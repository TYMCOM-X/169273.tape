
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 1
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

1	
2	
3	
4	
5	
6	
7	
8	
9	
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 2
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

10	begin "SUPCHK"
11	COMMENT SUPCHK.SAI -------------------------------------------------
12	
13		SUPCHK is a master program that successively builds auxiliary
14	circuits to a list of target hosts, checks for pending mail to the
15	username OPER and runs a slave program on the target host that collects 
16	information on pending requests and sends them back to SUPCHK.
17	Once activated, SUPCHK does the following:
18	
19	     1. Build AUX circuits to each host included in the HOST.LST file.
20	        For each host: 
21	
22	          a. Collect oper mail.
23	
24	          b. Activate the slave program (SLVSUP).
25	
26	          c. Interpret the codes and signals generated by SLVSUP.
27	
28	          d. Report the results to the tty on which it runs. 
29	
30	     2. Sleep for a specified interval then repeat 1 - 2.
31	
32	
33	   SLVSUP exists on all  PDP-10 hosts in the UTIL directory.  It is
34	written in MACRO.  Through a series of specialized single-character
35	codes, SLVSUP communicates with the master program that is running it
36	(SUPCHK) and, if the proper responses are received from SUPCHK,
37	accesses files in the SPOOL and *1BATCH directories that contain info on
38	pending requests.  The files accessed by SLVSUP are: (SPOOL)SPLCNT,
39	(*1BATCH)SSPOOL.DAT, and (*1BATCH)PPRTMP.DAT.  SLVSUP will also generate
40	specific error codes that can be interpreted by SUPCHK if there is
41	any trouble encountered when accessing these files.
42	
43	
44	
45	
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 3
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

46	
47	
48	
49			  SUMMARY OF SLVSUP INTERACTION CODES
50			  -----------------------------------
51	
52	The following are the normal codes sent by SLVSUP, the responses it
53	expects from the master and what the interaction means:
54	
55	SENDS:	EXPECTS:	MEANS:
56	------	--------	------------------------------------------------
57	ppabcd	ABCD		Normal handshake, SLVSUP is active and ready to run.
58	i	nothing		Handshake accepted, all is well.
59	`	`		Error on handshake, repeat abcd string.
60	k	K		Ready to send Spool Count (SPLCNT file).
61	v	V		Ready to send SSPOOL.DAT records.
62	w	W		Done sending SSPOOL.DAT records.
63	g	G		Ready to send first PPRTMP.DAT record.
64	n	N		Ready to send another PPRTMP.DAT record.
65	kk	K		Done sending PPRTMP.DAT records.
66	x	X		Done sending block of data, ready to send another.
67	f	F		No batch requests to report (file empty).
68	e	nothing		Normal exit from SLVSUP.
69	
70	In addition, the following error codes may be sent by SLVSUP:
71	
72	CODE:	EXPECTS:	ERROR:
73	-----	--------	------------------------------------------------
74	u	nothing		All purpose error code for SSPOOL.DAT or SSPOOL.BAK
75				files.  If any problems are encountered with these
76				files, SLVSUP sends the "u" and proceeds to look for
77				pending batch requests.
78	h	H		The "h" precedes all other error codes (aside from
79				the "u" error above) and waits for an "H" from the
80				master before sending the actual error code.  The 
81				actual error codes (below) are always two control
82				characters.
83	^A^A	nothing		Error on inputting PPRTMP.DAT file, abort.
84	^K^K	nothing		PPRTMP.DAT file not found, abort.
85	^L^L	nothing		Error outputting PPRTMP.DAT file, abort.
86	^M^M	nothing		Error renaming PPRTMP.DAT as PPRCLR.DAT, abort.
87	^N^N	nothing		Unable to open PPRCLR.DAT file after rename, abort.
88	^O^O	nothing		Error creating new PPRTMP.DAT file, abort.
89	^P^P	nothing		PPRCLR.DAT file expected but not found, abort.
90	^Q^Q	nothing		Error inputting PPRCLR.DAT, abort.
91	^R^R	nothing		Format error on PPRCLR.DAT, abort.
92	^S^S	nothing		Error deleting PPRCLR.DAT, abort.
93	^T^T	nothing		Unable to open SPLCNT file, abort.
94	
95	In addition to being able to interpret the above SLVSUP codes, SUPCHK
96	translates the text being sent by SLVSUP.
97	Text is sent in blocks of 96 characters and is preceded by one 
98	of the "ready to send" codes above ("v", "g", "n" or "x").  Carriage
99	return/line feed pairs are translated into the ASCII code octal 155 
100	("m") and are counted as only one character in the 96 character block.
101	All other ASCII codes have octal 40 subtracted from them, which in 
102	effect translates lower case to upper case (to distinguish text from 
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 3.1
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

103	SLVSUP codes).  SUPCHK translates back to proper ASCII codes in order
104	to create legible text.
105	
106	
107	
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 4
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

108	
109	
110	
111	NOTE:
112	
113	1.  SUPCHK will abort if the user name of the current user is not the
114	same as the user name in the body of the macro "ValidUserName".
115	
116	2.  On each host there must be a file named HOST.LST that contains a
117	list of the hosts that are valid for that center.  The user can update
118	the host list (with SUPCHK) in order to keep the lists current.  
119	
120	
121	
122	-----------------------------------------------------------------------;
123	
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 5
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

124	
125	require "(SAILIB)sail.def" source!file;
126	require "(MPL)UUOSYM.SAI" source!file;
127	require "(SAILIB)xtend.dcl" source!file;
128	
129	define  nhosts = 30,
130		TimeOut = 10,
131		Asterisks = {for a_1 upto 72 do print("*") ; print(crlf) },
132		AlertOperator = {print(crlf,#lf,#lf,#bel,#bel,#bel)},
133		DefaultWaitPeriod = 15,
134		SiteFileName = {"(UTIL)HOST.LST"}, 
135		ValidUserName = {"OPER"}; ! to be sure correct mail is collected ;
136					  ! MUST be caps ;
137	boolean AbortHostError, ! Signal to abort current host due to error ;
138		AUXTRACE,
139		ReDoingFailures, ! Set if can't log on to one host ;
140		CircuitGone, ! Set when auxinc returns -1 ;
141		!Trace,        ! enable user/debugger to see which hosts
142	                         are being procesed, as they are processed.
143	                         true when ^Z is typed in response to any Y/N question;
144		SecondPassInProgress; ! signal to use array of failed hosts ;
145	
146	itemvar AUXDEAD;
147	integer inbrchar,
148		CurrentHost,
149		AUXPORT,
150		ineof,
151		outchan,
152		h, ! hostloop index ;
153		a, ! "*" counter ;
154		WaitPeriod, ! time to sleep between polling of hosts ;
155		NumOfBadHosts, ! number of failures during first pass ;
156		LastHost; ! array position of last host in list ;
157	
158	string  UserName, ! used in AUXCRE ; 
159		ErrMsg,
160		ValidUser, ! user name confirmed same as ValidUserName (above) ;
161		line,SiteNameLine,SiteID;
162	
163	integer array hosts[0:nhosts-1], ! store hosts read in from host file ;
164		      FailedHosts[0:nhosts-1]; ! store failed hosts ;
165	
166	
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 6
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

167	integer procedure CREAUX (string UNAME);
168	!----------------------------------------------------------------------;
169	
170	! Build aux circuit to User and host specified in UNAME;
171	
172	!----------------------------------------------------------------------;
173	begin   "CREAUX"
174	    integer I;
175	    integer array X[0:5];
176	
177	    for I _ 0 upto 5 do X[i] _ cvasc(UNAME[1+5*i to 5+5*i]);
178	    AUXPORT _ I _ calli(location(X[0]),calli!CREAUX);
179	    if !SKIP! then return(AUXPORT);
180	    case !lh(I) of begin
181	
182	      [CXSUP#] case !rh(I) of begin
183	                 [CXSFE#] ErrMsg _ "?FORMAT ERROR" ;
184	                 [CXSBU#] ErrMsg _ "?USER NOT IN MUD" ;
185	                 [CXSBM#] ErrMsg _ "?BAD MUD" ;
186	                 [CXSHU#] ErrMsg _ "?HOST UNAVAILABLE" ;
187	                 [CXSDF#] ErrMsg _ "?DOWCRLFINE LOAD/DIALOUT REQUEST FAILURE" ;
188	                 [CXSTO#] ErrMsg _ "?TIMEOUT" ;
189	                 [CXSAB#] ErrMsg _ "?ACCESS BARRED" ;
190	                 [CXSIS#] ErrMsg _ "?ERROR IN ISIS" ;
191	                 [CXSLQ#] ErrMsg _ "?LONG QUEUE IN SUPERVISOR" ;
192	                 else ErrMsg _ "?UNKNOWN SUPERVISOR ERROR CODE: '"&cvos(!rh(I))
193	               end;
194	
195	      [CX2AX#] ErrMsg _ "?TOO MANY CIRCUITS W'OUT AC LICENSE" ;
196	
197	      [CXLOG#] ErrMsg _ "?NOT YOUR USERNAME W'OUT AC LICENSE" ;
198	
199	      [CXDCB#] ErrMsg _ "?NO ROOM IN MONITOR" ;
200	
201	      [CXNRR#] ErrMsg _ "?SUP DID NOT RESPOND TO ORIGINAL REQ" ;
202	
203	      [CXNRL#] ErrMsg _ "?SUP DID NOT RESPOND TO LOGIN MESSAGE" ;
204	
205	      [CXNCH#] ErrMsg _ "?SUP DID NOT SUPPLY A CIRCUIT" ;
206	 
207	      [CXERR#] ErrMsg _ "?SUP ERROR FROM ORIGINAL REQUEST" ;
208	
209	      else     ErrMsg _ "?UNKNOWN CREAUX ERROR CODE: '"&cvos(!lh(I) )
210	
211	    end;
212	    print(crlf);
213	    !SKIP! _ false;
214	    return(-1);
215	end     "CREAUX";
216	
217	
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 7
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

218	simple procedure AUXOUT(string S);
219	!----------------------------------------------------------------------;
220	!----------------------------------------------------------------------;
221	begin!code "AUXOUT"
222	        HRL     1,AuxPort;
223	        HRRI    1,!AXOPC;
224	        HRRZ    2,-1(SP);
225	        MOVE    3,0(SP);
226	        AUXCAL  1,2;
227	end "AUXOUT";
228	
229	
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 8
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

230	simple integer procedure AUXIN (integer TIM(0) );
231	!----------------------------------------------------------------------;
232	!----------------------------------------------------------------------;
233	begin   "AUXIN"
234	    integer C;
235	    calli( (auxport lsh 27) + !hl('111) + TIM, calli!HIBER);
236	    if !SKIP! then begin
237	        C _ auxclv(AuxPort,0,!AXI8S);
238	        if AuxTrace then outchr(C);
239	        if !SKIP! then return(C) else return(-1);
240	    end;
241	    auxport _ !hl(1);
242	    if typeit(AuxDead)=8 then apply(datum(AuxDead));
243	    !SKIP! _ false;
244	    return(-1);
245	end     "AUXIN";
246	
247	
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 9
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

248	
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 10
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

249	simple procedure AUXZAP;
250	!----------------------------------------------------------------------;
251	!----------------------------------------------------------------------;
252	begin!code
253	        MOVE 1,AuxPort;
254	        uuo!ZAPCIR 1,;
255	         JFCL;
256	end;
257	
258	
259	
260	
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 11
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

261	string procedure GetDate;
262	!----------------------------------------------------------------------;
263	
264	! returns MM/DD/YYYY .                                                   ;
265	
266	!----------------------------------------------------------------------;
267	Begin "GetDate"
268	  integer Day,Month,Year,Raw;
269	  Raw _ calli( 0,'14 );
270	  Month _ ( ( Raw DIV 31 ) MOD 12 ) + 1;
271	  Day _ ( Raw MOD 31 ) + 1;Year _ ( Raw DIV 365 ) + 64;
272	  Return( CVS( Month )&"/"&CVS( DAY )&"/"&CVS( Year ) );
273	End "GetDate";
274	
275	string procedure GetTime;
276	!----------------------------------------------------------------------;
277	
278	! returns HH:MM .                                                      ;
279	
280	!----------------------------------------------------------------------;
281	Begin "GetTime"
282	  string sHours,sMinutes;
283	  integer Hours,Minutes,Raw;
284	  Raw _ calli( 0,'23 );
285	  Hours _ ( ( Raw DIV 1000 ) DIV 3600 );
286	  Minutes _ ( ( ( Raw DIV 1000 )-( Hours * 3600 ) ) DIV 60 );
287	  if Hours < 10 then
288	    sHours _ ( "0"&CVS( Hours ) )
289	  else
290	    sHours _ ( CVS( Hours ) );
291	  if Minutes < 10 then
292	    sMinutes _ ( "0"&CVS( Minutes ) )
293	  else
294	    sMinutes _ ( CVS( Minutes ) );
295	  Return( sHours&":"&sMinutes );
296	End "GetTime";
297	
298	
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 12
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

299	integer procedure GetWaitPeriod;
300	!----------------------------------------------------------------------;
301	
302	! Obtain wait period from operator.                                    ;
303	
304	!----------------------------------------------------------------------;
305	begin "GetWaitPeriod"
306		integer foo,
307			Period;
308		string  line,
309			SavLine;
310	while true do
311	  begin "WaitPeriodLoop"
312	    print( "ENTER RESTART INTERVAL [DEFAULT ");
313	    print( cvs( DefaultWaitPeriod )," MINUTES]: " );
314	    if NOT EQU( line _ SavLine _ inchwl,null ) then  ! check for <cr> ;
315	      if EQU ( line,"?" ) then                       ! help ;
316	        begin "help"
317	          print( crlf,#lf,"THIS PROGRAM WILL POLL DESIGNATED SYSTEMS ",crlf );
318	          print( "     WITH A SPECIFIED WAIT PERIOD BETWEEN EACH RUN. ",crlf );
319	          print( "ENTER EITHER: ",crlf );
320	          print( "- WAITPERIOD PERIOD IN MINUTES <CR>",crlf );
321	          print( "- <CR> (ONLY) FOR DEFAULT PERIOD OF " );
322	          print( cvs( DefaultWaitPeriod )," MINUTES",crlf );
323	          AlertOperator;
324	        end "help"
325	      else
326	        begin "make sure it is an integer"
327	          period _ intscan( line,foo );
328	          if foo = -1 then ! integer only ;
329	            begin
330	              print( crlf&"?"&Savline&"?"&crlf&#lf );
331	              continue;
332	            end;
333	          Return( period ); ! any integer obtained is returned ;
334	        end "make sure it is an integer"
335	    else
336	      ! Default is used if response was <cr> only;
337	      Return( DefaultWaitPeriod );
338	  end "WaitPeriodLoop";
339	end "GetWaitPeriod";
340	
341	
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 13
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

342	simple procedure Waiting( integer WaitPeriod );
343	!----------------------------------------------------------------------;
344	
345	! Waits for a specified period.                                        ;
346	
347	!----------------------------------------------------------------------;
348	
349	begin "Waiting"
350	
351	print( "BEGINNING ",cvs( WaitPeriod )," MINUTE WAIT  " );
352	print( GetDate,"  ",GetTime,crlf,#lf,#lf,#lf );
353	calli( !xwd( 2,WaitPeriod ),calli!Hiber ); ! zzzzz ;
354	end "Waiting";
355	
356	
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 14
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

357	string procedure SeeIfValidUser; ! $$ ;
358	!----------------------------------------------------------------------;
359	
360	! If the logged on user-name is the same as the macro "ValidUserName" then ;
361	! return the user-name, else abort.                                        ;
362	
363	!----------------------------------------------------------------------;
364	
365	begin "user name"
366		string temp;
367	temp _ ( cv6str( calli( -1 lsh 18 lor -'22, '41 ) )
368	       & cv6str( calli( -1 lsh 18 lor -'21, '41 ) ) );
369	if EQU(temp,ValidUserName) then 
370	  return(temp)
371	else
372	  usererr( 0,0,"SUPCHK CANNOT BE RUN BY USER NAME ["&temp&"]."&crlf&
373	               "MUST BE LOGGED IN AS ["&ValidUserName&"].","X" );
374	
375	End   "user name";
376	
377	
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 15
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

378	string procedure AddForty( integer C );
379	!----------------------------------------------------------------------;
380	
381	! SLVSUP sends most chars with 40 subtracted, so the uncorrected text  ;
382	! would consist of a bunch of punctuation characters and numbers.      ;
383	! Adding '40 to this apparent garbage converts it to uppercase chars   ;
384	! which make sense.  This procedure is applied to any char coming which ;
385	! has an ASCII value < '141. Any characters received from SLVSUP with  ;
386	! ASCII values > '140 (lower case letters) are special control characters ;
387	! and this function returns them unchanged.                               ;
388	
389	!----------------------------------------------------------------------;
390	
391	begin
392	    if C > '140 then  ! lower case chars are all special ;
393	      if C = "m" then ! "m" is SLVSUP signal to insert crlf into text. ;
394	        return( crlf )
395	      else
396	        return( C ) ! return lower case char unchanged. ;
397	    else
398	      return( C + '40 ); ! convert to a letter ;
399	end;
400	
401	
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 16
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

402	simple procedure Fatal( integer Host ; String Msg ; integer Location );
403	!----------------------------------------------------------------------;
404	
405	! Handles errors not reported by SLVSUP (usually circuit trouble).     ;
406	
407	!----------------------------------------------------------------------;
408	BEGIN
409	print( SiteID & cvs( Host )," :  " ); ! begin message to operator. ;
410	if Equ(Msg,null) then       ! No Message supplied in procedure call ;
411	  if EQU(ErrMsg,null) then  ! No AUXCRE supplied error message ;
412	    print("CIRCUIT ZAPPED OR TT #",cvs(location),"." )
413	  else                      ! Use AUXCRE supplied error message ;
414	    print( ErrMsg," #",cvs(location),"." )
415	else                        ! Use Message supplied in procedure call ;
416	  print(Msg," #",cvs(location),"." );
417	AlertOperator;
418	auxzap; ! do not continue this host if error ;
419	AuxPort _ -1;
420	ErrMsg _ null;
421	AbortHostError _ True; ! Signal to abort current host due to error. ;
422	CircuitGone _ true; ! skip back to beginning of hostloop. ;
423	  
424	END;
425	
426	
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 17
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

427	simple procedure ErrorRoutine( integer HostNum ); 
428	!----------------------------------------------------------------------;
429	
430	! responses to errors generated by SLVSUP.                             ;
431	
432	!----------------------------------------------------------------------;
433	
434	begin "ErrorRoutine"
435		integer ch;
436	
437	auxout( "H" ); ! tell SLVSUP to send error code ;
438	ch _ AuxIn( TimeOut ); ! error codes are sent twice in succession ;
439	if ch = -1 then
440	  BEGIN
441	    Fatal( HostNum , null , 1 );
442	    return;
443	  END;
444	ch _ AuxIn( TimeOut ); ! second time ;
445	if ch = -1 then
446	  BEGIN
447	    Fatal( HostNum , null , 2 );
448	    return;
449	  END;
450	
451	print( SiteID & cvs( HostNum ),"  - " ); ! begin message to operator ;
452	case CH of begin
453	
454	  ['1]  ! ^A ; print( " ERROR INPUTTING PPRTMP.DAT FILE," );
455	
456	  ['13] ! ^K ; print( "PPRTMP.DAT FILE NOT FOUND," );  
457	
458	  ['14] ! ^L ; print( "ERROR OUTPUTTING PPRTMP.DAT FILE," );
459	
460	  ['15] ! ^M ; print( "ERROR RENAMING PPRTMP.DAT AS PPRCLR.DAT," );
461	
462	  ['16] ! ^N ; print( "UNABLE TO OPEN PPRCLR.DAT FILE AFTER RENAME" );
463	
464	  ['17] ! ^O ; print( "ERROR CREATING NEW PPRTMP.DAT FILE," );
465	
466	  ['20] ! ^P ; print( "PPRCLR.DAT FILE EXPECTED BUT NOT FOUND," );
467	
468	  ['21] ! ^Q ; print( "ERROR INPUTTING PPRCLR.DAT," );
469	
470	  ['22] ! ^R ; print( "FORMAT ERROR ON PPRCLR.DAT," );
471	
472	  ['23] ! ^S ; print( "ERROR DELETING PPRCLR.DAT," );
473	
474	  ['24] ! ^T ; print( "UNABLE TO OPEN SPLCNT FILE," );
475	
476	  else  print( "UNKNOWN ERROR CODE: "&cvs(ch)&" FROM SLVSUP," )
477	
478	  end; ! case ;
479	print( "ABORT",crlf );
480	AlertOperator;
481	AuxZap; ! do not continue this host if error ;
482	AbortHostError _ True; ! Signal to abort current host due to error ;
483	end "ErrorRoutine";
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 17.1
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

484	
485	
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 18
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

486	simple procedure ReadSpoolReq( integer host );
487	!----------------------------------------------------------------------;
488	
489	! get pending spool requests and print them.                           ;
490	! looks for "w" from SLVSUP, indicating the end.                       ;
491	
492	!----------------------------------------------------------------------;
493	
494	begin "ReadSpoolReq"
495		integer ch;
496		string  CStr; ! "ch" converted by adding 40 ;
497		boolean FirstCharWasW; ! first char received in a spool rec should
498	                                 not be 'w' since this indicates end ;
499	
500	auxout( "V" );   ! Indicate ready to receive ;
501	ch _ AuxIn( TimeOut );
502	if ch = -1 then
503	  BEGIN
504	    Fatal( Host , null , 3 );
505	    return;
506	  END;
507	CStr _ AddForty( ch );
508	if ch neq "w" then    ! "w" here means there is actually no spool request ;
509	  begin               ! so if ch = "w" then fall through this procedure. ;
510	    AlertOperator;
511	    Asterisks;
512	    print( SiteID & cvs( Currenthost )&": SPOOL REQUEST - " );
513	    print( GetDate,"  ",GetTime,crlf,#lf);
514	    FirstCharWasW _ False; 
515	  end
516	else
517	  FirstCharWasW _ True; ! probable something wrong somewhere ;
518	while Not EQU( CStr,"w" ) do    ! "w" indicates end of SPOOL recs ;
519	  begin "reading"
520	    if Not EQU( CStr,"x" ) then 
521	      print( CStr ); 
522	    ch _ AuxIn( TimeOut );
523	    if ch = -1 then
524	      BEGIN
525	        Fatal( Host , null , 4 );
526	        return;
527	      END;
528	    CStr _ AddForty( ch );
529	    if ch = "h" then ! trouble signal from SLVSUP ;
530	      begin
531	        ErrorRoutine( host );
532	        return;
533	      end;
534	    if CStr = "x" then ! "x" indicates end of a block of chars ;
535	      begin
536	        auxout( "X" );   ! Indicate ready to continue ;
537	        continue "reading";
538	      end;
539	  end "reading";
540	if CStr = "w" then
541	  auxout( "W" );   ! Acknowledge receipt of end indicator. ;
542	if Not FirstCharWasW then ! prevent these operator signals in this case. ;
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 18.1
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

543	  begin
544	    Asterisks;
545	    AlertOperator;
546	  end;
547	end "ReadSpoolReq";
548	
549	
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 19
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

550	simple procedure ReadBatchReq( integer beginMark,host );
551	!----------------------------------------------------------------------;
552	
553	! prints pending batch requests sent by SLVSUP.                        ;
554	! looks for "k" from SLVSUP, indicating the end.                       ;
555	
556	!----------------------------------------------------------------------;
557	
558	begin "ReadBatchReq"
559		integer ch;
560		string  CStr; ! "ch" converted by adding 40 ;
561	
562	AlertOperator;
563	Asterisks;
564	print( SiteID & cvs(Currenthost )&": BATCH REQUEST - " );
565	print( GetDate,"  ",GetTime,crlf,#lf);
566	print( "FILE LAST CLEARED" );
567	if EQU( beginMark,"g" ) then
568	  auxout( "G" )    ! Indicate ready to receive first Batch req ;
569	else
570	  auxout( "N" );   ! Indicate ready to receive another Batch req ;
571	CStr _ null;
572	while Not EQU( CStr,"k" ) do                    ! "k" means done ;
573	  begin "reading"
574	    if Not EQU( CStr,"x" ) and Not EQU( CStr,"g") and Not EQU( CStr,"n" ) then 
575	      print( CStr ); ! print everthing but SLVSUP signal chars ;
576	    ch _ AuxIn( TimeOut );
577	    if ch = -1 then
578	      BEGIN
579	        Fatal( Host , null , 5 );
580	        return;
581	      END;
582	    CStr _ AddForty( ch );
583	    if CStr = "h" then ! trouble indicator ;
584	      begin
585	        ErrorRoutine( host );
586	        return;
587	      end;
588	    if ( CStr = "x" ) then ! end of one block of data ;
589	      begin
590	        auxout( "X" ); ! Signal ready to continue ;
591	        continue "reading";
592	      end;
593	      if CStr = "n" then ! SLVSUP is ready with more ;
594	        begin
595	          auxout( "N" ); ! Signal ready to continue ;
596	          Asterisks;
597	          AlertOperator;
598	          Asterisks;
599	          print( SiteID & cvs(Currenthost )&": BATCH REQUEST - " );
600	          print( GetDate,"  ",GetTime,crlf,#lf);
601	          print( "FILE LAST CLEARED" );
602	          continue "reading";
603	        end;
604	  end "reading";
605	  if Cstr = "k" then ! End of Batch requests signal from SLVSUP ;
606	    begin
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 19.1
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

607	      ch _ AuxIn( TimeOut ); ! Get second "k" ;
608	      if ch = -1 then
609	        BEGIN
610	          Fatal( Host , null , 6 );
611	          return;
612	        END;
613	      CStr _ AddForty( ch );
614	      Asterisks;
615	      AlertOperator;
616	      auxout( "K" );   ! Acknowledge end ;
617	    end;
618	end "ReadBatchReq";
619	
620	
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 20
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

621	integer procedure CreateNewFil( String NameForTheNewFile );
622	!----------------------------------------------------------------------;
623	
624	! create a new file.                                                   ;
625	
626	!----------------------------------------------------------------------;
627	
628	begin
629		integer eof,
630			NewFilChan;
631	
632	open( NewFilChan _ getchan,"DSK",0,0,4,0,0,eof );
633	enter( NewFilChan,NameForTheNewFile,eof );
634	if eof then
635	  usererr( 0,0,"Can't enter "&NameForTheNewFile,"X" );
636	return( NewFilChan );
637	end;
638	
639	
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 21
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

640	simple procedure DisplaySystems;
641	!----------------------------------------------------------------------;
642	
643	! show systems which were read into the array                          ;
644	
645	!----------------------------------------------------------------------;
646	
647	begin
648		integer i;
649	
650	  print( crlf,"CURRENT ",SiteNameLine," SYSTEMS ARE:",crlf );
651	  for i _ 0 upto LastHost do
652	    print( cvs( hosts[i] )," " );
653	end;
654	
655	
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 22
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

656	simple boolean procedure YES( string TheQuestion );
657	!----------------------------------------------------------------------;
658	
659	! Prompts for yes or no response to TheQuestion.                       ;
660	 
661	!----------------------------------------------------------------------;
662	
663	begin
664		string line;
665	
666	while true do
667	  begin "ask"
668	    print( crlf,TheQuestion&" ( Y OR N )? " );
669	    while true do
670	      case ( Line _ inchwl ) of begin
671	  
672	        [000&'32] begin
673	                !Trace _ true; 
674	                ! hostnums are displayed as circuits are built ;
675	                continue "ask"; ! still need answer to "Y or N". ;
676	              end;
677	  
678	        ['131] ['171] return( true );
679	  
680	        ['116] ['156] return( false );
681	  
682	        else          Continue "ask"
683	  
684	      end; ! case ;
685	  end "ask";
686	end;! YES ;
687	
688	
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 23
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

689	simple integer procedure OpenFil( String NameOfTheFile );
690	!----------------------------------------------------------------------;
691	
692	! Open a currently existing file                                       ;
693	
694	!----------------------------------------------------------------------;
695	
696	begin
697		integer eof,
698			FilChan;
699	
700	open( FilChan _ getchan,"DSK",0,2,0,500,0,eof );
701	LookUp( FilChan,NameOfTheFile,eof );
702	if eof then
703	  usererr( 0,0,"Can't find "&NameOfTheFile,"X" );
704	return( FilChan );
705	end;
706	  
707	  
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 24
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

708	simple boolean procedure DeleteSys;
709	!----------------------------------------------------------------------;
710	
711	! to remove a system from those in hosts array.                        ;
712	
713	!----------------------------------------------------------------------;
714	
715	begin
716		integer i,j,SysNum,foo;
717		string SavLine;
718	
719	while true do
720	  begin "GetSysNum"
721	    print( crlf,"ENTER SYSTEM NUMBER[S] ( OMIT LETTERS ): " );
722	    line _ inchwl;
723	    while true do
724	      begin "ReadIn"
725	        if ( SavLine _ Line ) = null then ! if nothin remains ;
726	          done "GetSysNum";
727	        SysNum _ intscan( line,foo );
728	        if foo = -1 then
729	          begin
730	            print( crlf,"?",Savline,"?",crlf );
731	            continue "GetSysNum";
732	          end;
733	        if SysNum = 0 then
734	          continue;
735	        for i _ 0 upto ( nhosts - 1 ) do
736	          begin "DeleteIt"
737	            if hosts[i] = SysNum then
738	              begin
739	                for j _ i upto ( nhosts - 2 ) do ! take it out ;
740	                  hosts[j] _ hosts[j + 1];
741	                LastHost  _ LastHost - 1;
742	              end;
743	          end "DeleteIt";
744	      end "ReadIn";
745	  end "GetSysNum";
746	end;  ! DeleteSys ;
747	  
748	
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 25
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

749	simple boolean procedure AddSys;
750	!----------------------------------------------------------------------;
751	
752	! to add a system to those in hosts array.                             ;
753	
754	!----------------------------------------------------------------------;
755	
756	begin
757		boolean found;
758		integer i,j,SysNum,foo;
759		string SavLine;
760	
761	while true do
762	  begin "GetSysNum"
763	    print( crlf,"ENTER SYSTEM NUMBER[S] ( OMIT LETTERS ): " );
764	    line _ inchwl;
765	    while true do
766	      begin "ReadIn"
767	        if ( SavLine _ line ) = null then ! if nothing remains on line ;
768	          done "GetSysNum";
769	        SysNum _ intscan( line,foo );
770	        if foo = -1 then
771	          begin
772	            print( crlf,"?",Savline,"?",crlf );
773	            continue "GetSysNum";
774	          end;
775	        found _ false;
776	        for i _ 0 upto ( nhosts - 1 ) do
777	          begin "InsertIt"
778	            if hosts[i] = SysNum then ! no duplicates ;
779	              begin
780	                found _ true;
781	                done;
782	              end;
783	            if hosts[i] > SysNum then ! insert into proper position ;
784	              begin
785	                found _ true;
786	                for j _ LastHost downto i do
787	                  hosts[j + 1] _ hosts[j];
788	                hosts[i] _ SysNum;
789	                LastHost _ LastHost + 1;
790	                done;
791	              end;
792	          end "InsertIt";
793	        if not found then ! must be higher number ;
794	          begin
795	            print( #bel );
796	            hosts[LastHost _ LastHost + 1] _ SysNum;
797	          end;
798	      end "ReadIn";
799	  end "GetSysNum";
800	end;  ! AddSys ;
801	  
802	simple procedure StoreChanges;
803	!----------------------------------------------------------------------;
804	
805	! for making system number changes permanent                           ;
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 25.1
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

806	
807	!----------------------------------------------------------------------;
808	
809	begin
810		integer i;
811	
812	  setbreak( InBrChar _ GetBreak,#lf,#cr,"I" );
813	  OutChan _ CreateNewFil( SiteFileName );
814	  cprint( OutChan,SiteNameLine&crlf );
815	  for i _ 0 upto LastHost - 1 do
816	    cprint( OutChan,cvs( hosts[i] ),"," );
817	  cprint( OutChan,cvs( hosts[LastHost] ) );
818	  print( crlf,#lf,"SUPCHK UPDATED",crlf );
819	  release( OutChan );
820	end; ! StoreChanges ;
821	  
822	
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 26
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

823	simple procedure ChangeHosts;
824	!----------------------------------------------------------------------;
825	
826	! ask user whether to add or remove systems from those displayed       ;
827	
828	!----------------------------------------------------------------------;
829	
830	begin ! ChangeHosts ;
831	while true do
832	  begin "Changes"
833	    if YES( "REMOVE SYSTEM[S]" ) then
834	      begin "GetDeletes"
835	        DeleteSys;
836	        DisplaySystems;
837	      end "GetDeletes";
838	    if YES( "ADD SYSTEM[S]" ) then
839	      begin "GetAdds"
840	        AddSys;
841	        DisplaySystems;
842	      end "GetAdds";
843	    if NOT YES( "OKAY" ) then
844	      DisplaySystems
845	    else
846	      done;      
847	  end "Changes";
848	if YES( "ARE CHANGES PERMANENT" ) THEN
849	  StoreChanges;
850	end;  ! ChangeHosts ;
851	  
852	
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 27
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

853	simple procedure Gethosts;
854	!----------------------------------------------------------------------;
855	
856	! Gets site from user and looks to a file for list of hosts             ;
857	
858	!----------------------------------------------------------------------;
859	
860	begin
861		integer h,OneHost,foo,Chan;
862		string  line,savline;
863	
864	Chan _ OpenFil( SiteFileName );
865	  begin ! Get a line from file ;
866	    setbreak( InBrChar _ GetBreak,#lf,#cr,"I" );
867	    SiteNameLine _ input( Chan,InBrChar ); ! ex: "FREMONT" or "VALLEY FORGE" ;
868	    SiteID _ SiteNameLine[1 for 1];  ! first letter, ex: "F" for "FREMONT" ;
869	    Line _ input( Chan,InBrChar );
870	    for h _ 0 step 1 until nhosts-1 do
871	      begin "ReadHostsIntoArray"
872	        LastHost _ h-1;
873	        if ( savline _ line ) = null then
874	          done;
875	        OneHost _ intscan( line,foo );
876	        if foo = -1 then
877	          print( savline&"?"&crlf );
878	        hosts[h] _ OneHost;
879	      end "ReadHostsIntoArray";
880	    DisplaySystems;
881	    if NOT YES( "OKAY" ) then
882	      ChangeHosts;
883	  end;
884	print( crlf&crlf );
885	end; ! Gethosts ;
886	
887	
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 28
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

888	simple procedure SaveForRetry( integer Host );
889	!----------------------------------------------------------------------;
890	
891	! Place hosts that could not be logged into into the Retry array.      ;
892	! Do not insert hosts that have failed twice.                          ;
893	
894	!----------------------------------------------------------------------;
895	
896	BEGIN
897	  if NOT SecondPassInProgress then ! No retries of retries. ;
898	    begin
899	      ReDoingFailures _ true; ! do not reset if this is second pass ;
900	      NumOfBadHosts _ NumOfBadHosts + 1; ! increment on first pass only ;
901	      FailedHosts[NumOfBadHosts - 1] _ Host; ! save for second pass ;
902	    end;
903	END;
904	
905	
906	
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 29
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

907	simple procedure CheckMail(integer HostNum);
908	!----------------------------------------------------------------------;
909	
910	! print oper mail if there is any waiting                              ;
911	
912	!----------------------------------------------------------------------;
913	
914	begin
915		integer ch;
916		string response;
917		boolean MailWaiting; ! set true if "mail waiting" comes with
918					with logon messages ;
919	
920	  if !Trace then print( " CHECK MAIL  " );
921	  response _ null;
922	  MailWaiting _ false;
923	  auxout( "mail"&#cr );                    ! ask for mail ;
924	  if !Trace then print( "-" );
925	  
926	while ( ch _ AuxIn( TimeOut ) ) neq -1 do
927	    begin                           ! look for echo of command "mail" ;
928	      response _ response & ch;                        ! tack it on ;
929	      if equ( ch,#lf ) then                     ! clear for new line ;
930	          response _ null;
931	      if equ( response[1 for 12],"mail waiting" ) then
932	        MailWaiting _ true;
933	      if equ( response[1 for 5],"-mail" ) or ! true if echo of "mail" rec'd;
934	         equ( response[1 for 5],".mail" ) then 
935	                            ! After echo of the "mail" command, see if the next
936	                              seven character rec'd after crlf is the string 
937	                              "No mail".  If it is, then return with No mail.
938	                              If what follows is not "no mail", then assume
939	                              that the next seven characters is the beginning
940	                              of a mail message and print those seven and 
941	                              also print whatever follows up to the next
942	                              system prompt ( "." or "-" in column 1 ). ;
943	
944	        while ( ch _ AuxIn( TimeOut ) ) neq -1 do
945	          begin "AfterCommandEcho"
946	            response _ response & ch;                 ! tack it on ;
947	            if equ( ch,#lf ) then            !  end of a line of echo'd stuff ;
948	              response _ null;               
949	            if    ( length( response ) = 7 ) and
950	               equ( response[1 for 7],"No mail" ) then ! return no mail ;
951	              begin "ResponseIsNoMail"
952	                if !Trace then print( "NO MAIL ",crlf );
953	                if MailWaiting then
954			  BEGIN ! something wrong ;
955	                    AlertOperator;
956	                    Asterisks;
957	                    print( SiteID & cvs(Currenthost )&": 'Mail Waiting' " );
958	                    print( "during logon " );
959	                    print( "but no response to 'mail' command...continuing" );
960	                    Asterisks;
961	                    AlertOperator;
962			  END;                  
963	                return; 
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 29.1
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

964	              end "ResponseIsNoMail"
965	           else          ! if stuff coming after echo of "mail" is not        ;
966	                         !  "No mail",  then what is coming is mail - copy it ;
967	            if ( length( response ) = 7 ) then ! copy the mail ;
968	              begin "copythemail"
969	                AlertOperator;
970	                Asterisks;
971	                print( SiteID & cvs(Currenthost )&": MAIL - " );
972	                print( GetDate,"  ",GetTime,crlf,#lf);
973	                print(crlf,"SYSTEM "&SiteID&cvs(HostNum)&" MAIL.",crlf);
974	                print( response );            ! was not "No mail" so print it ;
975	                response _ null;
976	
977	                while ( ch _ AuxIn( TimeOut ) ) neq -1 do
978	                  begin "CopyUntilSysPrompt"
979	                    response _ response & ch; ! tack it on ;
980	                    if equ( response[1 for 1],"-" ) or   ! assumes "." or "-" ;
981	                       equ( response[1 for 1],"." ) then ! in col 1 indicates ;
982	                         done;                           ! mail is done.;      
983	                    if equ( ch,#lf ) then
984	                      response _ null;        ! end of a line without "<cr>." ;
985	                    print( null&ch );      ! print latest character from mail ;
986	                  end "CopyUntilSysPrompt";
987	
988			if ch = -1 then    ! if circuit was cut ;
989	                  BEGIN
990	                    Fatal( HostNum , null , 7 );
991	                    return;
992	                  END;
993	                Asterisks;
994	                AlertOperator;
995	                return;            ! return with mail copied and no problem ;
996	              end "copythemail";
997	
998	          end "AfterCommandEcho";
999	
1000	    end; ! while ;
1001	
1002	  if ch = -1  then
1003	    BEGIN
1004	      Fatal( HostNum , "HOST UNAVAILABLE" , 8 );
1005	      SaveForRetry( HostNum );
1006	      return;
1007	    END;
1008	
1009	end; ! CheckMail ;
1010	
1011	
1012	
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 30
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

1013	simple procedure Pollhosts;
1014	!----------------------------------------------------------------------;
1015	
1016	! checks each host for mail then runs SLVSUP on each host              ;
1017	
1018	!----------------------------------------------------------------------;
1019	
1020	begin 
1021		integer ch,Count,i;
1022		boolean HandShakeRecd;
1023	
1024	if Not ReDoingFailures then                      ! don't do when retrying ;
1025	  begin                                         ! stuff for first pass only ;
1026	    print( crlf,#lf,"CLEARING ",SiteNameLine);    
1027	    print( " CENTER HOSTS  ",GetDate,"  ",GetTime,crlf );
1028	    AlertOperator;
1029	    NumOfBadHosts _ 0;                          ! clear it during first try ;
1030	    SecondPassInProgress _ false;
1031	    arrclr( FailedHosts );  ! get rid of fail hosts from any previous passes ;
1032	  end
1033	else
1034	  SecondPassInProgress _ true;             ! so hostloop will use FailedHosts ;
1035	  
1036	ReDoingFailures _ false; ! will be set if needed in hostloop ;
1037	
1038	for h _ 0 upto LastHost do
1039	begin "hostloop"
1040	
1041	  ! Initializations and see if this is first pass through hostlist ;
1042	  ! ************************************************************ ;
1043	  CircuitGone _ false; ! becomes true if an auxin fails somewhere. ;
1044	  AbortHostError _ false; ! becomes true if error message comes from SLVSUP ;
1045	  HandShakeRecd _ false;
1046	  if SecondPassInProgress and h > NumOfBadHosts - 1 then
1047	    done; ! finished with retry's ;
1048	  if NOT SecondPassInProgress then
1049	    CurrentHost _ hosts[h]
1050	  else
1051	    ! second time around get hosts from array of failures ;
1052	    CurrentHost _ FailedHosts[h];
1053	      
1054	  if !Trace then print( SiteID & cvs( Currenthost )&":" );
1055	  ! ------------------------------------------------------------ ;
1056	
1057	
1058	  ! Establish circuit to a host ;
1059	  ! ************************************************************ ;
1060	  AuxPort _ creaux( ValidUser&":"&cvs(CurrentHost ) );
1061	  if !Trace then Print( " port("&cvs(AUXPORT)&")" );
1062	  if AuxPort = -1 then
1063	    begin
1064	      FATAL(CurrentHost, null , 15 );
1065	      SaveForRetry( CurrentHost );
1066	      continue;
1067	    end;
1068	  auxout( #cr&#cr ); ! proj code/attach msgs ;
1069	  ! ------------------------------------------------------------ ;
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 30.1
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

1070	
1071	
1072	  ! Check for mail ;
1073	  ! ************************************************************ ;
1074	  CheckMail(CurrentHost);         ! Checkfor mail waiting ;
1075	  if CircuitGone then ! CIRCUIT FAILURE OR TIMEOUT during checkmail ;
1076	    Continue;  ! next host ;
1077	  ! ------------------------------------------------------------ ;
1078	
1079	
1080	  ! Call SLVSUP and establish that it is running ;
1081	  ! ************************************************************ ;
1082	  auxout( "run (UTIL)SLVSUP"&#cr );
1083	  if !Trace then print( "     RUN SLVSUP , " );
1084	  while NOT CircuitGone do 
1085	    begin "Findppabcd"
1086	      ch _ AuxIn( TimeOut );
1087	      if ch = -1 then
1088	        BEGIN
1089	          Fatal( CurrentHost , null , 9 );
1090	          Continue "hostloop" ; ! next host ;
1091	        END;
1092	      if ch = "p" then
1093	        begin "beginMarkFound"
1094	          ch _ AuxIn( TimeOut );
1095	          if ch = -1 then
1096	            BEGIN
1097	              Fatal( CurrentHost , null , 10 );
1098	              Continue "hostloop" ; ! next host ;
1099	            END;
1100	          if ch = "p" then
1101	            begin "SecondPFound"
1102	              ch_AuxIn( TimeOut );
1103	              if ch = "a" then
1104	                ch_AuxIn( TimeOut )
1105	              else continue;
1106	              if ch = "b" then
1107	                ch_AuxIn( TimeOut )
1108	              else continue;
1109	              if ch = "c" then
1110	                ch_AuxIn( TimeOut )
1111	              else continue;
1112	              if ch = "d" then
1113	                done;
1114	            end "SecondPFound"
1115	          else
1116	            ! if second consecutive "p" is not found ;
1117	            continue "Findppabcd";
1118	        end "beginMarkFound" 
1119	      else
1120	        if ch = -1 then
1121	                BEGIN
1122	                  Fatal( CurrentHost , null , 11 );
1123	                  Continue "hostloop" ; ! next host ;
1124	                END;
1125	    end "Findppabcd";
1126	  if !Trace then print( " RUNNING, " );
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 30.2
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

1127	  ! ------------------------------------------------------------ ;
1128	
1129	
1130	  ! Handshake with SLVSUP ;
1131	  ! ************************************************************ ;
1132	  if !Trace then print( "HANDSHAKE:" );
1133	  Count _ 0;
1134	  while NOT HandShakeRecd
1135	    and NOT CircuitGone do  ! send "ABCD" then look for "i" ;
1136	    begin "CheckHandShake"
1137	      if ch = -1 then
1138	        BEGIN
1139	          Fatal( CurrentHost , null , 12 );
1140	          Continue "hostloop" ; ! next host ;
1141	        END;
1142	      Count _ Count + 1;
1143	      If Count > 5 then ! Don't try more than 5 times ;
1144	        begin
1145	          if !Trace then print( crlf );
1146	          Fatal( CurrentHost,"Handshake failure...continuing",0 );       
1147	          Done "CheckHandShake";
1148	        end;
1149	      auxout( "ABCD" ); ! expected here by SLVSUP ;
1150	      if !Trace then print( " ABCD-" );
1151	      if ( ch _ AuxIn( TimeOut ) ) = "i" then
1152	        BEGIN
1153	          if !Trace then print( "OK" );
1154	          HandShakeRecd _ true;
1155	        END
1156	      else
1157	        if ch = "`" then ! error signal from SLVSUP ;
1158	          begin
1159	            if !Trace then print( "`" );
1160	            auxout( "`" ); ! expected here by SLVSUP ;
1161	            ch _ AuxIn( TimeOut );  ! get "a" ;
1162	            if ch = "a" then
1163	              ch_AuxIn( TimeOut )
1164	            else continue;
1165	            if ch = "b" then
1166	              ch_AuxIn( TimeOut )
1167	            else continue;
1168	            if ch = "c" then
1169	              ch_AuxIn( TimeOut )
1170	            else continue;
1171	            if ch = "d" then
1172	              continue;
1173	          end
1174	        else
1175	          if ch = -1 then
1176	            BEGIN
1177	              Fatal( CurrentHost , null , 13 );
1178	              Continue "hostloop" ; ! next host ;
1179	            END;
1180	  if !Trace then print( "," );
1181	      
1182	    end "CheckHandShake";
1183	  ! ------------------------------------------------------------ ;
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 30.3
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

1184	
1185	
1186	  ! Interact with SLVSUP ;
1187	  ! ************************************************************ ;
1188	  if !Trace and
1189	     NOT AbortHostError and
1190	     NOT CircuitGone 
1191	       then print( crlf,"     INTERACT: " );
1192	   while Not AbortHostError
1193	     and NOT CircuitGone do
1194	   ! read from host until/unless SLVSUP signal an error ;
1195	      begin "EndMarkFound"
1196	        ch _ AuxIn( TimeOut ); 
1197	        if ch = -1 then
1198	          BEGIN
1199	            Fatal( CurrentHost , null , 14 );
1200	            Continue "hostloop" ; ! next host ;
1201	          END;
1202	        if !Trace then print( null&ch );
1203	          case CH of begin
1204	
1205	              ["u"] ! Non-Fatal Error on SSPOOL.DAT records ;
1206	                    begin
1207	                      print( #bel,null );
1208		              print( SiteID & cvs(CurrentHost ),"  - " );
1209	                      print( "ERROR: Problem with SSPOOL.DAT or SSPOOL.BAK." );
1210	                      print( crlf );
1211	                    end;
1212	
1213	              ["v"] ! Ready to send SSPOOL.DAT records ;
1214	                    ReadSpoolReq( CurrentHost );
1215	
1216	              ["g"] ! Ready to send first PPRTMP.DAT record ;
1217	                    ReadBatchReq( "g",CurrentHost );
1218	
1219	              ["n"] ! Ready to send another  PPRTMP.DAT record ;
1220	                    ReadBatchReq( "n",CurrentHost );
1221	
1222	              ["k"] ! Ready to send Spool Count ;
1223	                    auxout( "K" ); ! expected here by SLVSUP ;
1224	
1225	              ["f"] ! No batch requests to report ( file empty );
1226	                    auxout( "F" ); ! expected here by SLVSUP ;
1227	
1228	              ["e"] ! Normal exit from SLVSUP ;
1229	                    begin
1230	                      AuxZap;
1231			      if !Trace then print( " NORMAL EXIT ",crlf );
1232	                      done "EndMarkFound"; ! next host ; 
1233	                    end;
1234	
1235	              ["h"] ! Error code follows ;
1236	                    begin  "ErrorCode"
1237	                      ErrorRoutine( CurrentHost );
1238	                      done "EndMarkFound";
1239	                    end "ErrorCode";
1240	
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 30.4
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

1241	              [ 000&'1 ] if !Trace then print( "^A");
1242	              [ 000&'2 ] if !Trace then print( "^B");
1243	              [ 000&'3 ] if !Trace then print( "^C");
1244	              [ 000&'4 ] if !Trace then print( "^D");
1245	              [ 000&'5 ] if !Trace then print( "^E");
1246	              [ 000&'6 ] if !Trace then print( "^F");
1247	              [ 000&'7 ] if !Trace then print( "^G");
1248	              [ 000&'8 ] if !Trace then print( "^H");
1249	              [ 000&'9 ] if !Trace then print( "^I");
1250	              [ 000&'10 ] if !Trace then print( "^J");
1251	              [ 000&'11 ] if !Trace then print( "^K");
1252	              [ 000&'12 ] if !Trace then print( "^L");
1253	              [ 000&'13 ] if !Trace then print( "^M");
1254	              [ 000&'14 ] if !Trace then print( "^N");
1255	              [ 000&'15 ] if !Trace then print( "^O");
1256	              [ 000&'16 ] if !Trace then print( "^P");
1257	              [ 000&'17 ] if !Trace then print( "^Q");
1258	              [ 000&'18 ] if !Trace then print( "^R");
1259	              [ 000&'19 ] if !Trace then print( "^S");
1260	              [ 000&'20 ] if !Trace then print( "^T");
1261	              [ 000&'21 ] if !Trace then print( "^U");
1262	              [ 000&'22 ] if !Trace then print( "^V");
1263	              [ 000&'23 ] if !Trace then print( "^W");
1264	              [ 000&'24 ] if !Trace then print( "^X");
1265	              [ 000&'25 ] if !Trace then print( "^Y");
1266	              [ 000&'26 ] if !Trace then print( "^Z");
1267	              [ 000 ] ! sometimes comes after "k", calls for no action ;
1268			      if !Trace then print( "null");
1269	
1270		      else 
1271	                if !Trace then print( "{",ch )
1272	
1273	             end; ! case ;
1274	         if AbortHostError then
1275	           done "EndMarkFound";
1276	       end "EndMarkFound";
1277	  ! ------------------------------------------------------------ ;
1278	  end "hostloop" ;
1279	end;
1280	
1281	
1282	
SUPCHK.WOK          created 25-Mar-85 10:17                      Page 31
Program Listing     by CRFSYM %5 at 19-Jan-87 14:14

1283	!----------------------------------------------------------------------;
1284	
1285	!  *** main *** ;
1286	
1287	!----------------------------------------------------------------------;
1288	
1289	print(crlf,#lf,#lf,"SUPCHK");
1290	
1291	AlertOperator;   ! Signals that program has started;
1292	
1293	ValidUser _ SeeIfValidUser; ! logged in user name must equal ValidUserName ;
1294	                            ! othrwise SUPCHK will abort.                  ;
1295	
1296	GetHosts;        ! Gets file with list of host numbers of hosts to be polled. ;
1297	                 ! User can make temporary changes to the list or permanent   ;
1298	                 ! changes to the file.                                       ;
1299	
1300	WaitPeriod _ GetWaitPeriod;  ! User is prompted for the time interval to wait ;
1301	                             ! between polls of the hosts.                    ;
1302	
1303	while true do
1304	  begin
1305	    PollHosts;               ! Build circuit in turn to each host in the host ;
1306	                             ! list, print mail if mail is waiting, then run  ;
1307	                             ! SLVSUP to check for SPOOL or BATCH requests.   ;
1308	                             ! Keep a list of hosts to which circuits could   ;
1309	                             ! not be built, and sets flag to retry them.     ;
1310	
1311	    if ReDoingFailures then  ! True if some circuits could not be built above.;
1312	      PollHosts;             ! This time use list of first time failures.     ;
1313	
1314	    Waiting( WaitPeriod );   !  Hold here for the wait period.                ;
1315	
1316	    continue;                ! Continue forever.                              ;
1317	
1318	  end;
1319	
1320	end "SUPCHK"

SUPCHK.WOK          created 25-Mar-85 10:17                      Page 32
User Defined Symbolsby CRFSYM %5 at 19-Jan-87 14:14

!AXI8S                     237
!AXOPC                     223
!HL                        235   241
!LH                        180   209
!RH                        182   192
!SKIP!                     179   213   236   239   243
!TRACE                     141   673   920   924   952  1054  1061  1083  1126
                          1145  1150  1153  1159  1180  1202  1231  1241  1242
                          1243  1244  1245  1246  1247  1248  1249  1250  1251
                          1252  1253  1254  1255  1256  1257  1258  1259  1260
                          1261  1262  1263  1264  1265  1266  1268  1271
!XWD                       353
#BEL                       132   132   132   795  1207
#CR                        812   866   923  1068  1068
#LF                        132   132   317   330   352   352   352   513   565
                           600   812   818   866   929   947   972   983  1026
A                          153
ABORTHOSTERROR             137   421   482  1044  1192  1274
ADDFORTY                   378   507   528   582   613
ADDSYS                     749   840
ALERTOPERATOR              132   323   417   480   510   545   562   597   615
                           955   961   969   994  1028  1291
ARRCLR                    1031
ASTERISKS                  511   544   563   596   598   614   956   960   970
                           993
AUXCAL                     226
AUXCLV                     237
AUXDEAD                    146   242   242
AUXIN                      230   438   444   501   522   576   607   926   944
                           977  1086  1094  1102  1104  1107  1110  1151  1161
                          1163  1166  1169  1196
AUXOUT                     218   437   500   536   541   568   570   590   595
                           616   923  1068  1149  1160  1223  1226
AUXPORT                    149   178   179   222   235   237   241   253   419
                          1061  1062
AUXTRACE                   138   238
AUXZAP                     249   418   481  1230
BEGIN!CODE                 221   252
BEGINMARK                  550   567
C                          234   237   238   239   378   393   396   398
CALLI                      178   235   269   284   353   367   368
CALLI!CREAUX               178
CALLI!HIBER                235   353
CH                         438   439   444   445   452   476   501   502   507
                           508   522   523   528   529   576   577   582   607
                           608   613   926   928   929   944   946   947   977
                           979   983   985   988  1002  1086  1087  1092  1094
                          1095  1100  1102  1103  1104  1106  1107  1109  1110
                          1112  1120  1137  1151  1157  1161  1162  1163  1165
                          1166  1168  1169  1171  1175  1196  1197  1202  1203
                          1271
CHAN                       864   867   869
CHANGEHOSTS                823   882
CHECKMAIL                  907
CIRCUITGONE                140   422  1075  1084  1135  1193
COUNT                     1133  1142  1142  1143

SUPCHK.WOK          created 25-Mar-85 10:17                      Page 33
User Defined Symbolsby CRFSYM %5 at 19-Jan-87 14:14

CREATENEWFIL               621   813
CREAUX                     167
CRLF                       131   132   212   317   317   318   319   320   322
                           330   330   352   372   394   479   513   565   600
                           650   650   668   721   730   730   763   772   772
                           814   818   818   877   884   884   952   972   973
                           973  1026  1027  1145  1210  1231
CSTR                       496   507   518   520   521   528   534   540   560
                           571   572   574   574   574   575   582   583   588
                           593   605   613
CURRENTHOST                148   512   564   599   957   971  1049  1052  1054
                          1064  1065  1089  1097  1122  1139  1146  1177  1199
                          1208  1214  1217  1220  1237
CV6STR                     367   368
CVASC                      177
CVOS                       192   209
CVS                        272   272   272   288   290   292   294   313   322
                           412   414   416   451   476   512   564   599   652
                           816   817   957   971   973  1054  1061  1208
CX2AX#                     195
CXDCB#                     199
CXERR#                     207
CXLOG#                     197
CXNCH#                     205
CXNRL#                     203
CXNRR#                     201
CXSAB#                     189
CXSBM#                     185
CXSBU#                     184
CXSDF#                     187
CXSFE#                     183
CXSHU#                     186
CXSIS#                     190
CXSLQ#                     191
CXSTO#                     188
CXSUP#                     182
DAY                        271   272
DEFAULTWAITPERIOD          133   313   322   337
DELETESYS                  708   835
DISPLAYSYSTEMS             640   836   841   844   880
DOWNTO                     786
ENTER                      633
EOF                        632   633   634   700   701   702
EQU                        314   315   369   410   411   518   520   567   572
                           574   574   574   929   931   933   934   947   950
                           980   981   983
ERRMSG                     159   183   184   185   186   187   188   189   190
                           191   192   195   197   199   201   203   205   207
                           209   411   414   420
ERRORROUTINE               427   531   585  1237
FAILEDHOSTS                164   901  1031  1052
FATAL                      402   441   447   504   525   579   610   990  1004
                          1064  1089  1097  1122  1139  1146  1177  1199
FILCHAN                    700   701   704
FIRSTCHARWASW              497   514   517   542
FOO                        327   328   727   728   758   769   770   875   876

SUPCHK.WOK          created 25-Mar-85 10:17                      Page 34
User Defined Symbolsby CRFSYM %5 at 19-Jan-87 14:14

FOUND                      775   780   785   793
GETBREAK                   812   866
GETCHAN                    632   700
GETDATE                    261   352   513   565   600   972  1027
GETHOSTS                   853  1296
GETTIME                    275   352   513   565   600   972  1027
GETWAITPERIOD              299  1300
H                          152   870   872   878  1038  1046  1049  1052
HANDSHAKERECD             1022  1045  1134  1154
HOST                       402   486   504   525   531   550   579   585   610
                           888   901
HOSTNUM                    427   441   447   451   907   973   990  1004  1005
HOSTS                      163   652   737   740   740   778   783   787   787
                           788   796   816   817   878  1049
HOURS                      283   285   286   287   288   290
HRL                        222
HRRI                       223
HRRZ                       224
I                          177   177   177   177   178   180   182   192   209
                           651   652   735   737   739   758   776   778   783
                           786   788   815   816
INBRCHAR                   147   812   866   867   869
INCHWL                     314   670   722   764
INEOF                      150
INPUT                      867   869
INTSCAN                    327   727   769   875
J                          739   740   740   758   786   787   787
JFCL                       255
LASTHOST                   156   651   741   741   786   789   789   796   796
                           815   817   872  1038
LINE                       161   308   314   315   327   670   722   725   727
                           764   767   769   862   869   873   875
LOOKUP                     701
MAILWAITING                917   922   932   953
MINUTES                    283   286   291   292   294
MONTH                      270   272
MOVE                       225   253
MSG                        402   410   416
NAMEFORTHENEWFILE          621   633   635
NAMEOFTHEFILE              689   701   703
NEWFILCHAN                 632   633   636
NHOSTS                     163   164   735   739   776   870
NUMOFBADHOSTS              155   900   900   901  1029  1046
ONEHOST                    875   878
OPEN                       632   700
OPENFIL                    689   864
OUTCHAN                    151   813   814   816   817   819
OUTCHR                     238
PERIOD                     327   333
POLLHOSTS                 1013  1305  1312
RAW                        269   270   271   271   283   284   285   286
READBATCHREQ               550  1217  1220
READSPOOLREQ               486  1214
REDOINGFAILURES            139   899  1024  1036  1311
RELEASE                    819
RESPONSE                   916   921   928   928   930   931   933   934   946

SUPCHK.WOK          created 25-Mar-85 10:17                      Page 35
User Defined Symbolsby CRFSYM %5 at 19-Jan-87 14:14

                           946   948   949   950   967   974   975   979   979
                           980   981   984
S                          218
SAVEFORRETRY               888  1005  1065
SAVLINE                    309   314   330   717   725   730   759   767   772
                           862   873   877
SECONDPASSINPROGRESS       144  1030  1034  1046  1048
SEEIFVALIDUSER             357  1293
SETBREAK                   812   866
SHOURS                     288   290   295
SITEFILENAME               134   813   864
SITEID                     161   451   512   564   599   868   957   971   973
                          1054  1208
SITENAMELINE               161   650   814   867   868  1026
SMINUTES                   292   294   295
SP                         224   225
STORECHANGES               802   849
SYSNUM                     727   733   737   758   769   778   783   788   796
TEMP                       367   369   370   372
THEQUESTION                656   668
TIM                        230   235
TIMEOUT                    438   444   501   522   576   607   926   944   977
                          1086  1094  1102  1104  1107  1110  1151  1161  1163
                          1166  1169  1196
TYPEIT                     242
UNAME                      167   177
UPTO                       177   651   735   739   776   815  1038
USERERR                    372   635   703
USERNAME                   158
UUO!ZAPCIR                 254
VALIDUSER                  160  1293
VALIDUSERNAME              135   369   373
WAITING                    342  1314
WAITPERIOD                 154   342   353  1300  1314
X                          175   177   178
YEAR                       271   272
YES                        656   833   838   843   848   881
  @M
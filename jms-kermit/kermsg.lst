KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1
KERMSG	MAC	18-Jan-73 17:20	

     1					;[CSM] B361LB.REL is on SYS:, not DSKB:[1,5]
     2					;   0001  0	%TITLE 'KERMSG - Kermit message processing'
     3					;   0002  0	MODULE KERMSG (IDENT = '3.0.041'
     4					;   0003  0			) =
     5					;   0004  1	BEGIN
     6					;   0005  1	
     7					;   0006  1	SWITCHES LANGUAGE (COMMON);
     8					;   0007  1	
     9					;   0008  1	!<BLF/WIDTH:100>
    10					;   0009  1	
    11					;   0010  1	!++
    12					;   0011  1	! FACILITY:
    13					;   0012  1	!   Kermit-10, VMS Kermit, Pro/Kermit
    14					;   0013  1	!
    15					;   0014  1	! ABSTRACT:
    16					;   0015  1	!	KERMSG is the message processing routines for Kermit-10, VMS Kermit,
    17
    18					;   0016  1	!	and PRO/Kermit.
    19					;   0017  1	!	This module is written in common BLISS, so that it can be
    20					;   0018  1	!	transported for the DECsystem-10 and VAX/VMS systems.
    21					;   0019  1	!
    22					;   0020  1	! ENVIRONMENT:
    23					;   0021  1	!   User mode
    24					;   0022  1	!
    25					;   0023  1	! AUTHOR: Robert C. McQueen, CREATION DATE: 24-January-1983
    26					;   0024  1	!
    27					;   0025  1	! MODIFIED BY:
    28					;   0026  1	!
    29					;   0027  1	!--
    30					;   0028  1	
    31					;   0029  1	%SBTTL 'Table of Contents'
    32					;   0030  1	!+
    33					;   0031  1	!.pag.lit
    34					;   0032  1	!		Table of Contents for KERMSG
    35					;   0033  1	!
    36					;   0034  1	!
    37					;   0035  1	!			   Section			      Page
    38					;   0036  1	!   1. Revision History . . . . . . . . . . . . . . . . . . .    3
    39					;   0037  1	!   2. Interface requirements . . . . . . . . . . . . . . . .    4
    40					;   0038  1	!   3. Declarations
    41					;   0039  1	!        3.1.   Forward definitions . . . . . . . . . . . . .    5
    42					;   0040  1	!   4. Require files. . . . . . . . . . . . . . . . . . . . .   28
    43					;   0041  1	!   5. Macro definitions. . . . . . . . . . . . . . . . . . .   29
    44					;   0042  1	!   6. KERMIT Protocol Definitions. . . . . . . . . . . . . .   30
    45					;   0043  1	!        6.1.   Packet offsets. . . . . . . . . . . . . . . .   31
    46					;   0044  1	!        6.2.   Message dependent field . . . . . . . . . . .   32
    47					;   0045  1	!        6.3.   SEND initiate packet. . . . . . . . . . . . .   33
    48					;   0046  1	!   7. KERMIT Protocol States . . . . . . . . . . . . . . . .   34
    49					;   0047  1	!   8. Internal constants . . . . . . . . . . . . . . . . . .   35
    50					;   0048  1	!   9. Storage - External . . . . . . . . . . . . . . . . . .   36
    51					;   0049  1	!  10. Storage - Local. . . . . . . . . . . . . . . . . . . .   37
    52					;   0050  1	!  11. External references. . . . . . . . . . . . . . . . . .   38
    53					;   0051  1	!  12. MSG%INIT . . . . . . . . . . . . . . . . . . . . . . .   39
    54					;   0052  1	!  13. SND%ERROR. . . . . . . . . . . . . . . . . . . . . . .   40
    55					;   0053  1	!  14. SERVER - Server mode . . . . . . . . . . . . . . . . .   41
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-1
KERMSG	MAC	18-Jan-73 17:20	

    56					;   0054  1	!  15. SEND%SWITCH. . . . . . . . . . . . . . . . . . . . . .   42
    57					;   0055  1	!  16. REC%SWITCH . . . . . . . . . . . . . . . . . . . . . .   43
    58					;   0056  1	!  17. Server
    59					;   0057  1	!       17.1.   DO%GENERIC - Execute a generic command. . . .   44
    60					;   0058  1	!  18. DO%TRANSACTION - Main loop for FSM . . . . . . . . . .   45
    61					;   0059  1	!  19. REC%SERVER%IDLE - Idle server state. . . . . . . . . .   46
    62					;   0060  1	!  20. SEND%SERVER%INIT . . . . . . . . . . . . . . . . . . .   47
    63					;   0061  1	!  21. SEND%DATA. . . . . . . . . . . . . . . . . . . . . . .   48
    64					;   0062  1	!  22. SEND%FILE. . . . . . . . . . . . . . . . . . . . . . .   49
    65					;   0063  1	!  23. SEND%EOF . . . . . . . . . . . . . . . . . . . . . . .   50
    66					;   0064  1	!  24. SEND%INIT. . . . . . . . . . . . . . . . . . . . . . .   51
    67					;   0065  1	!  25. SEND%OPEN%FILE - Open file for sending . . . . . . . .   52
    68					;   0066  1	!  26. SEND%GENCMD. . . . . . . . . . . . . . . . . . . . . .   53
    69					;   0067  1	!  27. SEND%BREAK . . . . . . . . . . . . . . . . . . . . . .   54
    70					;   0068  1	!  28. REC%INIT . . . . . . . . . . . . . . . . . . . . . . .   55
    71					;   0069  1	!  29. REC%FILE . . . . . . . . . . . . . . . . . . . . . . .   56
    72					;   0070  1	!  30. REC%DATA . . . . . . . . . . . . . . . . . . . . . . .   57
    73					;   0071  1	!  31. SERVER - Generic commands. . . . . . . . . . . . . . .   58
    74					;   0072  1	!  32. HOST%COMMAND - perform a host command. . . . . . . . .   59
    75					;   0073  1	!  33. CALL%SY%RTN - handle operating system dependent functions  60
    76					;   0074  1	!  34. Message processing
    77					;   0075  1	!       34.1.   PRS%SEND%INIT - Parse send init params. . . .   61
    78					;   0076  1	!  35. SET%SEND%INIT. . . . . . . . . . . . . . . . . . . . .   62
    79					;   0077  1	!  36. SEND%PACKET. . . . . . . . . . . . . . . . . . . . . .   63
    80					;   0078  1	!  37. REC%MESSAGE - Receive a message. . . . . . . . . . . .   64
    81					;   0079  1	!  38. REC%PACKET . . . . . . . . . . . . . . . . . . . . . .   65
    82					;   0080  1	!  39. CALC%BLOCK%CHECK . . . . . . . . . . . . . . . . . . .   66
    83					;   0081  1	!  40. NORMALIZE%FILE - Put file name into normal form. . . .   67
    84					;   0082  1	!  41. Buffer filling
    85					;   0083  1	!       41.1.   Main routine. . . . . . . . . . . . . . . . .   68
    86					;   0084  1	!  42. BFR%EMPTY. . . . . . . . . . . . . . . . . . . . . . .   69
    87					;   0085  1	!  43. Buffer filling and emptying subroutines. . . . . . . .   70
    88					;   0086  1	!  44. Add parity routine . . . . . . . . . . . . . . . . . .   71
    89					;   0087  1	!  45. Parity routine . . . . . . . . . . . . . . . . . . . .   72
    90					;   0088  1	!  46. Per transfer
    91					;   0089  1	!       46.1.   Initialization. . . . . . . . . . . . . . . .   73
    92					;   0090  1	!  47. Statistics
    93					;   0091  1	!       47.1.   Finish message transfer . . . . . . . . . . .   74
    94					;   0092  1	!  48. Status type out
    95					;   0093  1	!       48.1.   STS%OUTPUT. . . . . . . . . . . . . . . . . .   75
    96					;   0094  1	!  49. TYPE%CHAR - Type out a character . . . . . . . . . . .   76
    97					;   0095  1	!  50. Debugging
    98					;   0096  1	!       50.1.   DBG%SEND. . . . . . . . . . . . . . . . . . .   77
    99					;   0097  1	!       50.2.   DBG%RECEIVE . . . . . . . . . . . . . . . . .   78
   100					;   0098  1	!       50.3.   DBG%MESSAGE . . . . . . . . . . . . . . . . .   79
   101					;   0099  1	!  51. End of KERMSG. . . . . . . . . . . . . . . . . . . . .   80
   102					;   0100  1	!.end lit.pag
   103					;   0101  1	!-
   104					;   0102  1	%SBTTL 'Revision History'
   105					;   0103  1	
   106					;   0104  1	!++
   107					;   0105  1	! Start of version 1.
   108					;   0106  1	!
   109					;   0107  1	! 1.0.000	By: Robert C. McQueen		On: 4-Jan-1983
   110					;   0108  1	!		Create this program.
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-2
KERMSG	MAC	18-Jan-73 17:20	

   111					;   0109  1	!
   112					;   0110  1	! 1.0.001	By: Robert C. McQueen		On: 30-Apr-1983
   113					;   0111  1	!		Change PAR%xxx to be PR%xxx, so that they can be used for
   114					;   0112  1	!		KERMIT-10.
   115					;   0113  1	!
   116					;   0114  1	! 1.0.002	By: Robert C. McQueen		On: 1-May-1983
   117					;   0115  1	!		Add DO%GENERIC routine to cause a generic Kermit command to
   118					;   0116  1	!		be executed on the remote Kermit.
   119					;   0117  1	!
   120					;   0118  1	! 1.0.003	By: Robert C. McQueen		On: 3-May-1983
   121					;   0119  1	!		Fix message number incrementing.
   122					;   0120  1	!
   123					;   0121  1	! 1.0.004	By: Robert C. McQueen		On: 4-May-1983
   124					;   0122  1	!		Allow RECEIVE file-specification to work correctly.
   125					;   0123  1	!
   126					;   0124  1	! 1.0.005	By: Robert C. McQueen		On: 6-May-1983
   127					;   0125  1	!		Add more stats support.
   128					;   0126  1	!
   129					;   0127  1	! 1.0.006	By: Nick Bush			On: 13-June-1983
   130					;   0128  1	!		Fix SEND%PACKET to copy correct characters when fixing
   131					;   0129  1	!		parity bits.
   132					;   0130  1	!
   133					;   0131  1	! 1.1.007	By: Nick Bush			On: 15-July-1983
   134					;   0132  1	!		Correct SEND-INIT message handling to do the right things
   135					;   0133  1	!		with the protocol version 3 items.
   136					;   0134  1	!
   137					;   0135  1	! 1.1.010	By: Robert C. McQueen		On: 20-July-1983
   138					;   0136  1	!		Make PARITY a global routine, so that it can be called by
   139					;   0137  1	!		CONNECT processing.  Change the name from PARITY to GEN%PARI
   140					TY
   141					;   0138  1	!		add a new routine to generate the parity, since it is not
   142					;   0139  1	!		part of the checksum.
   143					;   0140  1	!
   144					;   0141  1	! 1.1.011	By: Robert C. McQueen		On: 28-July-1983
   145					;   0142  1	!		KER%TIMEOUT errors in the SERVER loop would cause
   146					;   0143  1	!		KER%UNISRV error messages to be returned to the remote.
   147					;   0144  1	!		Check for receive failures and send NAKs instead.
   148					;   0145  1	!
   149					;   0146  1	! 1.2.012	By: Robert C. McQueen		On: 23-August-1983
   150					;   0147  1	!		Don't abort if we get a message that is just an end of line
   151					;   0148  1	!		character.  It could be noise on the line.
   152					;   0149  1	!
   153					;   0150  1	! 1.2.013	By: Nick Bush			On: 7-September-1983
   154					;   0151  1	!		Fix several problems with the SEND%xxx parameters
   155					;   0152  1	!
   156					;   0153  1	! 1.2.014	By: Robert C. McQueen		On: 15-September-1983
   157					;   0154  1	!		Add routine calls to XFR%STATUS to tell the user on the
   158					;   0155  1	!		number of packets have changed.
   159					;   0156  1	!
   160					;   0157  1	! 1.2.015	By: Nick Bush			On: 5-October-1983
   161					;   0158  1	!		Add 2 and 3 character checksum (block check) support.
   162					;   0159  1	!		Add support for data within acknowledgement packets
   163					;   0160  1	!		and withing end-of-file packets to allow for file
   164					;   0161  1	!		transmission to be aborted.  Also add support for
   165					;   0162  1	!		"I" packet to allow server parameters to be initialized.
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-3
KERMSG	MAC	18-Jan-73 17:20	

   166					;   0163  1	!
   167					;   0164  1	! 1.2.016	By: Nick Bush			On: 19-October-1983
   168					;   0165  1	!		Add repeat character support.
   169					;   0166  1	!
   170					;   0167  1	! 2.0.017	Release TOPS-10 Kermit-10 version 2.0
   171					;   0168  1	!		Release VAX/VMS Kermit-32 version 2.0
   172					;   0169  1	!
   173					;   0170  1	! 2.0.018	By: Robert C. McQueen		On: 16-November-1983
   174					;   0171  1	!		Fix four checks on the message number that were not
   175					;   0172  1	!		mod 64.
   176					;   0173  1	!
   177					;   0174  1	! 2.0.019	By: Robert C. McQueen		On: 16-November-1983
   178					;   0175  1	!		Remove the CLEAR routine.  It is not really needed.
   179					;   0176  1	!
   180					;   0177  1	! 2.0.020	By: Nick Bush			On: 12-Dec-1983
   181					;   0178  1	!		Fix SEND%DATA and BFR%FILL to handle empty files and
   182					;   0179  1	!		files which happen to end just on a message boundary.
   183					;   0180  1	!		This would sometimes produce extra nulls.
   184					;   0181  1	!
   185					;   0182  1	! 2.0.021	By: Nick Bush			On: 15-Dec-1983
   186					;   0183  1	!		Fix some problems with REC%MESSAGE which would cause
   187					;   0184  1	!		aborts when a message timed out.
   188					;   0185  1	!
   189					;   0186  1	! 2.0.022	By: Robert C. McQueen		19-Dec-1983
   190					;   0187  1	!		Make STATUS a local for most routines and remove FILE%DUMP
   191					;   0188  1	!		as it is nolonger needed.
   192					;   0189  1	!
   193					;   0190  1	! 2.0.023	By: Nick Bush			On: 3-Jan-1984
   194					;   0191  1	!		Change FIL%NORMAL%FORM to contain not just a flag, but
   195					;   0192  1	!		a file name type instead.
   196					;   0193  1	!
   197					;   0194  1	! 2.0.024	By: Nick Bush			On: 11-Jan-1984
   198					;   0195  1	!		Fix REC%MESSAGE to send NAK for packet we expect, not
   199					;   0196  1	!		previous packet.
   200					;   0197  1	!
   201					;   0198  1	! 2.0.025	By: Nick Bush			On: 23-Jan-1984
   202					;   0199  1	!		Re-enable server-init packet and complete code so that
   203					;   0200  1	!		parameters set by it will remain set.
   204					;   0201  1	!		Fix file name copying to use BFR%FILL or BFR%EMPTY
   205					;   0202  1	!		so that all quoting/compression is done properly.
   206					;   0203  1	!
   207					;   0204  1	! 2.0.026	By: Nick Bush			On: 15-Feb-1984
   208					;   0205  1	!		Add code for generic command support (both directions).
   209					;   0206  1	!		There is now only one state dispatch loop, entered
   210					;   0207  1	!		in various states for different functions.
   211					;   0208  1	!
   212					;   0209  1	! 2.0.027	By: Robert C. McQueen		On: 16-Feb-1984
   213					;   0210  1	!		At some point SEND%TIMEOUT became global, but it was not mov
   214					ed
   215					;   0211  1	!		to KERGLB.  This edit moves it to KERGLB.BLI.
   216					;   0212  1	!
   217					;   0213  1	! 2.0.030	By: Nick Bush			On: 2-March-1984
   218					;   0214  1	!		Fix BFR%FILL to handle case of last repeated character
   219					;   0215  1	!		not fitting within a packet.  It was forgetting to
   220					;   0216  1	!		send the characters at all.
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-4
KERMSG	MAC	18-Jan-73 17:20	

   221					;   0217  1	!
   222					;   0218  1	! 2.0.031	By: Nick Bush			On: 6-March-1984
   223					;   0219  1	!		Make sure FILE%OPEN%FLAG is set properly when advancing
   224					;   0220  1	!		to next file of a wild-card send.  The file was not
   225					;   0221  1	!		being set true, leading to problems after a couple files.
   226					;   0222  1	!
   227					;   0223  1	! 2.0.032	By: Nick Bush			On: 9-March-1984
   228					;   0224  1	!		Fix UNPACK%DATA in SERVER%GENERIC to properly store
   229					;   0225  1	!		new string pointer.
   230					;   0226  1	!
   231					;   0227  1	! 2.0.033	By: Robert C. McQueen		On: 12-March-1984
   232					;   0228  1	!		If NEXT%FILE fails with anything other than a NOMORFILES
   233					;   0229  1	!		it should change state to STATE%A not STATE%SB.  This
   234					;   0230  1	!		fixes a problem caused by Pro/Kermit and KERFIL (VMS).
   235					;   0231  1	!
   236					;   0232  1	! 2.0.034	By: Nick Bush			On: 15-March-1984
   237					;   0233  1	!		Put file spec into X packet as well as F packet. This
   238					;   0234  1	!		makes wild card TYPE's work nicer.
   239					;   0235  1	!
   240					;   0236  1	! 2.0.035	By: Nick Bush			On: 20-March-1984
   241					;   0237  1	!		Fix send/receive quoting to conform to the way the
   242					;   0238  1	!		protocol manual says it should be done, rather
   243					;   0239  1	!		than the way we (and Kermit-20) have always done it.
   244					;   0240  1	!
   245					;   0241  1	! 2.0.036	By: Nick Bush			On: 28-March-1984
   246					;   0242  1	!		Make SERVER%GENERIC more defensive against badly
   247					;   0243  1	!		constructed packets.  If an argument has negative
   248					;   0244  1	!		length, punt the request.  Also put angle brackets
   249					;   0245  1	!		around data from "X" packet header, so file names will
   250					;   0246  1	!		stick out.
   251					;   0247  1	!
   252					;   0248  1	! 3.0.037	Start of version 3.
   253					;   0249  1	!
   254					;   0250  1	! 3.0.040	By: Nick Bush			On: 2-April-1984
   255					;   0251  1	!		Add separate server timeout.  This allows stopping the
   256					;   0252  1	!		server NAK's without affecting the normal packet timeout.
   257					;   0253  1	!
   258					;   0254  1	! 3.0.041	By: Nick Bush			On: 12-April-1984
   259					;   0255  1	!		Fix block check calculation to account for the fact
   260					;   0256  1	!		that the parity bits are put onto the message when
   261					;   0257  1	!		it is sent (in place), so that if a retransmission is
   262					;   0258  1	!		done without refilling the buffer (as is normal with
   263					;   0259  1	!		data messages), the parity bits will be there.  Make
   264					;   0260  1	!		sure we strip them out for block check calculation.
   265					;   0261  1	!--
   266					;   0262  1	
   267					;   0263  1	%SBTTL 'Interface requirements'
   268					;   0264  1	
   269					;   0265  1	!++
   270					;   0266  1	!		Interface requirements
   271					;   0267  1	!
   272					;   0268  1	! The following routines and data locations are rquired for a correct
   273					;   0269  1	! implementation of KERMIT.
   274					;   0270  1	!
   275					;   0271  1	! File routines:
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-5
KERMSG	MAC	18-Jan-73 17:20	

   276					;   0272  1	!
   277					;   0273  1	!	FILE%OPEN (Function)
   278					;   0274  1	!		This routine will open a file for reading or writting.  It
   279					;   0275  1	!		will assume that FILE%SIZE contains the number of bytes
   280					;   0276  1	!		and FILE%NAME contains the file name of length FILE%SIZE.
   281					;   0277  1	!		The function that is passed is either FNC%READ or FNC%WRITE.
   282
   283					;   0278  1	!
   284					;   0279  1	!	FILE%CLOSE ()
   285					;   0280  1	!		This routine will close the currently open file.  This
   286					;   0281  1	!		routine will return the status of the operation.
   287					282  1	!
   288					;   0283  1	!	GET%FILE (Character)
   289					;   0284  1	!		This routine will get a character from the currently open fi
   290					le
   291					;   0285  1	!		and store it in the location specified by "Character".  Ther
   292					e
   293					;   0286  1	!		will be a true/false value returned by the routine to determ
   294					ine
   295					;   0287  1	!		if there was an error.
   296					;   0288  1	!
   297					;   0289  1	!	PUT%FILE (Character)
   298					;   0290  1	!		This routine will output a character to the currently open
   299					;   0291  1	!		file.  It will return a true/false value to determine if the
   300
   301					;   0292  1	!		routine was successful.
   302					;   0293  1	!
   303					;   0294  1	!	NEXT%FILE ()
   304					;   0295  1	!		This routine will advance to the next file.  This routine
   305					;   0296  1	!		will return false if there are no more files to process.
   306					;   0297  1	!
   307					;   0298  1	! Communications line routines:
   308					;   0299  1	!
   309					;   0300  1	!	RECEIVE (Buffer address, Address of var to store length into)
   310					;   0301  1	!		This routine will receive a message from the remote Kermit.
   311					;   0302  1	!
   312					;   0303  1	!	SEND (Buffer address, Length in characters)
   313					;   0304  1	!		This routine will send a message to the remote Kermit.
   314					;   0305  1	!
   315					;   0306  1	!	GEN%CRC (Buffer address, length in characters)
   316					;   0307  1	!		This routine will calculate the CRC-CCITT for the characters
   317
   318					;   0308  1	!		in the buffer.
   319					;   0309  1	!
   320					;   0310  1	! Operating system routines:
   321					;   0311  1	!
   322					;   0312  1	!	SY%DISMISS (Seconds)
   323					;   0313  1	!		This routine will cause Kermit to sleep for the specified
   324					;   0314  1	!		number of seconds.  It is used to handle the DELAY parameter
   325					.
   326					;   0315  1	!
   327					;   0316  1	!	SY%LOGOUT ()
   328					;   0317  1	!		Log the job off of the system. (Kill the process).
   329					;   0318  1	!
   330					;   0319  1	!	SY%TIME ()
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-6
KERMSG	MAC	18-Jan-73 17:20	

   331					;   0320  1	!		This routine will return the starting time milliseconds.
   332					;   0321  1	!		It can be the start of Kermit, the system, etc, so long
   333					;   0322  1	!		as it always is incrementing.
   334					;   0323  1	!
   335					;   0324  1	! Status routines:
   336					;   0325  1	!
   337					;   0326  1	!	XFR%STATUS (Type, Subtype);
   338					;   0327  1	!		This routine is called to indicate the occurance of
   339					;   0328  1	!		a significant event that the user interface may wish
   340					;   0329  1	!		to inform the user about.  The arguments indicate the
   341					;   0330  1	!		type of event.
   342					;   0331  1	!		Type: "S" - Send, "R" - Receive
   343					;   0332  1	!			Subtype: "P" - Packet
   344					;   0333  1	!				 "N" - NAK
   345					;   0334  1	!				 "T" - timeout
   346					;   0335  1	!		For type = "I" (initiate), "T" (terminate):
   347					;   0336  1	!			Subtype: "S" - a file send
   348					;   0337  1	!				 "R" - a file receive
   349					;   0338  1	!				 "G" - a generic command
   350					;   0339  1	!				 "I" - for "T" only, returning to server idl
   351					e
   352					;   0340  1	!		For type = "F" (file operation):
   353					;   0341  1	!			Subtype: "S" - open for sending
   354					;   0342  1	!				 "R" - open for receiving
   355					;   0343  1	!				 "C" - closing file OK
   356					;   0344  1	!				 "X" - aborting file by user request
   357					;   0345  1	!				 "Z" - aborting group by user request
   358					;   0346  1	!				 "D" - aborting file, but saving due to disp
   359					osition
   360					;   0347  1	!				 "A" - aborting file due to protocol error
   361					;   0348  1	!
   362					;   0349  1	! Error processing:
   363					;   0350  1	!
   364					;   0351  1	!	KRM%ERROR (Error parameter)
   365					;   0352  1	!		This routine will cause an error message to be issued.
   366					;   0353  1	!		The error parameter is defined by KERERR.  This may cause
   367					;   0354  1	!		SND%ERROR to be called to send an "E" message to the remote.
   368
   369					;   0355  1	!
   370					;   0356  1	! Terminal I/O routines:
   371					;   0357  1	!
   372					;   0358  1	!	TERM%DUMP (Buffer, Count)
   373					;   0359  1	!	DBG%DUMP (Buffer, Count)
   374					;   0360  1	!		This routine will dump the buffer onto the user's terminal.
   375					;   0361  1	!		The routine is supplied with the count of the characters
   376					;   0362  1	!		and the address of the buffer.
   377					;   0363  1	!		These may be the same routine or different.  DBG%DUMP
   378					;   0364  1	!		is only called for debugging output.
   379					;   0365  1	!
   380					;   0366  1	!
   381					;   0367  1	!			ENTRY POINTS
   382					;   0368  1	!
   383					;   0369  1	! KERMSG contains the following entry points for the KERMIT.
   384					;   0370  1	!
   385					;   0371  1	!	SERVER ()
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-7
KERMSG	MAC	18-Jan-73 17:20	

   386					;   0372  1	!		This routine will cause KERMIT go enter server mode.
   387					;   0373  1	!
   388					;   0374  1	!	SEND%SWITCH ()
   389					;   0375  1	!		This routine will send a file.  It expects that the user
   390					;   0376  1	!		has stored the text of the file name into FILE%NAME and
   391					;   0377  1	!		the length of the text into FILE%SIZE.
   392					;   0378  1	!
   393					;   0379  1	!	REC%SWITCH ()
   394					;   0380  1	!		This routine will receive a file.  It expects that the defau
   395					lt
   396					;   0381  1	!		file name is set up in FILE%NAME and the length is in
   397					;   0382  1	!		FILE%SIZE.
   398					;   0383  1	!
   399					;   0384  1	!	GEN%PARITY (Character)
   400					;   0385  1	!		This routine will return the character with the proper parit
   401					y
   402					;   0386  1	!		on the character.
   403					;   0387  1	!
   404					;   0388  1	!	SND%ERROR (COUNT, ADDRESS)
   405					;   0389  1	!		This routine will send the text of an error to the remote
   406					;   0390  1	!		Kermit.
   407					;   0391  1	!
   408					;   0392  1	!	DO%GENERIC (TYPE)
   409					;   0393  1	!		This routine will cause a generic function to be sent to
   410					;   0394  1	!		the remote Kermit.  This routine will then do all of the
   411					;   0395  1	!		necessary hand shaking to handle the local end of the generi
   412					c
   413					;   0396  1	!		Kermit command.
   414					;   0397  1	!
   415					;   0398  1	!
   416					;   0399  1	!		GLOBAL Storage
   417					;   0400  1	!
   418					;   0401  1	! The following are the global storage locations that are used to interface
   419					;   0402  1	! to KERMSG.  These locations contains the various send and receive paramete
   420					rs.
   421					;   0403  1	!
   422					;   0404  1	! Receive parameters:
   423					;   0405  1	!
   424					;   0406  1	!	RCV%PKT%SIZE
   425					;   0407  1	!		Receive packet size.
   426					;   0408  1	!	RCV%NPAD
   427					;   0409  1	!		Padding length
   428					;   0410  1	!	RCV%PADCHAR
   429					;   0411  1	!		Padding character
   430					;   0412  1	!	RCV%TIMEOUT
   431					;   0413  1	!		Time out
   432					;   0414  1	!	RCV%EOL
   433					;   0415  1	!		End of line character
   434					;   0416  1	!	RCV%QUOTE%CHR
   435					;   0417  1	!		Quote character
   436					;   0418  1	!	RCV%8QUOTE%CHR
   437					;   0419  1	!		8-bit quoting character
   438					;   0420  1	!	RCV%SOH
   439					;   0421  1	!		Start of header character
   440					;   0422  1	!
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-8
KERMSG	MAC	18-Jan-73 17:20	

   441					;   0423  1	! Send parameters (Negative values denote the default, positive user supplie
   442					d):
   443					;   0424  1	!
   444					;   0425  1	!	SND%PKT%SIZE
   445					;   0426  1	!		Send packet size
   446					;   0427  1	!	SND%NPAD
   447					;   0428  1	!		Padding length
   448					;   0429  1	!	SND%PADCHAR
   449					;   0430  1	!		Padding character
   450					;   0431  1	!	SND%TIMEOUT
   451					;   0432  1	!		Time out
   452					;   0433  1	!	SND%EOL
   453					;   0434  1	!		End of line character
   454					;   0435  1	!	SND%QUOTE%CHR
   455					;   0436  1	!		Quote character
   456					;   0437  1	!	SND%SOH
   457					;   0438  1	!		Start of header character (normally 001)
   458					;   0439  1	!
   459					;   0440  1	! Statistics:
   460					;   0441  1	!
   461					;   0442  1	!	SND%TOTAL%CHARS
   462					;   0443  1	!		Total characters sent for this Kermit session
   463					;   0444  1	!	RCV%TOTAL%CHARS
   464					;   0445  1	!		Total characters received for this Kermit session
   465					;   0446  1	!	SND%DATA%CHARS
   466					;   0447  1	!		Total number of data characters sent for this Kermit session
   467
   468					;   0448  1	!	RCV%DATA%CHARS
   469					;   0449  1	!		Total number of data characters received for this Kermit ses
   470					sion
   471					;   0450  1	!	SND%COUNT
   472					;   0451  1	!		Total number of packets that have been sent
   473					;   0452  1	!	RCV%COUNT
   474					;   0453  1	!		Total number of packets that have been received.
   475					;   0454  1	!	SMSG%TOTAL%CHARS
   476					;   0455  1	!		Total characters sent for this file transfer
   477					;   0456  1	!	RMSG%TOTAL%CHARS
   478					;   0457  1	!		Total characters received for this file transfer
   479					;   0458  1	!	SMSG%DATA%CHARS
   480					;   0459  1	!		Total data characters sent for this file transfer
   481					;   0460  1	!	RMSG%DATA%CHARS
   482					;   0461  1	!		Total data characters received for this file transfer
   483					;   0462  1	!	SMSG%NAKS
   484					;   0463  1	!		Total number of NAKs sent for this file transfer
   485					;   0464  1	!	RMSG%NAKS
   486					;   0465  1	!		Total number of NAKs received for this file transfer
   487					;   0466  1	!	XFR%TIME
   488					;   0467  1	!		Amount of time the last transfer took in milliseconds.
   489					;   0468  1	!	TOTAL%TIME
   490					;   0469  1	!		Total amount of time spend transfering data.
   491					;   0470  1	!
   492					;   0471  1	! Misc constants:
   493					;   0472  1	!
   494					;   0473  1	!	LAST%ERROR
   495					;   0474  1	!		ASCIZ of the last error message issued.
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-9
KERMSG	MAC	18-Jan-73 17:20	

   496					;   0475  1	!	FILE%NAME
   497					;   0476  1	!		Vector containing the ASCII characters of the file name.
   498					;   0477  1	!	FILE%SIZE
   499					;   0478  1	!		Number of characters in the FILE%NAME vector.
   500					;   0479  1	!	DELAY
   501					;   0480  1	!		Amount of time to delay
   502					;   0481  1	!	DUPLEX
   503					;   0482  1	!		DP%HALF or DP%FULL to denote either half duplex or full dupl
   504					ex.
   505					;   0483  1	!		[Currently only DP%FULL is supported]
   506					;   0484  1	!	PKT%RETRIES
   507					;   0485  1	!		Number of retries to attempt to read a message.
   508					;   0486  1	!	SI%RETRIES
   509					;   0487  1	!		Number of retries to attempt on send inits
   510					;   0488  1	!	DEBUG%FLAG
   511					;   0489  1	!		Debugging mode on/off
   512					;   0490  1	!	WARN%FLAG
   513					;   0491  1	!		File warning flag
   514					;   0492  1	!	IBM%FLAG
   515					;   0493  1	!		True if talking to an IBM system, else false.
   516					;   0494  1	!	ECHO%FLAG
   517					;   0495  1	!		Local echo flag
   518					;   0496  1	!	CONNECT%FLAG
   519					;   0497  1	!		Connected flag; True if terminal and SET LINE are the same
   520					;   0498  1	!	PARITY%TYPE
   521					;   0499  1	!		Type of parity to use on sends.
   522					;   0500  1	!	DEV%PARITY%FLAG
   523					;   0501  1	!		Device will add parity to message.  True if device adds
   524					;   0502  1	!		parity and false if we must do it.
   525					;   0503  1	!
   526					;   0504  1	!--
   527					;   0505  1	
   528					;   0506  1	%SBTTL 'Declarations -- Forward definitions'
   529					;   0507  1	!<BLF/NOFORMAT>
   530					;   0508  1	!
   531					;   0509  1	! Forward definitions
   532					;   0510  1	!
   533					;   0511  1	
   534					;   0512  1	FORWARD ROUTINE
   535					;   0513  1	
   536					;   0514  1	! Main loop for a complete transaction
   537					;   0515  1	    DO%TRANSACTION,		! Perform a complete transaction
   538					;   0516  1	
   539					;   0517  1	! Send processing routines
   540					;   0518  1	
   541					;   0519  1	    SEND%SERVER%INIT,		![026] Send a server init packet
   542					;   0520  1	    SEND%DATA,			! Send data to the micro
   543					;   0521  1	    SEND%FILE,			! Send file name
   544					;   0522  1	    SEND%OPEN%FILE,			! Open file for sending
   545					;   0523  1	    SEND%GENCMD,		! Send generic command
   546					;   0524  1	    SEND%EOF,			! Send EOF
   547					;   0525  1	    SEND%INIT,			! Send initialization msg
   548					;   0526  1	    SEND%BREAK,			! Send break end of transmission
   549					;   0527  1	
   550					;   0528  1	! Receive processing routines
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-10
KERMSG	MAC	18-Jan-73 17:20	

   551					;   0529  1	
   552					;   0530  1	    REC%SERVER%IDLE,		! Wait for message while server is idle
   553					;   0531  1	    REC%INIT,			! Receive initialization
   554					;   0532  1	    REC%FILE,			! Receive file information
   555					;   0533  1	    REC%DATA,			! Receive data
   556					;   0534  1	!
   557					;   0535  1	! Server processing routines
   558					;   0536  1	!
   559					;   0537  1	    SERVER%GENERIC,		! Process generic KERMIT commands
   560					;   0538  1	    HOST%COMMAND,		! Process host command
   561					;   0539  1	    KERMIT%COMMAND,		! Process Kermit command
   562					;   0540  1	    CALL%SY%RTN,		! Handle calling system routine and returnin
   563					g result
   564					;   0541  1	!
   565					;   0542  1	! Statistic gathering routines
   566					;   0543  1	!
   567					;   0544  1	    END%STATS	: NOVALUE,	! End of a message processing stats routine
   568					;   0545  1	
   569					;   0546  1	! Low level send/receive routines
   570					;   0547  1	
   571					;   0548  1	    CALC%BLOCK%CHECK,		! Routine to calculate the block check value
   572
   573					;   0549  1	    SET%SEND%INIT : NOVALUE,	! Set up the MSG%SND%INIT parameters.
   574					;   0550  1	    PRS%SEND%INIT,		! Parse MSG%SND%INIT parameters.
   575					;   0551  1	    DO%PARITY : NOVALUE,	! Routine to generate parity for a message
   576					;   0552  1	    GEN%PARITY,			! Routine to add parity to a character
   577					;   0553  1	    SEND%PACKET,		! Send a packet to the remote
   578					;   0554  1	    REC%MESSAGE,		! Receive a message with retry processing
   579					;   0555  1	    REC%PACKET,			! Receive a packet from the remote
   580					;   0556  1	
   581					;   0557  1	! Utility routines
   582					;   0558  1	
   583					;   0559  1	    NORMALIZE%FILE : NOVALUE,	! Force file name into normal form
   584					;   0560  1	    BFR%EMPTY,			! Empty the data buffer
   585					;   0561  1	    BFR%FILL,			! Fill the data buffer from a file
   586					;   0562  1	    SET%STRING,			![025] Routine to set alternate get/put rout
   587					ines
   588					;   0563  1	    				! for use with in memory strings
   589					;   0564  1	    TYPE%CHAR,			! Type a character from a packet
   590					;   0565  1	    INIT%XFR	: NOVALUE,	! Initialize the per transfer processing
   591					;   0566  1	    STS%OUTPUT	: NOVALUE,	! Output current transfer status
   592					;   0567  1	!
   593					;   0568  1	! Debugging routines
   594					;   0569  1	!
   595					;   0570  1	    DBG%MESSAGE	: NOVALUE,	! Type out a formatted message
   596					;   0571  1	    DBG%SEND	: NOVALUE,	! Send message debugging routine
   597					;   0572  1	    DBG%RECEIVE	: NOVALUE;	! Receive message debugging routine
   598					;   0573  1		%SBTTL	'Require files'
   599					;   0574  1	
   600					;   0575  1	!
   601					;   0576  1	!<BLF/FORMAT>
   602					;   0577  1	!
   603					;   0578  1	! REQUIRE FILES:
   604					;   0579  1	!
   605					;   0580  1	
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-11
KERMSG	MAC	18-Jan-73 17:20	

   606					; L 0581  1	%IF %BLISS (BLISS32)
   607					; U 0582  1	%THEN
   608					; U 0583  1	
   609					; U 0584  1	LIBRARY 'SYS$LIBRARY:STARLET';
   610					; U 0585  1	
   611					;   0586  1	%FI
   612					;   0587  1	
   613					;   0588  1	REQUIRE 'KERCOM';
   614					;   0789  1	
   615					;   0790  1	REQUIRE 'KERERR';
   616					;   0813  1	
   617					;   0814  1	%SBTTL 'Macro definitions'
   618					;   0815  1	!
   619					;   0816  1	! MACROS:
   620					;   0817  1	!
   621					;   0818  1	
   622					;   0819  1	MACRO
   623					; M 0820  1	    CTL (C) =
   624					;   0821  1	 ((C) XOR %O'100')%,
   625					; M 0822  1	    CHAR (C) =
   626					;   0823  1	 ((C) + %O'40')%,
   627					; M 0824  1	    UNCHAR (C) =
   628					;   0825  1	 ((C) - %O'40')%;
   629					;   0826  1	
   630					;   0827  1	%SBTTL 'KERMIT Protocol Definitions'
   631					;   0828  1	
   632					;   0829  1	!++
   633					;   0830  1	! The following describes the various items that are found in the
   634					;   0831  1	! KERMIT messages.  A complete and through desription of the protocol can be
   635
   636					;   0832  1	! found in the KERMIT PROTOCOL MANUAL.
   637					;   0833  1	!
   638					;   0834  1	!
   639					;   0835  1	! All KERMIT messages have the following format:
   640					;   0836  1	!
   641					;   0837  1	! <Mark><CHAR(Count)><CHAR(Seq)><Message-dependent information><Check><EOL>
   642					;   0838  1	!
   643					;   0839  1	! <MARK>
   644					;   0840  1	!	Normally SOH (Control-A, octal 001).
   645					;   0841  1	!
   646					;   0842  1	! <CHAR(Count)>
   647					;   0843  1	!	Count of the number of characters following this position.
   648					;   0844  1	!	Character counts of ONLY 0 to 94 are valid.
   649					;   0845  1	!
   650					;   0846  1	! <CHAR(Seq)>
   651					;   0847  1	!	Packet sequence number, modulo 100 (octal).
   652					;   0848  1	!
   653					;   0849  1	! <MESSAGE-DEPENDENT INFORMATION>
   654					;   0850  1	!	This field contains the message dependent information.  There can
   655					;   0851  1	!	be multiple fields in this section.  See the KERMIT Protocol documen
   656					t
   657					;   0852  1	!	for a complete description of this.
   658					;   0853  1	!
   659					;   0854  1	! <Check>
   660					;   0855  1	!	A block check on the characters in the packet between, but not
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-12
KERMSG	MAC	18-Jan-73 17:20	

   661					;   0856  1	!	including, the mark and the checksum itself.  It may be one to three
   662
   663					;   0857  1	!	characters, depending upon the type agreed upon.
   664					;   0858  1	!
   665					;   0859  1	!	1. Single character arithmetic sum equal to:
   666					;   0860  1	!		chksum = (s + ((s AND 300)/100)) AND 77
   667					;   0861  1	!	    Character sent is CHAR(chksum).
   668					;   0862  1	!
   669					;   0863  1	!	2. Two character arithmetic sum.  CHAR of bits 6-11 are the first
   670					;   0864  1	!	   character, CHAR of bits 0-5 are the second character.
   671					;   0865  1	!
   672					;   0866  1	!	3. Three character CRC-CCITT.  First character is CHAR of bits 12-15
   673					,
   674					;   0867  1	!	   second is CHAR of bits 6-11, third is CHAR of bits 0-5.
   675					;   0868  1	!
   676					;   0869  1	!
   677					;   0870  1	! <EOL>
   678					;   0871  1	!	End of line.  Any line terminator that may be required by the host.
   679					;   0872  1	!--
   680					;   0873  1	
   681					;   0874  1	%SBTTL 'KERMIT Protocol Definitions -- Packet offsets'
   682					;   0875  1	
   683					;   0876  1	!++
   684					;   0877  1	! The following define the various offsets of the standard KERMIT
   685					;   0878  1	! packets.
   686					;   0879  1	!--
   687					;   0880  1	
   688					;   0881  1	LITERAL
   689					;   0882  1	    PKT%MARK = 0,				! <MARK>
   690					;   0883  1	    PKT%COUNT = 1,				! <CHAR(Count)>
   691					;   0884  1	    PKT%SEQ = 2,				! <CHAR(Seq)>
   692					;   0885  1	    PKT%TYPE = 3,				! <Message type>
   693					;   0886  1	    PKT%MSG = 4,				! <MESSAGE-DEPENDENT INFORMA
   694					TION>
   695					;   0887  1	    PKT%MAX%MSG = 94 - 5,			! Maximum size of the messag
   696					e dependent
   697					;   0888  1	    						!  information
   698					;   0889  1	    PKT%CHKSUM = 0,				! <CHAR(Chksum)> offset from
   699					 end of
   700					;   0890  1	    						!    Message dependent infor
   701					mation
   702					;   0891  1	    PKT%EOL = 1,				! <Eol> offset from end of d
   703					ata
   704					;   0892  1	    PKT%OVR%HEAD%B = 2,				! Header overhead
   705					;   0893  1	    PKT%OVR%HEAD%E = 1,				! Overhead at the end
   706					;   0894  1	    PKT%OVR%HEAD = 3,				! Overhead added to data len
   707					gth
   708					;   0895  1	    PKT%TOT%OVR%HEAD = 6;			! Total overhead of the mess
   709					age
   710					;   0896  1	
   711					;   0897  1	%SBTTL 'KERMIT Protocol Definitions -- Message dependent field'
   712					;   0898  1	
   713					;   0899  1	!++
   714					;   0900  1	! The MESSAGE-DEPENDENT information field of the message contains at
   715					;   0901  1	! least one part.  That is the type of message.  The remainder of the messag
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-13
KERMSG	MAC	18-Jan-73 17:20	

   716					e
   717					;   0902  1	! MESSAGE-DEPENDENT field is different depending on the message.
   718					;   0903  1	!
   719					;   0904  1	! <TYPE><TYPE-DEPENDENT-INFORMATION>
   720					;   0905  1	!
   721					;   0906  1	! <TYPE>
   722					;   0907  1	!	The type defines the type of message that is being processed.
   723					;   0908  1	!
   724					;   0909  1	!--
   725					;   0910  1	
   726					;   0911  1	! Protocol version 1.0 message types
   727					;   0912  1	
   728					;   0913  1	LITERAL
   729					;   0914  1	    MSG%DATA = %C'D',				! Data packet
   730					;   0915  1	    MSG%ACK = %C'Y',				! Acknowledgement
   731					;   0916  1	    MSG%NAK = %C'N',				! Negative acknowledgement
   732					;   0917  1	    MSG%SND%INIT = %C'S',			! Send initiate
   733					;   0918  1	    MSG%BREAK = %C'B',				! Break transmission
   734					;   0919  1	    MSG%FILE = %C'F',				! File header
   735					;   0920  1	    MSG%EOF = %C'Z',				! End of file (EOF)
   736					;   0921  1	    MSG%ERROR = %C'E';				! Error
   737					;   0922  1	
   738					;   0923  1	! Protocol version 2.0 message types
   739					;   0924  1	
   740					;   0925  1	LITERAL
   741					;   0926  1	    MSG%RCV%INIT = %C'R',			! Receive initiate
   742					;   0927  1	    MSG%COMMAND = %C'C',			! Host command
   743					;   0928  1	    MSG%GENERIC = %C'G',			! Generic KERMIT command.
   744					;   0929  1	    MSG%KERMIT = %C'K';				! Perform KERMIT command (te
   745					xt)
   746					;   0930  1	
   747					;   0931  1	! Protocol version 4.0 message types
   748					;   0932  1	
   749					;   0933  1	LITERAL
   750					;   0934  1	    MSG%SER%INIT = %C'I',			! Server initialization
   751					;   0935  1	    MSG%TEXT = %C'X';				! Text header message
   752					;   0936  1	
   753					;   0937  1	!++
   754					;   0938  1	! Generic KERMIT commands
   755					;   0939  1	!--
   756					;   0940  1	
   757					;   0941  1	LITERAL
   758					;   0942  1	    MSG%GEN%LOGIN = %C'I',			! Login
   759					;   0943  1	    MSG%GEN%EXIT = %C'F',			! Finish (exit to OS)
   760					;   0944  1	    MSG%GEN%CONNECT = %C'C',			! Connect to a directory
   761					;   0945  1	    MSG%GEN%LOGOUT = %C'L',			! Logout
   762					;   0946  1	    MSG%GEN%DIRECTORY = %C'D',			! Directory
   763					;   0947  1	    MSG%GEN%DISK%USAGE = %C'U',			! Disk usage
   764					;   0948  1	    MSG%GEN%DELETE = %C'E',			! Delete a file
   765					;   0949  1	    MSG%GEN%TYPE = %C'T',			! Type a file specification
   766					;   0950  1	!    MSG%GEN%SUBMIT = %C'S',			! Submit
   767					;   0951  1	!    MSG%GEN%PRINT = %C'P',			! Print
   768					;   0952  1	    MSG%GEN%WHO = %C'W',			! Who's logged in
   769					;   0953  1	    MSG%GEN%SEND = %C'M',			! Send a message to a user
   770					;   0954  1	    MSG%GEN%HELP = %C'H',			! Help
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-14
KERMSG	MAC	18-Jan-73 17:20	

   771					;   0955  1	    MSG%GEN%QUERY = %C'Q',			! Query status
   772					;   0956  1	    MSG%GEN%RENAME = %C'R',			! Rename file
   773					;   0957  1	    MSG%GEN%COPY = %C'K',			! Copy file
   774					;   0958  1	    MSG%GEN%PROGRAM = %C'P',			! Run program and pass data
   775					;   0959  1	    MSG%GEN%JOURNAL = %C'J',			! Perform journal functions
   776					;   0960  1	    MSG%GEN%VARIABLE = %C'V';			! Return/set variable state
   777					;   0961  1	
   778					;   0962  1	!
   779					;   0963  1	! Acknowledgement modifiers (protocol 4.0)
   780					;   0964  1	!
   781					;   0965  1	
   782					;   0966  1	LITERAL
   783					;   0967  1	    MSG%ACK%ABT%CUR = %C'X',			! Abort current file
   784					;   0968  1	    MSG%ACK%ABT%ALL = %C'Z';			! Abort entire stream of fil
   785					es
   786					;   0969  1	
   787					;   0970  1	!
   788					;   0971  1	! End of file packet modifier
   789					;   0972  1	!
   790					;   0973  1	
   791					;   0974  1	LITERAL
   792					;   0975  1	    MSG%EOF%DISCARD = %C'D';			! Discard data from previous
   793					 file
   794					;   0976  1	
   795					;   0977  1	%SBTTL 'KERMIT Protocol Definitions -- SEND initiate packet'
   796					;   0978  1	
   797					;   0979  1	!++
   798					;   0980  1	!
   799					;   0981  1	! The following describes the send initiate packet.  All fields in the messa
   800					ge
   801					;   0982  1	! data area are optional.
   802					;   0983  1	!
   803					;   0984  1	! <"S"><CHAR(Bufsiz)><CHAR(Timeout)><CHAR(npad)><CTL(pad)><CHAR(Eol)><Quote>
   804
   805					;   0985  1	!	<8-bit-quote><Check-type><Repeat-count-processing><Reserved><Reserve
   806					d>
   807					;   0986  1	!
   808					;   0987  1	! BUFSIZ
   809					;   0988  1	!	Sending Kermit's maximum buffer size.
   810					;   0989  1	!
   811					;   0990  1	! Timeout
   812					;   0991  1	!	Number of seconds after which the sending Kermit wishes to be timed 
   813					out
   814					;   0992  1	!
   815					;   0993  1	! Npad
   816					;   0994  1	!	Number of padding caracters the sending Kermit needs preceding each
   817					;   0995  1	!	packet.
   818					;   0996  1	!
   819					;   0997  1	! PAD
   820					;   0998  1	!	Padding character.
   821					;   0999  1	!
   822					;   1000  1	! EOL
   823					;   1001  1	!	A line terminator required on all packets set by the receiving
   824					;   1002  1	!	Kermit.
   825					;   1003  1	!
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-15
KERMSG	MAC	18-Jan-73 17:20	

   826					;   1004  1	! Quote
   827					;   1005  1	!	The printable ASCII characer the sending Kermit will use when quotin
   828					g
   829					;   1006  1	!	the control cahracters.  Default is "#".
   830					;   1007  1	!
   831					;   1008  1	! 8-bit-quote
   832					;   1009  1	!	Specify quoting mecanism for 8-bit quantities.  A quoting mecanism i
   833					s
   834					;   1010  1	!	mecessary when sending to hosts which prevent the use of the 8th bit
   835
   836					;   1011  1	!	for data.  When elected, the quoting mechanism will be used by both
   837					;   1012  1	!	hosts, and the quote character must be in the range of 41-76 or 140-
   838					176
   839					;   1013  1	!	octal, but different from the control-quoting character.  This field
   840					 is
   841					;   1014  1	!	interpreted as follows:
   842					;   1015  1	!
   843					;   1016  1	!	"Y" - I agree to 8-bit quoting if you request it.
   844					;   1017  1	!	"N" - I will not do 8-bit quoting.
   845					;   1018  1	!	"&" - (or any other character in the range of 41-76 or 140-176) I wa
   846					nt
   847					;   1019  1	!	      to do 8-bit quoting using this character (it will be done if t
   848					he
   849					;   1020  1	!	      other Kermit puts a "Y" in this field.
   850					;   1021  1	!	Anything else: Quoting will not be done.
   851					;   1022  1	!
   852					;   1023  1	! Check-type
   853					;   1024  1	!	Type of block check.  The only values presently allowed in this
   854					;   1025  1	!	field are "1", "2" or "3".  Future implementations may allow other
   855					;   1026  1	!	values.  Interpretation of the values is:
   856					;   1027  1	!
   857					;   1028  1	!	"1" - Single character checksum.  Default value if none specified.
   858					;   1029  1	!	"2" - Double character checksum.
   859					;   1030  1	!	"3" - Three character CRC.
   860					;   1031  1	!
   861					;   1032  1	! Repeat-count-processing
   862					;   1033  1	!	The prefix character to be used to indicate a repeated character.
   863					;   1034  1	!	This can be any printable cahracter other than blank (which denotes
   864					;   1035  1	!	no repeat count).
   865					;   1036  1	!
   866					;   1037  1	! Fields 10 to 11 reserved.
   867					;   1038  1	!--
   868					;   1039  1	
   869					;   1040  1	LITERAL
   870					;   1041  1	    P%SI%BUFSIZ = 0,				! Buffersize
   871					;   1042  1	    MY%PKT%SIZE = 80,				! My packet size
   872					;   1043  1	    P%SI%TIMOUT = 1,				! Time out
   873					;   1044  1	    MY%TIME%OUT = 15,				! My time out
   874					;   1045  1	    P%SI%NPAD = 2,				! Number of padding characte
   875					rs
   876					;   1046  1	    MY%NPAD = 0,				! Amount of padding I requir
   877					e
   878					;   1047  1	    P%SI%PAD = 3,				! Padding character
   879					;   1048  1	    MY%PAD%CHAR = 0,				! My pad character
   880					;   1049  1	    P%SI%EOL = 4,				! End of line character
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-16
KERMSG	MAC	18-Jan-73 17:20	

   881					;   1050  1	    MY%EOL%CHAR = %O'015',			! My EOL cahracter
   882					;   1051  1	    P%SI%QUOTE = 5,				! Quote character
   883					;   1052  1	    MY%QUOTE%CHAR = %C'#',			! My quoting character
   884					;   1053  1	    P%SI%8QUOTE = 6,				! 8-bit quote
   885					;   1054  1	    MY%8BIT%QUOTE = %C'&',			! Don't do it
   886					;   1055  1	    P%SI%CHKTYPE = 7,				! Checktype used
   887					;   1056  1	    MY%CHKTYPE = CHK%1CHAR,			! Use single character check
   888					sum
   889					;   1057  1	    P%SI%REPEAT = 8,				! Repeat character
   890					;   1058  1	    MY%REPEAT = %C'~',				! My repeat character
   891					;   1059  1	    P%SI%LENGTH = 9;				! Length of the message
   892					;   1060  1	
   893					;   1061  1	%SBTTL 'KERMIT Protocol States'
   894					;   1062  1	
   895					;   1063  1	!++
   896					;   1064  1	! The following are the various states that KERMIT can be in.
   897					;   1065  1	! The state transitions are defined in the KERMIT Protocol manual.
   898					;   1066  1	!--
   899					;   1067  1	
   900					;   1068  1	LITERAL
   901					;   1069  1	    STATE%MIN = 1,				! Min state number
   902					;   1070  1	    STATE%S = 1,				! Send init state
   903					;   1071  1	    STATE%SF = 2,				! Send file header
   904					;   1072  1	    STATE%SD = 3,				! Send file data packet
   905					;   1073  1	    STATE%SZ = 4,				! Send EOF packet
   906					;   1074  1	    STATE%SB = 5,				! Send break
   907					;   1075  1	    STATE%R = 6,				! Receive state (wait for se
   908					nd-init)
   909					;   1076  1	    STATE%RF = 7,				! Receive file header packet
   910
   911					;   1077  1	    STATE%RD = 8,				! Receive file data packet
   912					;   1078  1	    STATE%C = 9,				! Send complete
   913					;   1079  1	    STATE%A = 10,				! Abort
   914					;   1080  1	    STATE%SX = 11,				! Send text header
   915					;   1081  1	    STATE%SG = 12,				! Send generic command
   916					;   1082  1	    STATE%SI = 13,				! Send server init
   917					;   1083  1	    STATE%ID = 14,				! Server idle loop
   918					;   1084  1	    STATE%II = 15,				! Server idle after server i
   919					nit
   920					;   1085  1	    STATE%FI = 16,				! Server should exit
   921					;   1086  1	    STATE%LG = 17,				! Server should logout
   922					;   1087  1	    STATE%OF = 18,				! Send - open first input fi
   923					le
   924					;   1088  1	    STATE%EX = 19,				! Exit back to command parse
   925					r
   926					;   1089  1	    STATE%ER = 20,				! Retries exceeded error
   927					;   1090  1	    STATE%MAX = 20;				! Max state number
   928					;   1091  1	
   929					;   1092  1	%SBTTL 'Internal constants'
   930					;   1093  1	
   931					;   1094  1	!++
   932					;   1095  1	! The following represent various internal KERMSG constants.
   933					;   1096  1	!--
   934					;   1097  1	
   935					;   1098  1	LITERAL
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-17
KERMSG	MAC	18-Jan-73 17:20	

   936					;   1099  1	    MAX%PKT%RETRIES = 16,			! Maximum packet retries
   937					;   1100  1	    MAX%SI%RETRIES = 5;				! Maximum send init retries
   938					;   1101  1	
   939					;   1102  1	%SBTTL 'Storage - External'
   940					;   1103  1	!
   941					;   1104  1	! OWN STORAGE:
   942					;   1105  1	!
   943					;   1106  1	
   944					;   1107  1	EXTERNAL
   945					;   1108  1	!
   946					;   1109  1	! Receive parameters
   947					;   1110  1	!
   948					;   1111  1	    RCV%PKT%SIZE,				! Receive packet size
   949					;   1112  1	    RCV%NPAD,					! Padding length
   950					;   1113  1	    RCV%PADCHAR,				! Padding character
   951					;   1114  1	    RCV%TIMEOUT,				! Time out
   952					;   1115  1	    RCV%EOL,					! EOL character
   953					;   1116  1	    RCV%QUOTE%CHR,				! Quote character
   954					;   1117  1	    RCV%SOH,					! Start of header character
   955					;   1118  1	    RCV%8QUOTE%CHR,				! 8-bit quoting character
   956					;   1119  1	!
   957					;   1120  1	! Miscellaneous parameters
   958					;   1121  1	!
   959					;   1122  1	    SET%REPT%CHR,				! Repeat character
   960					;   1123  1	!
   961					;   1124  1	! Send parameters
   962					;   1125  1	!
   963					;   1126  1	    SND%PKT%SIZE,				! Send packet size
   964					;   1127  1	    SND%NPAD,					! Padding length
   965					;   1128  1	    SND%PADCHAR,				! Padding character
   966					;   1129  1	    SND%TIMEOUT,				! Time out
   967					;   1130  1	    SND%EOL,					! EOL character
   968					;   1131  1	    SND%QUOTE%CHR,				! Quote character
   969					;   1132  1	    SND%SOH,					! Start of header character
   970					;   1133  1	    SEND%TIMEOUT,				! Time to wait for receiving
   971					 message
   972					;   1134  1	!
   973					;   1135  1	! Server parameters
   974					;   1136  1	!
   975					;   1137  1	    SRV%TIMEOUT,				! Time between NAK's when se
   976					rver is idle
   977					;   1138  1	!
   978					;   1139  1	! Statistics
   979					;   1140  1	!
   980					;   1141  1	    SND%TOTAL%CHARS,				! Total characters sent
   981					;   1142  1	    RCV%TOTAL%CHARS,				! Total characters received
   982					;   1143  1	    SND%DATA%CHARS,				! Total number of data chara
   983					cters sent
   984					;   1144  1	    RCV%DATA%CHARS,				! Total number of data chara
   985					cters received
   986					;   1145  1	    SND%NAKS,					! Total NAKs sent
   987					;   1146  1	    RCV%NAKS,					! Total NAKs received
   988					;   1147  1	    SND%COUNT,					! Count of total number of p
   989					ackets
   990					;   1148  1	    RCV%COUNT,					! Count of total number pack
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-18
KERMSG	MAC	18-Jan-73 17:20	

   991					ets received
   992					;   1149  1	    SMSG%COUNT,					! Total number of packets se
   993					nt
   994					;   1150  1	    RMSG%COUNT,					! Total number of packets re
   995					ceived
   996					;   1151  1	    SMSG%TOTAL%CHARS,				! Total chars sent this file
   997					 xfer
   998					;   1152  1	    RMSG%TOTAL%CHARS,				! Total chars rcvd this file
   999					 xfer
  1000					;   1153  1	    SMSG%DATA%CHARS,				! Total data chars this file
  1001					 xfer
  1002					;   1154  1	    RMSG%DATA%CHARS,				! Total data chars this file
  1003					 xfer
  1004					;   1155  1	    SMSG%NAKS,					! Total number of NAKs this 
  1005					file xfer
  1006					;   1156  1	    RMSG%NAKS,					! Total number of NAKs recei
  1007					ved
  1008					;   1157  1	    XFR%TIME,					! Amount of time last xfr to
  1009					ok
  1010					;   1158  1	    TOTAL%TIME,					! Total time of all xfrs
  1011					;   1159  1	    						!  this file xfer
  1012					;   1160  1	    LAST%ERROR : VECTOR [CH$ALLOCATION (MAX%MSG + 1)],	! Last error message
  1013
  1014					;   1161  1	!
  1015					;   1162  1	! Misc constants.
  1016					;   1163  1	!
  1017					;   1164  1	    FILE%NAME : VECTOR [CH$ALLOCATION (MAX%FILE%NAME)],
  1018					;   1165  1	    FILE%SIZE,
  1019					;   1166  1	    SI%RETRIES,					! Send init retries to attem
  1020					pt
  1021					;   1167  1	    PKT%RETRIES,				! Number of retries to try f
  1022					or a message
  1023					;   1168  1	    DELAY,					! Amount of time to delay
  1024					;   1169  1	    DUPLEX,					! Type of connection (half o
  1025					r full)
  1026					;   1170  1	    PARITY%TYPE,				! Type of parity to use
  1027					;   1171  1	    DEV%PARITY%FLAG,				! True if output device does
  1028
  1029					;   1172  1	    						!  parity, false if we do it
  1030
  1031					;   1173  1	    CHKTYPE,					! Type of block check desire
  1032					d
  1033					;   1174  1	    ABT%FLAG,					! True if aborted file shoul
  1034					d be discarded
  1035					;   1175  1	    DEBUG%FLAG,					! Debugging mode on/off
  1036					;   1176  1	    WARN%FLAG,					! File warning flag
  1037					;   1177  1	    IBM%FLAG,					! Talking to an IBM system
  1038					;   1178  1	    IBM%CHAR,					! Turnaround character for I
  1039					BM mode
  1040					;   1179  1	    ECHO%FLAG,					! Local echo flag
  1041					;   1180  1	    CONNECT%FLAG,				! Connected flag; True if
  1042					;   1181  1	    						!  terminal and SET LINE are
  1043
  1044					;   1182  1	    						!  the same
  1045					;   1183  1	    ABT%CUR%FILE,				! Abort current file
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-19
KERMSG	MAC	18-Jan-73 17:20	

  1046					;   1184  1	    ABT%ALL%FILE,				! Abort all files in stream
  1047					;   1185  1	    TYP%STS%FLAG,				! Type status next message
  1048					;   1186  1	    TY%FIL,					! Type file specs
  1049					;   1187  1	    TY%PKT,					! Type packet info
  1050					;   1188  1	    FIL%NORMAL%FORM,				! If true, file names should
  1051					 be normalized
  1052					;   1189  1	    GEN%1DATA : VECTOR [CH$ALLOCATION (MAX%MSG)],	! Data for generic c
  1053					ommand
  1054					;   1190  1	    GEN%1SIZE,					! Size of data in GEN%1DATA
  1055					;   1191  1	    GEN%2DATA : VECTOR [CH$ALLOCATION (MAX%MSG)],	! Second argument fo
  1056					r generic command
  1057					;   1192  1	    GEN%2SIZE,					! Size of data in GEN%2DATA
  1058					;   1193  1	    GEN%3DATA : VECTOR [CH$ALLOCATION (MAX%MSG)],	! Third arg for gene
  1059					ric command
  1060					;   1194  1	    GEN%3SIZE;					! Size of data in GEN%3DATA
  1061					;   1195  1	
  1062					;   1196  1	%SBTTL 'Storage - Local'
  1063					;   1197  1	!
  1064					;   1198  1	! LOCAL OWN STORAGE:
  1065					;   1199  1	!
  1066					;   1200  1	
  1067					;   1201  1	OWN
  1068					;   1202  1	!
  1069					;   1203  1	! Receive parameters
  1070					;   1204  1	!
  1071					;   1205  1	    RECV%8QUOTE%CHR,				! 8th-bit quoting character
  1072					;   1206  1	    REPT%CHR,					! Repeat prefix character
  1073					;   1207  1	!
  1074					;   1208  1	! Send parameters
  1075					;   1209  1	!
  1076					;   1210  1	    SEND%PKT%SIZE,				! Send packet size
  1077					;   1211  1	    SEND%NPAD,					! Padding length
  1078					;   1212  1	    SEND%PADCHAR,				! Padding character
  1079					;   1213  1	    SEND%EOL,					! EOL character
  1080					;   1214  1	    SEND%QUOTE%CHR,				! Quote character
  1081					;   1215  1	    SEND%8QUOTE%CHR,				! 8-bit quoting character
  1082					;   1216  1	!
  1083					;   1217  1	! Misc parameters
  1084					;   1218  1	!
  1085					;   1219  1	    INI%CHK%TYPE,				! Type of block checking fro
  1086					m init message
  1087					;   1220  1	    BLK%CHK%TYPE,				! Type of block check to use
  1088
  1089					;   1221  1	    FLAG%8QUOTE,				! Flag to determine if doing
  1090					 8bit quoting
  1091					;   1222  1	    FLAG%REPEAT,				! True if doing repeated cha
  1092					racter compression
  1093					;   1223  1	    STATE,					! Current state
  1094					;   1224  1	    SIZE,					! Size of the current messag
  1095					e
  1096					;   1225  1	    OLD%RETRIES,				! Saved number of retries do
  1097					ne.
  1098					;   1226  1	    NUM%RETRIES,				! Number of retries
  1099					;   1227  1	    MSG%NUMBER,					! Current message number
  1100					;   1228  1	    REC%SEQ,					! Sequence number of msg in 
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-20
KERMSG	MAC	18-Jan-73 17:20	

  1101					REC%MSG
  1102					;   1229  1	    REC%LENGTH,					! Length of the message recv
  1103					'd
  1104					;   1230  1	    REC%TYPE,					! Type of the message receiv
  1105					ed.
  1106					;   1231  1	    REC%MSG : VECTOR [CH$ALLOCATION (MAX%MSG, CHR%SIZE)],	! Message re
  1107					ceived
  1108					;   1232  1	    SND%MSG : VECTOR [CH$ALLOCATION (MAX%MSG, CHR%SIZE)],	! Message se
  1109					nt
  1110					;   1233  1	    FILE%OPEN%FLAG,				! File is opened.
  1111					;   1234  1	    FILE%CHARS,					! Number of characters sent 
  1112					or received
  1113					;   1235  1	    TEXT%HEAD%FLAG,				! Text header received, not 
  1114					file header
  1115					;   1236  1	    NO%FILE%NEEDED,				! Don't open a file
  1116					;   1237  1	    INIT%PKT%SENT,				! Server-init sent and ACKed
  1117
  1118					;   1238  1	    GEN%TYPE,					! Command message type
  1119					;   1239  1	    GEN%SUBTYPE,				! Generic command subtype
  1120					;   1240  1	    GET%CHR%ROUTINE,			![025] Address of routine to get a c
  1121					haracter for BFR%FILL
  1122					;   1241  1	    PUT%CHR%ROUTINE;			![025] Address of routine to put a c
  1123					haracter for BFR%EMPTY
  1124					;   1242  1	
  1125					;   1243  1	%SBTTL 'External references'
  1126					;   1244  1	!
  1127					;   1245  1	! EXTERNAL REFERENCES:
  1128					;   1246  1	!
  1129					;   1247  1	! Packet I/O routines
  1130					;   1248  1	
  1131					;   1249  1	EXTERNAL ROUTINE
  1132					;   1250  1	    SEND,					! Send a packet to the remot
  1133					e
  1134					;   1251  1	    IBM%WAIT,					! Wait for IBM turnaround
  1135					;   1252  1	    RECEIVE;					! Receive a packet from the 
  1136					remote
  1137					;   1253  1	
  1138					;   1254  1	!
  1139					;   1255  1	! Terminal I/O routines
  1140					;   1256  1	!
  1141					;   1257  1	
  1142					;   1258  1	EXTERNAL ROUTINE
  1143					;   1259  1	    TERM%DUMP : NOVALUE,			! Normal terminal output
  1144					;   1260  1	    DBG%DUMP : NOVALUE,				! Debugging output
  1145					;   1261  1	    TT%SET%OUTPUT,				! Set output routine
  1146					;   1262  1	    TT%CHAR : NOVALUE,				! Output a single character
  1147					;   1263  1	    TT%CRLF : NOVALUE,				! Output a CRLF
  1148					;   1264  1	    TT%NUMBER : NOVALUE,			! Output a three digit numbe
  1149					r to the
  1150					;   1265  1	    						!  terminal
  1151					;   1266  1	    TT%TEXT : NOVALUE,				! Output a string to the use
  1152					r's
  1153					;   1267  1	    TT%OUTPUT : NOVALUE;			! Force buffered output to t
  1154					erminal
  1155					;   1268  1	
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-21
KERMSG	MAC	18-Jan-73 17:20	

  1156					;   1269  1	! Operating system routines and misc routines
  1157					;   1270  1	
  1158					;   1271  1	EXTERNAL ROUTINE
  1159					;   1272  1	    CRCCLC,					! Calculate a CRC-CCITT
  1160					;   1273  1	    XFR%STATUS : NOVALUE,			! Routine to tell the user t
  1161					he
  1162					;   1274  1	    						!  status of a transfer
  1163					;   1275  1	    KRM%ERROR : NOVALUE,			! Issue an error message
  1164					;   1276  1	    SY%LOGOUT : NOVALUE,			! Log the job off
  1165					;   1277  1	    SY%GENERIC,					! Perform a generic command
  1166					;   1278  1	    SY%TIME,					! Return elapsed time in mil
  1167					liseconds
  1168					;   1279  1	    SY%DISMISS : NOVALUE;			! Routine to dismiss for n s
  1169					econds.
  1170					;   1280  1	
  1171					;   1281  1	!
  1172					;   1282  1	! External file processing routines
  1173					;   1283  1	!
  1174					;   1284  1	
  1175					;   1285  1	EXTERNAL ROUTINE
  1176					;   1286  1	    FILE%OPEN,					! Open a file for reading/wr
  1177					iting
  1178					;   1287  1	    FILE%CLOSE,					! Close an open file
  1179					;   1288  1	    NEXT%FILE,					! Determine if there is a ne
  1180					xt file
  1181					;   1289  1	    						!  and open it for reading.
  1182					;   1290  1	    GET%FILE,					! Get a byte from the file
  1183					;   1291  1	    PUT%FILE;					! Put a byte in the file.
  1184					;   1292  1	
  1185					;   1293  1	%SBTTL 'MSG%INIT'
  1186					;   1294  1	
  1187					;   1295  1	GLOBAL ROUTINE MSG%INIT : NOVALUE =
  1188					;   1296  1	
  1189					;   1297  1	!++
  1190					;   1298  1	! FUNCTIONAL DESCRIPTION:
  1191					;   1299  1	!
  1192					;   1300  1	!	This routine will initialize the message processing for
  1193					;   1301  1	!	KERMIT-32/36.
  1194					;   1302  1	!
  1195					;   1303  1	! CALLING SEQUENCE:
  1196					;   1304  1	!
  1197					;   1305  1	!	MSG%INIT();
  1198					;   1306  1	!
  1199					;   1307  1	! INPUT PARAMETERS:
  1200					;   1308  1	!
  1201					;   1309  1	!	None.
  1202					;   1310  1	!
  1203					;   1311  1	! IMPLICIT INPUTS:
  1204					;   1312  1	!
  1205					;   1313  1	!	None.
  1206					;   1314  1	!
  1207					;   1315  1	! OUTPUT PARAMETERS:
  1208					;   1316  1	!
  1209					;   1317  1	!	None.
  1210					;   1318  1	!
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-22
KERMSG	MAC	18-Jan-73 17:20	

  1211					;   1319  1	! IMPLICIT OUTPUTS:
  1212					;   1320  1	!
  1213					;   1321  1	!	None.
  1214					;   1322  1	!
  1215					;   1323  1	! COMPLETION CODES:
  1216					;   1324  1	!
  1217					;   1325  1	!	None.
  1218					;   1326  1	!
  1219					;   1327  1	! SIDE EFFECTS:
  1220					;   1328  1	!
  1221					;   1329  1	!	None.
  1222					;   1330  1	!
  1223					;   1331  1	!--
  1224					;   1332  1	
  1225					;   1333  2	    BEGIN
  1226					;   1334  2	!
  1227					;   1335  2	! Initialize some variables
  1228					;   1336  2	!
  1229					;   1337  2	! Receive parameters first
  1230					;   1338  2	!
  1231					;   1339  2	    RCV%PKT%SIZE = MY%PKT%SIZE;
  1232					;   1340  2	    RCV%NPAD = MY%NPAD;
  1233					;   1341  2	    RCV%PADCHAR = MY%PAD%CHAR;
  1234					;   1342  2	    RCV%TIMEOUT = MY%TIME%OUT;
  1235					;   1343  2	    RCV%EOL = MY%EOL%CHAR;
  1236					;   1344  2	    RCV%QUOTE%CHR = MY%QUOTE%CHAR;
  1237					;   1345  2	    RCV%SOH = CHR%SOH;
  1238					;   1346  2	    RCV%8QUOTE%CHR = MY%8BIT%QUOTE;
  1239					;   1347  2	    SET%REPT%CHR = MY%REPEAT;
  1240					;   1348  2	!
  1241					;   1349  2	! Send parameters.
  1242					;   1350  2	!
  1243					;   1351  2	    SND%PKT%SIZE = -MY%PKT%SIZE;
  1244					;   1352  2	    SND%NPAD = -MY%NPAD;
  1245					;   1353  2	    SND%PADCHAR = -MY%PAD%CHAR;
  1246					;   1354  2	    SND%TIMEOUT = -MY%TIME%OUT;
  1247					;   1355  2	    SND%EOL = -MY%EOL%CHAR;
  1248					;   1356  2	    SND%QUOTE%CHR = -MY%QUOTE%CHAR;
  1249					;   1357  2	    SND%SOH = CHR%SOH;
  1250					;   1358  2	!
  1251					;   1359  2	! Server parameters
  1252					;   1360  2	!
  1253					;   1361  2	    SRV%TIMEOUT = 5*MY%TIME%OUT;
  1254					;   1362  2	!
  1255					;   1363  2	! Other random parameters
  1256					;   1364  2	!
  1257					;   1365  2	    PKT%RETRIES = MAX%PKT%RETRIES;		! Number of retries per mess
  1258					age
  1259					;   1366  2	    SI%RETRIES = MAX%SI%RETRIES;		! Number of retries on send 
  1260					inits
  1261					;   1367  2	    DELAY = INIT%DELAY;
  1262					;   1368  2	    DUPLEX = DP%FULL;				! Use full duplex
  1263					;   1369  2	    DEBUG%FLAG = FALSE;
  1264					;   1370  2	    WARN%FLAG = FALSE;
  1265					;   1371  2	    ECHO%FLAG = FALSE;
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-23
KERMSG	MAC	18-Jan-73 17:20	

  1266					;   1372  2	    BLK%CHK%TYPE = CHK%1CHAR;			! Start using single char ch
  1267					ecksum
  1268					;   1373  2	    CHKTYPE = MY%CHKTYPE;			! Desired block check type
  1269					;   1374  2	    INI%CHK%TYPE = .CHKTYPE;			! Same as default for now
  1270					;   1375  2	    DEV%PARITY%FLAG = FALSE;			! We generate parity
  1271					;   1376  2	    PARITY%TYPE = PR%NONE;			! No parity
  1272					;   1377  2	    ABT%FLAG = TRUE;				! Discard incomplete files
  1273					;   1378  2	    FILE%OPEN%FLAG = FALSE;
  1274					;   1379  2	    IBM%FLAG = FALSE;				! Not talking to an IBM
  1275					;   1380  2	    IBM%CHAR = CHR%DC1;				! XON is IBM turnaround char
  1276					acter
  1277					;   1381  2	    TY%FIL = TRUE;				! Default to typing files
  1278					;   1382  2	    TY%PKT = FALSE;				! But not packet numbers
  1279					;   1383  2	    FIL%NORMAL%FORM = FNM%NORMAL;		! Default to normal form nam
  1280					es
  1281					;   1384  2	    GET%CHR%ROUTINE = GET%FILE;			![025] Initialize the get-a-
  1282					char routine
  1283					;   1385  2	    PUT%CHR%ROUTINE = PUT%FILE;			![025] And the put-a-char
  1284					;   1386  1	    END;					! End of MSG%INIT
  1285
  1286
  1287						TITLE	KERMSG
  1288	400000'					TWOSEG
  1289
  1290
  1291					;[CSM]	.REQUEST  DSKB:B361LB.REL[1,5]
  1292						.REQUEST  SYS:B361LB.REL	;[CSM]
  1293
  1294
  1295	000000'					RELOC	0
  1296					; RECV%8QUOTE%CHR
  1297	000000'				U.37:	BLOCK	1
  1298					; REPT%CHR
  1299	000001'				U.38:	BLOCK	1
  1300					; SEND%PKT%SIZE
  1301	000002'				U.39:	BLOCK	1
  1302					; SEND%NPAD
  1303	000003'				U.40:	BLOCK	1
  1304					; SEND%PADCHAR
  1305	000004'				U.41:	BLOCK	1
  1306					; SEND%EOL
  1307	000005'				U.42:	BLOCK	1
  1308					; SEND%QUOTE%CHR
  1309	000006'				U.43:	BLOCK	1
  1310					; SEND%8QUOTE%CHR
  1311	000007'				U.44:	BLOCK	1
  1312					; INI%CHK%TYPE
  1313	000010'				U.45:	BLOCK	1
  1314					; BLK%CHK%TYPE
  1315	000011'				U.46:	BLOCK	1
  1316					; FLAG%8QUOTE
  1317	000012'				U.47:	BLOCK	1
  1318					; FLAG%REPEAT
  1319	000013'				U.48:	BLOCK	1
  1320					; STATE
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-24
KERMSG	MAC	18-Jan-73 17:20	

  1321	000014'				U.49:	BLOCK	1
  1322					; SIZE
  1323	000015'				U.50:	BLOCK	1
  1324					; OLD%RETRIES
  1325	000016'				U.51:	BLOCK	1
  1326					; NUM%RETRIES
  1327	000017'				U.52:	BLOCK	1
  1328					; MSG%NUMBER
  1329	000020'				U.53:	BLOCK	1
  1330					; REC%SEQ
  1331	000021'				U.54:	BLOCK	1
  1332					; REC%LENGTH
  1333	000022'				U.55:	BLOCK	1
  1334					; REC%TYPE
  1335	000023'				U.56:	BLOCK	1
  1336					; REC%MSG
  1337	000024'				U.57:	BLOCK	30
  1338					; SND%MSG
  1339	000054'				U.58:	BLOCK	30
  1340					; FILE%OPEN%FLAG
  1341	000104'				U.59:	BLOCK	1
  1342					; FILE%CHARS
  1343	000105'				U.60:	BLOCK	1
  1344					; TEXT%HEAD%FLAG
  1345	000106'				U.61:	BLOCK	1
  1346					; NO%FILE%NEEDED
  1347	000107'				U.62:	BLOCK	1
  1348					; INIT%PKT%SENT
  1349	000110'				U.63:	BLOCK	1
  1350					; GEN%TYPE
  1351	000111'				U.64:	BLOCK	1
  1352					; GEN%SUBTYPE
  1353	000112'				U.65:	BLOCK	1
  1354					; GET%CHR%ROUTINE
  1355	000113'				U.66:	BLOCK	1
  1356					; PUT%CHR%ROUTINE
  1357	000114'				U.67:	BLOCK	1
  1358
  1359
  1360						EXTERN	RCV%PKT%SIZE, RCV%NPAD, RCV%PADCHAR, RCV%TIMEOUT, RCV%EOL, RCV%QUOTE%CHR, RC
  1361					V%SOH
  1362						EXTERN	RCV%8QUOTE%CHR, SET%REPT%CHR, SND%PKT%SIZE, SND%NPAD, SND%PADCHAR, SND%TIMEO
  1363					UT, SND%EOL
  1364						EXTERN	SND%QUOTE%CHR, SND%SOH, SEND%TIMEOUT, SRV%TIMEOUT, SND%TOTAL%CHARS, RCV%TOTA
  1365					L%CHARS
  1366						EXTERN	SND%DATA%CHARS, RCV%DATA%CHARS, SND%NAKS, RCV%NAKS, SND%COUNT, RCV%COUNT, SM
  1367					SG%COUNT
  1368						EXTERN	RMSG%COUNT, SMSG%TOTAL%CHARS, RMSG%TOTAL%CHARS, SMSG%DATA%CHARS, RMSG%DATA%C
  1369					HARS, SMSG%NAKS
  1370						EXTERN	RMSG%NAKS, XFR%TIME, TOTAL%TIME, LAST%ERROR, FILE%NAME, FILE%SIZE, SI%RETRIE
  1371					S, PKT%RETRIES
  1372						EXTERN	DELAY, DUPLEX, PARITY%TYPE, DEV%PARITY%FLAG, CHKTYPE, ABT%FLAG, DEBUG%FLAG, 
  1373					WARN%FLAG
  1374						EXTERN	IBM%FLAG, IBM%CHAR, ECHO%FLAG, CONNECT%FLAG, ABT%CUR%FILE, ABT%ALL%FILE, TYP
  1375					%STS%FLAG
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-25
KERMSG	MAC	18-Jan-73 17:20	

  1376						EXTERN	TY%FIL, TY%PKT, FIL%NORMAL%FORM, GEN%1DATA, GEN%1SIZE, GEN%2DATA, GEN%2SIZE,
  1377					 GEN%3DATA
  1378						EXTERN	GEN%3SIZE, SEND, IBM%WAIT, RECEIVE, TERM%DUMP, DBG%DUMP, TT%SET%OUTPUT, TT%C
  1379					HAR, TT%CRLF
  1380						EXTERN	TT%NUMBER, TT%TEXT, TT%OUTPUT, CRCCLC, XFR%STATUS, KRM%ERROR, SY%LOGOUT, SY%
  1381					GENERIC
  1382						EXTERN	SY%TIME, SY%DISMISS, FILE%OPEN, FILE%CLOSE, NEXT%FILE, GET%FILE, PUT%FILE
  1383
  1384
  1385			000001		FNM%NORMAL==:	    1
  1386			000002		FNM%FULL==:	    2
  1387			000004		FNM%UNTRAN==:	    4
  1388			000000		PR%MIN==:	    0
  1389			000000		PR%NONE==:	    0
  1390			000001		PR%MARK==:	    1
  1391			000002		PR%EVEN==:	    2
  1392			000003		PR%ODD==:	    3
  1393			000004		PR%SPACE==:	    4
  1394			000004		PR%MAX==:	    4
  1395			000001		GC%MIN==:	    1
  1396			000001		GC%EXIT==:	    1
  1397			000002		GC%DIRECTORY==:     2
  1398			000003		GC%DISK%USAGE==:    3
  1399			000004		GC%DELETE==:	    4
  1400			000005		GC%TYPE==:	    5
  1401			000006		GC%HELP==:	    6
  1402			000007		GC%LOGOUT==:	    7
  1403			000010		GC%LGN==:	    10
  1404			000011		GC%CONNECT==:	    11
  1405			000012		GC%RENAME==:	    12
  1406			000013		GC%COPY==:	    13
  1407			000014		GC%WHO==:	    14
  1408			000015		GC%SEND%MSG==:	    15
  1409			000016		GC%STATUS==:	    16
  1410			000017		GC%COMMAND==:	    17
  1411			000020		GC%KERMIT==:	    20
  1412			000021		GC%JOURNAL==:	    21
  1413			000022		GC%VARIABLE==:	    22
  1414			000023		GC%PROGRAM==:	    23
  1415			000023		GC%MAX==:	    23
  1416			000000		DP%FULL==:	    0
  1417			000001		DP%HALF==:	    1
  1418			000061		CHK%1CHAR==:	    61
  1419			000062		CHK%2CHAR==:	    62
  1420			000063		CHK%CRC==:	    63
  1421			000140		MAX%MSG==:	    140
  1422
  1423
  1424			000000		AC0=	0
  1425			000001		AC1=	1
  1426			000002		AC2=	2
  1427			000003		AC3=	3
  1428			000004		AC4=	4
  1429			000005		AC5=	5
  1430			000006		AC6=	6
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-26
KERMSG	MAC	18-Jan-73 17:20	

  1431			000007		AC7=	7
  1432			000010		AC10=	10
  1433			000011		AC11=	11
  1434			000012		AC12=	12
  1435			000013		AC13=	13
  1436			000014		AC14=	14
  1437			000015		FP=	15
  1438			000016		AC16=	16
  1439			000017		SP=	17
  1440
  1441
  1442	400000'					RELOC	400000
  1443	400000'				MSG%INIT::
  1444						MOVEI	AC1,120				; AC1,120				
  1445	400000'	201 01 0 00 000120 						1339
  1446	400001'	202 01 0 00 000000*		MOVEM	AC1,RCV%PKT%SIZE		; AC1,RCV%PKT%SIZE
  1447						SETZM	RCV%NPAD			; RCV%NPAD				
  1448	400002'	402 00 0 00 000000*						1340
  1449						SETZM	RCV%PADCHAR			; RCV%PADCHAR				
  1450	400003'	402 00 0 00 000000*						1341
  1451						MOVEI	AC1,17				; AC1,17				
  1452	400004'	201 01 0 00 000017 						1342
  1453	400005'	202 01 0 00 000000*		MOVEM	AC1,RCV%TIMEOUT			; AC1,RCV%TIMEOUT
  1454						MOVEI	AC1,15				; AC1,15				
  1455	400006'	201 01 0 00 000015 						1343
  1456	400007'	202 01 0 00 000000*		MOVEM	AC1,RCV%EOL			; AC1,RCV%EOL
  1457						MOVEI	AC1,43				; AC1,43				
  1458	400010'	201 01 0 00 000043 						1344
  1459	400011'	202 01 0 00 000000*		MOVEM	AC1,RCV%QUOTE%CHR		; AC1,RCV%QUOTE%CHR
  1460						MOVEI	AC1,1				; AC1,1					
  1461	400012'	201 01 0 00 000001 						1345
  1462	400013'	202 01 0 00 000000*		MOVEM	AC1,RCV%SOH			; AC1,RCV%SOH
  1463						MOVEI	AC1,46				; AC1,46				
  1464	400014'	201 01 0 00 000046 						1346
  1465	400015'	202 01 0 00 000000*		MOVEM	AC1,RCV%8QUOTE%CHR		; AC1,RCV%8QUOTE%CHR
  1466						MOVEI	AC1,176				; AC1,176				
  1467	400016'	201 01 0 00 000176 						1347
  1468	400017'	202 01 0 00 000000*		MOVEM	AC1,SET%REPT%CHR		; AC1,SET%REPT%CHR
  1469						HRROI	AC1,-120			; AC1,-120				
  1470	400020'	561 01 0 00 777660 						1351
  1471	400021'	202 01 0 00 000000*		MOVEM	AC1,SND%PKT%SIZE		; AC1,SND%PKT%SIZE
  1472						SETZM	SND%NPAD			; SND%NPAD				
  1473	400022'	402 00 0 00 000000*						1352
  1474						SETZM	SND%PADCHAR			; SND%PADCHAR				
  1475	400023'	402 00 0 00 000000*						1353
  1476						HRROI	AC1,-17				; AC1,-17				
  1477	400024'	561 01 0 00 777761 						1354
  1478	400025'	202 01 0 00 000000*		MOVEM	AC1,SND%TIMEOUT			; AC1,SND%TIMEOUT
  1479						HRROI	AC1,-15				; AC1,-15				
  1480	400026'	561 01 0 00 777763 						1355
  1481	400027'	202 01 0 00 000000*		MOVEM	AC1,SND%EOL			; AC1,SND%EOL
  1482						HRROI	AC1,-43				; AC1,-43				
  1483	400030'	561 01 0 00 777735 						1356
  1484	400031'	202 01 0 00 000000*		MOVEM	AC1,SND%QUOTE%CHR		; AC1,SND%QUOTE%CHR
  1485						MOVEI	AC1,1				; AC1,1					
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-27
KERMSG	MAC	18-Jan-73 17:20	

  1486	400032'	201 01 0 00 000001 						1357
  1487	400033'	202 01 0 00 000000*		MOVEM	AC1,SND%SOH			; AC1,SND%SOH
  1488						MOVEI	AC1,113				; AC1,113				
  1489	400034'	201 01 0 00 000113 						1361
  1490	400035'	202 01 0 00 000000*		MOVEM	AC1,SRV%TIMEOUT			; AC1,SRV%TIMEOUT
  1491						MOVEI	AC1,20				; AC1,20				
  1492	400036'	201 01 0 00 000020 						1365
  1493	400037'	202 01 0 00 000000*		MOVEM	AC1,PKT%RETRIES			; AC1,PKT%RETRIES
  1494						MOVEI	AC1,5				; AC1,5					
  1495	400040'	201 01 0 00 000005 						1366
  1496	400041'	202 01 0 00 000000*		MOVEM	AC1,SI%RETRIES			; AC1,SI%RETRIES
  1497						MOVEI	AC1,5				; AC1,5					
  1498	400042'	201 01 0 00 000005 						1367
  1499	400043'	202 01 0 00 000000*		MOVEM	AC1,DELAY			; AC1,DELAY
  1500						SETZM	DUPLEX				; DUPLEX				
  1501	400044'	402 00 0 00 000000*						1368
  1502						SETZM	DEBUG%FLAG			; DEBUG%FLAG				
  1503	400045'	402 00 0 00 000000*						1369
  1504						SETZM	WARN%FLAG			; WARN%FLAG				
  1505	400046'	402 00 0 00 000000*						1370
  1506						SETZM	ECHO%FLAG			; ECHO%FLAG				
  1507	400047'	402 00 0 00 000000*						1371
  1508						MOVEI	AC1,61				; AC1,61				
  1509	400050'	201 01 0 00 000061 						1372
  1510	400051'	202 01 0 00 000011'		MOVEM	AC1,U.46			; AC1,BLK%CHK%TYPE
  1511						MOVEI	AC1,61				; AC1,61				
  1512	400052'	201 01 0 00 000061 						1373
  1513	400053'	202 01 0 00 000000*		MOVEM	AC1,CHKTYPE			; AC1,CHKTYPE
  1514						MOVEM	AC1,U.45			; AC1,INI%CHK%TYPE			
  1515	400054'	202 01 0 00 000010'						1374
  1516						SETZM	DEV%PARITY%FLAG			; DEV%PARITY%FLAG			
  1517	400055'	402 00 0 00 000000*						1375
  1518						SETZM	PARITY%TYPE			; PARITY%TYPE				
  1519	400056'	402 00 0 00 000000*						1376
  1520						MOVEI	AC1,1				; AC1,1					
  1521	400057'	201 01 0 00 000001 						1377
  1522	400060'	202 01 0 00 000000*		MOVEM	AC1,ABT%FLAG			; AC1,ABT%FLAG
  1523						SETZM	U.59				; FILE%OPEN%FLAG			
  1524	400061'	402 00 0 00 000104'						1378
  1525						SETZM	IBM%FLAG			; IBM%FLAG				
  1526	400062'	402 00 0 00 000000*						1379
  1527						MOVEI	AC1,21				; AC1,21				
  1528	400063'	201 01 0 00 000021 						1380
  1529	400064'	202 01 0 00 000000*		MOVEM	AC1,IBM%CHAR			; AC1,IBM%CHAR
  1530						MOVEI	AC1,1				; AC1,1					
  1531	400065'	201 01 0 00 000001 						1381
  1532	400066'	202 01 0 00 000000*		MOVEM	AC1,TY%FIL			; AC1,TY%FIL
  1533						SETZM	TY%PKT				; TY%PKT				
  1534	400067'	402 00 0 00 000000*						1382
  1535						MOVEI	AC1,1				; AC1,1					
  1536	400070'	201 01 0 00 000001 						1383
  1537	400071'	202 01 0 00 000000*		MOVEM	AC1,FIL%NORMAL%FORM		; AC1,FIL%NORMAL%FORM
  1538						MOVEI	AC1,GET%FILE			; AC1,GET%FILE				
  1539	400072'	201 01 0 00 000000*						1384
  1540	400073'	202 01 0 00 000113'		MOVEM	AC1,U.66			; AC1,GET%CHR%ROUTINE
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-28
KERMSG	MAC	18-Jan-73 17:20	

  1541						MOVEI	AC1,PUT%FILE			; AC1,PUT%FILE				
  1542	400074'	201 01 0 00 000000*						1385
  1543	400075'	202 01 0 00 000114'		MOVEM	AC1,U.67			; AC1,PUT%CHR%ROUTINE
  1544						POPJ	SP,				; SP,					
  1545	400076'	263 17 0 00 000000 						1295
  1546
  1547					; Routine Size:  63 words
  1548
  1549
  1550					;   1387  1	
  1551					;   1388  1	%SBTTL 'SND%ERROR'
  1552					;   1389  1	
  1553					;   1390  1	GLOBAL ROUTINE SND%ERROR (COUNT, ADDRESS) : NOVALUE =
  1554					;   1391  1	
  1555					;   1392  1	!++
  1556					;   1393  1	! FUNCTIONAL DESCRIPTION:
  1557					;   1394  1	!
  1558					;   1395  1	!	This routine will send an error packet to the remote KERMIT.  It
  1559					;   1396  1	!	is called with the count of characters and the address of the text.
  1560					;   1397  1	!
  1561					;   1398  1	! CALLING SEQUENCE:
  1562					;   1399  1	!
  1563					;   1400  1	!	SND%ERROR(COUNT, %ASCII 'Error text');
  1564					;   1401  1	!
  1565					;   1402  1	! INPUT PARAMETERS:
  1566					;   1403  1	!
  1567					;   1404  1	!	None.
  1568					;   1405  1	!
  1569					;   1406  1	! IMPLICIT INPUTS:
  1570					;   1407  1	!
  1571					;   1408  1	!	None.
  1572					;   1409  1	!
  1573					;   1410  1	! OUTPUT PARAMETERS:
  1574					;   1411  1	!
  1575					;   1412  1	!	None.
  1576					;   1413  1	!
  1577					;   1414  1	! IMPLICIT OUTPUTS:
  1578					;   1415  1	!
  1579					;   1416  1	!	None.
  1580					;   1417  1	!
  1581					;   1418  1	! COMPLETION CODES:
  1582					;   1419  1	!
  1583					;   1420  1	!	None.
  1584					;   1421  1	!
  1585					;   1422  1	! SIDE EFFECTS:
  1586					;   1423  1	!
  1587					;   1424  1	!
  1588					;   1425  1	!--
  1589					;   1426  1	
  1590					;   1427  2	    BEGIN
  1591					;   1428  2	!
  1592					;   1429  2	! Pack the message into the buffer
  1593					;   1430  2	!
  1594					;   1431  2	    SET%STRING (CH$PTR (.ADDRESS), .COUNT, TRUE);
  1595					;   1432  2	    BFR%FILL (TRUE);
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-29
KERMSG	MAC	18-Jan-73 17:20	

  1596					;   1433  2	    SET%STRING (0, 0, FALSE);
  1597					;   1434  2	!
  1598					;   1435  2	! Save the last error message also
  1599					;   1436  2	!
  1600					;   1437  2	
  1601					;   1438  2	    IF .COUNT GTR MAX%MSG THEN COUNT = MAX%MSG;
  1602					;   1439  2	
  1603					;   1440  2	    CH$COPY (.COUNT, CH$PTR (.ADDRESS), 0, MAX%MSG + 1, CH$PTR (LAST%ERROR))
  1604					;
  1605					;   1441  2	
  1606					;   1442  2	    IF NOT SEND%PACKET (MSG%ERROR, .SIZE, .MSG%NUMBER) THEN RETURN KER%ABORT
  1607					ED;
  1608					;   1443  2	
  1609					;   1444  1	    END;					! End of SND%ERROR
  1610
  1611
  1612	400077'				SND%ERROR::
  1613						PUSH	SP,AC14				; SP,AC14				
  1614	400077'	261 17 0 00 000014 						1390
  1615	400100'	261 17 0 00 000016 		PUSH	SP,AC16				; SP,AC16
  1616						MOVE	AC16,-3(SP)			; AC16,ADDRESS				
  1617	400101'	200 16 0 17 777775 						1431
  1618	400102'	201 01 0 16 777777 		MOVEI	AC1,-1(AC16)			; AC1,-1(AC16)
  1619	400103'	505 01 0 00 010700 		HRLI	AC1,10700			; AC1,10700
  1620	400104'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
  1621	400105'	200 14 0 17 777773 		MOVE	AC14,-5(SP)			; AC14,COUNT
  1622	400106'	261 17 0 00 000014 		PUSH	SP,AC14				; SP,AC14
  1623	400107'	261 17 0 00 400144'		PUSH	SP,C.2				; SP,[1]
  1624	400110'	260 17 0 00 406157'		PUSHJ	SP,U.30				; SP,SET%STRING
  1625						PUSH	SP,C.2				; SP,[1]				
  1626	400111'	261 17 0 00 400144'						1432
  1627	400112'	260 17 0 00 405543'		PUSHJ	SP,U.29				; SP,BFR%FILL
  1628						SETZM	-2(SP)				; -2(SP)				
  1629	400113'	402 00 0 17 777776 						1433
  1630	400114'	402 00 0 17 777777 		SETZM	-1(SP)				; -1(SP)
  1631	400115'	402 00 0 17 000000 		SETZM	0(SP)				; 0(SP)
  1632	400116'	260 17 0 00 406157'		PUSHJ	SP,U.30				; SP,SET%STRING
  1633						CAIG	AC14,140			; AC14,140				
  1634	400117'	307 14 0 00 000140 						1438
  1635	400120'	254 00 0 00 400123'		JRST	L.1				; L.1
  1636	400121'	201 01 0 00 000140 		MOVEI	AC1,140				; AC1,140
  1637	400122'	202 01 0 17 777770 		MOVEM	AC1,-10(SP)			; AC1,COUNT
  1638					L.1:	MOVEI	AC2,-1(AC16)			; AC2,-1(AC16)				
  1639	400123'	201 02 0 16 777777 						1440
  1640	400124'	505 02 0 00 010700 		HRLI	AC2,10700			; AC2,10700
  1641	400125'	200 01 0 17 777770 		MOVE	AC1,-10(SP)			; AC1,COUNT
  1642	400126'	201 04 0 00 000141 		MOVEI	AC4,141				; AC4,141
  1643	400127'	200 05 0 00 400145'		MOVE	AC5,C.3				; AC5,[POINT 7,LAST%ERROR-1,34]  <1,7>
  1644	400130'	123 01 0 00 400142'		EXTEND	AC1,C.1				; AC1,C.1
  1645	400131'	255 00 0 00 000000 		JFCL					;
  1646						PUSH	SP,C.4				; SP,[105]				
  1647	400132'	261 17 0 00 400146'						1442
  1648	400133'	261 17 0 00 000015'		PUSH	SP,U.50				; SP,SIZE
  1649	400134'	261 17 0 00 000020'		PUSH	SP,U.53				; SP,MSG%NUMBER
  1650	400135'	260 17 0 00 404426'		PUSHJ	SP,U.24				; SP,SEND%PACKET
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-30
KERMSG	MAC	18-Jan-73 17:20	

  1651	400136'	105 17 0 00 777771 		ADJSP	SP,-7				; SP,-7
  1652						POP	SP,AC16				; SP,AC16				
  1653	400137'	262 17 0 00 000016 						1390
  1654	400140'	262 17 0 00 000014 		POP	SP,AC14				; SP,AC14
  1655	400141'	263 17 0 00 000000 		POPJ	SP,				; SP,
  1656	400142'	016 00 0 00 000000 	C.1:	MOVSLJ					;
  1657	400143'	000000	000000			EXP	0				; 0
  1658	400144'	000000	000001		C.2:	EXP	1				; 1
  1659	400145'	01 07 0 00 000000#	C.3:	POINT	7,LAST%ERROR-1,34		; 7,LAST%ERROR-1,34
  1660	400146'	000000	000105		C.4:	EXP	105				; 105
  1661
  1662					; Routine Size:  40 words
  1663
  1664
  1665					;   1445  1	
  1666					;   1446  1	%SBTTL 'SERVER - Server mode'
  1667					;   1447  1	
  1668					;   1448  1	GLOBAL ROUTINE SERVER =
  1669					;   1449  1	
  1670					;   1450  1	!++
  1671					;   1451  1	! FUNCTIONAL DESCRIPTION:
  1672					;   1452  1	!
  1673					;   1453  1	!	This routine will handle the server function in the v2.0 protocol
  1674					;   1454  1	!	for KERMIT.  This routine by it's nature will call various operating
  1675
  1676					;   1455  1	!	system routines to do things like logging off the system.
  1677					;   1456  1	!
  1678					;   1457  1	! CALLING SEQUENCE:
  1679					;   1458  1	!
  1680					;   1459  1	!	EXIT%FLAG = SERVER();
  1681					;   1460  1	!
  1682					;   1461  1	! INPUT PARAMETERS:
  1683					;   1462  1	!
  1684					;   1463  1	!	None.
  1685					;   1464  1	!
  1686					;   1465  1	! IMPLICIT INPUTS:
  1687					;   1466  1	!
  1688					;   1467  1	!	None.
  1689					;   1468  1	!
  1690					;   1469  1	! OUTPUT PARAMETERS:
  1691					;   1470  1	!
  1692					;   1471  1	!	None.
  1693					;   1472  1	!
  1694					;   1473  1	! IMPLICIT OUTPUTS:
  1695					;   1474  1	!
  1696					;   1475  1	!	None.
  1697					;   1476  1	!
  1698					;   1477  1	! COMPLETION CODES:
  1699					;   1478  1	!
  1700					;   1479  1	!	None.
  1701					;   1480  1	!
  1702					;   1481  1	! SIDE EFFECTS:
  1703					;   1482  1	!
  1704					;   1483  1	!	None.
  1705					;   1484  1	!
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-31
KERMSG	MAC	18-Jan-73 17:20	

  1706					;   1485  1	!--
  1707					;   1486  1	
  1708					;   1487  2	    BEGIN
  1709					;   1488  2	
  1710					;   1489  2	    LOCAL
  1711					;   1490  2		STATUS;					! Status returned by various
  1712					 routines
  1713					;   1491  2	
  1714					;   1492  2	    DO
  1715					;   1493  3		BEGIN
  1716					;   1494  3		INIT%XFR ();
  1717					;   1495  3		XFR%STATUS (%C'T', %C'I');		! Now idle
  1718					;   1496  3		STATUS = DO%TRANSACTION (STATE%ID);
  1719					;   1497  3		END
  1720					;   1498  2	    UNTIL .STATUS EQL KER%EXIT OR .STATUS EQL KER%ABORTED;
  1721					;   1499  2	
  1722					;   1500  2	    RETURN .STATUS;
  1723					;   1501  1	    END;					! End of GLOBAL ROUTINE SERV
  1724					ER
  1725
  1726
  1727					SERVER::PUSH	SP,AC16				; SP,AC16				
  1728	400147'	261 17 0 00 000016 						1448
  1729					L.2:	PUSHJ	SP,U.32				; SP,INIT%XFR				
  1730	400150'	260 17 0 00 406306'						1494
  1731						PUSH	SP,C.5				; SP,[124]				
  1732	400151'	261 17 0 00 400167'						1495
  1733	400152'	261 17 0 00 400170'		PUSH	SP,C.6				; SP,[111]
  1734	400153'	260 17 0 00 000000*		PUSHJ	SP,XFR%STATUS			; SP,XFR%STATUS
  1735						PUSH	SP,C.7				; SP,[16]				
  1736	400154'	261 17 0 00 400171'						1496
  1737	400155'	260 17 0 00 400416'		PUSHJ	SP,U.1				; SP,DO%TRANSACTION
  1738	400156'	200 16 0 00 000001 		MOVE	AC16,AC1			; STATUS,AC1
  1739						ADJSP	SP,-3				; SP,-3					
  1740	400157'	105 17 0 00 777775 						1493
  1741						CAIN	AC16,223			; STATUS,223				
  1742	400160'	306 16 0 00 000223 						1498
  1743	400161'	254 00 0 00 400164'		JRST	L.3				; L.3
  1744	400162'	302 16 0 00 000312 		CAIE	AC16,312			; STATUS,312
  1745						JRST	L.2				; L.2					
  1746	400163'	254 00 0 00 400150'						1492
  1747					L.3:	MOVE	AC1,AC16			; AC1,STATUS				
  1748	400164'	200 01 0 00 000016 						1487
  1749						POP	SP,AC16				; SP,AC16				
  1750	400165'	262 17 0 00 000016 						1448
  1751	400166'	263 17 0 00 000000 		POPJ	SP,				; SP,
  1752	400167'	000000	000124		C.5:	EXP	124				; 124
  1753	400170'	000000	000111		C.6:	EXP	111				; 111
  1754	400171'	000000	000016		C.7:	EXP	16				; 16
  1755
  1756					; Routine Size:  19 words
  1757
  1758
  1759					;   1502  1	
  1760					;   1503  1	%SBTTL 'SEND%SWITCH'
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-32
KERMSG	MAC	18-Jan-73 17:20	

  1761					;   1504  1	
  1762					;   1505  1	GLOBAL ROUTINE SEND%SWITCH =
  1763					;   1506  1	
  1764					;   1507  1	!++
  1765					;   1508  1	! FUNCTIONAL DESCRIPTION:
  1766					;   1509  1	!
  1767					;   1510  1	!	This routine is the state table switcher for sending files.  It
  1768					;   1511  1	!	loops until either it is finished or an error is encountered.  The
  1769					;   1512  1	!	routines called by SEND%SWITCH are responsible for changing the stat
  1770					e.
  1771					;   1513  1	!
  1772					;   1514  1	! CALLING SEQUENCE:
  1773					;   1515  1	!
  1774					;   1516  1	!	SEND%SWITCH();
  1775					;   1517  1	!
  1776					;   1518  1	! INPUT PARAMETERS:
  1777					;   1519  1	!
  1778					;   1520  1	!	None.
  1779					;   1521  1	!
  1780					;   1522  1	! IMPLICIT INPUTS:
  1781					;   1523  1	!
  1782					;   1524  1	!	None.
  1783					;   1525  1	!
  1784					;   1526  1	! OUTPUT PARAMETERS:
  1785					;   1527  1	!
  1786					;   1528  1	!	Returns:
  1787					;   1529  1	!	    TRUE - File sent correctly.
  1788					;   1530  1	!	    FALSE - Aborted sending the file.
  1789					;   1531  1	!
  1790					;   1532  1	! IMPLICIT OUTPUTS:
  1791					;   1533  1	!
  1792					;   1534  1	!	None.
  1793					;   1535  1	!
  1794					;   1536  1	! COMPLETION CODES:
  1795					;   1537  1	!
  1796					;   1538  1	!	None.
  1797					;   1539  1	!
  1798					;   1540  1	! SIDE EFFECTS:
  1799					;   1541  1	!
  1800					;   1542  1	!	None.
  1801					;   1543  1	!
  1802					;   1544  1	!--
  1803					;   1545  1	
  1804					;   1546  2	    BEGIN
  1805					;   1547  2	
  1806					;   1548  2	    LOCAL
  1807					;   1549  2		STATUS;					! Status result
  1808					;   1550  2	
  1809					;   1551  2	    IF .CONNECT%FLAG THEN SY%DISMISS (.DELAY);	! Sleep if the user wanted u
  1810					s to
  1811					;   1552  2	
  1812					;   1553  2	    INIT%XFR ();				! Initialize for this transf
  1813					er
  1814					;   1554  2	    TEXT%HEAD%FLAG = FALSE;			! Set text flag correctly
  1815					;   1555  2	    XFR%STATUS (%C'I', %C'S');			! Start of file send
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-33
KERMSG	MAC	18-Jan-73 17:20	

  1816					;   1556  2	    STATUS = DO%TRANSACTION (STATE%S);		! Call routine to do real wo
  1817					rk
  1818					;   1557  2	    XFR%STATUS (%C'T', %C'S');			! Done with send
  1819					;   1558  2	    RETURN .STATUS;				! Return the result
  1820					;   1559  1	    END;
  1821
  1822
  1823	400172'				SEND%SWITCH::
  1824						PUSH	SP,AC16				; SP,AC16				
  1825	400172'	261 17 0 00 000016 						1505
  1826						MOVEI	AC1,1				; AC1,1					
  1827	400173'	201 01 0 00 000001 						1551
  1828	400174'	616 01 0 00 000000*		TDNN	AC1,CONNECT%FLAG		; AC1,CONNECT%FLAG
  1829	400175'	254 00 0 00 400201'		JRST	L.4				; L.4
  1830	400176'	261 17 0 00 400043*		PUSH	SP,DELAY			; SP,DELAY
  1831	400177'	260 17 0 00 000000*		PUSHJ	SP,SY%DISMISS			; SP,SY%DISMISS
  1832	400200'	105 17 0 00 777777 		ADJSP	SP,-1				; SP,-1
  1833					L.4:	PUSHJ	SP,U.32				; SP,INIT%XFR				
  1834	400201'	260 17 0 00 406306'						1553
  1835						SETZM	U.61				; TEXT%HEAD%FLAG			
  1836	400202'	402 00 0 00 000106'						1554
  1837						PUSH	SP,C.6				; SP,[111]				
  1838	400203'	261 17 0 00 400170'						1555
  1839	400204'	261 17 0 00 400220'		PUSH	SP,C.8				; SP,[123]
  1840	400205'	260 17 0 00 400153*		PUSHJ	SP,XFR%STATUS			; SP,XFR%STATUS
  1841						PUSH	SP,C.2				; SP,[1]				
  1842	400206'	261 17 0 00 400144'						1556
  1843	400207'	260 17 0 00 400416'		PUSHJ	SP,U.1				; SP,DO%TRANSACTION
  1844	400210'	200 16 0 00 000001 		MOVE	AC16,AC1			; STATUS,AC1
  1845						PUSH	SP,C.5				; SP,[124]				
  1846	400211'	261 17 0 00 400167'						1557
  1847	400212'	261 17 0 00 400220'		PUSH	SP,C.8				; SP,[123]
  1848	400213'	260 17 0 00 400205*		PUSHJ	SP,XFR%STATUS			; SP,XFR%STATUS
  1849						ADJSP	SP,-5				; SP,-5					
  1850	400214'	105 17 0 00 777773 						1558
  1851						MOVE	AC1,AC16			; AC1,STATUS				
  1852	400215'	200 01 0 00 000016 						1546
  1853						POP	SP,AC16				; SP,AC16				
  1854	400216'	262 17 0 00 000016 						1505
  1855	400217'	263 17 0 00 000000 		POPJ	SP,				; SP,
  1856	400220'	000000	000123		C.8:	EXP	123				; 123
  1857
  1858					; Routine Size:  23 words
  1859
  1860
  1861					;   1560  1	
  1862					;   1561  1	%SBTTL 'REC%SWITCH'
  1863					;   1562  1	
  1864					;   1563  1	GLOBAL ROUTINE REC%SWITCH =
  1865					;   1564  1	
  1866					;   1565  1	!++
  1867					;   1566  1	! FUNCTIONAL DESCRIPTION:
  1868					;   1567  1	!
  1869					;   1568  1	!	This routine will cause file(s) to be received by the remote
  1870					;   1569  1	!	KERMIT.  This routine contains the main loop for the sending of the
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-34
KERMSG	MAC	18-Jan-73 17:20	

  1871					;   1570  1	!	data.
  1872					;   1571  1	!
  1873					;   1572  1	! CALLING SEQUENCE:
  1874					;   1573  1	!
  1875					;   1574  1	!	REC%SWITCH();
  1876					;   1575  1	!
  1877					;   1576  1	! INPUT PARAMETERS:
  1878					;   1577  1	!
  1879					;   1578  1	!	None.
  1880					;   1579  1	!
  1881					;   1580  1	! IMPLICIT INPUTS:
  1882					;   1581  1	!
  1883					;   1582  1	!	FILE%DESC - Descriptor describing the file to be received by
  1884					;   1583  1	!		the remote KERMIT.
  1885					;   1584  1	!
  1886					;   1585  1	! OUTPUT PARAMETERS:
  1887					;   1586  1	!
  1888					;   1587  1	!	None.
  1889					;   1588  1	!
  1890					;   1589  1	! IMPLICIT OUTPUTS:
  1891					;   1590  1	!
  1892					;   1591  1	!	None.
  1893					;   1592  1	!
  1894					;   1593  1	! COMPLETION CODES:
  1895					;   1594  1	!
  1896					;   1595  1	!	True - File received correctly.
  1897					;   1596  1	!	FALSE - File transfer aborted.
  1898					;   1597  1	!
  1899					;   1598  1	! SIDE EFFECTS:
  1900					;   1599  1	!
  1901					;   1600  1	!	None.
  1902					;   1601  1	!
  1903					;   1602  1	!--
  1904					;   1603  1	
  1905					;   1604  2	    BEGIN
  1906					;   1605  2	
  1907					;   1606  2	    LOCAL
  1908					;   1607  2		INIT%STATE,				! State to start up DO%TRANS
  1909					ACTION in
  1910					;   1608  2		STATUS;					! Status returned by various
  1911					 routines
  1912					;   1609  2	
  1913					;   1610  2	    INIT%STATE = STATE%R;			! Initialize the state
  1914					;   1611  2	    MSG%NUMBER = 0;
  1915					;   1612  2	    INIT%XFR ();				! Initialize the per transfe
  1916					r info
  1917					;   1613  2	!
  1918					;   1614  2	! Determine if they said REC <file-spec>
  1919					;   1615  2	!	Send MSG%RCV%INIT and then receive the file
  1920					;   1616  2	!
  1921					;   1617  2	
  1922					;   1618  2	    IF .FILE%SIZE GTR 0
  1923					;   1619  2	    THEN
  1924					;   1620  3		BEGIN
  1925					;   1621  3		GEN%TYPE = MSG%RCV%INIT;		! Use receive-init message
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-35
KERMSG	MAC	18-Jan-73 17:20	

  1926					;   1622  3		CH$MOVE (.FILE%SIZE, CH$PTR (FILE%NAME), CH$PTR (GEN%1DATA));
  1927					;   1623  3		GEN%1SIZE = .FILE%SIZE;			! Save the length
  1928					;   1624  3		INIT%STATE = STATE%SI;			! Start out with server init
  1929
  1930					;   1625  2		END;
  1931					;   1626  2	
  1932					;   1627  2	!
  1933					;   1628  2	! Now receive the file normally
  1934					;   1629  2	!
  1935					;   1630  2	    XFR%STATUS (%C'I', %C'R');			! Start of a file receive
  1936					;   1631  2	    STATUS = DO%TRANSACTION (.INIT%STATE);
  1937					;   1632  2	    XFR%STATUS (%C'T', %C'R');			! End of file receive
  1938					;   1633  2	    RETURN .STATUS;				! Return the result
  1939					;   1634  1	    END;					! End of REC%SWITCH
  1940
  1941
  1942	400221'				REC%SWITCH::
  1943						PUSH	SP,AC16				; SP,AC16				
  1944	400221'	261 17 0 00 000016 						1563
  1945						MOVEI	AC16,6				; INIT%STATE,6				
  1946	400222'	201 16 0 00 000006 						1610
  1947						SETZM	U.53				; MSG%NUMBER				
  1948	400223'	402 00 0 00 000020'						1611
  1949						PUSHJ	SP,U.32				; SP,INIT%XFR				
  1950	400224'	260 17 0 00 406306'						1612
  1951						MOVE	AC3,FILE%SIZE			; AC3,FILE%SIZE				
  1952	400225'	200 03 0 00 000000*						1618
  1953	400226'	323 03 0 00 400241'		JUMPLE	AC3,L.5				; AC3,L.5
  1954						MOVEI	AC1,122				; AC1,122				
  1955	400227'	201 01 0 00 000122 						1621
  1956	400230'	202 01 0 00 000111'		MOVEM	AC1,U.64			; AC1,GEN%TYPE
  1957						MOVE	AC1,AC3				; AC1,AC3				
  1958	400231'	200 01 0 00 000003 						1622
  1959	400232'	200 02 0 00 400257'		MOVE	AC2,C.10			; AC2,[POINT 7,FILE%NAME-1,34]  <1,7>
  1960	400233'	200 04 0 00 000003 		MOVE	AC4,AC3				; AC4,AC3
  1961	400234'	200 05 0 00 400260'		MOVE	AC5,C.11			; AC5,[POINT 7,GEN%1DATA-1,34]  <1,7>
  1962	400235'	123 01 0 00 400256'		EXTEND	AC1,C.9				; AC1,[MOVSLJ ]
  1963	400236'	255 00 0 00 000000 		JFCL					;
  1964						MOVEM	AC3,GEN%1SIZE			; AC3,GEN%1SIZE				
  1965	400237'	202 03 0 00 000000*						1623
  1966						MOVEI	AC16,15				; INIT%STATE,15				
  1967	400240'	201 16 0 00 000015 						1624
  1968					L.5:	PUSH	SP,C.6				; SP,[111]				
  1969	400241'	261 17 0 00 400170'						1630
  1970	400242'	261 17 0 00 400261'		PUSH	SP,C.12				; SP,[122]
  1971	400243'	260 17 0 00 400213*		PUSHJ	SP,XFR%STATUS			; SP,XFR%STATUS
  1972						MOVEM	AC16,0(SP)			; INIT%STATE,0(SP)			
  1973	400244'	202 16 0 17 000000 						1631
  1974	400245'	260 17 0 00 400416'		PUSHJ	SP,U.1				; SP,DO%TRANSACTION
  1975	400246'	200 16 0 00 000001 		MOVE	AC16,AC1			; STATUS,AC1
  1976						PUSH	SP,C.5				; SP,[124]				
  1977	400247'	261 17 0 00 400167'						1632
  1978	400250'	261 17 0 00 400261'		PUSH	SP,C.12				; SP,[122]
  1979	400251'	260 17 0 00 400243*		PUSHJ	SP,XFR%STATUS			; SP,XFR%STATUS
  1980						ADJSP	SP,-4				; SP,-4					
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-36
KERMSG	MAC	18-Jan-73 17:20	

  1981	400252'	105 17 0 00 777774 						1633
  1982						MOVE	AC1,AC16			; AC1,STATUS				
  1983	400253'	200 01 0 00 000016 						1604
  1984						POP	SP,AC16				; SP,AC16				
  1985	400254'	262 17 0 00 000016 						1563
  1986	400255'	263 17 0 00 000000 		POPJ	SP,				; SP,
  1987	400256'	016 00 0 00 000000 	C.9:	MOVSLJ					;
  1988	400257'	01 07 0 00 000000#	C.10:	POINT	7,FILE%NAME-1,34		; 7,FILE%NAME-1,34
  1989	400260'	01 07 0 00 000000#	C.11:	POINT	7,GEN%1DATA-1,34		; 7,GEN%1DATA-1,34
  1990	400261'	000000	000122		C.12:	EXP	122				; 122
  1991
  1992					; Routine Size:  33 words
  1993
  1994
  1995					;   1635  1	
  1996					;   1636  1	%SBTTL 'Server -- DO%GENERIC - Execute a generic command'
  1997					;   1637  1	
  1998					;   1638  1	GLOBAL ROUTINE DO%GENERIC (TYPE) =
  1999					;   1639  1	
  2000					;   1640  1	!++
  2001					;   1641  1	! FUNCTIONAL DESCRIPTION:
  2002					;   1642  1	!
  2003					;   1643  1	!	This routine will send a generic command to the remote Kermit.
  2004					;   1644  1	!	it will do all the processing required for the generic command
  2005					;   1645  1	!	that was executed.  It will return to the caller after the
  2006					;   1646  1	!	command has be executed.
  2007					;   1647  1	!
  2008					;   1648  1	! CALLING SEQUENCE:
  2009					;   1649  1	!
  2010					;   1650  1	!	STATUS = DO%GENERIC (Command-type);
  2011					;   1651  1	!
  2012					;   1652  1	! INPUT PARAMETERS:
  2013					;   1653  1	!
  2014					;   1654  1	!	Command-type -- Command type to be executed.
  2015					;   1655  1	!
  2016					;   1656  1	! IMPLICIT INPUTS:
  2017					;   1657  1	!
  2018					;   1658  1	!	None.
  2019					;   1659  1	!
  2020					;   1660  1	! OUTPUT PARAMETERS:
  2021					;   1661  1	!
  2022					;   1662  1	!	None.
  2023					;   1663  1	!
  2024					;   1664  1	! IMPLICIT OUTPUTS:
  2025					;   1665  1	!
  2026					;   1666  1	!	None.
  2027					;   1667  1	!
  2028					;   1668  1	! COMPLETION CODES:
  2029					;   1669  1	!
  2030					;   1670  1	!	None.
  2031					;   1671  1	!
  2032					;   1672  1	! SIDE EFFECTS:
  2033					;   1673  1	!
  2034					;   1674  1	!	None.
  2035					;   1675  1	!
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-37
KERMSG	MAC	18-Jan-73 17:20	

  2036					;   1676  1	!--
  2037					;   1677  1	
  2038					;   1678  2	    BEGIN
  2039					;   1679  2	
  2040					;   1680  2	    LOCAL
  2041					;   1681  2		INIT%STATE;				! Initial state for FSM
  2042					;   1682  2	
  2043					;   1683  2	!
  2044					;   1684  2	! Set up the per transfer items
  2045					;   1685  2	!
  2046					;   1686  2	    INIT%XFR ();
  2047					;   1687  2	    NUM%RETRIES = 0;
  2048					;   1688  2	    MSG%NUMBER = 0;
  2049					;   1689  2	!
  2050					;   1690  2	! These are all generic commands
  2051					;   1691  2	!
  2052					;   1692  2	    GEN%TYPE = MSG%GENERIC;
  2053					;   1693  2	!
  2054					;   1694  2	! Assume we will not need server init
  2055					;   1695  2	!
  2056					;   1696  2	    INIT%STATE = STATE%SG;
  2057					;   1697  2	
  2058					;   1698  2	    CASE .TYPE FROM GC%MIN TO GC%MAX OF
  2059					;   1699  2		SET
  2060					;   1700  2	
  2061					;   1701  2		[GC%EXIT] :
  2062					;   1702  2		    GEN%SUBTYPE = MSG%GEN%EXIT;
  2063					;   1703  2	
  2064					;   1704  2		[GC%LOGOUT] :
  2065					;   1705  2		    GEN%SUBTYPE = MSG%GEN%LOGOUT;
  2066					;   1706  2	
  2067					;   1707  2		[GC%DIRECTORY] :
  2068					;   1708  3		    BEGIN
  2069					;   1709  3		    INIT%STATE = STATE%SI;		! We will need server-init
  2070					;   1710  3		    GEN%SUBTYPE = MSG%GEN%DIRECTORY;
  2071					;   1711  2		    END;
  2072					;   1712  2	
  2073					;   1713  2		[GC%DISK%USAGE] :
  2074					;   1714  3		    BEGIN
  2075					;   1715  3		    INIT%STATE = STATE%SI;		! We will need server-init
  2076					;   1716  3		    GEN%SUBTYPE = MSG%GEN%DISK%USAGE;
  2077					;   1717  2		    END;
  2078					;   1718  2	
  2079					;   1719  2		[GC%DELETE] :
  2080					;   1720  2		    GEN%SUBTYPE = MSG%GEN%DELETE;
  2081					;   1721  2	
  2082					;   1722  2		[GC%TYPE] :
  2083					;   1723  3		    BEGIN
  2084					;   1724  3		    INIT%STATE = STATE%SI;		! We will need server-init
  2085					;   1725  3		    GEN%SUBTYPE = MSG%GEN%TYPE;
  2086					;   1726  2		    END;
  2087					;   1727  2	
  2088					;   1728  2		[GC%HELP] :
  2089					;   1729  3		    BEGIN
  2090					;   1730  3		    INIT%STATE = STATE%SI;		! We will need server-init
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-38
KERMSG	MAC	18-Jan-73 17:20	

  2091					;   1731  3		    GEN%SUBTYPE = MSG%GEN%HELP;
  2092					;   1732  2		    END;
  2093					;   1733  2	
  2094					;   1734  2		[GC%LGN] :
  2095					;   1735  2		    GEN%SUBTYPE = MSG%GEN%LOGIN;	! Login just gets ACK
  2096					;   1736  2	
  2097					;   1737  2		[GC%CONNECT] :
  2098					;   1738  2		    GEN%SUBTYPE = MSG%GEN%CONNECT;	! CWD just gets ACK
  2099					;   1739  2	
  2100					;   1740  2		[GC%RENAME] :
  2101					;   1741  2		    GEN%SUBTYPE = MSG%GEN%RENAME;	! Rename file just needs ACK
  2102
  2103					;   1742  2	
  2104					;   1743  2		[GC%COPY] :
  2105					;   1744  2		    GEN%SUBTYPE = MSG%GEN%COPY;		! Copy file just needs ACK
  2106					;   1745  2	
  2107					;   1746  2		[GC%WHO] :
  2108					;   1747  3		    BEGIN
  2109					;   1748  3		    INIT%STATE = STATE%SI;		! May get large response
  2110					;   1749  3		    GEN%SUBTYPE = MSG%GEN%WHO;
  2111					;   1750  2		    END;
  2112					;   1751  2	
  2113					;   1752  2		[GC%SEND%MSG] :
  2114					;   1753  2		    GEN%SUBTYPE = MSG%GEN%SEND;		! Just need an ACK
  2115					;   1754  2	
  2116					;   1755  2		[GC%STATUS] :
  2117					;   1756  3		    BEGIN
  2118					;   1757  3		    INIT%STATE = STATE%SI;		! May get large response
  2119					;   1758  3		    GEN%SUBTYPE = MSG%GEN%QUERY;
  2120					;   1759  2		    END;
  2121					;   1760  2	
  2122					;   1761  2		[GC%COMMAND] :
  2123					;   1762  3		    BEGIN
  2124					;   1763  3		    INIT%STATE = STATE%SI;		! Large response likely
  2125					;   1764  3		    GEN%TYPE = MSG%COMMAND;		! This is host command
  2126					;   1765  2		    END;
  2127					;   1766  2	
  2128					;   1767  2		[GC%KERMIT] :
  2129					;   1768  2		    GEN%TYPE = MSG%KERMIT;		! Perform Kermit command (sh
  2130					ort response)
  2131					;   1769  2	
  2132					;   1770  2		[GC%PROGRAM] :
  2133					;   1771  3		    BEGIN
  2134					;   1772  3		    INIT%STATE = STATE%SI;		! Assume large response
  2135					;   1773  3		    GEN%SUBTYPE = MSG%GEN%PROGRAM;	! Generic program command
  2136					;   1774  2		    END;
  2137					;   1775  2	
  2138					;   1776  2		[GC%JOURNAL] :
  2139					;   1777  2		    GEN%SUBTYPE = MSG%GEN%JOURNAL;	! Do journal function (short
  2140					 reply)
  2141					;   1778  2	
  2142					;   1779  2		[GC%VARIABLE] :
  2143					;   1780  2		    GEN%SUBTYPE = MSG%GEN%VARIABLE;	! Set or get a variable valu
  2144					e
  2145					;   1781  2	
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-39
KERMSG	MAC	18-Jan-73 17:20	

  2146					;   1782  2		[INRANGE, OUTRANGE] :
  2147					;   1783  3		    BEGIN
  2148					;   1784  3		    KRM%ERROR (KER%UNIMPLGEN);
  2149					;   1785  3		    RETURN STATE%A;
  2150					;   1786  2		    END;
  2151					;   1787  2		TES;
  2152					;   1788  2	
  2153					;   1789  2	    RETURN DO%TRANSACTION (.INIT%STATE);	! Go do the command
  2154					;   1790  1	    END;					! End of DO%GENERIC
  2155
  2156
  2157	400262'				DO%GENERIC::
  2158						PUSH	SP,AC16				; SP,AC16				
  2159	400262'	261 17 0 00 000016 						1638
  2160						PUSHJ	SP,U.32				; SP,INIT%XFR				
  2161	400263'	260 17 0 00 406306'						1686
  2162						SETZM	U.52				; NUM%RETRIES				
  2163	400264'	402 00 0 00 000017'						1687
  2164						SETZM	U.53				; MSG%NUMBER				
  2165	400265'	402 00 0 00 000020'						1688
  2166						MOVEI	AC1,107				; AC1,107				
  2167	400266'	201 01 0 00 000107 						1692
  2168	400267'	202 01 0 00 000111'		MOVEM	AC1,U.64			; AC1,GEN%TYPE
  2169						MOVEI	AC16,14				; INIT%STATE,14				
  2170	400270'	201 16 0 00 000014 						1696
  2171						MOVE	AC1,-2(SP)			; AC1,TYPE				
  2172	400271'	200 01 0 17 777776 						1698
  2173	400272'	361 01 0 00 400321'		SOJL	AC1,L.7				; AC1,L.7
  2174	400273'	305 01 0 00 000023 		CAIGE	AC1,23				; AC1,23
  2175	400274'	254 00 0 01 400276'		JRST	L.6(AC1)			; L.6(AC1)
  2176	400275'	254 00 0 00 400321'		JRST	L.7				; L.7
  2177	400276'	254 00 0 00 400326'	L.6:	JRST	L.8				; L.8
  2178	400277'	254 00 0 00 400332'		JRST	L.10				; L.10
  2179	400300'	254 00 0 00 400335'		JRST	L.11				; L.11
  2180	400301'	254 00 0 00 400340'		JRST	L.12				; L.12
  2181	400302'	254 00 0 00 400342'		JRST	L.13				; L.13
  2182	400303'	254 00 0 00 400345'		JRST	L.14				; L.14
  2183	400304'	254 00 0 00 400330'		JRST	L.9				; L.9
  2184	400305'	254 00 0 00 400350'		JRST	L.15				; L.15
  2185	400306'	254 00 0 00 400352'		JRST	L.16				; L.16
  2186	400307'	254 00 0 00 400354'		JRST	L.17				; L.17
  2187	400310'	254 00 0 00 400356'		JRST	L.18				; L.18
  2188	400311'	254 00 0 00 400360'		JRST	L.19				; L.19
  2189	400312'	254 00 0 00 400363'		JRST	L.20				; L.20
  2190	400313'	254 00 0 00 400365'		JRST	L.21				; L.21
  2191	400314'	254 00 0 00 400370'		JRST	L.22				; L.22
  2192	400315'	254 00 0 00 400373'		JRST	L.23				; L.23
  2193	400316'	254 00 0 00 400401'		JRST	L.26				; L.26
  2194	400317'	254 00 0 00 400403'		JRST	L.27				; L.27
  2195	400320'	254 00 0 00 400376'		JRST	L.25				; L.25
  2196					L.7:	PUSH	SP,C.13				; SP,[232]				
  2197	400321'	261 17 0 00 400412'						1784
  2198	400322'	260 17 0 00 000000*		PUSHJ	SP,KRM%ERROR			; SP,KRM%ERROR
  2199						ADJSP	SP,-1				; SP,-1					
  2200	400323'	105 17 0 00 777777 						1785
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-40
KERMSG	MAC	18-Jan-73 17:20	

  2201						MOVEI	AC1,12				; AC1,12				
  2202	400324'	201 01 0 00 000012 						1783
  2203	400325'	254 00 0 00 400410'		JRST	L.30				; L.30
  2204					L.8:	MOVEI	AC1,106				; AC1,106				
  2205	400326'	201 01 0 00 000106 						1702
  2206	400327'	254 00 0 00 400404'		JRST	L.28				; L.28
  2207					L.9:	MOVEI	AC1,114				; AC1,114				
  2208	400330'	201 01 0 00 000114 						1705
  2209	400331'	254 00 0 00 400404'		JRST	L.28				; L.28
  2210					L.10:	MOVEI	AC16,15				; INIT%STATE,15				
  2211	400332'	201 16 0 00 000015 						1709
  2212						MOVEI	AC1,104				; AC1,104				
  2213	400333'	201 01 0 00 000104 						1710
  2214	400334'	254 00 0 00 400404'		JRST	L.28				; L.28
  2215					L.11:	MOVEI	AC16,15				; INIT%STATE,15				
  2216	400335'	201 16 0 00 000015 						1715
  2217						MOVEI	AC1,125				; AC1,125				
  2218	400336'	201 01 0 00 000125 						1716
  2219	400337'	254 00 0 00 400404'		JRST	L.28				; L.28
  2220					L.12:	MOVEI	AC1,105				; AC1,105				
  2221	400340'	201 01 0 00 000105 						1720
  2222	400341'	254 00 0 00 400404'		JRST	L.28				; L.28
  2223					L.13:	MOVEI	AC16,15				; INIT%STATE,15				
  2224	400342'	201 16 0 00 000015 						1724
  2225						MOVEI	AC1,124				; AC1,124				
  2226	400343'	201 01 0 00 000124 						1725
  2227	400344'	254 00 0 00 400404'		JRST	L.28				; L.28
  2228					L.14:	MOVEI	AC16,15				; INIT%STATE,15				
  2229	400345'	201 16 0 00 000015 						1730
  2230						MOVEI	AC1,110				; AC1,110				
  2231	400346'	201 01 0 00 000110 						1731
  2232	400347'	254 00 0 00 400404'		JRST	L.28				; L.28
  2233					L.15:	MOVEI	AC1,111				; AC1,111				
  2234	400350'	201 01 0 00 000111 						1735
  2235	400351'	254 00 0 00 400404'		JRST	L.28				; L.28
  2236					L.16:	MOVEI	AC1,103				; AC1,103				
  2237	400352'	201 01 0 00 000103 						1738
  2238	400353'	254 00 0 00 400404'		JRST	L.28				; L.28
  2239					L.17:	MOVEI	AC1,122				; AC1,122				
  2240	400354'	201 01 0 00 000122 						1741
  2241	400355'	254 00 0 00 400404'		JRST	L.28				; L.28
  2242					L.18:	MOVEI	AC1,113				; AC1,113				
  2243	400356'	201 01 0 00 000113 						1744
  2244	400357'	254 00 0 00 400404'		JRST	L.28				; L.28
  2245					L.19:	MOVEI	AC16,15				; INIT%STATE,15				
  2246	400360'	201 16 0 00 000015 						1748
  2247						MOVEI	AC1,127				; AC1,127				
  2248	400361'	201 01 0 00 000127 						1749
  2249	400362'	254 00 0 00 400404'		JRST	L.28				; L.28
  2250					L.20:	MOVEI	AC1,115				; AC1,115				
  2251	400363'	201 01 0 00 000115 						1753
  2252	400364'	254 00 0 00 400404'		JRST	L.28				; L.28
  2253					L.21:	MOVEI	AC16,15				; INIT%STATE,15				
  2254	400365'	201 16 0 00 000015 						1757
  2255						MOVEI	AC1,121				; AC1,121				
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-41
KERMSG	MAC	18-Jan-73 17:20	

  2256	400366'	201 01 0 00 000121 						1758
  2257	400367'	254 00 0 00 400404'		JRST	L.28				; L.28
  2258					L.22:	MOVEI	AC16,15				; INIT%STATE,15				
  2259	400370'	201 16 0 00 000015 						1763
  2260						MOVEI	AC1,103				; AC1,103				
  2261	400371'	201 01 0 00 000103 						1764
  2262	400372'	254 00 0 00 400374'		JRST	L.24				; L.24
  2263					L.23:	MOVEI	AC1,113				; AC1,113				
  2264	400373'	201 01 0 00 000113 						1768
  2265	400374'	202 01 0 00 000111'	L.24:	MOVEM	AC1,U.64			; AC1,GEN%TYPE
  2266						JRST	L.29				; L.29					
  2267	400375'	254 00 0 00 400405'						1698
  2268					L.25:	MOVEI	AC16,15				; INIT%STATE,15				
  2269	400376'	201 16 0 00 000015 						1772
  2270						MOVEI	AC1,120				; AC1,120				
  2271	400377'	201 01 0 00 000120 						1773
  2272	400400'	254 00 0 00 400404'		JRST	L.28				; L.28
  2273					L.26:	MOVEI	AC1,112				; AC1,112				
  2274	400401'	201 01 0 00 000112 						1777
  2275	400402'	254 00 0 00 400404'		JRST	L.28				; L.28
  2276					L.27:	MOVEI	AC1,126				; AC1,126				
  2277	400403'	201 01 0 00 000126 						1780
  2278	400404'	202 01 0 00 000112'	L.28:	MOVEM	AC1,U.65			; AC1,GEN%SUBTYPE
  2279					L.29:	PUSH	SP,AC16				; SP,INIT%STATE				
  2280	400405'	261 17 0 00 000016 						1789
  2281	400406'	260 17 0 00 400416'		PUSHJ	SP,U.1				; SP,DO%TRANSACTION
  2282	400407'	105 17 0 00 777777 		ADJSP	SP,-1				; SP,-1
  2283					L.30:	POP	SP,AC16				; SP,AC16				
  2284	400410'	262 17 0 00 000016 						1638
  2285	400411'	263 17 0 00 000000 		POPJ	SP,				; SP,
  2286	400412'	000000	000232		C.13:	EXP	232				; 232
  2287
  2288					; Routine Size:  89 words
  2289
  2290
  2291					;   1791  1	
  2292					;   1792  1	%SBTTL 'DO%TRANSACTION - Main loop for FSM'
  2293					;   1793  1	ROUTINE DO%TRANSACTION (INIT%STATE) =
  2294					;   1794  1	
  2295					;   1795  1	!++
  2296					;   1796  1	! FUNCTIONAL DESCRIPTION:
  2297					;   1797  1	!
  2298					;   1798  1	!	This is the main routine for performing a Kermit transaction.
  2299					;   1799  1	!	It is structured as a finite state machine with each state
  2300					;   1800  1	!	determining the next based upon the packet which is received.
  2301					;   1801  1	!	It is supplied with the initial state by the caller.
  2302					;   1802  1	!
  2303					;   1803  1	! CALLING SEQUENCE:
  2304					;   1804  1	!
  2305					;   1805  1	!	Status = DO%TRANSACTION(.INIT%STATE);
  2306					;   1806  1	!
  2307					;   1807  1	! INPUT PARAMETERS:
  2308					;   1808  1	!
  2309					;   1809  1	!	INIT%STATE - Initial state.
  2310					;   1810  1	!
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-42
KERMSG	MAC	18-Jan-73 17:20	

  2311					;   1811  1	! IMPLICIT INPUTS:
  2312					;   1812  1	!
  2313					;   1813  1	!	None.
  2314					;   1814  1	!
  2315					;   1815  1	! OUTPUT PARAMETERS:
  2316					;   1816  1	!
  2317					;   1817  1	!	None.
  2318					;   1818  1	!
  2319					;   1819  1	! IMPLICIT OUTPUTS:
  2320					;   1820  1	!
  2321					;   1821  1	!	None.
  2322					;   1822  1	!
  2323					;   1823  1	! COMPLETION CODES:
  2324					;   1824  1	!
  2325					;   1825  1	!	None.
  2326					;   1826  1	!
  2327					;   1827  1	! SIDE EFFECTS:
  2328					;   1828  1	!
  2329					;   1829  1	!	None.
  2330					;   1830  1	!
  2331					;   1831  1	!--
  2332					;   1832  1	
  2333					;   1833  2	    BEGIN
  2334					;   1834  2	
  2335					;   1835  2	    LOCAL
  2336					;   1836  2		RETURN%VALUE;
  2337					;   1837  2	
  2338					;   1838  2	    NUM%RETRIES = 0;				! Initialize the number of r
  2339					etries
  2340					;   1839  2	    STATE = .INIT%STATE;			! Initialize the state
  2341					;   1840  2	
  2342					;   1841  2	    WHILE TRUE DO
  2343					;   1842  2	
  2344					;   1843  2		CASE .STATE FROM STATE%MIN TO STATE%MAX OF
  2345					;   1844  2		    SET
  2346					;   1845  2	!
  2347					;   1846  2	! Send states
  2348					;   1847  2	!
  2349					;   1848  2	
  2350					;   1849  2		    [STATE%ID] :
  2351					;   1850  2	!
  2352					;   1851  2	! Server while idle.  Set the timeout to twice the normal wait
  2353					;   1852  2	! and wait for something to show up
  2354					;   1853  2	!
  2355					;   1854  3			BEGIN
  2356					;   1855  3	
  2357					;   1856  3			LOCAL
  2358					;   1857  3			    SAVED%TIMEOUT;
  2359					;   1858  3	
  2360					;   1859  3			SAVED%TIMEOUT = .SEND%TIMEOUT;
  2361					;   1860  3	
  2362					;   1861  3			IF .SEND%TIMEOUT NEQ 0 THEN SEND%TIMEOUT = .SRV%TIMEOUT;
  2363					;   1862  3	
  2364					;   1863  3			STATE = REC%SERVER%IDLE ();
  2365					;   1864  3			SEND%TIMEOUT = .SAVED%TIMEOUT;
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-43
KERMSG	MAC	18-Jan-73 17:20	

  2366					;   1865  2			END;
  2367					;   1866  2	
  2368					;   1867  2		    [STATE%II] :
  2369					;   1868  2	!
  2370					;   1869  2	! Here while server idle after having received a server-init packet
  2371					;   1870  2	!
  2372					;   1871  2			STATE = REC%SERVER%IDLE ();
  2373					;   1872  2	
  2374					;   1873  2		    [STATE%FI, STATE%LG] :
  2375					;   1874  2	!
  2376					;   1875  2	! Here when we are supposed to exit
  2377					;   1876  2	!
  2378					;   1877  2			RETURN KER%EXIT;
  2379					;   1878  2	
  2380					;   1879  2		    [STATE%SD] :
  2381					;   1880  2			STATE = SEND%DATA ();
  2382					;   1881  2	
  2383					;   1882  2		    [STATE%SF] :
  2384					;   1883  2			STATE = SEND%FILE ();
  2385					;   1884  2	
  2386					;   1885  2		    [STATE%SZ] :
  2387					;   1886  2			STATE = SEND%EOF ();
  2388					;   1887  2	
  2389					;   1888  2		    [STATE%S] :
  2390					;   1889  2			STATE = SEND%INIT ();
  2391					;   1890  2	
  2392					;   1891  2		    [STATE%OF] :
  2393					;   1892  2			STATE = SEND%OPEN%FILE ();
  2394					;   1893  2	
  2395					;   1894  2		    [STATE%SI] :
  2396					;   1895  2			STATE = SEND%SERVER%INIT ();
  2397					;   1896  2	
  2398					;   1897  2		    [STATE%SG] :
  2399					;   1898  2			STATE = SEND%GENCMD ();
  2400					;   1899  2	
  2401					;   1900  2		    [STATE%SB] :
  2402					;   1901  2			STATE = SEND%BREAK ();
  2403					;   1902  2	!
  2404					;   1903  2	! Receiving of the data and the end of file message.
  2405					;   1904  2	!
  2406					;   1905  2	
  2407					;   1906  2		    [STATE%RD] :
  2408					;   1907  2			STATE = REC%DATA ();
  2409					;   1908  2	!
  2410					;   1909  2	! Receiving the FILE information of the break to end the transfer of
  2411					;   1910  2	! one or more files
  2412					;   1911  2	!
  2413					;   1912  2	
  2414					;   1913  2		    [STATE%RF] :
  2415					;   1914  2			STATE = REC%FILE ();
  2416					;   1915  2	!
  2417					;   1916  2	! Initialization for the receiving of a file
  2418					;   1917  2	!
  2419					;   1918  2	
  2420					;   1919  2		    [STATE%R] :
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-44
KERMSG	MAC	18-Jan-73 17:20	

  2421					;   1920  2			STATE = REC%INIT ();
  2422					;   1921  2	!
  2423					;   1922  2	! Here if we have completed the receiving of the file
  2424					;   1923  2	!
  2425					;   1924  2	
  2426					;   1925  2		    [STATE%C] :
  2427					;   1926  3			BEGIN
  2428					;   1927  3			RETURN%VALUE = TRUE;
  2429					;   1928  3			EXITLOOP;
  2430					;   1929  2			END;
  2431					;   1930  2	!
  2432					;   1931  2	! Here if we aborted the transfer or we have gotten into some random
  2433					;   1932  2	! state (internal KERMSG problem).
  2434					;   1933  2	!
  2435					;   1934  2	
  2436					;   1935  2		    [STATE%A, STATE%EX, STATE%ER, INRANGE, OUTRANGE] :
  2437					;   1936  3			BEGIN
  2438					;   1937  3			RETURN%VALUE = FALSE;
  2439					;   1938  3	
  2440					;   1939  3			IF .STATE EQL STATE%EX THEN RETURN%VALUE = KER%ABORTED;
  2441					;   1940  3	
  2442					;   1941  3			!
  2443					;   1942  3			! Determine if the file is still open and if so close it
  2444					;   1943  3			!
  2445					;   1944  3	
  2446					;   1945  3			IF .FILE%OPEN%FLAG
  2447					;   1946  3			THEN
  2448					;   1947  4			    BEGIN
  2449					;   1948  4			    FILE%OPEN%FLAG = FALSE;
  2450					;   1949  4	
  2451					;   1950  4			    IF ( NOT .CONNECT%FLAG) AND .TY%FIL
  2452					;   1951  4			    THEN
  2453					;   1952  5				BEGIN
  2454					;   1953  5				TT%TEXT (UPLIT (%ASCIZ' [Aborted]'));
  2455					;   1954  5				TT%CRLF ();
  2456					;   1955  4				END;
  2457					;   1956  4	
  2458					;   1957  5			    FILE%CLOSE (.ABT%FLAG AND (.STATE EQL STATE%A OR .STATE 
  2459					EQL STATE%EX OR .STATE
  2460					;   1958  4				EQL STATE%ER));
  2461					;   1959  4			    XFR%STATUS (%C'F', %C'A');
  2462					;   1960  3			    END;
  2463					;   1961  3	
  2464					;   1962  3	!
  2465					;   1963  3	! Give error if aborted due to too many retries
  2466					;   1964  3	!
  2467					;   1965  3	
  2468					;   1966  3			IF .STATE EQL STATE%ER THEN KRM%ERROR (KER%RETRIES);
  2469					;   1967  3	
  2470					;   1968  3			EXITLOOP;
  2471					;   1969  2			END;
  2472					;   1970  2		    TES;
  2473					;   1971  2	
  2474					;   1972  2	!
  2475					;   1973  2	! End the stats and return to the caller
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-45
KERMSG	MAC	18-Jan-73 17:20	

  2476					;   1974  2	!
  2477					;   1975  2	    END%STATS ();
  2478					;   1976  2	!
  2479					;   1977  2	    RETURN .RETURN%VALUE;
  2480					;   1978  1	    END;					! End of DO%TRANSACTION
  2481
  2482
  2483	400413'	040 133 101 142 157 0 	P.AAA:	BYTE	(7)" ","[","A","b","o"		;  [Abo
  2484	400414'	162 164 145 144 135 0 		BYTE	(7)"r","t","e","d","]"		; rted]
  2485	400415'	000 000 000 000 000 0 		BYTE	(7)000,000,000,000,000
  2486
  2487
  2488					; DO%TRANSACTION
  2489					U.1:	PUSH	SP,AC14				; SP,AC14				
  2490	400416'	261 17 0 00 000014 						1793
  2491	400417'	261 17 0 00 000016 		PUSH	SP,AC16				; SP,AC16
  2492						SETZM	U.52				; NUM%RETRIES				
  2493	400420'	402 00 0 00 000017'						1838
  2494						MOVE	AC1,-3(SP)			; AC1,INIT%STATE			
  2495	400421'	200 01 0 17 777775 						1839
  2496	400422'	202 01 0 00 000014'	L.31:	MOVEM	AC1,U.49			; AC1,STATE
  2497					L.32:	MOVE	AC1,U.49			; AC1,STATE				
  2498	400423'	200 01 0 00 000014'						1843
  2499	400424'	200 02 0 00 000001 		MOVE	AC2,AC1				; AC2,AC1
  2500	400425'	361 02 0 00 400455'		SOJL	AC2,L.34			; AC2,L.34
  2501	400426'	305 02 0 00 000024 		CAIGE	AC2,24				; AC2,24
  2502	400427'	254 00 0 02 400431'		JRST	L.33(AC2)			; L.33(AC2)
  2503	400430'	254 00 0 00 400455'		JRST	L.34				; L.34
  2504	400431'	254 00 0 00 400554'	L.33:	JRST	L.44				; L.44
  2505	400432'	254 00 0 00 400550'		JRST	L.42				; L.42
  2506	400433'	254 00 0 00 400546'		JRST	L.41				; L.41
  2507	400434'	254 00 0 00 400552'		JRST	L.43				; L.43
  2508	400435'	254 00 0 00 400564'		JRST	L.48				; L.48
  2509	400436'	254 00 0 00 400572'		JRST	L.51				; L.51
  2510	400437'	254 00 0 00 400570'		JRST	L.50				; L.50
  2511	400440'	254 00 0 00 400566'		JRST	L.49				; L.49
  2512	400441'	254 00 0 00 400574'		JRST	L.52				; L.52
  2513	400442'	254 00 0 00 400455'		JRST	L.34				; L.34
  2514	400443'	254 00 0 00 400455'		JRST	L.34				; L.34
  2515	400444'	254 00 0 00 400562'		JRST	L.47				; L.47
  2516	400445'	254 00 0 00 400560'		JRST	L.46				; L.46
  2517	400446'	254 00 0 00 400531'		JRST	L.37				; L.37
  2518	400447'	254 00 0 00 400542'		JRST	L.39				; L.39
  2519	400450'	254 00 0 00 400544'		JRST	L.40				; L.40
  2520	400451'	254 00 0 00 400544'		JRST	L.40				; L.40
  2521	400452'	254 00 0 00 400556'		JRST	L.45				; L.45
  2522	400453'	254 00 0 00 400455'		JRST	L.34				; L.34
  2523	400454'	254 00 0 00 400455'		JRST	L.34				; L.34
  2524					L.34:	SETZ	AC14,				; RETURN%VALUE,				
  2525	400455'	400 14 0 00 000000 						1937
  2526						CAIN	AC1,23				; AC1,23				
  2527	400456'	306 01 0 00 000023 						1939
  2528	400457'	201 14 0 00 000312 		MOVEI	AC14,312			; RETURN%VALUE,312
  2529						MOVEI	AC1,1				; AC1,1					
  2530	400460'	201 01 0 00 000001 						1945
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-46
KERMSG	MAC	18-Jan-73 17:20	

  2531	400461'	616 01 0 00 000104'		TDNN	AC1,U.59			; AC1,FILE%OPEN%FLAG
  2532	400462'	254 00 0 00 400522'		JRST	L.36				; L.36
  2533						SETZM	U.59				; FILE%OPEN%FLAG			
  2534	400463'	402 00 0 00 000104'						1948
  2535						MOVEI	AC1,1				; AC1,1					
  2536	400464'	201 01 0 00 000001 						1950
  2537	400465'	612 01 0 00 400174*		TDNE	AC1,CONNECT%FLAG		; AC1,CONNECT%FLAG
  2538	400466'	254 00 0 00 400476'		JRST	L.35				; L.35
  2539	400467'	201 01 0 00 000001 		MOVEI	AC1,1				; AC1,1
  2540	400470'	616 01 0 00 400066*		TDNN	AC1,TY%FIL			; AC1,TY%FIL
  2541	400471'	254 00 0 00 400476'		JRST	L.35				; L.35
  2542						PUSH	SP,C.14				; SP,[0,,P.AAA]				
  2543	400472'	261 17 0 00 400602'						1953
  2544	400473'	260 17 0 00 000000*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
  2545	400474'	105 17 0 00 777777 		ADJSP	SP,-1				; SP,-1
  2546						PUSHJ	SP,TT%CRLF			; SP,TT%CRLF				
  2547	400475'	260 17 0 00 000000*						1954
  2548					L.35:	MOVE	AC3,U.49			; AC3,STATE				
  2549	400476'	200 03 0 00 000014'						1957
  2550	400477'	400 01 0 00 000000 		SETZ	AC1,				; AC1,
  2551	400500'	306 03 0 00 000012 		CAIN	AC3,12				; AC3,12
  2552	400501'	201 01 0 00 000001 		MOVEI	AC1,1				; AC1,1
  2553	400502'	400 02 0 00 000000 		SETZ	AC2,				; AC2,
  2554	400503'	306 03 0 00 000023 		CAIN	AC3,23				; AC3,23
  2555	400504'	201 02 0 00 000001 		MOVEI	AC2,1				; AC2,1
  2556	400505'	434 02 0 00 000001 		IOR	AC2,AC1				; AC2,AC1
  2557						SETZ	AC1,				; AC1,					
  2558	400506'	400 01 0 00 000000 						1958
  2559	400507'	306 03 0 00 000024 		CAIN	AC3,24				; AC3,24
  2560	400510'	201 01 0 00 000001 		MOVEI	AC1,1				; AC1,1
  2561						IOR	AC1,AC2				; AC1,AC2				
  2562	400511'	434 01 0 00 000002 						1957
  2563	400512'	404 01 0 00 400060*		AND	AC1,ABT%FLAG			; AC1,ABT%FLAG
  2564	400513'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
  2565	400514'	260 17 0 00 000000*		PUSHJ	SP,FILE%CLOSE			; SP,FILE%CLOSE
  2566	400515'	105 17 0 00 777777 		ADJSP	SP,-1				; SP,-1
  2567						PUSH	SP,C.15				; SP,[106]				
  2568	400516'	261 17 0 00 400603'						1959
  2569	400517'	261 17 0 00 400604'		PUSH	SP,C.16				; SP,[101]
  2570	400520'	260 17 0 00 400251*		PUSHJ	SP,XFR%STATUS			; SP,XFR%STATUS
  2571	400521'	105 17 0 00 777776 		ADJSP	SP,-2				; SP,-2
  2572					L.36:	MOVEI	AC1,24				; AC1,24				
  2573	400522'	201 01 0 00 000024 						1966
  2574	400523'	312 01 0 00 000014'		CAME	AC1,U.49			; AC1,STATE
  2575	400524'	254 00 0 00 400575'		JRST	L.53				; L.53
  2576	400525'	261 17 0 00 400605'		PUSH	SP,C.17				; SP,[212]
  2577	400526'	260 17 0 00 400322*		PUSHJ	SP,KRM%ERROR			; SP,KRM%ERROR
  2578	400527'	105 17 0 00 777777 		ADJSP	SP,-1				; SP,-1
  2579	400530'	254 00 0 00 400575'		JRST	L.53				; L.53
  2580					L.37:	MOVE	AC1,SEND%TIMEOUT		; AC1,SEND%TIMEOUT			
  2581	400531'	200 01 0 00 000000*						1859
  2582	400532'	200 16 0 00 000001 		MOVE	AC16,AC1			; SAVED%TIMEOUT,AC1
  2583						JUMPE	AC1,L.38			; AC1,L.38				
  2584	400533'	322 01 0 00 400536'						1861
  2585	400534'	200 01 0 00 400035*		MOVE	AC1,SRV%TIMEOUT			; AC1,SRV%TIMEOUT
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-47
KERMSG	MAC	18-Jan-73 17:20	

  2586	400535'	202 01 0 00 400531*		MOVEM	AC1,SEND%TIMEOUT		; AC1,SEND%TIMEOUT
  2587					L.38:	PUSHJ	SP,U.10				; SP,REC%SERVER%IDLE			
  2588	400536'	260 17 0 00 400606'						1863
  2589	400537'	202 01 0 00 000014'		MOVEM	AC1,U.49			; AC1,STATE
  2590						MOVEM	AC16,SEND%TIMEOUT		; SAVED%TIMEOUT,SEND%TIMEOUT		
  2591	400540'	202 16 0 00 400535*						1864
  2592						JRST	L.32				; L.32					
  2593	400541'	254 00 0 00 400423'						1843
  2594					L.39:	PUSHJ	SP,U.10				; SP,REC%SERVER%IDLE			
  2595	400542'	260 17 0 00 400606'						1871
  2596	400543'	254 00 0 00 400422'		JRST	L.31				; L.31
  2597					L.40:	MOVEI	AC1,223				; AC1,223				
  2598	400544'	201 01 0 00 000223 						1877
  2599	400545'	254 00 0 00 400577'		JRST	L.54				; L.54
  2600					L.41:	PUSHJ	SP,U.3				; SP,SEND%DATA				
  2601	400546'	260 17 0 00 401137'						1880
  2602	400547'	254 00 0 00 400422'		JRST	L.31				; L.31
  2603					L.42:	PUSHJ	SP,U.4				; SP,SEND%FILE				
  2604	400550'	260 17 0 00 401345'						1883
  2605	400551'	254 00 0 00 400422'		JRST	L.31				; L.31
  2606					L.43:	PUSHJ	SP,U.7				; SP,SEND%EOF				
  2607	400552'	260 17 0 00 401476'						1886
  2608	400553'	254 00 0 00 400422'		JRST	L.31				; L.31
  2609					L.44:	PUSHJ	SP,U.8				; SP,SEND%INIT				
  2610	400554'	260 17 0 00 401664'						1889
  2611	400555'	254 00 0 00 400422'		JRST	L.31				; L.31
  2612					L.45:	PUSHJ	SP,U.5				; SP,SEND%OPEN%FILE			
  2613	400556'	260 17 0 00 401747'						1892
  2614	400557'	254 00 0 00 400422'		JRST	L.31				; L.31
  2615					L.46:	PUSHJ	SP,U.2				; SP,SEND%SERVER%INIT			
  2616	400560'	260 17 0 00 401026'						1895
  2617	400561'	254 00 0 00 400422'		JRST	L.31				; L.31
  2618					L.47:	PUSHJ	SP,U.6				; SP,SEND%GENCMD			
  2619	400562'	260 17 0 00 402063'						1898
  2620	400563'	254 00 0 00 400422'		JRST	L.31				; L.31
  2621					L.48:	PUSHJ	SP,U.9				; SP,SEND%BREAK				
  2622	400564'	260 17 0 00 402351'						1901
  2623	400565'	254 00 0 00 400422'		JRST	L.31				; L.31
  2624					L.49:	PUSHJ	SP,U.13				; SP,REC%DATA				
  2625	400566'	260 17 0 00 403061'						1907
  2626	400567'	254 00 0 00 400422'		JRST	L.31				; L.31
  2627					L.50:	PUSHJ	SP,U.12				; SP,REC%FILE				
  2628	400570'	260 17 0 00 402533'						1914
  2629	400571'	254 00 0 00 400422'		JRST	L.31				; L.31
  2630					L.51:	PUSHJ	SP,U.11				; SP,REC%INIT				
  2631	400572'	260 17 0 00 402444'						1920
  2632	400573'	254 00 0 00 400422'		JRST	L.31				; L.31
  2633					L.52:	MOVEI	AC14,1				; RETURN%VALUE,1			
  2634	400574'	201 14 0 00 000001 						1927
  2635					L.53:	PUSHJ	SP,U.18				; SP,END%STATS				
  2636	400575'	260 17 0 00 406362'						1975
  2637						MOVE	AC1,AC14			; AC1,RETURN%VALUE			
  2638	400576'	200 01 0 00 000014 						1833
  2639					L.54:	POP	SP,AC16				; SP,AC16				
  2640	400577'	262 17 0 00 000016 						1793
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-48
KERMSG	MAC	18-Jan-73 17:20	

  2641	400600'	262 17 0 00 000014 		POP	SP,AC14				; SP,AC14
  2642	400601'	263 17 0 00 000000 		POPJ	SP,				; SP,
  2643	400602'	000000	400413'		C.14:	XWD	0,P.AAA				; 0,P.AAA
  2644	400603'	000000	000106		C.15:	EXP	106				; 106
  2645	400604'	000000	000101		C.16:	EXP	101				; 101
  2646	400605'	000000	000212		C.17:	EXP	212				; 212
  2647
  2648					; Routine Size:  120 words
  2649
  2650
  2651					;   1979  1	%SBTTL 'REC%SERVER%IDLE - Idle server state'
  2652					;   1980  1	ROUTINE REC%SERVER%IDLE =
  2653					;   1981  1	
  2654					;   1982  1	!++
  2655					;   1983  1	! FUNCTIONAL DESCRIPTION:
  2656					;   1984  1	!
  2657					;   1985  1	! This routine is called from DO%TRANSACTION when is the server idle
  2658					;   1986  1	! state.  It will receive a message and properly dispatch to the new
  2659					;   1987  1	! state.
  2660					;   1988  1	!
  2661					;   1989  1	! CALLING SEQUENCE:
  2662					;   1990  1	!
  2663					;   1991  1	!	STATE = REC%SERVER%IDLE ();
  2664					;   1992  1	!
  2665					;   1993  1	! INPUT PARAMETERS:
  2666					;   1994  1	!
  2667					;   1995  1	!	None.
  2668					;   1996  1	!
  2669					;   1997  1	! IMPLICIT INPUTS:
  2670					;   1998  1	!
  2671					;   1999  1	!	Almost everything.
  2672					;   2000  1	!
  2673					;   2001  1	! OUPTUT PARAMETERS:
  2674					;   2002  1	!
  2675					;   2003  1	!	Routine value is new state for FSM
  2676					;   2004  1	!
  2677					;   2005  1	! IMPLICIT OUTPUTS:
  2678					;   2006  1	!
  2679					;   2007  1	!	None.
  2680					;   2008  1	!
  2681					;   2009  1	! COMPLETION CODES:
  2682					;   2010  1	!
  2683					;   2011  1	!	None.
  2684					;   2012  1	!
  2685					;   2013  1	! SIDE EFFECTS:
  2686					;   2014  1	!
  2687					;   2015  1	!	None.
  2688					;   2016  1	!
  2689					;   2017  1	!--
  2690					;   2018  1	
  2691					;   2019  2	    BEGIN
  2692					;   2020  2	
  2693					;   2021  2	    LOCAL
  2694					;   2022  2		STATUS;
  2695					;   2023  2	
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-49
KERMSG	MAC	18-Jan-73 17:20	

  2696					;   2024  2	    STATUS = REC%PACKET ();
  2697					;   2025  2	!
  2698					;   2026  2	! Now determine what to do by the type of message we have receive.
  2699					;   2027  2	!
  2700					;   2028  2	
  2701					;   2029  2	    IF .STATUS EQL KER%ABORTED THEN RETURN STATE%EX;
  2702					;   2030  2	
  2703					;   2031  2	    IF .STATUS
  2704					;   2032  2	    THEN
  2705					;   2033  3		BEGIN
  2706					;   2034  3	
  2707					;   2035  3		SELECTONE .REC%TYPE OF
  2708					;   2036  3		    SET
  2709					;   2037  3		    !
  2710					;   2038  3		    ! Server initialization message received. ACK the
  2711					;   2039  3		    ! message and continue.
  2712					;   2040  3		    !
  2713					;   2041  3	
  2714					;   2042  3		    [MSG%SER%INIT] :
  2715					;   2043  4			BEGIN
  2716					;   2044  4	
  2717					;   2045  5			IF (STATUS = PRS%SEND%INIT ())
  2718					;   2046  4			THEN
  2719					;   2047  5			    BEGIN
  2720					;   2048  5			    SET%SEND%INIT ();
  2721					;   2049  5	
  2722					;   2050  6			    IF (STATUS = SEND%PACKET (MSG%ACK, P%SI%LENGTH, .REC%SEQ
  2723					))
  2724					;   2051  5			    THEN
  2725					;   2052  6				BEGIN
  2726					;   2053  6				SND%PKT%SIZE = -.SEND%PKT%SIZE;
  2727					;   2054  6				SND%TIMEOUT = -.SEND%TIMEOUT;
  2728					;   2055  6				SND%NPAD = -.SEND%NPAD;
  2729					;   2056  6				SND%PADCHAR = -.SEND%PADCHAR;
  2730					;   2057  6				SND%EOL = -.SEND%EOL;
  2731					;   2058  6				SND%QUOTE%CHR = -.SEND%QUOTE%CHR;
  2732					;   2059  6				RCV%8QUOTE%CHR = .SEND%8QUOTE%CHR;
  2733					;   2060  6				CHKTYPE = .INI%CHK%TYPE;
  2734					;   2061  6				SET%REPT%CHR = .REPT%CHR;
  2735					;   2062  6				RETURN STATE%II;	! Now idle after INIT
  2736					;   2063  5				END;
  2737					;   2064  5	
  2738					;   2065  4			    END;
  2739					;   2066  4	
  2740					;   2067  4			KRM%ERROR (KER%PROTOERR);
  2741					;   2068  4			RETURN STATE%A;
  2742					;   2069  3			END;
  2743					;   2070  3		    !
  2744					;   2071  3		    ! Send init message received.  We must ACK the message and
  2745					;   2072  3		    ! then attempt to receive a file from the remote.
  2746					;   2073  3		    !
  2747					;   2074  3	
  2748					;   2075  3		    [MSG%SND%INIT] :
  2749					;   2076  4			BEGIN
  2750					;   2077  4			MSG%NUMBER = (.REC%SEQ + 1) AND %O'77';
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-50
KERMSG	MAC	18-Jan-73 17:20	

  2751					;   2078  4	
  2752					;   2079  5			IF (STATUS = PRS%SEND%INIT ())
  2753					;   2080  4			THEN
  2754					;   2081  5			    BEGIN
  2755					;   2082  5			    SET%SEND%INIT ();
  2756					;   2083  5			    !
  2757					;   2084  5			    ! ACK the message then receive everything.
  2758					;   2085  5			    !
  2759					;   2086  5	
  2760					;   2087  5			    IF SEND%PACKET (MSG%ACK, P%SI%LENGTH, .REC%SEQ)
  2761					;   2088  5			    THEN
  2762					;   2089  6				BEGIN
  2763					;   2090  6				BLK%CHK%TYPE = .INI%CHK%TYPE;	! Switch to desired 
  2764					form of block check
  2765					;   2091  6				XFR%STATUS (%C'I', %C'R');	! Start of file rece
  2766					ive
  2767					;   2092  6				RETURN STATE%RF;
  2768					;   2093  5				END;
  2769					;   2094  5	
  2770					;   2095  4			    END;
  2771					;   2096  4	
  2772					;   2097  4			KRM%ERROR (KER%PROTOERR);
  2773					;   2098  4			RETURN STATE%A;
  2774					;   2099  3			END;
  2775					;   2100  3		    !
  2776					;   2101  3		    ! Here if we receive a receive init message.
  2777					;   2102  3		    ! We will be sending a file to the other end.
  2778					;   2103  3		    !
  2779					;   2104  3	
  2780					;   2105  3		    [MSG%RCV%INIT] :
  2781					;   2106  4			BEGIN
  2782					;   2107  4			!
  2783					;   2108  4			! Move the file specification if we received one
  2784					;   2109  4			!
  2785					;   2110  4			SET%STRING (CH$PTR (FILE%NAME), MAX%FILE%NAME, TRUE);
  2786					;   2111  4			BFR%EMPTY ();
  2787					;   2112  4			FILE%SIZE = SET%STRING (0, 0, FALSE);
  2788					;   2113  4			CH$WCHAR (CHR%NUL, CH$PTR (FILE%NAME, .FILE%SIZE));
  2789					;   2114  4	
  2790					;   2115  4			IF .FILE%SIZE GTR 0
  2791					;   2116  4			THEN
  2792					;   2117  5			    BEGIN
  2793					;   2118  5			    XFR%STATUS (%C'I', %C'S');	! Start of a file send
  2794					;   2119  5			    RETURN STATE%S;
  2795					;   2120  4			    END;
  2796					;   2121  4	
  2797					;   2122  4			KRM%ERROR (KER%PROTOERR);
  2798					;   2123  4			RETURN STATE%A;
  2799					;   2124  3			END;
  2800					;   2125  3	!
  2801					;   2126  3	! Generic KERMIT commands
  2802					;   2127  3	!
  2803					;   2128  3	
  2804					;   2129  3		    [MSG%GENERIC] :
  2805					;   2130  3			RETURN SERVER%GENERIC ();
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-51
KERMSG	MAC	18-Jan-73 17:20	

  2806					;   2131  3	!
  2807					;   2132  3	! Host command
  2808					;   2133  3	!
  2809					;   2134  3	
  2810					;   2135  3		    [MSG%COMMAND] :
  2811					;   2136  3			RETURN HOST%COMMAND ();
  2812					;   2137  3	!
  2813					;   2138  3	! Kermit command
  2814					;   2139  3	!
  2815					;   2140  3	
  2816					;   2141  3		    [MSG%KERMIT] :
  2817					;   2142  3			RETURN KERMIT%COMMAND ();
  2818					;   2143  3	!
  2819					;   2144  3	! Unimplimented server routines
  2820					;   2145  3	!
  2821					;   2146  3	
  2822					;   2147  3		    [OTHERWISE] :
  2823					;   2148  4			BEGIN
  2824					;   2149  4			KRM%ERROR (KER%UNISRV);
  2825					;   2150  4			RETURN STATE%A;
  2826					;   2151  3			END;
  2827					;   2152  3		    TES;
  2828					;   2153  3	
  2829					;   2154  2		END;
  2830					;   2155  2	
  2831					;   2156  2	!
  2832					;   2157  2	! If we get here, we must have gotten something random.  Therefore,
  2833					;   2158  2	! just send a NAK and remain in the current state (unless we have done this
  2834					;   2159  2	! too many times).
  2835					;   2160  2	!
  2836					;   2161  2	    NUM%RETRIES = .NUM%RETRIES + 1;
  2837					;   2162  2	
  2838					;   2163  2	    IF .NUM%RETRIES GTR .SI%RETRIES THEN RETURN STATE%A;
  2839					;   2164  2	
  2840					;   2165  2	    IF SEND%PACKET (MSG%NAK, 0, 0) THEN RETURN .STATE ELSE RETURN STATE%EX;
  2841					;   2166  2	
  2842					;   2167  1	    END;					! End of REC%SERVER%IDLE
  2843
  2844
  2845					; REC%SERVER%IDLE
  2846					U.10:	PUSH	SP,AC14				; SP,AC14				
  2847	400606'	261 17 0 00 000014 						1980
  2848	400607'	261 17 0 00 000016 		PUSH	SP,AC16				; SP,AC16
  2849						PUSHJ	SP,U.26				; SP,REC%PACKET				
  2850	400610'	260 17 0 00 404716'						2024
  2851	400611'	200 14 0 00 000001 		MOVE	AC14,AC1			; STATUS,AC1
  2852						CAIN	AC14,312			; STATUS,312				
  2853	400612'	306 14 0 00 000312 						2029
  2854	400613'	254 00 0 00 401007'		JRST	L.67				; L.67
  2855						TRNN	AC14,1				; STATUS,1				
  2856	400614'	606 14 0 00 000001 						2031
  2857	400615'	254 00 0 00 400773'		JRST	L.64				; L.64
  2858						MOVE	AC16,U.56			; AC16,REC%TYPE				
  2859	400616'	200 16 0 00 000023'						2035
  2860						CAIE	AC16,111			; AC16,111				
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-52
KERMSG	MAC	18-Jan-73 17:20	

  2861	400617'	302 16 0 00 000111 						2042
  2862	400620'	254 00 0 00 400662'		JRST	L.55				; L.55
  2863						PUSHJ	SP,U.21				; SP,PRS%SEND%INIT			
  2864	400621'	260 17 0 00 404103'						2045
  2865	400622'	200 14 0 00 000001 		MOVE	AC14,AC1			; STATUS,AC1
  2866	400623'	606 14 0 00 000001 		TRNN	AC14,1				; STATUS,1
  2867	400624'	254 00 0 00 400714'		JRST	L.56				; L.56
  2868						PUSHJ	SP,U.20				; SP,SET%SEND%INIT			
  2869	400625'	260 17 0 00 404355'						2048
  2870						PUSH	SP,C.20				; SP,[131]				
  2871	400626'	261 17 0 00 401015'						2050
  2872	400627'	261 17 0 00 401016'		PUSH	SP,C.21				; SP,[11]
  2873	400630'	261 17 0 00 000021'		PUSH	SP,U.54				; SP,REC%SEQ
  2874	400631'	260 17 0 00 404426'		PUSHJ	SP,U.24				; SP,SEND%PACKET
  2875	400632'	200 14 0 00 000001 		MOVE	AC14,AC1			; STATUS,AC1
  2876	400633'	105 17 0 00 777775 		ADJSP	SP,-3				; SP,-3
  2877	400634'	606 14 0 00 000001 		TRNN	AC14,1				; STATUS,1
  2878	400635'	254 00 0 00 400714'		JRST	L.56				; L.56
  2879						MOVE	AC1,U.39			; AC1,SEND%PKT%SIZE			
  2880	400636'	200 01 0 00 000002'						2053
  2881	400637'	212 01 0 00 400021*		MOVNM	AC1,SND%PKT%SIZE		; AC1,SND%PKT%SIZE
  2882						MOVE	AC1,SEND%TIMEOUT		; AC1,SEND%TIMEOUT			
  2883	400640'	200 01 0 00 400540*						2054
  2884	400641'	212 01 0 00 400025*		MOVNM	AC1,SND%TIMEOUT			; AC1,SND%TIMEOUT
  2885						MOVE	AC1,U.40			; AC1,SEND%NPAD				
  2886	400642'	200 01 0 00 000003'						2055
  2887	400643'	212 01 0 00 400022*		MOVNM	AC1,SND%NPAD			; AC1,SND%NPAD
  2888						MOVE	AC1,U.41			; AC1,SEND%PADCHAR			
  2889	400644'	200 01 0 00 000004'						2056
  2890	400645'	212 01 0 00 400023*		MOVNM	AC1,SND%PADCHAR			; AC1,SND%PADCHAR
  2891						MOVE	AC1,U.42			; AC1,SEND%EOL				
  2892	400646'	200 01 0 00 000005'						2057
  2893	400647'	212 01 0 00 400027*		MOVNM	AC1,SND%EOL			; AC1,SND%EOL
  2894						MOVE	AC1,U.43			; AC1,SEND%QUOTE%CHR			
  2895	400650'	200 01 0 00 000006'						2058
  2896	400651'	212 01 0 00 400031*		MOVNM	AC1,SND%QUOTE%CHR		; AC1,SND%QUOTE%CHR
  2897						MOVE	AC1,U.44			; AC1,SEND%8QUOTE%CHR			
  2898	400652'	200 01 0 00 000007'						2059
  2899	400653'	202 01 0 00 400015*		MOVEM	AC1,RCV%8QUOTE%CHR		; AC1,RCV%8QUOTE%CHR
  2900						MOVE	AC1,U.45			; AC1,INI%CHK%TYPE			
  2901	400654'	200 01 0 00 000010'						2060
  2902	400655'	202 01 0 00 400053*		MOVEM	AC1,CHKTYPE			; AC1,CHKTYPE
  2903						MOVE	AC1,U.38			; AC1,REPT%CHR				
  2904	400656'	200 01 0 00 000001'						2061
  2905	400657'	202 01 0 00 400017*		MOVEM	AC1,SET%REPT%CHR		; AC1,SET%REPT%CHR
  2906						MOVEI	AC1,17				; AC1,17				
  2907	400660'	201 01 0 00 000017 						2052
  2908	400661'	254 00 0 00 401010'		JRST	L.68				; L.68
  2909					L.55:	CAIE	AC16,123			; AC16,123				
  2910	400662'	302 16 0 00 000123 						2075
  2911	400663'	254 00 0 00 400716'		JRST	L.57				; L.57
  2912						MOVE	AC1,U.54			; AC1,REC%SEQ				
  2913	400664'	200 01 0 00 000021'						2077
  2914	400665'	271 01 0 00 000001 		ADDI	AC1,1				; AC1,1
  2915	400666'	135 02 0 00 401013'		LDB	AC2,C.18			; AC2,[POINT 6,AC1,35]  <0,6>
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-53
KERMSG	MAC	18-Jan-73 17:20	

  2916	400667'	202 02 0 00 000020'		MOVEM	AC2,U.53			; AC2,MSG%NUMBER
  2917						PUSHJ	SP,U.21				; SP,PRS%SEND%INIT			
  2918	400670'	260 17 0 00 404103'						2079
  2919	400671'	200 14 0 00 000001 		MOVE	AC14,AC1			; STATUS,AC1
  2920	400672'	606 14 0 00 000001 		TRNN	AC14,1				; STATUS,1
  2921	400673'	254 00 0 00 400714'		JRST	L.56				; L.56
  2922						PUSHJ	SP,U.20				; SP,SET%SEND%INIT			
  2923	400674'	260 17 0 00 404355'						2082
  2924						PUSH	SP,C.20				; SP,[131]				
  2925	400675'	261 17 0 00 401015'						2087
  2926	400676'	261 17 0 00 401016'		PUSH	SP,C.21				; SP,[11]
  2927	400677'	261 17 0 00 000021'		PUSH	SP,U.54				; SP,REC%SEQ
  2928	400700'	260 17 0 00 404426'		PUSHJ	SP,U.24				; SP,SEND%PACKET
  2929	400701'	105 17 0 00 777775 		ADJSP	SP,-3				; SP,-3
  2930	400702'	606 01 0 00 000001 		TRNN	AC1,1				; AC1,1
  2931	400703'	254 00 0 00 400714'		JRST	L.56				; L.56
  2932						MOVE	AC1,U.45			; AC1,INI%CHK%TYPE			
  2933	400704'	200 01 0 00 000010'						2090
  2934	400705'	202 01 0 00 000011'		MOVEM	AC1,U.46			; AC1,BLK%CHK%TYPE
  2935						PUSH	SP,C.6				; SP,[111]				
  2936	400706'	261 17 0 00 400170'						2091
  2937	400707'	261 17 0 00 400261'		PUSH	SP,C.12				; SP,[122]
  2938	400710'	260 17 0 00 400520*		PUSHJ	SP,XFR%STATUS			; SP,XFR%STATUS
  2939						ADJSP	SP,-2				; SP,-2					
  2940	400711'	105 17 0 00 777776 						2092
  2941						MOVEI	AC1,7				; AC1,7					
  2942	400712'	201 01 0 00 000007 						2089
  2943	400713'	254 00 0 00 401010'		JRST	L.68				; L.68
  2944					L.56:	PUSH	SP,C.22				; SP,[252]				
  2945	400714'	261 17 0 00 401017'						2097
  2946	400715'	254 00 0 00 400770'		JRST	L.63				; L.63
  2947					L.57:	CAIE	AC16,122			; AC16,122				
  2948	400716'	302 16 0 00 000122 						2105
  2949	400717'	254 00 0 00 400753'		JRST	L.59				; L.59
  2950						PUSH	SP,C.10				; SP,[POINT 7,FILE%NAME-1,34]  <1,7>	
  2951	400720'	261 17 0 00 400257'						2110
  2952	400721'	261 17 0 00 401020'		PUSH	SP,C.23				; SP,[204]
  2953	400722'	261 17 0 00 400144'		PUSH	SP,C.2				; SP,[1]
  2954	400723'	260 17 0 00 406157'		PUSHJ	SP,U.30				; SP,SET%STRING
  2955						PUSHJ	SP,U.28				; SP,BFR%EMPTY				
  2956	400724'	260 17 0 00 406030'						2111
  2957						SETZM	-2(SP)				; -2(SP)				
  2958	400725'	402 00 0 17 777776 						2112
  2959	400726'	402 00 0 17 777777 		SETZM	-1(SP)				; -1(SP)
  2960	400727'	402 00 0 17 000000 		SETZM	0(SP)				; 0(SP)
  2961	400730'	260 17 0 00 406157'		PUSHJ	SP,U.30				; SP,SET%STRING
  2962	400731'	202 01 0 00 400225*		MOVEM	AC1,FILE%SIZE			; AC1,FILE%SIZE
  2963						SETZ	AC3,				; AC3,					
  2964	400732'	400 03 0 00 000000 						2113
  2965	400733'	200 02 0 00 400731*		MOVE	AC2,FILE%SIZE			; AC2,FILE%SIZE
  2966	400734'	200 04 0 00 401014'		MOVE	AC4,C.19			; AC4,[POINT 7,FILE%NAME,-1]  <36,7>
  2967	400735'	200 01 0 00 000002 		MOVE	AC1,AC2				; AC1,AC2
  2968	400736'	133 01 0 00 000004 		ADJBP	AC1,AC4				; AC1,AC4
  2969	400737'	136 03 0 00 000001 		IDPB	AC3,AC1				; AC3,AC1
  2970						JUMPLE	AC2,L.58			; AC2,L.58				
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-54
KERMSG	MAC	18-Jan-73 17:20	

  2971	400740'	323 02 0 00 400747'						2115
  2972						PUSH	SP,C.6				; SP,[111]				
  2973	400741'	261 17 0 00 400170'						2118
  2974	400742'	261 17 0 00 400220'		PUSH	SP,C.8				; SP,[123]
  2975	400743'	260 17 0 00 400710*		PUSHJ	SP,XFR%STATUS			; SP,XFR%STATUS
  2976						ADJSP	SP,-5				; SP,-5					
  2977	400744'	105 17 0 00 777773 						2119
  2978						MOVEI	AC1,1				; AC1,1					
  2979	400745'	201 01 0 00 000001 						2117
  2980	400746'	254 00 0 00 401010'		JRST	L.68				; L.68
  2981					L.58:	PUSH	SP,C.22				; SP,[252]				
  2982	400747'	261 17 0 00 401017'						2122
  2983	400750'	260 17 0 00 400526*		PUSHJ	SP,KRM%ERROR			; SP,KRM%ERROR
  2984						ADJSP	SP,-4				; SP,-4					
  2985	400751'	105 17 0 00 777774 						2106
  2986	400752'	254 00 0 00 400776'		JRST	L.65				; L.65
  2987					L.59:	CAIE	AC16,107			; AC16,107				
  2988	400753'	302 16 0 00 000107 						2129
  2989	400754'	254 00 0 00 400757'		JRST	L.60				; L.60
  2990						PUSHJ	SP,U.14				; SP,SERVER%GENERIC			
  2991	400755'	260 17 0 00 403374'						2130
  2992						JRST	L.68				; L.68					
  2993	400756'	254 00 0 00 401010'						2035
  2994					L.60:	CAIE	AC16,103			; AC16,103				
  2995	400757'	302 16 0 00 000103 						2135
  2996	400760'	254 00 0 00 400763'		JRST	L.61				; L.61
  2997						PUSHJ	SP,U.15				; SP,HOST%COMMAND			
  2998	400761'	260 17 0 00 403673'						2136
  2999						JRST	L.68				; L.68					
  3000	400762'	254 00 0 00 401010'						2035
  3001					L.61:	CAIE	AC16,113			; AC16,113				
  3002	400763'	302 16 0 00 000113 						2141
  3003	400764'	254 00 0 00 400767'		JRST	L.62				; L.62
  3004						PUSHJ	SP,U.16				; SP,KERMIT%COMMAND			
  3005	400765'	260 17 0 00 403724'						2142
  3006						JRST	L.68				; L.68					
  3007	400766'	254 00 0 00 401010'						2035
  3008					L.62:	PUSH	SP,C.24				; SP,[242]				
  3009	400767'	261 17 0 00 401021'						2149
  3010	400770'	260 17 0 00 400750*	L.63:	PUSHJ	SP,KRM%ERROR			; SP,KRM%ERROR
  3011						ADJSP	SP,-1				; SP,-1					
  3012	400771'	105 17 0 00 777777 						2148
  3013	400772'	254 00 0 00 400776'		JRST	L.65				; L.65
  3014					L.64:	AOS	AC1,U.52			; AC1,NUM%RETRIES			
  3015	400773'	350 01 0 00 000017'						2163
  3016	400774'	317 01 0 00 400041*		CAMG	AC1,SI%RETRIES			; AC1,SI%RETRIES
  3017	400775'	254 00 0 00 401000'		JRST	L.66				; L.66
  3018	400776'	201 01 0 00 000012 	L.65:	MOVEI	AC1,12				; AC1,12
  3019	400777'	254 00 0 00 401010'		JRST	L.68				; L.68
  3020					L.66:	PUSH	SP,C.25				; SP,[116]				
  3021	401000'	261 17 0 00 401022'						2165
  3022	401001'	261 17 0 00 401023'		PUSH	SP,C.26				; SP,[0]
  3023	401002'	261 17 0 00 401023'		PUSH	SP,C.26				; SP,[0]
  3024	401003'	260 17 0 00 404426'		PUSHJ	SP,U.24				; SP,SEND%PACKET
  3025	401004'	105 17 0 00 777775 		ADJSP	SP,-3				; SP,-3
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-55
KERMSG	MAC	18-Jan-73 17:20	

  3026	401005'	602 01 0 00 000001 		TRNE	AC1,1				; AC1,1
  3027	401006'	334 01 0 00 000014'		SKIPA	AC1,U.49			; AC1,STATE
  3028	401007'	201 01 0 00 000023 	L.67:	MOVEI	AC1,23				; AC1,23
  3029					L.68:	POP	SP,AC16				; SP,AC16				
  3030	401010'	262 17 0 00 000016 						1980
  3031	401011'	262 17 0 00 000014 		POP	SP,AC14				; SP,AC14
  3032	401012'	263 17 0 00 000000 		POPJ	SP,				; SP,
  3033	401013'	00 06 0 00 000001 	C.18:	POINT	6,AC1,35			; 6,AC1,35
  3034	401014'	44 07 0 00 000000*	C.19:	POINT	7,FILE%NAME,-1			; 7,FILE%NAME,-1
  3035	401015'	000000	000131		C.20:	EXP	131				; 131
  3036	401016'	000000	000011		C.21:	EXP	11				; 11
  3037	401017'	000000	000252		C.22:	EXP	252				; 252
  3038	401020'	000000	000204		C.23:	EXP	204				; 204
  3039	401021'	000000	000242		C.24:	EXP	242				; 242
  3040	401022'	000000	000116		C.25:	EXP	116				; 116
  3041	401023'	000000	000000		C.26:	EXP	0				; 0
  3042
  3043					; Routine Size:  142 words
  3044
  3045
  3046					;   2168  1	%SBTTL 'SEND%SERVER%INIT'
  3047					;   2169  1	ROUTINE SEND%SERVER%INIT =
  3048					;   2170  1	
  3049					;   2171  1	!++
  3050					;   2172  1	! FUNCTIONAL DESCRIPTION:
  3051					;   2173  1	!
  3052					;   2174  1	!	This routine will send a server initialization message to the
  3053					;   2175  1	!	remote KERMIT.
  3054					;   2176  1	!
  3055					;   2177  1	! CALLING SEQUENCE:
  3056					;   2178  1	!
  3057					;   2179  1	!	STATE = SEND%SERVER%INIT();
  3058					;   2180  1	!
  3059					;   2181  1	! INPUT PARAMETERS:
  3060					;   2182  1	!
  3061					;   2183  1	!	None.
  3062					;   2184  1	!
  3063					;   2185  1	! IMPLICIT INPUTS:
  3064					;   2186  1	!
  3065					;   2187  1	!	RECV%xxx - desired receive parameters
  3066					;   2188  1	!
  3067					;   2189  1	! OUTPUT PARAMETERS:
  3068					;   2190  1	!
  3069					;   2191  1	!	New state to change the finite state machine to.
  3070					;   2192  1	!
  3071					;   2193  1	! IMPLICIT OUTPUTS:
  3072					;   2194  1	!
  3073					;   2195  1	!	SEND%xxx - Other Kermit's desired parameters
  3074					;   2196  1	!
  3075					;   2197  1	! COMPLETION CODES:
  3076					;   2198  1	!
  3077					;   2199  1	!	None.
  3078					;   2200  1	!
  3079					;   2201  1	! SIDE EFFECTS:
  3080					;   2202  1	!
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-56
KERMSG	MAC	18-Jan-73 17:20	

  3081					;   2203  1	!	None.
  3082					;   2204  1	!
  3083					;   2205  1	!--
  3084					;   2206  1	
  3085					;   2207  2	    BEGIN
  3086					;   2208  2	
  3087					;   2209  2	    LOCAL
  3088					;   2210  2		OLD%OUTPUT,				! Saved terminal output rout
  3089					ine
  3090					;   2211  2		STATUS;					! Status returned by various
  3091					 routines
  3092					;   2212  2	
  3093					;   2213  2	![026] Local routine to ignore error message output
  3094					;   2214  2	    ROUTINE IGNORE%ERROR (ADDRESS, LENGTH) =
  3095					;   2215  3		BEGIN
  3096					;   2216  3		RETURN TRUE;
  3097					;   2217  2		END;
  3098
  3099
  3100					; IGNORE%ERROR
  3101					U.74:	MOVEI	AC1,1				; AC1,1					
  3102	401024'	201 01 0 00 000001 						2215
  3103						POPJ	SP,				; SP,					
  3104	401025'	263 17 0 00 000000 						2214
  3105
  3106					; Routine Size:  2 words
  3107
  3108
  3109					;   2218  2	    SET%SEND%INIT ();
  3110					;   2219  2	![026] If too many tries, just give up.  Maybe the other Kermit doesn't
  3111					;   2220  2	![026] know what to do with this packet.
  3112					;   2221  2	
  3113					;   2222  2	    IF .NUM%RETRIES GTR .SI%RETRIES THEN RETURN STATE%ER;
  3114					;   2223  2	
  3115					;   2224  2	![026]
  3116					;   2225  2	![026] Count the number of times we try this
  3117					;   2226  2	![026]
  3118					;   2227  2	    NUM%RETRIES = .NUM%RETRIES + 1;
  3119					;   2228  2	
  3120					;   2229  2	    IF NOT SEND%PACKET (MSG%SER%INIT, P%SI%LENGTH, .MSG%NUMBER) THEN RETURN 
  3121					STATE%A;
  3122					;   2230  2	
  3123					;   2231  2	![026]
  3124					;   2232  2	![026] Determine if we received a packet it good condition.  If we timed out
  3125
  3126					;   2233  2	![026] just try again.  If we get an error packet back, ignore it and
  3127					;   2234  2	![026] just continue.  The other Kermit must not support this packet.
  3128					;   2235  2	![026]
  3129					;   2236  2	    OLD%OUTPUT = TT%SET%OUTPUT (IGNORE%ERROR);
  3130					;   2237  2	    STATUS = REC%PACKET ();
  3131					;   2238  2	    TT%OUTPUT ();
  3132					;   2239  2	    TT%SET%OUTPUT (.OLD%OUTPUT);
  3133					;   2240  2	
  3134					;   2241  2	    IF .STATUS EQL KER%ERRMSG THEN RETURN STATE%SG;
  3135					;   2242  2	
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-57
KERMSG	MAC	18-Jan-73 17:20	

  3136					;   2243  2	    IF NOT .STATUS
  3137					;   2244  2	    THEN
  3138					;   2245  2	
  3139					;   2246  4		IF NOT ((.STATUS EQL KER%ZEROLENMSG) OR (.STATUS EQL KER%TIMEOUT) OR
  3140					 (.STATUS EQL
  3141					;   2247  3		    KER%CHKSUMERR))
  3142					;   2248  2		THEN
  3143					;   2249  2		    RETURN STATE%EX
  3144					;   2250  2		ELSE
  3145					;   2251  2		    RETURN .STATE;
  3146					;   2252  2	
  3147					;   2253  2	!
  3148					;   2254  2	! Determine if the packet is good.
  3149					;   2255  2	!
  3150					;   2256  2	
  3151					;   2257  2	    IF .REC%TYPE EQL MSG%ACK AND .REC%SEQ EQL .MSG%NUMBER
  3152					;   2258  2	    THEN
  3153					;   2259  3		BEGIN
  3154					;   2260  3	!
  3155					;   2261  3	! Here if we have an ACK for the initialization message that was just sent
  3156					;   2262  3	! to the remote KERMIT.
  3157					;   2263  3	!
  3158					;   2264  3	
  3159					;   2265  3		IF NOT (STATUS = PRS%SEND%INIT ()) THEN RETURN STATE%A;
  3160					;   2266  3	
  3161					;   2267  3		NUM%RETRIES = 0;
  3162					;   2268  3		INIT%PKT%SENT = TRUE;			! We have exchanged init's
  3163					;   2269  3		RETURN STATE%SG;
  3164					;   2270  2		END;
  3165					;   2271  2	
  3166					;   2272  2	!
  3167					;   2273  2	! If we haven't returned yet, we must have gotten an invalid response.
  3168					;   2274  2	! Just stay in the same state so we try again
  3169					;   2275  2	!
  3170					;   2276  2	    RETURN .STATE;
  3171					;   2277  1	    END;
  3172
  3173
  3174					; SEND%SERVER%INIT
  3175					U.2:	PUSH	SP,AC14				; SP,AC14				
  3176	401026'	261 17 0 00 000014 						2169
  3177	401027'	261 17 0 00 000016 		PUSH	SP,AC16				; SP,AC16
  3178						PUSHJ	SP,U.20				; SP,SET%SEND%INIT			
  3179	401030'	260 17 0 00 404355'						2218
  3180						MOVE	AC1,U.52			; AC1,NUM%RETRIES			
  3181	401031'	200 01 0 00 000017'						2222
  3182	401032'	317 01 0 00 400774*		CAMG	AC1,SI%RETRIES			; AC1,SI%RETRIES
  3183	401033'	254 00 0 00 401036'		JRST	L.69				; L.69
  3184	401034'	201 01 0 00 000024 		MOVEI	AC1,24				; AC1,24
  3185	401035'	254 00 0 00 401121'		JRST	L.77				; L.77
  3186					L.69:	AOS	U.52				; NUM%RETRIES				
  3187	401036'	350 00 0 00 000017'						2227
  3188						PUSH	SP,C.6				; SP,[111]				
  3189	401037'	261 17 0 00 400170'						2229
  3190	401040'	261 17 0 00 401016'		PUSH	SP,C.21				; SP,[11]
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-58
KERMSG	MAC	18-Jan-73 17:20	

  3191	401041'	261 17 0 00 000020'		PUSH	SP,U.53				; SP,MSG%NUMBER
  3192	401042'	260 17 0 00 404426'		PUSHJ	SP,U.24				; SP,SEND%PACKET
  3193	401043'	105 17 0 00 777775 		ADJSP	SP,-3				; SP,-3
  3194	401044'	606 01 0 00 000001 		TRNN	AC1,1				; AC1,1
  3195	401045'	254 00 0 00 401107'		JRST	L.73				; L.73
  3196						PUSH	SP,C.27				; SP,[0,,IGNORE%ERROR]			
  3197	401046'	261 17 0 00 401124'						2236
  3198	401047'	260 17 0 00 000000*		PUSHJ	SP,TT%SET%OUTPUT		; SP,TT%SET%OUTPUT
  3199	401050'	200 14 0 00 000001 		MOVE	AC14,AC1			; OLD%OUTPUT,AC1
  3200						PUSHJ	SP,U.26				; SP,REC%PACKET				
  3201	401051'	260 17 0 00 404716'						2237
  3202	401052'	200 16 0 00 000001 		MOVE	AC16,AC1			; STATUS,AC1
  3203						PUSHJ	SP,TT%OUTPUT			; SP,TT%OUTPUT				
  3204	401053'	260 17 0 00 000000*						2238
  3205						MOVEM	AC14,0(SP)			; OLD%OUTPUT,0(SP)			
  3206	401054'	202 14 0 17 000000 						2239
  3207	401055'	260 17 0 00 401047*		PUSHJ	SP,TT%SET%OUTPUT		; SP,TT%SET%OUTPUT
  3208						CAIN	AC16,162			; STATUS,162				
  3209	401056'	306 16 0 00 000162 						2241
  3210	401057'	254 00 0 00 401114'		JRST	L.75				; L.75
  3211						TRNE	AC16,1				; STATUS,1				
  3212	401060'	602 16 0 00 000001 						2243
  3213	401061'	254 00 0 00 401074'		JRST	L.72				; L.72
  3214						CAIE	AC16,262			; STATUS,262				
  3215	401062'	302 16 0 00 000262 						2246
  3216	401063'	306 16 0 00 000300 		CAIN	AC16,300			; STATUS,300
  3217	401064'	254 00 0 00 401071'		JRST	L.70				; L.70
  3218	401065'	306 16 0 00 000172 		CAIN	AC16,172			; STATUS,172
  3219	401066'	254 00 0 00 401071'		JRST	L.70				; L.70
  3220						MOVEI	AC1,23				; AC1,23				
  3221	401067'	201 01 0 00 000023 						2251
  3222	401070'	254 00 0 00 401072'		JRST	L.71				; L.71
  3223	401071'	200 01 0 00 000014'	L.70:	MOVE	AC1,U.49			; AC1,STATE
  3224	401072'	105 17 0 00 777777 	L.71:	ADJSP	SP,-1				; SP,-1
  3225						JRST	L.77				; L.77					
  3226	401073'	254 00 0 00 401121'						2246
  3227					L.72:	MOVEI	AC1,131				; AC1,131				
  3228	401074'	201 01 0 00 000131 						2257
  3229	401075'	312 01 0 00 000023'		CAME	AC1,U.56			; AC1,REC%TYPE
  3230	401076'	254 00 0 00 401117'		JRST	L.76				; L.76
  3231	401077'	200 01 0 00 000021'		MOVE	AC1,U.54			; AC1,REC%SEQ
  3232	401100'	312 01 0 00 000020'		CAME	AC1,U.53			; AC1,MSG%NUMBER
  3233	401101'	254 00 0 00 401117'		JRST	L.76				; L.76
  3234						PUSHJ	SP,U.21				; SP,PRS%SEND%INIT			
  3235	401102'	260 17 0 00 404103'						2265
  3236	401103'	200 16 0 00 000001 		MOVE	AC16,AC1			; STATUS,AC1
  3237	401104'	602 16 0 00 000001 		TRNE	AC16,1				; STATUS,1
  3238	401105'	254 00 0 00 401111'		JRST	L.74				; L.74
  3239	401106'	105 17 0 00 777777 		ADJSP	SP,-1				; SP,-1
  3240	401107'	201 01 0 00 000012 	L.73:	MOVEI	AC1,12				; AC1,12
  3241	401110'	254 00 0 00 401121'		JRST	L.77				; L.77
  3242					L.74:	SETZM	U.52				; NUM%RETRIES				
  3243	401111'	402 00 0 00 000017'						2267
  3244						MOVEI	AC1,1				; AC1,1					
  3245	401112'	201 01 0 00 000001 						2268
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-59
KERMSG	MAC	18-Jan-73 17:20	

  3246	401113'	202 01 0 00 000110'		MOVEM	AC1,U.63			; AC1,INIT%PKT%SENT
  3247					L.75:	ADJSP	SP,-1				; SP,-1					
  3248	401114'	105 17 0 00 777777 						2269
  3249						MOVEI	AC1,14				; AC1,14				
  3250	401115'	201 01 0 00 000014 						2259
  3251	401116'	254 00 0 00 401121'		JRST	L.77				; L.77
  3252					L.76:	ADJSP	SP,-1				; SP,-1					
  3253	401117'	105 17 0 00 777777 						2276
  3254						MOVE	AC1,U.49			; AC1,STATE				
  3255	401120'	200 01 0 00 000014'						2207
  3256					L.77:	POP	SP,AC16				; SP,AC16				
  3257	401121'	262 17 0 00 000016 						2169
  3258	401122'	262 17 0 00 000014 		POP	SP,AC14				; SP,AC14
  3259	401123'	263 17 0 00 000000 		POPJ	SP,				; SP,
  3260	401124'	000000	401024'		C.27:	XWD	0,U.74				; 0,IGNORE%ERROR
  3261
  3262					; Routine Size:  63 words
  3263
  3264
  3265					;   2278  1	%SBTTL 'SEND%DATA'
  3266					;   2279  1	ROUTINE SEND%DATA =
  3267					;   2280  1	
  3268					;   2281  1	!++
  3269					;   2282  1	! FUNCTIONAL DESCRIPTION:
  3270					;   2283  1	!
  3271					;   2284  1	!	This routine will send a data message to the remote KERMIT.
  3272					;   2285  1	!
  3273					;   2286  1	! CALLING SEQUENCE:
  3274					;   2287  1	!
  3275					;   2288  1	!	STATE = SEND%DATA();
  3276					;   2289  1	!
  3277					;   2290  1	! INPUT PARAMETERS:
  3278					;   2291  1	!
  3279					;   2292  1	!	None.
  3280					;   2293  1	!
  3281					;   2294  1	! IMPLICIT INPUTS:
  3282					;   2295  1	!
  3283					;   2296  1	!	None.
  3284					;   2297  1	!
  3285					;   2298  1	! OUTPUT PARAMETERS:
  3286					;   2299  1	!
  3287					;   2300  1	!	New state to change the finite state machine to.
  3288					;   2301  1	!
  3289					;   2302  1	! IMPLICIT OUTPUTS:
  3290					;   2303  1	!
  3291					;   2304  1	!	None.
  3292					;   2305  1	!
  3293					;   2306  1	! COMPLETION CODES:
  3294					;   2307  1	!
  3295					;   2308  1	!	None.
  3296					;   2309  1	!
  3297					;   2310  1	! SIDE EFFECTS:
  3298					;   2311  1	!
  3299					;   2312  1	!	None.
  3300					;   2313  1	!
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-60
KERMSG	MAC	18-Jan-73 17:20	

  3301					;   2314  1	!--
  3302					;   2315  1	
  3303					;   2316  2	    BEGIN
  3304					;   2317  2	
  3305					;   2318  2	    LOCAL
  3306					;   2319  2		SUB%TYPE,				! Subtype for XFR%STATUS cal
  3307					l
  3308					;   2320  2		STATUS;					! Status returned by various
  3309					 routines
  3310					;   2321  2	
  3311					;   2322  2	!
  3312					;   2323  2	! If there is nothing in the data packet, we should not bother to send it.
  3313					;   2324  2	! Instead, we will just call BFR%FILL again to get some more data
  3314					;   2325  2	!
  3315					;   2326  2	
  3316					;   2327  2	    IF .SIZE GTR 0
  3317					;   2328  2	    THEN
  3318					;   2329  3		BEGIN
  3319					;   2330  3	!
  3320					;   2331  3	! Check to see if the number of retries have been exceeded.
  3321					;   2332  3	!
  3322					;   2333  3	
  3323					;   2334  3		IF .NUM%RETRIES GTR .PKT%RETRIES THEN RETURN STATE%ER;
  3324					;   2335  3	
  3325					;   2336  3	!
  3326					;   2337  3	! Not exceeded yet.  Increment the number of retries we have attempted
  3327					;   2338  3	! on this message.
  3328					;   2339  3	!
  3329					;   2340  3		NUM%RETRIES = .NUM%RETRIES + 1;
  3330					;   2341  3	!
  3331					;   2342  3	! Attempt to send the packet and abort if the send fails.
  3332					;   2343  3	!
  3333					;   2344  3	
  3334					;   2345  3		IF NOT SEND%PACKET (MSG%DATA, .SIZE, .MSG%NUMBER) THEN RETURN STATE%
  3335					EX;
  3336					;   2346  3	
  3337					;   2347  3	!
  3338					;   2348  3	! Attempt to receive a message from the remote KERMIT.
  3339					;   2349  3	!
  3340					;   2350  3		STATUS = REC%PACKET ();
  3341					;   2351  3	
  3342					;   2352  3		IF NOT .STATUS
  3343					;   2353  3		THEN
  3344					;   2354  4		    BEGIN
  3345					;   2355  4	
  3346					;   2356  5		    IF (.STATUS EQL KER%ZEROLENMSG) OR (.STATUS EQL KER%TIMEOUT) OR 
  3347					(.STATUS EQL
  3348					;   2357  5			KER%CHKSUMERR)
  3349					;   2358  4		    THEN
  3350					;   2359  4			RETURN .STATE
  3351					;   2360  4		    ELSE
  3352					;   2361  4			RETURN STATE%EX;
  3353					;   2362  4	
  3354					;   2363  3		    END;
  3355					;   2364  3	
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-61
KERMSG	MAC	18-Jan-73 17:20	

  3356					;   2365  3	!
  3357					;   2366  3	! Determine if the message is a NAK and the NAK is for the message number
  3358					;   2367  3	! that we are current working on.  If the NAK is for the next packet then
  3359					;   2368  3	! treat it like an ACK for this packet
  3360					;   2369  3	!
  3361					;   2370  3	
  3362					;   2371  4		IF .REC%TYPE EQL MSG%NAK AND (.REC%SEQ NEQ ((.MSG%NUMBER + 1) AND %O
  3363					'77'))
  3364					;   2372  3		THEN
  3365					;   2373  3		    RETURN .STATE;
  3366					;   2374  3	
  3367					;   2375  3	!
  3368					;   2376  3	! Make sure we have a NAK or ACK
  3369					;   2377  3	!
  3370					;   2378  3	
  3371					;   2379  4		IF NOT (.REC%TYPE EQL MSG%ACK OR .REC%TYPE EQL MSG%NAK)
  3372					;   2380  3		THEN
  3373					;   2381  3	!
  3374					;   2382  3	! Not an ACK or NAK, abort.
  3375					;   2383  3	!
  3376					;   2384  4		    BEGIN
  3377					;   2385  4		    KRM%ERROR (KER%PROTOERR);
  3378					;   2386  4		    RETURN STATE%A;
  3379					;   2387  3		    END;
  3380					;   2388  3	
  3381					;   2389  3	!
  3382					;   2390  3	! Is this for this message?
  3383					;   2391  3	!
  3384					;   2392  3	
  3385					;   2393  3		IF .REC%TYPE EQL MSG%ACK AND .REC%SEQ NEQ .MSG%NUMBER THEN RETURN .S
  3386					TATE;
  3387					;   2394  3	
  3388					;   2395  3	!
  3389					;   2396  3	! It was.  Set up for sending the next data message to the remote KERMIT
  3390					;   2397  3	! and return.
  3391					;   2398  3	!
  3392					;   2399  3	!
  3393					;   2400  3	! Check for data field in ACK indicating abort file or stream
  3394					;   2401  3	!
  3395					;   2402  3	!
  3396					;   2403  3	
  3397					;   2404  3		IF .REC%TYPE EQL MSG%ACK AND .REC%LENGTH EQL 1
  3398					;   2405  3		THEN
  3399					;   2406  3	
  3400					;   2407  3		    SELECTONE CH$RCHAR (CH$PTR (REC%MSG, PKT%MSG, CHR%SIZE)) OF
  3401					;   2408  3			SET
  3402					;   2409  3	
  3403					;   2410  3			[MSG%ACK%ABT%CUR] :
  3404					;   2411  3			    ABT%CUR%FILE = TRUE;
  3405					;   2412  3	
  3406					;   2413  3			[MSG%ACK%ABT%ALL] :
  3407					;   2414  3			    ABT%ALL%FILE = TRUE;
  3408					;   2415  3			TES;
  3409					;   2416  3	
  3410					;   2417  3		NUM%RETRIES = 0;
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-62
KERMSG	MAC	18-Jan-73 17:20	

  3411					;   2418  3		MSG%NUMBER = (.MSG%NUMBER + 1) AND %O'77';
  3412					;   2419  2		END;					! End of IF .SIZE GTR 0
  3413					;   2420  2	
  3414					;   2421  3	    IF (BFR%FILL (FALSE) EQL KER%NORMAL) AND NOT (.ABT%CUR%FILE OR .ABT%ALL%
  3415					FILE)
  3416					;   2422  2	    THEN
  3417					;   2423  2		RETURN STATE%SD
  3418					;   2424  2	    ELSE
  3419					;   2425  3		BEGIN
  3420					;   2426  3	
  3421					;   2427  3		IF ( NOT .CONNECT%FLAG) AND .TY%FIL
  3422					;   2428  3		THEN
  3423					;   2429  4		    BEGIN
  3424					;   2430  4	
  3425					;   2431  4		    IF .ABT%ALL%FILE
  3426					;   2432  4		    THEN
  3427					;   2433  4			TT%TEXT (UPLIT (%ASCIZ' [Group interrupted]'))
  3428					;   2434  4		    ELSE
  3429					;   2435  4	
  3430					;   2436  4			IF .ABT%CUR%FILE
  3431					;   2437  4			THEN
  3432					;   2438  4			    TT%TEXT (UPLIT (%ASCIZ' [Interrupted]'))
  3433					;   2439  4			ELSE
  3434					;   2440  4			    TT%TEXT (UPLIT (%ASCIZ' [OK]'));
  3435					;   2441  4	
  3436					;   2442  4		    TT%CRLF ();
  3437					;   2443  3		    END;
  3438					;   2444  3	
  3439					;   2445  3		IF .FILE%OPEN%FLAG THEN FILE%CLOSE (FALSE);
  3440					;   2446  3	
  3441					;   2447  3		SUB%TYPE = %C'C';			! Assume ok
  3442					;   2448  3	
  3443					;   2449  3		IF .ABT%ALL%FILE
  3444					;   2450  3		THEN
  3445					;   2451  3		    SUB%TYPE = %C'Z'
  3446					;   2452  3		ELSE
  3447					;   2453  3	
  3448					;   2454  3		    IF .ABT%CUR%FILE THEN SUB%TYPE = %C'X';
  3449					;   2455  3	
  3450					;   2456  3		XFR%STATUS (%C'F', .SUB%TYPE);
  3451					;   2457  3		FILE%OPEN%FLAG = FALSE;
  3452					;   2458  3		RETURN STATE%SZ;
  3453					;   2459  2		END;
  3454					;   2460  2	
  3455					;   2461  1	    END;
  3456
  3457
  3458	401125'	040 133 107 162 157 0 	P.AAB:	BYTE	(7)" ","[","G","r","o"		;  [Gro
  3459	401126'	165 160 040 151 156 0 		BYTE	(7)"u","p"," ","i","n"		; up in
  3460	401127'	164 145 162 162 165 0 		BYTE	(7)"t","e","r","r","u"		; terru
  3461	401130'	160 164 145 144 135 0 		BYTE	(7)"p","t","e","d","]"		; pted]
  3462	401131'	000 000 000 000 000 0 		BYTE	(7)000,000,000,000,000
  3463	401132'	040 133 111 156 164 0 	P.AAC:	BYTE	(7)" ","[","I","n","t"		;  [Int
  3464	401133'	145 162 162 165 160 0 		BYTE	(7)"e","r","r","u","p"		; errup
  3465	401134'	164 145 144 135 000 0 		BYTE	(7)"t","e","d","]",000		; ted]
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-63
KERMSG	MAC	18-Jan-73 17:20	

  3466	401135'	040 133 117 113 135 0 	P.AAD:	BYTE	(7)" ","[","O","K","]"		;  [OK]
  3467	401136'	000 000 000 000 000 0 		BYTE	(7)000,000,000,000,000
  3468
  3469
  3470					; SEND%DATA
  3471					U.3:	MOVE	AC1,U.50			; AC1,SIZE				
  3472	401137'	200 01 0 00 000015'						2327
  3473	401140'	323 01 0 00 401251'		JUMPLE	AC1,L.87			; AC1,L.87
  3474						MOVE	AC2,U.52			; AC2,NUM%RETRIES			
  3475	401141'	200 02 0 00 000017'						2334
  3476	401142'	317 02 0 00 400037*		CAMG	AC2,PKT%RETRIES			; AC2,PKT%RETRIES
  3477	401143'	254 00 0 00 401146'		JRST	L.78				; L.78
  3478	401144'	201 01 0 00 000024 		MOVEI	AC1,24				; AC1,24
  3479	401145'	263 17 0 00 000000 		POPJ	SP,				; SP,
  3480					L.78:	AOS	U.52				; NUM%RETRIES				
  3481	401146'	350 00 0 00 000017'						2340
  3482						PUSH	SP,C.28				; SP,[104]				
  3483	401147'	261 17 0 00 401340'						2345
  3484	401150'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
  3485	401151'	261 17 0 00 000020'		PUSH	SP,U.53				; SP,MSG%NUMBER
  3486	401152'	260 17 0 00 404426'		PUSHJ	SP,U.24				; SP,SEND%PACKET
  3487	401153'	105 17 0 00 777775 		ADJSP	SP,-3				; SP,-3
  3488	401154'	606 01 0 00 000001 		TRNN	AC1,1				; AC1,1
  3489	401155'	254 00 0 00 401166'		JRST	L.79				; L.79
  3490						PUSHJ	SP,U.26				; SP,REC%PACKET				
  3491	401156'	260 17 0 00 404716'						2350
  3492						TRNE	AC1,1				; STATUS,1				
  3493	401157'	602 01 0 00 000001 						2352
  3494	401160'	254 00 0 00 401170'		JRST	L.80				; L.80
  3495						CAIE	AC1,262				; STATUS,262				
  3496	401161'	302 01 0 00 000262 						2356
  3497	401162'	306 01 0 00 000300 		CAIN	AC1,300				; STATUS,300
  3498	401163'	254 00 0 00 401222'		JRST	L.83				; L.83
  3499	401164'	306 01 0 00 000172 		CAIN	AC1,172				; STATUS,172
  3500						JRST	L.83				; L.83					
  3501	401165'	254 00 0 00 401222'						2359
  3502					L.79:	MOVEI	AC1,23				; AC1,23				
  3503	401166'	201 01 0 00 000023 						2361
  3504						POPJ	SP,				; SP,					
  3505	401167'	263 17 0 00 000000 						2354
  3506					L.80:	MOVE	AC2,U.56			; AC2,REC%TYPE				
  3507	401170'	200 02 0 00 000023'						2371
  3508	401171'	400 03 0 00 000000 		SETZ	AC3,				; AC3,
  3509	401172'	302 02 0 00 000116 		CAIE	AC2,116				; AC2,116
  3510	401173'	254 00 0 00 401202'		JRST	L.81				; L.81
  3511	401174'	201 03 0 00 000001 		MOVEI	AC3,1				; AC3,1
  3512	401175'	200 01 0 00 000020'		MOVE	AC1,U.53			; AC1,MSG%NUMBER
  3513	401176'	271 01 0 00 000001 		ADDI	AC1,1				; AC1,1
  3514	401177'	135 04 0 00 401013'		LDB	AC4,C.18			; AC4,[POINT 6,AC1,35]  <0,6>
  3515	401200'	312 04 0 00 000021'		CAME	AC4,U.54			; AC4,REC%SEQ
  3516	401201'	254 00 0 00 401222'		JRST	L.83				; L.83
  3517					L.81:	CAIE	AC2,131				; AC2,131				
  3518	401202'	302 02 0 00 000131 						2379
  3519	401203'	602 03 0 00 000001 		TRNE	AC3,1				; AC3,1
  3520	401204'	254 00 0 00 401212'		JRST	L.82				; L.82
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-64
KERMSG	MAC	18-Jan-73 17:20	

  3521						PUSH	SP,C.22				; SP,[252]				
  3522	401205'	261 17 0 00 401017'						2385
  3523	401206'	260 17 0 00 400770*		PUSHJ	SP,KRM%ERROR			; SP,KRM%ERROR
  3524						ADJSP	SP,-1				; SP,-1					
  3525	401207'	105 17 0 00 777777 						2386
  3526						MOVEI	AC1,12				; AC1,12				
  3527	401210'	201 01 0 00 000012 						2384
  3528	401211'	263 17 0 00 000000 		POPJ	SP,				; SP,
  3529					L.82:	SETZ	AC1,				; AC1,					
  3530	401212'	400 01 0 00 000000 						2393
  3531	401213'	201 02 0 00 000131 		MOVEI	AC2,131				; AC2,131
  3532	401214'	312 02 0 00 000023'		CAME	AC2,U.56			; AC2,REC%TYPE
  3533	401215'	254 00 0 00 401224'		JRST	L.84				; L.84
  3534	401216'	201 01 0 00 000001 		MOVEI	AC1,1				; AC1,1
  3535	401217'	200 02 0 00 000021'		MOVE	AC2,U.54			; AC2,REC%SEQ
  3536	401220'	316 02 0 00 000020'		CAMN	AC2,U.53			; AC2,MSG%NUMBER
  3537	401221'	254 00 0 00 401224'		JRST	L.84				; L.84
  3538	401222'	200 01 0 00 000014'	L.83:	MOVE	AC1,U.49			; AC1,STATE
  3539	401223'	263 17 0 00 000000 		POPJ	SP,				; SP,
  3540					L.84:	TRNN	AC1,1				; AC1,1					
  3541	401224'	606 01 0 00 000001 						2404
  3542	401225'	254 00 0 00 401244'		JRST	L.86				; L.86
  3543	401226'	201 01 0 00 000001 		MOVEI	AC1,1				; AC1,1
  3544	401227'	312 01 0 00 000022'		CAME	AC1,U.55			; AC1,REC%LENGTH
  3545	401230'	254 00 0 00 401244'		JRST	L.86				; L.86
  3546						MOVE	AC1,C.29			; AC1,[POINT 8,REC%MSG,31]  <4,8>	
  3547	401231'	200 01 0 00 401341'						2407
  3548	401232'	134 01 0 00 000001 		ILDB	AC1,AC1				; AC1,AC1
  3549						CAIE	AC1,130				; AC1,130				
  3550	401233'	302 01 0 00 000130 						2410
  3551	401234'	254 00 0 00 401240'		JRST	L.85				; L.85
  3552						MOVEI	AC2,1				; AC2,1					
  3553	401235'	201 02 0 00 000001 						2411
  3554	401236'	202 02 0 00 000000*		MOVEM	AC2,ABT%CUR%FILE		; AC2,ABT%CUR%FILE
  3555						JRST	L.86				; L.86					
  3556	401237'	254 00 0 00 401244'						2407
  3557					L.85:	CAIE	AC1,132				; AC1,132				
  3558	401240'	302 01 0 00 000132 						2413
  3559	401241'	254 00 0 00 401244'		JRST	L.86				; L.86
  3560						MOVEI	AC1,1				; AC1,1					
  3561	401242'	201 01 0 00 000001 						2414
  3562	401243'	202 01 0 00 000000*		MOVEM	AC1,ABT%ALL%FILE		; AC1,ABT%ALL%FILE
  3563					L.86:	SETZM	U.52				; NUM%RETRIES				
  3564	401244'	402 00 0 00 000017'						2417
  3565						MOVE	AC1,U.53			; AC1,MSG%NUMBER			
  3566	401245'	200 01 0 00 000020'						2418
  3567	401246'	271 01 0 00 000001 		ADDI	AC1,1				; AC1,1
  3568	401247'	135 02 0 00 401013'		LDB	AC2,C.18			; AC2,[POINT 6,AC1,35]  <0,6>
  3569	401250'	202 02 0 00 000020'		MOVEM	AC2,U.53			; AC2,MSG%NUMBER
  3570					L.87:	PUSH	SP,C.26				; SP,[0]				
  3571	401251'	261 17 0 00 401023'						2421
  3572	401252'	260 17 0 00 405543'		PUSHJ	SP,U.29				; SP,BFR%FILL
  3573	401253'	105 17 0 00 777777 		ADJSP	SP,-1				; SP,-1
  3574	401254'	302 01 0 00 000013 		CAIE	AC1,13				; AC1,13
  3575	401255'	254 00 0 00 401266'		JRST	L.88				; L.88
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-65
KERMSG	MAC	18-Jan-73 17:20	

  3576	401256'	201 01 0 00 000001 		MOVEI	AC1,1				; AC1,1
  3577	401257'	612 01 0 00 401236*		TDNE	AC1,ABT%CUR%FILE		; AC1,ABT%CUR%FILE
  3578	401260'	254 00 0 00 401266'		JRST	L.88				; L.88
  3579	401261'	201 01 0 00 000001 		MOVEI	AC1,1				; AC1,1
  3580	401262'	612 01 0 00 401243*		TDNE	AC1,ABT%ALL%FILE		; AC1,ABT%ALL%FILE
  3581	401263'	254 00 0 00 401266'		JRST	L.88				; L.88
  3582						MOVEI	AC1,3				; AC1,3					
  3583	401264'	201 01 0 00 000003 						2425
  3584	401265'	263 17 0 00 000000 		POPJ	SP,				; SP,
  3585					L.88:	MOVEI	AC1,1				; AC1,1					
  3586	401266'	201 01 0 00 000001 						2427
  3587	401267'	612 01 0 00 400465*		TDNE	AC1,CONNECT%FLAG		; AC1,CONNECT%FLAG
  3588	401270'	254 00 0 00 401312'		JRST	L.92				; L.92
  3589	401271'	201 01 0 00 000001 		MOVEI	AC1,1				; AC1,1
  3590	401272'	616 01 0 00 400470*		TDNN	AC1,TY%FIL			; AC1,TY%FIL
  3591	401273'	254 00 0 00 401312'		JRST	L.92				; L.92
  3592						MOVEI	AC1,1				; AC1,1					
  3593	401274'	201 01 0 00 000001 						2431
  3594	401275'	616 01 0 00 401262*		TDNN	AC1,ABT%ALL%FILE		; AC1,ABT%ALL%FILE
  3595	401276'	254 00 0 00 401301'		JRST	L.89				; L.89
  3596						PUSH	SP,C.30				; SP,[0,,P.AAB]				
  3597	401277'	261 17 0 00 401342'						2433
  3598	401300'	254 00 0 00 401307'		JRST	L.91				; L.91
  3599					L.89:	MOVEI	AC1,1				; AC1,1					
  3600	401301'	201 01 0 00 000001 						2436
  3601	401302'	616 01 0 00 401257*		TDNN	AC1,ABT%CUR%FILE		; AC1,ABT%CUR%FILE
  3602	401303'	254 00 0 00 401306'		JRST	L.90				; L.90
  3603						PUSH	SP,C.31				; SP,[0,,P.AAC]				
  3604	401304'	261 17 0 00 401343'						2438
  3605	401305'	254 00 0 00 401307'		JRST	L.91				; L.91
  3606					L.90:	PUSH	SP,C.32				; SP,[0,,P.AAD]				
  3607	401306'	261 17 0 00 401344'						2440
  3608	401307'	260 17 0 00 400473*	L.91:	PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
  3609						PUSHJ	SP,TT%CRLF			; SP,TT%CRLF				
  3610	401310'	260 17 0 00 400475*						2442
  3611						ADJSP	SP,-1				; SP,-1					
  3612	401311'	105 17 0 00 777777 						2429
  3613					L.92:	MOVEI	AC1,1				; AC1,1					
  3614	401312'	201 01 0 00 000001 						2445
  3615	401313'	616 01 0 00 000104'		TDNN	AC1,U.59			; AC1,FILE%OPEN%FLAG
  3616	401314'	254 00 0 00 401320'		JRST	L.93				; L.93
  3617	401315'	261 17 0 00 401023'		PUSH	SP,C.26				; SP,[0]
  3618	401316'	260 17 0 00 400514*		PUSHJ	SP,FILE%CLOSE			; SP,FILE%CLOSE
  3619	401317'	105 17 0 00 777777 		ADJSP	SP,-1				; SP,-1
  3620					L.93:	MOVEI	AC1,103				; SUB%TYPE,103				
  3621	401320'	201 01 0 00 000103 						2447
  3622						MOVEI	AC2,1				; AC2,1					
  3623	401321'	201 02 0 00 000001 						2449
  3624	401322'	616 02 0 00 401275*		TDNN	AC2,ABT%ALL%FILE		; AC2,ABT%ALL%FILE
  3625	401323'	254 00 0 00 401326'		JRST	L.94				; L.94
  3626						MOVEI	AC1,132				; SUB%TYPE,132				
  3627	401324'	201 01 0 00 000132 						2451
  3628						JRST	L.95				; L.95					
  3629	401325'	254 00 0 00 401331'						2449
  3630					L.94:	MOVEI	AC2,1				; AC2,1					
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-66
KERMSG	MAC	18-Jan-73 17:20	

  3631	401326'	201 02 0 00 000001 						2454
  3632	401327'	612 02 0 00 401302*		TDNE	AC2,ABT%CUR%FILE		; AC2,ABT%CUR%FILE
  3633	401330'	201 01 0 00 000130 		MOVEI	AC1,130				; SUB%TYPE,130
  3634					L.95:	PUSH	SP,C.15				; SP,[106]				
  3635	401331'	261 17 0 00 400603'						2456
  3636	401332'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,SUB%TYPE
  3637	401333'	260 17 0 00 400743*		PUSHJ	SP,XFR%STATUS			; SP,XFR%STATUS
  3638						SETZM	U.59				; FILE%OPEN%FLAG			
  3639	401334'	402 00 0 00 000104'						2457
  3640						ADJSP	SP,-2				; SP,-2					
  3641	401335'	105 17 0 00 777776 						2425
  3642	401336'	201 01 0 00 000004 		MOVEI	AC1,4				; AC1,4
  3643						POPJ	SP,				; SP,					
  3644	401337'	263 17 0 00 000000 						2279
  3645	401340'	000000	000104		C.28:	EXP	104				; 104
  3646	401341'	04 10 0 00 000024'	C.29:	POINT	8,U.57,31			; 8,REC%MSG,31
  3647	401342'	000000	401125'		C.30:	XWD	0,P.AAB				; 0,P.AAB
  3648	401343'	000000	401132'		C.31:	XWD	0,P.AAC				; 0,P.AAC
  3649	401344'	000000	401135'		C.32:	XWD	0,P.AAD				; 0,P.AAD
  3650
  3651					; Routine Size:  134 words
  3652
  3653
  3654					;   2462  1	%SBTTL 'SEND%FILE'
  3655					;   2463  1	ROUTINE SEND%FILE =
  3656					;   2464  1	
  3657					;   2465  1	!++
  3658					;   2466  1	! FUNCTIONAL DESCRIPTION:
  3659					;   2467  1	!
  3660					;   2468  1	!	This routine will send the file specification that is being
  3661					;   2469  1	!	transfered, or it will send a text header message.
  3662					;   2470  1	!
  3663					;   2471  1	! CALLING SEQUENCE:
  3664					;   2472  1	!
  3665					;   2473  1	!	STATE = SEND%FILE();
  3666					;   2474  1	!
  3667					;   2475  1	! INPUT PARAMETERS:
  3668					;   2476  1	!
  3669					;   2477  1	!	None.
  3670					;   2478  1	!
  3671					;   2479  1	! IMPLICIT INPUTS:
  3672					;   2480  1	!
  3673					;   2481  1	!	TEXT%HEAD%FLAG - If true, send text header instead of file header
  3674					;   2482  1	!
  3675					;   2483  1	! OUTPUT PARAMETERS:
  3676					;   2484  1	!
  3677					;   2485  1	!	New state to change the finite state machine to.
  3678					;   2486  1	!
  3679					;   2487  1	! IMPLICIT OUTPUTS:
  3680					;   2488  1	!
  3681					;   2489  1	!	None.
  3682					;   2490  1	!
  3683					;   2491  1	! COMPLETION CODES:
  3684					;   2492  1	!
  3685					;   2493  1	!	None.
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-67
KERMSG	MAC	18-Jan-73 17:20	

  3686					;   2494  1	!
  3687					;   2495  1	! SIDE EFFECTS:
  3688					;   2496  1	!
  3689					;   2497  1	!	None.
  3690					;   2498  1	!
  3691					;   2499  1	!--
  3692					;   2500  1	
  3693					;   2501  2	    BEGIN
  3694					;   2502  2	
  3695					;   2503  2	    LOCAL
  3696					;   2504  2		M%TYPE,					! Message type to send
  3697					;   2505  2		STATUS;					! Status returned by various
  3698					 routines
  3699					;   2506  2	
  3700					;   2507  2	!
  3701					;   2508  2	! Flag we don't want to abort yet
  3702					;   2509  2	!
  3703					;   2510  2	    ABT%CUR%FILE = FALSE;
  3704					;   2511  2	    ABT%ALL%FILE = FALSE;
  3705					;   2512  2	!
  3706					;   2513  2	! First determine if we have exceed the number of retries that are
  3707					;   2514  2	! allowed to attempt to send this message.
  3708					;   2515  2	!
  3709					;   2516  2	
  3710					;   2517  2	    IF .NUM%RETRIES GTR .PKT%RETRIES THEN RETURN STATE%ER;
  3711					;   2518  2	
  3712					;   2519  2	!
  3713					;   2520  2	! The number of retries are not exceeded.  Increment the number and then
  3714					;   2521  2	! attempt to send the packet again.
  3715					;   2522  2	!
  3716					;   2523  2	    NUM%RETRIES = .NUM%RETRIES + 1;
  3717					;   2524  2	    SIZE = 0;					! Assume no name
  3718					;   2525  2	
  3719					;   2526  2	    IF .TEXT%HEAD%FLAG THEN M%TYPE = MSG%TEXT ELSE M%TYPE = MSG%FILE;
  3720					;   2527  2	
  3721					;   2528  2	    IF .FILE%SIZE NEQ 0 AND NOT .NO%FILE%NEEDED
  3722					;   2529  2	    THEN
  3723					;   2530  3		BEGIN
  3724					;   2531  3	![025]	CH$MOVE (.FILE%SIZE, CH$PTR (FILE%NAME),
  3725					;   2532  3	![025]	    CH$PTR (SND%MSG, PKT%MSG,
  3726					;   2533  3	![025]		CHR%SIZE));
  3727					;   2534  3	![025]
  3728					;   2535  3	![025] Fill packet with file name
  3729					;   2536  3	![025]
  3730					;   2537  3		SET%STRING (CH$PTR (FILE%NAME), .FILE%SIZE, TRUE);
  3731					;   2538  3		BFR%FILL (TRUE);
  3732					;   2539  3		SET%STRING (0, 0, FALSE);
  3733					;   2540  2		END;
  3734					;   2541  2	
  3735					;   2542  2	    IF NOT SEND%PACKET (.M%TYPE, .SIZE, .MSG%NUMBER) THEN RETURN STATE%EX;
  3736					;   2543  2	
  3737					;   2544  2	!
  3738					;   2545  2	! Now get the responce from the remote KERMIT.
  3739					;   2546  2	!
  3740					;   2547  2	    STATUS = REC%PACKET ();
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-68
KERMSG	MAC	18-Jan-73 17:20	

  3741					;   2548  2	
  3742					;   2549  2	    IF NOT .STATUS
  3743					;   2550  2	    THEN
  3744					;   2551  3		BEGIN
  3745					;   2552  3	
  3746					;   2553  4		IF (.STATUS EQL KER%ZEROLENMSG) OR (.STATUS EQL KER%TIMEOUT) OR (.ST
  3747					ATUS EQL KER%CHKSUMERR)
  3748					;   2554  3		THEN
  3749					;   2555  3		    RETURN .STATE
  3750					;   2556  3		ELSE
  3751					;   2557  3		    RETURN STATE%EX;
  3752					;   2558  3	
  3753					;   2559  2		END;
  3754					;   2560  2	
  3755					;   2561  2	!
  3756					;   2562  2	! Determine if the packet is good.
  3757					;   2563  2	!
  3758					;   2564  2	
  3759					;   2565  3	    IF NOT (.REC%TYPE EQL MSG%ACK OR .REC%TYPE EQL MSG%NAK)
  3760					;   2566  2	    THEN
  3761					;   2567  3		BEGIN
  3762					;   2568  3		KRM%ERROR (KER%PROTOERR);
  3763					;   2569  3		RETURN STATE%A;
  3764					;   2570  2		END;
  3765					;   2571  2	
  3766					;   2572  2	!
  3767					;   2573  2	! If this is a NAK and the message number is not the one we just send
  3768					;   2574  2	! treat this like an ACK, otherwise resend the last packet.
  3769					;   2575  2	!
  3770					;   2576  2	
  3771					;   2577  2	    IF .REC%TYPE EQL MSG%NAK AND (.REC%SEQ NEQ ((.MSG%NUMBER + 1) AND %O'77'
  3772					)) THEN RETURN .STATE;
  3773					;   2578  2	
  3774					;   2579  2	    IF .REC%TYPE EQL MSG%ACK AND .REC%SEQ NEQ .MSG%NUMBER THEN RETURN .STATE
  3775					;
  3776					;   2580  2	
  3777					;   2581  2	!
  3778					;   2582  2	! If all is ok, bump the message number and fill first buffer
  3779					;   2583  2	!
  3780					;   2584  2	    NUM%RETRIES = 0;
  3781					;   2585  2	    MSG%NUMBER = (.MSG%NUMBER + 1) AND %O'77';
  3782					;   2586  2	
  3783					;   2587  2	    IF BFR%FILL (TRUE) THEN RETURN STATE%SD ELSE RETURN STATE%A;
  3784					;   2588  2	
  3785					;   2589  1	    END;					! End of SEND%FILE
  3786
  3787
  3788					; SEND%FILE
  3789					U.4:	PUSH	SP,AC16				; SP,AC16				
  3790	401345'	261 17 0 00 000016 						2463
  3791						SETZM	ABT%CUR%FILE			; ABT%CUR%FILE				
  3792	401346'	402 00 0 00 401327*						2510
  3793						SETZM	ABT%ALL%FILE			; ABT%ALL%FILE				
  3794	401347'	402 00 0 00 401322*						2511
  3795						MOVE	AC1,U.52			; AC1,NUM%RETRIES			
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-69
KERMSG	MAC	18-Jan-73 17:20	

  3796	401350'	200 01 0 00 000017'						2517
  3797	401351'	317 01 0 00 401142*		CAMG	AC1,PKT%RETRIES			; AC1,PKT%RETRIES
  3798	401352'	254 00 0 00 401355'		JRST	L.96				; L.96
  3799	401353'	201 01 0 00 000024 		MOVEI	AC1,24				; AC1,24
  3800	401354'	254 00 0 00 401472'		JRST	L.107				; L.107
  3801					L.96:	AOS	U.52				; NUM%RETRIES				
  3802	401355'	350 00 0 00 000017'						2523
  3803						SETZM	U.50				; SIZE					
  3804	401356'	402 00 0 00 000015'						2524
  3805						MOVEI	AC1,1				; AC1,1					
  3806	401357'	201 01 0 00 000001 						2526
  3807	401360'	616 01 0 00 000106'		TDNN	AC1,U.61			; AC1,TEXT%HEAD%FLAG
  3808	401361'	254 00 0 00 401364'		JRST	L.97				; L.97
  3809	401362'	201 16 0 00 000130 		MOVEI	AC16,130			; M%TYPE,130
  3810	401363'	254 00 0 00 401365'		JRST	L.98				; L.98
  3811	401364'	201 16 0 00 000106 	L.97:	MOVEI	AC16,106			; M%TYPE,106
  3812					L.98:	MOVE	AC1,FILE%SIZE			; AC1,FILE%SIZE				
  3813	401365'	200 01 0 00 400733*						2528
  3814	401366'	322 01 0 00 401405'		JUMPE	AC1,L.99			; AC1,L.99
  3815	401367'	201 02 0 00 000001 		MOVEI	AC2,1				; AC2,1
  3816	401370'	612 02 0 00 000107'		TDNE	AC2,U.62			; AC2,NO%FILE%NEEDED
  3817	401371'	254 00 0 00 401405'		JRST	L.99				; L.99
  3818						PUSH	SP,C.10				; SP,[POINT 7,FILE%NAME-1,34]  <1,7>	
  3819	401372'	261 17 0 00 400257'						2537
  3820	401373'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
  3821	401374'	261 17 0 00 400144'		PUSH	SP,C.2				; SP,[1]
  3822	401375'	260 17 0 00 406157'		PUSHJ	SP,U.30				; SP,SET%STRING
  3823						PUSH	SP,C.2				; SP,[1]				
  3824	401376'	261 17 0 00 400144'						2538
  3825	401377'	260 17 0 00 405543'		PUSHJ	SP,U.29				; SP,BFR%FILL
  3826						SETZM	-2(SP)				; -2(SP)				
  3827	401400'	402 00 0 17 777776 						2539
  3828	401401'	402 00 0 17 777777 		SETZM	-1(SP)				; -1(SP)
  3829	401402'	402 00 0 17 000000 		SETZM	0(SP)				; 0(SP)
  3830	401403'	260 17 0 00 406157'		PUSHJ	SP,U.30				; SP,SET%STRING
  3831						ADJSP	SP,-4				; SP,-4					
  3832	401404'	105 17 0 00 777774 						2530
  3833					L.99:	PUSH	SP,AC16				; SP,M%TYPE				
  3834	401405'	261 17 0 00 000016 						2542
  3835	401406'	261 17 0 00 000015'		PUSH	SP,U.50				; SP,SIZE
  3836	401407'	261 17 0 00 000020'		PUSH	SP,U.53				; SP,MSG%NUMBER
  3837	401410'	260 17 0 00 404426'		PUSHJ	SP,U.24				; SP,SEND%PACKET
  3838	401411'	105 17 0 00 777775 		ADJSP	SP,-3				; SP,-3
  3839	401412'	606 01 0 00 000001 		TRNN	AC1,1				; AC1,1
  3840	401413'	254 00 0 00 401424'		JRST	L.100				; L.100
  3841						PUSHJ	SP,U.26				; SP,REC%PACKET				
  3842	401414'	260 17 0 00 404716'						2547
  3843						TRNE	AC1,1				; STATUS,1				
  3844	401415'	602 01 0 00 000001 						2549
  3845	401416'	254 00 0 00 401426'		JRST	L.101				; L.101
  3846						CAIE	AC1,262				; STATUS,262				
  3847	401417'	302 01 0 00 000262 						2553
  3848	401420'	306 01 0 00 000300 		CAIN	AC1,300				; STATUS,300
  3849	401421'	254 00 0 00 401453'		JRST	L.104				; L.104
  3850	401422'	306 01 0 00 000172 		CAIN	AC1,172				; STATUS,172
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-70
KERMSG	MAC	18-Jan-73 17:20	

  3851						JRST	L.104				; L.104					
  3852	401423'	254 00 0 00 401453'						2555
  3853					L.100:	MOVEI	AC1,23				; AC1,23				
  3854	401424'	201 01 0 00 000023 						2557
  3855						JRST	L.107				; L.107					
  3856	401425'	254 00 0 00 401472'						2551
  3857					L.101:	MOVE	AC1,U.56			; AC1,REC%TYPE				
  3858	401426'	200 01 0 00 000023'						2565
  3859	401427'	302 01 0 00 000131 		CAIE	AC1,131				; AC1,131
  3860	401430'	306 01 0 00 000116 		CAIN	AC1,116				; AC1,116
  3861	401431'	254 00 0 00 401436'		JRST	L.102				; L.102
  3862						PUSH	SP,C.22				; SP,[252]				
  3863	401432'	261 17 0 00 401017'						2568
  3864	401433'	260 17 0 00 401206*		PUSHJ	SP,KRM%ERROR			; SP,KRM%ERROR
  3865						ADJSP	SP,-1				; SP,-1					
  3866	401434'	105 17 0 00 777777 						2569
  3867	401435'	254 00 0 00 401471'		JRST	L.106				; L.106
  3868					L.102:	MOVE	AC2,U.56			; AC2,REC%TYPE				
  3869	401436'	200 02 0 00 000023'						2577
  3870	401437'	302 02 0 00 000116 		CAIE	AC2,116				; AC2,116
  3871	401440'	254 00 0 00 401446'		JRST	L.103				; L.103
  3872	401441'	200 01 0 00 000020'		MOVE	AC1,U.53			; AC1,MSG%NUMBER
  3873	401442'	271 01 0 00 000001 		ADDI	AC1,1				; AC1,1
  3874	401443'	135 03 0 00 401013'		LDB	AC3,C.18			; AC3,[POINT 6,AC1,35]  <0,6>
  3875	401444'	312 03 0 00 000021'		CAME	AC3,U.54			; AC3,REC%SEQ
  3876	401445'	254 00 0 00 401453'		JRST	L.104				; L.104
  3877					L.103:	CAIE	AC2,131				; AC2,131				
  3878	401446'	302 02 0 00 000131 						2579
  3879	401447'	254 00 0 00 401455'		JRST	L.105				; L.105
  3880	401450'	200 01 0 00 000021'		MOVE	AC1,U.54			; AC1,REC%SEQ
  3881	401451'	316 01 0 00 000020'		CAMN	AC1,U.53			; AC1,MSG%NUMBER
  3882	401452'	254 00 0 00 401455'		JRST	L.105				; L.105
  3883	401453'	200 01 0 00 000014'	L.104:	MOVE	AC1,U.49			; AC1,STATE
  3884	401454'	254 00 0 00 401472'		JRST	L.107				; L.107
  3885					L.105:	SETZM	U.52				; NUM%RETRIES				
  3886	401455'	402 00 0 00 000017'						2584
  3887						MOVE	AC1,U.53			; AC1,MSG%NUMBER			
  3888	401456'	200 01 0 00 000020'						2585
  3889	401457'	271 01 0 00 000001 		ADDI	AC1,1				; AC1,1
  3890	401460'	135 02 0 00 401013'		LDB	AC2,C.18			; AC2,[POINT 6,AC1,35]  <0,6>
  3891	401461'	202 02 0 00 000020'		MOVEM	AC2,U.53			; AC2,MSG%NUMBER
  3892						PUSH	SP,C.2				; SP,[1]				
  3893	401462'	261 17 0 00 400144'						2587
  3894	401463'	260 17 0 00 405543'		PUSHJ	SP,U.29				; SP,BFR%FILL
  3895	401464'	105 17 0 00 777777 		ADJSP	SP,-1				; SP,-1
  3896	401465'	606 01 0 00 000001 		TRNN	AC1,1				; AC1,1
  3897	401466'	254 00 0 00 401471'		JRST	L.106				; L.106
  3898	401467'	201 01 0 00 000003 		MOVEI	AC1,3				; AC1,3
  3899	401470'	254 00 0 00 401472'		JRST	L.107				; L.107
  3900	401471'	201 01 0 00 000012 	L.106:	MOVEI	AC1,12				; AC1,12
  3901					L.107:	POP	SP,AC16				; SP,AC16				
  3902	401472'	262 17 0 00 000016 						2463
  3903	401473'	263 17 0 00 000000 		POPJ	SP,				; SP,
  3904
  3905					; Routine Size:  87 words
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-71
KERMSG	MAC	18-Jan-73 17:20	

  3906
  3907
  3908					;   2590  1	%SBTTL 'SEND%EOF'
  3909					;   2591  1	ROUTINE SEND%EOF =
  3910					;   2592  1	
  3911					;   2593  1	!++
  3912					;   2594  1	! FUNCTIONAL DESCRIPTION:
  3913					;   2595  1	!
  3914					;   2596  1	!	This routine will send the end of file message to the remote
  3915					;   2597  1	!	KERMIT.  It will then determine if there are more files to
  3916					;   2598  1	!	send to the remote.
  3917					;   2599  1	!
  3918					;   2600  1	! CALLING SEQUENCE:
  3919					;   2601  1	!
  3920					;   2602  1	!	STATE = SEND%EOF();
  3921					;   2603  1	!
  3922					;   2604  1	! INPUT PARAMETERS:
  3923					;   2605  1	!
  3924					;   2606  1	!	None.
  3925					;   2607  1	!
  3926					;   2608  1	! IMPLICIT INPUTS:
  3927					;   2609  1	!
  3928					;   2610  1	!	None.
  3929					;   2611  1	!
  3930					;   2612  1	! OUTPUT PARAMETERS:
  3931					;   2613  1	!
  3932					;   2614  1	!	New state to change the finite state machine to.
  3933					;   2615  1	!
  3934					;   2616  1	! IMPLICIT OUTPUTS:
  3935					;   2617  1	!
  3936					;   2618  1	!	None.
  3937					;   2619  1	!
  3938					;   2620  1	! COMPLETION CODES:
  3939					;   2621  1	!
  3940					;   2622  1	!	None.
  3941					;   2623  1	!
  3942					;   2624  1	! SIDE EFFECTS:
  3943					;   2625  1	!
  3944					;   2626  1	!	Sets up for the next file to be processed if there is one.
  3945					;   2627  1	!
  3946					;   2628  1	!--
  3947					;   2629  1	
  3948					;   2630  2	    BEGIN
  3949					;   2631  2	
  3950					;   2632  2	    LOCAL
  3951					;   2633  2		STATUS,					! Status returned by various
  3952					 routines
  3953					;   2634  2		EOF%MSG%LEN;				! Length of EOF message to s
  3954					end
  3955					;   2635  2	
  3956					;   2636  2	!
  3957					;   2637  2	! First determine if we have exceed the number of retries that are
  3958					;   2638  2	! allowed to attempt to send this message.
  3959					;   2639  2	!
  3960					;   2640  2	
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-72
KERMSG	MAC	18-Jan-73 17:20	

  3961					;   2641  2	    IF .NUM%RETRIES GTR .PKT%RETRIES THEN RETURN STATE%ER;
  3962					;   2642  2	
  3963					;   2643  2	!
  3964					;   2644  2	! The number of retries are not exceeded.  Increment the number and then
  3965					;   2645  2	! attempt to send the packet again.
  3966					;   2646  2	!
  3967					;   2647  2	    NUM%RETRIES = .NUM%RETRIES + 1;
  3968					;   2648  2	!
  3969					;   2649  2	! Store character in packet to indicate discard of file
  3970					;   2650  2	! Character will only be sent if file should be discarded
  3971					;   2651  2	!
  3972					;   2652  2	    CH$WCHAR (MSG%EOF%DISCARD, CH$PTR (SND%MSG, PKT%MSG, CHR%SIZE));
  3973					;   2653  2	
  3974					;   2654  2	    IF .ABT%CUR%FILE OR .ABT%ALL%FILE THEN EOF%MSG%LEN = 1 ELSE EOF%MSG%LEN 
  3975					= 0;
  3976					;   2655  2	
  3977					;   2656  2	    IF NOT SEND%PACKET (MSG%EOF, .EOF%MSG%LEN, .MSG%NUMBER) THEN RETURN STAT
  3978					E%EX;
  3979					;   2657  2	
  3980					;   2658  2	!
  3981					;   2659  2	! Now get the responce from the remote KERMIT.
  3982					;   2660  2	!
  3983					;   2661  2	    STATUS = REC%PACKET ();
  3984					;   2662  2	
  3985					;   2663  2	    IF NOT .STATUS
  3986					;   2664  2	    THEN
  3987					;   2665  3		BEGIN
  3988					;   2666  3	
  3989					;   2667  4		IF (.STATUS EQL KER%ZEROLENMSG) OR (.STATUS EQL KER%TIMEOUT) OR (.ST
  3990					ATUS EQL KER%CHKSUMERR)
  3991					;   2668  3		THEN
  3992					;   2669  3		    RETURN .STATE
  3993					;   2670  3		ELSE
  3994					;   2671  3		    RETURN STATE%EX;
  3995					;   2672  3	
  3996					;   2673  2		END;
  3997					;   2674  2	
  3998					;   2675  2	!
  3999					;   2676  2	! Determine if the packet is good.
  4000					;   2677  2	!
  4001					;   2678  2	
  4002					;   2679  3	    IF NOT (.REC%TYPE EQL MSG%ACK OR .REC%TYPE EQL MSG%NAK)
  4003					;   2680  2	    THEN
  4004					;   2681  3		BEGIN
  4005					;   2682  3		KRM%ERROR (KER%PROTOERR);
  4006					;   2683  3		RETURN STATE%A;
  4007					;   2684  2		END;
  4008					;   2685  2	
  4009					;   2686  2	!
  4010					;   2687  2	! If this is a NAK and the message number is not the one we just send
  4011					;   2688  2	! treat this like an ACK, otherwise resend the last packet.
  4012					;   2689  2	!
  4013					;   2690  2	
  4014					;   2691  2	    IF .REC%TYPE EQL MSG%NAK AND (.REC%SEQ NEQ ((.MSG%NUMBER + 1) AND %O'77'
  4015					)) THEN RETURN .STATE;
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-73
KERMSG	MAC	18-Jan-73 17:20	

  4016					;   2692  2	
  4017					;   2693  2	    IF .REC%TYPE EQL MSG%ACK AND .REC%SEQ NEQ .MSG%NUMBER THEN RETURN .STATE
  4018					;
  4019					;   2694  2	
  4020					;   2695  2	!
  4021					;   2696  2	! Here to determine if there is another file to send.
  4022					;   2697  2	!
  4023					;   2698  2	    NUM%RETRIES = 0;
  4024					;   2699  2	    MSG%NUMBER = (.MSG%NUMBER + 1) AND %O'77';
  4025					;   2700  2	
  4026					;   2701  2	    IF NOT .ABT%ALL%FILE THEN STATUS = NEXT%FILE () ELSE STATUS = KER%NOMORF
  4027					ILES;
  4028					;   2702  2	
  4029					;   2703  3	    IF ( NOT .STATUS) OR (.STATUS EQL KER%NOMORFILES)
  4030					;   2704  2	    THEN
  4031					;   2705  3		BEGIN
  4032					;   2706  3	
  4033					;   2707  3		IF (.STATUS NEQ KER%NOMORFILES) THEN RETURN STATE%A ELSE RETURN STAT
  4034					E%SB;
  4035					;   2708  3	
  4036					;   2709  3		END
  4037					;   2710  2	    ELSE
  4038					;   2711  3		BEGIN
  4039					;   2712  3		FILE%OPEN%FLAG = TRUE;			! Have a file open again
  4040					;   2713  3	
  4041					;   2714  3		IF .FIL%NORMAL%FORM THEN NORMALIZE%FILE (FILE%NAME, FILE%SIZE, -1, -
  4042					1);
  4043					;   2715  3	
  4044					;   2716  3		XFR%STATUS (%C'F', %C'S');		! Inform display routine
  4045					;   2717  3	
  4046					;   2718  3		IF ( NOT .CONNECT%FLAG) AND .TY%FIL
  4047					;   2719  3		THEN
  4048					;   2720  4		    BEGIN
  4049					;   2721  4		    TT%TEXT (UPLIT (%ASCIZ'Sending: '));
  4050					;   2722  4		    TT%TEXT (FILE%NAME);
  4051					;   2723  4		    TT%OUTPUT ();
  4052					;   2724  3		    END;
  4053					;   2725  3	
  4054					;   2726  3		FILE%CHARS = 0;				! No characters sent yet
  4055					;   2727  3		RETURN STATE%SF;
  4056					;   2728  2		END;
  4057					;   2729  2	
  4058					;   2730  1	    END;					! End of SEND%EOF
  4059
  4060
  4061	401474'	123 145 156 144 151 0 	P.AAE:	BYTE	(7)"S","e","n","d","i"		; Sendi
  4062	401475'	156 147 072 040 000 0 		BYTE	(7)"n","g",":"," ",000		; ng:
  4063
  4064
  4065					; SEND%EOF
  4066					U.7:	PUSH	SP,AC16				; SP,AC16				
  4067	401476'	261 17 0 00 000016 						2591
  4068						MOVE	AC1,U.52			; AC1,NUM%RETRIES			
  4069	401477'	200 01 0 00 000017'						2641
  4070	401500'	317 01 0 00 401351*		CAMG	AC1,PKT%RETRIES			; AC1,PKT%RETRIES
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-74
KERMSG	MAC	18-Jan-73 17:20	

  4071	401501'	254 00 0 00 401504'		JRST	L.108				; L.108
  4072	401502'	201 01 0 00 000024 		MOVEI	AC1,24				; AC1,24
  4073	401503'	254 00 0 00 401654'		JRST	L.125				; L.125
  4074					L.108:	AOS	U.52				; NUM%RETRIES				
  4075	401504'	350 00 0 00 000017'						2647
  4076						MOVEI	AC2,104				; AC2,104				
  4077	401505'	201 02 0 00 000104 						2652
  4078	401506'	200 01 0 00 401656'		MOVE	AC1,C.33			; AC1,[POINT 8,SND%MSG,31]  <4,8>
  4079	401507'	136 02 0 00 000001 		IDPB	AC2,AC1				; AC2,AC1
  4080						MOVEI	AC1,1				; AC1,1					
  4081	401510'	201 01 0 00 000001 						2654
  4082	401511'	612 01 0 00 401346*		TDNE	AC1,ABT%CUR%FILE		; AC1,ABT%CUR%FILE
  4083	401512'	254 00 0 00 401516'		JRST	L.109				; L.109
  4084	401513'	201 01 0 00 000001 		MOVEI	AC1,1				; AC1,1
  4085	401514'	616 01 0 00 401347*		TDNN	AC1,ABT%ALL%FILE		; AC1,ABT%ALL%FILE
  4086	401515'	254 00 0 00 401520'		JRST	L.110				; L.110
  4087	401516'	201 01 0 00 000001 	L.109:	MOVEI	AC1,1				; EOF%MSG%LEN,1
  4088	401517'	254 00 0 00 401521'		JRST	L.111				; L.111
  4089	401520'	400 01 0 00 000000 	L.110:	SETZ	AC1,				; EOF%MSG%LEN,
  4090					L.111:	PUSH	SP,C.34				; SP,[132]				
  4091	401521'	261 17 0 00 401657'						2656
  4092	401522'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,EOF%MSG%LEN
  4093	401523'	261 17 0 00 000020'		PUSH	SP,U.53				; SP,MSG%NUMBER
  4094	401524'	260 17 0 00 404426'		PUSHJ	SP,U.24				; SP,SEND%PACKET
  4095	401525'	105 17 0 00 777775 		ADJSP	SP,-3				; SP,-3
  4096	401526'	606 01 0 00 000001 		TRNN	AC1,1				; AC1,1
  4097	401527'	254 00 0 00 401541'		JRST	L.112				; L.112
  4098						PUSHJ	SP,U.26				; SP,REC%PACKET				
  4099	401530'	260 17 0 00 404716'						2661
  4100	401531'	200 16 0 00 000001 		MOVE	AC16,AC1			; STATUS,AC1
  4101						TRNE	AC16,1				; STATUS,1				
  4102	401532'	602 16 0 00 000001 						2663
  4103	401533'	254 00 0 00 401543'		JRST	L.113				; L.113
  4104						CAIE	AC16,262			; STATUS,262				
  4105	401534'	302 16 0 00 000262 						2667
  4106	401535'	306 16 0 00 000300 		CAIN	AC16,300			; STATUS,300
  4107	401536'	254 00 0 00 401570'		JRST	L.116				; L.116
  4108	401537'	306 16 0 00 000172 		CAIN	AC16,172			; STATUS,172
  4109						JRST	L.116				; L.116					
  4110	401540'	254 00 0 00 401570'						2669
  4111					L.112:	MOVEI	AC1,23				; AC1,23				
  4112	401541'	201 01 0 00 000023 						2671
  4113						JRST	L.125				; L.125					
  4114	401542'	254 00 0 00 401654'						2665
  4115					L.113:	MOVE	AC1,U.56			; AC1,REC%TYPE				
  4116	401543'	200 01 0 00 000023'						2679
  4117	401544'	302 01 0 00 000131 		CAIE	AC1,131				; AC1,131
  4118	401545'	306 01 0 00 000116 		CAIN	AC1,116				; AC1,116
  4119	401546'	254 00 0 00 401553'		JRST	L.114				; L.114
  4120						PUSH	SP,C.22				; SP,[252]				
  4121	401547'	261 17 0 00 401017'						2682
  4122	401550'	260 17 0 00 401433*		PUSHJ	SP,KRM%ERROR			; SP,KRM%ERROR
  4123						ADJSP	SP,-1				; SP,-1					
  4124	401551'	105 17 0 00 777777 						2683
  4125	401552'	254 00 0 00 401613'		JRST	L.120				; L.120
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-75
KERMSG	MAC	18-Jan-73 17:20	

  4126					L.114:	MOVE	AC2,U.56			; AC2,REC%TYPE				
  4127	401553'	200 02 0 00 000023'						2691
  4128	401554'	302 02 0 00 000116 		CAIE	AC2,116				; AC2,116
  4129	401555'	254 00 0 00 401563'		JRST	L.115				; L.115
  4130	401556'	200 01 0 00 000020'		MOVE	AC1,U.53			; AC1,MSG%NUMBER
  4131	401557'	271 01 0 00 000001 		ADDI	AC1,1				; AC1,1
  4132	401560'	135 03 0 00 401013'		LDB	AC3,C.18			; AC3,[POINT 6,AC1,35]  <0,6>
  4133	401561'	312 03 0 00 000021'		CAME	AC3,U.54			; AC3,REC%SEQ
  4134	401562'	254 00 0 00 401570'		JRST	L.116				; L.116
  4135					L.115:	CAIE	AC2,131				; AC2,131				
  4136	401563'	302 02 0 00 000131 						2693
  4137	401564'	254 00 0 00 401572'		JRST	L.117				; L.117
  4138	401565'	200 01 0 00 000021'		MOVE	AC1,U.54			; AC1,REC%SEQ
  4139	401566'	316 01 0 00 000020'		CAMN	AC1,U.53			; AC1,MSG%NUMBER
  4140	401567'	254 00 0 00 401572'		JRST	L.117				; L.117
  4141	401570'	200 01 0 00 000014'	L.116:	MOVE	AC1,U.49			; AC1,STATE
  4142	401571'	254 00 0 00 401654'		JRST	L.125				; L.125
  4143					L.117:	SETZM	U.52				; NUM%RETRIES				
  4144	401572'	402 00 0 00 000017'						2698
  4145						MOVE	AC1,U.53			; AC1,MSG%NUMBER			
  4146	401573'	200 01 0 00 000020'						2699
  4147	401574'	271 01 0 00 000001 		ADDI	AC1,1				; AC1,1
  4148	401575'	135 02 0 00 401013'		LDB	AC2,C.18			; AC2,[POINT 6,AC1,35]  <0,6>
  4149	401576'	202 02 0 00 000020'		MOVEM	AC2,U.53			; AC2,MSG%NUMBER
  4150						MOVEI	AC1,1				; AC1,1					
  4151	401577'	201 01 0 00 000001 						2701
  4152	401600'	612 01 0 00 401514*		TDNE	AC1,ABT%ALL%FILE		; AC1,ABT%ALL%FILE
  4153	401601'	254 00 0 00 401604'		JRST	L.118				; L.118
  4154	401602'	260 17 0 00 000000*		PUSHJ	SP,NEXT%FILE			; SP,NEXT%FILE
  4155	401603'	334 16 0 00 000001 		SKIPA	AC16,AC1			; STATUS,AC1
  4156	401604'	201 16 0 00 000133 	L.118:	MOVEI	AC16,133			; STATUS,133
  4157						TRNN	AC16,1				; STATUS,1				
  4158	401605'	606 16 0 00 000001 						2703
  4159	401606'	254 00 0 00 401611'		JRST	L.119				; L.119
  4160	401607'	302 16 0 00 000133 		CAIE	AC16,133			; STATUS,133
  4161	401610'	254 00 0 00 401617'		JRST	L.122				; L.122
  4162					L.119:	CAIN	AC16,133			; STATUS,133				
  4163	401611'	306 16 0 00 000133 						2707
  4164	401612'	254 00 0 00 401615'		JRST	L.121				; L.121
  4165	401613'	201 01 0 00 000012 	L.120:	MOVEI	AC1,12				; AC1,12
  4166	401614'	254 00 0 00 401654'		JRST	L.125				; L.125
  4167	401615'	201 01 0 00 000005 	L.121:	MOVEI	AC1,5				; AC1,5
  4168						JRST	L.125				; L.125					
  4169	401616'	254 00 0 00 401654'						2711
  4170					L.122:	MOVEI	AC1,1				; AC1,1					
  4171	401617'	201 01 0 00 000001 						2712
  4172	401620'	202 01 0 00 000104'		MOVEM	AC1,U.59			; AC1,FILE%OPEN%FLAG
  4173						MOVEI	AC1,1				; AC1,1					
  4174	401621'	201 01 0 00 000001 						2714
  4175	401622'	616 01 0 00 400071*		TDNN	AC1,FIL%NORMAL%FORM		; AC1,FIL%NORMAL%FORM
  4176	401623'	254 00 0 00 401632'		JRST	L.123				; L.123
  4177	401624'	261 17 0 00 401660'		PUSH	SP,C.35				; SP,[0,,FILE%NAME]
  4178	401625'	261 17 0 00 401661'		PUSH	SP,C.36				; SP,[0,,FILE%SIZE]
  4179	401626'	261 17 0 00 401662'		PUSH	SP,C.37				; SP,[-1]
  4180	401627'	261 17 0 00 401662'		PUSH	SP,C.37				; SP,[-1]
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-76
KERMSG	MAC	18-Jan-73 17:20	

  4181	401630'	260 17 0 00 405277'		PUSHJ	SP,U.27				; SP,NORMALIZE%FILE
  4182	401631'	105 17 0 00 777774 		ADJSP	SP,-4				; SP,-4
  4183					L.123:	PUSH	SP,C.15				; SP,[106]				
  4184	401632'	261 17 0 00 400603'						2716
  4185	401633'	261 17 0 00 400220'		PUSH	SP,C.8				; SP,[123]
  4186	401634'	260 17 0 00 401333*		PUSHJ	SP,XFR%STATUS			; SP,XFR%STATUS
  4187						MOVEI	AC1,1				; AC1,1					
  4188	401635'	201 01 0 00 000001 						2718
  4189	401636'	612 01 0 00 401267*		TDNE	AC1,CONNECT%FLAG		; AC1,CONNECT%FLAG
  4190	401637'	254 00 0 00 401651'		JRST	L.124				; L.124
  4191	401640'	201 01 0 00 000001 		MOVEI	AC1,1				; AC1,1
  4192	401641'	616 01 0 00 401272*		TDNN	AC1,TY%FIL			; AC1,TY%FIL
  4193	401642'	254 00 0 00 401651'		JRST	L.124				; L.124
  4194						PUSH	SP,C.38				; SP,[0,,P.AAE]				
  4195	401643'	261 17 0 00 401663'						2721
  4196	401644'	260 17 0 00 401307*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
  4197						PUSH	SP,C.35				; SP,[0,,FILE%NAME]			
  4198	401645'	261 17 0 00 401660'						2722
  4199	401646'	260 17 0 00 401644*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
  4200						PUSHJ	SP,TT%OUTPUT			; SP,TT%OUTPUT				
  4201	401647'	260 17 0 00 401053*						2723
  4202						ADJSP	SP,-2				; SP,-2					
  4203	401650'	105 17 0 00 777776 						2720
  4204					L.124:	SETZM	U.60				; FILE%CHARS				
  4205	401651'	402 00 0 00 000105'						2726
  4206						ADJSP	SP,-2				; SP,-2					
  4207	401652'	105 17 0 00 777776 						2711
  4208	401653'	201 01 0 00 000002 		MOVEI	AC1,2				; AC1,2
  4209					L.125:	POP	SP,AC16				; SP,AC16				
  4210	401654'	262 17 0 00 000016 						2591
  4211	401655'	263 17 0 00 000000 		POPJ	SP,				; SP,
  4212	401656'	04 10 0 00 000054'	C.33:	POINT	8,U.58,31			; 8,SND%MSG,31
  4213	401657'	000000	000132		C.34:	EXP	132				; 132
  4214	401660'	000000	401014*		C.35:	XWD	0,FILE%NAME			; 0,FILE%NAME
  4215	401661'	000000	401365*		C.36:	XWD	0,FILE%SIZE			; 0,FILE%SIZE
  4216	401662'	777777	777777		C.37:	EXP	-1				; -1
  4217	401663'	000000	401474'		C.38:	XWD	0,P.AAE				; 0,P.AAE
  4218
  4219					; Routine Size:  118 words
  4220
  4221
  4222					;   2731  1	%SBTTL 'SEND%INIT'
  4223					;   2732  1	ROUTINE SEND%INIT =
  4224					;   2733  1	
  4225					;   2734  1	!++
  4226					;   2735  1	! FUNCTIONAL DESCRIPTION:
  4227					;   2736  1	!
  4228					;   2737  1	!	This routine will send the initialization packet to the remote
  4229					;   2738  1	!	KERMIT.  The message type sent is S.
  4230					;   2739  1	!
  4231					;   2740  1	! CALLING SEQUENCE:
  4232					;   2741  1	!
  4233					;   2742  1	!	STATE = SEND%INIT();
  4234					;   2743  1	!
  4235					;   2744  1	! INPUT PARAMETERS:
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-77
KERMSG	MAC	18-Jan-73 17:20	

  4236					;   2745  1	!
  4237					;   2746  1	!	None.
  4238					;   2747  1	!
  4239					;   2748  1	! IMPLICIT INPUTS:
  4240					;   2749  1	!
  4241					;   2750  1	!	None.
  4242					;   2751  1	!
  4243					;   2752  1	! OUTPUT PARAMETERS:
  4244					;   2753  1	!
  4245					;   2754  1	!	New state to change the finite state machine to.
  4246					;   2755  1	!
  4247					;   2756  1	! IMPLICIT OUTPUTS:
  4248					;   2757  1	!
  4249					;   2758  1	!	None.
  4250					;   2759  1	!
  4251					;   2760  1	! COMPLETION CODES:
  4252					;   2761  1	!
  4253					;   2762  1	!	None.
  4254					;   2763  1	!
  4255					;   2764  1	! SIDE EFFECTS:
  4256					;   2765  1	!
  4257					;   2766  1	!	None.
  4258					;   2767  1	!
  4259					;   2768  1	!--
  4260					;   2769  1	
  4261					;   2770  2	    BEGIN
  4262					;   2771  2	
  4263					;   2772  2	    LOCAL
  4264					;   2773  2		STATUS;					! Status returned by various
  4265					 routines
  4266					;   2774  2	
  4267					;   2775  2	    SET%SEND%INIT ();
  4268					;   2776  2	
  4269					;   2777  2	    IF .NUM%RETRIES GTR .SI%RETRIES THEN RETURN STATE%ER;
  4270					;   2778  2	
  4271					;   2779  2	!
  4272					;   2780  2	! Count the number of times we try this
  4273					;   2781  2	!
  4274					;   2782  2	    NUM%RETRIES = .NUM%RETRIES + 1;
  4275					;   2783  2	
  4276					;   2784  2	    IF NOT SEND%PACKET (MSG%SND%INIT, P%SI%LENGTH, .MSG%NUMBER) THEN RETURN 
  4277					STATE%EX;
  4278					;   2785  2	
  4279					;   2786  2	!
  4280					;   2787  2	! Determine if we received a packet it good condition.  If we timed out or
  4281					;   2788  2	! got an illegal message, just try again.
  4282					;   2789  2	!
  4283					;   2790  2	    STATUS = REC%PACKET ();
  4284					;   2791  2	
  4285					;   2792  2	    IF NOT .STATUS
  4286					;   2793  2	    THEN
  4287					;   2794  3		BEGIN
  4288					;   2795  3	
  4289					;   2796  4		IF (.STATUS EQL KER%ZEROLENMSG) OR (.STATUS EQL KER%TIMEOUT) OR (.ST
  4290					ATUS EQL KER%CHKSUMERR)
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-78
KERMSG	MAC	18-Jan-73 17:20	

  4291					;   2797  3		THEN
  4292					;   2798  3		    RETURN .STATE
  4293					;   2799  3		ELSE
  4294					;   2800  3		    RETURN STATE%EX;
  4295					;   2801  3	
  4296					;   2802  2		END;
  4297					;   2803  2	
  4298					;   2804  2	!
  4299					;   2805  2	! Determine if the packet is good.
  4300					;   2806  2	!
  4301					;   2807  2	
  4302					;   2808  2	    IF .REC%TYPE NEQ MSG%ACK THEN RETURN .STATE;
  4303					;   2809  2	
  4304					;   2810  2	    IF .REC%SEQ NEQ .MSG%NUMBER THEN RETURN .STATE;
  4305					;   2811  2	
  4306					;   2812  2	!
  4307					;   2813  2	! Here if we have an ACK for the initialization message that was just sent
  4308					;   2814  2	! to the remote KERMIT.
  4309					;   2815  2	!
  4310					;   2816  2	
  4311					;   2817  2	    IF NOT (STATUS = PRS%SEND%INIT ()) THEN RETURN STATE%A;
  4312					;   2818  2	
  4313					;   2819  2	    BLK%CHK%TYPE = .INI%CHK%TYPE;		! We now use agreed upon blo
  4314					ck check type
  4315					;   2820  2	    NUM%RETRIES = 0;
  4316					;   2821  2	    MSG%NUMBER = (.MSG%NUMBER + 1) AND %O'77';
  4317					;   2822  2	    RETURN STATE%OF;				! Now need to open the file
  4318					;   2823  1	    END;
  4319
  4320
  4321					; SEND%INIT
  4322					U.8:	PUSHJ	SP,U.20				; SP,SET%SEND%INIT			
  4323	401664'	260 17 0 00 404355'						2775
  4324						MOVE	AC1,U.52			; AC1,NUM%RETRIES			
  4325	401665'	200 01 0 00 000017'						2777
  4326	401666'	317 01 0 00 401032*		CAMG	AC1,SI%RETRIES			; AC1,SI%RETRIES
  4327	401667'	254 00 0 00 401672'		JRST	L.126				; L.126
  4328	401670'	201 01 0 00 000024 		MOVEI	AC1,24				; AC1,24
  4329	401671'	263 17 0 00 000000 		POPJ	SP,				; SP,
  4330					L.126:	AOS	U.52				; NUM%RETRIES				
  4331	401672'	350 00 0 00 000017'						2782
  4332						PUSH	SP,C.8				; SP,[123]				
  4333	401673'	261 17 0 00 400220'						2784
  4334	401674'	261 17 0 00 401016'		PUSH	SP,C.21				; SP,[11]
  4335	401675'	261 17 0 00 000020'		PUSH	SP,U.53				; SP,MSG%NUMBER
  4336	401676'	260 17 0 00 404426'		PUSHJ	SP,U.24				; SP,SEND%PACKET
  4337	401677'	105 17 0 00 777775 		ADJSP	SP,-3				; SP,-3
  4338	401700'	602 01 0 00 000001 		TRNE	AC1,1				; AC1,1
  4339	401701'	254 00 0 00 401704'		JRST	L.127				; L.127
  4340	401702'	201 01 0 00 000023 		MOVEI	AC1,23				; AC1,23
  4341	401703'	263 17 0 00 000000 		POPJ	SP,				; SP,
  4342					L.127:	PUSHJ	SP,U.26				; SP,REC%PACKET				
  4343	401704'	260 17 0 00 404716'						2790
  4344						TRNE	AC1,1				; STATUS,1				
  4345	401705'	602 01 0 00 000001 						2792
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-79
KERMSG	MAC	18-Jan-73 17:20	

  4346	401706'	254 00 0 00 401717'		JRST	L.129				; L.129
  4347						CAIE	AC1,262				; STATUS,262				
  4348	401707'	302 01 0 00 000262 						2796
  4349	401710'	306 01 0 00 000300 		CAIN	AC1,300				; STATUS,300
  4350	401711'	254 00 0 00 401713'		JRST	L.128				; L.128
  4351	401712'	306 01 0 00 000172 		CAIN	AC1,172				; STATUS,172
  4352					L.128:	SKIPA	AC2,U.49			; AC2,STATE				
  4353	401713'	334 02 0 00 000014'						2800
  4354	401714'	201 02 0 00 000023 		MOVEI	AC2,23				; AC2,23
  4355						MOVE	AC1,AC2				; AC1,AC2				
  4356	401715'	200 01 0 00 000002 						2794
  4357	401716'	263 17 0 00 000000 		POPJ	SP,				; SP,
  4358					L.129:	MOVEI	AC2,131				; AC2,131				
  4359	401717'	201 02 0 00 000131 						2808
  4360	401720'	312 02 0 00 000023'		CAME	AC2,U.56			; AC2,REC%TYPE
  4361	401721'	254 00 0 00 401725'		JRST	L.130				; L.130
  4362						MOVE	AC2,U.54			; AC2,REC%SEQ				
  4363	401722'	200 02 0 00 000021'						2810
  4364	401723'	316 02 0 00 000020'		CAMN	AC2,U.53			; AC2,MSG%NUMBER
  4365	401724'	254 00 0 00 401727'		JRST	L.131				; L.131
  4366	401725'	200 01 0 00 000014'	L.130:	MOVE	AC1,U.49			; AC1,STATE
  4367	401726'	263 17 0 00 000000 		POPJ	SP,				; SP,
  4368					L.131:	PUSHJ	SP,U.21				; SP,PRS%SEND%INIT			
  4369	401727'	260 17 0 00 404103'						2817
  4370	401730'	602 01 0 00 000001 		TRNE	AC1,1				; STATUS,1
  4371	401731'	254 00 0 00 401734'		JRST	L.132				; L.132
  4372	401732'	201 01 0 00 000012 		MOVEI	AC1,12				; AC1,12
  4373	401733'	263 17 0 00 000000 		POPJ	SP,				; SP,
  4374					L.132:	MOVE	AC1,U.45			; AC1,INI%CHK%TYPE			
  4375	401734'	200 01 0 00 000010'						2819
  4376	401735'	202 01 0 00 000011'		MOVEM	AC1,U.46			; AC1,BLK%CHK%TYPE
  4377						SETZM	U.52				; NUM%RETRIES				
  4378	401736'	402 00 0 00 000017'						2820
  4379						MOVE	AC1,U.53			; AC1,MSG%NUMBER			
  4380	401737'	200 01 0 00 000020'						2821
  4381	401740'	271 01 0 00 000001 		ADDI	AC1,1				; AC1,1
  4382	401741'	135 02 0 00 401013'		LDB	AC2,C.18			; AC2,[POINT 6,AC1,35]  <0,6>
  4383	401742'	202 02 0 00 000020'		MOVEM	AC2,U.53			; AC2,MSG%NUMBER
  4384						MOVEI	AC1,22				; AC1,22				
  4385	401743'	201 01 0 00 000022 						2770
  4386						POPJ	SP,				; SP,					
  4387	401744'	263 17 0 00 000000 						2732
  4388
  4389					; Routine Size:  49 words
  4390
  4391
  4392					;   2824  1	%SBTTL 'SEND%OPEN%FILE - Open file for sending'
  4393					;   2825  1	ROUTINE SEND%OPEN%FILE =
  4394					;   2826  1	
  4395					;   2827  1	!++
  4396					;   2828  1	! FUNCTIONAL DESCRIPTION:
  4397					;   2829  1	!
  4398					;   2830  1	! This routine is called from DO%TRANSACTION when the first input file
  4399					;   2831  1	! needs to be opened.
  4400					;   2832  1	!
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-80
KERMSG	MAC	18-Jan-73 17:20	

  4401					;   2833  1	! CALLING SEQUENCE:
  4402					;   2834  1	!
  4403					;   2835  1	!	STATE = SEND%OPEN%FILE ();
  4404					;   2836  1	!
  4405					;   2837  1	! INPUT PARAMETERS:
  4406					;   2838  1	!
  4407					;   2839  1	!	None.
  4408					;   2840  1	!
  4409					;   2841  1	! IMPLICIT INPUTS:
  4410					;   2842  1	!
  4411					;   2843  1	!	FILE%NAME, FILE%SIZE, etc.
  4412					;   2844  1	!
  4413					;   2845  1	! OUPTUT PARAMETERS:
  4414					;   2846  1	!
  4415					;   2847  1	!	New state for FSM.
  4416					;   2848  1	!
  4417					;   2849  1	! IMPLICIT OUTPUTS:
  4418					;   2850  1	!
  4419					;   2851  1	!	None.
  4420					;   2852  1	!
  4421					;   2853  1	! COMPLETION CODES:
  4422					;   2854  1	!
  4423					;   2855  1	!	None.
  4424					;   2856  1	!
  4425					;   2857  1	! SIDE EFFECTS:
  4426					;   2858  1	!
  4427					;   2859  1	!	None.
  4428					;   2860  1	!
  4429					;   2861  1	!--
  4430					;   2862  1	
  4431					;   2863  2	    BEGIN
  4432					;   2864  2	
  4433					;   2865  2	    IF ( NOT .CONNECT%FLAG) AND .TY%FIL
  4434					;   2866  2	    THEN
  4435					;   2867  3		BEGIN
  4436					;   2868  3		TT%TEXT (UPLIT (%ASCIZ'Sending: '));
  4437					;   2869  3		TT%OUTPUT ();
  4438					;   2870  2		END;
  4439					;   2871  2	
  4440					;   2872  2	    FILE%CHARS = 0;				! No characters sent yet
  4441					;   2873  2	
  4442					;   2874  2	    IF NOT .NO%FILE%NEEDED
  4443					;   2875  2	    THEN
  4444					;   2876  2	
  4445					;   2877  2		IF NOT FILE%OPEN (FNC%READ) THEN RETURN STATE%A ELSE FILE%OPEN%FLAG 
  4446					= TRUE;
  4447					;   2878  2	
  4448					;   2879  2	![023]
  4449					;   2880  2	![023] If we want normalized file names, beat up the name now
  4450					;   2881  2	![023]
  4451					;   2882  2	
  4452					;   2883  2	    IF .FIL%NORMAL%FORM THEN NORMALIZE%FILE (FILE%NAME, FILE%SIZE, -1, -1);
  4453					;   2884  2	
  4454					;   2885  2	    XFR%STATUS (%C'F', %C'S');			! Inform display routine
  4455					;   2886  2	
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-81
KERMSG	MAC	18-Jan-73 17:20	

  4456					;   2887  2	    IF ( NOT .CONNECT%FLAG) AND .TY%FIL
  4457					;   2888  2	    THEN
  4458					;   2889  3		BEGIN
  4459					;   2890  3		TT%TEXT (FILE%NAME);
  4460					;   2891  3		TT%OUTPUT ();
  4461					;   2892  2		END;
  4462					;   2893  2	
  4463					;   2894  2	    RETURN STATE%SF;
  4464					;   2895  1	    END;					! End of FSM%OPEN%FILE
  4465
  4466
  4467	401745'	123 145 156 144 151 0 	P.AAF:	BYTE	(7)"S","e","n","d","i"		; Sendi
  4468	401746'	156 147 072 040 000 0 		BYTE	(7)"n","g",":"," ",000		; ng:
  4469
  4470
  4471					; SEND%OPEN%FILE
  4472					U.5:	MOVEI	AC1,1				; AC1,1					
  4473	401747'	201 01 0 00 000001 						2865
  4474	401750'	612 01 0 00 401636*		TDNE	AC1,CONNECT%FLAG		; AC1,CONNECT%FLAG
  4475	401751'	254 00 0 00 401761'		JRST	L.133				; L.133
  4476	401752'	201 01 0 00 000001 		MOVEI	AC1,1				; AC1,1
  4477	401753'	616 01 0 00 401641*		TDNN	AC1,TY%FIL			; AC1,TY%FIL
  4478	401754'	254 00 0 00 401761'		JRST	L.133				; L.133
  4479						PUSH	SP,C.39				; SP,[0,,P.AAF]				
  4480	401755'	261 17 0 00 402027'						2868
  4481	401756'	260 17 0 00 401646*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
  4482						PUSHJ	SP,TT%OUTPUT			; SP,TT%OUTPUT				
  4483	401757'	260 17 0 00 401647*						2869
  4484						ADJSP	SP,-1				; SP,-1					
  4485	401760'	105 17 0 00 777777 						2867
  4486					L.133:	SETZM	U.60				; FILE%CHARS				
  4487	401761'	402 00 0 00 000105'						2872
  4488						MOVEI	AC1,1				; AC1,1					
  4489	401762'	201 01 0 00 000001 						2874
  4490	401763'	612 01 0 00 000107'		TDNE	AC1,U.62			; AC1,NO%FILE%NEEDED
  4491	401764'	254 00 0 00 401776'		JRST	L.135				; L.135
  4492						PUSH	SP,C.26				; SP,[0]				
  4493	401765'	261 17 0 00 401023'						2877
  4494	401766'	260 17 0 00 000000*		PUSHJ	SP,FILE%OPEN			; SP,FILE%OPEN
  4495	401767'	105 17 0 00 777777 		ADJSP	SP,-1				; SP,-1
  4496	401770'	602 01 0 00 000001 		TRNE	AC1,1				; AC1,1
  4497	401771'	254 00 0 00 401774'		JRST	L.134				; L.134
  4498	401772'	201 01 0 00 000012 		MOVEI	AC1,12				; AC1,12
  4499	401773'	263 17 0 00 000000 		POPJ	SP,				; SP,
  4500	401774'	201 01 0 00 000001 	L.134:	MOVEI	AC1,1				; AC1,1
  4501	401775'	202 01 0 00 000104'		MOVEM	AC1,U.59			; AC1,FILE%OPEN%FLAG
  4502					L.135:	MOVEI	AC1,1				; AC1,1					
  4503	401776'	201 01 0 00 000001 						2883
  4504	401777'	616 01 0 00 401622*		TDNN	AC1,FIL%NORMAL%FORM		; AC1,FIL%NORMAL%FORM
  4505	402000'	254 00 0 00 402007'		JRST	L.136				; L.136
  4506	402001'	261 17 0 00 401660'		PUSH	SP,C.35				; SP,[0,,FILE%NAME]
  4507	402002'	261 17 0 00 401661'		PUSH	SP,C.36				; SP,[0,,FILE%SIZE]
  4508	402003'	261 17 0 00 401662'		PUSH	SP,C.37				; SP,[-1]
  4509	402004'	261 17 0 00 401662'		PUSH	SP,C.37				; SP,[-1]
  4510	402005'	260 17 0 00 405277'		PUSHJ	SP,U.27				; SP,NORMALIZE%FILE
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-82
KERMSG	MAC	18-Jan-73 17:20	

  4511	402006'	105 17 0 00 777774 		ADJSP	SP,-4				; SP,-4
  4512					L.136:	PUSH	SP,C.15				; SP,[106]				
  4513	402007'	261 17 0 00 400603'						2885
  4514	402010'	261 17 0 00 400220'		PUSH	SP,C.8				; SP,[123]
  4515	402011'	260 17 0 00 401634*		PUSHJ	SP,XFR%STATUS			; SP,XFR%STATUS
  4516						MOVEI	AC1,1				; AC1,1					
  4517	402012'	201 01 0 00 000001 						2887
  4518	402013'	612 01 0 00 401750*		TDNE	AC1,CONNECT%FLAG		; AC1,CONNECT%FLAG
  4519	402014'	254 00 0 00 402024'		JRST	L.137				; L.137
  4520	402015'	201 01 0 00 000001 		MOVEI	AC1,1				; AC1,1
  4521	402016'	616 01 0 00 401753*		TDNN	AC1,TY%FIL			; AC1,TY%FIL
  4522	402017'	254 00 0 00 402024'		JRST	L.137				; L.137
  4523						PUSH	SP,C.35				; SP,[0,,FILE%NAME]			
  4524	402020'	261 17 0 00 401660'						2890
  4525	402021'	260 17 0 00 401756*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
  4526						PUSHJ	SP,TT%OUTPUT			; SP,TT%OUTPUT				
  4527	402022'	260 17 0 00 401757*						2891
  4528						ADJSP	SP,-1				; SP,-1					
  4529	402023'	105 17 0 00 777777 						2889
  4530					L.137:	ADJSP	SP,-2				; SP,-2					
  4531	402024'	105 17 0 00 777776 						2894
  4532						MOVEI	AC1,2				; AC1,2					
  4533	402025'	201 01 0 00 000002 						2863
  4534						POPJ	SP,				; SP,					
  4535	402026'	263 17 0 00 000000 						2825
  4536	402027'	000000	401745'		C.39:	XWD	0,P.AAF				; 0,P.AAF
  4537
  4538					; Routine Size:  49 words
  4539
  4540
  4541					;   2896  1	%SBTTL 'SEND%GENCMD'
  4542					;   2897  1	ROUTINE SEND%GENCMD =
  4543					;   2898  1	
  4544					;   2899  1	!++
  4545					;   2900  1	! FUNCTIONAL DESCRIPTION:
  4546					;   2901  1	!
  4547					;   2902  1	!	This routine will send a command packet to the server Kermit.
  4548					;   2903  1	!	The new state will depend upon the response.  If a send-init
  4549					;   2904  1	!	is received, it will process it and switch to STATE%RF.
  4550					;   2905  1	!	If a text-header is received it will switch to STATE%RD.
  4551					;   2906  1	!	If an ACK is received, it will type the data portion and
  4552					;   2907  1	!	switch to STATE%C.
  4553					;   2908  1	!
  4554					;   2909  1	! CALLING SEQUENCE:
  4555					;   2910  1	!
  4556					;   2911  1	!	STATE = SEND%GENCMD();
  4557					;   2912  1	!
  4558					;   2913  1	! INPUT PARAMETERS:
  4559					;   2914  1	!
  4560					;   2915  1	!	None.
  4561					;   2916  1	!
  4562					;   2917  1	! IMPLICIT INPUTS:
  4563					;   2918  1	!
  4564					;   2919  1	!	GEN%TYPE - Message type to send (normally MSG%GENERIC)
  4565					;   2920  1	!	GEN%SUBTYPE - Message subtype (only if MSG%GENERIC)
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-83
KERMSG	MAC	18-Jan-73 17:20	

  4566					;   2921  1	!	GEN%1DATA - First argument string
  4567					;   2922  1	!	GEN%1SIZE - Size of first argument
  4568					;   2923  1	!	GEN%2DATA - Second argument string
  4569					;   2924  1	!	GEN%2SIZE - Size of second argument
  4570					;   2925  1	!	GEN%3DATA - Third argument string
  4571					;   2926  1	!	GEN%3SIZE - Size of third argument
  4572					;   2927  1	!
  4573					;   2928  1	! OUTPUT PARAMETERS:
  4574					;   2929  1	!
  4575					;   2930  1	!	New state for the finite state machine.
  4576					;   2931  1	!
  4577					;   2932  1	! IMPLICIT OUTPUTS:
  4578					;   2933  1	!
  4579					;   2934  1	!	None.
  4580					;   2935  1	!
  4581					;   2936  1	! COMPLETION CODES:
  4582					;   2937  1	!
  4583					;   2938  1	!	None.
  4584					;   2939  1	!
  4585					;   2940  1	! SIDE EFFECTS:
  4586					;   2941  1	!
  4587					;   2942  1	!	None.
  4588					;   2943  1	!
  4589					;   2944  1	!--
  4590					;   2945  1	
  4591					;   2946  2	    BEGIN
  4592					;   2947  2	
  4593					;   2948  2	    LOCAL
  4594					;   2949  2		POINTER,				! Pointer at DATA%TEXT
  4595					;   2950  2		DATA%TEXT : VECTOR [CH$ALLOCATION (MAX%MSG)],	! Data buffer
  4596					;   2951  2		DATA%SIZE,				! Length of data buffer used
  4597
  4598					;   2952  2		STATUS;					! Status returned by various
  4599					 routines
  4600					;   2953  2	
  4601					;   2954  2	    ROUTINE PACK%DATA (POINTER, LENGTH, SRC%ADDR, SRC%LEN) =
  4602					;   2955  2	!
  4603					;   2956  2	! Routine to pack an argument into the buffer.
  4604					;   2957  2	!
  4605					;   2958  3		BEGIN
  4606					;   2959  3	
  4607					;   2960  3		IF .SRC%LEN GTR MAX%MSG - .LENGTH - 1 THEN SRC%LEN = MAX%MSG - .LENG
  4608					TH - 1;
  4609					;   2961  3	
  4610					;   2962  3		LENGTH = .LENGTH + .SRC%LEN + 1;
  4611					;   2963  3		CH$WCHAR%A (CHAR (.SRC%LEN), .POINTER);
  4612					;   2964  3		.POINTER = CH$MOVE (.SRC%LEN, CH$PTR (.SRC%ADDR), ..POINTER);
  4613					;   2965  3		RETURN .LENGTH;
  4614					;   2966  2		END;
  4615
  4616
  4617					; PACK%DATA
  4618					U.75:	MOVE	AC1,-3(SP)			; AC1,LENGTH				
  4619	402030'	200 01 0 17 777775 						2960
  4620	402031'	275 01 0 00 000137 		SUBI	AC1,137				; AC1,137
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-84
KERMSG	MAC	18-Jan-73 17:20	

  4621	402032'	210 02 0 00 000001 		MOVN	AC2,AC1				; AC2,AC1
  4622	402033'	315 02 0 17 777777 		CAMGE	AC2,-1(SP)			; AC2,SRC%LEN
  4623	402034'	212 01 0 17 777777 		MOVNM	AC1,-1(SP)			; AC1,SRC%LEN
  4624						MOVE	AC1,-3(SP)			; AC1,LENGTH				
  4625	402035'	200 01 0 17 777775 						2962
  4626	402036'	270 01 0 17 777777 		ADD	AC1,-1(SP)			; AC1,SRC%LEN
  4627	402037'	271 01 0 00 000001 		ADDI	AC1,1				; AC1,1
  4628	402040'	202 01 0 17 777775 		MOVEM	AC1,-3(SP)			; AC1,LENGTH
  4629						MOVE	AC2,-1(SP)			; AC2,SRC%LEN				
  4630	402041'	200 02 0 17 777777 						2963
  4631	402042'	271 02 0 00 000040 		ADDI	AC2,40				; AC2,40
  4632	402043'	200 01 0 17 777774 		MOVE	AC1,-4(SP)			; AC1,POINTER
  4633	402044'	136 02 0 01 000000 		IDPB	AC2,0(AC1)			; AC2,0(AC1)
  4634						MOVE	AC3,-4(SP)			; AC3,POINTER				
  4635	402045'	200 03 0 17 777774 						2964
  4636	402046'	200 01 0 17 777776 		MOVE	AC1,-2(SP)			; AC1,SRC%ADDR
  4637	402047'	201 02 0 01 777777 		MOVEI	AC2,-1(AC1)			; AC2,-1(AC1)
  4638	402050'	505 02 0 00 010700 		HRLI	AC2,10700			; AC2,10700
  4639	402051'	200 01 0 17 777777 		MOVE	AC1,-1(SP)			; AC1,SRC%LEN
  4640	402052'	200 04 0 17 777777 		MOVE	AC4,-1(SP)			; AC4,SRC%LEN
  4641	402053'	200 05 0 03 000000 		MOVE	AC5,0(AC3)			; AC5,0(AC3)
  4642	402054'	123 01 0 00 400256'		EXTEND	AC1,C.9				; AC1,[MOVSLJ ]
  4643	402055'	255 00 0 00 000000 		JFCL					;
  4644	402056'	202 05 0 03 000000 		MOVEM	AC5,0(AC3)			; AC5,0(AC3)
  4645						MOVE	AC1,-3(SP)			; AC1,LENGTH				
  4646	402057'	200 01 0 17 777775 						2958
  4647						POPJ	SP,				; SP,					
  4648	402060'	263 17 0 00 000000 						2954
  4649
  4650					; Routine Size:  25 words
  4651
  4652
  4653					;   2967  2	!
  4654					;   2968  2	! First determine if we have exceed the number of retries that are
  4655					;   2969  2	! allowed to attempt to send this message.
  4656					;   2970  2	!
  4657					;   2971  2	
  4658					;   2972  2	    IF .NUM%RETRIES GTR .PKT%RETRIES THEN RETURN STATE%ER;
  4659					;   2973  2	
  4660					;   2974  2	!
  4661					;   2975  2	! The number of retries are not exceeded.  Increment the number and then
  4662					;   2976  2	! attempt to send the packet again.
  4663					;   2977  2	!
  4664					;   2978  2	    NUM%RETRIES = .NUM%RETRIES + 1;
  4665					;   2979  2	!
  4666					;   2980  2	! Build the packet data field
  4667					;   2981  2	!
  4668					;   2982  2	    POINTER = CH$PTR (DATA%TEXT);
  4669					;   2983  2	    DATA%SIZE = 0;
  4670					;   2984  2	
  4671					;   2985  2	    IF .GEN%TYPE EQL MSG%GENERIC
  4672					;   2986  2	    THEN
  4673					;   2987  3		BEGIN
  4674					;   2988  3		CH$WCHAR%A (.GEN%SUBTYPE, POINTER);
  4675					;   2989  3		DATA%SIZE = 1;
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-85
KERMSG	MAC	18-Jan-73 17:20	

  4676					;   2990  3	
  4677					;   2991  3		IF .GEN%1SIZE GTR 0 OR .GEN%2SIZE GTR 0 OR .GEN%3SIZE GTR 0
  4678					;   2992  3		THEN
  4679					;   2993  4		    BEGIN
  4680					;   2994  4		    DATA%SIZE = PACK%DATA (POINTER, .DATA%SIZE, GEN%1DATA, .GEN%1SIZ
  4681					E);
  4682					;   2995  4	
  4683					;   2996  4		    IF .GEN%2SIZE GTR 0 OR .GEN%3SIZE GTR 0
  4684					;   2997  4		    THEN
  4685					;   2998  5			BEGIN
  4686					;   2999  5			DATA%SIZE = PACK%DATA (POINTER, .DATA%SIZE, GEN%2DATA, .GEN%
  4687					2SIZE);
  4688					;   3000  5	
  4689					;   3001  5			IF .GEN%3SIZE GTR 0
  4690					;   3002  5			THEN
  4691					;   3003  6			    BEGIN
  4692					;   3004  6			    DATA%SIZE = PACK%DATA (POINTER, .DATA%SIZE, GEN%3DATA, .
  4693					GEN%3SIZE);
  4694					;   3005  5			    END;
  4695					;   3006  5	
  4696					;   3007  4			END;
  4697					;   3008  4	
  4698					;   3009  3		    END;
  4699					;   3010  3	
  4700					;   3011  3		END
  4701					;   3012  2	    ELSE
  4702					;   3013  3		BEGIN
  4703					;   3014  3	
  4704					;   3015  3		IF .GEN%1SIZE GTR MAX%MSG THEN GEN%1SIZE = MAX%MSG;
  4705					;   3016  3	
  4706					;   3017  3		DATA%SIZE = .GEN%1SIZE;
  4707					;   3018  3		CH$MOVE (.GEN%1SIZE, CH$PTR (GEN%1DATA), .POINTER);
  4708					;   3019  2		END;
  4709					;   3020  2	
  4710					;   3021  2	    SET%STRING (CH$PTR (DATA%TEXT), .DATA%SIZE, TRUE);
  4711					;   3022  2	    BFR%FILL (TRUE);
  4712					;   3023  2	    SET%STRING (0, 0, FALSE);
  4713					;   3024  2	!
  4714					;   3025  2	! Send the packet
  4715					;   3026  2	!
  4716					;   3027  2	
  4717					;   3028  2	    IF NOT SEND%PACKET (.GEN%TYPE, .SIZE, .MSG%NUMBER) THEN RETURN STATE%EX;
  4718
  4719					;   3029  2	
  4720					;   3030  2	!
  4721					;   3031  2	! Now get the responce from the remote KERMIT.
  4722					;   3032  2	!
  4723					;   3033  2	    STATUS = REC%PACKET ();
  4724					;   3034  2	
  4725					;   3035  2	    IF NOT .STATUS
  4726					;   3036  2	    THEN
  4727					;   3037  3		BEGIN
  4728					;   3038  3	
  4729					;   3039  4		IF (.STATUS EQL KER%ZEROLENMSG) OR (.STATUS EQL KER%TIMEOUT) OR (.ST
  4730					ATUS EQL KER%CHKSUMERR)
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-86
KERMSG	MAC	18-Jan-73 17:20	

  4731					;   3040  3		THEN
  4732					;   3041  3		    RETURN .STATE
  4733					;   3042  3		ELSE
  4734					;   3043  3		    RETURN STATE%EX;
  4735					;   3044  3	
  4736					;   3045  2		END;
  4737					;   3046  2	
  4738					;   3047  2	! Did we get a send-init?
  4739					;   3048  2	
  4740					;   3049  2	    SELECTONE .REC%TYPE OF
  4741					;   3050  2		SET
  4742					;   3051  2	
  4743					;   3052  2		[MSG%SND%INIT] :
  4744					;   3053  3		    BEGIN
  4745					;   3054  3		    MSG%NUMBER = .REC%SEQ;		! Initialize sequence number
  4746					s
  4747					;   3055  3	! Determine if the parameters are ok.  If not, give up
  4748					;   3056  3	
  4749					;   3057  3		    IF NOT (STATUS = PRS%SEND%INIT ()) THEN RETURN .STATUS;
  4750					;   3058  3	
  4751					;   3059  3		    SET%SEND%INIT ();			! Set up our acknowledgement
  4752					 to the send-init
  4753					;   3060  3		    SEND%PACKET (MSG%ACK, P%SI%LENGTH, .MSG%NUMBER);	! Send it
  4754					;   3061  3		    BLK%CHK%TYPE = .INI%CHK%TYPE;	! Can now use agreed upon ty
  4755					pe
  4756					;   3062  3		    OLD%RETRIES = .NUM%RETRIES;
  4757					;   3063  3		    NUM%RETRIES = 0;
  4758					;   3064  3		    MSG%NUMBER = (.MSG%NUMBER + 1) AND %O'77';
  4759					;   3065  3		    RETURN STATE%RF;			! Now expect file header
  4760					;   3066  2		    END;
  4761					;   3067  2	
  4762					;   3068  2		[MSG%TEXT] :
  4763					;   3069  2	!
  4764					;   3070  2	! If we just got a text header, set up for typing on the terminal and
  4765					;   3071  2	! shift to receiving data
  4766					;   3072  2	!
  4767					;   3073  3		    BEGIN
  4768					;   3074  3		    TEXT%HEAD%FLAG = TRUE;		! We want terminal output
  4769					;   3075  3		    PUT%CHR%ROUTINE = TYPE%CHAR;	! Set up the put a character
  4770					 routine
  4771					;   3076  3	
  4772					;   3077  3		    IF .REC%LENGTH GTR 0
  4773					;   3078  3		    THEN
  4774					;   3079  4			BEGIN
  4775					;   3080  4			TT%TEXT (UPLIT (%ASCIZ'<<'));	! Make sure file name sticks
  4776					 out
  4777					;   3081  4			BFR%EMPTY ();			! Dump the packet data to th
  4778					e terminal
  4779					;   3082  4			TT%TEXT (UPLIT (%ASCIZ'>>'));	! So user can tell where nam
  4780					e ends
  4781					;   3083  4			TT%CRLF ();			! And a CRLF
  4782					;   3084  3			END;
  4783					;   3085  3	
  4784					;   3086  3		    SEND%PACKET (MSG%ACK, 0, .MSG%NUMBER);	! Send an ACK
  4785					;   3087  3		    OLD%RETRIES = .NUM%RETRIES;
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-87
KERMSG	MAC	18-Jan-73 17:20	

  4786					;   3088  3		    NUM%RETRIES = 0;
  4787					;   3089  3		    MSG%NUMBER = (.MSG%NUMBER + 1) AND %O'77';
  4788					;   3090  3		    RETURN STATE%RD;			! We now want data
  4789					;   3091  2		    END;
  4790					;   3092  2	
  4791					;   3093  2		[MSG%ACK] :
  4792					;   3094  2	!
  4793					;   3095  2	! If we get an ACK, just type the data on the terminal and complete the
  4794					;   3096  2	! transaction.
  4795					;   3097  2	!
  4796					;   3098  3		    BEGIN
  4797					;   3099  3		    PUT%CHR%ROUTINE = TYPE%CHAR;	! Dump to terminal
  4798					;   3100  3		    BFR%EMPTY ();			! Do it
  4799					;   3101  3	
  4800					;   3102  3		    IF .REC%LENGTH GTR 0 THEN TT%CRLF ();
  4801					;   3103  3	
  4802					;   3104  3		    RETURN STATE%C;			! And go idle
  4803					;   3105  2		    END;
  4804					;   3106  2	
  4805					;   3107  2		[MSG%NAK] :
  4806					;   3108  2	!
  4807					;   3109  2	! If we get a NAK, stay in the same state.  We will re-transmit the
  4808					;   3110  2	! packet again.
  4809					;   3111  2	!
  4810					;   3112  2		    RETURN .STATE;
  4811					;   3113  2		TES;
  4812					;   3114  2	
  4813					;   3115  2	!
  4814					;   3116  2	! If we get here, we didn't get anything resembling an acceptable
  4815					;   3117  2	! packet, so we will abort.
  4816					;   3118  2	!
  4817					;   3119  2	    KRM%ERROR (KER%PROTOERR);
  4818					;   3120  2	    RETURN STATE%A;
  4819					;   3121  1	    END;
  4820
  4821
  4822	402061'	074 074 000 000 000 0 	P.AAG:	BYTE	(7)"<","<",000,000,000		; <<
  4823	402062'	076 076 000 000 000 0 	P.AAH:	BYTE	(7)">",">",000,000,000		; >>
  4824
  4825
  4826					; SEND%GENCMD
  4827					U.6:	ADJSP	SP,25				; SP,25					
  4828	402063'	105 17 0 00 000025 						2897
  4829						MOVE	AC1,U.52			; AC1,NUM%RETRIES			
  4830	402064'	200 01 0 00 000017'						2972
  4831	402065'	317 01 0 00 401500*		CAMG	AC1,PKT%RETRIES			; AC1,PKT%RETRIES
  4832	402066'	254 00 0 00 402071'		JRST	L.138				; L.138
  4833	402067'	201 01 0 00 000024 		MOVEI	AC1,24				; AC1,24
  4834	402070'	254 00 0 00 402342'		JRST	L.155				; L.155
  4835					L.138:	AOS	U.52				; NUM%RETRIES				
  4836	402071'	350 00 0 00 000017'						2978
  4837						MOVEI	AC1,-25(SP)			; AC1,DATA%TEXT-1			
  4838	402072'	201 01 0 17 777753 						2982
  4839	402073'	505 01 0 00 010700 		HRLI	AC1,10700			; AC1,10700
  4840	402074'	202 01 0 17 000000 		MOVEM	AC1,0(SP)			; AC1,POINTER
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-88
KERMSG	MAC	18-Jan-73 17:20	

  4841						SETZ	AC3,				; DATA%SIZE,				
  4842	402075'	400 03 0 00 000000 						2983
  4843						MOVEI	AC1,107				; AC1,107				
  4844	402076'	201 01 0 00 000107 						2985
  4845	402077'	312 01 0 00 000111'		CAME	AC1,U.64			; AC1,GEN%TYPE
  4846	402100'	254 00 0 00 402151'		JRST	L.143				; L.143
  4847						MOVE	AC1,U.65			; AC1,GEN%SUBTYPE			
  4848	402101'	200 01 0 00 000112'						2988
  4849	402102'	136 01 0 17 000000 		IDPB	AC1,0(SP)			; AC1,POINTER
  4850						MOVEI	AC3,1				; DATA%SIZE,1				
  4851	402103'	201 03 0 00 000001 						2989
  4852						MOVE	AC1,GEN%1SIZE			; AC1,GEN%1SIZE				
  4853	402104'	200 01 0 00 400237*						2991
  4854	402105'	327 01 0 00 402112'		JUMPG	AC1,L.139			; AC1,L.139
  4855	402106'	333 00 0 00 000000*		SKIPLE	GEN%2SIZE			; GEN%2SIZE
  4856	402107'	254 00 0 00 402112'		JRST	L.139				; L.139
  4857	402110'	337 00 0 00 000000*		SKIPG	GEN%3SIZE			; GEN%3SIZE
  4858	402111'	254 00 0 00 402165'		JRST	L.145				; L.145
  4859					L.139:	MOVEI	AC2,0(SP)			; AC2,POINTER				
  4860	402112'	201 02 0 17 000000 						2994
  4861	402113'	261 17 0 00 000002 		PUSH	SP,AC2				; SP,AC2
  4862	402114'	261 17 0 00 000003 		PUSH	SP,AC3				; SP,DATA%SIZE
  4863	402115'	261 17 0 00 402344'		PUSH	SP,C.40				; SP,[0,,GEN%1DATA]
  4864	402116'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
  4865	402117'	260 17 0 00 402030'		PUSHJ	SP,U.75				; SP,PACK%DATA
  4866	402120'	200 03 0 00 000001 		MOVE	AC3,AC1				; DATA%SIZE,AC1
  4867						MOVE	AC1,GEN%2SIZE			; AC1,GEN%2SIZE				
  4868	402121'	200 01 0 00 402106*						2996
  4869	402122'	327 01 0 00 402125'		JUMPG	AC1,L.140			; AC1,L.140
  4870	402123'	337 00 0 00 402110*		SKIPG	GEN%3SIZE			; GEN%3SIZE
  4871	402124'	254 00 0 00 402147'		JRST	L.142				; L.142
  4872					L.140:	MOVEI	AC2,-4(SP)			; AC2,POINTER				
  4873	402125'	201 02 0 17 777774 						2999
  4874	402126'	261 17 0 00 000002 		PUSH	SP,AC2				; SP,AC2
  4875	402127'	261 17 0 00 000003 		PUSH	SP,AC3				; SP,DATA%SIZE
  4876	402130'	261 17 0 00 402345'		PUSH	SP,C.41				; SP,[0,,GEN%2DATA]
  4877	402131'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
  4878	402132'	260 17 0 00 402030'		PUSHJ	SP,U.75				; SP,PACK%DATA
  4879	402133'	200 03 0 00 000001 		MOVE	AC3,AC1				; DATA%SIZE,AC1
  4880						MOVE	AC1,GEN%3SIZE			; AC1,GEN%3SIZE				
  4881	402134'	200 01 0 00 402123*						3001
  4882	402135'	323 01 0 00 402146'		JUMPLE	AC1,L.141			; AC1,L.141
  4883						MOVEI	AC2,-10(SP)			; AC2,POINTER				
  4884	402136'	201 02 0 17 777770 						3004
  4885	402137'	261 17 0 00 000002 		PUSH	SP,AC2				; SP,AC2
  4886	402140'	261 17 0 00 000003 		PUSH	SP,AC3				; SP,DATA%SIZE
  4887	402141'	261 17 0 00 402346'		PUSH	SP,C.42				; SP,[0,,GEN%3DATA]
  4888	402142'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
  4889	402143'	260 17 0 00 402030'		PUSHJ	SP,U.75				; SP,PACK%DATA
  4890	402144'	200 03 0 00 000001 		MOVE	AC3,AC1				; DATA%SIZE,AC1
  4891						ADJSP	SP,-4				; SP,-4					
  4892	402145'	105 17 0 00 777774 						3003
  4893					L.141:	ADJSP	SP,-4				; SP,-4					
  4894	402146'	105 17 0 00 777774 						2998
  4895					L.142:	ADJSP	SP,-4				; SP,-4					
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-89
KERMSG	MAC	18-Jan-73 17:20	

  4896	402147'	105 17 0 00 777774 						2993
  4897						JRST	L.145				; L.145					
  4898	402150'	254 00 0 00 402165'						2991
  4899					L.143:	MOVEI	AC1,140				; AC1,140				
  4900	402151'	201 01 0 00 000140 						3015
  4901	402152'	311 01 0 00 402104*		CAML	AC1,GEN%1SIZE			; AC1,GEN%1SIZE
  4902	402153'	254 00 0 00 402156'		JRST	L.144				; L.144
  4903	402154'	201 01 0 00 000140 		MOVEI	AC1,140				; AC1,140
  4904	402155'	202 01 0 00 402152*		MOVEM	AC1,GEN%1SIZE			; AC1,GEN%1SIZE
  4905					L.144:	MOVE	AC3,GEN%1SIZE			; DATA%SIZE,GEN%1SIZE			
  4906	402156'	200 03 0 00 402155*						3017
  4907						MOVE	AC1,GEN%1SIZE			; AC1,GEN%1SIZE				
  4908	402157'	200 01 0 00 402156*						3018
  4909	402160'	200 02 0 00 400260'		MOVE	AC2,C.11			; AC2,[POINT 7,GEN%1DATA-1,34]  <1,7>
  4910	402161'	200 04 0 00 402157*		MOVE	AC4,GEN%1SIZE			; AC4,GEN%1SIZE
  4911	402162'	200 05 0 17 000000 		MOVE	AC5,0(SP)			; AC5,POINTER
  4912	402163'	123 01 0 00 400256'		EXTEND	AC1,C.9				; AC1,[MOVSLJ ]
  4913	402164'	255 00 0 00 000000 		JFCL					;
  4914					L.145:	MOVEI	AC1,-25(SP)			; AC1,DATA%TEXT-1			
  4915	402165'	201 01 0 17 777753 						3021
  4916	402166'	505 01 0 00 010700 		HRLI	AC1,10700			; AC1,10700
  4917	402167'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
  4918	402170'	261 17 0 00 000003 		PUSH	SP,AC3				; SP,DATA%SIZE
  4919	402171'	261 17 0 00 400144'		PUSH	SP,C.2				; SP,[1]
  4920	402172'	260 17 0 00 406157'		PUSHJ	SP,U.30				; SP,SET%STRING
  4921						PUSH	SP,C.2				; SP,[1]				
  4922	402173'	261 17 0 00 400144'						3022
  4923	402174'	260 17 0 00 405543'		PUSHJ	SP,U.29				; SP,BFR%FILL
  4924						SETZM	-2(SP)				; -2(SP)				
  4925	402175'	402 00 0 17 777776 						3023
  4926	402176'	402 00 0 17 777777 		SETZM	-1(SP)				; -1(SP)
  4927	402177'	402 00 0 17 000000 		SETZM	0(SP)				; 0(SP)
  4928	402200'	260 17 0 00 406157'		PUSHJ	SP,U.30				; SP,SET%STRING
  4929						PUSH	SP,U.64				; SP,GEN%TYPE				
  4930	402201'	261 17 0 00 000111'						3028
  4931	402202'	261 17 0 00 000015'		PUSH	SP,U.50				; SP,SIZE
  4932	402203'	261 17 0 00 000020'		PUSH	SP,U.53				; SP,MSG%NUMBER
  4933	402204'	260 17 0 00 404426'		PUSHJ	SP,U.24				; SP,SEND%PACKET
  4934	402205'	105 17 0 00 777775 		ADJSP	SP,-3				; SP,-3
  4935	402206'	602 01 0 00 000001 		TRNE	AC1,1				; AC1,1
  4936	402207'	254 00 0 00 402213'		JRST	L.146				; L.146
  4937	402210'	105 17 0 00 777774 		ADJSP	SP,-4				; SP,-4
  4938	402211'	201 01 0 00 000023 		MOVEI	AC1,23				; AC1,23
  4939	402212'	254 00 0 00 402342'		JRST	L.155				; L.155
  4940					L.146:	PUSHJ	SP,U.26				; SP,REC%PACKET				
  4941	402213'	260 17 0 00 404716'						3033
  4942						TRNE	AC1,1				; STATUS,1				
  4943	402214'	602 01 0 00 000001 						3035
  4944	402215'	254 00 0 00 402227'		JRST	L.148				; L.148
  4945						CAIE	AC1,262				; STATUS,262				
  4946	402216'	302 01 0 00 000262 						3039
  4947	402217'	306 01 0 00 000300 		CAIN	AC1,300				; STATUS,300
  4948	402220'	254 00 0 00 402222'		JRST	L.147				; L.147
  4949	402221'	306 01 0 00 000172 		CAIN	AC1,172				; STATUS,172
  4950					L.147:	SKIPA	AC2,U.49			; AC2,STATE				
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-90
KERMSG	MAC	18-Jan-73 17:20	

  4951	402222'	334 02 0 00 000014'						3043
  4952	402223'	201 02 0 00 000023 		MOVEI	AC2,23				; AC2,23
  4953						ADJSP	SP,-4				; SP,-4					
  4954	402224'	105 17 0 00 777774 						3039
  4955						MOVE	AC1,AC2				; AC1,AC2				
  4956	402225'	200 01 0 00 000002 						3037
  4957	402226'	254 00 0 00 402342'		JRST	L.155				; L.155
  4958					L.148:	MOVE	AC2,U.56			; AC2,REC%TYPE				
  4959	402227'	200 02 0 00 000023'						3049
  4960						CAIE	AC2,123				; AC2,123				
  4961	402230'	302 02 0 00 000123 						3052
  4962	402231'	254 00 0 00 402262'		JRST	L.150				; L.150
  4963						MOVE	AC3,U.54			; AC3,REC%SEQ				
  4964	402232'	200 03 0 00 000021'						3054
  4965	402233'	202 03 0 00 000020'		MOVEM	AC3,U.53			; AC3,MSG%NUMBER
  4966						PUSHJ	SP,U.21				; SP,PRS%SEND%INIT			
  4967	402234'	260 17 0 00 404103'						3057
  4968	402235'	602 01 0 00 000001 		TRNE	AC1,1				; STATUS,1
  4969	402236'	254 00 0 00 402241'		JRST	L.149				; L.149
  4970	402237'	105 17 0 00 777774 		ADJSP	SP,-4				; SP,-4
  4971	402240'	254 00 0 00 402342'		JRST	L.155				; L.155
  4972					L.149:	PUSHJ	SP,U.20				; SP,SET%SEND%INIT			
  4973	402241'	260 17 0 00 404355'						3059
  4974						PUSH	SP,C.20				; SP,[131]				
  4975	402242'	261 17 0 00 401015'						3060
  4976	402243'	261 17 0 00 401016'		PUSH	SP,C.21				; SP,[11]
  4977	402244'	261 17 0 00 000020'		PUSH	SP,U.53				; SP,MSG%NUMBER
  4978	402245'	260 17 0 00 404426'		PUSHJ	SP,U.24				; SP,SEND%PACKET
  4979						MOVE	AC1,U.45			; AC1,INI%CHK%TYPE			
  4980	402246'	200 01 0 00 000010'						3061
  4981	402247'	202 01 0 00 000011'		MOVEM	AC1,U.46			; AC1,BLK%CHK%TYPE
  4982						MOVE	AC1,U.52			; AC1,NUM%RETRIES			
  4983	402250'	200 01 0 00 000017'						3062
  4984	402251'	202 01 0 00 000016'		MOVEM	AC1,U.51			; AC1,OLD%RETRIES
  4985						SETZM	U.52				; NUM%RETRIES				
  4986	402252'	402 00 0 00 000017'						3063
  4987						MOVE	AC1,U.53			; AC1,MSG%NUMBER			
  4988	402253'	200 01 0 00 000020'						3064
  4989	402254'	271 01 0 00 000001 		ADDI	AC1,1				; AC1,1
  4990	402255'	135 02 0 00 401013'		LDB	AC2,C.18			; AC2,[POINT 6,AC1,35]  <0,6>
  4991	402256'	202 02 0 00 000020'		MOVEM	AC2,U.53			; AC2,MSG%NUMBER
  4992						ADJSP	SP,-7				; SP,-7					
  4993	402257'	105 17 0 00 777771 						3065
  4994						MOVEI	AC1,7				; AC1,7					
  4995	402260'	201 01 0 00 000007 						3053
  4996	402261'	254 00 0 00 402342'		JRST	L.155				; L.155
  4997					L.150:	CAIE	AC2,130				; AC2,130				
  4998	402262'	302 02 0 00 000130 						3068
  4999	402263'	254 00 0 00 402317'		JRST	L.152				; L.152
  5000						MOVEI	AC1,1				; AC1,1					
  5001	402264'	201 01 0 00 000001 						3074
  5002	402265'	202 01 0 00 000106'		MOVEM	AC1,U.61			; AC1,TEXT%HEAD%FLAG
  5003						MOVEI	AC1,U.31			; AC1,TYPE%CHAR				
  5004	402266'	201 01 0 00 406711'						3075
  5005	402267'	202 01 0 00 000114'		MOVEM	AC1,U.67			; AC1,PUT%CHR%ROUTINE
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-91
KERMSG	MAC	18-Jan-73 17:20	

  5006						SKIPG	U.55				; REC%LENGTH				
  5007	402270'	337 00 0 00 000022'						3077
  5008	402271'	254 00 0 00 402301'		JRST	L.151				; L.151
  5009						PUSH	SP,C.43				; SP,[0,,P.AAG]				
  5010	402272'	261 17 0 00 402347'						3080
  5011	402273'	260 17 0 00 402021*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
  5012						PUSHJ	SP,U.28				; SP,BFR%EMPTY				
  5013	402274'	260 17 0 00 406030'						3081
  5014						PUSH	SP,C.44				; SP,[0,,P.AAH]				
  5015	402275'	261 17 0 00 402350'						3082
  5016	402276'	260 17 0 00 402273*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
  5017						PUSHJ	SP,TT%CRLF			; SP,TT%CRLF				
  5018	402277'	260 17 0 00 401310*						3083
  5019						ADJSP	SP,-2				; SP,-2					
  5020	402300'	105 17 0 00 777776 						3079
  5021					L.151:	PUSH	SP,C.20				; SP,[131]				
  5022	402301'	261 17 0 00 401015'						3086
  5023	402302'	261 17 0 00 401023'		PUSH	SP,C.26				; SP,[0]
  5024	402303'	261 17 0 00 000020'		PUSH	SP,U.53				; SP,MSG%NUMBER
  5025	402304'	260 17 0 00 404426'		PUSHJ	SP,U.24				; SP,SEND%PACKET
  5026						MOVE	AC1,U.52			; AC1,NUM%RETRIES			
  5027	402305'	200 01 0 00 000017'						3087
  5028	402306'	202 01 0 00 000016'		MOVEM	AC1,U.51			; AC1,OLD%RETRIES
  5029						SETZM	U.52				; NUM%RETRIES				
  5030	402307'	402 00 0 00 000017'						3088
  5031						MOVE	AC1,U.53			; AC1,MSG%NUMBER			
  5032	402310'	200 01 0 00 000020'						3089
  5033	402311'	271 01 0 00 000001 		ADDI	AC1,1				; AC1,1
  5034	402312'	135 02 0 00 401013'		LDB	AC2,C.18			; AC2,[POINT 6,AC1,35]  <0,6>
  5035	402313'	202 02 0 00 000020'		MOVEM	AC2,U.53			; AC2,MSG%NUMBER
  5036						ADJSP	SP,-7				; SP,-7					
  5037	402314'	105 17 0 00 777771 						3090
  5038						MOVEI	AC1,10				; AC1,10				
  5039	402315'	201 01 0 00 000010 						3073
  5040	402316'	254 00 0 00 402342'		JRST	L.155				; L.155
  5041					L.152:	CAIE	AC2,131				; AC2,131				
  5042	402317'	302 02 0 00 000131 						3093
  5043	402320'	254 00 0 00 402331'		JRST	L.153				; L.153
  5044						MOVEI	AC1,U.31			; AC1,TYPE%CHAR				
  5045	402321'	201 01 0 00 406711'						3099
  5046	402322'	202 01 0 00 000114'		MOVEM	AC1,U.67			; AC1,PUT%CHR%ROUTINE
  5047						PUSHJ	SP,U.28				; SP,BFR%EMPTY				
  5048	402323'	260 17 0 00 406030'						3100
  5049						SKIPLE	U.55				; REC%LENGTH				
  5050	402324'	333 00 0 00 000022'						3102
  5051	402325'	260 17 0 00 402277*		PUSHJ	SP,TT%CRLF			; SP,TT%CRLF
  5052						ADJSP	SP,-4				; SP,-4					
  5053	402326'	105 17 0 00 777774 						3104
  5054						MOVEI	AC1,11				; AC1,11				
  5055	402327'	201 01 0 00 000011 						3098
  5056	402330'	254 00 0 00 402342'		JRST	L.155				; L.155
  5057					L.153:	CAIE	AC2,116				; AC2,116				
  5058	402331'	302 02 0 00 000116 						3107
  5059	402332'	254 00 0 00 402336'		JRST	L.154				; L.154
  5060						ADJSP	SP,-4				; SP,-4					
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-92
KERMSG	MAC	18-Jan-73 17:20	

  5061	402333'	105 17 0 00 777774 						3112
  5062	402334'	200 01 0 00 000014'		MOVE	AC1,U.49			; AC1,STATE
  5063	402335'	254 00 0 00 402342'		JRST	L.155				; L.155
  5064					L.154:	PUSH	SP,C.22				; SP,[252]				
  5065	402336'	261 17 0 00 401017'						3119
  5066	402337'	260 17 0 00 401550*		PUSHJ	SP,KRM%ERROR			; SP,KRM%ERROR
  5067						ADJSP	SP,-5				; SP,-5					
  5068	402340'	105 17 0 00 777773 						3120
  5069						MOVEI	AC1,12				; AC1,12				
  5070	402341'	201 01 0 00 000012 						2946
  5071					L.155:	ADJSP	SP,-25				; SP,-25				
  5072	402342'	105 17 0 00 777753 						2897
  5073	402343'	263 17 0 00 000000 		POPJ	SP,				; SP,
  5074	402344'	000000	000000*		C.40:	XWD	0,GEN%1DATA			; 0,GEN%1DATA
  5075	402345'	000000	000000*		C.41:	XWD	0,GEN%2DATA			; 0,GEN%2DATA
  5076	402346'	000000	000000*		C.42:	XWD	0,GEN%3DATA			; 0,GEN%3DATA
  5077	402347'	000000	402061'		C.43:	XWD	0,P.AAG				; 0,P.AAG
  5078	402350'	000000	402062'		C.44:	XWD	0,P.AAH				; 0,P.AAH
  5079
  5080					; Routine Size:  182 words
  5081
  5082
  5083					;   3122  1	%SBTTL 'SEND%BREAK'
  5084					;   3123  1	ROUTINE SEND%BREAK =
  5085					;   3124  1	
  5086					;   3125  1	!++
  5087					;   3126  1	! FUNCTIONAL DESCRIPTION:
  5088					;   3127  1	!
  5089					;   3128  1	!	This routine will send the break (end of transmission) message
  5090					;   3129  1	!	to the remote KERMIT.  On an ACK the state becomes STATE%C.
  5091					;   3130  1	!
  5092					;   3131  1	! CALLING SEQUENCE:
  5093					;   3132  1	!
  5094					;   3133  1	!	STATE = SEND%BREAK();
  5095					;   3134  1	!
  5096					;   3135  1	! INPUT PARAMETERS:
  5097					;   3136  1	!
  5098					;   3137  1	!	None.
  5099					;   3138  1	!
  5100					;   3139  1	! IMPLICIT INPUTS:
  5101					;   3140  1	!
  5102					;   3141  1	!	None.
  5103					;   3142  1	!
  5104					;   3143  1	! OUTPUT PARAMETERS:
  5105					;   3144  1	!
  5106					;   3145  1	!	New state for the finite state machine.
  5107					;   3146  1	!
  5108					;   3147  1	! IMPLICIT OUTPUTS:
  5109					;   3148  1	!
  5110					;   3149  1	!	None.
  5111					;   3150  1	!
  5112					;   3151  1	! COMPLETION CODES:
  5113					;   3152  1	!
  5114					;   3153  1	!	None.
  5115					;   3154  1	!
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-93
KERMSG	MAC	18-Jan-73 17:20	

  5116					;   3155  1	! SIDE EFFECTS:
  5117					;   3156  1	!
  5118					;   3157  1	!	None.
  5119					;   3158  1	!
  5120					;   3159  1	!--
  5121					;   3160  1	
  5122					;   3161  2	    BEGIN
  5123					;   3162  2	
  5124					;   3163  2	    LOCAL
  5125					;   3164  2		STATUS;					! Status returned by various
  5126					 routines
  5127					;   3165  2	
  5128					;   3166  2	!
  5129					;   3167  2	! First determine if we have exceed the number of retries that are
  5130					;   3168  2	! allowed to attempt to send this message.
  5131					;   3169  2	!
  5132					;   3170  2	
  5133					;   3171  2	    IF .NUM%RETRIES GTR .PKT%RETRIES THEN RETURN STATE%ER;
  5134					;   3172  2	
  5135					;   3173  2	!
  5136					;   3174  2	! The number of retries are not exceeded.  Increment the number and then
  5137					;   3175  2	! attempt to send the packet again.
  5138					;   3176  2	!
  5139					;   3177  2	    NUM%RETRIES = .NUM%RETRIES + 1;
  5140					;   3178  2	
  5141					;   3179  2	    IF NOT SEND%PACKET (MSG%BREAK, 0, .MSG%NUMBER) THEN RETURN STATE%EX;
  5142					;   3180  2	
  5143					;   3181  2	!
  5144					;   3182  2	! Now get the responce from the remote KERMIT.
  5145					;   3183  2	!
  5146					;   3184  2	    STATUS = REC%PACKET ();
  5147					;   3185  2	
  5148					;   3186  2	    IF NOT .STATUS
  5149					;   3187  2	    THEN
  5150					;   3188  3		BEGIN
  5151					;   3189  3	
  5152					;   3190  4		IF (.STATUS EQL KER%ZEROLENMSG) OR (.STATUS EQL KER%TIMEOUT) OR (.ST
  5153					ATUS EQL KER%CHKSUMERR)
  5154					;   3191  3		THEN
  5155					;   3192  3		    RETURN .STATE
  5156					;   3193  3		ELSE
  5157					;   3194  3		    RETURN STATE%EX;
  5158					;   3195  3	
  5159					;   3196  2		END;
  5160					;   3197  2	
  5161					;   3198  2	!
  5162					;   3199  2	! Determine if the packet is good.
  5163					;   3200  2	!
  5164					;   3201  2	
  5165					;   3202  3	    IF NOT (.REC%TYPE EQL MSG%ACK OR .REC%TYPE EQL MSG%NAK)
  5166					;   3203  2	    THEN
  5167					;   3204  3		BEGIN
  5168					;   3205  3		KRM%ERROR (KER%PROTOERR);
  5169					;   3206  3		RETURN STATE%A;
  5170					;   3207  2		END;
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-94
KERMSG	MAC	18-Jan-73 17:20	

  5171					;   3208  2	
  5172					;   3209  2	!
  5173					;   3210  2	! If this is a NAK and the message number is not the one we just send
  5174					;   3211  2	! treat this like an ACK, otherwise resend the last packet.
  5175					;   3212  2	!
  5176					;   3213  2	
  5177					;   3214  2	    IF .REC%TYPE EQL MSG%NAK AND .REC%SEQ NEQ 0 THEN RETURN .STATE;
  5178					;   3215  2	
  5179					;   3216  2	    IF .REC%TYPE EQL MSG%ACK AND .REC%SEQ NEQ .MSG%NUMBER THEN RETURN .STATE
  5180					;
  5181					;   3217  2	
  5182					;   3218  2	!
  5183					;   3219  2	! Here to determine if there is another file to send.
  5184					;   3220  2	!
  5185					;   3221  2	    NUM%RETRIES = 0;
  5186					;   3222  2	    MSG%NUMBER = (.MSG%NUMBER + 1) AND %O'77';
  5187					;   3223  2	    RETURN STATE%C;
  5188					;   3224  1	    END;
  5189
  5190
  5191					; SEND%BREAK
  5192					U.9:	MOVE	AC1,U.52			; AC1,NUM%RETRIES			
  5193	402351'	200 01 0 00 000017'						3171
  5194	402352'	317 01 0 00 402065*		CAMG	AC1,PKT%RETRIES			; AC1,PKT%RETRIES
  5195	402353'	254 00 0 00 402356'		JRST	L.156				; L.156
  5196	402354'	201 01 0 00 000024 		MOVEI	AC1,24				; AC1,24
  5197	402355'	263 17 0 00 000000 		POPJ	SP,				; SP,
  5198					L.156:	AOS	U.52				; NUM%RETRIES				
  5199	402356'	350 00 0 00 000017'						3177
  5200						PUSH	SP,C.45				; SP,[102]				
  5201	402357'	261 17 0 00 402434'						3179
  5202	402360'	261 17 0 00 401023'		PUSH	SP,C.26				; SP,[0]
  5203	402361'	261 17 0 00 000020'		PUSH	SP,U.53				; SP,MSG%NUMBER
  5204	402362'	260 17 0 00 404426'		PUSHJ	SP,U.24				; SP,SEND%PACKET
  5205	402363'	105 17 0 00 777775 		ADJSP	SP,-3				; SP,-3
  5206	402364'	606 01 0 00 000001 		TRNN	AC1,1				; AC1,1
  5207	402365'	254 00 0 00 402376'		JRST	L.157				; L.157
  5208						PUSHJ	SP,U.26				; SP,REC%PACKET				
  5209	402366'	260 17 0 00 404716'						3184
  5210						TRNE	AC1,1				; STATUS,1				
  5211	402367'	602 01 0 00 000001 						3186
  5212	402370'	254 00 0 00 402400'		JRST	L.158				; L.158
  5213						CAIE	AC1,262				; STATUS,262				
  5214	402371'	302 01 0 00 000262 						3190
  5215	402372'	306 01 0 00 000300 		CAIN	AC1,300				; STATUS,300
  5216	402373'	254 00 0 00 402423'		JRST	L.161				; L.161
  5217	402374'	306 01 0 00 000172 		CAIN	AC1,172				; STATUS,172
  5218						JRST	L.161				; L.161					
  5219	402375'	254 00 0 00 402423'						3192
  5220					L.157:	MOVEI	AC1,23				; AC1,23				
  5221	402376'	201 01 0 00 000023 						3194
  5222						POPJ	SP,				; SP,					
  5223	402377'	263 17 0 00 000000 						3188
  5224					L.158:	MOVE	AC1,U.56			; AC1,REC%TYPE				
  5225	402400'	200 01 0 00 000023'						3202
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-95
KERMSG	MAC	18-Jan-73 17:20	

  5226	402401'	302 01 0 00 000131 		CAIE	AC1,131				; AC1,131
  5227	402402'	306 01 0 00 000116 		CAIN	AC1,116				; AC1,116
  5228	402403'	254 00 0 00 402411'		JRST	L.159				; L.159
  5229						PUSH	SP,C.22				; SP,[252]				
  5230	402404'	261 17 0 00 401017'						3205
  5231	402405'	260 17 0 00 402337*		PUSHJ	SP,KRM%ERROR			; SP,KRM%ERROR
  5232						ADJSP	SP,-1				; SP,-1					
  5233	402406'	105 17 0 00 777777 						3206
  5234						MOVEI	AC1,12				; AC1,12				
  5235	402407'	201 01 0 00 000012 						3204
  5236	402410'	263 17 0 00 000000 		POPJ	SP,				; SP,
  5237					L.159:	MOVE	AC1,U.56			; AC1,REC%TYPE				
  5238	402411'	200 01 0 00 000023'						3214
  5239	402412'	306 01 0 00 000116 		CAIN	AC1,116				; AC1,116
  5240	402413'	336 00 0 00 000021'		SKIPN	U.54				; REC%SEQ
  5241	402414'	254 00 0 00 402416'		JRST	L.160				; L.160
  5242	402415'	254 00 0 00 402423'		JRST	L.161				; L.161
  5243					L.160:	CAIE	AC1,131				; AC1,131				
  5244	402416'	302 01 0 00 000131 						3216
  5245	402417'	254 00 0 00 402425'		JRST	L.162				; L.162
  5246	402420'	200 01 0 00 000021'		MOVE	AC1,U.54			; AC1,REC%SEQ
  5247	402421'	316 01 0 00 000020'		CAMN	AC1,U.53			; AC1,MSG%NUMBER
  5248	402422'	254 00 0 00 402425'		JRST	L.162				; L.162
  5249	402423'	200 01 0 00 000014'	L.161:	MOVE	AC1,U.49			; AC1,STATE
  5250	402424'	263 17 0 00 000000 		POPJ	SP,				; SP,
  5251					L.162:	SETZM	U.52				; NUM%RETRIES				
  5252	402425'	402 00 0 00 000017'						3221
  5253						MOVE	AC1,U.53			; AC1,MSG%NUMBER			
  5254	402426'	200 01 0 00 000020'						3222
  5255	402427'	271 01 0 00 000001 		ADDI	AC1,1				; AC1,1
  5256	402430'	135 02 0 00 401013'		LDB	AC2,C.18			; AC2,[POINT 6,AC1,35]  <0,6>
  5257	402431'	202 02 0 00 000020'		MOVEM	AC2,U.53			; AC2,MSG%NUMBER
  5258						MOVEI	AC1,11				; AC1,11				
  5259	402432'	201 01 0 00 000011 						3161
  5260						POPJ	SP,				; SP,					
  5261	402433'	263 17 0 00 000000 						3123
  5262	402434'	000000	000102		C.45:	EXP	102				; 102
  5263
  5264					; Routine Size:  52 words
  5265
  5266
  5267					;   3225  1	%SBTTL 'REC%INIT'
  5268					;   3226  1	ROUTINE REC%INIT =
  5269					;   3227  1	
  5270					;   3228  1	!++
  5271					;   3229  1	! FUNCTIONAL DESCRIPTION:
  5272					;   3230  1	!
  5273					;   3231  1	!	This routine will process an initialization message received from
  5274					;   3232  1	!	the remote KERMIT.
  5275					;   3233  1	!
  5276					;   3234  1	! CALLING SEQUENCE:
  5277					;   3235  1	!
  5278					;   3236  1	!	STATE = REC%INIT();
  5279					;   3237  1	!
  5280					;   3238  1	! INPUT PARAMETERS:
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-96
KERMSG	MAC	18-Jan-73 17:20	

  5281					;   3239  1	!
  5282					;   3240  1	!	None.
  5283					;   3241  1	!
  5284					;   3242  1	! IMPLICIT INPUTS:
  5285					;   3243  1	!
  5286					;   3244  1	!	None.
  5287					;   3245  1	!
  5288					;   3246  1	! OUTPUT PARAMETERS:
  5289					;   3247  1	!
  5290					;   3248  1	!	New machine state.
  5291					;   3249  1	!
  5292					;   3250  1	! IMPLICIT OUTPUTS:
  5293					;   3251  1	!
  5294					;   3252  1	!	None.
  5295					;   3253  1	!
  5296					;   3254  1	! COMPLETION CODES:
  5297					;   3255  1	!
  5298					;   3256  1	!	None.
  5299					;   3257  1	!
  5300					;   3258  1	! SIDE EFFECTS:
  5301					;   3259  1	!
  5302					;   3260  1	!	None.
  5303					;   3261  1	!
  5304					;   3262  1	!--
  5305					;   3263  1	
  5306					;   3264  2	    BEGIN
  5307					;   3265  2	
  5308					;   3266  2	    LOCAL
  5309					;   3267  2		STATUS;					! Status returned by various
  5310					 routines
  5311					;   3268  2	
  5312					;   3269  2	    ROUTINE CHECK%INIT =
  5313					;   3270  3		BEGIN
  5314					;   3271  3	
  5315					;   3272  3		IF .REC%TYPE EQL MSG%SND%INIT THEN RETURN TRUE ELSE RETURN FALSE;
  5316					;   3273  3	
  5317					;   3274  2		END;
  5318
  5319
  5320					; CHECK%INIT
  5321					U.76:	MOVEI	AC1,123				; AC1,123				
  5322	402435'	201 01 0 00 000123 						3272
  5323	402436'	312 01 0 00 000023'		CAME	AC1,U.56			; AC1,REC%TYPE
  5324	402437'	254 00 0 00 402442'		JRST	L.163				; L.163
  5325	402440'	201 01 0 00 000001 		MOVEI	AC1,1				; AC1,1
  5326	402441'	263 17 0 00 000000 		POPJ	SP,				; SP,
  5327	402442'	400 01 0 00 000000 	L.163:	SETZ	AC1,				; AC1,
  5328						POPJ	SP,				; SP,					
  5329	402443'	263 17 0 00 000000 						3269
  5330
  5331					; Routine Size:  7 words
  5332
  5333
  5334					;   3275  2	
  5335					;   3276  3	    IF NOT (STATUS = REC%MESSAGE (CHECK%INIT))
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-97
KERMSG	MAC	18-Jan-73 17:20	

  5336					;   3277  2	    THEN
  5337					;   3278  2	
  5338					;   3279  2		IF .STATUS NEQ KER%ABORTED THEN RETURN STATE%A ELSE RETURN STATE%EX;
  5339
  5340					;   3280  2	
  5341					;   3281  2	    MSG%NUMBER = .REC%SEQ;
  5342					;   3282  2	
  5343					;   3283  2	    IF NOT (STATUS = PRS%SEND%INIT ()) THEN RETURN STATE%A;
  5344					;   3284  2	
  5345					;   3285  2	    SET%SEND%INIT ();
  5346					;   3286  2	    SEND%PACKET (MSG%ACK, P%SI%LENGTH, .MSG%NUMBER);
  5347					;   3287  2	    BLK%CHK%TYPE = .INI%CHK%TYPE;		! Can now use agreed upon ty
  5348					pe
  5349					;   3288  2	    OLD%RETRIES = .NUM%RETRIES;
  5350					;   3289  2	    NUM%RETRIES = 0;
  5351					;   3290  2	    MSG%NUMBER = (.MSG%NUMBER + 1) AND %O'77';
  5352					;   3291  2	    RETURN STATE%RF;
  5353					;   3292  1	    END;					! End of REC%INIT
  5354
  5355
  5356					; REC%INIT
  5357					U.11:	PUSH	SP,C.46				; SP,[0,,CHECK%INIT]			
  5358	402444'	261 17 0 00 402510'						3276
  5359	402445'	260 17 0 00 404641'		PUSHJ	SP,U.25				; SP,REC%MESSAGE
  5360	402446'	105 17 0 00 777777 		ADJSP	SP,-1				; SP,-1
  5361	402447'	602 01 0 00 000001 		TRNE	AC1,1				; STATUS,1
  5362	402450'	254 00 0 00 402460'		JRST	L.166				; L.166
  5363						CAIN	AC1,312				; STATUS,312				
  5364	402451'	306 01 0 00 000312 						3279
  5365	402452'	254 00 0 00 402455'		JRST	L.164				; L.164
  5366	402453'	201 02 0 00 000012 		MOVEI	AC2,12				; AC2,12
  5367	402454'	254 00 0 00 402456'		JRST	L.165				; L.165
  5368	402455'	201 02 0 00 000023 	L.164:	MOVEI	AC2,23				; AC2,23
  5369	402456'	200 01 0 00 000002 	L.165:	MOVE	AC1,AC2				; AC1,AC2
  5370	402457'	263 17 0 00 000000 		POPJ	SP,				; SP,
  5371					L.166:	MOVE	AC2,U.54			; AC2,REC%SEQ				
  5372	402460'	200 02 0 00 000021'						3281
  5373	402461'	202 02 0 00 000020'		MOVEM	AC2,U.53			; AC2,MSG%NUMBER
  5374						PUSHJ	SP,U.21				; SP,PRS%SEND%INIT			
  5375	402462'	260 17 0 00 404103'						3283
  5376	402463'	602 01 0 00 000001 		TRNE	AC1,1				; STATUS,1
  5377	402464'	254 00 0 00 402467'		JRST	L.167				; L.167
  5378	402465'	201 01 0 00 000012 		MOVEI	AC1,12				; AC1,12
  5379	402466'	263 17 0 00 000000 		POPJ	SP,				; SP,
  5380					L.167:	PUSHJ	SP,U.20				; SP,SET%SEND%INIT			
  5381	402467'	260 17 0 00 404355'						3285
  5382						PUSH	SP,C.20				; SP,[131]				
  5383	402470'	261 17 0 00 401015'						3286
  5384	402471'	261 17 0 00 401016'		PUSH	SP,C.21				; SP,[11]
  5385	402472'	261 17 0 00 000020'		PUSH	SP,U.53				; SP,MSG%NUMBER
  5386	402473'	260 17 0 00 404426'		PUSHJ	SP,U.24				; SP,SEND%PACKET
  5387						MOVE	AC1,U.45			; AC1,INI%CHK%TYPE			
  5388	402474'	200 01 0 00 000010'						3287
  5389	402475'	202 01 0 00 000011'		MOVEM	AC1,U.46			; AC1,BLK%CHK%TYPE
  5390						MOVE	AC1,U.52			; AC1,NUM%RETRIES			
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-98
KERMSG	MAC	18-Jan-73 17:20	

  5391	402476'	200 01 0 00 000017'						3288
  5392	402477'	202 01 0 00 000016'		MOVEM	AC1,U.51			; AC1,OLD%RETRIES
  5393						SETZM	U.52				; NUM%RETRIES				
  5394	402500'	402 00 0 00 000017'						3289
  5395						MOVE	AC1,U.53			; AC1,MSG%NUMBER			
  5396	402501'	200 01 0 00 000020'						3290
  5397	402502'	271 01 0 00 000001 		ADDI	AC1,1				; AC1,1
  5398	402503'	135 02 0 00 401013'		LDB	AC2,C.18			; AC2,[POINT 6,AC1,35]  <0,6>
  5399	402504'	202 02 0 00 000020'		MOVEM	AC2,U.53			; AC2,MSG%NUMBER
  5400						ADJSP	SP,-3				; SP,-3					
  5401	402505'	105 17 0 00 777775 						3291
  5402						MOVEI	AC1,7				; AC1,7					
  5403	402506'	201 01 0 00 000007 						3264
  5404						POPJ	SP,				; SP,					
  5405	402507'	263 17 0 00 000000 						3226
  5406	402510'	000000	402435'		C.46:	XWD	0,U.76				; 0,CHECK%INIT
  5407
  5408					; Routine Size:  37 words
  5409
  5410
  5411					;   3293  1	%SBTTL 'REC%FILE'
  5412					;   3294  1	ROUTINE REC%FILE =
  5413					;   3295  1	
  5414					;   3296  1	!++
  5415					;   3297  1	! FUNCTIONAL DESCRIPTION:
  5416					;   3298  1	!
  5417					;   3299  1	!	This routine expects to receive an MSG%FILE packet from the remote
  5418					;   3300  1	!	KERMIT.  If the message is correct this routine will change the stat
  5419					e
  5420					;   3301  1	!	to STATE%RD.
  5421					;   3302  1	!
  5422					;   3303  1	!	This routine also expects MSG%SND%INIT, MSG%EOF, or MSG%BREAK.
  5423					;   3304  1	!
  5424					;   3305  1	! CALLING SEQUENCE:
  5425					;   3306  1	!
  5426					;   3307  1	!	STATE = REC%FILE();
  5427					;   3308  1	!
  5428					;   3309  1	! INPUT PARAMETERS:
  5429					;   3310  1	!
  5430					;   3311  1	!	None.
  5431					;   3312  1	!
  5432					;   3313  1	! IMPLICIT INPUTS:
  5433					;   3314  1	!
  5434					;   3315  1	!	None.
  5435					;   3316  1	!
  5436					;   3317  1	! OUTPUT PARAMETERS:
  5437					;   3318  1	!
  5438					;   3319  1	!	New state.
  5439					;   3320  1	!
  5440					;   3321  1	! IMPLICIT OUTPUTS:
  5441					;   3322  1	!
  5442					;   3323  1	!	None.
  5443					;   3324  1	!
  5444					;   3325  1	! COMPLETION CODES:
  5445					;   3326  1	!
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-99
KERMSG	MAC	18-Jan-73 17:20	

  5446					;   3327  1	!	None.
  5447					;   3328  1	!
  5448					;   3329  1	! SIDE EFFECTS:
  5449					;   3330  1	!
  5450					;   3331  1	!	None.
  5451					;   3332  1	!
  5452					;   3333  1	!--
  5453					;   3334  1	
  5454					;   3335  2	    BEGIN
  5455					;   3336  2	
  5456					;   3337  2	    LOCAL
  5457					;   3338  2		STATUS;
  5458					;   3339  2	
  5459					;   3340  2	    ROUTINE CHECK%FILE =
  5460					;   3341  3		BEGIN
  5461					;   3342  3	
  5462					;   3343  4		IF (.REC%TYPE EQL MSG%SND%INIT) OR (.REC%TYPE EQL MSG%EOF) OR (.REC%
  5463					TYPE EQL MSG%FILE) OR (
  5464					;   3344  4		    .REC%TYPE EQL MSG%BREAK) OR (.REC%TYPE EQL MSG%TEXT)
  5465					;   3345  3		THEN
  5466					;   3346  3		    RETURN TRUE
  5467					;   3347  3		ELSE
  5468					;   3348  3		    RETURN FALSE;
  5469					;   3349  3	
  5470					;   3350  2		END;
  5471
  5472
  5473					; CHECK%FILE
  5474					U.77:	MOVE	AC1,U.56			; AC1,REC%TYPE				
  5475	402511'	200 01 0 00 000023'						3343
  5476	402512'	302 01 0 00 000123 		CAIE	AC1,123				; AC1,123
  5477	402513'	306 01 0 00 000132 		CAIN	AC1,132				; AC1,132
  5478	402514'	254 00 0 00 402522'		JRST	L.168				; L.168
  5479	402515'	302 01 0 00 000106 		CAIE	AC1,106				; AC1,106
  5480	402516'	306 01 0 00 000102 		CAIN	AC1,102				; AC1,102
  5481	402517'	254 00 0 00 402522'		JRST	L.168				; L.168
  5482						CAIE	AC1,130				; AC1,130				
  5483	402520'	302 01 0 00 000130 						3344
  5484	402521'	254 00 0 00 402524'		JRST	L.169				; L.169
  5485					L.168:	MOVEI	AC1,1				; AC1,1					
  5486	402522'	201 01 0 00 000001 						3348
  5487	402523'	263 17 0 00 000000 		POPJ	SP,				; SP,
  5488	402524'	400 01 0 00 000000 	L.169:	SETZ	AC1,				; AC1,
  5489						POPJ	SP,				; SP,					
  5490	402525'	263 17 0 00 000000 						3340
  5491
  5492					; Routine Size:  13 words
  5493
  5494
  5495					;   3351  2	!
  5496					;   3352  2	! Initialize the abort flags
  5497					;   3353  2	!
  5498					;   3354  2	    ABT%CUR%FILE = FALSE;
  5499					;   3355  2	    ABT%ALL%FILE = FALSE;
  5500					;   3356  2	!
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-100
KERMSG	MAC	18-Jan-73 17:20	

  5501					;   3357  2	! Get a message
  5502					;   3358  2	!
  5503					;   3359  2	
  5504					;   3360  3	    IF NOT (STATUS = REC%MESSAGE (CHECK%FILE))
  5505					;   3361  2	    THEN
  5506					;   3362  2	
  5507					;   3363  2		IF .STATUS NEQ KER%ABORTED THEN RETURN STATE%A ELSE RETURN STATE%EX;
  5508
  5509					;   3364  2	
  5510					;   3365  2	    SELECTONE .REC%TYPE OF
  5511					;   3366  2		SET
  5512					;   3367  2	
  5513					;   3368  2		[MSG%SND%INIT] :
  5514					;   3369  3		    BEGIN
  5515					;   3370  3	
  5516					;   3371  3		    IF .OLD%RETRIES GTR .SI%RETRIES THEN RETURN STATE%ER;
  5517					;   3372  3	
  5518					;   3373  3		    OLD%RETRIES = .OLD%RETRIES + 1;
  5519					;   3374  3	
  5520					;   3375  3		    IF ((.MSG%NUMBER - 1) AND %O'77') EQL .REC%SEQ
  5521					;   3376  3		    THEN
  5522					;   3377  4			BEGIN
  5523					;   3378  4			SET%SEND%INIT ();
  5524					;   3379  4			BLK%CHK%TYPE = CHK%1CHAR;	! Must use 1 character CHKSU
  5525					M
  5526					;   3380  4			SEND%PACKET (MSG%ACK, P%SI%LENGTH, .REC%SEQ);
  5527					;   3381  4			BLK%CHK%TYPE = .INI%CHK%TYPE;	! Back to agreed upon type
  5528					;   3382  4			NUM%RETRIES = 0;
  5529					;   3383  4			RETURN .STATE;
  5530					;   3384  4			END
  5531					;   3385  3		    ELSE
  5532					;   3386  4			BEGIN
  5533					;   3387  4			KRM%ERROR (KER%PROTOERR);
  5534					;   3388  4			RETURN STATE%A;
  5535					;   3389  3			END;
  5536					;   3390  3	
  5537					;   3391  2		    END;
  5538					;   3392  2	
  5539					;   3393  2		[MSG%EOF] :
  5540					;   3394  3		    BEGIN
  5541					;   3395  3	
  5542					;   3396  3		    IF .OLD%RETRIES GTR .PKT%RETRIES THEN RETURN STATE%ER;
  5543					;   3397  3	
  5544					;   3398  3		    OLD%RETRIES = .OLD%RETRIES + 1;
  5545					;   3399  3	
  5546					;   3400  3		    IF ((.MSG%NUMBER - 1) AND %O'77') EQL .REC%SEQ
  5547					;   3401  3		    THEN
  5548					;   3402  4			BEGIN
  5549					;   3403  4			SEND%PACKET (MSG%ACK, 0, .REC%SEQ);
  5550					;   3404  4			NUM%RETRIES = 0;
  5551					;   3405  4			RETURN .STATE;
  5552					;   3406  4			END
  5553					;   3407  3		    ELSE
  5554					;   3408  4			BEGIN
  5555					;   3409  4			KRM%ERROR (KER%PROTOERR);
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-101
KERMSG	MAC	18-Jan-73 17:20	

  5556					;   3410  4			RETURN STATE%A;
  5557					;   3411  3			END;
  5558					;   3412  3	
  5559					;   3413  2		    END;
  5560					;   3414  2	
  5561					;   3415  2		[MSG%FILE] :
  5562					;   3416  3		    BEGIN
  5563					;   3417  3	
  5564					;   3418  3		    IF .MSG%NUMBER NEQ .REC%SEQ THEN RETURN STATE%ER;
  5565					;   3419  3	
  5566					;   3420  3		    IF .REC%LENGTH EQL 0
  5567					;   3421  3		    THEN
  5568					;   3422  4			BEGIN
  5569					;   3423  4			KRM%ERROR (KER%PROTOERR);
  5570					;   3424  4			RETURN STATE%A;
  5571					;   3425  3			END;
  5572					;   3426  3	
  5573					;   3427  3	![025]
  5574					;   3428  3	![025] Get file name from packet with all quoting undone
  5575					;   3429  3	![025]
  5576					;   3430  3		    SET%STRING (CH$PTR (FILE%NAME), MAX%FILE%NAME, TRUE);
  5577					;   3431  3		    BFR%EMPTY ();
  5578					;   3432  3		    FILE%SIZE = SET%STRING (0, 0, FALSE);
  5579					;   3433  3		    CH$WCHAR (CHR%NUL, CH$PTR (FILE%NAME, .FILE%SIZE));
  5580					;   3434  3	![025]	    FILE%SIZE = .REC%LENGTH;
  5581					;   3435  3	![025]	    CH$COPY (.REC%LENGTH, CH$PTR (REC%MSG, PKT%MSG, CHR%SIZE), CHR%N
  5582					UL, MAX%FILE%NAME,
  5583					;   3436  3	![025]		CH$PTR (FILE%NAME));
  5584					;   3437  3	
  5585					;   3438  3		    IF ( NOT .CONNECT%FLAG) AND .TY%FIL
  5586					;   3439  3		    THEN
  5587					;   3440  4			BEGIN
  5588					;   3441  4			TT%TEXT (UPLIT (%ASCIZ'Receiving: '));
  5589					;   3442  4			TT%TEXT (FILE%NAME);
  5590					;   3443  4			TT%OUTPUT ();
  5591					;   3444  3			END;
  5592					;   3445  3	
  5593					;   3446  3	![023]
  5594					;   3447  3	![023] Force file name into normal form if desired
  5595					;   3448  3	![023]
  5596					;   3449  3	
  5597					;   3450  3		    IF .FIL%NORMAL%FORM THEN NORMALIZE%FILE (FILE%NAME, FILE%SIZE, 9
  5598					, 3);
  5599					;   3451  3	
  5600					;   3452  3		    FILE%CHARS = 0;			! No characters received yet
  5601
  5602					;   3453  3	
  5603					;   3454  3		    IF NOT FILE%OPEN (FNC%WRITE) THEN RETURN STATE%A;
  5604					;   3455  3	
  5605					;   3456  3		    XFR%STATUS (%C'F', %C'R');		! Tell display routine
  5606					;   3457  3		    TEXT%HEAD%FLAG = FALSE;		! Got an F, not an X
  5607					;   3458  3		    FILE%OPEN%FLAG = TRUE;
  5608					;   3459  3		    SEND%PACKET (MSG%ACK, 0, .MSG%NUMBER);
  5609					;   3460  3		    OLD%RETRIES = .NUM%RETRIES;
  5610					;   3461  3		    NUM%RETRIES = 0;
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-102
KERMSG	MAC	18-Jan-73 17:20	

  5611					;   3462  3		    MSG%NUMBER = (.MSG%NUMBER + 1) AND %O'77';
  5612					;   3463  3		    RETURN STATE%RD;
  5613					;   3464  2		    END;
  5614					;   3465  2	
  5615					;   3466  2		[MSG%TEXT] :
  5616					;   3467  2	!
  5617					;   3468  2	! If we get a text header, we will want to type the data on
  5618					;   3469  2	! the terminal.  Set up the put a character routine correctly.
  5619					;   3470  2	!
  5620					;   3471  3		    BEGIN
  5621					;   3472  3	
  5622					;   3473  3		    IF .MSG%NUMBER NEQ .REC%SEQ
  5623					;   3474  3		    THEN
  5624					;   3475  4			BEGIN
  5625					;   3476  4			KRM%ERROR (KER%PROTOERR);
  5626					;   3477  4			RETURN STATE%A;
  5627					;   3478  3			END;
  5628					;   3479  3	
  5629					;   3480  3		    TEXT%HEAD%FLAG = TRUE;		! Got an X, not an F
  5630					;   3481  3		    PUT%CHR%ROUTINE = TYPE%CHAR;	! Empty buffer on terminal
  5631					;   3482  3	
  5632					;   3483  3		    IF .REC%LENGTH GTR 0
  5633					;   3484  3		    THEN
  5634					;   3485  4			BEGIN
  5635					;   3486  4			TT%TEXT (UPLIT (%ASCIZ'<<'));	! Make file name stick out
  5636					;   3487  4			BFR%EMPTY ();			! Do the header data
  5637					;   3488  4			TT%TEXT (UPLIT (%ASCIZ'>>'));
  5638					;   3489  4			TT%CRLF ();			! And a crlf
  5639					;   3490  3			END;
  5640					;   3491  3	
  5641					;   3492  3		    SEND%PACKET (MSG%ACK, 0, .MSG%NUMBER);
  5642					;   3493  3		    OLD%RETRIES = .NUM%RETRIES;
  5643					;   3494  3		    NUM%RETRIES = 0;
  5644					;   3495  3		    MSG%NUMBER = (.MSG%NUMBER + 1) AND %O'77';
  5645					;   3496  3		    RETURN STATE%RD;
  5646					;   3497  2		    END;
  5647					;   3498  2	
  5648					;   3499  2		[MSG%BREAK] :
  5649					;   3500  3		    BEGIN
  5650					;   3501  3	
  5651					;   3502  3		    IF .MSG%NUMBER NEQ .REC%SEQ
  5652					;   3503  3		    THEN
  5653					;   3504  4			BEGIN
  5654					;   3505  4			KRM%ERROR (KER%PROTOERR);
  5655					;   3506  4			RETURN STATE%A;
  5656					;   3507  3			END;
  5657					;   3508  3	
  5658					;   3509  3		    SEND%PACKET (MSG%ACK, 0, .REC%SEQ);
  5659					;   3510  3		    RETURN STATE%C;
  5660					;   3511  2		    END;
  5661					;   3512  2	
  5662					;   3513  2		[OTHERWISE] :
  5663					;   3514  3		    BEGIN
  5664					;   3515  3		    KRM%ERROR (KER%PROTOERR);
  5665					;   3516  3		    RETURN STATE%A;
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-103
KERMSG	MAC	18-Jan-73 17:20	

  5666					;   3517  2		    END;
  5667					;   3518  2		TES;
  5668					;   3519  2	
  5669					;   3520  1	    END;					! End of REC%FILE
  5670
  5671
  5672	402526'	122 145 143 145 151 0 	P.AAI:	BYTE	(7)"R","e","c","e","i"		; Recei
  5673	402527'	166 151 156 147 072 0 		BYTE	(7)"v","i","n","g",":"		; ving:
  5674	402530'	040 000 000 000 000 0 		BYTE	(7)" ",000,000,000,000
  5675	402531'	074 074 000 000 000 0 	P.AAJ:	BYTE	(7)"<","<",000,000,000		; <<
  5676	402532'	076 076 000 000 000 0 	P.AAK:	BYTE	(7)">",">",000,000,000		; >>
  5677
  5678
  5679					; REC%FILE
  5680					U.12:	SETZM	ABT%CUR%FILE			; ABT%CUR%FILE				
  5681	402533'	402 00 0 00 401511*						3354
  5682						SETZM	ABT%ALL%FILE			; ABT%ALL%FILE				
  5683	402534'	402 00 0 00 401600*						3355
  5684						PUSH	SP,C.47				; SP,[0,,CHECK%FILE]			
  5685	402535'	261 17 0 00 403015'						3360
  5686	402536'	260 17 0 00 404641'		PUSHJ	SP,U.25				; SP,REC%MESSAGE
  5687	402537'	105 17 0 00 777777 		ADJSP	SP,-1				; SP,-1
  5688	402540'	602 01 0 00 000001 		TRNE	AC1,1				; STATUS,1
  5689	402541'	254 00 0 00 402546'		JRST	L.170				; L.170
  5690						CAIE	AC1,312				; STATUS,312				
  5691	402542'	302 01 0 00 000312 						3363
  5692	402543'	254 00 0 00 402777'		JRST	L.184				; L.184
  5693	402544'	201 01 0 00 000023 		MOVEI	AC1,23				; AC1,23
  5694	402545'	263 17 0 00 000000 		POPJ	SP,				; SP,
  5695					L.170:	MOVE	AC1,U.56			; AC1,REC%TYPE				
  5696	402546'	200 01 0 00 000023'						3365
  5697						CAIE	AC1,123				; AC1,123				
  5698	402547'	302 01 0 00 000123 						3368
  5699	402550'	254 00 0 00 402574'		JRST	L.171				; L.171
  5700						MOVE	AC2,U.51			; AC2,OLD%RETRIES			
  5701	402551'	200 02 0 00 000016'						3371
  5702	402552'	313 02 0 00 401666*		CAMLE	AC2,SI%RETRIES			; AC2,SI%RETRIES
  5703	402553'	254 00 0 00 402624'		JRST	L.174				; L.174
  5704						AOS	U.51				; OLD%RETRIES				
  5705	402554'	350 00 0 00 000016'						3373
  5706						MOVE	AC1,U.53			; AC1,MSG%NUMBER			
  5707	402555'	200 01 0 00 000020'						3375
  5708	402556'	275 01 0 00 000001 		SUBI	AC1,1				; AC1,1
  5709	402557'	135 02 0 00 401013'		LDB	AC2,C.18			; AC2,[POINT 6,AC1,35]  <0,6>
  5710	402560'	312 02 0 00 000021'		CAME	AC2,U.54			; AC2,REC%SEQ
  5711	402561'	254 00 0 00 403010'		JRST	L.186				; L.186
  5712						PUSHJ	SP,U.20				; SP,SET%SEND%INIT			
  5713	402562'	260 17 0 00 404355'						3378
  5714						MOVEI	AC1,61				; AC1,61				
  5715	402563'	201 01 0 00 000061 						3379
  5716	402564'	202 01 0 00 000011'		MOVEM	AC1,U.46			; AC1,BLK%CHK%TYPE
  5717						PUSH	SP,C.20				; SP,[131]				
  5718	402565'	261 17 0 00 401015'						3380
  5719	402566'	261 17 0 00 401016'		PUSH	SP,C.21				; SP,[11]
  5720	402567'	261 17 0 00 000021'		PUSH	SP,U.54				; SP,REC%SEQ
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-104
KERMSG	MAC	18-Jan-73 17:20	

  5721	402570'	260 17 0 00 404426'		PUSHJ	SP,U.24				; SP,SEND%PACKET
  5722						MOVE	AC1,U.45			; AC1,INI%CHK%TYPE			
  5723	402571'	200 01 0 00 000010'						3381
  5724	402572'	202 01 0 00 000011'		MOVEM	AC1,U.46			; AC1,BLK%CHK%TYPE
  5725	402573'	254 00 0 00 402613'		JRST	L.172				; L.172
  5726					L.171:	CAIE	AC1,132				; AC1,132				
  5727	402574'	302 01 0 00 000132 						3393
  5728	402575'	254 00 0 00 402617'		JRST	L.173				; L.173
  5729						MOVE	AC2,U.51			; AC2,OLD%RETRIES			
  5730	402576'	200 02 0 00 000016'						3396
  5731	402577'	313 02 0 00 402352*		CAMLE	AC2,PKT%RETRIES			; AC2,PKT%RETRIES
  5732	402600'	254 00 0 00 402624'		JRST	L.174				; L.174
  5733						AOS	U.51				; OLD%RETRIES				
  5734	402601'	350 00 0 00 000016'						3398
  5735						MOVE	AC1,U.53			; AC1,MSG%NUMBER			
  5736	402602'	200 01 0 00 000020'						3400
  5737	402603'	275 01 0 00 000001 		SUBI	AC1,1				; AC1,1
  5738	402604'	135 02 0 00 401013'		LDB	AC2,C.18			; AC2,[POINT 6,AC1,35]  <0,6>
  5739	402605'	312 02 0 00 000021'		CAME	AC2,U.54			; AC2,REC%SEQ
  5740	402606'	254 00 0 00 403010'		JRST	L.186				; L.186
  5741						PUSH	SP,C.20				; SP,[131]				
  5742	402607'	261 17 0 00 401015'						3403
  5743	402610'	261 17 0 00 401023'		PUSH	SP,C.26				; SP,[0]
  5744	402611'	261 17 0 00 000021'		PUSH	SP,U.54				; SP,REC%SEQ
  5745	402612'	260 17 0 00 404426'		PUSHJ	SP,U.24				; SP,SEND%PACKET
  5746					L.172:	SETZM	U.52				; NUM%RETRIES				
  5747	402613'	402 00 0 00 000017'						3404
  5748						ADJSP	SP,-2				; SP,-2					
  5749	402614'	105 17 0 00 777776 						3402
  5750						MOVE	AC1,U.49			; AC1,STATE				
  5751	402615'	200 01 0 00 000014'						3408
  5752	402616'	254 00 0 00 403013'		JRST	L.187				; L.187
  5753					L.173:	CAIE	AC1,106				; AC1,106				
  5754	402617'	302 01 0 00 000106 						3415
  5755	402620'	254 00 0 00 402727'		JRST	L.179				; L.179
  5756						MOVE	AC2,U.53			; AC2,MSG%NUMBER			
  5757	402621'	200 02 0 00 000020'						3418
  5758	402622'	316 02 0 00 000021'		CAMN	AC2,U.54			; AC2,REC%SEQ
  5759	402623'	254 00 0 00 402626'		JRST	L.175				; L.175
  5760	402624'	201 01 0 00 000024 	L.174:	MOVEI	AC1,24				; AC1,24
  5761	402625'	263 17 0 00 000000 		POPJ	SP,				; SP,
  5762					L.175:	SKIPN	U.55				; REC%LENGTH				
  5763	402626'	336 00 0 00 000022'						3420
  5764	402627'	254 00 0 00 402774'		JRST	L.183				; L.183
  5765						PUSH	SP,C.10				; SP,[POINT 7,FILE%NAME-1,34]  <1,7>	
  5766	402630'	261 17 0 00 400257'						3430
  5767	402631'	261 17 0 00 401020'		PUSH	SP,C.23				; SP,[204]
  5768	402632'	261 17 0 00 400144'		PUSH	SP,C.2				; SP,[1]
  5769	402633'	260 17 0 00 406157'		PUSHJ	SP,U.30				; SP,SET%STRING
  5770						PUSHJ	SP,U.28				; SP,BFR%EMPTY				
  5771	402634'	260 17 0 00 406030'						3431
  5772						SETZM	-2(SP)				; -2(SP)				
  5773	402635'	402 00 0 17 777776 						3432
  5774	402636'	402 00 0 17 777777 		SETZM	-1(SP)				; -1(SP)
  5775	402637'	402 00 0 17 000000 		SETZM	0(SP)				; 0(SP)
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-105
KERMSG	MAC	18-Jan-73 17:20	

  5776	402640'	260 17 0 00 406157'		PUSHJ	SP,U.30				; SP,SET%STRING
  5777	402641'	202 01 0 00 401661*		MOVEM	AC1,FILE%SIZE			; AC1,FILE%SIZE
  5778						SETZ	AC2,				; AC2,					
  5779	402642'	400 02 0 00 000000 						3433
  5780	402643'	200 03 0 00 401014'		MOVE	AC3,C.19			; AC3,[POINT 7,FILE%NAME,-1]  <36,7>
  5781	402644'	200 01 0 00 402641*		MOVE	AC1,FILE%SIZE			; AC1,FILE%SIZE
  5782	402645'	133 01 0 00 000003 		ADJBP	AC1,AC3				; AC1,AC3
  5783	402646'	136 02 0 00 000001 		IDPB	AC2,AC1				; AC2,AC1
  5784						MOVEI	AC1,1				; AC1,1					
  5785	402647'	201 01 0 00 000001 						3438
  5786	402650'	612 01 0 00 402013*		TDNE	AC1,CONNECT%FLAG		; AC1,CONNECT%FLAG
  5787	402651'	254 00 0 00 402663'		JRST	L.176				; L.176
  5788	402652'	201 01 0 00 000001 		MOVEI	AC1,1				; AC1,1
  5789	402653'	616 01 0 00 402016*		TDNN	AC1,TY%FIL			; AC1,TY%FIL
  5790	402654'	254 00 0 00 402663'		JRST	L.176				; L.176
  5791						PUSH	SP,C.48				; SP,[0,,P.AAI]				
  5792	402655'	261 17 0 00 403016'						3441
  5793	402656'	260 17 0 00 402276*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
  5794						PUSH	SP,C.35				; SP,[0,,FILE%NAME]			
  5795	402657'	261 17 0 00 401660'						3442
  5796	402660'	260 17 0 00 402656*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
  5797						PUSHJ	SP,TT%OUTPUT			; SP,TT%OUTPUT				
  5798	402661'	260 17 0 00 402022*						3443
  5799						ADJSP	SP,-2				; SP,-2					
  5800	402662'	105 17 0 00 777776 						3440
  5801					L.176:	MOVEI	AC1,1				; AC1,1					
  5802	402663'	201 01 0 00 000001 						3450
  5803	402664'	616 01 0 00 401777*		TDNN	AC1,FIL%NORMAL%FORM		; AC1,FIL%NORMAL%FORM
  5804	402665'	254 00 0 00 402674'		JRST	L.177				; L.177
  5805	402666'	261 17 0 00 401660'		PUSH	SP,C.35				; SP,[0,,FILE%NAME]
  5806	402667'	261 17 0 00 401661'		PUSH	SP,C.36				; SP,[0,,FILE%SIZE]
  5807	402670'	261 17 0 00 401016'		PUSH	SP,C.21				; SP,[11]
  5808	402671'	261 17 0 00 403017'		PUSH	SP,C.49				; SP,[3]
  5809	402672'	260 17 0 00 405277'		PUSHJ	SP,U.27				; SP,NORMALIZE%FILE
  5810	402673'	105 17 0 00 777774 		ADJSP	SP,-4				; SP,-4
  5811					L.177:	SETZM	U.60				; FILE%CHARS				
  5812	402674'	402 00 0 00 000105'						3452
  5813						PUSH	SP,C.2				; SP,[1]				
  5814	402675'	261 17 0 00 400144'						3454
  5815	402676'	260 17 0 00 401766*		PUSHJ	SP,FILE%OPEN			; SP,FILE%OPEN
  5816	402677'	105 17 0 00 777777 		ADJSP	SP,-1				; SP,-1
  5817	402700'	602 01 0 00 000001 		TRNE	AC1,1				; AC1,1
  5818	402701'	254 00 0 00 402704'		JRST	L.178				; L.178
  5819	402702'	105 17 0 00 777775 		ADJSP	SP,-3				; SP,-3
  5820	402703'	254 00 0 00 402777'		JRST	L.184				; L.184
  5821					L.178:	PUSH	SP,C.15				; SP,[106]				
  5822	402704'	261 17 0 00 400603'						3456
  5823	402705'	261 17 0 00 400261'		PUSH	SP,C.12				; SP,[122]
  5824	402706'	260 17 0 00 402011*		PUSHJ	SP,XFR%STATUS			; SP,XFR%STATUS
  5825						SETZM	U.61				; TEXT%HEAD%FLAG			
  5826	402707'	402 00 0 00 000106'						3457
  5827						MOVEI	AC1,1				; AC1,1					
  5828	402710'	201 01 0 00 000001 						3458
  5829	402711'	202 01 0 00 000104'		MOVEM	AC1,U.59			; AC1,FILE%OPEN%FLAG
  5830						PUSH	SP,C.20				; SP,[131]				
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-106
KERMSG	MAC	18-Jan-73 17:20	

  5831	402712'	261 17 0 00 401015'						3459
  5832	402713'	261 17 0 00 401023'		PUSH	SP,C.26				; SP,[0]
  5833	402714'	261 17 0 00 000020'		PUSH	SP,U.53				; SP,MSG%NUMBER
  5834	402715'	260 17 0 00 404426'		PUSHJ	SP,U.24				; SP,SEND%PACKET
  5835						MOVE	AC1,U.52			; AC1,NUM%RETRIES			
  5836	402716'	200 01 0 00 000017'						3460
  5837	402717'	202 01 0 00 000016'		MOVEM	AC1,U.51			; AC1,OLD%RETRIES
  5838						SETZM	U.52				; NUM%RETRIES				
  5839	402720'	402 00 0 00 000017'						3461
  5840						MOVE	AC1,U.53			; AC1,MSG%NUMBER			
  5841	402721'	200 01 0 00 000020'						3462
  5842	402722'	271 01 0 00 000001 		ADDI	AC1,1				; AC1,1
  5843	402723'	135 02 0 00 401013'		LDB	AC2,C.18			; AC2,[POINT 6,AC1,35]  <0,6>
  5844	402724'	202 02 0 00 000020'		MOVEM	AC2,U.53			; AC2,MSG%NUMBER
  5845						ADJSP	SP,-7				; SP,-7					
  5846	402725'	105 17 0 00 777771 						3416
  5847	402726'	254 00 0 00 402765'		JRST	L.181				; L.181
  5848					L.179:	CAIE	AC1,130				; AC1,130				
  5849	402727'	302 01 0 00 000130 						3466
  5850	402730'	254 00 0 00 402767'		JRST	L.182				; L.182
  5851						MOVE	AC1,U.53			; AC1,MSG%NUMBER			
  5852	402731'	200 01 0 00 000020'						3473
  5853	402732'	312 01 0 00 000021'		CAME	AC1,U.54			; AC1,REC%SEQ
  5854	402733'	254 00 0 00 402774'		JRST	L.183				; L.183
  5855						MOVEI	AC1,1				; AC1,1					
  5856	402734'	201 01 0 00 000001 						3480
  5857	402735'	202 01 0 00 000106'		MOVEM	AC1,U.61			; AC1,TEXT%HEAD%FLAG
  5858						MOVEI	AC1,U.31			; AC1,TYPE%CHAR				
  5859	402736'	201 01 0 00 406711'						3481
  5860	402737'	202 01 0 00 000114'		MOVEM	AC1,U.67			; AC1,PUT%CHR%ROUTINE
  5861						SKIPG	U.55				; REC%LENGTH				
  5862	402740'	337 00 0 00 000022'						3483
  5863	402741'	254 00 0 00 402751'		JRST	L.180				; L.180
  5864						PUSH	SP,C.50				; SP,[0,,P.AAJ]				
  5865	402742'	261 17 0 00 403020'						3486
  5866	402743'	260 17 0 00 402660*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
  5867						PUSHJ	SP,U.28				; SP,BFR%EMPTY				
  5868	402744'	260 17 0 00 406030'						3487
  5869						PUSH	SP,C.51				; SP,[0,,P.AAK]				
  5870	402745'	261 17 0 00 403021'						3488
  5871	402746'	260 17 0 00 402743*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
  5872						PUSHJ	SP,TT%CRLF			; SP,TT%CRLF				
  5873	402747'	260 17 0 00 402325*						3489
  5874						ADJSP	SP,-2				; SP,-2					
  5875	402750'	105 17 0 00 777776 						3485
  5876					L.180:	PUSH	SP,C.20				; SP,[131]				
  5877	402751'	261 17 0 00 401015'						3492
  5878	402752'	261 17 0 00 401023'		PUSH	SP,C.26				; SP,[0]
  5879	402753'	261 17 0 00 000020'		PUSH	SP,U.53				; SP,MSG%NUMBER
  5880	402754'	260 17 0 00 404426'		PUSHJ	SP,U.24				; SP,SEND%PACKET
  5881						MOVE	AC1,U.52			; AC1,NUM%RETRIES			
  5882	402755'	200 01 0 00 000017'						3493
  5883	402756'	202 01 0 00 000016'		MOVEM	AC1,U.51			; AC1,OLD%RETRIES
  5884						SETZM	U.52				; NUM%RETRIES				
  5885	402757'	402 00 0 00 000017'						3494
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-107
KERMSG	MAC	18-Jan-73 17:20	

  5886						MOVE	AC1,U.53			; AC1,MSG%NUMBER			
  5887	402760'	200 01 0 00 000020'						3495
  5888	402761'	271 01 0 00 000001 		ADDI	AC1,1				; AC1,1
  5889	402762'	135 02 0 00 401013'		LDB	AC2,C.18			; AC2,[POINT 6,AC1,35]  <0,6>
  5890	402763'	202 02 0 00 000020'		MOVEM	AC2,U.53			; AC2,MSG%NUMBER
  5891						ADJSP	SP,-2				; SP,-2					
  5892	402764'	105 17 0 00 777776 						3471
  5893					L.181:	MOVEI	AC1,10				; AC1,10				
  5894	402765'	201 01 0 00 000010 						3365
  5895	402766'	254 00 0 00 403013'		JRST	L.187				; L.187
  5896					L.182:	CAIE	AC1,102				; AC1,102				
  5897	402767'	302 01 0 00 000102 						3499
  5898	402770'	254 00 0 00 403010'		JRST	L.186				; L.186
  5899						MOVE	AC1,U.53			; AC1,MSG%NUMBER			
  5900	402771'	200 01 0 00 000020'						3502
  5901	402772'	316 01 0 00 000021'		CAMN	AC1,U.54			; AC1,REC%SEQ
  5902	402773'	254 00 0 00 403001'		JRST	L.185				; L.185
  5903					L.183:	PUSH	SP,C.22				; SP,[252]				
  5904	402774'	261 17 0 00 401017'						3505
  5905	402775'	260 17 0 00 402405*		PUSHJ	SP,KRM%ERROR			; SP,KRM%ERROR
  5906						ADJSP	SP,-1				; SP,-1					
  5907	402776'	105 17 0 00 777777 						3506
  5908					L.184:	MOVEI	AC1,12				; AC1,12				
  5909	402777'	201 01 0 00 000012 						3504
  5910	403000'	263 17 0 00 000000 		POPJ	SP,				; SP,
  5911					L.185:	PUSH	SP,C.20				; SP,[131]				
  5912	403001'	261 17 0 00 401015'						3509
  5913	403002'	261 17 0 00 401023'		PUSH	SP,C.26				; SP,[0]
  5914	403003'	261 17 0 00 000021'		PUSH	SP,U.54				; SP,REC%SEQ
  5915	403004'	260 17 0 00 404426'		PUSHJ	SP,U.24				; SP,SEND%PACKET
  5916						ADJSP	SP,-2				; SP,-2					
  5917	403005'	105 17 0 00 777776 						3500
  5918						MOVEI	AC1,11				; AC1,11				
  5919	403006'	201 01 0 00 000011 						3365
  5920	403007'	254 00 0 00 403013'		JRST	L.187				; L.187
  5921					L.186:	PUSH	SP,C.22				; SP,[252]				
  5922	403010'	261 17 0 00 401017'						3515
  5923	403011'	260 17 0 00 402775*		PUSHJ	SP,KRM%ERROR			; SP,KRM%ERROR
  5924						MOVEI	AC1,12				; AC1,12				
  5925	403012'	201 01 0 00 000012 						3365
  5926					L.187:	ADJSP	SP,-1				; SP,-1					
  5927	403013'	105 17 0 00 777777 						3514
  5928						POPJ	SP,				; SP,					
  5929	403014'	263 17 0 00 000000 						3294
  5930	403015'	000000	402511'		C.47:	XWD	0,U.77				; 0,CHECK%FILE
  5931	403016'	000000	402526'		C.48:	XWD	0,P.AAI				; 0,P.AAI
  5932	403017'	000000	000003		C.49:	EXP	3				; 3
  5933	403020'	000000	402531'		C.50:	XWD	0,P.AAJ				; 0,P.AAJ
  5934	403021'	000000	402532'		C.51:	XWD	0,P.AAK				; 0,P.AAK
  5935
  5936					; Routine Size:  183 words
  5937
  5938
  5939					;   3521  1	%SBTTL 'REC%DATA'
  5940					;   3522  1	ROUTINE REC%DATA =
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-108
KERMSG	MAC	18-Jan-73 17:20	

  5941					;   3523  1	
  5942					;   3524  1	!++
  5943					;   3525  1	! FUNCTIONAL DESCRIPTION:
  5944					;   3526  1	!
  5945					;   3527  1	! This routine will accept data messages and write them to disk.
  5946					;   3528  1	! It will also accept MSG%FILE, MSG%TEXT and MSG%EOF messages.
  5947					;   3529  1	!
  5948					;   3530  1	! CALLING SEQUENCE:
  5949					;   3531  1	!
  5950					;   3532  1	!	STATE = REC%DATA();
  5951					;   3533  1	!
  5952					;   3534  1	! INPUT PARAMETERS:
  5953					;   3535  1	!
  5954					;   3536  1	!	None.
  5955					;   3537  1	!
  5956					;   3538  1	! IMPLICIT INPUTS:
  5957					;   3539  1	!
  5958					;   3540  1	!	None.
  5959					;   3541  1	!
  5960					;   3542  1	! OUTPUT PARAMETERS:
  5961					;   3543  1	!
  5962					;   3544  1	!	New state for the finite state machine.
  5963					;   3545  1	!
  5964					;   3546  1	! IMPLICIT OUTPUTS:
  5965					;   3547  1	!
  5966					;   3548  1	!	None.
  5967					;   3549  1	!
  5968					;   3550  1	! COMPLETION CODES:
  5969					;   3551  1	!
  5970					;   3552  1	!	None.
  5971					;   3553  1	!
  5972					;   3554  1	! SIDE EFFECTS:
  5973					;   3555  1	!
  5974					;   3556  1	!	None.
  5975					;   3557  1	!
  5976					;   3558  1	!--
  5977					;   3559  1	
  5978					;   3560  2	    BEGIN
  5979					;   3561  2	
  5980					;   3562  2	    LOCAL
  5981					;   3563  2		STATUS;
  5982					;   3564  2	
  5983					;   3565  2	    ROUTINE CHECK%DATA =
  5984					;   3566  3		BEGIN
  5985					;   3567  3	
  5986					;   3568  3		IF .REC%TYPE EQL MSG%DATA OR (.REC%TYPE EQL MSG%FILE AND NOT .TEXT%H
  5987					EAD%FLAG) OR .REC%TYPE
  5988					;   3569  4		    EQL MSG%EOF OR (.REC%TYPE EQL MSG%TEXT AND .TEXT%HEAD%FLAG)
  5989					;   3570  3		THEN
  5990					;   3571  3		    RETURN TRUE
  5991					;   3572  3		ELSE
  5992					;   3573  3		    RETURN FALSE;
  5993					;   3574  3	
  5994					;   3575  2		END;
  5995
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-109
KERMSG	MAC	18-Jan-73 17:20	

  5996
  5997					; CHECK%DATA
  5998					U.78:	MOVE	AC1,U.56			; AC1,REC%TYPE				
  5999	403022'	200 01 0 00 000023'						3568
  6000	403023'	306 01 0 00 000104 		CAIN	AC1,104				; AC1,104
  6001	403024'	254 00 0 00 403041'		JRST	L.189				; L.189
  6002	403025'	302 01 0 00 000106 		CAIE	AC1,106				; AC1,106
  6003	403026'	254 00 0 00 403032'		JRST	L.188				; L.188
  6004	403027'	201 02 0 00 000001 		MOVEI	AC2,1				; AC2,1
  6005	403030'	616 02 0 00 000106'		TDNN	AC2,U.61			; AC2,TEXT%HEAD%FLAG
  6006	403031'	254 00 0 00 403041'		JRST	L.189				; L.189
  6007					L.188:	CAIN	AC1,132				; AC1,132				
  6008	403032'	306 01 0 00 000132 						3569
  6009	403033'	254 00 0 00 403041'		JRST	L.189				; L.189
  6010	403034'	302 01 0 00 000130 		CAIE	AC1,130				; AC1,130
  6011	403035'	254 00 0 00 403043'		JRST	L.190				; L.190
  6012	403036'	201 01 0 00 000001 		MOVEI	AC1,1				; AC1,1
  6013	403037'	616 01 0 00 000106'		TDNN	AC1,U.61			; AC1,TEXT%HEAD%FLAG
  6014	403040'	254 00 0 00 403043'		JRST	L.190				; L.190
  6015					L.189:	MOVEI	AC1,1				; AC1,1					
  6016	403041'	201 01 0 00 000001 						3573
  6017	403042'	263 17 0 00 000000 		POPJ	SP,				; SP,
  6018	403043'	400 01 0 00 000000 	L.190:	SETZ	AC1,				; AC1,
  6019						POPJ	SP,				; SP,					
  6020	403044'	263 17 0 00 000000 						3565
  6021
  6022					; Routine Size:  19 words
  6023
  6024
  6025					;   3576  2	
  6026					;   3577  2	    LOCAL
  6027					;   3578  2		SUB%TYPE,				! Subtype for XFR%STATUS
  6028					;   3579  2		DISCARD%FILE%FLAG,			! Sender requested discard
  6029					;   3580  2		ACK%MSG%LEN;				! Length of ACK to send
  6030					;   3581  2	
  6031					;   3582  2	!
  6032					;   3583  2	! First get a message
  6033					;   3584  2	!
  6034					;   3585  2	
  6035					;   3586  3	    IF NOT (STATUS = REC%MESSAGE (CHECK%DATA))
  6036					;   3587  2	    THEN
  6037					;   3588  2	
  6038					;   3589  2		IF .STATUS NEQ KER%ABORTED THEN RETURN STATE%A ELSE RETURN STATE%EX;
  6039
  6040					;   3590  2	
  6041					;   3591  2	    SELECTONE .REC%TYPE OF
  6042					;   3592  2		SET
  6043					;   3593  2	
  6044					;   3594  2		[MSG%DATA] :
  6045					;   3595  3		    BEGIN
  6046					;   3596  3	
  6047					;   3597  3		    IF .MSG%NUMBER NEQ .REC%SEQ
  6048					;   3598  3		    THEN
  6049					;   3599  4			BEGIN
  6050					;   3600  4	
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-110
KERMSG	MAC	18-Jan-73 17:20	

  6051					;   3601  4			IF .OLD%RETRIES GTR .PKT%RETRIES THEN RETURN STATE%ER;
  6052					;   3602  4	
  6053					;   3603  4			OLD%RETRIES = .OLD%RETRIES + 1;
  6054					;   3604  4	
  6055					;   3605  4			IF ((.MSG%NUMBER - 1) AND %O'77') EQL .REC%SEQ
  6056					;   3606  4			THEN
  6057					;   3607  5			    BEGIN
  6058					;   3608  5			    SEND%PACKET (MSG%ACK, 0, .REC%SEQ);
  6059					;   3609  5			    NUM%RETRIES = 0;
  6060					;   3610  5			    RETURN .STATE;
  6061					;   3611  5			    END
  6062					;   3612  4			ELSE
  6063					;   3613  5			    BEGIN
  6064					;   3614  5			    KRM%ERROR (KER%PROTOERR);
  6065					;   3615  5			    RETURN STATE%A;
  6066					;   3616  4			    END;
  6067					;   3617  4	
  6068					;   3618  3			END;
  6069					;   3619  3	
  6070					;   3620  3	!
  6071					;   3621  3	! Here if we have a message with a valid message number
  6072					;   3622  3	!
  6073					;   3623  3	
  6074					;   3624  3		    IF NOT BFR%EMPTY () THEN RETURN STATE%A;
  6075					;   3625  3	
  6076					;   3626  3	!
  6077					;   3627  3	! Check if we wish to abort for some reason
  6078					;   3628  3	!
  6079					;   3629  3	
  6080					;   3630  3		    IF .ABT%CUR%FILE
  6081					;   3631  3		    THEN
  6082					;   3632  4			BEGIN
  6083					;   3633  4			CH$WCHAR (MSG%ACK%ABT%CUR, CH$PTR (SND%MSG, PKT%MSG, CHR%SIZ
  6084					E));
  6085					;   3634  4			ACK%MSG%LEN = 1;
  6086					;   3635  4			END
  6087					;   3636  3		    ELSE
  6088					;   3637  3	
  6089					;   3638  3			IF .ABT%ALL%FILE
  6090					;   3639  3			THEN
  6091					;   3640  4			    BEGIN
  6092					;   3641  4			    CH$WCHAR (MSG%ACK%ABT%ALL, CH$PTR (SND%MSG, PKT%MSG, CHR
  6093					%SIZE));
  6094					;   3642  4			    ACK%MSG%LEN = 1;
  6095					;   3643  4			    END
  6096					;   3644  3			ELSE
  6097					;   3645  3			    ACK%MSG%LEN = 0;
  6098					;   3646  3	
  6099					;   3647  3	!
  6100					;   3648  3	! Now send the ACK
  6101					;   3649  3	!
  6102					;   3650  3		    SEND%PACKET (MSG%ACK, .ACK%MSG%LEN, .REC%SEQ);
  6103					;   3651  3		    OLD%RETRIES = .NUM%RETRIES;
  6104					;   3652  3		    NUM%RETRIES = 0;
  6105					;   3653  3		    MSG%NUMBER = (.MSG%NUMBER + 1) AND %O'77';
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-111
KERMSG	MAC	18-Jan-73 17:20	

  6106					;   3654  3		    RETURN STATE%RD;
  6107					;   3655  2		    END;
  6108					;   3656  2	
  6109					;   3657  2		[MSG%FILE, MSG%TEXT] :
  6110					;   3658  3		    BEGIN
  6111					;   3659  3	
  6112					;   3660  3		    IF .OLD%RETRIES GTR .PKT%RETRIES THEN RETURN STATE%ER;
  6113					;   3661  3	
  6114					;   3662  3		    OLD%RETRIES = .OLD%RETRIES + 1;
  6115					;   3663  3	
  6116					;   3664  3		    IF ((.MSG%NUMBER - 1) AND %O'77') EQL .REC%SEQ
  6117					;   3665  3		    THEN
  6118					;   3666  4			BEGIN
  6119					;   3667  4			SEND%PACKET (MSG%ACK, 0, .REC%SEQ);
  6120					;   3668  4			NUM%RETRIES = 0;
  6121					;   3669  4			RETURN .STATE;
  6122					;   3670  4			END
  6123					;   3671  3		    ELSE
  6124					;   3672  4			BEGIN
  6125					;   3673  4			KRM%ERROR (KER%PROTOERR);
  6126					;   3674  4			RETURN STATE%A;
  6127					;   3675  3			END;
  6128					;   3676  3	
  6129					;   3677  2		    END;
  6130					;   3678  2	
  6131					;   3679  2		[MSG%EOF] :
  6132					;   3680  3		    BEGIN
  6133					;   3681  3	
  6134					;   3682  3		    IF .MSG%NUMBER NEQ .REC%SEQ
  6135					;   3683  3		    THEN
  6136					;   3684  4			BEGIN
  6137					;   3685  4			KRM%ERROR (KER%PROTOERR);
  6138					;   3686  4			RETURN STATE%A;
  6139					;   3687  3			END;
  6140					;   3688  3	
  6141					;   3689  3		    SEND%PACKET (MSG%ACK, 0, .REC%SEQ);
  6142					;   3690  3	
  6143					;   3691  3		    IF NOT .TEXT%HEAD%FLAG
  6144					;   3692  3		    THEN
  6145					;   3693  4			BEGIN
  6146					;   3694  4			FILE%OPEN%FLAG = FALSE;
  6147					;   3695  4			DISCARD%FILE%FLAG = FALSE;	! Assume we want file
  6148					;   3696  4	
  6149					;   3697  4			IF .REC%LENGTH EQL 1
  6150					;   3698  4			THEN
  6151					;   3699  4	
  6152					;   3700  4			    IF CH$RCHAR (CH$PTR (REC%MSG, PKT%MSG, CHR%SIZE)) EQL MS
  6153					G%EOF%DISCARD
  6154					;   3701  4			    THEN
  6155					;   3702  4				DISCARD%FILE%FLAG = TRUE;
  6156					;   3703  4	
  6157					;   3704  4			IF ( NOT .CONNECT%FLAG) AND .TY%FIL
  6158					;   3705  4			THEN
  6159					;   3706  5			    BEGIN
  6160					;   3707  5	
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-112
KERMSG	MAC	18-Jan-73 17:20	

  6161					;   3708  5			    IF .DISCARD%FILE%FLAG
  6162					;   3709  5			    THEN
  6163					;   3710  5	
  6164					;   3711  5				IF .ABT%FLAG
  6165					;   3712  5				THEN
  6166					;   3713  5				    TT%TEXT (UPLIT (%ASCIZ' [Interrupted]'))
  6167					;   3714  5				ELSE
  6168					;   3715  5				    TT%TEXT (UPLIT (%ASCIZ' [Interrupted, partial fi
  6169					le saved]'))
  6170					;   3716  5	
  6171					;   3717  5			    ELSE
  6172					;   3718  5				TT%TEXT (UPLIT (%ASCIZ' [OK]'));
  6173					;   3719  5	
  6174					;   3720  5			    TT%CRLF ();
  6175					;   3721  4			    END;
  6176					;   3722  4	
  6177					;   3723  4			IF NOT FILE%CLOSE (.DISCARD%FILE%FLAG AND .ABT%FLAG) THEN RE
  6178					TURN STATE%A;
  6179					;   3724  4	
  6180					;   3725  4			IF .DISCARD%FILE%FLAG
  6181					;   3726  4			THEN
  6182					;   3727  4	
  6183					;   3728  4			    IF .ABT%FLAG THEN SUB%TYPE = %C'X' ELSE SUB%TYPE = %C'D'
  6184
  6185					;   3729  4	
  6186					;   3730  4			ELSE
  6187					;   3731  4			    SUB%TYPE = %C'C';
  6188					;   3732  4	
  6189					;   3733  4			END
  6190					;   3734  3		    ELSE
  6191					;   3735  4			BEGIN
  6192					;   3736  4			TT%CRLF ();			! Make sure we have a CRLF
  6193					;   3737  4			TT%OUTPUT ();			! And make sure all output i
  6194					s sent
  6195					;   3738  3			END;
  6196					;   3739  3	
  6197					;   3740  3		    XFR%STATUS (%C'F', .SUB%TYPE);
  6198					;   3741  3		    MSG%NUMBER = (.MSG%NUMBER + 1) AND %O'77';
  6199					;   3742  3		    RETURN STATE%RF;
  6200					;   3743  2		    END;
  6201					;   3744  2	
  6202					;   3745  2		[OTHERWISE] :
  6203					;   3746  3		    BEGIN
  6204					;   3747  3		    KRM%ERROR (KER%PROTOERR);
  6205					;   3748  3		    RETURN STATE%A;
  6206					;   3749  2		    END;
  6207					;   3750  2		TES;
  6208					;   3751  2	
  6209					;   3752  1	    END;					! End of REC%DATA
  6210
  6211
  6212	403045'	040 133 111 156 164 0 	P.AAL:	BYTE	(7)" ","[","I","n","t"		;  [Int
  6213	403046'	145 162 162 165 160 0 		BYTE	(7)"e","r","r","u","p"		; errup
  6214	403047'	164 145 144 135 000 0 		BYTE	(7)"t","e","d","]",000		; ted]
  6215	403050'	040 133 111 156 164 0 	P.AAM:	BYTE	(7)" ","[","I","n","t"		;  [Int
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-113
KERMSG	MAC	18-Jan-73 17:20	

  6216	403051'	145 162 162 165 160 0 		BYTE	(7)"e","r","r","u","p"		; errup
  6217	403052'	164 145 144 054 040 0 		BYTE	(7)"t","e","d",","," "		; ted,
  6218	403053'	160 141 162 164 151 0 		BYTE	(7)"p","a","r","t","i"		; parti
  6219	403054'	141 154 040 146 151 0 		BYTE	(7)"a","l"," ","f","i"		; al fi
  6220	403055'	154 145 040 163 141 0 		BYTE	(7)"l","e"," ","s","a"		; le sa
  6221	403056'	166 145 144 135 000 0 		BYTE	(7)"v","e","d","]",000		; ved]
  6222	403057'	040 133 117 113 135 0 	P.AAN:	BYTE	(7)" ","[","O","K","]"		;  [OK]
  6223	403060'	000 000 000 000 000 0 		BYTE	(7)000,000,000,000,000
  6224
  6225
  6226					; REC%DATA
  6227					U.13:	PUSH	SP,AC16				; SP,AC16				
  6228	403061'	261 17 0 00 000016 						3522
  6229						PUSH	SP,C.52				; SP,[0,,CHECK%DATA]			
  6230	403062'	261 17 0 00 403315'						3586
  6231	403063'	260 17 0 00 404641'		PUSHJ	SP,U.25				; SP,REC%MESSAGE
  6232	403064'	105 17 0 00 777777 		ADJSP	SP,-1				; SP,-1
  6233	403065'	602 01 0 00 000001 		TRNE	AC1,1				; STATUS,1
  6234	403066'	254 00 0 00 403073'		JRST	L.191				; L.191
  6235						CAIE	AC1,312				; STATUS,312				
  6236	403067'	302 01 0 00 000312 						3589
  6237	403070'	254 00 0 00 403256'		JRST	L.208				; L.208
  6238	403071'	201 01 0 00 000023 		MOVEI	AC1,23				; AC1,23
  6239	403072'	254 00 0 00 403313'		JRST	L.216				; L.216
  6240					L.191:	MOVE	AC1,U.56			; AC1,REC%TYPE				
  6241	403073'	200 01 0 00 000023'						3591
  6242						CAIE	AC1,104				; AC1,104				
  6243	403074'	302 01 0 00 000104 						3594
  6244	403075'	254 00 0 00 403144'		JRST	L.197				; L.197
  6245						MOVE	AC2,U.53			; AC2,MSG%NUMBER			
  6246	403076'	200 02 0 00 000020'						3597
  6247	403077'	316 02 0 00 000021'		CAMN	AC2,U.54			; AC2,REC%SEQ
  6248	403100'	254 00 0 00 403105'		JRST	L.192				; L.192
  6249						MOVE	AC1,U.51			; AC1,OLD%RETRIES			
  6250	403101'	200 01 0 00 000016'						3601
  6251	403102'	313 01 0 00 402577*		CAMLE	AC1,PKT%RETRIES			; AC1,PKT%RETRIES
  6252	403103'	254 00 0 00 403153'		JRST	L.199				; L.199
  6253						JRST	L.200				; L.200					
  6254	403104'	254 00 0 00 403155'						3522
  6255					L.192:	PUSHJ	SP,U.28				; SP,BFR%EMPTY				
  6256	403105'	260 17 0 00 406030'						3624
  6257	403106'	606 01 0 00 000001 		TRNN	AC1,1				; AC1,1
  6258	403107'	254 00 0 00 403256'		JRST	L.208				; L.208
  6259						MOVEI	AC1,1				; AC1,1					
  6260	403110'	201 01 0 00 000001 						3630
  6261	403111'	616 01 0 00 402533*		TDNN	AC1,ABT%CUR%FILE		; AC1,ABT%CUR%FILE
  6262	403112'	254 00 0 00 403115'		JRST	L.193				; L.193
  6263						MOVEI	AC2,130				; AC2,130				
  6264	403113'	201 02 0 00 000130 						3633
  6265	403114'	254 00 0 00 403121'		JRST	L.194				; L.194
  6266					L.193:	MOVEI	AC1,1				; AC1,1					
  6267	403115'	201 01 0 00 000001 						3638
  6268	403116'	616 01 0 00 402534*		TDNN	AC1,ABT%ALL%FILE		; AC1,ABT%ALL%FILE
  6269	403117'	254 00 0 00 403125'		JRST	L.195				; L.195
  6270						MOVEI	AC2,132				; AC2,132				
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-114
KERMSG	MAC	18-Jan-73 17:20	

  6271	403120'	201 02 0 00 000132 						3641
  6272	403121'	200 01 0 00 401656'	L.194:	MOVE	AC1,C.33			; AC1,[POINT 8,SND%MSG,31]  <4,8>
  6273	403122'	136 02 0 00 000001 		IDPB	AC2,AC1				; AC2,AC1
  6274						MOVEI	AC3,1				; ACK%MSG%LEN,1				
  6275	403123'	201 03 0 00 000001 						3642
  6276						JRST	L.196				; L.196					
  6277	403124'	254 00 0 00 403126'						3638
  6278					L.195:	SETZ	AC3,				; ACK%MSG%LEN,				
  6279	403125'	400 03 0 00 000000 						3645
  6280					L.196:	PUSH	SP,C.20				; SP,[131]				
  6281	403126'	261 17 0 00 401015'						3650
  6282	403127'	261 17 0 00 000003 		PUSH	SP,AC3				; SP,ACK%MSG%LEN
  6283	403130'	261 17 0 00 000021'		PUSH	SP,U.54				; SP,REC%SEQ
  6284	403131'	260 17 0 00 404426'		PUSHJ	SP,U.24				; SP,SEND%PACKET
  6285						MOVE	AC1,U.52			; AC1,NUM%RETRIES			
  6286	403132'	200 01 0 00 000017'						3651
  6287	403133'	202 01 0 00 000016'		MOVEM	AC1,U.51			; AC1,OLD%RETRIES
  6288						SETZM	U.52				; NUM%RETRIES				
  6289	403134'	402 00 0 00 000017'						3652
  6290						MOVE	AC1,U.53			; AC1,MSG%NUMBER			
  6291	403135'	200 01 0 00 000020'						3653
  6292	403136'	271 01 0 00 000001 		ADDI	AC1,1				; AC1,1
  6293	403137'	135 02 0 00 401013'		LDB	AC2,C.18			; AC2,[POINT 6,AC1,35]  <0,6>
  6294	403140'	202 02 0 00 000020'		MOVEM	AC2,U.53			; AC2,MSG%NUMBER
  6295						ADJSP	SP,-2				; SP,-2					
  6296	403141'	105 17 0 00 777776 						3595
  6297						MOVEI	AC1,10				; AC1,10				
  6298	403142'	201 01 0 00 000010 						3591
  6299	403143'	254 00 0 00 403312'		JRST	L.215				; L.215
  6300					L.197:	CAIE	AC1,106				; AC1,106				
  6301	403144'	302 01 0 00 000106 						3657
  6302	403145'	306 01 0 00 000130 		CAIN	AC1,130				; AC1,130
  6303	403146'	254 00 0 00 403150'		JRST	L.198				; L.198
  6304	403147'	254 00 0 00 403173'		JRST	L.201				; L.201
  6305					L.198:	MOVE	AC1,U.51			; AC1,OLD%RETRIES			
  6306	403150'	200 01 0 00 000016'						3660
  6307	403151'	317 01 0 00 403102*		CAMG	AC1,PKT%RETRIES			; AC1,PKT%RETRIES
  6308	403152'	254 00 0 00 403155'		JRST	L.200				; L.200
  6309	403153'	201 01 0 00 000024 	L.199:	MOVEI	AC1,24				; AC1,24
  6310	403154'	254 00 0 00 403313'		JRST	L.216				; L.216
  6311					L.200:	AOS	U.51				; OLD%RETRIES				
  6312	403155'	350 00 0 00 000016'						3662
  6313						MOVE	AC1,U.53			; AC1,MSG%NUMBER			
  6314	403156'	200 01 0 00 000020'						3664
  6315	403157'	275 01 0 00 000001 		SUBI	AC1,1				; AC1,1
  6316	403160'	135 02 0 00 401013'		LDB	AC2,C.18			; AC2,[POINT 6,AC1,35]  <0,6>
  6317	403161'	312 02 0 00 000021'		CAME	AC2,U.54			; AC2,REC%SEQ
  6318	403162'	254 00 0 00 403307'		JRST	L.214				; L.214
  6319						PUSH	SP,C.20				; SP,[131]				
  6320	403163'	261 17 0 00 401015'						3667
  6321	403164'	261 17 0 00 401023'		PUSH	SP,C.26				; SP,[0]
  6322	403165'	261 17 0 00 000021'		PUSH	SP,U.54				; SP,REC%SEQ
  6323	403166'	260 17 0 00 404426'		PUSHJ	SP,U.24				; SP,SEND%PACKET
  6324						SETZM	U.52				; NUM%RETRIES				
  6325	403167'	402 00 0 00 000017'						3668
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-115
KERMSG	MAC	18-Jan-73 17:20	

  6326						ADJSP	SP,-2				; SP,-2					
  6327	403170'	105 17 0 00 777776 						3666
  6328						MOVE	AC1,U.49			; AC1,STATE				
  6329	403171'	200 01 0 00 000014'						3672
  6330	403172'	254 00 0 00 403312'		JRST	L.215				; L.215
  6331					L.201:	CAIE	AC1,132				; AC1,132				
  6332	403173'	302 01 0 00 000132 						3679
  6333	403174'	254 00 0 00 403307'		JRST	L.214				; L.214
  6334						MOVE	AC1,U.53			; AC1,MSG%NUMBER			
  6335	403175'	200 01 0 00 000020'						3682
  6336	403176'	316 01 0 00 000021'		CAMN	AC1,U.54			; AC1,REC%SEQ
  6337	403177'	254 00 0 00 403204'		JRST	L.202				; L.202
  6338						PUSH	SP,C.22				; SP,[252]				
  6339	403200'	261 17 0 00 401017'						3685
  6340	403201'	260 17 0 00 403011*		PUSHJ	SP,KRM%ERROR			; SP,KRM%ERROR
  6341						ADJSP	SP,-1				; SP,-1					
  6342	403202'	105 17 0 00 777777 						3686
  6343	403203'	254 00 0 00 403256'		JRST	L.208				; L.208
  6344					L.202:	PUSH	SP,C.20				; SP,[131]				
  6345	403204'	261 17 0 00 401015'						3689
  6346	403205'	261 17 0 00 401023'		PUSH	SP,C.26				; SP,[0]
  6347	403206'	261 17 0 00 000021'		PUSH	SP,U.54				; SP,REC%SEQ
  6348	403207'	260 17 0 00 404426'		PUSHJ	SP,U.24				; SP,SEND%PACKET
  6349						MOVEI	AC1,1				; AC1,1					
  6350	403210'	201 01 0 00 000001 						3691
  6351	403211'	612 01 0 00 000106'		TDNE	AC1,U.61			; AC1,TEXT%HEAD%FLAG
  6352	403212'	254 00 0 00 403273'		JRST	L.212				; L.212
  6353						SETZB	AC16,U.59			; DISCARD%FILE%FLAG,FILE%OPEN%FLAG	
  6354	403213'	403 16 0 00 000104'						3694
  6355						MOVEI	AC1,1				; AC1,1					
  6356	403214'	201 01 0 00 000001 						3697
  6357	403215'	312 01 0 00 000022'		CAME	AC1,U.55			; AC1,REC%LENGTH
  6358	403216'	254 00 0 00 403223'		JRST	L.203				; L.203
  6359						MOVE	AC1,C.29			; AC1,[POINT 8,REC%MSG,31]  <4,8>	
  6360	403217'	200 01 0 00 401341'						3700
  6361	403220'	134 01 0 00 000001 		ILDB	AC1,AC1				; AC1,AC1
  6362	403221'	306 01 0 00 000104 		CAIN	AC1,104				; AC1,104
  6363						MOVEI	AC16,1				; DISCARD%FILE%FLAG,1			
  6364	403222'	201 16 0 00 000001 						3702
  6365					L.203:	MOVEI	AC1,1				; AC1,1					
  6366	403223'	201 01 0 00 000001 						3704
  6367	403224'	612 01 0 00 402650*		TDNE	AC1,CONNECT%FLAG		; AC1,CONNECT%FLAG
  6368	403225'	254 00 0 00 403246'		JRST	L.207				; L.207
  6369	403226'	201 01 0 00 000001 		MOVEI	AC1,1				; AC1,1
  6370	403227'	616 01 0 00 402653*		TDNN	AC1,TY%FIL			; AC1,TY%FIL
  6371	403230'	254 00 0 00 403246'		JRST	L.207				; L.207
  6372						TRNN	AC16,1				; DISCARD%FILE%FLAG,1			
  6373	403231'	606 16 0 00 000001 						3708
  6374	403232'	254 00 0 00 403242'		JRST	L.205				; L.205
  6375						MOVEI	AC1,1				; AC1,1					
  6376	403233'	201 01 0 00 000001 						3711
  6377	403234'	616 01 0 00 400512*		TDNN	AC1,ABT%FLAG			; AC1,ABT%FLAG
  6378	403235'	254 00 0 00 403240'		JRST	L.204				; L.204
  6379						PUSH	SP,C.53				; SP,[0,,P.AAL]				
  6380	403236'	261 17 0 00 403316'						3713
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-116
KERMSG	MAC	18-Jan-73 17:20	

  6381	403237'	254 00 0 00 403243'		JRST	L.206				; L.206
  6382					L.204:	PUSH	SP,C.54				; SP,[0,,P.AAM]				
  6383	403240'	261 17 0 00 403317'						3715
  6384	403241'	254 00 0 00 403243'		JRST	L.206				; L.206
  6385					L.205:	PUSH	SP,C.55				; SP,[0,,P.AAN]				
  6386	403242'	261 17 0 00 403320'						3718
  6387	403243'	260 17 0 00 402746*	L.206:	PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
  6388						PUSHJ	SP,TT%CRLF			; SP,TT%CRLF				
  6389	403244'	260 17 0 00 402747*						3720
  6390						ADJSP	SP,-1				; SP,-1					
  6391	403245'	105 17 0 00 777777 						3706
  6392					L.207:	MOVE	AC1,AC16			; AC1,DISCARD%FILE%FLAG			
  6393	403246'	200 01 0 00 000016 						3723
  6394	403247'	404 01 0 00 403234*		AND	AC1,ABT%FLAG			; AC1,ABT%FLAG
  6395	403250'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
  6396	403251'	260 17 0 00 401316*		PUSHJ	SP,FILE%CLOSE			; SP,FILE%CLOSE
  6397	403252'	105 17 0 00 777777 		ADJSP	SP,-1				; SP,-1
  6398	403253'	602 01 0 00 000001 		TRNE	AC1,1				; AC1,1
  6399	403254'	254 00 0 00 403260'		JRST	L.209				; L.209
  6400	403255'	105 17 0 00 777775 		ADJSP	SP,-3				; SP,-3
  6401	403256'	201 01 0 00 000012 	L.208:	MOVEI	AC1,12				; AC1,12
  6402	403257'	254 00 0 00 403313'		JRST	L.216				; L.216
  6403					L.209:	TRNN	AC16,1				; DISCARD%FILE%FLAG,1			
  6404	403260'	606 16 0 00 000001 						3725
  6405	403261'	254 00 0 00 403271'		JRST	L.211				; L.211
  6406						MOVEI	AC1,1				; AC1,1					
  6407	403262'	201 01 0 00 000001 						3728
  6408	403263'	616 01 0 00 403247*		TDNN	AC1,ABT%FLAG			; AC1,ABT%FLAG
  6409	403264'	254 00 0 00 403267'		JRST	L.210				; L.210
  6410	403265'	201 01 0 00 000130 		MOVEI	AC1,130				; SUB%TYPE,130
  6411	403266'	254 00 0 00 403275'		JRST	L.213				; L.213
  6412	403267'	201 01 0 00 000104 	L.210:	MOVEI	AC1,104				; SUB%TYPE,104
  6413						JRST	L.213				; L.213					
  6414	403270'	254 00 0 00 403275'						3725
  6415					L.211:	MOVEI	AC1,103				; SUB%TYPE,103				
  6416	403271'	201 01 0 00 000103 						3731
  6417						JRST	L.213				; L.213					
  6418	403272'	254 00 0 00 403275'						3691
  6419					L.212:	PUSHJ	SP,TT%CRLF			; SP,TT%CRLF				
  6420	403273'	260 17 0 00 403244*						3736
  6421						PUSHJ	SP,TT%OUTPUT			; SP,TT%OUTPUT				
  6422	403274'	260 17 0 00 402661*						3737
  6423					L.213:	PUSH	SP,C.15				; SP,[106]				
  6424	403275'	261 17 0 00 400603'						3740
  6425	403276'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,SUB%TYPE
  6426	403277'	260 17 0 00 402706*		PUSHJ	SP,XFR%STATUS			; SP,XFR%STATUS
  6427						MOVE	AC1,U.53			; AC1,MSG%NUMBER			
  6428	403300'	200 01 0 00 000020'						3741
  6429	403301'	271 01 0 00 000001 		ADDI	AC1,1				; AC1,1
  6430	403302'	135 02 0 00 401013'		LDB	AC2,C.18			; AC2,[POINT 6,AC1,35]  <0,6>
  6431	403303'	202 02 0 00 000020'		MOVEM	AC2,U.53			; AC2,MSG%NUMBER
  6432						ADJSP	SP,-4				; SP,-4					
  6433	403304'	105 17 0 00 777774 						3680
  6434						MOVEI	AC1,7				; AC1,7					
  6435	403305'	201 01 0 00 000007 						3591
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-117
KERMSG	MAC	18-Jan-73 17:20	

  6436	403306'	254 00 0 00 403312'		JRST	L.215				; L.215
  6437					L.214:	PUSH	SP,C.22				; SP,[252]				
  6438	403307'	261 17 0 00 401017'						3747
  6439	403310'	260 17 0 00 403201*		PUSHJ	SP,KRM%ERROR			; SP,KRM%ERROR
  6440						MOVEI	AC1,12				; AC1,12				
  6441	403311'	201 01 0 00 000012 						3591
  6442					L.215:	ADJSP	SP,-1				; SP,-1					
  6443	403312'	105 17 0 00 777777 						3746
  6444					L.216:	POP	SP,AC16				; SP,AC16				
  6445	403313'	262 17 0 00 000016 						3522
  6446	403314'	263 17 0 00 000000 		POPJ	SP,				; SP,
  6447	403315'	000000	403022'		C.52:	XWD	0,U.78				; 0,CHECK%DATA
  6448	403316'	000000	403045'		C.53:	XWD	0,P.AAL				; 0,P.AAL
  6449	403317'	000000	403050'		C.54:	XWD	0,P.AAM				; 0,P.AAM
  6450	403320'	000000	403057'		C.55:	XWD	0,P.AAN				; 0,P.AAN
  6451
  6452					; Routine Size:  160 words
  6453
  6454
  6455					;   3753  1	%SBTTL 'SERVER - Generic commands'
  6456					;   3754  1	ROUTINE SERVER%GENERIC =
  6457					;   3755  1	
  6458					;   3756  1	!++
  6459					;   3757  1	! FUNCTIONAL DESCRIPTION:
  6460					;   3758  1	!
  6461					;   3759  1	!	This routine will handle the generic server messages.
  6462					;   3760  1	!	The generic server messages include FINISH, LOGOUT.
  6463					;   3761  1	!
  6464					;   3762  1	! CALLING SEQUENCE:
  6465					;   3763  1	!
  6466					;   3764  1	!	STATE = SERVER%GENERIC();
  6467					;   3765  1	!
  6468					;   3766  1	! INPUT PARAMETERS:
  6469					;   3767  1	!
  6470					;   3768  1	!	None.
  6471					;   3769  1	!
  6472					;   3770  1	! IMPLICIT INPUTS:
  6473					;   3771  1	!
  6474					;   3772  1	!	Generic message receive in REC%MSG.
  6475					;   3773  1	!
  6476					;   3774  1	! OUTPUT PARAMETERS:
  6477					;   3775  1	!
  6478					;   3776  1	!	Returns new state for FSM
  6479					;   3777  1	!
  6480					;   3778  1	! IMPLICIT OUTPUTS:
  6481					;   3779  1	!
  6482					;   3780  1	!	None.
  6483					;   3781  1	!
  6484					;   3782  1	! COMPLETION CODES:
  6485					;   3783  1	!
  6486					;   3784  1	!	None.
  6487					;   3785  1	!
  6488					;   3786  1	! SIDE EFFECTS:
  6489					;   3787  1	!
  6490					;   3788  1	!	None.
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-118
KERMSG	MAC	18-Jan-73 17:20	

  6491					;   3789  1	!
  6492					;   3790  1	!--
  6493					;   3791  1	
  6494					;   3792  2	    BEGIN
  6495					;   3793  2	
  6496					;   3794  2	    LOCAL
  6497					;   3795  2		STATUS,					! Returned status
  6498					;   3796  2		G%FUNC,					! Generic command function
  6499					;   3797  2		POINTER,				! Character pointer
  6500					;   3798  2		DATA%TEXT : VECTOR [CH$ALLOCATION (MAX%MSG)],	! Unpacked message
  6501					;   3799  2		DATA%SIZE;				! Actual size of data
  6502					;   3800  2	
  6503					;   3801  2	    ROUTINE UNPACK%DATA (POINTER, SIZE, DST%ADDR, DST%LEN) =
  6504					;   3802  2	!
  6505					;   3803  2	! Routine to unpack an argument.
  6506					;   3804  2	! This will copy the argument data to the desired buffer.
  6507					;   3805  2	!
  6508					;   3806  3		BEGIN
  6509					;   3807  3	
  6510					;   3808  3		IF .SIZE GTR 0				! If we have something to un
  6511					pack
  6512					;   3809  3		THEN
  6513					;   3810  4		    BEGIN
  6514					;   3811  4		    .DST%LEN = UNCHAR (CH$RCHAR%A (.POINTER));
  6515					;   3812  4	
  6516					;   3813  4		    IF ..DST%LEN LSS 0
  6517					;   3814  4		    THEN
  6518					;   3815  5			BEGIN
  6519					;   3816  5			KRM%ERROR (KER%PROTOERR);	! Someone screwed up
  6520					;   3817  5			..DST%LEN = 0;
  6521					;   3818  5			RETURN -1;
  6522					;   3819  4			END;
  6523					;   3820  4	
  6524					;   3821  4		    IF ..DST%LEN GTR .SIZE - 1 THEN .DST%LEN = .SIZE - 1;
  6525					;   3822  4	
  6526					;   3823  4		    CH$COPY (..DST%LEN, ..POINTER, CHR%NUL, MAX%MSG, CH$PTR (.DST%AD
  6527					DR));
  6528					;   3824  4		    .POINTER = CH$PLUS (..POINTER, ..DST%LEN);
  6529					;   3825  4		    RETURN .SIZE - ..DST%LEN - 1;
  6530					;   3826  4		    END
  6531					;   3827  3		ELSE
  6532					;   3828  3	!
  6533					;   3829  3	! If nothing left in buffer, return the current size (0)
  6534					;   3830  3	!
  6535					;   3831  3		    RETURN .SIZE;
  6536					;   3832  3	
  6537					;   3833  2		END;
  6538
  6539
  6540					; UNPACK%DATA
  6541					U.79:	PUSH	SP,AC12				; SP,AC12				
  6542	403321'	261 17 0 00 000012 						3801
  6543	403322'	261 17 0 00 000013 		PUSH	SP,AC13				; SP,AC13
  6544	403323'	261 17 0 00 000014 		PUSH	SP,AC14				; SP,AC14
  6545	403324'	261 17 0 00 000016 		PUSH	SP,AC16				; SP,AC16
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-119
KERMSG	MAC	18-Jan-73 17:20	

  6546						MOVE	AC12,-7(SP)			; AC12,SIZE				
  6547	403325'	200 12 0 17 777771 						3808
  6548	403326'	323 12 0 00 403366'		JUMPLE	AC12,L.218			; AC12,L.218
  6549						MOVE	AC13,-5(SP)			; AC13,DST%LEN				
  6550	403327'	200 13 0 17 777773 						3811
  6551	403330'	200 16 0 17 777770 		MOVE	AC16,-10(SP)			; AC16,POINTER
  6552	403331'	134 01 0 16 000000 		ILDB	AC1,0(AC16)			; AC1,0(AC16)
  6553	403332'	275 01 0 00 000040 		SUBI	AC1,40				; AC1,40
  6554	403333'	202 01 0 13 000000 		MOVEM	AC1,0(AC13)			; AC1,0(AC13)
  6555						MOVE	AC14,0(AC13)			; AC14,0(AC13)				
  6556	403334'	200 14 0 13 000000 						3813
  6557	403335'	325 14 0 00 403344'		JUMPGE	AC14,L.217			; AC14,L.217
  6558						PUSH	SP,C.22				; SP,[252]				
  6559	403336'	261 17 0 00 401017'						3816
  6560	403337'	260 17 0 00 403310*		PUSHJ	SP,KRM%ERROR			; SP,KRM%ERROR
  6561						SETZM	0(AC14)				; 0(AC14)				
  6562	403340'	402 00 0 14 000000 						3817
  6563						ADJSP	SP,-1				; SP,-1					
  6564	403341'	105 17 0 00 777777 						3818
  6565						SETO	AC1,				; AC1,					
  6566	403342'	474 01 0 00 000000 						3815
  6567	403343'	254 00 0 00 403367'		JRST	L.219				; L.219
  6568					L.217:	MOVE	AC1,AC12			; AC1,AC12				
  6569	403344'	200 01 0 00 000012 						3821
  6570	403345'	275 01 0 00 000001 		SUBI	AC1,1				; AC1,1
  6571	403346'	313 14 0 00 000001 		CAMLE	AC14,AC1			; AC14,AC1
  6572	403347'	202 01 0 13 000000 		MOVEM	AC1,0(AC13)			; AC1,0(AC13)
  6573						MOVE	AC1,-6(SP)			; AC1,DST%ADDR				
  6574	403350'	200 01 0 17 777772 						3823
  6575	403351'	201 05 0 01 777777 		MOVEI	AC5,-1(AC1)			; AC5,-1(AC1)
  6576	403352'	505 05 0 00 010700 		HRLI	AC5,10700			; AC5,10700
  6577	403353'	200 01 0 13 000000 		MOVE	AC1,0(AC13)			; AC1,0(AC13)
  6578	403354'	200 02 0 16 000000 		MOVE	AC2,0(AC16)			; AC2,0(AC16)
  6579	403355'	201 04 0 00 000140 		MOVEI	AC4,140				; AC4,140
  6580	403356'	123 01 0 00 400142'		EXTEND	AC1,C.1				; AC1,C.1
  6581	403357'	255 00 0 00 000000 		JFCL					;
  6582						MOVE	AC1,0(AC13)			; AC1,0(AC13)				
  6583	403360'	200 01 0 13 000000 						3824
  6584	403361'	133 01 0 16 000000 		ADJBP	AC1,0(AC16)			; AC1,0(AC16)
  6585	403362'	202 01 0 16 000000 		MOVEM	AC1,0(AC16)			; AC1,0(AC16)
  6586						MOVE	AC1,AC12			; AC1,AC12				
  6587	403363'	200 01 0 00 000012 						3825
  6588	403364'	274 01 0 13 000000 		SUB	AC1,0(AC13)			; AC1,0(AC13)
  6589						SOJA	AC1,L.219			; AC1,L.219				
  6590	403365'	364 01 0 00 403367'						3831
  6591	403366'	200 01 0 00 000012 	L.218:	MOVE	AC1,AC12			; AC1,AC12
  6592					L.219:	POP	SP,AC16				; SP,AC16				
  6593	403367'	262 17 0 00 000016 						3801
  6594	403370'	262 17 0 00 000014 		POP	SP,AC14				; SP,AC14
  6595	403371'	262 17 0 00 000013 		POP	SP,AC13				; SP,AC13
  6596	403372'	262 17 0 00 000012 		POP	SP,AC12				; SP,AC12
  6597	403373'	263 17 0 00 000000 		POPJ	SP,				; SP,
  6598
  6599					; Routine Size:  43 words
  6600
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-120
KERMSG	MAC	18-Jan-73 17:20	

  6601
  6602					;   3834  2	!
  6603					;   3835  2	! First unpack the message data into its various pieces
  6604					;   3836  2	!
  6605					;   3837  2	    SET%STRING (CH$PTR (DATA%TEXT), MAX%MSG, TRUE);	! Initialize for unp
  6606					acking
  6607					;   3838  2	    BFR%EMPTY ();				! Unpack the data
  6608					;   3839  2	    DATA%SIZE = SET%STRING (0, 0, FALSE);	! All done, get size
  6609					;   3840  2	
  6610					;   3841  2	    IF .DATA%SIZE LEQ 0
  6611					;   3842  2	    THEN
  6612					;   3843  3		BEGIN
  6613					;   3844  3		KRM%ERROR (KER%PROTOERR);		! Someone screwed up
  6614					;   3845  3		RETURN STATE%A;				! Since no subtype
  6615					;   3846  2		END;
  6616					;   3847  2	
  6617					;   3848  2	!
  6618					;   3849  2	! Get the arguments from the unpacked data (if any)
  6619					;   3850  2	!
  6620					;   3851  2	    GEN%1SIZE = 0;				! Assume no args
  6621					;   3852  2	    GEN%2SIZE = 0;				! none at all
  6622					;   3853  2	    GEN%3SIZE = 0;
  6623					;   3854  2	    CH$WCHAR (CHR%NUL, CH$PTR (GEN%1DATA));	! Ensure all are null termin
  6624					ated
  6625					;   3855  2	    CH$WCHAR (CHR%NUL, CH$PTR (GEN%2DATA));
  6626					;   3856  2	    CH$WCHAR (CHR%NUL, CH$PTR (GEN%3DATA));
  6627					;   3857  2	    POINTER = CH$PTR (DATA%TEXT, 1);		! Point at second character
  6628					;   3858  2	    DATA%SIZE = .DATA%SIZE - 1;			! Account for subtype
  6629					;   3859  2	
  6630					;   3860  2	    IF .DATA%SIZE GTR 0				! Room for first arg?
  6631					;   3861  2	    THEN
  6632					;   3862  3		BEGIN
  6633					;   3863  3		DATA%SIZE = UNPACK%DATA (POINTER, .DATA%SIZE, GEN%1DATA, GEN%1SIZE);
  6634
  6635					;   3864  3	
  6636					;   3865  3		IF .DATA%SIZE LSS 0 THEN RETURN STATE%A;	! Punt if bad argume
  6637					nts
  6638					;   3866  3	
  6639					;   3867  3		IF .DATA%SIZE GTR 0			! Second argument present?
  6640					;   3868  3		THEN
  6641					;   3869  4		    BEGIN
  6642					;   3870  4		    DATA%SIZE = UNPACK%DATA (POINTER, .DATA%SIZE, GEN%2DATA, GEN%2SI
  6643					ZE);
  6644					;   3871  4	
  6645					;   3872  4		    IF .DATA%SIZE LSS 0 THEN RETURN STATE%A;	! Punt if bad argume
  6646					nts
  6647					;   3873  4	
  6648					;   3874  4		    IF .DATA%SIZE GTR 0			! Third argument here?
  6649					;   3875  4		    THEN
  6650					;   3876  5			BEGIN
  6651					;   3877  5			DATA%SIZE = UNPACK%DATA (POINTER, .DATA%SIZE, GEN%3DATA, GEN
  6652					%3SIZE);
  6653					;   3878  5	
  6654					;   3879  5			IF .DATA%SIZE LSS 0 THEN RETURN STATE%A;	! Punt if ba
  6655					d arguments
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-121
KERMSG	MAC	18-Jan-73 17:20	

  6656					;   3880  5	
  6657					;   3881  4			END;
  6658					;   3882  4	
  6659					;   3883  3		    END;
  6660					;   3884  3	
  6661					;   3885  2		END;
  6662					;   3886  2	
  6663					;   3887  2	    SELECTONE CH$RCHAR (CH$PTR (DATA%TEXT)) OF
  6664					;   3888  2		SET
  6665					;   3889  2		!
  6666					;   3890  2		! EXIT command, just return the status to the upper level
  6667					;   3891  2		!
  6668					;   3892  2	
  6669					;   3893  2		[MSG%GEN%EXIT] :
  6670					;   3894  3		    BEGIN
  6671					;   3895  3		    SEND%PACKET (MSG%ACK, 0, .REC%SEQ);
  6672					;   3896  3		    RETURN STATE%FI;
  6673					;   3897  2		    END;
  6674					;   3898  2		!
  6675					;   3899  2		! LOGOUT command, ACK the message then call the system routine to
  6676					;   3900  2		! kill the process (log the job out, etc.)
  6677					;   3901  2		!
  6678					;   3902  2	
  6679					;   3903  2		[MSG%GEN%LOGOUT] :
  6680					;   3904  3		    BEGIN
  6681					;   3905  3		    SEND%PACKET (MSG%ACK, 0, .REC%SEQ);
  6682					;   3906  3		    SY%LOGOUT ();
  6683					;   3907  3		    RETURN STATE%LG;
  6684					;   3908  2		    END;
  6685					;   3909  2	!
  6686					;   3910  2	! For a type command, just set up a transfer flagging we want a text header
  6687					;   3911  2	! instead of a file header.
  6688					;   3912  2	!
  6689					;   3913  2	
  6690					;   3914  2		[MSG%GEN%TYPE] :
  6691					;   3915  3		    BEGIN
  6692					;   3916  3		    CH$COPY (.GEN%1SIZE, CH$PTR (GEN%1DATA), CHR%NUL, MAX%FILE%NAME,
  6693					 CH$PTR (FILE%NAME));
  6694					;   3917  3		    FILE%SIZE = .GEN%1SIZE;
  6695					;   3918  3		    TEXT%HEAD%FLAG = TRUE;		! Now want text header
  6696					;   3919  3		    XFR%STATUS (%C'I', %C'G');		! Tell display routine we ar
  6697					e doing a command
  6698					;   3920  3	
  6699					;   3921  3		    IF .STATE EQL STATE%II AND .BLK%CHK%TYPE EQL .INI%CHK%TYPE
  6700					;   3922  3		    THEN
  6701					;   3923  3			RETURN STATE%OF			! Must open the file
  6702					;   3924  3		    ELSE
  6703					;   3925  3			RETURN STATE%S;			! Start the transaction with
  6704					 a send
  6705					;   3926  3	
  6706					;   3927  2		    END;
  6707					;   3928  2	
  6708					;   3929  2		[MSG%GEN%DIRECTORY] :
  6709					;   3930  2		    G%FUNC = GC%DIRECTORY;
  6710					;   3931  2	
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-122
KERMSG	MAC	18-Jan-73 17:20	

  6711					;   3932  2		[MSG%GEN%DISK%USAGE] :
  6712					;   3933  2		    G%FUNC = GC%DISK%USAGE;
  6713					;   3934  2	
  6714					;   3935  2		[MSG%GEN%DELETE] :
  6715					;   3936  2		    G%FUNC = GC%DELETE;
  6716					;   3937  2	
  6717					;   3938  2		[MSG%GEN%HELP] :
  6718					;   3939  2		    G%FUNC = GC%HELP;
  6719					;   3940  2	
  6720					;   3941  2		[MSG%GEN%LOGIN] :
  6721					;   3942  2		    G%FUNC = GC%LGN;
  6722					;   3943  2	
  6723					;   3944  2		[MSG%GEN%CONNECT] :
  6724					;   3945  2		    G%FUNC = GC%CONNECT;
  6725					;   3946  2	
  6726					;   3947  2		[MSG%GEN%RENAME] :
  6727					;   3948  2		    G%FUNC = GC%RENAME;
  6728					;   3949  2	
  6729					;   3950  2		[MSG%GEN%COPY] :
  6730					;   3951  2		    G%FUNC = GC%COPY;
  6731					;   3952  2	
  6732					;   3953  2		[MSG%GEN%WHO] :
  6733					;   3954  2		    G%FUNC = GC%WHO;
  6734					;   3955  2	
  6735					;   3956  2		[MSG%GEN%SEND] :
  6736					;   3957  2		    G%FUNC = GC%SEND%MSG;
  6737					;   3958  2	
  6738					;   3959  2		[MSG%GEN%QUERY] :
  6739					;   3960  2		    G%FUNC = GC%STATUS;
  6740					;   3961  2	
  6741					;   3962  2		[MSG%GEN%PROGRAM] :
  6742					;   3963  2		    G%FUNC = GC%PROGRAM;
  6743					;   3964  2	
  6744					;   3965  2		[MSG%GEN%JOURNAL] :
  6745					;   3966  2		    G%FUNC = GC%JOURNAL;
  6746					;   3967  2	
  6747					;   3968  2		[MSG%GEN%VARIABLE] :
  6748					;   3969  2		    G%FUNC = GC%VARIABLE;
  6749					;   3970  2	!
  6750					;   3971  2	! Here if we have a function that is not implemented in KERMSG.
  6751					;   3972  2	!
  6752					;   3973  2	
  6753					;   3974  2		[OTHERWISE] :
  6754					;   3975  3		    BEGIN
  6755					;   3976  3		    KRM%ERROR (KER%UNIMPLGEN);
  6756					;   3977  3		    RETURN STATE%A;
  6757					;   3978  2		    END;
  6758					;   3979  2		TES;
  6759					;   3980  2	
  6760					;   3981  2	!
  6761					;   3982  2	! If we get here, we have gotten a known type of generic message that
  6762					;   3983  2	! we need to have our operating system dependent routine handle.
  6763					;   3984  2	!
  6764					;   3985  2	    RETURN CALL%SY%RTN (.G%FUNC);
  6765					;   3986  1	    END;					! End of SERVER%GENERIC
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-123
KERMSG	MAC	18-Jan-73 17:20	

  6766
  6767
  6768					; SERVER%GENERIC
  6769					U.14:	PUSH	SP,AC14				; SP,AC14				
  6770	403374'	261 17 0 00 000014 						3754
  6771	403375'	261 17 0 00 000016 		PUSH	SP,AC16				; SP,AC16
  6772	403376'	105 17 0 00 000025 		ADJSP	SP,25				; SP,25
  6773						MOVEI	AC1,-25(SP)			; AC1,DATA%TEXT-1			
  6774	403377'	201 01 0 17 777753 						3837
  6775	403400'	505 01 0 00 010700 		HRLI	AC1,10700			; AC1,10700
  6776	403401'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
  6777	403402'	261 17 0 00 403664'		PUSH	SP,C.56				; SP,[140]
  6778	403403'	261 17 0 00 400144'		PUSH	SP,C.2				; SP,[1]
  6779	403404'	260 17 0 00 406157'		PUSHJ	SP,U.30				; SP,SET%STRING
  6780						PUSHJ	SP,U.28				; SP,BFR%EMPTY				
  6781	403405'	260 17 0 00 406030'						3838
  6782						SETZM	-2(SP)				; -2(SP)				
  6783	403406'	402 00 0 17 777776 						3839
  6784	403407'	402 00 0 17 777777 		SETZM	-1(SP)				; -1(SP)
  6785	403410'	402 00 0 17 000000 		SETZM	0(SP)				; 0(SP)
  6786	403411'	260 17 0 00 406157'		PUSHJ	SP,U.30				; SP,SET%STRING
  6787	403412'	200 14 0 00 000001 		MOVE	AC14,AC1			; DATA%SIZE,AC1
  6788						JUMPG	AC14,L.220			; DATA%SIZE,L.220			
  6789	403413'	327 14 0 00 403416'						3841
  6790						PUSH	SP,C.22				; SP,[252]				
  6791	403414'	261 17 0 00 401017'						3844
  6792	403415'	254 00 0 00 403651'		JRST	L.246				; L.246
  6793					L.220:	SETZM	GEN%1SIZE			; GEN%1SIZE				
  6794	403416'	402 00 0 00 402161*						3851
  6795						SETZM	GEN%2SIZE			; GEN%2SIZE				
  6796	403417'	402 00 0 00 402121*						3852
  6797						SETZB	AC2,GEN%3SIZE			; AC2,GEN%3SIZE				
  6798	403420'	403 02 0 00 402134*						3853
  6799						MOVE	AC1,C.11			; AC1,[POINT 7,GEN%1DATA-1,34]  <1,7>	
  6800	403421'	200 01 0 00 400260'						3854
  6801	403422'	136 02 0 00 000001 		IDPB	AC2,AC1				; AC2,AC1
  6802						SETZ	AC2,				; AC2,					
  6803	403423'	400 02 0 00 000000 						3855
  6804	403424'	200 01 0 00 403665'		MOVE	AC1,C.57			; AC1,[POINT 7,GEN%2DATA-1,34]  <1,7>
  6805	403425'	136 02 0 00 000001 		IDPB	AC2,AC1				; AC2,AC1
  6806						SETZ	AC2,				; AC2,					
  6807	403426'	400 02 0 00 000000 						3856
  6808	403427'	200 01 0 00 403666'		MOVE	AC1,C.58			; AC1,[POINT 7,GEN%3DATA-1,34]  <1,7>
  6809	403430'	136 02 0 00 000001 		IDPB	AC2,AC1				; AC2,AC1
  6810						MOVEI	AC1,-27(SP)			; AC1,DATA%TEXT				
  6811	403431'	201 01 0 17 777751 						3857
  6812	403432'	505 01 0 00 350700 		HRLI	AC1,350700			; AC1,350700
  6813	403433'	202 01 0 17 777775 		MOVEM	AC1,-3(SP)			; AC1,POINTER
  6814						SOJLE	AC14,L.226			; DATA%SIZE,L.226			
  6815	403434'	363 14 0 00 403500'						3860
  6816						MOVEI	AC1,-3(SP)			; AC1,POINTER				
  6817	403435'	201 01 0 17 777775 						3863
  6818	403436'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
  6819	403437'	261 17 0 00 000014 		PUSH	SP,AC14				; SP,DATA%SIZE
  6820	403440'	261 17 0 00 402344'		PUSH	SP,C.40				; SP,[0,,GEN%1DATA]
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-124
KERMSG	MAC	18-Jan-73 17:20	

  6821	403441'	261 17 0 00 403667'		PUSH	SP,C.59				; SP,[0,,GEN%1SIZE]
  6822	403442'	260 17 0 00 403321'		PUSHJ	SP,U.79				; SP,UNPACK%DATA
  6823	403443'	200 14 0 00 000001 		MOVE	AC14,AC1			; DATA%SIZE,AC1
  6824						JUMPGE	AC14,L.221			; DATA%SIZE,L.221			
  6825	403444'	325 14 0 00 403447'						3865
  6826	403445'	105 17 0 00 777771 		ADJSP	SP,-7				; SP,-7
  6827	403446'	254 00 0 00 403653'		JRST	L.247				; L.247
  6828					L.221:	JUMPLE	AC14,L.225			; DATA%SIZE,L.225			
  6829	403447'	323 14 0 00 403477'						3867
  6830						MOVEI	AC1,-7(SP)			; AC1,POINTER				
  6831	403450'	201 01 0 17 777771 						3870
  6832	403451'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
  6833	403452'	261 17 0 00 000014 		PUSH	SP,AC14				; SP,DATA%SIZE
  6834	403453'	261 17 0 00 402345'		PUSH	SP,C.41				; SP,[0,,GEN%2DATA]
  6835	403454'	261 17 0 00 403670'		PUSH	SP,C.60				; SP,[0,,GEN%2SIZE]
  6836	403455'	260 17 0 00 403321'		PUSHJ	SP,U.79				; SP,UNPACK%DATA
  6837	403456'	200 14 0 00 000001 		MOVE	AC14,AC1			; DATA%SIZE,AC1
  6838						JUMPGE	AC14,L.222			; DATA%SIZE,L.222			
  6839	403457'	325 14 0 00 403462'						3872
  6840	403460'	105 17 0 00 777765 		ADJSP	SP,-13				; SP,-13
  6841	403461'	254 00 0 00 403653'		JRST	L.247				; L.247
  6842					L.222:	JUMPLE	AC14,L.224			; DATA%SIZE,L.224			
  6843	403462'	323 14 0 00 403476'						3874
  6844						MOVEI	AC1,-13(SP)			; AC1,POINTER				
  6845	403463'	201 01 0 17 777765 						3877
  6846	403464'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
  6847	403465'	261 17 0 00 000014 		PUSH	SP,AC14				; SP,DATA%SIZE
  6848	403466'	261 17 0 00 402346'		PUSH	SP,C.42				; SP,[0,,GEN%3DATA]
  6849	403467'	261 17 0 00 403671'		PUSH	SP,C.61				; SP,[0,,GEN%3SIZE]
  6850	403470'	260 17 0 00 403321'		PUSHJ	SP,U.79				; SP,UNPACK%DATA
  6851	403471'	200 14 0 00 000001 		MOVE	AC14,AC1			; DATA%SIZE,AC1
  6852						JUMPGE	AC14,L.223			; DATA%SIZE,L.223			
  6853	403472'	325 14 0 00 403475'						3879
  6854	403473'	105 17 0 00 777761 		ADJSP	SP,-17				; SP,-17
  6855	403474'	254 00 0 00 403653'		JRST	L.247				; L.247
  6856					L.223:	ADJSP	SP,-4				; SP,-4					
  6857	403475'	105 17 0 00 777774 						3876
  6858					L.224:	ADJSP	SP,-4				; SP,-4					
  6859	403476'	105 17 0 00 777774 						3869
  6860					L.225:	ADJSP	SP,-4				; SP,-4					
  6861	403477'	105 17 0 00 777774 						3862
  6862					L.226:	MOVEI	AC1,-30(SP)			; AC1,DATA%TEXT-1			
  6863	403500'	201 01 0 17 777750 						3887
  6864	403501'	505 01 0 00 010700 		HRLI	AC1,10700			; AC1,10700
  6865	403502'	134 16 0 00 000001 		ILDB	AC16,AC1			; AC16,AC1
  6866						CAIE	AC16,106			; AC16,106				
  6867	403503'	302 16 0 00 000106 						3893
  6868	403504'	254 00 0 00 403514'		JRST	L.227				; L.227
  6869						PUSH	SP,C.20				; SP,[131]				
  6870	403505'	261 17 0 00 401015'						3895
  6871	403506'	261 17 0 00 401023'		PUSH	SP,C.26				; SP,[0]
  6872	403507'	261 17 0 00 000021'		PUSH	SP,U.54				; SP,REC%SEQ
  6873	403510'	260 17 0 00 404426'		PUSHJ	SP,U.24				; SP,SEND%PACKET
  6874						ADJSP	SP,-6				; SP,-6					
  6875	403511'	105 17 0 00 777772 						3896
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-125
KERMSG	MAC	18-Jan-73 17:20	

  6876						MOVEI	AC1,20				; AC1,20				
  6877	403512'	201 01 0 00 000020 						3894
  6878	403513'	254 00 0 00 403660'		JRST	L.249				; L.249
  6879					L.227:	CAIE	AC16,114			; AC16,114				
  6880	403514'	302 16 0 00 000114 						3903
  6881	403515'	254 00 0 00 403526'		JRST	L.228				; L.228
  6882						PUSH	SP,C.20				; SP,[131]				
  6883	403516'	261 17 0 00 401015'						3905
  6884	403517'	261 17 0 00 401023'		PUSH	SP,C.26				; SP,[0]
  6885	403520'	261 17 0 00 000021'		PUSH	SP,U.54				; SP,REC%SEQ
  6886	403521'	260 17 0 00 404426'		PUSHJ	SP,U.24				; SP,SEND%PACKET
  6887						PUSHJ	SP,SY%LOGOUT			; SP,SY%LOGOUT				
  6888	403522'	260 17 0 00 000000*						3906
  6889						ADJSP	SP,-6				; SP,-6					
  6890	403523'	105 17 0 00 777772 						3907
  6891						MOVEI	AC1,21				; AC1,21				
  6892	403524'	201 01 0 00 000021 						3904
  6893	403525'	254 00 0 00 403660'		JRST	L.249				; L.249
  6894					L.228:	CAIE	AC16,124			; AC16,124				
  6895	403526'	302 16 0 00 000124 						3914
  6896	403527'	254 00 0 00 403560'		JRST	L.231				; L.231
  6897						MOVE	AC1,GEN%1SIZE			; AC1,GEN%1SIZE				
  6898	403530'	200 01 0 00 403416*						3916
  6899	403531'	200 02 0 00 400260'		MOVE	AC2,C.11			; AC2,[POINT 7,GEN%1DATA-1,34]  <1,7>
  6900	403532'	201 04 0 00 000204 		MOVEI	AC4,204				; AC4,204
  6901	403533'	200 05 0 00 400257'		MOVE	AC5,C.10			; AC5,[POINT 7,FILE%NAME-1,34]  <1,7>
  6902	403534'	123 01 0 00 400142'		EXTEND	AC1,C.1				; AC1,C.1
  6903	403535'	255 00 0 00 000000 		JFCL					;
  6904						MOVE	AC1,GEN%1SIZE			; AC1,GEN%1SIZE				
  6905	403536'	200 01 0 00 403530*						3917
  6906	403537'	202 01 0 00 402644*		MOVEM	AC1,FILE%SIZE			; AC1,FILE%SIZE
  6907						MOVEI	AC1,1				; AC1,1					
  6908	403540'	201 01 0 00 000001 						3918
  6909	403541'	202 01 0 00 000106'		MOVEM	AC1,U.61			; AC1,TEXT%HEAD%FLAG
  6910						PUSH	SP,C.6				; SP,[111]				
  6911	403542'	261 17 0 00 400170'						3919
  6912	403543'	261 17 0 00 403672'		PUSH	SP,C.62				; SP,[107]
  6913	403544'	260 17 0 00 403277*		PUSHJ	SP,XFR%STATUS			; SP,XFR%STATUS
  6914						MOVEI	AC1,17				; AC1,17				
  6915	403545'	201 01 0 00 000017 						3921
  6916	403546'	312 01 0 00 000014'		CAME	AC1,U.49			; AC1,STATE
  6917	403547'	254 00 0 00 403555'		JRST	L.229				; L.229
  6918	403550'	200 01 0 00 000011'		MOVE	AC1,U.46			; AC1,BLK%CHK%TYPE
  6919	403551'	312 01 0 00 000010'		CAME	AC1,U.45			; AC1,INI%CHK%TYPE
  6920	403552'	254 00 0 00 403555'		JRST	L.229				; L.229
  6921						MOVEI	AC1,22				; AC1,22				
  6922	403553'	201 01 0 00 000022 						3925
  6923	403554'	254 00 0 00 403556'		JRST	L.230				; L.230
  6924	403555'	201 01 0 00 000001 	L.229:	MOVEI	AC1,1				; AC1,1
  6925					L.230:	ADJSP	SP,-5				; SP,-5					
  6926	403556'	105 17 0 00 777773 						3921
  6927						JRST	L.249				; L.249					
  6928	403557'	254 00 0 00 403660'						3915
  6929					L.231:	CAIE	AC16,104			; AC16,104				
  6930	403560'	302 16 0 00 000104 						3929
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-126
KERMSG	MAC	18-Jan-73 17:20	

  6931	403561'	254 00 0 00 403564'		JRST	L.232				; L.232
  6932						MOVEI	AC14,2				; G%FUNC,2				
  6933	403562'	201 14 0 00 000002 						3930
  6934						JRST	L.248				; L.248					
  6935	403563'	254 00 0 00 403655'						3887
  6936					L.232:	CAIE	AC16,125			; AC16,125				
  6937	403564'	302 16 0 00 000125 						3932
  6938	403565'	254 00 0 00 403570'		JRST	L.233				; L.233
  6939						MOVEI	AC14,3				; G%FUNC,3				
  6940	403566'	201 14 0 00 000003 						3933
  6941						JRST	L.248				; L.248					
  6942	403567'	254 00 0 00 403655'						3887
  6943					L.233:	CAIE	AC16,105			; AC16,105				
  6944	403570'	302 16 0 00 000105 						3935
  6945	403571'	254 00 0 00 403574'		JRST	L.234				; L.234
  6946						MOVEI	AC14,4				; G%FUNC,4				
  6947	403572'	201 14 0 00 000004 						3936
  6948						JRST	L.248				; L.248					
  6949	403573'	254 00 0 00 403655'						3887
  6950					L.234:	CAIE	AC16,110			; AC16,110				
  6951	403574'	302 16 0 00 000110 						3938
  6952	403575'	254 00 0 00 403600'		JRST	L.235				; L.235
  6953						MOVEI	AC14,6				; G%FUNC,6				
  6954	403576'	201 14 0 00 000006 						3939
  6955						JRST	L.248				; L.248					
  6956	403577'	254 00 0 00 403655'						3887
  6957					L.235:	CAIE	AC16,111			; AC16,111				
  6958	403600'	302 16 0 00 000111 						3941
  6959	403601'	254 00 0 00 403604'		JRST	L.236				; L.236
  6960						MOVEI	AC14,10				; G%FUNC,10				
  6961	403602'	201 14 0 00 000010 						3942
  6962						JRST	L.248				; L.248					
  6963	403603'	254 00 0 00 403655'						3887
  6964					L.236:	CAIE	AC16,103			; AC16,103				
  6965	403604'	302 16 0 00 000103 						3944
  6966	403605'	254 00 0 00 403610'		JRST	L.237				; L.237
  6967						MOVEI	AC14,11				; G%FUNC,11				
  6968	403606'	201 14 0 00 000011 						3945
  6969						JRST	L.248				; L.248					
  6970	403607'	254 00 0 00 403655'						3887
  6971					L.237:	CAIE	AC16,122			; AC16,122				
  6972	403610'	302 16 0 00 000122 						3947
  6973	403611'	254 00 0 00 403614'		JRST	L.238				; L.238
  6974						MOVEI	AC14,12				; G%FUNC,12				
  6975	403612'	201 14 0 00 000012 						3948
  6976						JRST	L.248				; L.248					
  6977	403613'	254 00 0 00 403655'						3887
  6978					L.238:	CAIE	AC16,113			; AC16,113				
  6979	403614'	302 16 0 00 000113 						3950
  6980	403615'	254 00 0 00 403620'		JRST	L.239				; L.239
  6981						MOVEI	AC14,13				; G%FUNC,13				
  6982	403616'	201 14 0 00 000013 						3951
  6983						JRST	L.248				; L.248					
  6984	403617'	254 00 0 00 403655'						3887
  6985					L.239:	CAIE	AC16,127			; AC16,127				
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-127
KERMSG	MAC	18-Jan-73 17:20	

  6986	403620'	302 16 0 00 000127 						3953
  6987	403621'	254 00 0 00 403624'		JRST	L.240				; L.240
  6988						MOVEI	AC14,14				; G%FUNC,14				
  6989	403622'	201 14 0 00 000014 						3954
  6990						JRST	L.248				; L.248					
  6991	403623'	254 00 0 00 403655'						3887
  6992					L.240:	CAIE	AC16,115			; AC16,115				
  6993	403624'	302 16 0 00 000115 						3956
  6994	403625'	254 00 0 00 403630'		JRST	L.241				; L.241
  6995						MOVEI	AC14,15				; G%FUNC,15				
  6996	403626'	201 14 0 00 000015 						3957
  6997						JRST	L.248				; L.248					
  6998	403627'	254 00 0 00 403655'						3887
  6999					L.241:	CAIE	AC16,121			; AC16,121				
  7000	403630'	302 16 0 00 000121 						3959
  7001	403631'	254 00 0 00 403634'		JRST	L.242				; L.242
  7002						MOVEI	AC14,16				; G%FUNC,16				
  7003	403632'	201 14 0 00 000016 						3960
  7004						JRST	L.248				; L.248					
  7005	403633'	254 00 0 00 403655'						3887
  7006					L.242:	CAIE	AC16,120			; AC16,120				
  7007	403634'	302 16 0 00 000120 						3962
  7008	403635'	254 00 0 00 403640'		JRST	L.243				; L.243
  7009						MOVEI	AC14,23				; G%FUNC,23				
  7010	403636'	201 14 0 00 000023 						3963
  7011						JRST	L.248				; L.248					
  7012	403637'	254 00 0 00 403655'						3887
  7013					L.243:	CAIE	AC16,112			; AC16,112				
  7014	403640'	302 16 0 00 000112 						3965
  7015	403641'	254 00 0 00 403644'		JRST	L.244				; L.244
  7016						MOVEI	AC14,21				; G%FUNC,21				
  7017	403642'	201 14 0 00 000021 						3966
  7018						JRST	L.248				; L.248					
  7019	403643'	254 00 0 00 403655'						3887
  7020					L.244:	CAIE	AC16,126			; AC16,126				
  7021	403644'	302 16 0 00 000126 						3968
  7022	403645'	254 00 0 00 403650'		JRST	L.245				; L.245
  7023						MOVEI	AC14,22				; G%FUNC,22				
  7024	403646'	201 14 0 00 000022 						3969
  7025						JRST	L.248				; L.248					
  7026	403647'	254 00 0 00 403655'						3887
  7027					L.245:	PUSH	SP,C.13				; SP,[232]				
  7028	403650'	261 17 0 00 400412'						3976
  7029	403651'	260 17 0 00 403337*	L.246:	PUSHJ	SP,KRM%ERROR			; SP,KRM%ERROR
  7030						ADJSP	SP,-4				; SP,-4					
  7031	403652'	105 17 0 00 777774 						3977
  7032					L.247:	MOVEI	AC1,12				; AC1,12				
  7033	403653'	201 01 0 00 000012 						3975
  7034	403654'	254 00 0 00 403660'		JRST	L.249				; L.249
  7035					L.248:	MOVEM	AC14,0(SP)			; G%FUNC,0(SP)				
  7036	403655'	202 14 0 17 000000 						3985
  7037	403656'	260 17 0 00 403755'		PUSHJ	SP,U.17				; SP,CALL%SY%RTN
  7038	403657'	105 17 0 00 777775 		ADJSP	SP,-3				; SP,-3
  7039					L.249:	ADJSP	SP,-25				; SP,-25				
  7040	403660'	105 17 0 00 777753 						3754
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-128
KERMSG	MAC	18-Jan-73 17:20	

  7041	403661'	262 17 0 00 000016 		POP	SP,AC16				; SP,AC16
  7042	403662'	262 17 0 00 000014 		POP	SP,AC14				; SP,AC14
  7043	403663'	263 17 0 00 000000 		POPJ	SP,				; SP,
  7044	403664'	000000	000140		C.56:	EXP	140				; 140
  7045	403665'	01 07 0 00 000000#	C.57:	POINT	7,GEN%2DATA-1,34		; 7,GEN%2DATA-1,34
  7046	403666'	01 07 0 00 000000#	C.58:	POINT	7,GEN%3DATA-1,34		; 7,GEN%3DATA-1,34
  7047	403667'	000000	403536*		C.59:	XWD	0,GEN%1SIZE			; 0,GEN%1SIZE
  7048	403670'	000000	403417*		C.60:	XWD	0,GEN%2SIZE			; 0,GEN%2SIZE
  7049	403671'	000000	403420*		C.61:	XWD	0,GEN%3SIZE			; 0,GEN%3SIZE
  7050	403672'	000000	000107		C.62:	EXP	107				; 107
  7051
  7052					; Routine Size:  191 words
  7053
  7054
  7055					;   3987  1	%SBTTL 'HOST%COMMAND - perform a host command'
  7056					;   3988  1	ROUTINE HOST%COMMAND =
  7057					;   3989  1	
  7058					;   3990  1	!++
  7059					;   3991  1	! FUNCTIONAL DESCRIPTION:
  7060					;   3992  1	!
  7061					;   3993  1	! This routine will handle the host command packet.
  7062					;   3994  1	! It will set up the data for the call to the system routine.
  7063					;   3995  1	!
  7064					;   3996  1	! CALLING SEQUENCE:
  7065					;   3997  1	!
  7066					;   3998  1	!	STATE = HOST%COMMAND();
  7067					;   3999  1	!
  7068					;   4000  1	! INPUT PARAMETERS:
  7069					;   4001  1	!
  7070					;   4002  1	!	None.
  7071					;   4003  1	!
  7072					;   4004  1	! IMPLICIT INPUTS:
  7073					;   4005  1	!
  7074					;   4006  1	!	Generic message receive in REC%MSG.
  7075					;   4007  1	!
  7076					;   4008  1	! OUTPUT PARAMETERS:
  7077					;   4009  1	!
  7078					;   4010  1	!	Returns new state for FSM
  7079					;   4011  1	!
  7080					;   4012  1	! IMPLICIT OUTPUTS:
  7081					;   4013  1	!
  7082					;   4014  1	!	None.
  7083					;   4015  1	!
  7084					;   4016  1	! COMPLETION CODES:
  7085					;   4017  1	!
  7086					;   4018  1	!	None.
  7087					;   4019  1	!
  7088					;   4020  1	! SIDE EFFECTS:
  7089					;   4021  1	!
  7090					;   4022  1	!	None.
  7091					;   4023  1	!
  7092					;   4024  1	!--
  7093					;   4025  1	
  7094					;   4026  2	    BEGIN
  7095					;   4027  2	    GEN%1SIZE = 0;
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-129
KERMSG	MAC	18-Jan-73 17:20	

  7096					;   4028  2	    GEN%2SIZE = 0;
  7097					;   4029  2	    GEN%3SIZE = 0;
  7098					;   4030  2	
  7099					;   4031  2	    IF .REC%LENGTH LEQ 0
  7100					;   4032  2	    THEN
  7101					;   4033  3		BEGIN
  7102					;   4034  3		KRM%ERROR (KER%PROTOERR);		! Return an error
  7103					;   4035  3		RETURN STATE%A;				! Just abort
  7104					;   4036  2		END;
  7105					;   4037  2	
  7106					;   4038  2	    SET%STRING (CH$PTR (GEN%1DATA), MAX%MSG, TRUE);	! Start writing to b
  7107					uffer
  7108					;   4039  2	    BFR%EMPTY ();				! Dump the text
  7109					;   4040  2	    GEN%1SIZE = SET%STRING (0, 0, FALSE);	! Get the result
  7110					;   4041  2	    RETURN CALL%SY%RTN (GC%COMMAND);
  7111					;   4042  1	    END;					! End of HOST%COMMAND
  7112
  7113
  7114					; HOST%COMMAND
  7115					U.15:	SETZM	GEN%1SIZE			; GEN%1SIZE				
  7116	403673'	402 00 0 00 403667*						4027
  7117						SETZM	GEN%2SIZE			; GEN%2SIZE				
  7118	403674'	402 00 0 00 403670*						4028
  7119						SETZM	GEN%3SIZE			; GEN%3SIZE				
  7120	403675'	402 00 0 00 403671*						4029
  7121						SKIPLE	U.55				; REC%LENGTH				
  7122	403676'	333 00 0 00 000022'						4031
  7123	403677'	254 00 0 00 403705'		JRST	L.250				; L.250
  7124						PUSH	SP,C.22				; SP,[252]				
  7125	403700'	261 17 0 00 401017'						4034
  7126	403701'	260 17 0 00 403651*		PUSHJ	SP,KRM%ERROR			; SP,KRM%ERROR
  7127						ADJSP	SP,-1				; SP,-1					
  7128	403702'	105 17 0 00 777777 						4035
  7129						MOVEI	AC1,12				; AC1,12				
  7130	403703'	201 01 0 00 000012 						4033
  7131	403704'	263 17 0 00 000000 		POPJ	SP,				; SP,
  7132					L.250:	PUSH	SP,C.11				; SP,[POINT 7,GEN%1DATA-1,34]  <1,7>	
  7133	403705'	261 17 0 00 400260'						4038
  7134	403706'	261 17 0 00 403664'		PUSH	SP,C.56				; SP,[140]
  7135	403707'	261 17 0 00 400144'		PUSH	SP,C.2				; SP,[1]
  7136	403710'	260 17 0 00 406157'		PUSHJ	SP,U.30				; SP,SET%STRING
  7137						PUSHJ	SP,U.28				; SP,BFR%EMPTY				
  7138	403711'	260 17 0 00 406030'						4039
  7139						SETZM	-2(SP)				; -2(SP)				
  7140	403712'	402 00 0 17 777776 						4040
  7141	403713'	402 00 0 17 777777 		SETZM	-1(SP)				; -1(SP)
  7142	403714'	402 00 0 17 000000 		SETZM	0(SP)				; 0(SP)
  7143	403715'	260 17 0 00 406157'		PUSHJ	SP,U.30				; SP,SET%STRING
  7144	403716'	202 01 0 00 403673*		MOVEM	AC1,GEN%1SIZE			; AC1,GEN%1SIZE
  7145						PUSH	SP,C.63				; SP,[17]				
  7146	403717'	261 17 0 00 403723'						4041
  7147	403720'	260 17 0 00 403755'		PUSHJ	SP,U.17				; SP,CALL%SY%RTN
  7148	403721'	105 17 0 00 777774 		ADJSP	SP,-4				; SP,-4
  7149						POPJ	SP,				; SP,					
  7150	403722'	263 17 0 00 000000 						3988
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-130
KERMSG	MAC	18-Jan-73 17:20	

  7151	403723'	000000	000017		C.63:	EXP	17				; 17
  7152
  7153					; Routine Size:  25 words
  7154
  7155
  7156					;   4043  1	%SBTTL 'KERMIT%COMMAND - perform a KERMIT command'
  7157					;   4044  1	ROUTINE KERMIT%COMMAND =
  7158					;   4045  1	
  7159					;   4046  1	!++
  7160					;   4047  1	! FUNCTIONAL DESCRIPTION:
  7161					;   4048  1	!
  7162					;   4049  1	! This routine will handle the KERMIT command packet.
  7163					;   4050  1	! It will set up the data for the call to the system routine.
  7164					;   4051  1	!
  7165					;   4052  1	! CALLING SEQUENCE:
  7166					;   4053  1	!
  7167					;   4054  1	!	STATE = KERMIT%COMMAND();
  7168					;   4055  1	!
  7169					;   4056  1	! INPUT PARAMETERS:
  7170					;   4057  1	!
  7171					;   4058  1	!	None.
  7172					;   4059  1	!
  7173					;   4060  1	! IMPLICIT INPUTS:
  7174					;   4061  1	!
  7175					;   4062  1	!	Generic message receive in REC%MSG.
  7176					;   4063  1	!
  7177					;   4064  1	! OUTPUT PARAMETERS:
  7178					;   4065  1	!
  7179					;   4066  1	!	Returns new state for FSM
  7180					;   4067  1	!
  7181					;   4068  1	! IMPLICIT OUTPUTS:
  7182					;   4069  1	!
  7183					;   4070  1	!	None.
  7184					;   4071  1	!
  7185					;   4072  1	! COMPLETION CODES:
  7186					;   4073  1	!
  7187					;   4074  1	!	None.
  7188					;   4075  1	!
  7189					;   4076  1	! SIDE EFFECTS:
  7190					;   4077  1	!
  7191					;   4078  1	!	None.
  7192					;   4079  1	!
  7193					;   4080  1	!--
  7194					;   4081  1	
  7195					;   4082  2	    BEGIN
  7196					;   4083  2	    GEN%1SIZE = 0;
  7197					;   4084  2	    GEN%2SIZE = 0;
  7198					;   4085  2	    GEN%3SIZE = 0;
  7199					;   4086  2	
  7200					;   4087  2	    IF .REC%LENGTH LEQ 0
  7201					;   4088  2	    THEN
  7202					;   4089  3		BEGIN
  7203					;   4090  3		KRM%ERROR (KER%PROTOERR);		! Return an error
  7204					;   4091  3		RETURN STATE%A;				! Just abort
  7205					;   4092  2		END;
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-131
KERMSG	MAC	18-Jan-73 17:20	

  7206					;   4093  2	
  7207					;   4094  2	    SET%STRING (CH$PTR (GEN%1DATA), MAX%MSG, TRUE);	! Start writing to b
  7208					uffer
  7209					;   4095  2	    BFR%EMPTY ();				! Dump the text
  7210					;   4096  2	    GEN%1SIZE = SET%STRING (0, 0, FALSE);	! Get the result
  7211					;   4097  2	    RETURN CALL%SY%RTN (GC%KERMIT);
  7212					;   4098  1	    END;					! End of KERMIT%COMMAND
  7213
  7214
  7215					; KERMIT%COMMAND
  7216					U.16:	SETZM	GEN%1SIZE			; GEN%1SIZE				
  7217	403724'	402 00 0 00 403716*						4083
  7218						SETZM	GEN%2SIZE			; GEN%2SIZE				
  7219	403725'	402 00 0 00 403674*						4084
  7220						SETZM	GEN%3SIZE			; GEN%3SIZE				
  7221	403726'	402 00 0 00 403675*						4085
  7222						SKIPLE	U.55				; REC%LENGTH				
  7223	403727'	333 00 0 00 000022'						4087
  7224	403730'	254 00 0 00 403736'		JRST	L.251				; L.251
  7225						PUSH	SP,C.22				; SP,[252]				
  7226	403731'	261 17 0 00 401017'						4090
  7227	403732'	260 17 0 00 403701*		PUSHJ	SP,KRM%ERROR			; SP,KRM%ERROR
  7228						ADJSP	SP,-1				; SP,-1					
  7229	403733'	105 17 0 00 777777 						4091
  7230						MOVEI	AC1,12				; AC1,12				
  7231	403734'	201 01 0 00 000012 						4089
  7232	403735'	263 17 0 00 000000 		POPJ	SP,				; SP,
  7233					L.251:	PUSH	SP,C.11				; SP,[POINT 7,GEN%1DATA-1,34]  <1,7>	
  7234	403736'	261 17 0 00 400260'						4094
  7235	403737'	261 17 0 00 403664'		PUSH	SP,C.56				; SP,[140]
  7236	403740'	261 17 0 00 400144'		PUSH	SP,C.2				; SP,[1]
  7237	403741'	260 17 0 00 406157'		PUSHJ	SP,U.30				; SP,SET%STRING
  7238						PUSHJ	SP,U.28				; SP,BFR%EMPTY				
  7239	403742'	260 17 0 00 406030'						4095
  7240						SETZM	-2(SP)				; -2(SP)				
  7241	403743'	402 00 0 17 777776 						4096
  7242	403744'	402 00 0 17 777777 		SETZM	-1(SP)				; -1(SP)
  7243	403745'	402 00 0 17 000000 		SETZM	0(SP)				; 0(SP)
  7244	403746'	260 17 0 00 406157'		PUSHJ	SP,U.30				; SP,SET%STRING
  7245	403747'	202 01 0 00 403724*		MOVEM	AC1,GEN%1SIZE			; AC1,GEN%1SIZE
  7246						PUSH	SP,C.64				; SP,[20]				
  7247	403750'	261 17 0 00 403754'						4097
  7248	403751'	260 17 0 00 403755'		PUSHJ	SP,U.17				; SP,CALL%SY%RTN
  7249	403752'	105 17 0 00 777774 		ADJSP	SP,-4				; SP,-4
  7250						POPJ	SP,				; SP,					
  7251	403753'	263 17 0 00 000000 						4044
  7252	403754'	000000	000020		C.64:	EXP	20				; 20
  7253
  7254					; Routine Size:  25 words
  7255
  7256
  7257					;   4099  1	%SBTTL 'CALL%SY%RTN - handle operating system dependent functions'
  7258					;   4100  1	ROUTINE CALL%SY%RTN (G%FUNC) =
  7259					;   4101  1	
  7260					;   4102  1	!++
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-132
KERMSG	MAC	18-Jan-73 17:20	

  7261					;   4103  1	! FUNCTIONAL DESCRIPTION:
  7262					;   4104  1	!
  7263					;   4105  1	! This routine will handle calling the operating system dependent routine
  7264					;   4106  1	! for a server function and returning the response.
  7265					;   4107  1	!
  7266					;   4108  1	! CALLING SEQUENCE:
  7267					;   4109  1	!
  7268					;   4110  1	!	STATE = CALL%SY%RTN(.G%FUNC);
  7269					;   4111  1	!
  7270					;   4112  1	! INPUT PARAMETERS:
  7271					;   4113  1	!
  7272					;   4114  1	!	G%FUNC - Generic function code
  7273					;   4115  1	!
  7274					;   4116  1	! IMPLICIT INPUTS:
  7275					;   4117  1	!
  7276					;   4118  1	!	Generic message data in GEN%1DATA
  7277					;   4119  1	!
  7278					;   4120  1	! OUTPUT PARAMETERS:
  7279					;   4121  1	!
  7280					;   4122  1	!	Returns new state for FSM
  7281					;   4123  1	!
  7282					;   4124  1	! IMPLICIT OUTPUTS:
  7283					;   4125  1	!
  7284					;   4126  1	!	None.
  7285					;   4127  1	!
  7286					;   4128  1	! COMPLETION CODES:
  7287					;   4129  1	!
  7288					;   4130  1	!	None.
  7289					;   4131  1	!
  7290					;   4132  1	! SIDE EFFECTS:
  7291					;   4133  1	!
  7292					;   4134  1	!	None.
  7293					;   4135  1	!
  7294					;   4136  1	!--
  7295					;   4137  1	
  7296					;   4138  2	    BEGIN
  7297					;   4139  2	
  7298					;   4140  2	    LOCAL
  7299					;   4141  2		STRING%ADDRESS,				! Address of string result
  7300					;   4142  2		STRING%LENGTH,				! Length of string result
  7301					;   4143  2		GET%CHR%SUBROUTINE,			! Routine to get a response 
  7302					character
  7303					;   4144  2		STATUS;					! Status value
  7304					;   4145  2	
  7305					;   4146  2	!
  7306					;   4147  2	! Call the routine with the desired type of command.
  7307					;   4148  2	!
  7308					;   4149  2	    STRING%LENGTH = 0;				! Initialize for no string
  7309					;   4150  2	    GET%CHR%SUBROUTINE = 0;			! And no subroutine
  7310					;   4151  2	
  7311					;   4152  2	    IF NOT SY%GENERIC (.G%FUNC, STRING%ADDRESS, STRING%LENGTH, GET%CHR%SUBRO
  7312					UTINE)
  7313					;   4153  2	    THEN
  7314					;   4154  2		RETURN STATE%A;				! And abort
  7315					;   4155  2	
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-133
KERMSG	MAC	18-Jan-73 17:20	

  7316					;   4156  2	    IF .STRING%LENGTH GTR 0
  7317					;   4157  2	    THEN
  7318					;   4158  3		BEGIN
  7319					;   4159  3		SET%STRING (CH$PTR (.STRING%ADDRESS), .STRING%LENGTH, TRUE);
  7320					;   4160  3	
  7321					;   4161  3		IF .STRING%LENGTH LSS .SEND%PKT%SIZE - PKT%OVR%HEAD
  7322					;   4162  3		THEN
  7323					;   4163  4		    BEGIN
  7324					;   4164  4		    BFR%FILL (TRUE);			! If it should fit, pack it 
  7325					in
  7326					;   4165  4	
  7327					;   4166  4		    IF SET%STRING (0, 0, FALSE) GEQ .STRING%LENGTH
  7328					;   4167  4		    THEN 				! It fit, so just send the A
  7329					CK
  7330					;   4168  4	
  7331					;   4169  4			IF SEND%PACKET (MSG%ACK, .SIZE, .REC%SEQ) THEN RETURN STATE%
  7332					C ELSE RETURN STATE%EX;
  7333					;   4170  4	
  7334					;   4171  4	!
  7335					;   4172  4	! It didn't fit, reset the pointers to the beginning
  7336					;   4173  4	!
  7337					;   4174  4		    SET%STRING (CH$PTR (.STRING%ADDRESS), .STRING%LENGTH, TRUE);
  7338					;   4175  3		    END;
  7339					;   4176  3	
  7340					;   4177  3		NO%FILE%NEEDED = TRUE;			! Don't need a file
  7341					;   4178  3		END
  7342					;   4179  2	    ELSE
  7343					;   4180  2	
  7344					;   4181  2		IF .GET%CHR%SUBROUTINE NEQ 0		! If we got a subroutine bac
  7345					k
  7346					;   4182  2		THEN
  7347					;   4183  3		    BEGIN
  7348					;   4184  3		    GET%CHR%ROUTINE = .GET%CHR%SUBROUTINE;
  7349					;   4185  3		    NO%FILE%NEEDED = TRUE;
  7350					;   4186  2		    END;
  7351					;   4187  2	
  7352					;   4188  2	    TEXT%HEAD%FLAG = TRUE;			! Send to be typed
  7353					;   4189  2	    XFR%STATUS (%C'I', %C'G');			! Doing a generic command
  7354					;   4190  2	
  7355					;   4191  2	    IF .STATE EQL STATE%II AND .BLK%CHK%TYPE EQL .INI%CHK%TYPE
  7356					;   4192  2	    THEN
  7357					;   4193  2		RETURN STATE%OF
  7358					;   4194  2	    ELSE
  7359					;   4195  2		RETURN STATE%S;				! Send the response
  7360					;   4196  2	
  7361					;   4197  1	    END;					! End of CALL%SY%RTN
  7362
  7363
  7364					; CALL%SY%RTN
  7365					U.17:	PUSH	SP,AC14				; SP,AC14				
  7366	403755'	261 17 0 00 000014 						4100
  7367	403756'	261 17 0 00 000016 		PUSH	SP,AC16				; SP,AC16
  7368	403757'	105 17 0 00 000003 		ADJSP	SP,3				; SP,3
  7369						SETZM	-1(SP)				; STRING%LENGTH				
  7370	403760'	402 00 0 17 777777 						4149
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-134
KERMSG	MAC	18-Jan-73 17:20	

  7371						SETZM	-2(SP)				; GET%CHR%SUBROUTINE			
  7372	403761'	402 00 0 17 777776 						4150
  7373						PUSH	SP,-6(SP)			; SP,G%FUNC				
  7374	403762'	261 17 0 17 777772 						4152
  7375	403763'	201 01 0 17 777777 		MOVEI	AC1,-1(SP)			; AC1,STRING%ADDRESS
  7376	403764'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
  7377	403765'	201 01 0 17 777775 		MOVEI	AC1,-3(SP)			; AC1,STRING%LENGTH
  7378	403766'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
  7379	403767'	201 01 0 17 777773 		MOVEI	AC1,-5(SP)			; AC1,GET%CHR%SUBROUTINE
  7380	403770'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
  7381	403771'	260 17 0 00 000000*		PUSHJ	SP,SY%GENERIC			; SP,SY%GENERIC
  7382	403772'	105 17 0 00 777774 		ADJSP	SP,-4				; SP,-4
  7383	403773'	602 01 0 00 000001 		TRNE	AC1,1				; AC1,1
  7384	403774'	254 00 0 00 403777'		JRST	L.252				; L.252
  7385						MOVEI	AC1,12				; AC1,12				
  7386	403775'	201 01 0 00 000012 						4154
  7387	403776'	254 00 0 00 404077'		JRST	L.261				; L.261
  7388					L.252:	MOVE	AC14,-1(SP)			; AC14,STRING%LENGTH			
  7389	403777'	200 14 0 17 777777 						4156
  7390	404000'	323 14 0 00 404053'		JUMPLE	AC14,L.257			; AC14,L.257
  7391						MOVE	AC16,0(SP)			; AC16,STRING%ADDRESS			
  7392	404001'	200 16 0 17 000000 						4159
  7393	404002'	201 01 0 16 777777 		MOVEI	AC1,-1(AC16)			; AC1,-1(AC16)
  7394	404003'	505 01 0 00 010700 		HRLI	AC1,10700			; AC1,10700
  7395	404004'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
  7396	404005'	261 17 0 00 000014 		PUSH	SP,AC14				; SP,AC14
  7397	404006'	261 17 0 00 400144'		PUSH	SP,C.2				; SP,[1]
  7398	404007'	260 17 0 00 406157'		PUSHJ	SP,U.30				; SP,SET%STRING
  7399						MOVE	AC1,U.39			; AC1,SEND%PKT%SIZE			
  7400	404010'	200 01 0 00 000002'						4161
  7401	404011'	275 01 0 00 000003 		SUBI	AC1,3				; AC1,3
  7402	404012'	311 14 0 00 000001 		CAML	AC14,AC1			; AC14,AC1
  7403	404013'	254 00 0 00 404047'		JRST	L.256				; L.256
  7404						PUSH	SP,C.2				; SP,[1]				
  7405	404014'	261 17 0 00 400144'						4164
  7406	404015'	260 17 0 00 405543'		PUSHJ	SP,U.29				; SP,BFR%FILL
  7407						SETZM	-2(SP)				; -2(SP)				
  7408	404016'	402 00 0 17 777776 						4166
  7409	404017'	402 00 0 17 777777 		SETZM	-1(SP)				; -1(SP)
  7410	404020'	402 00 0 17 000000 		SETZM	0(SP)				; 0(SP)
  7411	404021'	260 17 0 00 406157'		PUSHJ	SP,U.30				; SP,SET%STRING
  7412	404022'	315 01 0 00 000014 		CAMGE	AC1,AC14			; AC1,AC14
  7413	404023'	254 00 0 00 404040'		JRST	L.255				; L.255
  7414						PUSH	SP,C.20				; SP,[131]				
  7415	404024'	261 17 0 00 401015'						4169
  7416	404025'	261 17 0 00 000015'		PUSH	SP,U.50				; SP,SIZE
  7417	404026'	261 17 0 00 000021'		PUSH	SP,U.54				; SP,REC%SEQ
  7418	404027'	260 17 0 00 404426'		PUSHJ	SP,U.24				; SP,SEND%PACKET
  7419	404030'	105 17 0 00 777775 		ADJSP	SP,-3				; SP,-3
  7420	404031'	606 01 0 00 000001 		TRNN	AC1,1				; AC1,1
  7421	404032'	254 00 0 00 404035'		JRST	L.253				; L.253
  7422	404033'	201 01 0 00 000011 		MOVEI	AC1,11				; AC1,11
  7423	404034'	254 00 0 00 404036'		JRST	L.254				; L.254
  7424	404035'	201 01 0 00 000023 	L.253:	MOVEI	AC1,23				; AC1,23
  7425	404036'	105 17 0 00 777774 	L.254:	ADJSP	SP,-4				; SP,-4
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-135
KERMSG	MAC	18-Jan-73 17:20	

  7426	404037'	254 00 0 00 404077'		JRST	L.261				; L.261
  7427					L.255:	MOVEI	AC1,-1(AC16)			; AC1,-1(AC16)				
  7428	404040'	201 01 0 16 777777 						4174
  7429	404041'	505 01 0 00 010700 		HRLI	AC1,10700			; AC1,10700
  7430	404042'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
  7431	404043'	261 17 0 00 000014 		PUSH	SP,AC14				; SP,AC14
  7432	404044'	261 17 0 00 400144'		PUSH	SP,C.2				; SP,[1]
  7433	404045'	260 17 0 00 406157'		PUSHJ	SP,U.30				; SP,SET%STRING
  7434						ADJSP	SP,-4				; SP,-4					
  7435	404046'	105 17 0 00 777774 						4163
  7436					L.256:	MOVEI	AC1,1				; AC1,1					
  7437	404047'	201 01 0 00 000001 						4177
  7438	404050'	202 01 0 00 000107'		MOVEM	AC1,U.62			; AC1,NO%FILE%NEEDED
  7439						ADJSP	SP,-3				; SP,-3					
  7440	404051'	105 17 0 00 777775 						4158
  7441						JRST	L.258				; L.258					
  7442	404052'	254 00 0 00 404060'						4156
  7443					L.257:	MOVE	AC1,-2(SP)			; AC1,GET%CHR%SUBROUTINE		
  7444	404053'	200 01 0 17 777776 						4181
  7445	404054'	322 01 0 00 404060'		JUMPE	AC1,L.258			; AC1,L.258
  7446						MOVEM	AC1,U.66			; AC1,GET%CHR%ROUTINE			
  7447	404055'	202 01 0 00 000113'						4184
  7448						MOVEI	AC1,1				; AC1,1					
  7449	404056'	201 01 0 00 000001 						4185
  7450	404057'	202 01 0 00 000107'		MOVEM	AC1,U.62			; AC1,NO%FILE%NEEDED
  7451					L.258:	MOVEI	AC1,1				; AC1,1					
  7452	404060'	201 01 0 00 000001 						4188
  7453	404061'	202 01 0 00 000106'		MOVEM	AC1,U.61			; AC1,TEXT%HEAD%FLAG
  7454						PUSH	SP,C.6				; SP,[111]				
  7455	404062'	261 17 0 00 400170'						4189
  7456	404063'	261 17 0 00 403672'		PUSH	SP,C.62				; SP,[107]
  7457	404064'	260 17 0 00 403544*		PUSHJ	SP,XFR%STATUS			; SP,XFR%STATUS
  7458						MOVEI	AC1,17				; AC1,17				
  7459	404065'	201 01 0 00 000017 						4191
  7460	404066'	312 01 0 00 000014'		CAME	AC1,U.49			; AC1,STATE
  7461	404067'	254 00 0 00 404075'		JRST	L.259				; L.259
  7462	404070'	200 01 0 00 000011'		MOVE	AC1,U.46			; AC1,BLK%CHK%TYPE
  7463	404071'	312 01 0 00 000010'		CAME	AC1,U.45			; AC1,INI%CHK%TYPE
  7464	404072'	254 00 0 00 404075'		JRST	L.259				; L.259
  7465						MOVEI	AC1,22				; AC1,22				
  7466	404073'	201 01 0 00 000022 						4195
  7467	404074'	254 00 0 00 404076'		JRST	L.260				; L.260
  7468	404075'	201 01 0 00 000001 	L.259:	MOVEI	AC1,1				; AC1,1
  7469					L.260:	ADJSP	SP,-2				; SP,-2					
  7470	404076'	105 17 0 00 777776 						4191
  7471					L.261:	ADJSP	SP,-3				; SP,-3					
  7472	404077'	105 17 0 00 777775 						4100
  7473	404100'	262 17 0 00 000016 		POP	SP,AC16				; SP,AC16
  7474	404101'	262 17 0 00 000014 		POP	SP,AC14				; SP,AC14
  7475	404102'	263 17 0 00 000000 		POPJ	SP,				; SP,
  7476
  7477					; Routine Size:  86 words
  7478
  7479
  7480					;   4198  1	%SBTTL 'Message processing -- PRS%SEND%INIT - Parse send init params'
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-136
KERMSG	MAC	18-Jan-73 17:20	

  7481					;   4199  1	ROUTINE PRS%SEND%INIT =
  7482					;   4200  1	
  7483					;   4201  1	!++
  7484					;   4202  1	! FUNCTIONAL DESCRIPTION:
  7485					;   4203  1	!
  7486					;   4204  1	!	This routine will parse the SEND%INIT parameters that were sent by
  7487					;   4205  1	!	the remote Kermit.  The items will be stored into the low segment.
  7488					;   4206  1	!
  7489					;   4207  1	! CALLING SEQUENCE:
  7490					;   4208  1	!
  7491					;   4209  1	!	PRS%SEND%INIT ();
  7492					;   4210  1	!
  7493					;   4211  1	! INPUT PARAMETERS:
  7494					;   4212  1	!
  7495					;   4213  1	!	None.
  7496					;   4214  1	!
  7497					;   4215  1	! IMPLICIT INPUTS:
  7498					;   4216  1	!
  7499					;   4217  1	!	Message stored in REC%MSG.
  7500					;   4218  1	!
  7501					;   4219  1	! OUTPUT PARAMETERS:
  7502					;   4220  1	!
  7503					;   4221  1	!	None.
  7504					;   4222  1	!
  7505					;   4223  1	! IMPLICIT OUTPUTS:
  7506					;   4224  1	!
  7507					;   4225  1	!	None.
  7508					;   4226  1	!
  7509					;   4227  1	! COMPLETION CODES:
  7510					;   4228  1	!
  7511					;   4229  1	!	None.
  7512					;   4230  1	!
  7513					;   4231  1	! SIDE EFFECTS:
  7514					;   4232  1	!
  7515					;   4233  1	!	None.
  7516					;   4234  1	!
  7517					;   4235  1	!--
  7518					;   4236  1	
  7519					;   4237  2	    BEGIN
  7520					;   4238  2	! The following section of code will parse the various send parameters
  7521					;   4239  2	! that are found in the send-init message.  The following code will store
  7522					;   4240  2	! the following as the value.
  7523					;   4241  2	!
  7524					;   4242  2	! If the user specified a value then the user supplied value will be used el
  7525					se
  7526					;   4243  2	! the value in the message and if none in the message then the default value
  7527					.
  7528					;   4244  2	!
  7529					;   4245  2	! User supplied values are denoted as positive values in SND%xxxxxxx.
  7530					;   4246  2	!
  7531					;   4247  2	! Parse the packet size
  7532					;   4248  2	!
  7533					;   4249  3	    SEND%PKT%SIZE = (IF .SND%PKT%SIZE GEQ 0 THEN .SND%PKT%SIZE ELSE
  7534					;   4250  4		BEGIN
  7535					;   4251  4	
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-137
KERMSG	MAC	18-Jan-73 17:20	

  7536					;   4252  4		IF .REC%LENGTH GTR P%SI%BUFSIZ
  7537					;   4253  4		THEN
  7538					; P 4254  4		    UNCHAR (CH$RCHAR (CH$PTR (REC%MSG,
  7539					;   4255  5				PKT%MSG + P%SI%BUFSIZ, CHR%SIZE)))
  7540					;   4256  4		ELSE
  7541					;   4257  4		    ABS (.SND%PKT%SIZE)
  7542					;   4258  4	
  7543					;   4259  4		END
  7544					;   4260  2	    );
  7545					;   4261  2	!
  7546					;   4262  2	! Parse the time out value
  7547					;   4263  2	!
  7548					;   4264  3	    SEND%TIMEOUT = (IF .SND%TIMEOUT GEQ 0 THEN .SND%TIMEOUT ELSE
  7549					;   4265  4		BEGIN
  7550					;   4266  4	
  7551					;   4267  4		IF .REC%LENGTH GTR P%SI%TIMOUT
  7552					;   4268  4		THEN
  7553					; P 4269  4		    UNCHAR (CH$RCHAR (CH$PTR (REC%MSG,
  7554					;   4270  5				PKT%MSG + P%SI%TIMOUT, CHR%SIZE)))
  7555					;   4271  4		ELSE
  7556					;   4272  4		    ABS (.SND%TIMEOUT)
  7557					;   4273  4	
  7558					;   4274  4		END
  7559					;   4275  2	    );
  7560					;   4276  2	!
  7561					;   4277  2	! Parse the number of padding characters supplied
  7562					;   4278  2	!
  7563					;   4279  3	    SEND%NPAD = (IF .SND%NPAD GEQ 0 THEN .SND%NPAD ELSE
  7564					;   4280  4		BEGIN
  7565					;   4281  4	
  7566					;   4282  4		IF .REC%LENGTH GTR P%SI%NPAD
  7567					;   4283  4		THEN
  7568					; P 4284  4		    UNCHAR (CH$RCHAR (CH$PTR (REC%MSG, PKT%MSG + P%SI%NPAD,
  7569					;   4285  5				CHR%SIZE)))
  7570					;   4286  4		ELSE
  7571					;   4287  4		    ABS (.SND%NPAD)
  7572					;   4288  4	
  7573					;   4289  4		END
  7574					;   4290  2	    );
  7575					;   4291  2	!
  7576					;   4292  2	! Parse the padding character
  7577					;   4293  2	!
  7578					;   4294  3	    SEND%PADCHAR = (IF .SND%PADCHAR GEQ 0 THEN .SND%PADCHAR ELSE
  7579					;   4295  4		BEGIN
  7580					;   4296  4	
  7581					;   4297  4		IF .REC%LENGTH GTR P%SI%PAD
  7582					;   4298  4		THEN
  7583					; P 4299  4		    CTL (CH$RCHAR (CH$PTR (REC%MSG, PKT%MSG + P%SI%PAD,
  7584					;   4300  5				CHR%SIZE)))
  7585					;   4301  4		ELSE
  7586					;   4302  4		    ABS (.SND%PADCHAR)
  7587					;   4303  4	
  7588					;   4304  4		END
  7589					;   4305  2	    );
  7590					;   4306  2	!
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-138
KERMSG	MAC	18-Jan-73 17:20	

  7591					;   4307  2	! Parse the end of line character
  7592					;   4308  2	!
  7593					;   4309  3	    SEND%EOL = (IF .SND%EOL GEQ 0 THEN .SND%EOL ELSE
  7594					;   4310  4		BEGIN
  7595					;   4311  4	
  7596					;   4312  4		IF .REC%LENGTH GTR P%SI%EOL
  7597					;   4313  4		THEN
  7598					; P 4314  4		    UNCHAR (CH$RCHAR (CH$PTR (REC%MSG, PKT%MSG + P%SI%EOL,
  7599					;   4315  5				CHR%SIZE)))
  7600					;   4316  4		ELSE
  7601					;   4317  4		    ABS (.SND%EOL)
  7602					;   4318  4	
  7603					;   4319  4		END
  7604					;   4320  2	    );
  7605					;   4321  2	!
  7606					;   4322  2	! Parse the quoting character
  7607					;   4323  2	!
  7608					;   4324  3	    SEND%QUOTE%CHR = (IF .SND%QUOTE%CHR GEQ 0 THEN .SND%QUOTE%CHR ELSE
  7609					;   4325  4		BEGIN
  7610					;   4326  4	
  7611					;   4327  4		IF .REC%LENGTH GTR P%SI%QUOTE
  7612					;   4328  4		THEN
  7613					;   4329  4		    CH$RCHAR (CH$PTR (REC%MSG, PKT%MSG + P%SI%QUOTE,
  7614					;   4330  4			    CHR%SIZE))
  7615					;   4331  4		ELSE
  7616					;   4332  4		    ABS (.SND%QUOTE%CHR)
  7617					;   4333  4	
  7618					;   4334  4		END
  7619					;   4335  2	    );
  7620					;   4336  2	!
  7621					;   4337  2	! Parse the 8-bit quoting character
  7622					;   4338  2	!
  7623					;   4339  2	! If the character was not included in the packet, assume no eight-bit
  7624					;   4340  2	! quoting allowed (we are probably talking to an old version of Kermit).
  7625					;   4341  2	!
  7626					;   4342  3	    SEND%8QUOTE%CHR = (IF .REC%LENGTH GTR P%SI%8QUOTE THEN CH$RCHAR (CH$PTR 
  7627					(REC%MSG,
  7628					;   4343  3			PKT%MSG + P%SI%8QUOTE, CHR%SIZE)) ELSE %C'N'	! Assume no 
  7629					8-bit quoting allowed
  7630					;   4344  2	    );
  7631					;   4345  2	!
  7632					;   4346  2	! Parse the checksum type
  7633					;   4347  2	!
  7634					;   4348  2	
  7635					;   4349  2	    IF .REC%LENGTH GTR P%SI%CHKTYPE
  7636					;   4350  2	    THEN
  7637					;   4351  3		BEGIN
  7638					;   4352  3	
  7639					;   4353  3		LOCAL
  7640					;   4354  3		    REQ%CHK%TYPE;
  7641					;   4355  3	
  7642					;   4356  3		REQ%CHK%TYPE = CH$RCHAR (CH$PTR (REC%MSG, PKT%MSG + P%SI%CHKTYPE, CH
  7643					R%SIZE));
  7644					;   4357  3	
  7645					;   4358  3		IF .REC%TYPE NEQ MSG%ACK
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-139
KERMSG	MAC	18-Jan-73 17:20	

  7646					;   4359  3		THEN
  7647					;   4360  3	
  7648					;   4361  3		    IF .REQ%CHK%TYPE GEQ CHK%1CHAR AND .REQ%CHK%TYPE LEQ CHK%CRC
  7649					;   4362  3		    THEN
  7650					;   4363  3			INI%CHK%TYPE = .REQ%CHK%TYPE
  7651					;   4364  3		    ELSE
  7652					;   4365  3			INI%CHK%TYPE = CHK%1CHAR
  7653					;   4366  3	
  7654					;   4367  3		ELSE
  7655					;   4368  3	
  7656					;   4369  3		    IF .REQ%CHK%TYPE NEQ .CHKTYPE
  7657					;   4370  3		    THEN
  7658					;   4371  3			INI%CHK%TYPE = CHK%1CHAR
  7659					;   4372  3		    ELSE
  7660					;   4373  3			INI%CHK%TYPE = .REQ%CHK%TYPE
  7661					;   4374  3	
  7662					;   4375  3		END
  7663					;   4376  2	    ELSE
  7664					;   4377  2		INI%CHK%TYPE = CHK%1CHAR;		! Only single character chec
  7665					ksum if not specified
  7666					;   4378  2	
  7667					;   4379  2	!
  7668					;   4380  2	! Parse the repeat character
  7669					;   4381  2	!
  7670					;   4382  3	    REPT%CHR = (IF .REC%LENGTH GTR P%SI%REPEAT THEN CH$RCHAR (CH$PTR (REC%MS
  7671					G,
  7672					;   4383  2			PKT%MSG + P%SI%REPEAT, CHR%SIZE)) ELSE %C' ');
  7673					;   4384  2	!
  7674					;   4385  2	! Check for a valid quoting character.  If it is not valid, then we have
  7675					;   4386  2	! a protocol error
  7676					;   4387  2	!
  7677					;   4388  2	
  7678					;   4389  4	    IF NOT ((.SEND%QUOTE%CHR GEQ %O'41' AND .SEND%QUOTE%CHR LEQ %O'76') OR (
  7679					.SEND%QUOTE%CHR GEQ %O
  7680					;   4390  3		'140' AND .SEND%QUOTE%CHR LEQ %O'176'))
  7681					;   4391  2	    THEN
  7682					;   4392  3		BEGIN
  7683					;   4393  3		KRM%ERROR (KER%PROTOERR);
  7684					;   4394  3		RETURN KER%PROTOERR;
  7685					;   4395  2		END;
  7686					;   4396  2	
  7687					;   4397  2	!
  7688					;   4398  2	! Check for a valid 8 bit quoting and set the 8 bit quoting flag as needed
  7689					;   4399  2	!
  7690					;   4400  2	
  7691					;   4401  5	    IF ( NOT ((.SEND%8QUOTE%CHR GEQ %O'041' AND .SEND%8QUOTE%CHR LEQ %O'076'
  7692					) OR (.SEND%8QUOTE%CHR
  7693					;   4402  5		GEQ %O'140' AND .SEND%8QUOTE%CHR LEQ %O'176') OR (.SEND%8QUOTE%CHR E
  7694					QL %C'N') OR (
  7695					;   4403  2		.SEND%8QUOTE%CHR EQL %C'Y'))) OR .SEND%8QUOTE%CHR EQL .SEND%QUOTE%CH
  7696					R OR .SEND%8QUOTE%CHR
  7697					;   4404  2		EQL .RCV%QUOTE%CHR
  7698					;   4405  2	    THEN
  7699					;   4406  3		BEGIN
  7700					;   4407  3		KRM%ERROR (KER%PROTOERR);
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-140
KERMSG	MAC	18-Jan-73 17:20	

  7701					;   4408  3		RETURN KER%PROTOERR;
  7702					;   4409  2		END;
  7703					;   4410  2	
  7704					;   4411  2	    IF .SEND%8QUOTE%CHR EQL %C'Y' THEN SEND%8QUOTE%CHR = .RECV%8QUOTE%CHR;
  7705					;   4412  2	
  7706					;   4413  2	    IF .SEND%8QUOTE%CHR NEQ %C'N' AND .SEND%8QUOTE%CHR NEQ %C'Y'
  7707					;   4414  2	    THEN
  7708					;   4415  2		FLAG%8QUOTE = TRUE
  7709					;   4416  2	    ELSE
  7710					;   4417  2		FLAG%8QUOTE = FALSE;
  7711					;   4418  2	
  7712					;   4419  2	!
  7713					;   4420  2	! Check the repeat character and set flags
  7714					;   4421  2	!
  7715					;   4422  2	
  7716					;   4423  5	    IF ( NOT ((.REPT%CHR GEQ %O'41' AND .REPT%CHR LEQ %O'76') OR (.REPT%CHR 
  7717					GEQ %O'140' AND
  7718					;   4424  3		.REPT%CHR LEQ %O'176')) OR .REPT%CHR EQL .SEND%QUOTE%CHR OR .REPT%CH
  7719					R EQL .SEND%8QUOTE%CHR
  7720					;   4425  2		OR .REPT%CHR EQL .RCV%QUOTE%CHR) AND .REPT%CHR NEQ %C' '
  7721					;   4426  2	    THEN
  7722					;   4427  3		BEGIN
  7723					;   4428  3		KRM%ERROR (KER%PROTOERR);
  7724					;   4429  3		RETURN KER%PROTOERR;
  7725					;   4430  2		END;
  7726					;   4431  2	
  7727					;   4432  2	    IF .REPT%CHR NEQ %C' ' THEN FLAG%REPEAT = TRUE ELSE FLAG%REPEAT = FALSE;
  7728
  7729					;   4433  2	
  7730					;   4434  2	    RETURN KER%NORMAL;
  7731					;   4435  1	    END;					! End of PRS%SEND%INIT
  7732
  7733
  7734					; PRS%SEND%INIT
  7735					U.21:	MOVE	AC1,SND%PKT%SIZE		; AC1,SND%PKT%SIZE			
  7736	404103'	200 01 0 00 400637*						4249
  7737	404104'	325 01 0 00 404114'		JUMPGE	AC1,L.263			; AC1,L.263
  7738						SKIPG	U.55				; REC%LENGTH				
  7739	404105'	337 00 0 00 000022'						4252
  7740	404106'	254 00 0 00 404113'		JRST	L.262				; L.262
  7741						MOVE	AC1,C.29			; AC1,[POINT 8,REC%MSG,31]  <4,8>	
  7742	404107'	200 01 0 00 401341'						4255
  7743	404110'	134 01 0 00 000001 		ILDB	AC1,AC1				; AC1,AC1
  7744	404111'	275 01 0 00 000040 		SUBI	AC1,40				; AC1,40
  7745						JRST	L.263				; L.263					
  7746	404112'	254 00 0 00 404114'						4250
  7747					L.262:	MOVM	AC1,AC1				; AC1,AC1				
  7748	404113'	214 01 0 00 000001 						4257
  7749					L.263:	MOVEM	AC1,U.39			; AC1,SEND%PKT%SIZE			
  7750	404114'	202 01 0 00 000002'						4249
  7751						MOVE	AC1,SND%TIMEOUT			; AC1,SND%TIMEOUT			
  7752	404115'	200 01 0 00 400641*						4264
  7753	404116'	325 01 0 00 404127'		JUMPGE	AC1,L.265			; AC1,L.265
  7754						MOVEI	AC2,1				; AC2,1					
  7755	404117'	201 02 0 00 000001 						4267
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-141
KERMSG	MAC	18-Jan-73 17:20	

  7756	404120'	311 02 0 00 000022'		CAML	AC2,U.55			; AC2,REC%LENGTH
  7757	404121'	254 00 0 00 404126'		JRST	L.264				; L.264
  7758						MOVE	AC1,C.65			; AC1,[POINT 8,REC%MSG+1,7]  <28,8>	
  7759	404122'	200 01 0 00 404345'						4270
  7760	404123'	134 01 0 00 000001 		ILDB	AC1,AC1				; AC1,AC1
  7761	404124'	275 01 0 00 000040 		SUBI	AC1,40				; AC1,40
  7762						JRST	L.265				; L.265					
  7763	404125'	254 00 0 00 404127'						4265
  7764					L.264:	MOVM	AC1,AC1				; AC1,AC1				
  7765	404126'	214 01 0 00 000001 						4272
  7766					L.265:	MOVEM	AC1,SEND%TIMEOUT		; AC1,SEND%TIMEOUT			
  7767	404127'	202 01 0 00 400640*						4264
  7768						MOVE	AC1,SND%NPAD			; AC1,SND%NPAD				
  7769	404130'	200 01 0 00 400643*						4279
  7770	404131'	325 01 0 00 404142'		JUMPGE	AC1,L.267			; AC1,L.267
  7771						MOVEI	AC2,2				; AC2,2					
  7772	404132'	201 02 0 00 000002 						4282
  7773	404133'	311 02 0 00 000022'		CAML	AC2,U.55			; AC2,REC%LENGTH
  7774	404134'	254 00 0 00 404141'		JRST	L.266				; L.266
  7775						MOVE	AC1,C.66			; AC1,[POINT 8,REC%MSG+1,15]  <20,8>	
  7776	404135'	200 01 0 00 404346'						4285
  7777	404136'	134 01 0 00 000001 		ILDB	AC1,AC1				; AC1,AC1
  7778	404137'	275 01 0 00 000040 		SUBI	AC1,40				; AC1,40
  7779						JRST	L.267				; L.267					
  7780	404140'	254 00 0 00 404142'						4280
  7781					L.266:	MOVM	AC1,AC1				; AC1,AC1				
  7782	404141'	214 01 0 00 000001 						4287
  7783					L.267:	MOVEM	AC1,U.40			; AC1,SEND%NPAD				
  7784	404142'	202 01 0 00 000003'						4279
  7785						MOVE	AC1,SND%PADCHAR			; AC1,SND%PADCHAR			
  7786	404143'	200 01 0 00 400645*						4294
  7787	404144'	325 01 0 00 404154'		JUMPGE	AC1,L.269			; AC1,L.269
  7788						MOVEI	AC2,3				; AC2,3					
  7789	404145'	201 02 0 00 000003 						4297
  7790	404146'	311 02 0 00 000022'		CAML	AC2,U.55			; AC2,REC%LENGTH
  7791	404147'	254 00 0 00 404153'		JRST	L.268				; L.268
  7792						MOVE	AC1,C.67			; AC1,[POINT 8,REC%MSG+1,23]  <12,8>	
  7793	404150'	200 01 0 00 404347'						4300
  7794	404151'	134 01 0 00 000001 		ILDB	AC1,AC1				; AC1,AC1
  7795	404152'	644 01 0 00 000100 		TRCA	AC1,100				; AC1,100
  7796					L.268:	MOVM	AC1,AC1				; AC1,AC1				
  7797	404153'	214 01 0 00 000001 						4302
  7798					L.269:	MOVEM	AC1,U.41			; AC1,SEND%PADCHAR			
  7799	404154'	202 01 0 00 000004'						4294
  7800						MOVE	AC1,SND%EOL			; AC1,SND%EOL				
  7801	404155'	200 01 0 00 400647*						4309
  7802	404156'	325 01 0 00 404167'		JUMPGE	AC1,L.271			; AC1,L.271
  7803						MOVEI	AC2,4				; AC2,4					
  7804	404157'	201 02 0 00 000004 						4312
  7805	404160'	311 02 0 00 000022'		CAML	AC2,U.55			; AC2,REC%LENGTH
  7806	404161'	254 00 0 00 404166'		JRST	L.270				; L.270
  7807						MOVE	AC1,C.68			; AC1,[POINT 8,REC%MSG+1,31]  <4,8>	
  7808	404162'	200 01 0 00 404350'						4315
  7809	404163'	134 01 0 00 000001 		ILDB	AC1,AC1				; AC1,AC1
  7810	404164'	275 01 0 00 000040 		SUBI	AC1,40				; AC1,40
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-142
KERMSG	MAC	18-Jan-73 17:20	

  7811						JRST	L.271				; L.271					
  7812	404165'	254 00 0 00 404167'						4310
  7813					L.270:	MOVM	AC1,AC1				; AC1,AC1				
  7814	404166'	214 01 0 00 000001 						4317
  7815					L.271:	MOVEM	AC1,U.42			; AC1,SEND%EOL				
  7816	404167'	202 01 0 00 000005'						4309
  7817						MOVE	AC1,SND%QUOTE%CHR		; AC1,SND%QUOTE%CHR			
  7818	404170'	200 01 0 00 400651*						4324
  7819	404171'	325 01 0 00 404201'		JUMPGE	AC1,L.273			; AC1,L.273
  7820						MOVEI	AC2,5				; AC2,5					
  7821	404172'	201 02 0 00 000005 						4327
  7822	404173'	311 02 0 00 000022'		CAML	AC2,U.55			; AC2,REC%LENGTH
  7823	404174'	254 00 0 00 404200'		JRST	L.272				; L.272
  7824						MOVE	AC1,C.69			; AC1,[POINT 8,REC%MSG+2,7]  <28,8>	
  7825	404175'	200 01 0 00 404351'						4329
  7826	404176'	134 01 0 00 000001 		ILDB	AC1,AC1				; AC1,AC1
  7827						JRST	L.273				; L.273					
  7828	404177'	254 00 0 00 404201'						4325
  7829					L.272:	MOVM	AC1,AC1				; AC1,AC1				
  7830	404200'	214 01 0 00 000001 						4332
  7831					L.273:	MOVEM	AC1,U.43			; AC1,SEND%QUOTE%CHR			
  7832	404201'	202 01 0 00 000006'						4324
  7833						MOVE	AC2,U.55			; AC2,REC%LENGTH			
  7834	404202'	200 02 0 00 000022'						4342
  7835	404203'	307 02 0 00 000006 		CAIG	AC2,6				; AC2,6
  7836	404204'	254 00 0 00 404210'		JRST	L.274				; L.274
  7837	404205'	200 01 0 00 404352'		MOVE	AC1,C.70			; AC1,[POINT 8,REC%MSG+2,15]  <20,8>
  7838	404206'	134 01 0 00 000001 		ILDB	AC1,AC1				; AC1,AC1
  7839	404207'	254 00 0 00 404211'		JRST	L.275				; L.275
  7840	404210'	201 01 0 00 000116 	L.274:	MOVEI	AC1,116				; AC1,116
  7841	404211'	202 01 0 00 000007'	L.275:	MOVEM	AC1,U.44			; AC1,SEND%8QUOTE%CHR
  7842						CAIG	AC2,7				; AC2,7					
  7843	404212'	307 02 0 00 000007 						4349
  7844	404213'	254 00 0 00 404232'		JRST	L.278				; L.278
  7845						MOVE	AC1,C.71			; AC1,[POINT 8,REC%MSG+2,23]  <12,8>	
  7846	404214'	200 01 0 00 404353'						4356
  7847	404215'	134 01 0 00 000001 		ILDB	AC1,AC1				; REQ%CHK%TYPE,AC1
  7848						MOVEI	AC3,131				; AC3,131				
  7849	404216'	201 03 0 00 000131 						4358
  7850	404217'	316 03 0 00 000023'		CAMN	AC3,U.56			; AC3,REC%TYPE
  7851	404220'	254 00 0 00 404225'		JRST	L.276				; L.276
  7852						CAIL	AC1,61				; REQ%CHK%TYPE,61			
  7853	404221'	301 01 0 00 000061 						4361
  7854	404222'	303 01 0 00 000063 		CAILE	AC1,63				; REQ%CHK%TYPE,63
  7855	404223'	254 00 0 00 404227'		JRST	L.277				; L.277
  7856	404224'	254 00 0 00 404233'		JRST	L.279				; L.279
  7857					L.276:	CAMN	AC1,CHKTYPE			; REQ%CHK%TYPE,CHKTYPE			
  7858	404225'	316 01 0 00 400655*						4369
  7859	404226'	254 00 0 00 404233'		JRST	L.279				; L.279
  7860					L.277:	MOVEI	AC3,61				; AC3,61				
  7861	404227'	201 03 0 00 000061 						4371
  7862	404230'	202 03 0 00 000010'		MOVEM	AC3,U.45			; AC3,INI%CHK%TYPE
  7863						JRST	L.280				; L.280					
  7864	404231'	254 00 0 00 404234'						4369
  7865					L.278:	MOVEI	AC1,61				; AC1,61				
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-143
KERMSG	MAC	18-Jan-73 17:20	

  7866	404232'	201 01 0 00 000061 						4377
  7867	404233'	202 01 0 00 000010'	L.279:	MOVEM	AC1,U.45			; AC1,INI%CHK%TYPE
  7868					L.280:	CAIG	AC2,10				; AC2,10				
  7869	404234'	307 02 0 00 000010 						4382
  7870	404235'	254 00 0 00 404241'		JRST	L.281				; L.281
  7871	404236'	200 01 0 00 404354'		MOVE	AC1,C.72			; AC1,[POINT 8,REC%MSG+2,31]  <4,8>
  7872	404237'	134 01 0 00 000001 		ILDB	AC1,AC1				; AC1,AC1
  7873	404240'	254 00 0 00 404242'		JRST	L.282				; L.282
  7874	404241'	201 01 0 00 000040 	L.281:	MOVEI	AC1,40				; AC1,40
  7875	404242'	202 01 0 00 000001'	L.282:	MOVEM	AC1,U.38			; AC1,REPT%CHR
  7876						MOVE	AC1,U.43			; AC1,SEND%QUOTE%CHR			
  7877	404243'	200 01 0 00 000006'						4389
  7878	404244'	305 01 0 00 000041 		CAIGE	AC1,41				; AC1,41
  7879	404245'	254 00 0 00 404250'		JRST	L.283				; L.283
  7880	404246'	307 01 0 00 000076 		CAIG	AC1,76				; AC1,76
  7881	404247'	254 00 0 00 404253'		JRST	L.284				; L.284
  7882	404250'	301 01 0 00 000140 	L.283:	CAIL	AC1,140				; AC1,140
  7883						CAILE	AC1,176				; AC1,176				
  7884	404251'	303 01 0 00 000176 						4390
  7885						JRST	L.294				; L.294					
  7886	404252'	254 00 0 00 404327'						4392
  7887					L.284:	MOVE	AC1,U.44			; AC1,SEND%8QUOTE%CHR			
  7888	404253'	200 01 0 00 000007'						4401
  7889	404254'	305 01 0 00 000041 		CAIGE	AC1,41				; AC1,41
  7890	404255'	254 00 0 00 404260'		JRST	L.285				; L.285
  7891	404256'	307 01 0 00 000076 		CAIG	AC1,76				; AC1,76
  7892	404257'	254 00 0 00 404270'		JRST	L.287				; L.287
  7893					L.285:	CAIGE	AC1,140				; AC1,140				
  7894	404260'	305 01 0 00 000140 						4402
  7895	404261'	254 00 0 00 404264'		JRST	L.286				; L.286
  7896	404262'	307 01 0 00 000176 		CAIG	AC1,176				; AC1,176
  7897	404263'	254 00 0 00 404270'		JRST	L.287				; L.287
  7898	404264'	306 01 0 00 000116 	L.286:	CAIN	AC1,116				; AC1,116
  7899	404265'	254 00 0 00 404270'		JRST	L.287				; L.287
  7900	404266'	302 01 0 00 000131 		CAIE	AC1,131				; AC1,131
  7901	404267'	254 00 0 00 404327'		JRST	L.294				; L.294
  7902					L.287:	CAME	AC1,U.43			; AC1,SEND%QUOTE%CHR			
  7903	404270'	312 01 0 00 000006'						4403
  7904						CAMN	AC1,RCV%QUOTE%CHR		; AC1,RCV%QUOTE%CHR			
  7905	404271'	316 01 0 00 400011*						4404
  7906						JRST	L.294				; L.294					
  7907	404272'	254 00 0 00 404327'						4406
  7908						MOVEI	AC1,131				; AC1,131				
  7909	404273'	201 01 0 00 000131 						4411
  7910	404274'	312 01 0 00 000007'		CAME	AC1,U.44			; AC1,SEND%8QUOTE%CHR
  7911	404275'	254 00 0 00 404300'		JRST	L.288				; L.288
  7912	404276'	200 01 0 00 000000'		MOVE	AC1,U.37			; AC1,RECV%8QUOTE%CHR
  7913	404277'	202 01 0 00 000007'		MOVEM	AC1,U.44			; AC1,SEND%8QUOTE%CHR
  7914					L.288:	MOVE	AC2,U.44			; AC2,SEND%8QUOTE%CHR			
  7915	404300'	200 02 0 00 000007'						4413
  7916	404301'	302 02 0 00 000116 		CAIE	AC2,116				; AC2,116
  7917	404302'	306 02 0 00 000131 		CAIN	AC2,131				; AC2,131
  7918	404303'	254 00 0 00 404307'		JRST	L.289				; L.289
  7919						MOVEI	AC1,1				; AC1,1					
  7920	404304'	201 01 0 00 000001 						4415
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-144
KERMSG	MAC	18-Jan-73 17:20	

  7921	404305'	202 01 0 00 000012'		MOVEM	AC1,U.47			; AC1,FLAG%8QUOTE
  7922						JRST	L.290				; L.290					
  7923	404306'	254 00 0 00 404310'						4413
  7924					L.289:	SETZM	U.47				; FLAG%8QUOTE				
  7925	404307'	402 00 0 00 000012'						4417
  7926					L.290:	MOVE	AC1,U.38			; AC1,REPT%CHR				
  7927	404310'	200 01 0 00 000001'						4423
  7928	404311'	305 01 0 00 000041 		CAIGE	AC1,41				; AC1,41
  7929	404312'	254 00 0 00 404315'		JRST	L.291				; L.291
  7930	404313'	307 01 0 00 000076 		CAIG	AC1,76				; AC1,76
  7931	404314'	254 00 0 00 404320'		JRST	L.292				; L.292
  7932	404315'	301 01 0 00 000140 	L.291:	CAIL	AC1,140				; AC1,140
  7933						CAILE	AC1,176				; AC1,176				
  7934	404316'	303 01 0 00 000176 						4424
  7935	404317'	254 00 0 00 404325'		JRST	L.293				; L.293
  7936	404320'	312 01 0 00 000006'	L.292:	CAME	AC1,U.43			; AC1,SEND%QUOTE%CHR
  7937	404321'	316 01 0 00 000002 		CAMN	AC1,AC2				; AC1,AC2
  7938	404322'	254 00 0 00 404325'		JRST	L.293				; L.293
  7939						CAME	AC1,RCV%QUOTE%CHR		; AC1,RCV%QUOTE%CHR			
  7940	404323'	312 01 0 00 404271*						4425
  7941	404324'	254 00 0 00 404334'		JRST	L.295				; L.295
  7942	404325'	306 01 0 00 000040 	L.293:	CAIN	AC1,40				; AC1,40
  7943	404326'	254 00 0 00 404334'		JRST	L.295				; L.295
  7944					L.294:	PUSH	SP,C.22				; SP,[252]				
  7945	404327'	261 17 0 00 401017'						4428
  7946	404330'	260 17 0 00 403732*		PUSHJ	SP,KRM%ERROR			; SP,KRM%ERROR
  7947						ADJSP	SP,-1				; SP,-1					
  7948	404331'	105 17 0 00 777777 						4429
  7949						MOVEI	AC1,252				; AC1,252				
  7950	404332'	201 01 0 00 000252 						4427
  7951	404333'	263 17 0 00 000000 		POPJ	SP,				; SP,
  7952					L.295:	MOVEI	AC1,40				; AC1,40				
  7953	404334'	201 01 0 00 000040 						4432
  7954	404335'	316 01 0 00 000001'		CAMN	AC1,U.38			; AC1,REPT%CHR
  7955	404336'	254 00 0 00 404342'		JRST	L.296				; L.296
  7956	404337'	201 01 0 00 000001 		MOVEI	AC1,1				; AC1,1
  7957	404340'	202 01 0 00 000013'		MOVEM	AC1,U.48			; AC1,FLAG%REPEAT
  7958	404341'	254 00 0 00 404343'		JRST	L.297				; L.297
  7959	404342'	402 00 0 00 000013'	L.296:	SETZM	U.48				; FLAG%REPEAT
  7960					L.297:	MOVEI	AC1,13				; AC1,13				
  7961	404343'	201 01 0 00 000013 						4237
  7962						POPJ	SP,				; SP,					
  7963	404344'	263 17 0 00 000000 						4199
  7964	404345'	34 10 0 00 000025'	C.65:	POINT	8,U.57+1,7			; 8,REC%MSG+1,7
  7965	404346'	24 10 0 00 000025'	C.66:	POINT	8,U.57+1,15			; 8,REC%MSG+1,15
  7966	404347'	14 10 0 00 000025'	C.67:	POINT	8,U.57+1,23			; 8,REC%MSG+1,23
  7967	404350'	04 10 0 00 000025'	C.68:	POINT	8,U.57+1,31			; 8,REC%MSG+1,31
  7968	404351'	34 10 0 00 000026'	C.69:	POINT	8,U.57+2,7			; 8,REC%MSG+2,7
  7969	404352'	24 10 0 00 000026'	C.70:	POINT	8,U.57+2,15			; 8,REC%MSG+2,15
  7970	404353'	14 10 0 00 000026'	C.71:	POINT	8,U.57+2,23			; 8,REC%MSG+2,23
  7971	404354'	04 10 0 00 000026'	C.72:	POINT	8,U.57+2,31			; 8,REC%MSG+2,31
  7972
  7973					; Routine Size:  170 words
  7974
  7975
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-145
KERMSG	MAC	18-Jan-73 17:20	

  7976					;   4436  1	%SBTTL 'SET%SEND%INIT'
  7977					;   4437  1	ROUTINE SET%SEND%INIT : NOVALUE =
  7978					;   4438  1	
  7979					;   4439  1	!++
  7980					;   4440  1	! FUNCTIONAL DESCRIPTION:
  7981					;   4441  1	!
  7982					;   4442  1	!	This routine will initialize the various parameters for the
  7983					;   4443  1	!	MSG%SND%INIT message.
  7984					;   4444  1	!
  7985					;   4445  1	! CALLING SEQUENCE:
  7986					;   4446  1	!
  7987					;   4447  1	!	SET%SEND%INIT();
  7988					;   4448  1	!
  7989					;   4449  1	! INPUT PARAMETERS:
  7990					;   4450  1	!
  7991					;   4451  1	!	None.
  7992					;   4452  1	!
  7993					;   4453  1	! IMPLICIT INPUTS:
  7994					;   4454  1	!
  7995					;   4455  1	!	None.
  7996					;   4456  1	!
  7997					;   4457  1	! OUTPUT PARAMETERS:
  7998					;   4458  1	!
  7999					;   4459  1	!	None.
  8000					;   4460  1	!
  8001					;   4461  1	! IMPLICIT OUTPUTS:
  8002					;   4462  1	!
  8003					;   4463  1	!	SND%MSG parameters set up.
  8004					;   4464  1	!
  8005					;   4465  1	! COMPLETION CODES:
  8006					;   4466  1	!
  8007					;   4467  1	!	None.
  8008					;   4468  1	!
  8009					;   4469  1	! SIDE EFFECTS:
  8010					;   4470  1	!
  8011					;   4471  1	!	None.
  8012					;   4472  1	!
  8013					;   4473  1	!--
  8014					;   4474  1	
  8015					;   4475  2	    BEGIN
  8016					;   4476  2	    CH$WCHAR (CHAR (.RCV%PKT%SIZE), CH$PTR (SND%MSG, PKT%MSG + P%SI%BUFSIZ, 
  8017					CHR%SIZE));
  8018					;   4477  2	    CH$WCHAR (CHAR (.RCV%TIMEOUT), CH$PTR (SND%MSG, PKT%MSG + P%SI%TIMOUT, C
  8019					HR%SIZE));
  8020					;   4478  2	    CH$WCHAR (CHAR (.RCV%NPAD), CH$PTR (SND%MSG, PKT%MSG + P%SI%NPAD, CHR%SI
  8021					ZE));
  8022					;   4479  2	    CH$WCHAR (CTL (.RCV%PADCHAR), CH$PTR (SND%MSG, PKT%MSG + P%SI%PAD, CHR%S
  8023					IZE));
  8024					;   4480  2	    CH$WCHAR (CHAR (.RCV%EOL), CH$PTR (SND%MSG, PKT%MSG + P%SI%EOL, CHR%SIZE
  8025					));
  8026					;   4481  2	    CH$WCHAR (.RCV%QUOTE%CHR, CH$PTR (SND%MSG, PKT%MSG + P%SI%QUOTE, CHR%SIZ
  8027					E));
  8028					;   4482  2	    CH$WCHAR (.SEND%8QUOTE%CHR, CH$PTR (SND%MSG, PKT%MSG + P%SI%8QUOTE, CHR%
  8029					SIZE));
  8030					;   4483  2	    CH$WCHAR (.INI%CHK%TYPE, CH$PTR (SND%MSG, PKT%MSG + P%SI%CHKTYPE, CHR%SI
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-146
KERMSG	MAC	18-Jan-73 17:20	

  8031					ZE));
  8032					;   4484  2	    CH$WCHAR (.REPT%CHR, CH$PTR (SND%MSG, PKT%MSG + P%SI%REPEAT, CHR%SIZE));
  8033
  8034					;   4485  1	    END;					! End of SET%SEND%INIT
  8035
  8036
  8037					; SET%SEND%INIT
  8038					U.20:	MOVE	AC2,RCV%PKT%SIZE		; AC2,RCV%PKT%SIZE			
  8039	404355'	200 02 0 00 400001*						4476
  8040	404356'	271 02 0 00 000040 		ADDI	AC2,40				; AC2,40
  8041	404357'	200 01 0 00 401656'		MOVE	AC1,C.33			; AC1,[POINT 8,SND%MSG,31]  <4,8>
  8042	404360'	136 02 0 00 000001 		IDPB	AC2,AC1				; AC2,AC1
  8043						MOVE	AC2,RCV%TIMEOUT			; AC2,RCV%TIMEOUT			
  8044	404361'	200 02 0 00 400005*						4477
  8045	404362'	271 02 0 00 000040 		ADDI	AC2,40				; AC2,40
  8046	404363'	200 01 0 00 404416'		MOVE	AC1,C.73			; AC1,[POINT 8,SND%MSG+1,7]  <28,8>
  8047	404364'	136 02 0 00 000001 		IDPB	AC2,AC1				; AC2,AC1
  8048						MOVE	AC2,RCV%NPAD			; AC2,RCV%NPAD				
  8049	404365'	200 02 0 00 400002*						4478
  8050	404366'	271 02 0 00 000040 		ADDI	AC2,40				; AC2,40
  8051	404367'	200 01 0 00 404417'		MOVE	AC1,C.74			; AC1,[POINT 8,SND%MSG+1,15]  <20,8>
  8052	404370'	136 02 0 00 000001 		IDPB	AC2,AC1				; AC2,AC1
  8053						MOVE	AC2,RCV%PADCHAR			; AC2,RCV%PADCHAR			
  8054	404371'	200 02 0 00 400003*						4479
  8055	404372'	640 02 0 00 000100 		TRC	AC2,100				; AC2,100
  8056	404373'	200 01 0 00 404420'		MOVE	AC1,C.75			; AC1,[POINT 8,SND%MSG+1,23]  <12,8>
  8057	404374'	136 02 0 00 000001 		IDPB	AC2,AC1				; AC2,AC1
  8058						MOVE	AC2,RCV%EOL			; AC2,RCV%EOL				
  8059	404375'	200 02 0 00 400007*						4480
  8060	404376'	271 02 0 00 000040 		ADDI	AC2,40				; AC2,40
  8061	404377'	200 01 0 00 404421'		MOVE	AC1,C.76			; AC1,[POINT 8,SND%MSG+1,31]  <4,8>
  8062	404400'	136 02 0 00 000001 		IDPB	AC2,AC1				; AC2,AC1
  8063						MOVE	AC2,RCV%QUOTE%CHR		; AC2,RCV%QUOTE%CHR			
  8064	404401'	200 02 0 00 404323*						4481
  8065	404402'	200 01 0 00 404422'		MOVE	AC1,C.77			; AC1,[POINT 8,SND%MSG+2,7]  <28,8>
  8066	404403'	136 02 0 00 000001 		IDPB	AC2,AC1				; AC2,AC1
  8067						MOVE	AC2,U.44			; AC2,SEND%8QUOTE%CHR			
  8068	404404'	200 02 0 00 000007'						4482
  8069	404405'	200 01 0 00 404423'		MOVE	AC1,C.78			; AC1,[POINT 8,SND%MSG+2,15]  <20,8>
  8070	404406'	136 02 0 00 000001 		IDPB	AC2,AC1				; AC2,AC1
  8071						MOVE	AC2,U.45			; AC2,INI%CHK%TYPE			
  8072	404407'	200 02 0 00 000010'						4483
  8073	404410'	200 01 0 00 404424'		MOVE	AC1,C.79			; AC1,[POINT 8,SND%MSG+2,23]  <12,8>
  8074	404411'	136 02 0 00 000001 		IDPB	AC2,AC1				; AC2,AC1
  8075						MOVE	AC2,U.38			; AC2,REPT%CHR				
  8076	404412'	200 02 0 00 000001'						4484
  8077	404413'	200 01 0 00 404425'		MOVE	AC1,C.80			; AC1,[POINT 8,SND%MSG+2,31]  <4,8>
  8078	404414'	136 02 0 00 000001 		IDPB	AC2,AC1				; AC2,AC1
  8079						POPJ	SP,				; SP,					
  8080	404415'	263 17 0 00 000000 						4437
  8081	404416'	34 10 0 00 000055'	C.73:	POINT	8,U.58+1,7			; 8,SND%MSG+1,7
  8082	404417'	24 10 0 00 000055'	C.74:	POINT	8,U.58+1,15			; 8,SND%MSG+1,15
  8083	404420'	14 10 0 00 000055'	C.75:	POINT	8,U.58+1,23			; 8,SND%MSG+1,23
  8084	404421'	04 10 0 00 000055'	C.76:	POINT	8,U.58+1,31			; 8,SND%MSG+1,31
  8085	404422'	34 10 0 00 000056'	C.77:	POINT	8,U.58+2,7			; 8,SND%MSG+2,7
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-147
KERMSG	MAC	18-Jan-73 17:20	

  8086	404423'	24 10 0 00 000056'	C.78:	POINT	8,U.58+2,15			; 8,SND%MSG+2,15
  8087	404424'	14 10 0 00 000056'	C.79:	POINT	8,U.58+2,23			; 8,SND%MSG+2,23
  8088	404425'	04 10 0 00 000056'	C.80:	POINT	8,U.58+2,31			; 8,SND%MSG+2,31
  8089
  8090					; Routine Size:  41 words
  8091
  8092
  8093					;   4486  1	%SBTTL 'SEND%PACKET'
  8094					;   4487  1	ROUTINE SEND%PACKET (TYPE, LENGTH, MN) =
  8095					;   4488  1	
  8096					;   4489  1	!++
  8097					;   4490  1	! FUNCTIONAL DESCRIPTION:
  8098					;   4491  1	!
  8099					;   4492  1	!	This routine will cause a packet to be sent over the line
  8100					;   4493  1	!	that has been opened by OPEN%TERMINAL.
  8101					;   4494  1	!
  8102					;   4495  1	! CALLING SEQUENCE:
  8103					;   4496  1	!
  8104					;   4497  1	!	SEND%PACKET(Type, Length);
  8105					;   4498  1	!
  8106					;   4499  1	! INPUT PARAMETERS:
  8107					;   4500  1	!
  8108					;   4501  1	!	TYPE - Type of packet to send.
  8109					;   4502  1	!
  8110					;   4503  1	!	LENGTH - Length of the packet being sent.
  8111					;   4504  1	!
  8112					;   4505  1	! IMPLICIT INPUTS:
  8113					;   4506  1	!
  8114					;   4507  1	!	None.
  8115					;   4508  1	!
  8116					;   4509  1	! OUTPUT PARAMETERS:
  8117					;   4510  1	!
  8118					;   4511  1	!	None.
  8119					;   4512  1	!
  8120					;   4513  1	! IMPLICIT OUTPUTS:
  8121					;   4514  1	!
  8122					;   4515  1	!	None.
  8123					;   4516  1	!
  8124					;   4517  1	! COMPLETION CODES:
  8125					;   4518  1	!
  8126					;   4519  1	!	None.
  8127					;   4520  1	!
  8128					;   4521  1	! SIDE EFFECTS:
  8129					;   4522  1	!
  8130					;   4523  1	!	None.
  8131					;   4524  1	!
  8132					;   4525  1	!--
  8133					;   4526  1	
  8134					;   4527  2	    BEGIN
  8135					;   4528  2	
  8136					;   4529  2	    LOCAL
  8137					;   4530  2		FILLER : VECTOR [CH$ALLOCATION (MAX%MSG, CHR%SIZE)],
  8138					;   4531  2		TOT%MSG%LEN,				! Length of message includin
  8139					g all characters
  8140					;   4532  2		CHKSUM,					! Checksum for the message w
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-148
KERMSG	MAC	18-Jan-73 17:20	

  8141					e calculate
  8142					;   4533  2		POINTER;				! Pointer to the information
  8143					 in the message
  8144					;   4534  2	
  8145					;   4535  2	!
  8146					;   4536  2	! Do any filler processing that the remote KERMIT requires.
  8147					;   4537  2	!
  8148					;   4538  2	
  8149					;   4539  2	    IF .SEND%NPAD NEQ 0
  8150					;   4540  2	    THEN
  8151					;   4541  3		BEGIN
  8152					;   4542  3		CH$FILL (.SEND%PADCHAR, MAX%MSG, CH$PTR (FILLER, 0, CHR%SIZE));
  8153					;   4543  3	!
  8154					;   4544  3	! Update the send stats
  8155					;   4545  3	!
  8156					;   4546  3		SMSG%TOTAL%CHARS = .SMSG%TOTAL%CHARS + .SEND%NPAD;
  8157					;   4547  3	!
  8158					;   4548  3	! Send the fill
  8159					;   4549  3	!
  8160					;   4550  3		DO%PARITY (FILLER, .SEND%NPAD + PKT%TOT%OVR%HEAD);
  8161					;   4551  3		SEND (FILLER, .SEND%NPAD + PKT%TOT%OVR%HEAD);
  8162					;   4552  2		END;
  8163					;   4553  2	
  8164					;   4554  2	!
  8165					;   4555  2	! Store the header information into the message.
  8166					;   4556  2	!
  8167					;   4557  2	    CH$WCHAR (.TYPE, CH$PTR (SND%MSG, PKT%TYPE, CHR%SIZE));
  8168					;   4558  2	    CH$WCHAR (.SND%SOH, CH$PTR (SND%MSG, PKT%MARK, CHR%SIZE));
  8169					;   4559  2	    CH$WCHAR (CHAR (.LENGTH + PKT%OVR%HEAD + (.BLK%CHK%TYPE - CHK%1CHAR)),
  8170					;   4560  2		CH$PTR (SND%MSG,
  8171					;   4561  2		    PKT%COUNT, CHR%SIZE));
  8172					;   4562  2	    CH$WCHAR (CHAR ((IF .MN LSS 0 THEN 0 ELSE .MN)), CH$PTR (SND%MSG, PKT%SE
  8173					Q, CHR%SIZE));
  8174					;   4563  2	!
  8175					;   4564  2	! Calculate the block check value
  8176					;   4565  2	!
  8177					;   4566  2	    POINTER = CH$PTR (SND%MSG, PKT%MARK + 1, CHR%SIZE);
  8178					;   4567  2	    CHKSUM = CALC%BLOCK%CHECK (.POINTER, .LENGTH + PKT%OVR%HEAD);
  8179					;   4568  2	    TOT%MSG%LEN = .LENGTH + PKT%TOT%OVR%HEAD;
  8180					;   4569  2	!
  8181					;   4570  2	! Store the checksum into the message
  8182					;   4571  2	!
  8183					;   4572  2	    POINTER = CH$PTR (SND%MSG, .LENGTH + PKT%OVR%HEAD + 1, CHR%SIZE);
  8184					;   4573  2	
  8185					;   4574  2	    CASE .BLK%CHK%TYPE FROM CHK%1CHAR TO CHK%CRC OF
  8186					;   4575  2		SET
  8187					;   4576  2	
  8188					;   4577  2		[CHK%1CHAR] :
  8189					;   4578  2		    CH$WCHAR%A (CHAR (.CHKSUM), POINTER);
  8190					;   4579  2	
  8191					;   4580  2		[CHK%2CHAR] :
  8192					;   4581  3		    BEGIN
  8193					;   4582  3		    CH$WCHAR%A (CHAR (.CHKSUM<6, 6>), POINTER);
  8194					;   4583  3		    CH$WCHAR%A (CHAR (.CHKSUM<0, 6>), POINTER);
  8195					;   4584  3		    TOT%MSG%LEN = .TOT%MSG%LEN + 1;
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-149
KERMSG	MAC	18-Jan-73 17:20	

  8196					;   4585  2		    END;
  8197					;   4586  2	
  8198					;   4587  2		[CHK%CRC] :
  8199					;   4588  3		    BEGIN
  8200					;   4589  3		    CH$WCHAR%A (CHAR (.CHKSUM<12, 4>), POINTER);
  8201					;   4590  3		    CH$WCHAR%A (CHAR (.CHKSUM<6, 6>), POINTER);
  8202					;   4591  3		    CH$WCHAR%A (CHAR (.CHKSUM<0, 6>), POINTER);
  8203					;   4592  3		    TOT%MSG%LEN = .TOT%MSG%LEN + 2;
  8204					;   4593  2		    END;
  8205					;   4594  2		TES;
  8206					;   4595  2	
  8207					;   4596  2	!
  8208					;   4597  2	! Store in the end of line character
  8209					;   4598  2	!
  8210					;   4599  2	    CH$WCHAR%A (.SEND%EOL, POINTER);
  8211					;   4600  2	!
  8212					;   4601  2	! If we are debugging then type out the message we are sending.
  8213					;   4602  2	!
  8214					;   4603  2	    DBG%SEND (SND%MSG, (.TOT%MSG%LEN));
  8215					;   4604  2	!
  8216					;   4605  2	! Update the stats for total characters and the data characters
  8217					;   4606  2	!
  8218					;   4607  2	    SMSG%TOTAL%CHARS = .SMSG%TOTAL%CHARS + .TOT%MSG%LEN;
  8219					;   4608  2	! Make data characters really be that, not just characters in data field
  8220					;   4609  2	!    SMSG%DATA%CHARS = .SMSG%DATA%CHARS + .LENGTH;
  8221					;   4610  2	
  8222					;   4611  2	    IF .TYPE EQL MSG%NAK
  8223					;   4612  2	    THEN
  8224					;   4613  3		BEGIN
  8225					;   4614  3		SMSG%NAKS = .SMSG%NAKS + 1;
  8226					;   4615  3		XFR%STATUS (%C'S', %C'N');
  8227					;   4616  3		END
  8228					;   4617  2	    ELSE
  8229					;   4618  3		BEGIN
  8230					;   4619  3		SMSG%COUNT = .SMSG%COUNT + 1;
  8231					;   4620  3		XFR%STATUS (%C'S', %C'P');
  8232					;   4621  2		END;
  8233					;   4622  2	
  8234					;   4623  2	!
  8235					;   4624  2	! Check if we are in IBM mode and need to wait for an XON first
  8236					;   4625  2	! We will not wait if this is a packet which might be going out
  8237					;   4626  2	! without previous traffic (generic commands, init packets).
  8238					;   4627  2	
  8239					;   4628  3	    IF .IBM%FLAG AND NOT (.TYPE EQL MSG%SND%INIT OR .TYPE EQL MSG%SER%INIT O
  8240					R .TYPE EQL MSG%RCV%INIT
  8241					;   4629  3		OR .TYPE EQL MSG%COMMAND OR .TYPE EQL MSG%GENERIC)
  8242					;   4630  2	    THEN
  8243					;   4631  2	
  8244					;   4632  2		IF NOT IBM%WAIT () THEN RETURN KER%ABORTED;
  8245					;   4633  2	
  8246					;   4634  2	!
  8247					;   4635  2	! Now call the O/S routine to send the message out to the remote KERMIT
  8248					;   4636  2	!
  8249					;   4637  2	    DO%PARITY (SND%MSG, .TOT%MSG%LEN);
  8250					;   4638  2	    RETURN SEND (SND%MSG, .TOT%MSG%LEN);
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-150
KERMSG	MAC	18-Jan-73 17:20	

  8251					;   4639  1	    END;					! End of SEND%PACKET
  8252
  8253
  8254					; SEND%PACKET
  8255					U.24:	PUSH	SP,AC13				; SP,AC13				
  8256	404426'	261 17 0 00 000013 						4487
  8257	404427'	261 17 0 00 000014 		PUSH	SP,AC14				; SP,AC14
  8258	404430'	261 17 0 00 000016 		PUSH	SP,AC16				; SP,AC16
  8259	404431'	105 17 0 00 000032 		ADJSP	SP,32				; SP,32
  8260						MOVE	AC3,U.40			; AC3,SEND%NPAD				
  8261	404432'	200 03 0 00 000003'						4539
  8262	404433'	322 03 0 00 404462'		JUMPE	AC3,L.298			; AC3,L.298
  8263						MOVEI	AC5,-32(SP)			; AC5,FILLER-1				
  8264	404434'	201 05 0 17 777746 						4542
  8265	404435'	505 05 0 00 041000 		HRLI	AC5,41000			; AC5,41000
  8266	404436'	403 01 0 00 000002 		SETZB	AC1,AC2				; AC1,AC2
  8267	404437'	201 04 0 00 000140 		MOVEI	AC4,140				; AC4,140
  8268	404440'	201 13 0 17 777776 		MOVEI	AC13,-2(SP)			; AC13,-2(SP)
  8269	404441'	261 13 0 00 400256'		PUSH	AC13,C.9			; AC13,[MOVSLJ ]
  8270	404442'	261 13 0 00 000004'		PUSH	AC13,U.41			; AC13,SEND%PADCHAR
  8271	404443'	123 01 0 17 777777 		EXTEND	AC1,-1(SP)			; AC1,-1(SP)
  8272	404444'	255 00 0 00 000000 		JFCL					;
  8273						ADDM	AC3,SMSG%TOTAL%CHARS		; AC3,SMSG%TOTAL%CHARS			
  8274	404445'	272 03 0 00 000000*						4546
  8275						MOVEI	AC1,-31(SP)			; AC1,FILLER				
  8276	404446'	201 01 0 17 777747 						4550
  8277	404447'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
  8278	404450'	271 03 0 00 000006 		ADDI	AC3,6				; AC3,6
  8279	404451'	261 17 0 00 000003 		PUSH	SP,AC3				; SP,AC3
  8280	404452'	260 17 0 00 406211'		PUSHJ	SP,U.22				; SP,DO%PARITY
  8281						MOVEI	AC1,-33(SP)			; AC1,FILLER				
  8282	404453'	201 01 0 17 777745 						4551
  8283	404454'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
  8284	404455'	200 01 0 00 000003'		MOVE	AC1,U.40			; AC1,SEND%NPAD
  8285	404456'	271 01 0 00 000006 		ADDI	AC1,6				; AC1,6
  8286	404457'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
  8287	404460'	260 17 0 00 000000*		PUSHJ	SP,SEND				; SP,SEND
  8288						ADJSP	SP,-4				; SP,-4					
  8289	404461'	105 17 0 00 777774 						4541
  8290					L.298:	MOVE	AC2,-40(SP)			; AC2,TYPE				
  8291	404462'	200 02 0 17 777740 						4557
  8292	404463'	200 01 0 00 404633'		MOVE	AC1,C.84			; AC1,[POINT 8,SND%MSG,23]  <12,8>
  8293	404464'	136 02 0 00 000001 		IDPB	AC2,AC1				; AC2,AC1
  8294						MOVE	AC2,SND%SOH			; AC2,SND%SOH				
  8295	404465'	200 02 0 00 400033*						4558
  8296	404466'	200 01 0 00 404634'		MOVE	AC1,C.85			; AC1,[POINT 8,SND%MSG-1,31]  <4,8>
  8297	404467'	136 02 0 00 000001 		IDPB	AC2,AC1				; AC2,AC1
  8298						MOVE	AC13,-37(SP)			; AC13,LENGTH				
  8299	404470'	200 13 0 17 777741 						4559
  8300	404471'	200 14 0 00 000013 		MOVE	AC14,AC13			; AC14,AC13
  8301	404472'	270 14 0 00 000011'		ADD	AC14,U.46			; AC14,BLK%CHK%TYPE
  8302	404473'	275 14 0 00 000016 		SUBI	AC14,16				; AC14,16
  8303						MOVE	AC1,C.86			; AC1,[POINT 8,SND%MSG,7]  <28,8>	
  8304	404474'	200 01 0 00 404635'						4560
  8305						IDPB	AC14,AC1			; AC14,AC1				
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-151
KERMSG	MAC	18-Jan-73 17:20	

  8306	404475'	136 14 0 00 000001 						4559
  8307						SKIPGE	AC1,-36(SP)			; AC1,MN				
  8308	404476'	335 01 0 17 777742 						4562
  8309	404477'	400 01 0 00 000000 		SETZ	AC1,				; AC1,
  8310	404500'	271 01 0 00 000040 		ADDI	AC1,40				; AC1,40
  8311	404501'	200 02 0 00 404636'		MOVE	AC2,C.87			; AC2,[POINT 8,SND%MSG,15]  <20,8>
  8312	404502'	136 01 0 00 000002 		IDPB	AC1,AC2				; AC1,AC2
  8313						MOVE	AC16,C.86			; POINTER,[POINT 8,SND%MSG,7]  <28,8>	
  8314	404503'	200 16 0 00 404635'						4566
  8315						PUSH	SP,AC16				; SP,POINTER				
  8316	404504'	261 17 0 00 000016 						4567
  8317	404505'	200 01 0 00 000013 		MOVE	AC1,AC13			; AC1,AC13
  8318	404506'	271 01 0 00 000003 		ADDI	AC1,3				; AC1,3
  8319	404507'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
  8320	404510'	260 17 0 00 405215'		PUSHJ	SP,U.19				; SP,CALC%BLOCK%CHECK
  8321						MOVE	AC14,AC13			; TOT%MSG%LEN,AC13			
  8322	404511'	200 14 0 00 000013 						4568
  8323	404512'	271 14 0 00 000006 		ADDI	AC14,6				; TOT%MSG%LEN,6
  8324						ADDI	AC13,4				; AC13,4				
  8325	404513'	271 13 0 00 000004 						4572
  8326	404514'	200 03 0 00 404630'		MOVE	AC3,C.81			; AC3,[POINT 8,SND%MSG,-1]  <36,8>
  8327	404515'	200 02 0 00 000013 		MOVE	AC2,AC13			; AC2,AC13
  8328	404516'	133 02 0 00 000003 		ADJBP	AC2,AC3				; AC2,AC3
  8329	404517'	200 16 0 00 000002 		MOVE	AC16,AC2			; POINTER,AC2
  8330						MOVE	AC2,U.46			; AC2,BLK%CHK%TYPE			
  8331	404520'	200 02 0 00 000011'						4574
  8332	404521'	275 02 0 00 000061 		SUBI	AC2,61				; AC2,61
  8333	404522'	254 00 0 02 404523'		JRST	L.299(AC2)			; L.299(AC2)
  8334	404523'	254 00 0 00 404526'	L.299:	JRST	L.300				; L.300
  8335	404524'	254 00 0 00 404532'		JRST	L.301				; L.301
  8336	404525'	254 00 0 00 404541'		JRST	L.302				; L.302
  8337					L.300:	MOVE	AC2,AC1				; AC2,CHKSUM				
  8338	404526'	200 02 0 00 000001 						4578
  8339	404527'	271 02 0 00 000040 		ADDI	AC2,40				; AC2,40
  8340	404530'	136 02 0 00 000016 		IDPB	AC2,AC16			; AC2,POINTER
  8341						JRST	L.303				; L.303					
  8342	404531'	254 00 0 00 404553'						4574
  8343					L.301:	LDB	AC2,C.82			; AC2,[POINT 6,CHKSUM,29]  <6,6>	
  8344	404532'	135 02 0 00 404631'						4582
  8345	404533'	271 02 0 00 000040 		ADDI	AC2,40				; AC2,40
  8346	404534'	136 02 0 00 000016 		IDPB	AC2,AC16			; AC2,POINTER
  8347						LDB	AC2,C.18			; AC2,[POINT 6,AC1,35]  <0,6>		
  8348	404535'	135 02 0 00 401013'						4583
  8349	404536'	271 02 0 00 000040 		ADDI	AC2,40				; AC2,40
  8350	404537'	136 02 0 00 000016 		IDPB	AC2,AC16			; AC2,POINTER
  8351						AOJA	AC14,L.303			; TOT%MSG%LEN,L.303			
  8352	404540'	344 14 0 00 404553'						4574
  8353					L.302:	LDB	AC2,C.83			; AC2,[POINT 4,CHKSUM,23]  <12,4>	
  8354	404541'	135 02 0 00 404632'						4589
  8355	404542'	271 02 0 00 000040 		ADDI	AC2,40				; AC2,40
  8356	404543'	136 02 0 00 000016 		IDPB	AC2,AC16			; AC2,POINTER
  8357						LDB	AC2,C.82			; AC2,[POINT 6,CHKSUM,29]  <6,6>	
  8358	404544'	135 02 0 00 404631'						4590
  8359	404545'	271 02 0 00 000040 		ADDI	AC2,40				; AC2,40
  8360	404546'	136 02 0 00 000016 		IDPB	AC2,AC16			; AC2,POINTER
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-152
KERMSG	MAC	18-Jan-73 17:20	

  8361						ANDI	AC1,77				; AC1,77				
  8362	404547'	405 01 0 00 000077 						4591
  8363	404550'	271 01 0 00 000040 		ADDI	AC1,40				; AC1,40
  8364	404551'	136 01 0 00 000016 		IDPB	AC1,AC16			; AC1,POINTER
  8365						ADDI	AC14,2				; TOT%MSG%LEN,2				
  8366	404552'	271 14 0 00 000002 						4592
  8367					L.303:	MOVE	AC1,U.42			; AC1,SEND%EOL				
  8368	404553'	200 01 0 00 000005'						4599
  8369	404554'	136 01 0 00 000016 		IDPB	AC1,AC16			; AC1,POINTER
  8370						PUSH	SP,C.88				; SP,[0,,SND%MSG]			
  8371	404555'	261 17 0 00 404637'						4603
  8372	404556'	261 17 0 00 000014 		PUSH	SP,AC14				; SP,TOT%MSG%LEN
  8373	404557'	260 17 0 00 406721'		PUSHJ	SP,U.35				; SP,DBG%SEND
  8374						ADDM	AC14,SMSG%TOTAL%CHARS		; TOT%MSG%LEN,SMSG%TOTAL%CHARS		
  8375	404560'	272 14 0 00 404445*						4607
  8376						MOVE	AC16,-44(SP)			; AC16,TYPE				
  8377	404561'	200 16 0 17 777734 						4611
  8378	404562'	302 16 0 00 000116 		CAIE	AC16,116			; AC16,116
  8379	404563'	254 00 0 00 404570'		JRST	L.304				; L.304
  8380						AOS	SMSG%NAKS			; SMSG%NAKS				
  8381	404564'	350 00 0 00 000000*						4614
  8382						PUSH	SP,C.8				; SP,[123]				
  8383	404565'	261 17 0 00 400220'						4615
  8384	404566'	261 17 0 00 401022'		PUSH	SP,C.25				; SP,[116]
  8385	404567'	254 00 0 00 404573'		JRST	L.305				; L.305
  8386					L.304:	AOS	SMSG%COUNT			; SMSG%COUNT				
  8387	404570'	350 00 0 00 000000*						4619
  8388						PUSH	SP,C.8				; SP,[123]				
  8389	404571'	261 17 0 00 400220'						4620
  8390	404572'	261 17 0 00 404640'		PUSH	SP,C.89				; SP,[120]
  8391	404573'	260 17 0 00 404064*	L.305:	PUSHJ	SP,XFR%STATUS			; SP,XFR%STATUS
  8392						MOVEI	AC1,1				; AC1,1					
  8393	404574'	201 01 0 00 000001 						4628
  8394	404575'	612 01 0 00 400062*		TDNE	AC1,IBM%FLAG			; AC1,IBM%FLAG
  8395	404576'	306 16 0 00 000123 		CAIN	AC16,123			; AC16,123
  8396	404577'	254 00 0 00 404614'		JRST	L.306				; L.306
  8397	404600'	302 16 0 00 000111 		CAIE	AC16,111			; AC16,111
  8398	404601'	306 16 0 00 000122 		CAIN	AC16,122			; AC16,122
  8399	404602'	254 00 0 00 404614'		JRST	L.306				; L.306
  8400						CAIE	AC16,103			; AC16,103				
  8401	404603'	302 16 0 00 000103 						4629
  8402	404604'	306 16 0 00 000107 		CAIN	AC16,107			; AC16,107
  8403	404605'	254 00 0 00 404614'		JRST	L.306				; L.306
  8404						PUSHJ	SP,IBM%WAIT			; SP,IBM%WAIT				
  8405	404606'	260 17 0 00 000000*						4632
  8406	404607'	602 01 0 00 000001 		TRNE	AC1,1				; AC1,1
  8407	404610'	254 00 0 00 404614'		JRST	L.306				; L.306
  8408	404611'	105 17 0 00 777772 		ADJSP	SP,-6				; SP,-6
  8409	404612'	201 01 0 00 000312 		MOVEI	AC1,312				; AC1,312
  8410	404613'	254 00 0 00 404623'		JRST	L.307				; L.307
  8411					L.306:	PUSH	SP,C.88				; SP,[0,,SND%MSG]			
  8412	404614'	261 17 0 00 404637'						4637
  8413	404615'	261 17 0 00 000014 		PUSH	SP,AC14				; SP,TOT%MSG%LEN
  8414	404616'	260 17 0 00 406211'		PUSHJ	SP,U.22				; SP,DO%PARITY
  8415						PUSH	SP,C.88				; SP,[0,,SND%MSG]			
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-153
KERMSG	MAC	18-Jan-73 17:20	

  8416	404617'	261 17 0 00 404637'						4638
  8417	404620'	261 17 0 00 000014 		PUSH	SP,AC14				; SP,TOT%MSG%LEN
  8418	404621'	260 17 0 00 404460*		PUSHJ	SP,SEND				; SP,SEND
  8419	404622'	105 17 0 00 777766 		ADJSP	SP,-12				; SP,-12
  8420					L.307:	ADJSP	SP,-32				; SP,-32				
  8421	404623'	105 17 0 00 777746 						4487
  8422	404624'	262 17 0 00 000016 		POP	SP,AC16				; SP,AC16
  8423	404625'	262 17 0 00 000014 		POP	SP,AC14				; SP,AC14
  8424	404626'	262 17 0 00 000013 		POP	SP,AC13				; SP,AC13
  8425	404627'	263 17 0 00 000000 		POPJ	SP,				; SP,
  8426	404630'	44 10 0 00 000054'	C.81:	POINT	8,U.58,-1			; 8,SND%MSG,-1
  8427	404631'	06 06 0 00 000001 	C.82:	POINT	6,AC1,29			; 6,CHKSUM,29
  8428	404632'	14 04 0 00 000001 	C.83:	POINT	4,AC1,23			; 4,CHKSUM,23
  8429	404633'	14 10 0 00 000054'	C.84:	POINT	8,U.58,23			; 8,SND%MSG,23
  8430	404634'	04 10 0 00 000053'	C.85:	POINT	8,U.58-1,31			; 8,SND%MSG-1,31
  8431	404635'	34 10 0 00 000054'	C.86:	POINT	8,U.58,7			; 8,SND%MSG,7
  8432	404636'	24 10 0 00 000054'	C.87:	POINT	8,U.58,15			; 8,SND%MSG,15
  8433	404637'	000000	000054'		C.88:	XWD	0,U.58				; 0,SND%MSG
  8434	404640'	000000	000120		C.89:	EXP	120				; 120
  8435
  8436					; Routine Size:  139 words
  8437
  8438
  8439					;   4640  1	%SBTTL 'REC%MESSAGE - Receive a message'
  8440					;   4641  1	ROUTINE REC%MESSAGE (CHK%ROUTINE) =
  8441					;   4642  1	
  8442					;   4643  1	!++
  8443					;   4644  1	! FUNCTIONAL DESCRIPTION:
  8444					;   4645  1	!
  8445					;   4646  1	!	This routine will handle the retry processing for the various
  8446					;   4647  1	!	messages that can be received.
  8447					;   4648  1	!
  8448					;   4649  1	! CALLING SEQUENCE:
  8449					;   4650  1	!
  8450					;   4651  1	! INPUT PARAMETERS:
  8451					;   4652  1	!
  8452					;   4653  1	!	None.
  8453					;   4654  1	!
  8454					;   4655  1	! IMPLICIT INPUTS:
  8455					;   4656  1	!
  8456					;   4657  1	!	None.
  8457					;   4658  1	!
  8458					;   4659  1	! OUTPUT PARAMETERS:
  8459					;   4660  1	!
  8460					;   4661  1	!	None.
  8461					;   4662  1	!
  8462					;   4663  1	! IMPLICIT OUTPUTS:
  8463					;   4664  1	!
  8464					;   4665  1	!	None.
  8465					;   4666  1	!
  8466					;   4667  1	! COMPLETION CODES:
  8467					;   4668  1	!
  8468					;   4669  1	!	KER%NORMAL - Normal return
  8469					;   4670  1	!	KER%RETRIES - Too many retries
  8470					;   4671  1	!	(What ever REC%PACKET returns).
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-154
KERMSG	MAC	18-Jan-73 17:20	

  8471					;   4672  1	!
  8472					;   4673  1	! SIDE EFFECTS:
  8473					;   4674  1	!
  8474					;   4675  1	!	None.
  8475					;   4676  1	!
  8476					;   4677  1	!--
  8477					;   4678  1	
  8478					;   4679  2	    BEGIN
  8479					;   4680  2	
  8480					;   4681  2	    LOCAL
  8481					;   4682  2		STATUS;					! Status returned by various
  8482					 routines
  8483					;   4683  2	
  8484					;   4684  2	    RETURN
  8485					;   4685  2	
  8486					;   4686  2		WHILE TRUE DO
  8487					;   4687  3		    BEGIN
  8488					;   4688  3	
  8489					;   4689  3		    IF .NUM%RETRIES GTR .PKT%RETRIES
  8490					;   4690  3		    THEN
  8491					;   4691  4			BEGIN
  8492					;   4692  4			KRM%ERROR (KER%RETRIES);	! Report the error
  8493					;   4693  4			RETURN KER%RETRIES;
  8494					;   4694  3			END;
  8495					;   4695  3	
  8496					;   4696  3		    NUM%RETRIES = .NUM%RETRIES + 1;
  8497					;   4697  3		    STATUS = REC%PACKET ();
  8498					;   4698  3	
  8499					;   4699  3		    IF NOT .STATUS AND .STATUS NEQ KER%CHKSUMERR AND .STATUS NEQ KER
  8500					%TIMEOUT
  8501					;   4700  3		    THEN
  8502					;   4701  3			RETURN .STATUS;
  8503					;   4702  3	
  8504					;   4703  3		    IF NOT .STATUS
  8505					;   4704  3		    THEN
  8506					;   4705  3			SEND%PACKET (MSG%NAK, 0, .MSG%NUMBER)	![024]
  8507					;   4706  3		    ELSE
  8508					;   4707  4			BEGIN
  8509					;   4708  4	![021]
  8510					;   4709  4	![021] If the packet type is not acceptable by our caller, nak it so the
  8511					;   4710  4	![021] other end tries again, and abort the current operation.  This is so
  8512					;   4711  4	![021] we will return to server mode (if we are running that way) quickly
  8513					;   4712  4	![021] when the other Kermit has been aborted and then restarted, and should
  8514
  8515					;   4713  4	![021] also make restarting quick, since we will not need to wait for the
  8516					;   4714  4	![021] other Kermit to time this message out before retransmitting.
  8517					;   4715  4	![021]
  8518					;   4716  4	
  8519					;   4717  4			IF NOT (.CHK%ROUTINE) ()
  8520					;   4718  4			THEN
  8521					;   4719  5			    BEGIN
  8522					;   4720  5			    SEND%PACKET (MSG%NAK, 0, .REC%SEQ);
  8523					;   4721  5			    RETURN FALSE;		! Just indicate an error
  8524					;   4722  5			    END
  8525					;   4723  4			ELSE
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-155
KERMSG	MAC	18-Jan-73 17:20	

  8526					;   4724  4			    EXITLOOP KER%NORMAL;
  8527					;   4725  4	
  8528					;   4726  3			END;
  8529					;   4727  3	
  8530					;   4728  2		    END;
  8531					;   4729  2	
  8532					;   4730  1	    END;					! End of REC%PARSE
  8533
  8534
  8535					; REC%MESSAGE
  8536					U.25:	PUSH	SP,AC16				; SP,AC16				
  8537	404641'	261 17 0 00 000016 						4641
  8538					L.308:	MOVE	AC1,U.52			; AC1,NUM%RETRIES			
  8539	404642'	200 01 0 00 000017'						4689
  8540	404643'	317 01 0 00 403151*		CAMG	AC1,PKT%RETRIES			; AC1,PKT%RETRIES
  8541	404644'	254 00 0 00 404652'		JRST	L.309				; L.309
  8542						PUSH	SP,C.17				; SP,[212]				
  8543	404645'	261 17 0 00 400605'						4692
  8544	404646'	260 17 0 00 404330*		PUSHJ	SP,KRM%ERROR			; SP,KRM%ERROR
  8545						ADJSP	SP,-1				; SP,-1					
  8546	404647'	105 17 0 00 777777 						4693
  8547						MOVEI	AC1,212				; AC1,212				
  8548	404650'	201 01 0 00 000212 						4691
  8549	404651'	254 00 0 00 404707'		JRST	L.313				; L.313
  8550					L.309:	AOS	U.52				; NUM%RETRIES				
  8551	404652'	350 00 0 00 000017'						4696
  8552						PUSHJ	SP,U.26				; SP,REC%PACKET				
  8553	404653'	260 17 0 00 404716'						4697
  8554	404654'	200 16 0 00 000001 		MOVE	AC16,AC1			; STATUS,AC1
  8555						TRNN	AC16,1				; STATUS,1				
  8556	404655'	606 16 0 00 000001 						4699
  8557	404656'	306 16 0 00 000172 		CAIN	AC16,172			; STATUS,172
  8558	404657'	254 00 0 00 404664'		JRST	L.310				; L.310
  8559	404660'	306 16 0 00 000300 		CAIN	AC16,300			; STATUS,300
  8560	404661'	254 00 0 00 404664'		JRST	L.310				; L.310
  8561						MOVE	AC1,AC16			; AC1,STATUS				
  8562	404662'	200 01 0 00 000016 						4701
  8563	404663'	254 00 0 00 404707'		JRST	L.313				; L.313
  8564					L.310:	TRNE	AC16,1				; STATUS,1				
  8565	404664'	602 16 0 00 000001 						4703
  8566	404665'	254 00 0 00 404674'		JRST	L.311				; L.311
  8567						PUSH	SP,C.25				; SP,[116]				
  8568	404666'	261 17 0 00 401022'						4705
  8569	404667'	261 17 0 00 401023'		PUSH	SP,C.26				; SP,[0]
  8570	404670'	261 17 0 00 000020'		PUSH	SP,U.53				; SP,MSG%NUMBER
  8571	404671'	260 17 0 00 404426'		PUSHJ	SP,U.24				; SP,SEND%PACKET
  8572	404672'	105 17 0 00 777775 		ADJSP	SP,-3				; SP,-3
  8573						JRST	L.308				; L.308					
  8574	404673'	254 00 0 00 404642'						4703
  8575					L.311:	MOVE	AC1,-2(SP)			; AC1,CHK%ROUTINE			
  8576	404674'	200 01 0 17 777776 						4717
  8577	404675'	260 17 0 01 000000 		PUSHJ	SP,0(AC1)			; SP,0(AC1)
  8578	404676'	602 01 0 00 000001 		TRNE	AC1,1				; AC1,1
  8579	404677'	254 00 0 00 404706'		JRST	L.312				; L.312
  8580						PUSH	SP,C.25				; SP,[116]				
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-156
KERMSG	MAC	18-Jan-73 17:20	

  8581	404700'	261 17 0 00 401022'						4720
  8582	404701'	261 17 0 00 401023'		PUSH	SP,C.26				; SP,[0]
  8583	404702'	261 17 0 00 000021'		PUSH	SP,U.54				; SP,REC%SEQ
  8584	404703'	260 17 0 00 404426'		PUSHJ	SP,U.24				; SP,SEND%PACKET
  8585						ADJSP	SP,-3				; SP,-3					
  8586	404704'	105 17 0 00 777775 						4721
  8587						TDZA	AC1,AC1				; AC1,AC1				
  8588	404705'	634 01 0 00 000001 						4719
  8589					L.312:	MOVEI	AC1,13				; AC1,13				
  8590	404706'	201 01 0 00 000013 						4724
  8591					L.313:	POP	SP,AC16				; SP,AC16				
  8592	404707'	262 17 0 00 000016 						4641
  8593	404710'	263 17 0 00 000000 		POPJ	SP,				; SP,
  8594
  8595					; Routine Size:  40 words
  8596
  8597
  8598					;   4731  1	%SBTTL 'REC%PACKET'
  8599					;   4732  1	ROUTINE REC%PACKET =
  8600					;   4733  1	
  8601					;   4734  1	!++
  8602					;   4735  1	! FUNCTIONAL DESCRIPTION:
  8603					;   4736  1	!
  8604					;   4737  1	!	This routine will do the oppoiste of SEND%PACKET.  It will wait
  8605					;   4738  1	!	for the message to be read from the remote and then it will
  8606					;   4739  1	!	check the message for validity.
  8607					;   4740  1	!
  8608					;   4741  1	! CALLING SEQUENCE:
  8609					;   4742  1	!
  8610					;   4743  1	!	Flag = REC%PACKET();
  8611					;   4744  1	!
  8612					;   4745  1	! INPUT PARAMETERS:
  8613					;   4746  1	!
  8614					;   4747  1	!	None.
  8615					;   4748  1	!
  8616					;   4749  1	! IMPLICIT INPUTS:
  8617					;   4750  1	!
  8618					;   4751  1	!	None.
  8619					;   4752  1	!
  8620					;   4753  1	! OUTPUT PARAMETERS:
  8621					;   4754  1	!
  8622					;   4755  1	!	None.
  8623					;   4756  1	!
  8624					;   4757  1	! IMPLICIT OUTPUTS:
  8625					;   4758  1	!
  8626					;   4759  1	!	REC%MSG - Contains the message received.
  8627					;   4760  1	!
  8628					;   4761  1	! COMPLETION CODES:
  8629					;   4762  1	!
  8630					;   4763  1	!	True - Packet receive ok.
  8631					;   4764  1	!	False - Problem occured during the receiving of the packet.
  8632					;   4765  1	!
  8633					;   4766  1	! SIDE EFFECTS:
  8634					;   4767  1	!
  8635					;   4768  1	!	None.
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-157
KERMSG	MAC	18-Jan-73 17:20	

  8636					;   4769  1	!
  8637					;   4770  1	!--
  8638					;   4771  1	
  8639					;   4772  2	    BEGIN
  8640					;   4773  2	
  8641					;   4774  2	    BIND
  8642					;   4775  2		ATTEMPT%TEXT = UPLIT (%ASCIZ'Attempting to receive');
  8643					;   4776  2	
  8644					;   4777  2	    LOCAL
  8645					;   4778  2		STATUS,					! Status returned by various
  8646					 routines
  8647					;   4779  2		MSG%LENGTH,
  8648					;   4780  2		ERR%POINTER,				! Pointer to the error buffe
  8649					r
  8650					;   4781  2		POINTER,
  8651					;   4782  2		CHKSUM;					! Checksum of the message
  8652					;   4783  2	
  8653					;   4784  2	!
  8654					;   4785  2	! Attempt to read the message from the remote.
  8655					;   4786  2	!
  8656					;   4787  2	!    DO
  8657					;   4788  2	!	BEGIN
  8658					;   4789  2	
  8659					;   4790  2	    IF .DEBUG%FLAG
  8660					;   4791  2	    THEN
  8661					;   4792  3		BEGIN
  8662					;   4793  3	
  8663					;   4794  3		LOCAL
  8664					;   4795  3		    OLD%RTN;
  8665					;   4796  3	
  8666					;   4797  3		OLD%RTN = TT%SET%OUTPUT (DBG%DUMP);
  8667					;   4798  3		TT%TEXT (ATTEMPT%TEXT);
  8668					;   4799  3		TT%CRLF ();
  8669					;   4800  3		TT%SET%OUTPUT (.OLD%RTN);
  8670					;   4801  2		END;
  8671					;   4802  2	
  8672					;   4803  2	!
  8673					;   4804  2	! If status type out requested, do it once
  8674					;   4805  2	!
  8675					;   4806  2	
  8676					;   4807  2	    IF .TYP%STS%FLAG
  8677					;   4808  2	    THEN
  8678					;   4809  3		BEGIN
  8679					;   4810  3		STS%OUTPUT ();
  8680					;   4811  3		TYP%STS%FLAG = FALSE;
  8681					;   4812  2		END;
  8682					;   4813  2	
  8683					;   4814  2	!
  8684					;   4815  2	! Receive the message from the remote Kermit
  8685					;   4816  2	!
  8686					;   4817  2	    STATUS = RECEIVE (REC%MSG, MSG%LENGTH);
  8687					;   4818  2	!
  8688					;   4819  2	! Check for timeouts
  8689					;   4820  2	!
  8690					;   4821  2	
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-158
KERMSG	MAC	18-Jan-73 17:20	

  8691					;   4822  2	    IF .STATUS EQL KER%TIMEOUT THEN XFR%STATUS (%C'R', %C'T');
  8692					;   4823  2	
  8693					;   4824  2	!
  8694					;   4825  2	! If it failed return the status to the upper level
  8695					;   4826  2	!
  8696					;   4827  2	
  8697					;   4828  2	    IF NOT .STATUS
  8698					;   4829  2	    THEN
  8699					;   4830  3		BEGIN
  8700					;   4831  3	
  8701					;   4832  3		IF .STATUS NEQ KER%ABORTED AND .STATUS NEQ KER%TIMEOUT THEN KRM%ERRO
  8702					R (.STATUS);
  8703					;   4833  3	
  8704					;   4834  3							! Report error
  8705					;   4835  3		RETURN .STATUS;
  8706					;   4836  2		END;
  8707					;   4837  2	
  8708					;   4838  2	!
  8709					;   4839  2	! Determine if we got a good message
  8710					;   4840  2	!
  8711					;   4841  2	
  8712					;   4842  2	    IF .MSG%LENGTH LSS PKT%TOT%OVR%HEAD - 1
  8713					;   4843  2	    THEN
  8714					;   4844  3		BEGIN
  8715					;   4845  3		RETURN KER%ZEROLENMSG;
  8716					;   4846  2		END;
  8717					;   4847  2	
  8718					;   4848  2	!
  8719					;   4849  2	! Update the stats on the total number of characters received.
  8720					;   4850  2	!
  8721					;   4851  2	    RMSG%TOTAL%CHARS = .RMSG%TOTAL%CHARS + .MSG%LENGTH;
  8722					;   4852  2	!
  8723					;   4853  2	! Initialize the checksum and others
  8724					;   4854  2	!
  8725					;   4855  2	    REC%TYPE = CH$RCHAR (CH$PTR (REC%MSG, PKT%TYPE, CHR%SIZE));
  8726					;   4856  2	!
  8727					;   4857  2	! Now break the message apart byte by byte.
  8728					;   4858  2	!
  8729					;   4859  3	    REC%LENGTH = UNCHAR (CH$RCHAR (CH$PTR (REC%MSG, PKT%COUNT, CHR%SIZE))) -
  8730					 PKT%OVR%HEAD - (
  8731					;   4860  2	    .BLK%CHK%TYPE - CHK%1CHAR);
  8732					;   4861  2	    REC%SEQ = UNCHAR (CH$RCHAR (CH$PTR (REC%MSG, PKT%SEQ, CHR%SIZE)));
  8733					;   4862  2	!
  8734					;   4863  2	! Typed the packet if we are debugging
  8735					;   4864  2	!
  8736					;   4865  2	    DBG%RECEIVE (REC%MSG);
  8737					;   4866  2	!
  8738					;   4867  2	! Now compute the final checksum and make sure that it is identical
  8739					;   4868  2	! to what we received from the remote KERMIT
  8740					;   4869  2	!
  8741					;   4870  2	    POINTER = CH$PTR (REC%MSG, PKT%MARK + 1, CHR%SIZE);
  8742					;   4871  2	    CHKSUM = CALC%BLOCK%CHECK (.POINTER, .REC%LENGTH + PKT%OVR%HEAD);
  8743					;   4872  2	    POINTER = CH$PTR (REC%MSG, .REC%LENGTH + PKT%OVR%HEAD + 1, CHR%SIZE);
  8744					;   4873  2	    STATUS = KER%NORMAL;			! Assume good checksum
  8745					;   4874  2	
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-159
KERMSG	MAC	18-Jan-73 17:20	

  8746					;   4875  2	    CASE .BLK%CHK%TYPE FROM CHK%1CHAR TO CHK%CRC OF
  8747					;   4876  2		SET
  8748					;   4877  2	
  8749					;   4878  2		[CHK%1CHAR] :
  8750					;   4879  2	
  8751					;   4880  2		    IF .CHKSUM NEQ UNCHAR (CH$RCHAR%A (POINTER)) THEN STATUS = KER%C
  8752					HKSUMERR;
  8753					;   4881  2	
  8754					;   4882  2		[CHK%2CHAR] :
  8755					;   4883  2	
  8756					; P 4884  3		    IF (.CHKSUM<6, 6> NEQ UNCHAR (CH$RCHAR%A (POINTER))) OR (.CHKSUM
  8757					<0, 6> NEQ UNCHAR (
  8758					;   4885  3			    CH$RCHAR%A (POINTER)))
  8759					;   4886  2		    THEN
  8760					;   4887  2			STATUS = KER%CHKSUMERR;
  8761					;   4888  2	
  8762					;   4889  2		[CHK%CRC] :
  8763					;   4890  2	
  8764					; P 4891  3		    IF (.CHKSUM<12, 4> NEQ UNCHAR (CH$RCHAR%A (POINTER))) OR (.CHKSU
  8765					M<6, 6> NEQ UNCHAR (
  8766					;   4892  3			    CH$RCHAR%A (POINTER))) OR (.CHKSUM<0, 6> NEQ UNCHAR (CH$
  8767					RCHAR%A (POINTER)))
  8768					;   4893  2		    THEN
  8769					;   4894  2			STATUS = KER%CHKSUMERR;
  8770					;   4895  2	
  8771					;   4896  2		TES;
  8772					;   4897  2	
  8773					;   4898  2	!
  8774					;   4899  2	! If we have a bad checksum, check for the special cases when we might be ou
  8775					t
  8776					;   4900  2	! of sync with the sender.  This can occur if the sender is retransmitting
  8777					;   4901  2	! a send-init (because our ACK got lost), and we have agreed on multi-char
  8778					;   4902  2	! checksums, or because the sender is a server who has aborted back to being
  8779
  8780					;   4903  2	! idle without telling us.
  8781					;   4904  2	! Note that in either case, we return back to using single character checksu
  8782					ms
  8783					;   4905  2	!
  8784					;   4906  2	
  8785					;   4907  2	    IF .STATUS EQL KER%CHKSUMERR
  8786					;   4908  2	    THEN
  8787					;   4909  3		BEGIN
  8788					;   4910  3	
  8789					;   4911  5		IF (.BLK%CHK%TYPE NEQ CHK%1CHAR AND .REC%SEQ EQL 0) AND (.REC%LENGTH
  8790					 LSS 1 - (.BLK%CHK%TYPE
  8791					;   4912  4		    - CHK%1CHAR) AND .REC%TYPE EQL MSG%NAK) OR (.REC%TYPE EQL MSG%SN
  8792					D%INIT)
  8793					;   4913  3		THEN
  8794					;   4914  4		    BEGIN
  8795					;   4915  4	
  8796					;   4916  4		    LOCAL
  8797					;   4917  4			SAVE%BLK%CHK%TYPE;
  8798					;   4918  4	
  8799					;   4919  4		    SAVE%BLK%CHK%TYPE = .BLK%CHK%TYPE;	! Remember what we are using
  8800
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-160
KERMSG	MAC	18-Jan-73 17:20	

  8801					;   4920  4		    BLK%CHK%TYPE = CHK%1CHAR;
  8802					;   4921  4		    POINTER = CH$PTR (REC%MSG, PKT%MARK + 1, CHR%SIZE);
  8803					;   4922  4		    CHKSUM = CALC%BLOCK%CHECK (.POINTER, .REC%LENGTH + PKT%OVR%HEAD)
  8804					;
  8805					;   4923  4		    POINTER = CH$PTR (REC%MSG, .REC%LENGTH + PKT%OVR%HEAD + 1, CHR%S
  8806					IZE);
  8807					;   4924  4	
  8808					;   4925  5		    IF .CHKSUM NEQ UNCHAR (CH$RCHAR%A (POINTER))
  8809					;   4926  4		    THEN
  8810					;   4927  5			BEGIN
  8811					;   4928  5			BLK%CHK%TYPE = .SAVE%BLK%CHK%TYPE;
  8812					;   4929  5			RETURN KER%CHKSUMERR;
  8813					;   4930  4			END;
  8814					;   4931  4	
  8815					;   4932  4		    END
  8816					;   4933  3		ELSE
  8817					;   4934  3		    RETURN KER%CHKSUMERR;
  8818					;   4935  3	
  8819					;   4936  2		END;
  8820					;   4937  2	
  8821					;   4938  2	!
  8822					;   4939  2	! Update the stats
  8823					;   4940  2	!
  8824					;   4941  2	!    RMSG%DATA%CHARS = .RMSG%DATA%CHARS + .REC%LENGTH;
  8825					;   4942  2	
  8826					;   4943  2	    IF .REC%TYPE EQL MSG%NAK
  8827					;   4944  2	    THEN
  8828					;   4945  3		BEGIN
  8829					;   4946  3		RMSG%NAKS = .RMSG%NAKS + 1;
  8830					;   4947  3		XFR%STATUS (%C'R', %C'N');
  8831					;   4948  3		END
  8832					;   4949  2	    ELSE
  8833					;   4950  3		BEGIN
  8834					;   4951  3		RMSG%COUNT = .RMSG%COUNT + 1;
  8835					;   4952  3		XFR%STATUS (%C'R', %C'P');
  8836					;   4953  2		END;
  8837					;   4954  2	
  8838					;   4955  2	!
  8839					;   4956  2	! Now check to see if we have an E type (Error) packet.
  8840					;   4957  2	!
  8841					;   4958  2	
  8842					;   4959  2	    IF .REC%TYPE NEQ MSG%ERROR THEN RETURN KER%NORMAL;
  8843					;   4960  2	
  8844					;   4961  2	!
  8845					;   4962  2	! Here to process an error packet.  Call the user routine to output the
  8846					;   4963  2	! error message to the terminal.
  8847					;   4964  2	!
  8848					;   4965  2	!
  8849					;   4966  2	![026] Use decoding routine to fetch the error text
  8850					;   4967  2	!
  8851					;   4968  2	    CH$FILL (CHR%NUL, MAX%MSG + 1, CH$PTR (LAST%ERROR));
  8852					;   4969  2	    SET%STRING (CH$PTR (LAST%ERROR), MAX%MSG, TRUE);
  8853					;   4970  2	    BFR%EMPTY ();
  8854					;   4971  2	    SET%STRING (0, 0, FALSE);
  8855					;   4972  2	![026]    ERR%POINTER = CH$PTR (LAST%ERROR);
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-161
KERMSG	MAC	18-Jan-73 17:20	

  8856					;   4973  2	![026]    POINTER = CH$PTR (REC%MSG, PKT%MSG, CHR%SIZE);
  8857					;   4974  2	![026]
  8858					;   4975  2	![026]    INCR I FROM 1 TO .REC%LENGTH DO
  8859					;   4976  2	![026]	CH$WCHAR%A (CH$RCHAR%A (POINTER), ERR%POINTER);
  8860					;   4977  2	![026]
  8861					;   4978  2	![026]    CH$WCHAR (CHR%NUL, ERR%POINTER);
  8862					;   4979  2	    TT%TEXT (LAST%ERROR);
  8863					;   4980  2	    TT%CRLF ();
  8864					;   4981  2	    RETURN KER%ERRMSG;
  8865					;   4982  1	    END;					! End of REC%PACKET
  8866
  8867
  8868	404711'	101 164 164 145 155 0 	P.AAO:	BYTE	(7)"A","t","t","e","m"		; Attem
  8869	404712'	160 164 151 156 147 0 		BYTE	(7)"p","t","i","n","g"		; pting
  8870	404713'	040 164 157 040 162 0 		BYTE	(7)" ","t","o"," ","r"		;  to r
  8871	404714'	145 143 145 151 166 0 		BYTE	(7)"e","c","e","i","v"		; eceiv
  8872	404715'	145 000 000 000 000 0 		BYTE	(7)"e",000,000,000,000		; e
  8873
  8874
  8875					; ATTEMPT%TEXT
  8876			404711'		U.80=		    P.AAO
  8877
  8878
  8879					; REC%PACKET
  8880					U.26:	PUSH	SP,AC14				; SP,AC14				
  8881	404716'	261 17 0 00 000014 						4732
  8882	404717'	261 17 0 00 000016 		PUSH	SP,AC16				; SP,AC16
  8883	404720'	105 17 0 00 000001 		ADJSP	SP,1				; SP,1
  8884						MOVEI	AC1,1				; AC1,1					
  8885	404721'	201 01 0 00 000001 						4790
  8886	404722'	616 01 0 00 400045*		TDNN	AC1,DEBUG%FLAG			; AC1,DEBUG%FLAG
  8887	404723'	254 00 0 00 404735'		JRST	L.314				; L.314
  8888						PUSH	SP,C.91				; SP,[0,,DBG%DUMP]			
  8889	404724'	261 17 0 00 405206'						4797
  8890	404725'	260 17 0 00 401055*		PUSHJ	SP,TT%SET%OUTPUT		; SP,TT%SET%OUTPUT
  8891	404726'	200 14 0 00 000001 		MOVE	AC14,AC1			; OLD%RTN,AC1
  8892						PUSH	SP,C.92				; SP,[0,,ATTEMPT%TEXT]			
  8893	404727'	261 17 0 00 405207'						4798
  8894	404730'	260 17 0 00 403243*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
  8895						PUSHJ	SP,TT%CRLF			; SP,TT%CRLF				
  8896	404731'	260 17 0 00 403273*						4799
  8897						MOVEM	AC14,0(SP)			; OLD%RTN,0(SP)				
  8898	404732'	202 14 0 17 000000 						4800
  8899	404733'	260 17 0 00 404725*		PUSHJ	SP,TT%SET%OUTPUT		; SP,TT%SET%OUTPUT
  8900						ADJSP	SP,-2				; SP,-2					
  8901	404734'	105 17 0 00 777776 						4792
  8902					L.314:	MOVEI	AC1,1				; AC1,1					
  8903	404735'	201 01 0 00 000001 						4807
  8904	404736'	616 01 0 00 000000*		TDNN	AC1,TYP%STS%FLAG		; AC1,TYP%STS%FLAG
  8905	404737'	254 00 0 00 404742'		JRST	L.315				; L.315
  8906						PUSHJ	SP,U.33				; SP,STS%OUTPUT				
  8907	404740'	260 17 0 00 406530'						4810
  8908						SETZM	TYP%STS%FLAG			; TYP%STS%FLAG				
  8909	404741'	402 00 0 00 404736*						4811
  8910					L.315:	PUSH	SP,C.93				; SP,[0,,REC%MSG]			
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-162
KERMSG	MAC	18-Jan-73 17:20	

  8911	404742'	261 17 0 00 405210'						4817
  8912	404743'	201 01 0 17 777777 		MOVEI	AC1,-1(SP)			; AC1,MSG%LENGTH
  8913	404744'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
  8914	404745'	260 17 0 00 000000*		PUSHJ	SP,RECEIVE			; SP,RECEIVE
  8915	404746'	200 14 0 00 000001 		MOVE	AC14,AC1			; STATUS,AC1
  8916						CAIE	AC14,300			; STATUS,300				
  8917	404747'	302 14 0 00 000300 						4822
  8918	404750'	254 00 0 00 404755'		JRST	L.316				; L.316
  8919	404751'	261 17 0 00 400261'		PUSH	SP,C.12				; SP,[122]
  8920	404752'	261 17 0 00 400167'		PUSH	SP,C.5				; SP,[124]
  8921	404753'	260 17 0 00 404573*		PUSHJ	SP,XFR%STATUS			; SP,XFR%STATUS
  8922	404754'	105 17 0 00 777776 		ADJSP	SP,-2				; SP,-2
  8923					L.316:	TRNE	AC14,1				; STATUS,1				
  8924	404755'	602 14 0 00 000001 						4828
  8925	404756'	254 00 0 00 404767'		JRST	L.318				; L.318
  8926						CAIE	AC14,312			; STATUS,312				
  8927	404757'	302 14 0 00 000312 						4832
  8928	404760'	306 14 0 00 000300 		CAIN	AC14,300			; STATUS,300
  8929	404761'	254 00 0 00 404764'		JRST	L.317				; L.317
  8930	404762'	202 14 0 17 000000 		MOVEM	AC14,0(SP)			; STATUS,0(SP)
  8931	404763'	260 17 0 00 404646*		PUSHJ	SP,KRM%ERROR			; SP,KRM%ERROR
  8932					L.317:	ADJSP	SP,-2				; SP,-2					
  8933	404764'	105 17 0 00 777776 						4835
  8934						MOVE	AC1,AC14			; AC1,STATUS				
  8935	404765'	200 01 0 00 000014 						4830
  8936	404766'	254 00 0 00 405201'		JRST	L.335				; L.335
  8937					L.318:	MOVE	AC1,-2(SP)			; AC1,MSG%LENGTH			
  8938	404767'	200 01 0 17 777776 						4842
  8939	404770'	301 01 0 00 000005 		CAIL	AC1,5				; AC1,5
  8940	404771'	254 00 0 00 404775'		JRST	L.319				; L.319
  8941						ADJSP	SP,-2				; SP,-2					
  8942	404772'	105 17 0 00 777776 						4845
  8943						MOVEI	AC1,262				; AC1,262				
  8944	404773'	201 01 0 00 000262 						4844
  8945	404774'	254 00 0 00 405201'		JRST	L.335				; L.335
  8946					L.319:	ADDM	AC1,RMSG%TOTAL%CHARS		; AC1,RMSG%TOTAL%CHARS			
  8947	404775'	272 01 0 00 000000*						4851
  8948						MOVE	AC1,C.94			; AC1,[POINT 8,REC%MSG,23]  <12,8>	
  8949	404776'	200 01 0 00 405211'						4855
  8950	404777'	134 01 0 00 000001 		ILDB	AC1,AC1				; AC1,AC1
  8951	405000'	202 01 0 00 000023'		MOVEM	AC1,U.56			; AC1,REC%TYPE
  8952						MOVE	AC1,C.95			; AC1,[POINT 8,REC%MSG,7]  <28,8>	
  8953	405001'	200 01 0 00 405212'						4859
  8954	405002'	134 01 0 00 000001 		ILDB	AC1,AC1				; AC1,AC1
  8955	405003'	274 01 0 00 000011'		SUB	AC1,U.46			; AC1,BLK%CHK%TYPE
  8956	405004'	271 01 0 00 000016 		ADDI	AC1,16				; AC1,16
  8957	405005'	202 01 0 00 000022'		MOVEM	AC1,U.55			; AC1,REC%LENGTH
  8958						MOVE	AC1,C.96			; AC1,[POINT 8,REC%MSG,15]  <20,8>	
  8959	405006'	200 01 0 00 405213'						4861
  8960	405007'	134 01 0 00 000001 		ILDB	AC1,AC1				; AC1,AC1
  8961	405010'	275 01 0 00 000040 		SUBI	AC1,40				; AC1,40
  8962	405011'	202 01 0 00 000021'		MOVEM	AC1,U.54			; AC1,REC%SEQ
  8963						PUSH	SP,C.93				; SP,[0,,REC%MSG]			
  8964	405012'	261 17 0 00 405210'						4865
  8965	405013'	260 17 0 00 406746'		PUSHJ	SP,U.36				; SP,DBG%RECEIVE
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-163
KERMSG	MAC	18-Jan-73 17:20	

  8966						MOVE	AC16,C.95			; POINTER,[POINT 8,REC%MSG,7]  <28,8>	
  8967	405014'	200 16 0 00 405212'						4870
  8968						MOVEM	AC16,0(SP)			; POINTER,0(SP)				
  8969	405015'	202 16 0 17 000000 						4871
  8970	405016'	200 01 0 00 000022'		MOVE	AC1,U.55			; AC1,REC%LENGTH
  8971	405017'	271 01 0 00 000003 		ADDI	AC1,3				; AC1,3
  8972	405020'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
  8973	405021'	260 17 0 00 405215'		PUSHJ	SP,U.19				; SP,CALC%BLOCK%CHECK
  8974						MOVE	AC2,U.55			; AC2,REC%LENGTH			
  8975	405022'	200 02 0 00 000022'						4872
  8976	405023'	271 02 0 00 000004 		ADDI	AC2,4				; AC2,4
  8977	405024'	200 03 0 00 405205'		MOVE	AC3,C.90			; AC3,[POINT 8,REC%MSG,-1]  <36,8>
  8978	405025'	133 02 0 00 000003 		ADJBP	AC2,AC3				; AC2,AC3
  8979	405026'	200 16 0 00 000002 		MOVE	AC16,AC2			; POINTER,AC2
  8980						MOVEI	AC14,13				; STATUS,13				
  8981	405027'	201 14 0 00 000013 						4873
  8982						MOVE	AC3,U.46			; AC3,BLK%CHK%TYPE			
  8983	405030'	200 03 0 00 000011'						4875
  8984	405031'	200 02 0 00 000003 		MOVE	AC2,AC3				; AC2,AC3
  8985	405032'	275 02 0 00 000061 		SUBI	AC2,61				; AC2,61
  8986	405033'	254 00 0 02 405034'		JRST	L.320(AC2)			; L.320(AC2)
  8987	405034'	254 00 0 00 405037'	L.320:	JRST	L.321				; L.321
  8988	405035'	254 00 0 00 405051'		JRST	L.323				; L.323
  8989	405036'	254 00 0 00 405044'		JRST	L.322				; L.322
  8990					L.321:	ILDB	AC2,AC16			; AC2,POINTER				
  8991	405037'	134 02 0 00 000016 						4880
  8992	405040'	275 02 0 00 000040 		SUBI	AC2,40				; AC2,40
  8993	405041'	316 01 0 00 000002 		CAMN	AC1,AC2				; CHKSUM,AC2
  8994	405042'	254 00 0 00 405063'		JRST	L.325				; L.325
  8995	405043'	254 00 0 00 405062'		JRST	L.324				; L.324
  8996					L.322:	ILDB	AC2,AC16			; AC2,POINTER				
  8997	405044'	134 02 0 00 000016 						4891
  8998	405045'	275 02 0 00 000040 		SUBI	AC2,40				; AC2,40
  8999	405046'	135 04 0 00 404632'		LDB	AC4,C.83			; AC4,[POINT 4,AC1,23]  <12,4>
  9000	405047'	312 04 0 00 000002 		CAME	AC4,AC2				; AC4,AC2
  9001	405050'	254 00 0 00 405062'		JRST	L.324				; L.324
  9002					L.323:	ILDB	AC2,AC16			; AC2,POINTER				
  9003	405051'	134 02 0 00 000016 						4892
  9004	405052'	275 02 0 00 000040 		SUBI	AC2,40				; AC2,40
  9005						LDB	AC4,C.82			; AC4,[POINT 6,AC1,29]  <6,6>		
  9006	405053'	135 04 0 00 404631'						4891
  9007	405054'	312 04 0 00 000002 		CAME	AC4,AC2				; AC4,AC2
  9008	405055'	254 00 0 00 405062'		JRST	L.324				; L.324
  9009						ILDB	AC2,AC16			; AC2,POINTER				
  9010	405056'	134 02 0 00 000016 						4892
  9011	405057'	275 02 0 00 000040 		SUBI	AC2,40				; AC2,40
  9012	405060'	135 04 0 00 401013'		LDB	AC4,C.18			; AC4,[POINT 6,AC1,35]  <0,6>
  9013	405061'	312 04 0 00 000002 		CAME	AC4,AC2				; AC4,AC2
  9014					L.324:	MOVEI	AC14,172			; STATUS,172				
  9015	405062'	201 14 0 00 000172 						4894
  9016					L.325:	CAIE	AC14,172			; STATUS,172				
  9017	405063'	302 14 0 00 000172 						4907
  9018	405064'	254 00 0 00 405135'		JRST	L.331				; L.331
  9019						CAIE	AC3,61				; AC3,61				
  9020	405065'	302 03 0 00 000061 						4911
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-164
KERMSG	MAC	18-Jan-73 17:20	

  9021	405066'	332 00 0 00 000021'		SKIPE	U.54				; REC%SEQ
  9022	405067'	254 00 0 00 405100'		JRST	L.326				; L.326
  9023	405070'	200 02 0 00 000003 		MOVE	AC2,AC3				; AC2,AC3
  9024	405071'	275 02 0 00 000062 		SUBI	AC2,62				; AC2,62
  9025	405072'	210 02 0 00 000002 		MOVN	AC2,AC2				; AC2,AC2
  9026	405073'	317 02 0 00 000022'		CAMG	AC2,U.55			; AC2,REC%LENGTH
  9027	405074'	254 00 0 00 405100'		JRST	L.326				; L.326
  9028						MOVEI	AC2,116				; AC2,116				
  9029	405075'	201 02 0 00 000116 						4912
  9030	405076'	316 02 0 00 000023'		CAMN	AC2,U.56			; AC2,REC%TYPE
  9031	405077'	254 00 0 00 405103'		JRST	L.327				; L.327
  9032	405100'	201 02 0 00 000123 	L.326:	MOVEI	AC2,123				; AC2,123
  9033	405101'	312 02 0 00 000023'		CAME	AC2,U.56			; AC2,REC%TYPE
  9034	405102'	254 00 0 00 405132'		JRST	L.329				; L.329
  9035					L.327:	MOVE	AC14,AC3			; SAVE%BLK%CHK%TYPE,AC3			
  9036	405103'	200 14 0 00 000003 						4919
  9037						MOVEI	AC2,61				; AC2,61				
  9038	405104'	201 02 0 00 000061 						4920
  9039	405105'	202 02 0 00 000011'		MOVEM	AC2,U.46			; AC2,BLK%CHK%TYPE
  9040						MOVE	AC16,C.95			; POINTER,[POINT 8,REC%MSG,7]  <28,8>	
  9041	405106'	200 16 0 00 405212'						4921
  9042						MOVEM	AC16,0(SP)			; POINTER,0(SP)				
  9043	405107'	202 16 0 17 000000 						4922
  9044	405110'	200 02 0 00 000022'		MOVE	AC2,U.55			; AC2,REC%LENGTH
  9045	405111'	271 02 0 00 000003 		ADDI	AC2,3				; AC2,3
  9046	405112'	261 17 0 00 000002 		PUSH	SP,AC2				; SP,AC2
  9047	405113'	260 17 0 00 405215'		PUSHJ	SP,U.19				; SP,CALC%BLOCK%CHECK
  9048						MOVE	AC2,U.55			; AC2,REC%LENGTH			
  9049	405114'	200 02 0 00 000022'						4923
  9050	405115'	271 02 0 00 000004 		ADDI	AC2,4				; AC2,4
  9051	405116'	200 03 0 00 405205'		MOVE	AC3,C.90			; AC3,[POINT 8,REC%MSG,-1]  <36,8>
  9052	405117'	133 02 0 00 000003 		ADJBP	AC2,AC3				; AC2,AC3
  9053	405120'	200 16 0 00 000002 		MOVE	AC16,AC2			; POINTER,AC2
  9054						ILDB	AC2,AC16			; AC2,POINTER				
  9055	405121'	134 02 0 00 000016 						4925
  9056	405122'	275 02 0 00 000040 		SUBI	AC2,40				; AC2,40
  9057	405123'	316 01 0 00 000002 		CAMN	AC1,AC2				; CHKSUM,AC2
  9058	405124'	254 00 0 00 405130'		JRST	L.328				; L.328
  9059						MOVEM	AC14,U.46			; SAVE%BLK%CHK%TYPE,BLK%CHK%TYPE	
  9060	405125'	202 14 0 00 000011'						4928
  9061						ADJSP	SP,-5				; SP,-5					
  9062	405126'	105 17 0 00 777773 						4929
  9063	405127'	254 00 0 00 405133'		JRST	L.330				; L.330
  9064					L.328:	ADJSP	SP,-1				; SP,-1					
  9065	405130'	105 17 0 00 777777 						4914
  9066						JRST	L.331				; L.331					
  9067	405131'	254 00 0 00 405135'						4911
  9068					L.329:	ADJSP	SP,-4				; SP,-4					
  9069	405132'	105 17 0 00 777774 						4934
  9070	405133'	201 01 0 00 000172 	L.330:	MOVEI	AC1,172				; AC1,172
  9071	405134'	254 00 0 00 405201'		JRST	L.335				; L.335
  9072					L.331:	MOVEI	AC1,116				; AC1,116				
  9073	405135'	201 01 0 00 000116 						4943
  9074	405136'	312 01 0 00 000023'		CAME	AC1,U.56			; AC1,REC%TYPE
  9075	405137'	254 00 0 00 405144'		JRST	L.332				; L.332
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-165
KERMSG	MAC	18-Jan-73 17:20	

  9076						AOS	RMSG%NAKS			; RMSG%NAKS				
  9077	405140'	350 00 0 00 000000*						4946
  9078						PUSH	SP,C.12				; SP,[122]				
  9079	405141'	261 17 0 00 400261'						4947
  9080	405142'	261 17 0 00 401022'		PUSH	SP,C.25				; SP,[116]
  9081	405143'	254 00 0 00 405147'		JRST	L.333				; L.333
  9082					L.332:	AOS	RMSG%COUNT			; RMSG%COUNT				
  9083	405144'	350 00 0 00 000000*						4951
  9084						PUSH	SP,C.12				; SP,[122]				
  9085	405145'	261 17 0 00 400261'						4952
  9086	405146'	261 17 0 00 404640'		PUSH	SP,C.89				; SP,[120]
  9087	405147'	260 17 0 00 404753*	L.333:	PUSHJ	SP,XFR%STATUS			; SP,XFR%STATUS
  9088						MOVEI	AC1,105				; AC1,105				
  9089	405150'	201 01 0 00 000105 						4959
  9090	405151'	316 01 0 00 000023'		CAMN	AC1,U.56			; AC1,REC%TYPE
  9091	405152'	254 00 0 00 405156'		JRST	L.334				; L.334
  9092	405153'	105 17 0 00 777772 		ADJSP	SP,-6				; SP,-6
  9093	405154'	201 01 0 00 000013 		MOVEI	AC1,13				; AC1,13
  9094	405155'	254 00 0 00 405201'		JRST	L.335				; L.335
  9095					L.334:	SETZB	AC1,AC2				; AC1,AC2				
  9096	405156'	403 01 0 00 000002 						4968
  9097	405157'	201 04 0 00 000141 		MOVEI	AC4,141				; AC4,141
  9098	405160'	200 05 0 00 400145'		MOVE	AC5,C.3				; AC5,[POINT 7,LAST%ERROR-1,34]  <1,7>
  9099	405161'	123 01 0 00 400142'		EXTEND	AC1,C.1				; AC1,C.1
  9100	405162'	255 00 0 00 000000 		JFCL					;
  9101						PUSH	SP,C.3				; SP,[POINT 7,LAST%ERROR-1,34]  <1,7>	
  9102	405163'	261 17 0 00 400145'						4969
  9103	405164'	261 17 0 00 403664'		PUSH	SP,C.56				; SP,[140]
  9104	405165'	261 17 0 00 400144'		PUSH	SP,C.2				; SP,[1]
  9105	405166'	260 17 0 00 406157'		PUSHJ	SP,U.30				; SP,SET%STRING
  9106						PUSHJ	SP,U.28				; SP,BFR%EMPTY				
  9107	405167'	260 17 0 00 406030'						4970
  9108						SETZM	-2(SP)				; -2(SP)				
  9109	405170'	402 00 0 17 777776 						4971
  9110	405171'	402 00 0 17 777777 		SETZM	-1(SP)				; -1(SP)
  9111	405172'	402 00 0 17 000000 		SETZM	0(SP)				; 0(SP)
  9112	405173'	260 17 0 00 406157'		PUSHJ	SP,U.30				; SP,SET%STRING
  9113						PUSH	SP,C.97				; SP,[0,,LAST%ERROR]			
  9114	405174'	261 17 0 00 405214'						4979
  9115	405175'	260 17 0 00 404730*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
  9116						PUSHJ	SP,TT%CRLF			; SP,TT%CRLF				
  9117	405176'	260 17 0 00 404731*						4980
  9118						ADJSP	SP,-12				; SP,-12				
  9119	405177'	105 17 0 00 777766 						4981
  9120						MOVEI	AC1,162				; AC1,162				
  9121	405200'	201 01 0 00 000162 						4772
  9122					L.335:	ADJSP	SP,-1				; SP,-1					
  9123	405201'	105 17 0 00 777777 						4732
  9124	405202'	262 17 0 00 000016 		POP	SP,AC16				; SP,AC16
  9125	405203'	262 17 0 00 000014 		POP	SP,AC14				; SP,AC14
  9126	405204'	263 17 0 00 000000 		POPJ	SP,				; SP,
  9127	405205'	44 10 0 00 000024'	C.90:	POINT	8,U.57,-1			; 8,REC%MSG,-1
  9128	405206'	000000	000000*		C.91:	XWD	0,DBG%DUMP			; 0,DBG%DUMP
  9129	405207'	000000	404711'		C.92:	XWD	0,U.80				; 0,ATTEMPT%TEXT
  9130	405210'	000000	000024'		C.93:	XWD	0,U.57				; 0,REC%MSG
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-166
KERMSG	MAC	18-Jan-73 17:20	

  9131	405211'	14 10 0 00 000024'	C.94:	POINT	8,U.57,23			; 8,REC%MSG,23
  9132	405212'	34 10 0 00 000024'	C.95:	POINT	8,U.57,7			; 8,REC%MSG,7
  9133	405213'	24 10 0 00 000024'	C.96:	POINT	8,U.57,15			; 8,REC%MSG,15
  9134	405214'	000000	000000*		C.97:	XWD	0,LAST%ERROR			; 0,LAST%ERROR
  9135
  9136					; Routine Size:  191 words
  9137
  9138
  9139					;   4983  1	%SBTTL 'CALC%BLOCK%CHECK'
  9140					;   4984  1	ROUTINE CALC%BLOCK%CHECK (POINTER, LENGTH) =
  9141					;   4985  1	
  9142					;   4986  1	!++
  9143					;   4987  1	! FUNCTIONAL DESCRIPTION:
  9144					;   4988  1	!
  9145					;   4989  1	!	This routine will calculate the proper value for the block check
  9146					;   4990  1	!	for a given message.  The value it returns is dependant upon the
  9147					;   4991  1	!	type of block check requested in BLK%CHK%TYPE.
  9148					;   4992  1	!
  9149					;   4993  1	! CALLING SEQUENCE:
  9150					;   4994  1	!
  9151					;   4995  1	!	CHKSUM = CALC%BLOCK%CHECK (.POINTER, .LENGTH);
  9152					;   4996  1	!
  9153					;   4997  1	! INPUT PARAMETERS:
  9154					;   4998  1	!
  9155					;   4999  1	!	POINTER - A character pointer to the first character to be
  9156					;   5000  1	!		included in the block check.
  9157					;   5001  1	!
  9158					;   5002  1	!	LENGTH - The number of characters to be included.
  9159					;   5003  1	!
  9160					;   5004  1	! IMPLICIT INPUTS:
  9161					;   5005  1	!
  9162					;   5006  1	!	BLK%CHK%TYPE - The type of block check to generate.
  9163					;   5007  1	!
  9164					;   5008  1	! OUPTUT PARAMETERS:
  9165					;   5009  1	!
  9166					;   5010  1	!	The value is the block check.
  9167					;   5011  1	!
  9168					;   5012  1	! IMPLICIT OUTPUTS:
  9169					;   5013  1	!
  9170					;   5014  1	!	None.
  9171					;   5015  1	!
  9172					;   5016  1	! COMPLETION CODES:
  9173					;   5017  1	!
  9174					;   5018  1	!	None.
  9175					;   5019  1	!
  9176					;   5020  1	! SIDE EFFECTS:
  9177					;   5021  1	!
  9178					;   5022  1	!	None.
  9179					;   5023  1	!
  9180					;   5024  1	!--
  9181					;   5025  1	
  9182					;   5026  2	    BEGIN
  9183					;   5027  2	
  9184					;   5028  2	    LOCAL
  9185					;   5029  2		CHAR%MASK,				! Mask for stripping bits
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-167
KERMSG	MAC	18-Jan-73 17:20	

  9186					;   5030  2		BLOCK%CHECK;				! To build initial block che
  9187					ck value
  9188					;   5031  2	
  9189					;   5032  2	    BLOCK%CHECK = 0;				! Start out at 0
  9190					;   5033  2	!
  9191					;   5034  2	! Set mask for characters so that we calculate the block check correctly
  9192					;   5035  2	!
  9193					;   5036  2	    CHAR%MASK = (IF .PARITY%TYPE EQL PR%NONE THEN %O'377' ELSE %O'177');
  9194					;   5037  2	
  9195					;   5038  2	    CASE .BLK%CHK%TYPE FROM CHK%1CHAR TO CHK%CRC OF
  9196					;   5039  2		SET
  9197					;   5040  2	
  9198					;   5041  2		[CHK%1CHAR, CHK%2CHAR] :
  9199					;   5042  2	
  9200					;   5043  2		    INCR I FROM 1 TO .LENGTH DO
  9201					;   5044  2			BLOCK%CHECK = .BLOCK%CHECK + (CH$RCHAR%A (POINTER) AND .CHAR
  9202					%MASK);
  9203					;   5045  2	
  9204					;   5046  2		[CHK%CRC] :
  9205					;   5047  3		    BEGIN
  9206					;   5048  3	!
  9207					;   5049  3	! Ensure that the calculation is done with correct type of characters
  9208					;   5050  3	!
  9209					;   5051  3	
  9210					;   5052  3		    LOCAL
  9211					;   5053  3			TMP%PTR;			! Temp pointer for copying c
  9212					hars
  9213					;   5054  3	
  9214					;   5055  3		    TMP%PTR = .POINTER;
  9215					;   5056  3	
  9216					;   5057  3		    IF .PARITY%TYPE EQL PR%NONE
  9217					;   5058  3		    THEN
  9218					;   5059  3	
  9219					;   5060  3			INCR I FROM 1 TO .LENGTH DO
  9220					;   5061  3			    CH$WCHAR%A ((CH$RCHAR (.TMP%PTR) AND %O'177'), TMP%PTR);
  9221
  9222					;   5062  3	
  9223					;   5063  3		    BLOCK%CHECK = CRCCLC (.POINTER, .LENGTH);
  9224					;   5064  2		    END;
  9225					;   5065  2		TES;
  9226					;   5066  2	
  9227					;   5067  2	    IF .BLK%CHK%TYPE EQL CHK%1CHAR
  9228					;   5068  2	    THEN
  9229					;   5069  2		BLOCK%CHECK = (.BLOCK%CHECK + ((.BLOCK%CHECK AND %O'300')/%O'100')) 
  9230					AND %O'77';
  9231					;   5070  2	
  9232					;   5071  2	    RETURN .BLOCK%CHECK;			! Return the correct value
  9233					;   5072  1	    END;					! End of CALC%BLOCK%CHK
  9234
  9235
  9236					; CALC%BLOCK%CHECK
  9237					U.19:	SETZB	AC4,AC2				; BLOCK%CHECK,AC2			
  9238	405215'	403 04 0 00 000002 						5032
  9239						SKIPE	PARITY%TYPE			; PARITY%TYPE				
  9240	405216'	332 00 0 00 400056*						5036
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-168
KERMSG	MAC	18-Jan-73 17:20	

  9241	405217'	254 00 0 00 405223'		JRST	L.336				; L.336
  9242	405220'	201 02 0 00 000001 		MOVEI	AC2,1				; AC2,1
  9243	405221'	201 03 0 00 000377 		MOVEI	AC3,377				; CHAR%MASK,377
  9244	405222'	254 00 0 00 405224'		JRST	L.337				; L.337
  9245	405223'	201 03 0 00 000177 	L.336:	MOVEI	AC3,177				; CHAR%MASK,177
  9246					L.337:	MOVE	AC1,U.46			; AC1,BLK%CHK%TYPE			
  9247	405224'	200 01 0 00 000011'						5038
  9248	405225'	275 01 0 00 000061 		SUBI	AC1,61				; AC1,61
  9249	405226'	254 00 0 01 405227'		JRST	L.338(AC1)			; L.338(AC1)
  9250	405227'	254 00 0 00 405232'	L.338:	JRST	L.339				; L.339
  9251	405230'	254 00 0 00 405232'		JRST	L.339				; L.339
  9252	405231'	254 00 0 00 405243'		JRST	L.342				; L.342
  9253					L.339:	SETZ	AC2,				; I,					
  9254	405232'	400 02 0 00 000000 						5043
  9255	405233'	254 00 0 00 405237'		JRST	L.341				; L.341
  9256					L.340:	ILDB	AC1,-2(SP)			; AC1,POINTER				
  9257	405234'	134 01 0 17 777776 						5044
  9258	405235'	404 01 0 00 000003 		AND	AC1,AC3				; AC1,CHAR%MASK
  9259	405236'	270 04 0 00 000001 		ADD	AC4,AC1				; BLOCK%CHECK,AC1
  9260					L.341:	ADDI	AC2,1				; I,1					
  9261	405237'	271 02 0 00 000001 						5043
  9262	405240'	317 02 0 17 777777 		CAMG	AC2,-1(SP)			; I,LENGTH
  9263	405241'	254 00 0 00 405234'		JRST	L.340				; L.340
  9264						JRST	L.346				; L.346					
  9265	405242'	254 00 0 00 405265'						5038
  9266					L.342:	MOVE	AC1,-2(SP)			; TMP%PTR,POINTER			
  9267	405243'	200 01 0 17 777776 						5055
  9268						TRNN	AC2,1				; AC2,1					
  9269	405244'	606 02 0 00 000001 						5057
  9270	405245'	254 00 0 00 405260'		JRST	L.345				; L.345
  9271						MOVE	AC5,-1(SP)			; AC5,LENGTH				
  9272	405246'	200 05 0 17 777777 						5060
  9273	405247'	400 03 0 00 000000 		SETZ	AC3,				; I,
  9274	405250'	254 00 0 00 405255'		JRST	L.344				; L.344
  9275					L.343:	MOVE	AC2,AC1				; AC2,TMP%PTR				
  9276	405251'	200 02 0 00 000001 						5061
  9277	405252'	134 02 0 00 000002 		ILDB	AC2,AC2				; AC2,AC2
  9278	405253'	405 02 0 00 000177 		ANDI	AC2,177				; AC2,177
  9279	405254'	136 02 0 00 000001 		IDPB	AC2,AC1				; AC2,TMP%PTR
  9280					L.344:	ADDI	AC3,1				; I,1					
  9281	405255'	271 03 0 00 000001 						5060
  9282	405256'	317 03 0 00 000005 		CAMG	AC3,AC5				; I,AC5
  9283	405257'	254 00 0 00 405251'		JRST	L.343				; L.343
  9284					L.345:	PUSH	SP,-2(SP)			; SP,POINTER				
  9285	405260'	261 17 0 17 777776 						5063
  9286	405261'	261 17 0 17 777776 		PUSH	SP,-2(SP)			; SP,LENGTH
  9287	405262'	260 17 0 00 000000*		PUSHJ	SP,CRCCLC			; SP,CRCCLC
  9288	405263'	200 04 0 00 000001 		MOVE	AC4,AC1				; BLOCK%CHECK,AC1
  9289						ADJSP	SP,-2				; SP,-2					
  9290	405264'	105 17 0 00 777776 						5047
  9291					L.346:	MOVEI	AC1,61				; AC1,61				
  9292	405265'	201 01 0 00 000061 						5067
  9293	405266'	312 01 0 00 000011'		CAME	AC1,U.46			; AC1,BLK%CHK%TYPE
  9294	405267'	254 00 0 00 405275'		JRST	L.347				; L.347
  9295						MOVE	AC1,AC4				; AC1,BLOCK%CHECK			
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-169
KERMSG	MAC	18-Jan-73 17:20	

  9296	405270'	200 01 0 00 000004 						5069
  9297	405271'	405 01 0 00 000300 		ANDI	AC1,300				; AC1,300
  9298	405272'	231 01 0 00 000100 		IDIVI	AC1,100				; AC1,100
  9299	405273'	270 01 0 00 000004 		ADD	AC1,AC4				; AC1,BLOCK%CHECK
  9300	405274'	135 04 0 00 401013'		LDB	AC4,C.18			; BLOCK%CHECK,[POINT 6,AC1,35]  <0,6>
  9301					L.347:	MOVE	AC1,AC4				; AC1,BLOCK%CHECK			
  9302	405275'	200 01 0 00 000004 						5026
  9303						POPJ	SP,				; SP,					
  9304	405276'	263 17 0 00 000000 						4984
  9305
  9306					; Routine Size:  50 words
  9307
  9308
  9309					;   5073  1	%SBTTL 'NORMALIZE%FILE - Put file name into normal form'
  9310					;   5074  1	ROUTINE NORMALIZE%FILE (FILE%ADDRESS, FILE%LENGTH, NAME%LENGTH, TYPE%LENGTH)
  9311					 : NOVALUE =
  9312					;   5075  1	
  9313					;   5076  1	!++
  9314					;   5077  1	! FUNCTIONAL DESCRIPTION:
  9315					;   5078  1	!
  9316					;   5079  1	!	This routine will ensure that a file specification is in normal
  9317					;   5080  1	!	form.  It does this by replacing all non-alphanumeric characters
  9318					;   5081  1	!	(except the first period) with "X".  It will also ensure that
  9319					;   5082  1	!	the resulting specification (of form name.type) has only
  9320					;   5083  1	!	a specified number of characters in the name portion and type portio
  9321					n.
  9322					;   5084  1	!
  9323					;   5085  1	! CALLING SEQUENCE:
  9324					;   5086  1	!
  9325					;   5087  1	!	NORMALIZE%FILE (FILE%ADDRESS, FILE%LENGTH, NAME%LENGTH, TYPE%LENGTH)
  9326					;
  9327					;   5088  1	!
  9328					;   5089  1	! INPUT PARAMETERS:
  9329					;   5090  1	!
  9330					;   5091  1	!	FILE%ADDRESS - Address of file specification string to be normalized
  9331
  9332					;   5092  1	!
  9333					;   5093  1	!	FILE%LENGTH - Length of file specification
  9334					;   5094  1	!
  9335					;   5095  1	!	NAME%LENGTH - Maximum length desired for "name" portion.
  9336					;   5096  1	!
  9337					;   5097  1	!	TYPE%LENGTH - Maximum length desired for "type" portion.
  9338					;   5098  1	!
  9339					;   5099  1	!	With both NAME%LENGTH and TYPE%LENGTH, a negative value indicates
  9340					;   5100  1	!	unlimited lenght.
  9341					;   5101  1	!
  9342					;   5102  1	! IMPLICIT INPUTS:
  9343					;   5103  1	!
  9344					;   5104  1	!	None.
  9345					;   5105  1	!
  9346					;   5106  1	! OUPTUT PARAMETERS:
  9347					;   5107  1	!
  9348					;   5108  1	!	FILE%LENGTH - The length of the resulting file spec
  9349					;   5109  1	!
  9350					;   5110  1	!	NAME%LENGTH - The actual length of the resulting file name
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-170
KERMSG	MAC	18-Jan-73 17:20	

  9351					;   5111  1	!
  9352					;   5112  1	!	TYPE%LENGTH - The actual length of the resulting file type
  9353					;   5113  1	!
  9354					;   5114  1	! IMPLICIT OUTPUTS:
  9355					;   5115  1	!
  9356					;   5116  1	!	None.
  9357					;   5117  1	!
  9358					;   5118  1	! COMPLETION CODES:
  9359					;   5119  1	!
  9360					;   5120  1	!	None.
  9361					;   5121  1	!
  9362					;   5122  1	! SIDE EFFECTS:
  9363					;   5123  1	!
  9364					;   5124  1	!	None.
  9365					;   5125  1	!
  9366					;   5126  1	!--
  9367					;   5127  1	
  9368					;   5128  2	    BEGIN
  9369					;   5129  2	
  9370					;   5130  2	    LOCAL
  9371					;   5131  2		CH,					! Character being processed
  9372					;   5132  2		POINTER,				! Pointer to file spec
  9373					;   5133  2		WRT%POINTER,				! Pointer to write file spec
  9374
  9375					;   5134  2		WRT%SIZE,
  9376					;   5135  2		FIRST%PERIOD,				! Flag we have seen a period
  9377
  9378					;   5136  2		IGNORE%BAD,				! Flag we should ignore bad 
  9379					characters
  9380					;   5137  2		BAD%CHAR,				! Flag this character was ba
  9381					d
  9382					;   5138  2		FILE%CTR,				! Counter for overall length
  9383
  9384					;   5139  2		NAME%CTR,				! Counter for name character
  9385					s
  9386					;   5140  2		TYPE%CTR;				! Counter for type character
  9387					s
  9388					;   5141  2	
  9389					;   5142  2	    FILE%CTR = 0;
  9390					;   5143  2	    NAME%CTR = 0;
  9391					;   5144  2	    TYPE%CTR = 0;
  9392					;   5145  2	    WRT%SIZE = 0;
  9393					;   5146  2	    FIRST%PERIOD = FALSE;			! No periods yet
  9394					;   5147  2	    POINTER = CH$PTR (.FILE%ADDRESS);		! Set up pointer to file nam
  9395					e
  9396					;   5148  2	    WRT%POINTER = .POINTER;
  9397					;   5149  2	
  9398					;   5150  2	    IF .NAME%LENGTH EQL 0 THEN FIRST%PERIOD = TRUE;	! Pretend we did nam
  9399					e already
  9400					;   5151  2	
  9401					;   5152  2	    IGNORE%BAD = FALSE;
  9402					;   5153  2	
  9403					;   5154  2	    IF .NAME%LENGTH GTR 0
  9404					;   5155  2	    THEN
  9405					;   5156  3		BEGIN
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-171
KERMSG	MAC	18-Jan-73 17:20	

  9406					;   5157  3	
  9407					;   5158  3		DECR I FROM ..FILE%LENGTH TO 0 DO
  9408					;   5159  3	
  9409					;   5160  3		    IF CH$RCHAR%A (POINTER) EQL %C'.'
  9410					;   5161  3		    THEN
  9411					;   5162  4			BEGIN
  9412					;   5163  4			IGNORE%BAD = TRUE;
  9413					;   5164  4			EXITLOOP;
  9414					;   5165  3			END;
  9415					;   5166  3	
  9416					;   5167  2		END;
  9417					;   5168  2	
  9418					;   5169  2	    POINTER = .WRT%POINTER;
  9419					;   5170  2	
  9420					;   5171  2	    WHILE .FILE%CTR LSS ..FILE%LENGTH DO
  9421					;   5172  3		BEGIN
  9422					;   5173  3		CH = CH$RCHAR%A (POINTER);		! Get a character
  9423					;   5174  3		FILE%CTR = .FILE%CTR + 1;
  9424					;   5175  3	
  9425					;   5176  4		IF (.CH LSS %C'0' AND (.CH NEQ %C'.' OR .FIRST%PERIOD)) OR .CH GTR %
  9426					C'z' OR (.CH GTR %C'9'
  9427					;   5177  4		    AND .CH LSS %C'A') OR (.CH GTR %C'Z' AND .CH LSS %C'a')
  9428					;   5178  3		THEN
  9429					;   5179  4		    BEGIN
  9430					;   5180  4		    BAD%CHAR = TRUE;
  9431					;   5181  4		    CH = %C'X';
  9432					;   5182  4		    END
  9433					;   5183  3		ELSE
  9434					;   5184  4		    BEGIN
  9435					;   5185  4		    BAD%CHAR = FALSE;
  9436					;   5186  4	
  9437					;   5187  4		    IF .CH GEQ %C'a' THEN CH = .CH - (%C'a' - %C'A');
  9438					;   5188  4	
  9439					;   5189  3		    END;
  9440					;   5190  3	
  9441					;   5191  3		IF .CH EQL %C'.'
  9442					;   5192  3		THEN
  9443					;   5193  4		    BEGIN
  9444					;   5194  4		    FIRST%PERIOD = TRUE;
  9445					;   5195  4		    CH$WCHAR%A (.CH, WRT%POINTER);
  9446					;   5196  4		    WRT%SIZE = .WRT%SIZE + 1;
  9447					;   5197  4		    END
  9448					;   5198  3		ELSE
  9449					;   5199  3	
  9450					;   5200  3		    IF NOT .BAD%CHAR OR NOT .IGNORE%BAD
  9451					;   5201  3		    THEN
  9452					;   5202  3	
  9453					;   5203  3			IF NOT .FIRST%PERIOD
  9454					;   5204  3			THEN
  9455					;   5205  4			    BEGIN
  9456					;   5206  4	
  9457					;   5207  4			    IF .NAME%LENGTH LSS 0 OR .NAME%CTR LSS .NAME%LENGTH
  9458					;   5208  4			    THEN
  9459					;   5209  5				BEGIN
  9460					;   5210  5				NAME%CTR = .NAME%CTR + 1;
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-172
KERMSG	MAC	18-Jan-73 17:20	

  9461					;   5211  5				WRT%SIZE = .WRT%SIZE + 1;
  9462					;   5212  5				CH$WCHAR%A (.CH, WRT%POINTER);
  9463					;   5213  4				END;
  9464					;   5214  4	
  9465					;   5215  4			    END
  9466					;   5216  3			ELSE
  9467					;   5217  3	
  9468					;   5218  3			    IF .TYPE%LENGTH LSS 0 OR .TYPE%CTR LSS .TYPE%LENGTH
  9469					;   5219  3			    THEN
  9470					;   5220  4				BEGIN
  9471					;   5221  4				TYPE%CTR = .TYPE%CTR + 1;
  9472					;   5222  4				WRT%SIZE = .WRT%SIZE + 1;
  9473					;   5223  4				CH$WCHAR%A (.CH, WRT%POINTER);
  9474					;   5224  3				END;
  9475					;   5225  3	
  9476					;   5226  2		END;
  9477					;   5227  2	
  9478					;   5228  2	    .FILE%LENGTH = .WRT%SIZE;
  9479					;   5229  2	    CH$WCHAR%A (CHR%NUL, WRT%POINTER);
  9480					;   5230  1	    END;					! End of NORMALIZE%FILE
  9481
  9482
  9483					; NORMALIZE%FILE
  9484					U.27:	PUSH	SP,AC10				; SP,AC10				
  9485	405277'	261 17 0 00 000010 						5074
  9486	405300'	261 17 0 00 000011 		PUSH	SP,AC11				; SP,AC11
  9487	405301'	261 17 0 00 000012 		PUSH	SP,AC12				; SP,AC12
  9488	405302'	261 17 0 00 000013 		PUSH	SP,AC13				; SP,AC13
  9489	405303'	261 17 0 00 000014 		PUSH	SP,AC14				; SP,AC14
  9490	405304'	261 17 0 00 000016 		PUSH	SP,AC16				; SP,AC16
  9491						SETZB	AC16,AC11			; FILE%CTR,NAME%CTR			
  9492	405305'	403 16 0 00 000011 						5142
  9493						SETZB	AC10,AC12			; TYPE%CTR,WRT%SIZE			
  9494	405306'	403 10 0 00 000012 						5144
  9495						SETZ	AC13,				; FIRST%PERIOD,				
  9496	405307'	400 13 0 00 000000 						5146
  9497						MOVE	AC1,-12(SP)			; AC1,FILE%ADDRESS			
  9498	405310'	200 01 0 17 777766 						5147
  9499	405311'	201 01 0 01 777777 		MOVEI	AC1,-1(AC1)			; AC1,-1(AC1)
  9500	405312'	505 01 0 00 010700 		HRLI	AC1,10700			; AC1,10700
  9501						MOVE	AC4,AC1				; WRT%POINTER,POINTER			
  9502	405313'	200 04 0 00 000001 						5148
  9503						SKIPN	AC2,-10(SP)			; AC2,NAME%LENGTH			
  9504	405314'	336 02 0 17 777770 						5150
  9505	405315'	201 13 0 00 000001 		MOVEI	AC13,1				; FIRST%PERIOD,1
  9506						SETZ	AC14,				; IGNORE%BAD,				
  9507	405316'	400 14 0 00 000000 						5152
  9508						JUMPLE	AC2,L.350			; AC2,L.350				
  9509	405317'	323 02 0 00 405331'						5154
  9510						MOVE	AC2,-11(SP)			; AC2,FILE%LENGTH			
  9511	405320'	200 02 0 17 777767 						5158
  9512	405321'	200 03 0 02 000000 		MOVE	AC3,0(AC2)			; I,0(AC2)
  9513	405322'	344 03 0 00 405330'		AOJA	AC3,L.349			; I,L.349
  9514					L.348:	ILDB	AC2,AC1				; AC2,POINTER				
  9515	405323'	134 02 0 00 000001 						5160
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-173
KERMSG	MAC	18-Jan-73 17:20	

  9516	405324'	302 02 0 00 000056 		CAIE	AC2,56				; AC2,56
  9517	405325'	254 00 0 00 405330'		JRST	L.349				; L.349
  9518						MOVEI	AC14,1				; IGNORE%BAD,1				
  9519	405326'	201 14 0 00 000001 						5163
  9520						JRST	L.350				; L.350					
  9521	405327'	254 00 0 00 405331'						5162
  9522					L.349:	SOJGE	AC3,L.348			; I,L.348				
  9523	405330'	365 03 0 00 405323'						5158
  9524					L.350:	MOVE	AC1,AC4				; POINTER,WRT%POINTER			
  9525	405331'	200 01 0 00 000004 						5169
  9526					L.351:	MOVE	AC3,-11(SP)			; AC3,FILE%LENGTH			
  9527	405332'	200 03 0 17 777767 						5171
  9528	405333'	311 16 0 03 000000 		CAML	AC16,0(AC3)			; FILE%CTR,0(AC3)
  9529	405334'	254 00 0 00 405413'		JRST	L.363				; L.363
  9530						ILDB	AC2,AC1				; CH,POINTER				
  9531	405335'	134 02 0 00 000001 						5173
  9532						ADDI	AC16,1				; FILE%CTR,1				
  9533	405336'	271 16 0 00 000001 						5174
  9534						CAIL	AC2,60				; CH,60					
  9535	405337'	301 02 0 00 000060 						5176
  9536	405340'	254 00 0 00 405344'		JRST	L.352				; L.352
  9537	405341'	306 02 0 00 000056 		CAIN	AC2,56				; CH,56
  9538	405342'	602 13 0 00 000001 		TRNE	AC13,1				; FIRST%PERIOD,1
  9539	405343'	254 00 0 00 405355'		JRST	L.354				; L.354
  9540	405344'	303 02 0 00 000172 	L.352:	CAILE	AC2,172				; CH,172
  9541	405345'	254 00 0 00 405355'		JRST	L.354				; L.354
  9542	405346'	307 02 0 00 000071 		CAIG	AC2,71				; CH,71
  9543	405347'	254 00 0 00 405352'		JRST	L.353				; L.353
  9544						CAIGE	AC2,101				; CH,101				
  9545	405350'	305 02 0 00 000101 						5177
  9546	405351'	254 00 0 00 405355'		JRST	L.354				; L.354
  9547	405352'	303 02 0 00 000132 	L.353:	CAILE	AC2,132				; CH,132
  9548	405353'	301 02 0 00 000141 		CAIL	AC2,141				; CH,141
  9549	405354'	254 00 0 00 405360'		JRST	L.355				; L.355
  9550					L.354:	MOVEI	AC5,1				; BAD%CHAR,1				
  9551	405355'	201 05 0 00 000001 						5180
  9552						MOVEI	AC2,130				; CH,130				
  9553	405356'	201 02 0 00 000130 						5181
  9554						JRST	L.356				; L.356					
  9555	405357'	254 00 0 00 405363'						5176
  9556					L.355:	SETZ	AC5,				; BAD%CHAR,				
  9557	405360'	400 05 0 00 000000 						5185
  9558						CAIL	AC2,141				; CH,141				
  9559	405361'	301 02 0 00 000141 						5187
  9560	405362'	275 02 0 00 000040 		SUBI	AC2,40				; CH,40
  9561					L.356:	CAIE	AC2,56				; CH,56					
  9562	405363'	302 02 0 00 000056 						5191
  9563	405364'	254 00 0 00 405370'		JRST	L.357				; L.357
  9564						MOVEI	AC13,1				; FIRST%PERIOD,1			
  9565	405365'	201 13 0 00 000001 						5194
  9566						IDPB	AC2,AC4				; CH,WRT%POINTER			
  9567	405366'	136 02 0 00 000004 						5195
  9568						AOJA	AC12,L.351			; WRT%SIZE,L.351			
  9569	405367'	344 12 0 00 405332'						5191
  9570					L.357:	TRNN	AC5,1				; BAD%CHAR,1				
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-174
KERMSG	MAC	18-Jan-73 17:20	

  9571	405370'	606 05 0 00 000001 						5200
  9572	405371'	254 00 0 00 405374'		JRST	L.358				; L.358
  9573	405372'	602 14 0 00 000001 		TRNE	AC14,1				; IGNORE%BAD,1
  9574	405373'	254 00 0 00 405332'		JRST	L.351				; L.351
  9575					L.358:	TRNE	AC13,1				; FIRST%PERIOD,1			
  9576	405374'	602 13 0 00 000001 						5203
  9577	405375'	254 00 0 00 405403'		JRST	L.360				; L.360
  9578						MOVE	AC3,-10(SP)			; AC3,NAME%LENGTH			
  9579	405376'	200 03 0 17 777770 						5207
  9580	405377'	321 03 0 00 405402'		JUMPL	AC3,L.359			; AC3,L.359
  9581	405400'	311 11 0 00 000003 		CAML	AC11,AC3			; NAME%CTR,AC3
  9582	405401'	254 00 0 00 405332'		JRST	L.351				; L.351
  9583					L.359:	AOJA	AC11,L.362			; NAME%CTR,L.362			
  9584	405402'	344 11 0 00 405410'						5210
  9585					L.360:	MOVE	AC3,-7(SP)			; AC3,TYPE%LENGTH			
  9586	405403'	200 03 0 17 777771 						5218
  9587	405404'	321 03 0 00 405407'		JUMPL	AC3,L.361			; AC3,L.361
  9588	405405'	311 10 0 00 000003 		CAML	AC10,AC3			; TYPE%CTR,AC3
  9589	405406'	254 00 0 00 405332'		JRST	L.351				; L.351
  9590					L.361:	ADDI	AC10,1				; TYPE%CTR,1				
  9591	405407'	271 10 0 00 000001 						5221
  9592					L.362:	ADDI	AC12,1				; WRT%SIZE,1				
  9593	405410'	271 12 0 00 000001 						5222
  9594						IDPB	AC2,AC4				; CH,WRT%POINTER			
  9595	405411'	136 02 0 00 000004 						5223
  9596						JRST	L.351				; L.351					
  9597	405412'	254 00 0 00 405332'						5218
  9598					L.363:	MOVE	AC1,-11(SP)			; AC1,FILE%LENGTH			
  9599	405413'	200 01 0 17 777767 						5228
  9600	405414'	202 12 0 01 000000 		MOVEM	AC12,0(AC1)			; WRT%SIZE,0(AC1)
  9601						SETZ	AC1,				; AC1,					
  9602	405415'	400 01 0 00 000000 						5229
  9603	405416'	136 01 0 00 000004 		IDPB	AC1,AC4				; AC1,WRT%POINTER
  9604						POP	SP,AC16				; SP,AC16				
  9605	405417'	262 17 0 00 000016 						5074
  9606	405420'	262 17 0 00 000014 		POP	SP,AC14				; SP,AC14
  9607	405421'	262 17 0 00 000013 		POP	SP,AC13				; SP,AC13
  9608	405422'	262 17 0 00 000012 		POP	SP,AC12				; SP,AC12
  9609	405423'	262 17 0 00 000011 		POP	SP,AC11				; SP,AC11
  9610	405424'	262 17 0 00 000010 		POP	SP,AC10				; SP,AC10
  9611	405425'	263 17 0 00 000000 		POPJ	SP,				; SP,
  9612
  9613					; Routine Size:  87 words
  9614
  9615
  9616					;   5231  1	%SBTTL 'Buffer filling -- Main routine'
  9617					;   5232  1	ROUTINE BFR%FILL (FIRST%FLAG) =
  9618					;   5233  1	
  9619					;   5234  1	!++
  9620					;   5235  1	! FUNCTIONAL DESCRIPTION:
  9621					;   5236  1	!
  9622					;   5237  1	!	This routine will fill the buffer with data from the file.  It
  9623					;   5238  1	!	will do all the quoting that is required.
  9624					;   5239  1	!
  9625					;   5240  1	! CALLING SEQUENCE:
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-175
KERMSG	MAC	18-Jan-73 17:20	

  9626					;   5241  1	!
  9627					;   5242  1	!	EOF%FLAG = BFR%FILL(.FIRST%FLAG);
  9628					;   5243  1	!
  9629					;   5244  1	! INPUT PARAMETERS:
  9630					;   5245  1	!
  9631					;   5246  1	!	FIRST%FLAG - Flag whether first call for this file
  9632					;   5247  1	!
  9633					;   5248  1	! IMPLICIT INPUTS:
  9634					;   5249  1	!
  9635					;   5250  1	!	None.
  9636					;   5251  1	!
  9637					;   5252  1	! OUTPUT PARAMETERS:
  9638					;   5253  1	!
  9639					;   5254  1	!	True - Buffer filled may be at end of file.
  9640					;   5255  1	!	False - At end of file.
  9641					;   5256  1	!
  9642					;   5257  1	! IMPLICIT OUTPUTS:
  9643					;   5258  1	!
  9644					;   5259  1	!	Number of characters stored in the buffer.
  9645					;   5260  1	!
  9646					;   5261  1	! COMPLETION CODES:
  9647					;   5262  1	!
  9648					;   5263  1	!	None.
  9649					;   5264  1	!
  9650					;   5265  1	! SIDE EFFECTS:
  9651					;   5266  1	!
  9652					;   5267  1	!	None.
  9653					;   5268  1	!
  9654					;   5269  1	!--
  9655					;   5270  1	
  9656					;   5271  2	    BEGIN
  9657					;   5272  2	
  9658					;   5273  2	    LITERAL
  9659					;   5274  2		NO%CHAR = -1,				! No character next
  9660					;   5275  2		EOF%CHAR = -2;				! EOF seen
  9661					;   5276  2	
  9662					;   5277  2	    LOCAL
  9663					;   5278  2		I,					! Temp loop index
  9664					;   5279  2		MAX%SIZE,				! Maximum size of data
  9665					;   5280  2		POINTER;				! Pointer into the message b
  9666					uffer
  9667					;   5281  2	
  9668					;   5282  2	    OWN
  9669					;   5283  2		NEXT%CHR,				! Saved character
  9670					;   5284  2		STATUS,					! Status value
  9671					;   5285  2		REPEAT%COUNT,				! Number of times character 
  9672					repeated
  9673					;   5286  2		CHAR%8%BIT,				! 8 bit character from file
  9674					;   5287  2		CHRS : VECTOR [5],			! String needed to represent
  9675					 character
  9676					;   5288  2		CHR%IDX,				! Index into CHRS
  9677					;   5289  2		OLD%CHAR%8%BIT,				! Previous 8-bit character
  9678					;   5290  2		OLD%CHRS : VECTOR [5],			! String for previous charac
  9679					ter
  9680					;   5291  2		OLD%CHR%IDX;				! Index for previous charact
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-176
KERMSG	MAC	18-Jan-73 17:20	

  9681					er
  9682					;   5292  2	
  9683					;   5293  2	    ROUTINE GET%QUOTED%CHAR =
  9684					;   5294  2	!
  9685					;   5295  2	! This routine gets a character from the file and returns both
  9686					;   5296  2	! the character and the string needed to represent the character
  9687					;   5297  2	! if it needs quoting.
  9688					;   5298  2	!
  9689					;   5299  3		BEGIN
  9690					;   5300  3	
  9691					;   5301  3		IF .NEXT%CHR GEQ 0
  9692					;   5302  3		THEN
  9693					;   5303  4		    BEGIN
  9694					;   5304  4		    CHAR%8%BIT = .NEXT%CHR;
  9695					;   5305  4		    NEXT%CHR = NO%CHAR;
  9696					;   5306  4		    STATUS = KER%NORMAL;
  9697					;   5307  4		    END
  9698					;   5308  3		ELSE
  9699					;   5309  3	
  9700					;   5310  3		    IF .NEXT%CHR EQL NO%CHAR
  9701					;   5311  3		    THEN
  9702					;   5312  3			STATUS = (.GET%CHR%ROUTINE) (CHAR%8%BIT)
  9703					;   5313  3		    ELSE
  9704					;   5314  3			STATUS = KER%EOF;
  9705					;   5315  3	
  9706					;   5316  3		IF .STATUS EQL KER%NORMAL
  9707					;   5317  3		THEN
  9708					;   5318  4		    BEGIN
  9709					;   5319  4	!
  9710					;   5320  4	! Determine if we should just quote the character
  9711					;   5321  4	!	Either:
  9712					;   5322  4	!		Character is a delete (177 octal)
  9713					;   5323  4	!	or	Character is a control character (less than 40 octal)
  9714					;   5324  4	!	or	Character is a quote character
  9715					;   5325  4	!	or	Character is the repeat character and doing repeat compressi
  9716					on
  9717					;   5326  4	!	or	Character is an eight bit quote character and doing eight bi
  9718					t
  9719					;   5327  4	!		  quoting.
  9720					;   5328  4	!
  9721					;   5329  4	
  9722					;   5330  5		    IF ((.CHAR%8%BIT AND %O'177') LSS %C' ') OR ((.CHAR%8%BIT AND %O
  9723					'177') EQL CHR%DEL) OR (
  9724					;   5331  7			(.CHAR%8%BIT AND %O'177') EQL .RCV%QUOTE%CHR) OR (.FLAG%REPE
  9725					AT AND ((.CHAR%8%BIT AND
  9726					;   5332  6			%O'177') EQL .REPT%CHR)) OR (.FLAG%8QUOTE AND ((.CHAR%8%BIT 
  9727					AND %O'177') EQL
  9728					;   5333  5			.SEND%8QUOTE%CHR))
  9729					;   5334  4		    THEN
  9730					;   5335  5			BEGIN
  9731					;   5336  5	!
  9732					;   5337  5	! If the character is a control character or delete we must do a CTL(Charact
  9733					er)
  9734					;   5338  5	! so it is something that we can be sure we can send.
  9735					;   5339  5	!
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-177
KERMSG	MAC	18-Jan-73 17:20	

  9736					;   5340  5	
  9737					;   5341  6			IF ((.CHAR%8%BIT AND %O'177') LSS %C' ') OR ((.CHAR%8%BIT AN
  9738					D %O'177') EQL CHR%DEL)
  9739					;   5342  5			THEN
  9740					;   5343  6			    CHRS [0] = CTL (.CHAR%8%BIT)
  9741					;   5344  5			ELSE
  9742					;   5345  5			    CHRS [0] = .CHAR%8%BIT;
  9743					;   5346  5	
  9744					;   5347  5			CHR%IDX = 1;
  9745					;   5348  5			CHRS [1] = .RCV%QUOTE%CHR;	![035] Use character we said
  9746					 we would send
  9747					;   5349  5			END
  9748					;   5350  4		    ELSE
  9749					;   5351  5			BEGIN
  9750					;   5352  5			CHR%IDX = 0;
  9751					;   5353  5			CHRS [0] = .CHAR%8%BIT;
  9752					;   5354  4			END;
  9753					;   5355  4	
  9754					;   5356  4		    END
  9755					;   5357  3		ELSE
  9756					;   5358  3	
  9757					;   5359  3		    IF .STATUS NEQ KER%EOF THEN KRM%ERROR (.STATUS);	! Report err
  9758					or
  9759					;   5360  3	
  9760					;   5361  3		RETURN .STATUS;
  9761					;   5362  2		END;
  9762
  9763
  9764	000115'					RELOC	115
  9765					; NEXT%CHR
  9766	000115'				U.81:	BLOCK	1
  9767					; STATUS
  9768	000116'				U.82:	BLOCK	1
  9769					; REPEAT%COUNT
  9770	000117'				U.83:	BLOCK	1
  9771					; CHAR%8%BIT
  9772	000120'				U.84:	BLOCK	1
  9773					; CHRS
  9774	000121'				U.85:	BLOCK	5
  9775					; CHR%IDX
  9776	000126'				U.86:	BLOCK	1
  9777					; OLD%CHAR%8%BIT
  9778	000127'				U.87:	BLOCK	1
  9779					; OLD%CHRS
  9780	000130'				U.88:	BLOCK	5
  9781					; OLD%CHR%IDX
  9782	000135'				U.89:	BLOCK	1
  9783
  9784
  9785	405426'					RELOC	405426
  9786					; GET%QUOTED%CHAR
  9787					U.90:	MOVE	AC1,U.81			; AC1,NEXT%CHR				
  9788	405426'	200 01 0 00 000115'						5301
  9789	405427'	321 01 0 00 405434'		JUMPL	AC1,L.364			; AC1,L.364
  9790						MOVEM	AC1,U.84			; AC1,CHAR%8%BIT			
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-178
KERMSG	MAC	18-Jan-73 17:20	

  9791	405430'	202 01 0 00 000120'						5304
  9792						SETOM	U.81				; NEXT%CHR				
  9793	405431'	476 00 0 00 000115'						5305
  9794						MOVEI	AC1,13				; AC1,13				
  9795	405432'	201 01 0 00 000013 						5306
  9796	405433'	254 00 0 00 405445'		JRST	L.366				; L.366
  9797					L.364:	CAME	AC1,C.37			; AC1,[-1]				
  9798	405434'	312 01 0 00 401662'						5310
  9799	405435'	254 00 0 00 405444'		JRST	L.365				; L.365
  9800						MOVE	AC1,U.66			; AC1,GET%CHR%ROUTINE			
  9801	405436'	200 01 0 00 000113'						5312
  9802	405437'	261 17 0 00 405520'		PUSH	SP,C.99				; SP,[0,,CHAR%8%BIT]
  9803	405440'	260 17 0 01 000000 		PUSHJ	SP,0(AC1)			; SP,0(AC1)
  9804	405441'	202 01 0 00 000116'		MOVEM	AC1,U.82			; AC1,STATUS
  9805	405442'	105 17 0 00 777777 		ADJSP	SP,-1				; SP,-1
  9806						JRST	L.367				; L.367					
  9807	405443'	254 00 0 00 405446'						5310
  9808					L.365:	MOVEI	AC1,113				; AC1,113				
  9809	405444'	201 01 0 00 000113 						5314
  9810	405445'	202 01 0 00 000116'	L.366:	MOVEM	AC1,U.82			; AC1,STATUS
  9811					L.367:	MOVE	AC1,U.82			; AC1,STATUS				
  9812	405446'	200 01 0 00 000116'						5316
  9813	405447'	302 01 0 00 000013 		CAIE	AC1,13				; AC1,13
  9814	405450'	254 00 0 00 405510'		JRST	L.372				; L.372
  9815						MOVE	AC2,U.84			; AC2,CHAR%8%BIT			
  9816	405451'	200 02 0 00 000120'						5330
  9817	405452'	135 01 0 00 405517'		LDB	AC1,C.98			; AC1,[POINT 7,AC2,35]  <0,7>
  9818	405453'	400 03 0 00 000000 		SETZ	AC3,				; AC3,
  9819	405454'	301 01 0 00 000040 		CAIL	AC1,40				; AC1,40
  9820	405455'	254 00 0 00 405460'		JRST	L.368				; L.368
  9821	405456'	201 03 0 00 000001 		MOVEI	AC3,1				; AC3,1
  9822	405457'	254 00 0 00 405474'		JRST	L.370				; L.370
  9823	405460'	302 01 0 00 000177 	L.368:	CAIE	AC1,177				; AC1,177
  9824	405461'	316 01 0 00 404401*		CAMN	AC1,RCV%QUOTE%CHR		; AC1,RCV%QUOTE%CHR
  9825	405462'	254 00 0 00 405474'		JRST	L.370				; L.370
  9826						MOVEI	AC4,1				; AC4,1					
  9827	405463'	201 04 0 00 000001 						5331
  9828	405464'	616 04 0 00 000013'		TDNN	AC4,U.48			; AC4,FLAG%REPEAT
  9829	405465'	254 00 0 00 405470'		JRST	L.369				; L.369
  9830	405466'	316 01 0 00 000001'		CAMN	AC1,U.38			; AC1,REPT%CHR
  9831	405467'	254 00 0 00 405474'		JRST	L.370				; L.370
  9832					L.369:	MOVEI	AC4,1				; AC4,1					
  9833	405470'	201 04 0 00 000001 						5332
  9834	405471'	612 04 0 00 000012'		TDNE	AC4,U.47			; AC4,FLAG%8QUOTE
  9835	405472'	312 01 0 00 000007'		CAME	AC1,U.44			; AC1,SEND%8QUOTE%CHR
  9836	405473'	254 00 0 00 405505'		JRST	L.371				; L.371
  9837					L.370:	TRNN	AC3,1				; AC3,1					
  9838	405474'	606 03 0 00 000001 						5341
  9839	405475'	306 01 0 00 000177 		CAIN	AC1,177				; AC1,177
  9840						TRC	AC2,100				; AC2,100				
  9841	405476'	640 02 0 00 000100 						5343
  9842						MOVEM	AC2,U.85			; AC2,CHRS				
  9843	405477'	202 02 0 00 000121'						5345
  9844						MOVEI	AC1,1				; AC1,1					
  9845	405500'	201 01 0 00 000001 						5347
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-179
KERMSG	MAC	18-Jan-73 17:20	

  9846	405501'	202 01 0 00 000126'		MOVEM	AC1,U.86			; AC1,CHR%IDX
  9847						MOVE	AC1,RCV%QUOTE%CHR		; AC1,RCV%QUOTE%CHR			
  9848	405502'	200 01 0 00 405461*						5348
  9849	405503'	202 01 0 00 000122'		MOVEM	AC1,U.85+1			; AC1,CHRS+1
  9850						JRST	L.373				; L.373					
  9851	405504'	254 00 0 00 405515'						5330
  9852					L.371:	SETZM	U.86				; CHR%IDX				
  9853	405505'	402 00 0 00 000126'						5352
  9854						MOVEM	AC2,U.85			; AC2,CHRS				
  9855	405506'	202 02 0 00 000121'						5353
  9856						JRST	L.373				; L.373					
  9857	405507'	254 00 0 00 405515'						5316
  9858					L.372:	CAIN	AC1,113				; AC1,113				
  9859	405510'	306 01 0 00 000113 						5359
  9860	405511'	254 00 0 00 405515'		JRST	L.373				; L.373
  9861	405512'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
  9862	405513'	260 17 0 00 404763*		PUSHJ	SP,KRM%ERROR			; SP,KRM%ERROR
  9863	405514'	105 17 0 00 777777 		ADJSP	SP,-1				; SP,-1
  9864					L.373:	MOVE	AC1,U.82			; AC1,STATUS				
  9865	405515'	200 01 0 00 000116'						5299
  9866						POPJ	SP,				; SP,					
  9867	405516'	263 17 0 00 000000 						5293
  9868	405517'	00 07 0 00 000002 	C.98:	POINT	7,AC2,35			; 7,AC2,35
  9869	405520'	000000	000120'		C.99:	XWD	0,U.84				; 0,CHAR%8%BIT
  9870
  9871					; Routine Size:  59 words
  9872
  9873
  9874					;   5363  2	    ROUTINE GET%8%QUOTED%CHAR =
  9875					;   5364  2	!
  9876					;   5365  2	! This routine will get the quoted representation of a character
  9877					;   5366  2	! (by calling GET%QUOTED%CHAR), and return the 8th-bit quoted
  9878					;   5367  2	! representation.
  9879					;   5368  2	!
  9880					;   5369  3		BEGIN
  9881					;   5370  3	
  9882					;   5371  3		IF (STATUS = GET%QUOTED%CHAR ()) EQL KER%NORMAL
  9883					;   5372  3		THEN
  9884					;   5373  4		    BEGIN
  9885					;   5374  4	!
  9886					;   5375  4	! Determine if we must quote the eighth bit (parity bit on)
  9887					;   5376  4	!
  9888					;   5377  4	
  9889					;   5378  5		    IF (((.CHRS [0] AND %O'177') NEQ .CHRS [0]) AND .FLAG%8QUOTE)
  9890					;   5379  4		    THEN
  9891					;   5380  5			BEGIN
  9892					;   5381  5			CHRS [0] = .CHRS [0] AND %O'177';
  9893					;   5382  5			CHR%IDX = .CHR%IDX + 1;
  9894					;   5383  5			CHRS [.CHR%IDX] = .SEND%8QUOTE%CHR;
  9895					;   5384  4			END;
  9896					;   5385  4	
  9897					;   5386  3		    END;
  9898					;   5387  3	
  9899					;   5388  3		RETURN .STATUS;
  9900					;   5389  2		END;
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-180
KERMSG	MAC	18-Jan-73 17:20	

  9901
  9902
  9903					; GET%8%QUOTED%CHAR
  9904					U.91:	PUSHJ	SP,U.90				; SP,GET%QUOTED%CHAR			
  9905	405521'	260 17 0 00 405426'						5371
  9906	405522'	202 01 0 00 000116'		MOVEM	AC1,U.82			; AC1,STATUS
  9907	405523'	302 01 0 00 000013 		CAIE	AC1,13				; AC1,13
  9908	405524'	254 00 0 00 405540'		JRST	L.374				; L.374
  9909						LDB	AC1,C.100			; AC1,[POINT 7,CHRS,35]  <0,7>		
  9910	405525'	135 01 0 00 405542'						5378
  9911	405526'	316 01 0 00 000121'		CAMN	AC1,U.85			; AC1,CHRS
  9912	405527'	254 00 0 00 405540'		JRST	L.374				; L.374
  9913	405530'	201 01 0 00 000001 		MOVEI	AC1,1				; AC1,1
  9914	405531'	616 01 0 00 000012'		TDNN	AC1,U.47			; AC1,FLAG%8QUOTE
  9915	405532'	254 00 0 00 405540'		JRST	L.374				; L.374
  9916						LDB	AC1,C.100			; AC1,[POINT 7,CHRS,35]  <0,7>		
  9917	405533'	135 01 0 00 405542'						5381
  9918	405534'	202 01 0 00 000121'		MOVEM	AC1,U.85			; AC1,CHRS
  9919						AOS	AC1,U.86			; AC1,CHR%IDX				
  9920	405535'	350 01 0 00 000126'						5383
  9921	405536'	200 02 0 00 000007'		MOVE	AC2,U.44			; AC2,SEND%8QUOTE%CHR
  9922	405537'	202 02 0 01 000121'		MOVEM	AC2,U.85(AC1)			; AC2,CHRS(AC1)
  9923					L.374:	MOVE	AC1,U.82			; AC1,STATUS				
  9924	405540'	200 01 0 00 000116'						5369
  9925						POPJ	SP,				; SP,					
  9926	405541'	263 17 0 00 000000 						5363
  9927	405542'	00 07 0 00 000121'	C.100:	POINT	7,U.85,35			; 7,CHRS,35
  9928
  9929					; Routine Size:  18 words
  9930
  9931
  9932					;   5390  2	!
  9933					;   5391  2	! Start of code for BFR%FILL
  9934					;   5392  2	!
  9935					;   5393  2	! Initialize pointer and count
  9936					;   5394  2	!
  9937					;   5395  2	    SIZE = 0;
  9938					;   5396  2	    POINTER = CH$PTR (SND%MSG, PKT%MSG, CHR%SIZE);
  9939					;   5397  2	    MAX%SIZE = .SEND%PKT%SIZE - PKT%OVR%HEAD - (.BLK%CHK%TYPE - CHK%1CHAR);
  9940					;   5398  2	!
  9941					;   5399  2	! If last call got an error or eof, return it now
  9942					;   5400  2	!
  9943					;   5401  2	
  9944					;   5402  2	    IF NOT .FIRST%FLAG AND (.STATUS NEQ KER%NORMAL) THEN RETURN .STATUS;
  9945					;   5403  2	
  9946					;   5404  2	!
  9947					;   5405  2	! If first time for a file prime the pump with the first character.
  9948					;   5406  2	!
  9949					;   5407  2	
  9950					;   5408  2	    IF .FIRST%FLAG
  9951					;   5409  2	    THEN
  9952					;   5410  3		BEGIN
  9953					;   5411  3		FIRST%FLAG = FALSE;
  9954					;   5412  3		NEXT%CHR = -1;				! No backed up character
  9955					;   5413  3	
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-181
KERMSG	MAC	18-Jan-73 17:20	

  9956					;   5414  3		IF .FLAG%8QUOTE THEN STATUS = GET%8%QUOTED%CHAR () ELSE STATUS = GET
  9957					%QUOTED%CHAR ();
  9958					;   5415  3	
  9959					;   5416  3		IF .STATUS NEQ KER%NORMAL THEN RETURN .STATUS;
  9960					;   5417  3	
  9961					;   5418  3		OLD%CHAR%8%BIT = .CHAR%8%BIT;
  9962					;   5419  3	
  9963					;   5420  3		INCR OLD%CHR%IDX FROM 0 TO .CHR%IDX DO
  9964					;   5421  3		    OLD%CHRS [.OLD%CHR%IDX] = .CHRS [.OLD%CHR%IDX];
  9965					;   5422  3	
  9966					;   5423  3		OLD%CHR%IDX = .CHR%IDX;
  9967					;   5424  3		REPEAT%COUNT = 0;			! Character was not repeated
  9968					 yet
  9969					;   5425  3							! Will always be incremented
  9970
  9971					;   5426  2		END;
  9972					;   5427  2	
  9973					;   5428  2	!
  9974					;   5429  2	! Otherwise, loop until we fill buffer
  9975					;   5430  2	!
  9976					;   5431  2	
  9977					;   5432  2	    WHILE .SIZE LSS .MAX%SIZE DO 		! Normal exit is via an EXIT
  9978					LOOP
  9979					;   5433  3		BEGIN
  9980					;   5434  3	!
  9981					;   5435  3	! Check if we are doing run compression
  9982					;   5436  3	!
  9983					;   5437  3	
  9984					;   5438  3		IF .FLAG%REPEAT
  9985					;   5439  3		THEN
  9986					;   5440  4		    BEGIN
  9987					;   5441  4	!
  9988					;   5442  4	! Here with previous character in OLD%xxx.  As long as we
  9989					;   5443  4	! are getting the same character, just count the run.
  9990					;   5444  4	!
  9991					;   5445  4	
  9992					;   5446  4		    WHILE (.CHAR%8%BIT EQL .OLD%CHAR%8%BIT) AND (.REPEAT%COUNT LSS 9
  9993					4) DO
  9994					;   5447  5			BEGIN
  9995					;   5448  5			REPEAT%COUNT = .REPEAT%COUNT + 1;
  9996					;   5449  5	
  9997					;   5450  5			IF .FLAG%8QUOTE THEN STATUS = GET%8%QUOTED%CHAR () ELSE STAT
  9998					US = GET%QUOTED%CHAR ();
  9999					;   5451  5	
 10000					;   5452  5			IF .STATUS NEQ KER%NORMAL
 10001					;   5453  5			THEN
 10002					;   5454  5	
 10003					;   5455  5			    IF .STATUS NEQ KER%EOF
 10004					;   5456  5			    THEN
 10005					;   5457  5				CHAR%8%BIT = NO%CHAR
 10006					;   5458  5			    ELSE
 10007					;   5459  6				BEGIN
 10008					;   5460  6				CHAR%8%BIT = EOF%CHAR;
 10009					;   5461  6				CHR%IDX = -1;
 10010					;   5462  5				END;
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-182
KERMSG	MAC	18-Jan-73 17:20	

 10011					;   5463  5	
 10012					;   5464  4			END;
 10013					;   5465  4	
 10014					;   5466  5		    IF .OLD%CHR%IDX + 1 + 2 LSS ((.OLD%CHR%IDX + 1)*.REPEAT%COUNT)
 10015					;   5467  4		    THEN
 10016					;   5468  5			BEGIN
 10017					;   5469  5	
 10018					;   5470  5			IF .SIZE + .OLD%CHR%IDX + 1 + 2 GTR .MAX%SIZE
 10019					;   5471  5			THEN
 10020					;   5472  6			    BEGIN
 10021					;   5473  6	
 10022					;   5474  6			    IF .CHAR%8%BIT EQL .OLD%CHAR%8%BIT
 10023					;   5475  6			    THEN
 10024					;   5476  7				BEGIN
 10025					;   5477  7				NEXT%CHR = .CHAR%8%BIT;
 10026					;   5478  7				REPEAT%COUNT = .REPEAT%COUNT - 1;
 10027					;   5479  6				END;
 10028					;   5480  6	
 10029					;   5481  6			    IF .CHAR%8%BIT EQL EOF%CHAR
 10030					;   5482  6			    THEN
 10031					;   5483  7				BEGIN
 10032					;   5484  7				NEXT%CHR = EOF%CHAR;	! Remember EOF for next time
 10033
 10034					;   5485  7				STATUS = KER%NORMAL;	! And give good return now
 10035					;   5486  6				END;
 10036					;   5487  6	
 10037					;   5488  6			    EXITLOOP;
 10038					;   5489  5			    END;
 10039					;   5490  5	
 10040					;   5491  5			OLD%CHRS [.OLD%CHR%IDX + 1] = CHAR (.REPEAT%COUNT);
 10041					;   5492  5			OLD%CHRS [.OLD%CHR%IDX + 2] = .REPT%CHR;
 10042					;   5493  5			OLD%CHR%IDX = .OLD%CHR%IDX + 2;
 10043					;   5494  5	!
 10044					;   5495  5	! Count the number of file characters this represents
 10045					;   5496  5	!
 10046					;   5497  5			SMSG%DATA%CHARS = .SMSG%DATA%CHARS + .REPEAT%COUNT - 1;
 10047					;   5498  5			FILE%CHARS = .FILE%CHARS + .REPEAT%COUNT - 1;
 10048					;   5499  5			REPEAT%COUNT = 1;		! Only one time for this str
 10049					ing
 10050					;   5500  4			END;
 10051					;   5501  4	
 10052					;   5502  4	!
 10053					;   5503  4	! If we don't have enough room for this character, wait till next
 10054					;   5504  4	! time.
 10055					;   5505  4	!
 10056					;   5506  4	
 10057					;   5507  4		    IF .SIZE + (.OLD%CHR%IDX + 1)*.REPEAT%COUNT GTR .MAX%SIZE
 10058					;   5508  4		    THEN
 10059					;   5509  5			BEGIN
 10060					;   5510  5	! If the next character is the same, the count will get incremented
 10061					;   5511  5	! next time we enter, so back it off now.
 10062					;   5512  5	
 10063					;   5513  5			IF .CHAR%8%BIT EQL .OLD%CHAR%8%BIT
 10064					;   5514  5			THEN
 10065					;   5515  6			    BEGIN
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-183
KERMSG	MAC	18-Jan-73 17:20	

 10066					;   5516  6			    NEXT%CHR = .CHAR%8%BIT;
 10067					;   5517  6			    REPEAT%COUNT = .REPEAT%COUNT - 1;
 10068					;   5518  5			    END;
 10069					;   5519  5	
 10070					;   5520  5			EXITLOOP;
 10071					;   5521  4			END;
 10072					;   5522  4	
 10073					;   5523  4		    SMSG%DATA%CHARS = .SMSG%DATA%CHARS + .REPEAT%COUNT;
 10074					;   5524  4		    FILE%CHARS = .FILE%CHARS + .REPEAT%COUNT;
 10075					;   5525  4	
 10076					;   5526  4		    DECR REPEAT%COUNT FROM .REPEAT%COUNT TO 1 DO
 10077					;   5527  4	
 10078					;   5528  4			DECR I FROM .OLD%CHR%IDX TO 0 DO
 10079					;   5529  5			    BEGIN
 10080					;   5530  5			    CH$WCHAR%A (.OLD%CHRS [.I], POINTER);
 10081					;   5531  5			    SIZE = .SIZE + 1;
 10082					;   5532  4			    END;
 10083					;   5533  4	
 10084					;   5534  4	!
 10085					;   5535  4	! If we got an error (or EOF) then exit
 10086					;   5536  4	!
 10087					;   5537  4	
 10088					;   5538  4		    IF (.STATUS NEQ KER%NORMAL) THEN EXITLOOP;
 10089					;   5539  4	
 10090					;   5540  4	!
 10091					;   5541  4	! Otherwise, copy the character which broke the run
 10092					;   5542  4	!
 10093					;   5543  4		    OLD%CHAR%8%BIT = .CHAR%8%BIT;
 10094					;   5544  4	
 10095					;   5545  4		    INCR OLD%CHR%IDX FROM 0 TO .CHR%IDX DO
 10096					;   5546  4			OLD%CHRS [.OLD%CHR%IDX] = .CHRS [.OLD%CHR%IDX];
 10097					;   5547  4	
 10098					;   5548  4		    OLD%CHR%IDX = .CHR%IDX;
 10099					;   5549  4		    REPEAT%COUNT = 0;
 10100					;   5550  4		    END
 10101					;   5551  3		ELSE
 10102					;   5552  3	!
 10103					;   5553  3	! Here if we are not doing run compression.  We can do things much
 10104					;   5554  3	! easier.
 10105					;   5555  3	!
 10106					;   5556  4		    BEGIN
 10107					;   5557  4	
 10108					;   5558  4		    IF (.SIZE + .CHR%IDX + 1) GTR .MAX%SIZE THEN EXITLOOP;
 10109					;   5559  4	
 10110					;   5560  4		    SMSG%DATA%CHARS = .SMSG%DATA%CHARS + 1;
 10111					;   5561  4		    FILE%CHARS = .FILE%CHARS + 1;
 10112					;   5562  4	
 10113					;   5563  4		    DECR CHR%IDX FROM .CHR%IDX TO 0 DO
 10114					;   5564  5			BEGIN
 10115					;   5565  5			CH$WCHAR%A (.CHRS [.CHR%IDX], POINTER);
 10116					;   5566  5			SIZE = .SIZE + 1;
 10117					;   5567  4			END;
 10118					;   5568  4	
 10119					;   5569  4		    IF .FLAG%8QUOTE THEN STATUS = GET%8%QUOTED%CHAR () ELSE STATUS =
 10120					 GET%QUOTED%CHAR ();
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-184
KERMSG	MAC	18-Jan-73 17:20	

 10121					;   5570  4	
 10122					;   5571  4		    IF (.STATUS NEQ KER%NORMAL) THEN EXITLOOP;
 10123					;   5572  4	
 10124					;   5573  3		    END;
 10125					;   5574  3	
 10126					;   5575  2		END;
 10127					;   5576  2	
 10128					;   5577  2	!
 10129					;   5578  2	! Determine if we really stored anything into the buffer.
 10130					;   5579  2	!
 10131					;   5580  2	
 10132					;   5581  2	    IF .SIZE NEQ 0 THEN RETURN KER%NORMAL ELSE RETURN .STATUS;
 10133					;   5582  2	
 10134					;   5583  1	    END;					! End of BFR%FILL
 10135
 10136
 10137					; BFR% GET%QUOTED%CHAR ();
  9999					;   5451  5	
 10000					;   5452  5			IF .STATUS NEQ KER%NORMAL
 10001					;   5453  5			THEN
 10002					;   5454  5	
 10003					;   5455  5			    IF .STATUS NEQ KER%EOF
 10004					;   5456  5			    THEN
 10005					;   5457  5				CHAR%8%BIT = NO%CHAR
 10006					;   5458  5			    ELSE
 10007					;   5459  6				BEGIN
 10008					;   5460  6				CHAR%8%BIT = EOF%CHAR;
 10009					;   5461  6				CHR%IDX = -1;
 10010					;   5462  5				END;
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-182
KERMSG	MAC	18-Jan-73 17:20	

 10011					;   5463  5	
 10012					;   5464  4			END;
 10013					;   5465  4	
 10014					;   5466  5		    IF .OLD%CHR%IDX + 1 + 2 LSS ((.OLD%CHR%IDX + 1)*.REPEAT%COUNT)
 10015					;   5467  4		    THEN
 10016					;   5468  5			BEGIN
 10017					;   5469  5	
 10018					;   5470  5			IF .SIZE + .OLD%CHR%IDX + 1 + 2 GTR .MAX%SIZE
 10019					;   5471  5			THEN
 10020					;   5472  6			    BEGIN
 10021					;   5473  6	
 10022					;   5474  6			    IF .CHAR%8%BIT EQL .OLD%CHAR%8%BIT
 10023					;   5475  6			    THEN
 10024					;   5476  7				BEGIN
 10025					;   5477  7				NEXT%CHR = .CHAR%8%BIT;
 10026					;   5478  7				REPEAT%COUNT = .REPEAT%COUNT - 1;
 10027					;   5479  6				END;
 10028					;   5480  6	
 10029					;   5481  6			    IF .CHAR%8%BIT EQL EOF%CHAR
 10030					;   5482  6			    THEN
 10031					;   5483  7				BEGIN
 10032					;   5484  7				NEXT%CHR = EOF%CHAR;	! Remember EOF for next time
 10033
 10034					;   5485  7				STATUS = KER%NORMAL;	! And give good return now
 10035					;   5486  6				END;
 10036					;   5487  6	
 10037					;   5488  6			    EXITLOOP;
 10038					;   5489  5			    END;
 10039					;   5490  5	
 10040					;   5491  5			OLD%CHRS [.OLD%CHR%IDX + 1] = CHAR (.REPEAT%COUNT);
 10041					;   5492  5			OLD%CHRS [.OLD%CHR%IDX + 2] = .REPT%CHR;
 10042					;   5493  5			OLD%CHR%IDX = .OLD%CHR%IDX + 2;
 10043					;   5494  5	!
 10044					;   5495  5	! Count the number of file characters this represents
 10045					;   5496  5	!
 10046					;   5497  5			SMSG%DATA%CHARS = .SMSG%DATA%CHARS + .REPEAT%COUNT - 1;
 10047					;   5498  5			FILE%CHARS = .FILE%CHARS + .REPEAT%COUNT - 1;
 10048					;   5499  5			REPEAT%COUNT = 1;		! Only one time for this str
 10049					ing
 10050					;   5500  4			END;
 10051					;   5501  4	
 10052					;   5502  4	!
 10053					;   5503  4	! If we don't have enough room for this character, wait till next
 10054					;   5504  4	! time.
 10055					;   5505  4	!
 10056					;MOVEM	AC1,U.87			; AC1,OLD%CHAR%8%BIT
 10138						SETO	AC1,				; OLD%CHR%IDX,				
 10139	405577'	474 01 0 00 000000 						5420
 10140	405600'	254 00 0 00 405603'		JRST	L.379				; L.379
 10141					L.378:	MOVE	AC2,U.85(AC1)			; AC2,CHRS(OLD%CHR%IDX)			
 10142	405601'	200 02 0 01 000121'						5421
 10143	405602'	202 02 0 01 000130'		MOVEM	AC2,U.88(AC1)			; AC2,OLD%CHRS(OLD%CHR%IDX)
 10144					L.379:	ADDI	AC1,1				; OLD%CHR%IDX,1				
 10145	405603'	271 01 0 00 000001 						5420
 10146	405604'	317 01 0 00 000126'		CAMG	AC1,U.86			; OLD%CHR%IDX,CHR%IDX
 10147	405605'	254 00 0 00 405601'		JRST	L.378				; L.378
 10148					L.380:	MOVE	AC1,U.86			; AC1,CHR%IDX				
 10149	405606'	200 01 0 00 000126'						5423
 10150	405607'	202 01 0 00 000135'		MOVEM	AC1,U.89			; AC1,OLD%CHR%IDX
 10151						SETZM	U.83				; REPEAT%COUNT				
 10152	405610'	402 00 0 00 000117'						5424
 10153					L.381:	CAMG	AC16,U.50			; MAX%SIZE,SIZE				
 10154	405611'	317 16 0 00 000015'						5432
 10155	405612'	254 00 0 00 406020'		JRST	L.402				; L.402
 10156						MOVEI	AC1,1				; AC1,1					
 10157	405613'	201 01 0 00 000001 						5438
 10158	405614'	616 01 0 00 000013'		TDNN	AC1,U.48			; AC1,FLAG%REPEAT
 10159	405615'	254 00 0 00 405771'		JRST	L.397				; L.397
 10160					L.382:	MOVE	AC1,U.84			; AC1,CHAR%8%BIT			
 10161	405616'	200 01 0 00 000120'						5446
 10162	405617'	312 01 0 00 000127'		CAME	AC1,U.87			; AC1,OLD%CHAR%8%BIT
 10163	405620'	254 00 0 00 405646'		JRST	L.386				; L.386
 10164	405621'	201 01 0 00 000136 		MOVEI	AC1,136				; AC1,136
 10165	405622'	317 01 0 00 000117'		CAMG	AC1,U.83			; AC1,REPEAT%COUNT
 10166	405623'	254 00 0 00 405646'		JRST	L.386				; L.386
 10167						AOS	U.83				; REPEAT%COUNT				
 10168	405624'	350 00 0 00 000117'						5448
 10169						MOVEI	AC1,1				; AC1,1					
 10170	405625'	201 01 0 00 000001 						5450
 10171	405626'	616 01 0 00 000012'		TDNN	AC1,U.47			; AC1,FLAG%8QUOTE
 10172	405627'	254 00 0 00 405632'		JRST	L.383				; L.383
 10173	405630'	260 17 0 00 405521'		PUSHJ	SP,U.91				; SP,GET%8%QUOTED%CHAR
 10174	405631'	254 00 0 00 405633'		JRST	L.384				; L.384
 10175	405632'	260 17 0 00 405426'	L.383:	PUSHJ	SP,U.90				; SP,GET%QUOTED%CHAR
 10176	405633'	202 01 0 00 000116'	L.384:	MOVEM	AC1,U.82			; AC1,STATUS
 10177						CAIN	AC1,13				; AC1,13				
 10178	405634'	306 01 0 00 000013 						5452
 10179	405635'	254 00 0 00 405616'		JRST	L.382				; L.382
 10180						CAIN	AC1,113				; AC1,113				
 10181	405636'	306 01 0 00 000113 						5455
 10182	405637'	254 00 0 00 405642'		JRST	L.385				; L.385
 10183						SETOM	U.84				; CHAR%8%BIT				
 10184	405640'	476 00 0 00 000120'						5457
 10185						JRST	L.382				; L.382					
 10186	405641'	254 00 0 00 405616'						5455
 10187					L.385:	HRROI	AC1,-2				; AC1,-2				
 10188	405642'	561 01 0 00 777776 						5460
 10189	405643'	202 01 0 00 000120'		MOVEM	AC1,U.84			; AC1,CHAR%8%BIT
 10190						SETOM	U.86				; CHR%IDX				
 10191	405644'	476 00 0 00 000126'						5461
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-186
KERMSG	MAC	18-Jan-73 17:20	

 10192						JRST	L.382				; L.382					
 10193	405645'	254 00 0 00 405616'						5452
 10194					L.386:	MOVE	AC2,U.89			; AC2,OLD%CHR%IDX			
 10195	405646'	200 02 0 00 000135'						5466
 10196	405647'	200 04 0 00 000002 		MOVE	AC4,AC2				; AC4,AC2
 10197	405650'	271 04 0 00 000003 		ADDI	AC4,3				; AC4,3
 10198	405651'	200 01 0 00 000002 		MOVE	AC1,AC2				; AC1,AC2
 10199	405652'	350 03 0 00 000001 		AOS	AC3,AC1				; AC3,AC1
 10200	405653'	220 03 0 00 000117'		IMUL	AC3,U.83			; AC3,REPEAT%COUNT
 10201	405654'	311 04 0 00 000003 		CAML	AC4,AC3				; AC4,AC3
 10202	405655'	254 00 0 00 405722'		JRST	L.389				; L.389
 10203						MOVE	AC3,U.50			; AC3,SIZE				
 10204	405656'	200 03 0 00 000015'						5470
 10205	405657'	270 03 0 00 000002 		ADD	AC3,AC2				; AC3,AC2
 10206	405660'	271 03 0 00 000003 		ADDI	AC3,3				; AC3,3
 10207	405661'	317 03 0 00 000016 		CAMG	AC3,AC16			; AC3,MAX%SIZE
 10208	405662'	254 00 0 00 405701'		JRST	L.388				; L.388
 10209						MOVE	AC3,U.84			; AC3,CHAR%8%BIT			
 10210	405663'	200 03 0 00 000120'						5474
 10211	405664'	312 03 0 00 000127'		CAME	AC3,U.87			; AC3,OLD%CHAR%8%BIT
 10212	405665'	254 00 0 00 405671'		JRST	L.387				; L.387
 10213						MOVE	AC3,U.84			; AC3,CHAR%8%BIT			
 10214	405666'	200 03 0 00 000120'						5477
 10215	405667'	202 03 0 00 000115'		MOVEM	AC3,U.81			; AC3,NEXT%CHR
 10216						SOS	U.83				; REPEAT%COUNT				
 10217	405670'	370 00 0 00 000117'						5478
 10218					L.387:	HRROI	AC3,-2				; AC3,-2				
 10219	405671'	561 03 0 00 777776 						5481
 10220	405672'	312 03 0 00 000120'		CAME	AC3,U.84			; AC3,CHAR%8%BIT
 10221	405673'	254 00 0 00 406020'		JRST	L.402				; L.402
 10222						HRROI	AC3,-2				; AC3,-2				
 10223	405674'	561 03 0 00 777776 						5484
 10224	405675'	202 03 0 00 000115'		MOVEM	AC3,U.81			; AC3,NEXT%CHR
 10225						MOVEI	AC3,13				; AC3,13				
 10226	405676'	201 03 0 00 000013 						5485
 10227	405677'	202 03 0 00 000116'		MOVEM	AC3,U.82			; AC3,STATUS
 10228						JRST	L.402				; L.402					
 10229	405700'	254 00 0 00 406020'						5481
 10230					L.388:	MOVE	AC3,U.83			; AC3,REPEAT%COUNT			
 10231	405701'	200 03 0 00 000117'						5491
 10232	405702'	271 03 0 00 000040 		ADDI	AC3,40				; AC3,40
 10233	405703'	202 03 0 01 000130'		MOVEM	AC3,U.88(AC1)			; AC3,OLD%CHRS(AC1)
 10234						MOVE	AC1,U.38			; AC1,REPT%CHR				
 10235	405704'	200 01 0 00 000001'						5492
 10236	405705'	202 01 0 02 000132'		MOVEM	AC1,U.88+2(AC2)			; AC1,OLD%CHRS+2(AC2)
 10237						MOVEI	AC1,2				; AC1,2					
 10238	405706'	201 01 0 00 000002 						5493
 10239	405707'	272 01 0 00 000135'		ADDM	AC1,U.89			; AC1,OLD%CHR%IDX
 10240						MOVE	AC1,SMSG%DATA%CHARS		; AC1,SMSG%DATA%CHARS			
 10241	405710'	200 01 0 00 000000*						5497
 10242	405711'	270 01 0 00 000117'		ADD	AC1,U.83			; AC1,REPEAT%COUNT
 10243	405712'	275 01 0 00 000001 		SUBI	AC1,1				; AC1,1
 10244	405713'	202 01 0 00 405710*		MOVEM	AC1,SMSG%DATA%CHARS		; AC1,SMSG%DATA%CHARS
 10245						MOVE	AC1,U.60			; AC1,FILE%CHARS			
 10246	405714'	200 01 0 00 000105'						5498
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-187
KERMSG	MAC	18-Jan-73 17:20	

 10247	405715'	270 01 0 00 000117'		ADD	AC1,U.83			; AC1,REPEAT%COUNT
 10248	405716'	275 01 0 00 000001 		SUBI	AC1,1				; AC1,1
 10249	405717'	202 01 0 00 000105'		MOVEM	AC1,U.60			; AC1,FILE%CHARS
 10250						MOVEI	AC1,1				; AC1,1					
 10251	405720'	201 01 0 00 000001 						5499
 10252	405721'	202 01 0 00 000117'	determining the next based upon the packet which is received.
  2301					;   1801  1	!	It is supplied with the initial state by the caller.
  2302					;   1802  1	!
  2303					;   1803  1	! CALLING SEQUENCE:
  2304					;   1804  1	!
  2305					;   1805  1	!	Status = DO%TRANSACTION(.INIT%STATE);
  2306					;   1806  1	!
  2307					;   1807  1	! INPUT PARAMETERS:
  2308					;   1808  1	!
  2309					;   1809  1	!	INIT%STATE - Initial state.
  2310					;   1810  1	!
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-42
KERMSG	MAC	18-Jan-73 17:20	

  2311					;   1811  1	! IMPLICIT INPUTS:
  2312					;   1812  1	!
  2313					;   1813  1	!	None.
  2314					;   1814  1	!
  2315					;   1815  1	! OUTPUT PARAMETERS:
  2316					;   1816  1	!
  2317					;   1817  1	!	None.
  2318					;   1818  1	!
  2319					;   1819  1	! IMPLICIT OUTPUTS:
  2320					;   1820  1	!
  2321					;   1821  1	!	None.
  2322					;   1822  1	!
  2323					;   1823  1	! COMPLETION CODES:
  2324					;   1824  1	!
  2325					;   1825  1	!	None.
  2326					;   1826  1	!
  2327					;   1827  1	! SIDE EFFECTS:
  2328					;   1828  1	!
  2329					;   1829  1	!	None.
  2330					;   1830  1	!
  2331					;   1831  1	!--
  2332					;   1832  1	
  2333					;   1833  2	    BEGIN
  2334					;   1834  2	
  2335					;   1835  2	    LOCAL
  2336					;   1836  2		RETURN%VALUE;
  2337					;   1837  2	
  2338					;   1838  2	    NUM%RETRIES = 0;				! Initialize the number of r
  2339					etries
  2340					;   1839  2	    STATE = .INIT%STATE;			! Initialize the state
  2341					;   1840  2	
  2342					;   1841  2	    WHILE TRUE DO
  2343					;   1842  2	
  2344					;   1843  2		CASE .STATE FROM STATE%MIN TO STATE%MAX OF
  2345					;   1844  2		    SET
  2346					;   1845  2	!
  2347					;   1846  2	! Send states
  2348					;   1847  2	!
  2349					;   1848  2	
  2350					;   1849  2		    [STATE%ID] :
  2351					;   1850  2	!
  2352					;   1851  2	! Server while idle.  Set the timeout to twice the normal wait
  2353					;   1852  2	! and wait for something to show up
  2354					;   1853  2	!
  2355					;   1854  3			BEGIN
  2356					;   1855  3	
  2357					;   1856  3			LOCAL
  2358					;   1857  3			    SAVED%TIMEOUT;
  2359					;   1858  3	
  2360					;   1859  3			SAVED%TIMEOUT = .SEND%TIMEOUT;
  2361					;   1860  3	
  2362					;   1861  3			IF .SEND%TIMEOUT NEQ 0 THEN SEND%TIMEOUT = .SRV%TIMEOUT;
  2363					;   1862  3	
  2364					;   1863  3			STATE = REC%SERVER%IDLE ();
  2365					;   1864  3			SEN0 00 405745'						5526
 10253						MOVEI	AC1,13				; AC1,13				
 10254	405754'	201 01 0 00 000013 						5538
 10255	405755'	312 01 0 00 000116'		CAME	AC1,U.82			; AC1,STATUS
 10256	405756'	254 00 0 00 406020'		JRST	L.402				; L.402
 10257						MOVE	AC1,U.84			; AC1,CHAR%8%BIT			
 10258	405757'	200 01 0 00 000120'						5543
 10259	405760'	202 01 0 00 000127'		MOVEM	AC1,U.87			; AC1,OLD%CHAR%8%BIT
 10260						SETO	AC1,				; OLD%CHR%IDX,				
 10261	405761'	474 01 0 00 000000 						5545
 10262	405762'	254 00 0 00 405765'		JRST	L.396				; L.396
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-188
KERMSG	MAC	18-Jan-73 17:20	

 10263					L.395:	MOVE	AC2,U.85(AC1)			; AC2,CHRS(OLD%CHR%IDX)			
 10264	405763'	200 02 0 01 000121'						5546
 10265	405764'	202 02 0 01 000130'		MOVEM	AC2,U.88(AC1)			; AC2,OLD%CHRS(OLD%CHR%IDX)
 10266					L.396:	ADDI	AC1,1				; OLD%CHR%IDX,1				
 10267	405765'	271 01 0 00 000001 						5545
 10268	405766'	317 01 0 00 000126'		CAMG	AC1,U.86			; OLD%CHR%IDX,CHR%IDX
 10269	405767'	254 00 0 00 405763'		JRST	L.395				; L.395
 10270	405770'	254 00 0 00 405606'		JRST	L.380				; L.380
 10271					L.397:	MOVE	AC1,U.50			; AC1,SIZE				
 10272	405771'	200 01 0 00 000015'						5558
 10273	405772'	270 01 0 00 000126'		ADD	AC1,U.86			; AC1,CHR%IDX
 10274	405773'	271 01 0 00 000001 		ADDI	AC1,1				; AC1,1
 10275	405774'	313 01 0 00 000016 		CAMLE	AC1,AC16			; AC1,MAX%SIZE
 10276	405775'	254 00 0 00 406020'		JRST	L.402				; L.402
 10277						AOS	SMSG%DATA%CHARS			; SMSG%DATA%CHARS			
 10278	405776'	350 00 0 00 405740*						5560
 10279						AOS	U.60				; FILE%CHARS				
 10280	405777'	350 00 0 00 000105'						5561
 10281						MOVE	AC1,U.86			; CHR%IDX,CHR%IDX			
 10282	406000'	200 01 0 00 000126'						5563
 10283	406001'	344 01 0 00 406005'		AOJA	AC1,L.399			; CHR%IDX,L.399
 10284					L.398:	MOVE	AC2,U.85(AC1)			; AC2,CHRS(CHR%IDX)			
 10285	406002'	200 02 0 01 000121'						5565
 10286	406003'	136 02 0 00 000014 		IDPB	AC2,AC14			; AC2,POINTER
 10287						AOS	U.50				; SIZE					
 10288	406004'	350 00 0 00 000015'						5566
 10289					L.399:	SOJGE	AC1,L.398			; CHR%IDX,L.398				
 10290	406005'	365 01 0 00 406002'						5563
 10291						MOVEI	AC1,1				; AC1,1					
 10292	406006'	201 01 0 00 000001 						5569
 10293	406007'	616 01 0 00 000012'		TDNN	AC1,U.47			; AC1,FLAG%8QUOTE
 10294	406010'	254 00 0 00 406013'		JRST	L.400				; L.400
 10295	406011'	260 17 0 00 405521'		PUSHJ	SP,U.91				; SP,GET%8%QUOTED%CHAR
 10296	406012'	254 00 0 00 406014'		JRST	L.401				; L.401
 10297	406013'	260 17 0 00 405426'	L.400:	PUSHJ	SP,U.90				; SP,GET%QUOTED%CHAR
 10298	406014'	202 01 0 00 000116'	L.401:	MOVEM	AC1,U.82			; AC1,STATUS
 10299						MOVEI	AC1,13				; AC1,13				
 10300	406015'	201 01 0 00 000013 						5571
 10301	406016'	316 01 0 00 000116'		CAMN	AC1,U.82			; AC1,STATUS
 10302						JRST	L.381				; L.381					
 10303	406017'	254 00 0 00 405611'						5432
 10304					L.402:	SKIPN	U.50				; SIZE					
 10305	406020'	336 00 0 00 000015'						5581
 10306	406021'	254 00 0 00 406024'		JRST	L.403				; L.403
 10307	406022'	201 01 0 00 000013 		MOVEI	AC1,13				; AC1,13
 10308	406023'	254 00 0 00 406025'		JRST	L.404				; L.404
 10309	406024'	200 01 0 00 000116'	L.403:	MOVE	AC1,U.82			; AC1,STATUS
 10310					L.404:	POP	SP,AC16				; SP,AC16				
 10311	406025'	262 17 0 00 000016 						5232
 10312	406026'	262 17 0 00 000014 		POP	SP,AC14				; SP,AC14
 10313	406027'	263 17 0 00 000000 		POPJ	SP,				; SP,
 10314
 10315					; Routine Size:  181 words
 10316
 10317
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-189
KERMSG	MAC	18-Jan-73 17:20	

 10318					;   5584  1	%SBTTL 'BFR%EMPTY'
 10319					;   5585  1	ROUTINE BFR%EMPTY =
 10320					;   5586  1	
 10321					;   5587  1	!++
 10322					;   5588  1	! FUNCTIONAL DESCRIPTION:
 10323					;   5589  1	!
 10324					;   5590  1	!	This routine will empty the data from the REC%MSG message buffer
 10325					;   5591  1	!	to the file.  It will process quoting characters.
 10326					;   5592  1	!
 10327					;   5593  1	! CALLING SEQUENCE:
 10328					;   5594  1	!
 10329					;   5595  1	!	Flag = BFR%EMPTY();
 10330					;   5596  1	!
 10331					;   5597  1	! INPUT PARAMETERS:
 10332					;   5598  1	!
 10333					;   5599  1	!	None.
 10334					;   5600  1	!
 10335					;   5601  1	! IMPLICIT INPUTS:
 10336					;   5602  1	!
 10337					;   5603  1	!	None.
 10338					;   5604  1	!
 10339					;   5605  1	! OUTPUT PARAMETERS:
 10340					;   5606  1	!
 10341					;   5607  1	!	True - No problems writing the file.
 10342					;   5608  1	!	False - I/O error writing the file.
 10343					;   5609  1	!
 10344					;   5610  1	! IMPLICIT OUTPUTS:
 10345					;   5611  1	!
 10346					;   5612  1	!	None.
 10347					;   5613  1	!
 10348					;   5614  1	! COMPLETION CODES:
 10349					;   5615  1	!
 10350					;   5616  1	!	None.
 10351					;   5617  1	!
 10352					;   5618  1	! SIDE EFFECTS:
 10353					;   5619  1	!
 10354					;   5620  1	!	None.
 10355					;   5621  1	!
 10356					;   5622  1	!--
 10357					;   5623  1	
 10358					;   5624  2	    BEGIN
 10359					;   5625  2	
 10360					;   5626  2	    LOCAL
 10361					;   5627  2		STATUS,					! Status returned by various
 10362					 routines
 10363					;   5628  2		REPEAT%COUNT,				! Count of times to repeat c
 10364					haracter
 10365					;   5629  2		TURN%BIT%8%ON,				! If eight bit quoting
 10366					;   5630  2		COUNTER,				! Count of the characters le
 10367					ft
 10368					;   5631  2		CHARACTER,				! Character we are processin
 10369					g
 10370					;   5632  2		POINTER;				! Pointer to the data
 10371					;   5633  2	
 10372					;   5634  2	    POINTER = CH$PTR (REC%MSG, PKT%MSG, CHR%SIZE);
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-190
KERMSG	MAC	18-Jan-73 17:20	

 10373					;   5635  2	    COUNTER = 0;
 10374					;   5636  2	
 10375					;   5637  2	    WHILE (.COUNTER LSS .REC%LENGTH) DO
 10376					;   5638  3		BEGIN
 10377					;   5639  3		CHARACTER = CH$RCHAR%A (POINTER);
 10378					;   5640  3		COUNTER = .COUNTER + 1;
 10379					;   5641  3	!
 10380					;   5642  3	! If the character is the repeat character (and we are doing repeat
 10381					;   5643  3	! compression), then get the count.
 10382					;   5644  3	!
 10383					;   5645  3	
 10384					;   5646  4		IF ((.CHARACTER EQL .REPT%CHR) AND .FLAG%REPEAT)
 10385					;   5647  3		THEN
 10386					;   5648  4		    BEGIN
 10387					;   5649  4		    REPEAT%COUNT = UNCHAR (CH$RCHAR%A (POINTER) AND %O'177');
 10388					;   5650  4		    CHARACTER = CH$RCHAR%A (POINTER);
 10389					;   5651  4		    COUNTER = .COUNTER + 2;
 10390					;   5652  4		    END
 10391					;   5653  3		ELSE
 10392					;   5654  3		    REPEAT%COUNT = 1;
 10393					;   5655  3	
 10394					;   5656  3	!
 10395					;   5657  3	! If the character is an eight bit quoting character and we are doing eight
 10396					;   5658  3	! bit quoting then turn on the flag so we turn the eighth bit on when we
 10397					;   5659  3	! get the real character.
 10398					;   5660  3	!
 10399					;   5661  3	
 10400					;   5662  4		IF ((.CHARACTER EQL .SEND%8QUOTE%CHR) AND .FLAG%8QUOTE)
 10401					;   5663  3		THEN
 10402					;   5664  4		    BEGIN
 10403					;   5665  4		    TURN%BIT%8%ON = TRUE;
 10404					;   5666  4		    COUNTER = .COUNTER + 1;
 10405					;   5667  4		    CHARACTER = CH$RCHAR%A (POINTER);
 10406					;   5668  4		    END
 10407					;   5669  3		ELSE
 10408					;   5670  3		    TURN%BIT%8%ON = FALSE;
 10409					;   5671  3	
 10410					;   5672  3	!
 10411					;   5673  3	! Now determine if we are quoting the character.  If so then we must eat
 10412					;   5674  3	! the quoting character and get the real character.
 10413					;   5675  3	!
 10414					;   5676  3	
 10415					;   5677  3		IF .CHARACTER EQL .SEND%QUOTE%CHR
 10416					;   5678  3						![035] Is this character other Kermi
 10417					t sends as quote?
 10418					;   5679  3		THEN
 10419					;   5680  4		    BEGIN
 10420					;   5681  4		    CHARACTER = CH$RCHAR%A (POINTER);
 10421					;   5682  4		    COUNTER = .COUNTER + 1;
 10422					;   5683  4	!
 10423					;   5684  4	! Determine if we must undo what someone else has done to the character
 10424					;   5685  4	!
 10425					;   5686  4	
 10426					; P 5687  5		    IF ((.CHARACTER AND %O'177') GEQ CTL (CHR%DEL)) AND ((.CHARACTER
 10427					 AND %O'177') LEQ CTL (
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-191
KERMSG	MAC	18-Jan-73 17:20	

 10428					;   5688  5			    CHR%DEL) + %O'40')
 10429					;   5689  4		    THEN
 10430					;   5690  4			CHARACTER = CTL (.CHARACTER);
 10431					;   5691  4	
 10432					;   5692  3		    END;
 10433					;   5693  3	
 10434					;   5694  3	!
 10435					;   5695  3	! Turn on the eight bit if needed and then write the character out
 10436					;   5696  3	!
 10437					;   5697  3	
 10438					;   5698  3		IF .TURN%BIT%8%ON THEN CHARACTER = .CHARACTER OR %O'200';
 10439					;   5699  3	
 10440					;   5700  3		RMSG%DATA%CHARS = .RMSG%DATA%CHARS + .REPEAT%COUNT;
 10441					;   5701  3		FILE%CHARS = .FILE%CHARS + .REPEAT%COUNT;
 10442					;   5702  3	
 10443					;   5703  3		DECR REPEAT%COUNT FROM .REPEAT%COUNT TO 1 DO
 10444					;   5704  4		    BEGIN
 10445					;   5705  4		    STATUS = (.PUT%CHR%ROUTINE) (.CHARACTER);
 10446					;   5706  4	
 10447					;   5707  4		    IF NOT .STATUS THEN RETURN .STATUS;
 10448					;   5708  4	
 10449					;   5709  3		    END;
 10450					;   5710  3	
 10451					;   5711  2		END;
 10452					;   5712  2	
 10453					;   5713  2	    RETURN KER%NORMAL;
 10454					;   5714  1	    END;					! End of BFR%EMPTY
 10455
 10456
 10457					; BFR%EMPTY
 10458					U.28:	PUSH	SP,AC10				; SP,AC10				
 10459	406030'	261 17 0 00 000010 						5585
 10460	406031'	261 17 0 00 000011 		PUSH	SP,AC11				; SP,AC11
 10461	406032'	261 17 0 00 000012 		PUSH	SP,AC12				; SP,AC12
 10462	406033'	261 17 0 00 000013 		PUSH	SP,AC13				; SP,AC13
 10463	406034'	261 17 0 00 000014 		PUSH	SP,AC14				; SP,AC14
 10464	406035'	261 17 0 00 000016 		PUSH	SP,AC16				; SP,AC16
 10465						MOVE	AC11,C.29			; POINTER,[POINT 8,REC%MSG,31]  <4,8>	
 10466	406036'	200 11 0 00 401341'						5634
 10467						SETZ	AC12,				; COUNTER,				
 10468	406037'	400 12 0 00 000000 						5635
 10469					L.405:	CAML	AC12,U.55			; COUNTER,REC%LENGTH			
 10470	406040'	311 12 0 00 000022'						5637
 10471	406041'	254 00 0 00 406123'		JRST	L.414				; L.414
 10472						ILDB	AC13,AC11			; CHARACTER,POINTER			
 10473	406042'	134 13 0 00 000011 						5639
 10474						ADDI	AC12,1				; COUNTER,1				
 10475	406043'	271 12 0 00 000001 						5640
 10476						CAME	AC13,U.38			; CHARACTER,REPT%CHR			
 10477	406044'	312 13 0 00 000001'						5646
 10478	406045'	254 00 0 00 406057'		JRST	L.406				; L.406
 10479	406046'	201 02 0 00 000001 		MOVEI	AC2,1				; AC2,1
 10480	406047'	616 02 0 00 000013'		TDNN	AC2,U.48			; AC2,FLAG%REPEAT
 10481	406050'	254 00 0 00 406057'		JRST	L.406				; L.406
 10482						ILDB	AC2,AC11			; AC2,POINTER				
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-192
KERMSG	MAC	18-Jan-73 17:20	

 10483	406051'	134 02 0 00 000011 						5649
 10484	406052'	135 14 0 00 405517'		LDB	AC14,C.98			; REPEAT%COUNT,[POINT 7,AC2,35]  <0,7>
 10485	406053'	275 14 0 00 000040 		SUBI	AC14,40				; REPEAT%COUNT,40
 10486						ILDB	AC13,AC11			; CHARACTER,POINTER			
 10487	406054'	134 13 0 00 000011 						5650
 10488						ADDI	AC12,2				; COUNTER,2				
 10489	406055'	271 12 0 00 000002 						5651
 10490						JRST	L.407				; L.407					
 10491	406056'	254 00 0 00 406060'						5646
 10492					L.406:	MOVEI	AC14,1				; REPEAT%COUNT,1			
 10493	406057'	201 14 0 00 000001 						5654
 10494					L.407:	CAME	AC13,U.44			; CHARACTER,SEND%8QUOTE%CHR		
 10495	406060'	312 13 0 00 000007'						5662
 10496	406061'	254 00 0 00 406071'		JRST	L.408				; L.408
 10497	406062'	201 02 0 00 000001 		MOVEI	AC2,1				; AC2,1
 10498	406063'	616 02 0 00 0
  2531	400461'	616 01 0 00 000104'		TDNN	AC1,U.59			; AC1,FILE%OPEN%FLAG
  2532	400462'	254 00 0 00 400522'		JRST	L.36				; L.36
  2533						SETZM	U.59				; FILE%OPEN%FLAG			
  2534	400463'	402 00 0 00 000104'						1948
  2535						MOVEI	AC1,1				; AC1,1					
  2536	400464'	201 01 0 00 000001 						1950
  2537	400465'	612 01 0 00 400174*		TDNE	AC1,CONNECT%FLAG		; AC1,CONNECT%FLAG
  2538	400466'	254 00 0 00 400476'		JRST	L.35				; L.35
  2539	400467'	201 01 0 00 000001 		MOVEI	AC1,1				; AC1,1
  2540	400470'	616 01 0 00 400066*		TDNN	AC1,TY%FIL			; AC1,TY%FIL
  2541	400471'	254 00 0 00 400476'		JRST	L.35				; L.35
  2542						PUSH	SP,C.14				; SP,[0,,P.AAA]				
  2543	400472'	261 17 0 00 400602'						1953
  2544	400473'	260 17 0 00 000000*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
  2545	400474'	105 17 0 00 777777 		ADJSP	SP,-1				; SP,-1
  2546						PUSHJ	SP,TT%CRLF			; SP,TT%CRLF				
  2547	400475'	260 17 0 00 000000*						1954
  2548					L.35:	MOVE	AC3,U.49			; AC3,STATE				
  2549	400476'	200 03 0 00 000014'						1957
  2550	400477'	400 01 0 00 000000 		SETZ	AC1,				; AC1,
  2551	400500'	306 03 0 00 000012 		CAIN	AC3,12				; AC3,12
  2552	400501'	201 01 0 00 000001 		MOVEI	AC1,1				; AC1,1
  2553	400502'	400 02 0 00 000000 		SETZ	AC2,				; AC2,
  2554	400503'	306 03 0 00 000023 		CAIN	AC3,23				; AC3,23
  2555	400504'	201 02 0 00 000001 		MOVEI	AC2,1				; AC2,1
  2556	400505'	434 02 0 00 000001 		IOR	AC2,AC1				; AC2,AC1
  2557						SETZ	AC1,				; AC1,					
  2558	400506'	400 01 0 00 000000 						1958
  2559	400507'	306 03 0 00 000024 		CAIN	AC3,24				; AC3,24
  2560	400510'	201 01 0 00 000001 		MOVEI	AC1,1				; AC1,1
  2561						IOR	AC1,AC2				; AC1,AC2				
  2562	400511'	434 01 0 00 000002 						1957
  2563	400512'	404 01 0 00 400060*		AND	AC1,ABT%FLAG			; AC1,ABT%FLAG
  2564	400513'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
  2565	400514'	260 17 0 00 000000*		PUSHJ	SP,FILE%CLOSE			; SP,FILE%CLOSE
  2566	400515'	105 17 0 00 777777 		ADJSP	SP,-1				; SP,-1
  2567						PUSH	SP,C.15				; SP,[106]				
  2568	400516'	261 17 0 00 400603'						1959
  2569	400517'	261 17 0 00 400604'		PUSH	SP,C.16				; SP,[101]
  2570	400520'	260 17 0 00 400251*		PUSHJ	SP,XFR%STATUS			; SP,XFR%STATUS
  2571	400521'	105 17 0 00 777776 		ADJSP	SP,-2				; SP,-2
  2572					L.36:	MOVEI	AC1,24				; AC1,24				
  2573	400522'	201 01 0 00 000024 						1966
  2574	400523'	312 01 0 00 000014'		CAME	AC1,U.49			; AC1,STATE
  2575	400524'	254 00 0 00 400575'		JRST	L.53				; L.53
  2576	400525'	261 17 0 00 40				; STATUS,1				
 10499	406114'	602 01 0 00 000001 						5707
 10500	406115'	254 00 0 00 406120'		JRST	L.412				; L.412
 10501	406116'	105 17 0 00 777777 		ADJSP	SP,-1				; SP,-1
 10502	406117'	254 00 0 00 406124'		JRST	L.415				; L.415
 10503					L.412:	ADJSP	SP,-1				; SP,-1					
 10504	406120'	105 17 0 00 777777 						5704
 10505					L.413:	SOJG	AC16,L.411			; REPEAT%COUNT,L.411			
 10506	406121'	367 16 0 00 406111'						5703
 10507						JRST	L.405				; L.405					
 10508	406122'	254 00 0 00 406040'						5637
 10509					L.414:	MOVEI	AC1,13				; AC1,13				
 10510	406123'	201 01 0 00 000013 						5624
 10511					L.415:	POP	SP,AC16				; SP,AC16				
 10512	406124'	262 17 0 00 000016 						5585
 10513	406125'	262 17 0 00 000014 		POP	SP,AC14				; SP,AC14
 10514	406126'	262 17 0 00 000013 		POP	SP,AC13				; SP,AC13
 10515	406127'	262 17 0 00 000012 		POP	SP,AC12				; SP,AC12
 10516	406130'	262 17 0 00 000011 		POP	SP,AC11				; SP,AC11
 10517	406131'	262 17 0 00 000010 		POP	SP,AC10				; SP,AC10
 10518	406132'	263 17 0 00 000000 		POPJ	SP,				; SP,
 10519	406133'	00 07 0 00 000013 	C.101:	POINT	7,AC13,35			; 7,CHARACTER,35
 10520
 10521					; Routine Size:  68 words
 10522
 10523
 10524					;   5715  1	%SBTTL 'Buffer filling and emptying subroutines'
 10525					;   5716  1	ROUTINE SET%STRING (POINTER, LENGTH, START) =
 10526					;   5717  1	
 10527					;   5718  1	!++
 10528					;   5719  1	! FUNCTIONAL DESCRIPTION:
 10529					;   5720  1	!
 10530					;   5721  1	!	This routine is used to set up the buffer filling and emptying
 10531					;   5722  1	!	routines to use a string for input (or output) rather than
 10532					;   5723  1	!	the file I/O routines.
 10533					;   5724  1	!
 10534					;   5725  1	! CALLING SEQUENCE:
 10535					;   5726  1	!
 10536					;   5727  1	!	SET%STRING (.POINTER, .LENGTH, .START)
 10537					;   5728  1	!
 10538					;   5729  1	! INPUT PARAMETERS:
 10539					;   5730  1	!
 10540					;   5731  1	!	POINTER - Character pointer to string
 10541					;   5732  1	!
 10542					;   5733  1	!	LENGTH - Number of characters in string
 10543					;   5734  1	!
 10544					;   5735  1	!	START - True to start string, false to end it
 10545					;   5736  1	!
 10546					;   5737  1	! IMPLICIT INPUTS:
 10547					;   5738  1	!
 10548					;   5739  1	!	None.
 10549					;   5740  1	!
 10550					;   5741  1	! OUPTUT PARAMETERS:
 10551					;   5742  1	!
 10552					;   5743  1	!	Returns 0 if START = TRUE, actual number of characters used
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-194
KERMSG	MAC	18-Jan-73 17:20	

 10553					;   5744  1	!	by last string if START = FALSE.
 10554					;   5745  1	!
 10555					;   5746  1	! IMPLICIT OUTPUTS:
 10556					;   5747  1	!
 10557					;   5748  1	!	GET%CHR%ROUTINE and PUT%CHR%ROUTINE modifed so that string
 10558					;   5749  1	!	routines are called instead of file I/O.
 10559					;   5750  1	!
 10560					;   5751  1	! COMPLETION CODES:
 10561					;   5752  1	!
 10562					;   5753  1	!	None.
 10563					;   5754  1	!
 10564					;   5755  1	! SIDE EFFECTS:
 10565					;   5756  1	!
 10566					;   5757  1	!	None.
 10567					;   5758  1	!
 10568					;   5759  1	!--
 10569					;   5760  1	
 10570					;   5761  2	    BEGIN
 10571					;   5762  2	
 10572					;   5763  2	    OWN
 10573					;   5764  2		STR%POINTER,				! Pointer to string
 10574					;   5765  2		STR%LENGTH,				! Length of string
 10575					;   5766  2		STR%ORG%LENGTH,				! Original length of string
 10576					;   5767  2		OLD%GET%CHR,				! Old get-char routine
 10577					;   5768  2		OLD%PUT%CHR;				! Old put-char routine
 10578					;   5769  2	
 10579					;   5770  2	!
 10580					;   5771  2	! Routine to get a character from the string
 10581					;   5772  2	!
 10582					;   5773  2	    ROUTINE GET%STRING (CHAR%ADDRESS) =
 10583					;   5774  3		BEGIN
 10584					;   5775  3	!
 10585					;   5776  3	! If some characters are left, count down the length and get next character
 10586					;   5777  3	! Otherwise return and end of file indication.
 10587					;   5778  3	!
 10588					;   5779  3	
 10589					;   5780  3		IF .STR%LENGTH GTR 0
 10590					;   5781  3		THEN
 10591					;   5782  4		    BEGIN
 10592					;   5783  4		    STR%LENGTH = .STR%LENGTH - 1;
 10593					;   5784  4		    .CHAR%ADDRESS = CH$RCHAR%A (STR%POINTER);
 10594					;   5785  4		    RETURN KER%NORMAL;
 10595					;   5786  4		    END
 10596					;   5787  3		ELSE
 10597					;   5788  3		    RETURN KER%EOF;
 10598					;   5789  3	
 10599					;   5790  2		END;					! End of GET%STRING
 10600
 10601
 10602	000136'					RELOC	136
 10603					; STR%POINTER
 10604	000136'				U.92:	BLOCK	1
 10605					; STR%LENGTH
 10606	000137'				U.93:	BLOCK	1
 10607					; STR%ORG%LENGTH
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-195
KERMSG	MAC	18-Jan-73 17:20	

 10608	000140'				U.94:	BLOCK	1
 10609					; OLD%GET%CHR
 10610	000141'				U.95:	BLOCK	1
 10611					; OLD%PUT%CHR
 10612	000142'				U.96:	BLOCK	1
 10613
 10614
 10615	406134'					RELOC	406134
 10616					; GET%STRING
 10617					U.97:	SKIPG	U.93				; STR%LENGTH				
 10618	406134'	337 00 0 00 000137'						5780
 10619	406135'	254 00 0 00 406144'		JRST	L.416				; L.416
 10620						SOS	U.93				; STR%LENGTH				
 10621	406136'	370 00 0 00 000137'						5783
 10622						MOVE	AC2,-1(SP)			; AC2,CHAR%ADDRESS			
 10623	406137'	200 02 0 17 777777 						5784
 10624	406140'	134 01 0 00 000136'		ILDB	AC1,U.92			; AC1,STR%POINTER
 10625	406141'	202 01 0 02 000000 		MOVEM	AC1,0(AC2)			; AC1,0(AC2)
 10626						MOVEI	AC1,13				; AC1,13				
 10627	406142'	201 01 0 00 000013 						5788
 10628	406143'	263 17 0 00 000000 		POPJ	SP,				; SP,
 10629	406144'	201 01 0 00 000113 	L.416:	MOVEI	AC1,113				; AC1,113
 10630						POPJ	SP,				; SP,					
 10631	406145'	263 17 0 00 000000 						5773
 10632
 10633					; Routine Size:  10 words
 10634
 10635
 10636					;   5791  2	    ROUTINE PUT%STRING (CHAR%VALUE) =
 10637					;   5792  3		BEGIN
 10638					;   5793  3	!
 10639					;   5794  3	! If there is enough room to store another character, store the character
 10640					;   5795  3	! and count it.  Otherwise return a line too long indication.
 10641					;   5796  3	!
 10642					;   5797  3	
 10643					;   5798  3		IF .STR%LENGTH GTR 0
 10644					;   5799  3		THEN
 10645					;   5800  4		    BEGIN
 10646					;   5801  4		    STR%LENGTH = .STR%LENGTH - 1;
 10647					;   5802  4		    CH$WCHAR%A (.CHAR%VALUE, STR%POINTER);
 10648					;   5803  4		    RETURN KER%NORMAL;
 10649					;   5804  4		    END
 10650					;   5805  3		ELSE
 10651					;   5806  3		    RETURN KER%LINTOOLNG;
 10652					;   5807  3	
 10653					;   5808  2		END;					! End of PUT%STRING
 10654
 10655
 10656					; PUT%STRING
 10657					U.98:	SKIPG	U.93				; STR%LENGTH				
 10658	406146'	337 00 0 00 000137'						5798
 10659	406147'	254 00 0 00 406155'		JRST	L.417				; L.417
 10660						SOS	U.93				; STR%LENGTH				
 10661	406150'	370 00 0 00 000137'						5801
 10662						MOVE	AC1,-1(SP)			; AC1,CHAR%VALUE			
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-196
KERMSG	MAC	18-Jan-73 17:20	

 10663	406151'	200 01 0 17 777777 						5802
 10664	406152'	136 01 0 00 000136'		IDPB	AC1,U.92			; AC1,STR%POINTER
 10665						MOVEI	AC1,13				; AC1,13				
 10666	406153'	201 01 0 00 000013 						5806
 10667	406154'	263 17 0 00 000000 		POPJ	SP,				; SP,
 10668	406155'	201 01 0 00 000102 	L.417:	MOVEI	AC1,102				; AC1,102
 10669						POPJ	SP,				; SP,					
 10670	406156'	263 17 0 00 000000 						5791
 10671
 10672					; Routine Size:  9 words
 10673
 10674
 10675					;   5809  2	!
 10676					;   5810  2	! If we have a request to start a string (input or output), save the old
 10677					;   5811  2	! routines and set up ours.  Also save the string pointer and length for
 10678					;   5812  2	! use by our get/put routines.
 10679					;   5813  2	! Otherwise this is a request to stop using the string routines, so reset
 10680					;   5814  2	! the old routines and return the actual number of characters read or
 10681					;   5815  2	! written
 10682					;   5816  2	!
 10683					;   5817  2	
 10684					;   5818  2	    IF .START
 10685					;   5819  2	    THEN
 10686					;   5820  3		BEGIN
 10687					;   5821  3		STR%POINTER = .POINTER;
 10688					;   5822  3		STR%ORG%LENGTH = .LENGTH;
 10689					;   5823  3		STR%LENGTH = .LENGTH;
 10690					;   5824  3		OLD%GET%CHR = .GET%CHR%ROUTINE;
 10691					;   5825  3		OLD%PUT%CHR = .PUT%CHR%ROUTINE;
 10692					;   5826  3		GET%CHR%ROUTINE = GET%STRING;
 10693					;   5827  3		PUT%CHR%ROUTINE = PUT%STRING;
 10694					;   5828  3		RETURN 0;
 10695					;   5829  3		END
 10696					;   5830  2	    ELSE
 10697					;   5831  3		BEGIN
 10698					;   5832  3		GET%CHR%ROUTINE = .OLD%GET%CHR;
 10699					;   5833  3		PUT%CHR%ROUTINE = .OLD%PUT%CHR;
 10700					;   5834  3		RETURN .STR%ORG%LENGTH - .STR%LENGTH;
 10701					;   5835  2		END;
 10702					;   5836  2	
 10703					;   5837  1	    END;					! End of SET%STRING
 10704
 10705
 10706					; SET%STRING
 10707					U.30:	MOVEI	AC1,1				; AC1,1					
 10708	406157'	201 01 0 00 000001 						5818
 10709	406160'	616 01 0 17 777777 		TDNN	AC1,-1(SP)			; AC1,START
 10710	406161'	254 00 0 00 406202'		JRST	L.418				; L.418
 10711						MOVE	AC1,-3(SP)			; AC1,POINTER				
 10712	406162'	200 01 0 17 777775 						5821
 10713	406163'	202 01 0 00 000136'		MOVEM	AC1,U.92			; AC1,STR%POINTER
 10714						MOVE	AC1,-2(SP)			; AC1,LENGTH				
 10715	406164'	200 01 0 17 777776 						5822
 10716	406165'	202 01 0 00 000140'		MOVEM	AC1,U.94			; AC1,STR%ORG%LENGTH
 10717						MOVE	AC1,-2(SP)			; AC1,LENGTH				
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-197
KERMSG	MAC	18-Jan-73 17:20	

 10718	406166'	200 01 0 17 777776 						5823
 10719	406167'	202 01 0 00 000137'		MOVEM	AC1,U.93			; AC1,STR%LENGTH
 10720						MOVE	AC1,U.66			; AC1,GET%CHR%ROUTINE			
 10721	406170'	200 01 0 00 000113'						5824
 10722	406171'	202 01 0 00 000141'		MOVEM	AC1,U.95			; AC1,OLD%GET%CHR
 10723						MOVE	AC1,U.67			; AC1,PUT%CHR%ROUTINE			
 10724	406172'	200 01 0 00 000114'						5825
 10725	406173'	202 01 0 00 000142'		MOVEM	AC1,U.96			; AC1,OLD%PUT%CHR
 10726						MOVEI	AC1,U.97			; AC1,GET%STRING			
 10727	406174'	201 01 0 00 406134'						5826
 10728	406175'	202 01 0 00 000113'		MOVEM	AC1,U.66			; AC1,GET%CHR%ROUTINE
 10729						MOVEI	AC1,U.98			; AC1,PUT%STRING			
 10730	406176'	201 01 0 00 406146'						5827
 10731	406177'	202 01 0 00 000114'		MOVEM	AC1,U.67			; AC1,PUT%CHR%ROUTINE
 10732						SETZ	AC1,				; AC1,					
 10733	406200'	400 01 0 00 000000 						5831
 10734	406201'	263 17 0 00 000000 		POPJ	SP,				; SP,
 10735					L.418:	MOVE	AC1,U.95			; AC1,OLD%GET%CHR			
 10736	406202'	200 01 0 00 000141'						5832
 10737	406203'	202 01 0 00 000113'		MOVEM	AC1,U.66			; AC1,GET%CHR%ROUTINE
 10738						MOVE	AC1,U.96			; AC1,OLD%PUT%CHR			
 10739	406204'	200 01 0 00 000142'						5833
 10740	406205'	202 01 0 00 000114'		MOVEM	AC1,U.67			; AC1,PUT%CHR%ROUTINE
 10741						MOVE	AC1,U.94			; AC1,STR%ORG%LENGTH			
 10742	406206'	200 01 0 00 000140'						5834
 10743	406207'	274 01 0 00 000137'		SUB	AC1,U.93			; AC1,STR%LENGTH
 10744						POPJ	SP,				; SP,					
 10745	406210'	263 17 0 00 000000 						5716
 10746
 10747					; Routine Size:  26 words
 10748
 10749
 10750					;   5838  1	%SBTTL 'Add parity routine'
 10751					;   5839  1	ROUTINE DO%PARITY (MESSAGE, LENGTH) : NOVALUE =
 10752					;   5840  1	
 10753					;   5841  1	!++
 10754					;   5842  1	! FUNCTIONAL DESCRIPTION:
 10755					;   5843  1	!
 10756					;   5844  1	!	This routine will add parity for a complete message that is to be
 10757					;   5845  1	!	sent to the remote Kermit.
 10758					;   5846  1	!
 10759					;   5847  1	! CALLING SEQUENCE:
 10760					;   5848  1	!
 10761					;   5849  1	!	DO%PARITY (Message%address, Message%length);
 10762					;   5850  1	!
 10763					;   5851  1	! INPUT PARAMETERS:
 10764					;   5852  1	!
 10765					;   5853  1	!	Message%address - Address of the message to put parity on.
 10766					;   5854  1	!	Message%length  - Lengtho of the message.
 10767					;   5855  1	!
 10768					;   5856  1	! IMPLICIT INPUTS:
 10769					;   5857  1	!
 10770					;   5858  1	!	None.
 10771					;   5859  1	!
 10772					;   5860  1	! OUTPUT PARAMETERS:
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-198
KERMSG	MAC	18-Jan-73 17:20	

 10773					;   5861  1	!
 10774					;   5862  1	!	None.
 10775					;   5863  1	!
 10776					;   5864  1	! IMPLICIT OUTPUTS:
 10777					;   5865  1	!
 10778					;   5866  1	!	None.
 10779					;   5867  1	!
 10780					;   5868  1	! COMPLETION CODES:
 10781					;   5869  1	!
 10782					;   5870  1	!	None.
 10783					;   5871  1	!
 10784					;   5872  1	! SIDE EFFECTS:
 10785					;   5873  1	!
 10786					;   5874  1	!	None.
 10787					;   5875  1	!
 10788					;   5876  1	!--
 10789					;   5877  1	
 10790					;   5878  2	    BEGIN
 10791					;   5879  2	
 10792					;   5880  2	    MAP
 10793					;   5881  2		MESSAGE : REF VECTOR [CH$ALLOCATION (MAX%MSG, CHR%SIZE)];
 10794					;   5882  2	
 10795					;   5883  2	    LOCAL
 10796					;   5884  2		POINTER;				! Point into the message
 10797					;   5885  2	
 10798					;   5886  2	    IF NOT .DEV%PARITY%FLAG
 10799					;   5887  2	    THEN
 10800					;   5888  3		BEGIN
 10801					;   5889  3		POINTER = CH$PTR (.MESSAGE,, CHR%SIZE);
 10802					;   5890  3	
 10803					;   5891  3		INCR I FROM 1 TO .LENGTH DO
 10804					;   5892  3		    CH$WCHAR%A (GEN%PARITY (CH$RCHAR (.POINTER)), POINTER);
 10805					;   5893  3	
 10806					;   5894  2		END;
 10807					;   5895  2	
 10808					;   5896  1	    END;					! End of DO%PARITY
 10809
 10810
 10811					; DO%PARITY
 10812					U.22:	PUSH	SP,AC13				; SP,AC13				
 10813	406211'	261 17 0 00 000013 						5839
 10814	406212'	261 17 0 00 000014 		PUSH	SP,AC14				; SP,AC14
 10815	406213'	261 17 0 00 000016 		PUSH	SP,AC16				; SP,AC16
 10816						MOVEI	AC1,1				; AC1,1					
 10817	406214'	201 01 0 00 000001 						5886
 10818	406215'	612 01 0 00 400055*		TDNE	AC1,DEV%PARITY%FLAG		; AC1,DEV%PARITY%FLAG
 10819	406216'	254 00 0 00 406236'		JRST	L.421				; L.421
 10820						MOVE	AC1,-5(SP)			; AC1,MESSAGE				
 10821	406217'	200 01 0 17 777773 						5889
 10822	406220'	201 16 0 01 777777 		MOVEI	AC16,-1(AC1)			; AC16,-1(AC1)
 10823	406221'	505 16 0 00 041000 		HRLI	AC16,41000			; AC16,41000
 10824						MOVE	AC13,-4(SP)			; AC13,LENGTH				
 10825	406222'	200 13 0 17 777774 						5891
 10826	406223'	400 14 0 00 000000 		SETZ	AC14,				; I,
 10827	406224'	254 00 0 00 406233'		JRST	L.420				; L.420
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-199
KERMSG	MAC	18-Jan-73 17:20	

 10828					L.419:	MOVE	AC1,AC16			; AC1,POINTER				
 10829	406225'	200 01 0 00 000016 						5892
 10830	406226'	134 01 0 00 000001 		ILDB	AC1,AC1				; AC1,AC1
 10831	406227'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
 10832	406230'	260 17 0 00 406242'		PUSHJ	SP,U.23				; SP,GEN%PARITY
 10833	406231'	136 01 0 00 000016 		IDPB	AC1,AC16			; AC1,POINTER
 10834	406232'	105 17 0 00 777777 		ADJSP	SP,-1				; SP,-1
 10835					L.420:	ADDI	AC14,1				; I,1					
 10836	406233'	271 14 0 00 000001 						5891
 10837	406234'	317 14 0 00 000013 		CAMG	AC14,AC13			; I,AC13
 10838	406235'	254 00 0 00 406225'		JRST	L.419				; L.419
 10839					L.421:	POP	SP,AC16				; SP,AC16				
 10840	406236'	262 17 0 00 000016 						5839
 10841	406237'	262 17 0 00 000014 		POP	SP,AC14				; SP,AC14
 10842	406240'	262 17 0 00 000013 		POP	SP,AC13				; SP,AC13
 10843	406241'	263 17 0 00 000000 		POPJ	SP,				; SP,
 10844
 10845					; Routine Size:  25 words
 10846
 10847
 10848					;   5897  1	%SBTTL 'Parity routine'
 10849					;   5898  1	
 10850					;   5899  1	GLOBAL ROUTINE GEN%PARITY (CHARACTER) =
 10851					;   5900  1	
 10852					;   5901  1	!++
 10853					;   5902  1	! FUNCTIONAL DESCRIPTION:
 10854					;   5903  1	!
 10855					;   5904  1	!	This routine will add parity to the character that is supplied.
 10856					;   5905  1	!
 10857					;   5906  1	! CALLING SEQUENCE:
 10858					;   5907  1	!
 10859					;   5908  1	!	CHARACTER = GEN%PARITY(CHARACTER)
 10860					;   5909  1	!
 10861					;   5910  1	! INPUT PARAMETERS:
 10862					;   5911  1	!
 10863					;   5912  1	!	CHARACTER - Produce the parity for this character depending on the
 10864					;   5913  1	!		setting of the SET PARITY switch.
 10865					;   5914  1	!
 10866					;   5915  1	! IMPLICIT INPUTS:
 10867					;   5916  1	!
 10868					;   5917  1	!	None.
 10869					;   5918  1	!
 10870					;   5919  1	! OUTPUT PARAMETERS:
 10871					;   5920  1	!
 10872					;   5921  1	!	None.
 10873					;   5922  1	!
 10874					;   5923  1	! IMPLICIT OUTPUTS:
 10875					;   5924  1	!
 10876					;   5925  1	!	None.
 10877					;   5926  1	!
 10878					;   5927  1	! COMPLETION CODES:
 10879					;   5928  1	!
 10880					;   5929  1	!	None.
 10881					;   5930  1	!
 10882					;   5931  1	! SIDE EFFECTS:
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-200
KERMSG	MAC	18-Jan-73 17:20	

 10883					;   5932  1	!
 10884					;   5933  1	!	None.
 10885					;   5934  1	!
 10886					;   5935  1	!--
 10887					;   5936  1	
 10888					;   5937  2	    BEGIN
 10889					;   5938  2	
 10890					;   5939  2	    LOCAL
 10891					;   5940  2		TEMP%CHAR;
 10892					;   5941  2	
 10893					;   5942  2	    IF .IBM%FLAG THEN RETURN .CHARACTER OR %O'200';
 10894					;   5943  2	
 10895					;   5944  2	    CASE .PARITY%TYPE FROM PR%MIN TO PR%MAX OF
 10896					;   5945  2		SET
 10897					;   5946  2	
 10898					;   5947  2		[PR%NONE] :
 10899					;   5948  2		    RETURN .CHARACTER;
 10900					;   5949  2	
 10901					;   5950  2		[PR%SPACE] :
 10902					;   5951  2		    RETURN .CHARACTER AND %O'177';
 10903					;   5952  2	
 10904					;   5953  2		[PR%MARK] :
 10905					;   5954  2		    RETURN .CHARACTER OR %O'200';
 10906					;   5955  2	
 10907					;   5956  2		[PR%ODD] :
 10908					;   5957  2		    TEMP%CHAR = .CHARACTER AND %O'177' OR %O'200';
 10909					;   5958  2	
 10910					;   5959  2		[PR%EVEN] :
 10911					;   5960  2		    TEMP%CHAR = .CHARACTER AND %O'177';
 10912					;   5961  2		TES;
 10913					;   5962  2	
 10914					;   5963  2	    TEMP%CHAR = .TEMP%CHAR XOR (.TEMP%CHAR^-4);
 10915					;   5964  2	    TEMP%CHAR = .TEMP%CHAR XOR (.TEMP%CHAR^-2);
 10916					;   5965  2	
 10917					;   5966  2	    IF .TEMP%CHAR<0, 2> EQL %B'01' OR .TEMP%CHAR<0, 2> EQL %B'10'
 10918					;   5967  2	    THEN
 10919					;   5968  2		RETURN .CHARACTER AND %O'177' OR %O'200'
 10920					;   5969  2	    ELSE
 10921					;   5970  2		RETURN .CHARACTER AND %O'177';
 10922					;   5971  2	
 10923					;   5972  1	    END;					! End of GEN%PARITY
 10924
 10925
 10926	406242'				U.23:
 10927	406242'				GEN%PARITY::
 10928						MOVEI	AC1,1				; AC1,1					
 10929	406242'	201 01 0 00 000001 						5942
 10930	406243'	616 01 0 00 404575*		TDNN	AC1,IBM%FLAG			; AC1,IBM%FLAG
 10931	406244'	254 00 0 00 406247'		JRST	L.422				; L.422
 10932	406245'	200 01 0 17 777777 		MOVE	AC1,-1(SP)			; AC1,CHARACTER
 10933	406246'	254 00 0 00 406302'		JRST	L.429				; L.429
 10934					L.422:	MOVE	AC3,-1(SP)			; AC3,CHARACTER				
 10935	406247'	200 03 0 17 777777 						5948
 10936						MOVE	AC1,PARITY%TYPE			; AC1,PARITY%TYPE			
 10937	406250'	200 01 0 00 405216*						5944
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-201
KERMSG	MAC	18-Jan-73 17:20	

 10938	406251'	254 00 0 01 406252'		JRST	L.423(AC1)			; L.423(AC1)
 10939	406252'	254 00 0 00 406257'	L.423:	JRST	L.424				; L.424
 10940	406253'	254 00 0 00 406261'		JRST	L.425				; L.425
 10941	406254'	254 00 0 00 406265'		JRST	L.427				; L.427
 10942	406255'	254 00 0 00 406263'		JRST	L.426				; L.426
 10943	406256'	254 00 0 00 406303'		JRST	L.430				; L.430
 10944					L.424:	MOVE	AC1,AC3				; AC1,AC3				
 10945	406257'	200 01 0 00 000003 						5948
 10946	406260'	263 17 0 00 000000 		POPJ	SP,				; SP,
 10947					L.425:	MOVE	AC1,AC3				; AC1,AC3				
 10948	406261'	200 01 0 00 000003 						5954
 10949	406262'	254 00 0 00 406302'		JRST	L.429				; L.429
 10950					L.426:	LDB	AC1,C.102			; TEMP%CHAR,[POINT 7,AC3,35]  <0,7>	
 10951	406263'	135 01 0 00 406305'						5957
 10952	406264'	664 01 0 00 000200 		TROA	AC1,200				; TEMP%CHAR,200
 10953					L.427:	LDB	AC1,C.102			; TEMP%CHAR,[POINT 7,AC3,35]  <0,7>	
 10954	406265'	135 01 0 00 406305'						5960
 10955						MOVE	AC2,AC1				; AC2,TEMP%CHAR				
 10956	406266'	200 02 0 00 000001 						5963
 10957	406267'	240 02 0 00 777774 		ASH	AC2,-4				; AC2,-4
 10958	406270'	430 01 0 00 000002 		XOR	AC1,AC2				; TEMP%CHAR,AC2
 10959						MOVE	AC2,AC1				; AC2,TEMP%CHAR				
 10960	406271'	200 02 0 00 000001 						5964
 10961	406272'	240 02 0 00 777776 		ASH	AC2,-2				; AC2,-2
 10962	406273'	430 01 0 00 000002 		XOR	AC1,AC2				; TEMP%CHAR,AC2
 10963						ANDI	AC1,3				; AC1,3					
 10964	406274'	405 01 0 00 000003 						5966
 10965	406275'	306 01 0 00 000001 		CAIN	AC1,1				; AC1,1
 10966	406276'	254 00 0 00 406301'		JRST	L.428				; L.428
 10967	406277'	302 01 0 00 000002 		CAIE	AC1,2				; AC1,2
 10968	406300'	254 00 0 00 406303'		JRST	L.430				; L.430
 10969					L.428:	LDB	AC1,C.102			; AC1,[POINT 7,AC3,35]  <0,7>		
 10970	406301'	135 01 0 00 406305'						5968
 10971	406302'	664 01 0 00 000200 	L.429:	TROA	AC1,200				; AC1,200
 10972					L.430:	LDB	AC1,C.102			; AC1,[POINT 7,AC3,35]  <0,7>		
 10973	406303'	135 01 0 00 406305'						5970
 10974						POPJ	SP,				; SP,					
 10975	406304'	263 17 0 00 000000 						5899
 10976	406305'	00 07 0 00 000003 	C.102:	POINT	7,AC3,35			; 7,AC3,35
 10977
 10978					; Routine Size:  36 words
 10979
 10980
 10981					;   5973  1	
 10982					;   5974  1	%SBTTL 'Per transfer -- Initialization'
 10983					;   5975  1	ROUTINE INIT%XFR : NOVALUE =
 10984					;   5976  1	
 10985					;   5977  1	!++
 10986					;   5978  1	! FUNCTIONAL DESCRIPTION:
 10987					;   5979  1	!
 10988					;   5980  1	!	This routine will initialize the various locations that the
 10989					;   5981  1	!	send and receive statistics are kept.
 10990					;   5982  1	!
 10991					;   5983  1	! CALLING SEQUENCE:
 10992					;   5984  1	!
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-202
KERMSG	MAC	18-Jan-73 17:20	

 10993					;   5985  1	!	INIT%XFR();
 10994					;   5986  1	!
 10995					;   5987  1	! INPUT PARAMETERS:
 10996					;   5988  1	!
 10997					;   5989  1	!	None.
 10998					;   5990  1	!
 10999					;   5991  1	! IMPLICIT INPUTS:
 11000					;   5992  1	!
 11001					;   5993  1	!	None.
 11002					;   5994  1	!
 11003					;   5995  1	! OUTPUT PARAMETERS:
 11004					;   5996  1	!
 11005					;   5997  1	!	None.
 11006					;   5998  1	!
 11007					;   5999  1	! IMPLICIT OUTPUTS:
 11008					;   6000  1	!
 11009					;   6001  1	!	None.
 11010					;   6002  1	!
 11011					;   6003  1	! COMPLETION CODES:
 11012					;   6004  1	!
 11013					;   6005  1	!	None.
 11014					;   6006  1	!
 11015					;   6007  1	! SIDE EFFECTS:
 11016					;   6008  1	!
 11017					;   6009  1	!	None.
 11018					;   6010  1	!
 11019					;   6011  1	!--
 11020					;   6012  1	
 11021					;   6013  2	    BEGIN
 11022					;   6014  2	!
 11023					;   6015  2	! Determine if we should do 8 bit quoting
 11024					;   6016  2	!
 11025					;   6017  2	
 11026					;   6018  2	    IF .PARITY%TYPE NEQ PR%NONE
 11027					;   6019  2	    THEN
 11028					;   6020  3		BEGIN
 11029					;   6021  3		RECV%8QUOTE%CHR = .RCV%8QUOTE%CHR;
 11030					;   6022  3		END
 11031					;   6023  2	    ELSE
 11032					;   6024  3		BEGIN
 11033					;   6025  3		RECV%8QUOTE%CHR = %C'Y';
 11034					;   6026  2		END;
 11035					;   6027  2	
 11036					;   6028  2	    NUM%RETRIES = 0;
 11037					;   6029  2	    SEND%8QUOTE%CHR = .RECV%8QUOTE%CHR;
 11038					;   6030  2	!
 11039					;   6031  2	! Send parameters that may not get set before we need them for the first
 11040					;   6032  2	! time.
 11041					;   6033  2	!
 11042					;   6034  2	    SEND%PKT%SIZE = ABS (.SND%PKT%SIZE);
 11043					;   6035  2	    SEND%NPAD = ABS (.SND%NPAD);
 11044					;   6036  2	    SEND%PADCHAR = ABS (.SND%PADCHAR);
 11045					;   6037  2	    SEND%TIMEOUT = ABS (.SND%TIMEOUT);
 11046					;   6038  2	    SEND%EOL = ABS (.SND%EOL);
 11047					;   6039  2	    SEND%QUOTE%CHR = ABS (.SND%QUOTE%CHR);
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-203
KERMSG	MAC	18-Jan-73 17:20	

 11048					;   6040  2	!
 11049					;   6041  2	! For initialization messages, we must use single character checksum
 11050					;   6042  2	! When the send-init/ack sequence has been done, we will switch to the
 11051					;   6043  2	! desired form
 11052					;   6044  2	!
 11053					;   6045  2	    BLK%CHK%TYPE = CHK%1CHAR;
 11054					;   6046  2	    INI%CHK%TYPE = .CHKTYPE;			! Send desired type
 11055					;   6047  2	!
 11056					;   6048  2	! Set desired repeat character for use in we are doing send-init
 11057					;   6049  2	! Will be overwritten by other ends desired character if it sends
 11058					;   6050  2	! the send-init.
 11059					;   6051  2	!
 11060					;   6052  2	    REPT%CHR = .SET%REPT%CHR;
 11061					;   6053  2	!
 11062					;   6054  2	! Assume packet assembly/disassembly uses characters from a file
 11063					;   6055  2	!
 11064					;   6056  2	    GET%CHR%ROUTINE = GET%FILE;			! Initialize the get-a-char 
 11065					routine
 11066					;   6057  2	    PUT%CHR%ROUTINE = PUT%FILE;			! And the put-a-char
 11067					;   6058  2	    TEXT%HEAD%FLAG = FALSE;			! And assume we will get an 
 11068					File header
 11069					;   6059  2	    NO%FILE%NEEDED = FALSE;			! Assume will do file ops
 11070					;   6060  2	    INIT%PKT%SENT = FALSE;			! And no server-init sent
 11071					;   6061  2	!
 11072					;   6062  2	! Always start with packet number 0
 11073					;   6063  2	!
 11074					;   6064  2	    MSG%NUMBER = 0;				! Initial message number
 11075					;   6065  2	!
 11076					;   6066  2	! Stats information
 11077					;   6067  2	!
 11078					;   6068  2	    SMSG%TOTAL%CHARS = 0;
 11079					;   6069  2	    RMSG%TOTAL%CHARS = 0;
 11080					;   6070  2	    SMSG%DATA%CHARS = 0;
 11081					;   6071  2	    RMSG%DATA%CHARS = 0;
 11082					;   6072  2	    SMSG%COUNT = 0;
 11083					;   6073  2	    RMSG%COUNT = 0;
 11084					;   6074  2	    RMSG%NAKS = 0;
 11085					;   6075  2	    SMSG%NAKS = 0;
 11086					;   6076  2	    XFR%TIME = SY%TIME ();
 11087					;   6077  1	    END;					! End of INIT%XFR
 11088
 11089
 11090					; INIT%XFR
 11091					U.32:	SKIPE	PARITY%TYPE			; PARITY%TYPE				
 11092	406306'	332 00 0 00 406250*						6018
 11093						SKIPA	AC1,RCV%8QUOTE%CHR		; AC1,RCV%8QUOTE%CHR			
 11094	406307'	334 01 0 00 400653*						6021
 11095						MOVEI	AC1,131				; AC1,131				
 11096	406310'	201 01 0 00 000131 						6025
 11097	406311'	202 01 0 00 000000'		MOVEM	AC1,U.37			; AC1,RECV%8QUOTE%CHR
 11098						SETZM	U.52				; NUM%RETRIES				
 11099	406312'	402 00 0 00 000017'						6028
 11100						MOVE	AC1,U.37			; AC1,RECV%8QUOTE%CHR			
 11101	406313'	200 01 0 00 000000'						6029
 11102	406314'	202 01 0 00 000007'		MOVEM	AC1,U.44			; AC1,SEND%8QUOTE%CHR
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-204
KERMSG	MAC	18-Jan-73 17:20	

 11103						MOVE	AC1,SND%PKT%SIZE		; AC1,SND%PKT%SIZE			
 11104	406315'	200 01 0 00 404103*						6034
 11105	406316'	216 01 0 00 000002'		MOVMM	AC1,U.39			; AC1,SEND%PKT%SIZE
 11106						MOVE	AC1,SND%NPAD			; AC1,SND%NPAD				
 11107	406317'	200 01 0 00 404130*						6035
 11108	406320'	216 01 0 00 000003'		MOVMM	AC1,U.40			; AC1,SEND%NPAD
 11109						MOVE	AC1,SND%PADCHAR			; AC1,SND%PADCHAR			
 11110	406321'	200 01 0 00 404143*						6036
 11111	406322'	216 01 0 00 000004'		MOVMM	AC1,U.41			; AC1,SEND%PADCHAR
 11112						MOVE	AC1,SND%TIMEOUT			; AC1,SND%TIMEOUT			
 11113	406323'	200 01 0 00 404115*						6037
 11114	406324'	216 01 0 00 404127*		MOVMM	AC1,SEND%TIMEOUT		; AC1,SEND%TIMEOUT
 11115						MOVE	AC1,SND%EOL			; AC1,SND%EOL				
 11116	406325'	200 01 0 00 404155*						6038
 11117	406326'	216 01 0 00 000005'		MOVMM	AC1,U.42			; AC1,SEND%EOL
 11118						MOVE	AC1,SND%QUOTE%CHR		; AC1,SND%QUOTE%CHR			
 11119	406327'	200 01 0 00 404170*						6039
 11120	406330'	216 01 0 00 000006'		MOVMM	AC1,U.43			; AC1,SEND%QUOTE%CHR
 11121						MOVEI	AC1,61				; AC1,61				
 11122	406331'	201 01 0 00 000061 						6045
 11123	406332'	202 01 0 00 000011'		MOVEM	AC1,U.46			; AC1,BLK%CHK%TYPE
 11124						MOVE	AC1,CHKTYPE			; AC1,CHKTYPE				
 11125	406333'	200 01 0 00 404225*						6046
 11126	406334'	202 01 0 00 000010'		MOVEM	AC1,U.45			; AC1,INI%CHK%TYPE
 11127						MOVE	AC1,SET%REPT%CHR		; AC1,SET%REPT%CHR			
 11128	406335'	200 01 0 00 400657*						6052
 11129	406336'	202 01 0 00 000001'		MOVEM	AC1,U.38			; AC1,REPT%CHR
 11130						MOVEI	AC1,GET%FILE			; AC1,GET%FILE				
 11131	406337'	201 01 0 00 400072*						6056
 11132	406340'	202 01 0 00 000113'		MOVEM	AC1,U.66			; AC1,GET%CHR%ROUTINE
 11133						MOVEI	AC1,PUT%FILE			; AC1,PUT%FILE				
 11134	406341'	201 01 0 00 400074*						6057
 11135	406342'	202 01 0 00 000114'		MOVEM	AC1,U.67			; AC1,PUT%CHR%ROUTINE
 11136						SETZM	U.61				; TEXT%HEAD%FLAG			
 11137	406343'	402 00 0 00 000106'						6058
 11138						SETZM	U.62				; NO%FILE%NEEDED			
 11139	406344'	402 00 0 00 000107'						6059
 11140						SETZM	U.63				; INIT%PKT%SENT				
 11141	406345'	402 00 0 00 000110'						6060
 11142						SETZM	U.53				; MSG%NUMBER				
 11143	406346'	402 00 0 00 000020'						6064
 11144						SETZM	SMSG%TOTAL%CHARS		; SMSG%TOTAL%CHARS			
 11145	406347'	402 00 0 00 404560*						6068
 11146						SETZM	RMSG%TOTAL%CHARS		; RMSG%TOTAL%CHARS			
 11147	406350'	402 00 0 00 404775*						6069
 11148						SETZM	SMSG%DATA%CHARS			; SMSG%DATA%CHARS			
 11149	406351'	402 00 0 00 405776*						6070
 11150						SETZM	RMSG%DATA%CHARS			; RMSG%DATA%CHARS			
 11151	406352'	402 00 0 00 406105*						6071
 11152						SETZM	SMSG%COUNT			; SMSG%COUNT				
 11153	406353'	402 00 0 00 404570*						6072
 11154						SETZM	RMSG%COUNT			; RMSG%COUNT				
 11155	406354'	402 00 0 00 405144*						6073
 11156						SETZM	RMSG%NAKS			; RMSG%NAKS				
 11157	406355'	402 00 0 00 405140*						6074
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-205
KERMSG	MAC	18-Jan-73 17:20	

 11158						SETZM	SMSG%NAKS			; SMSG%NAKS				
 11159	406356'	402 00 0 00 404564*						6075
 11160						PUSHJ	SP,SY%TIME			; SP,SY%TIME				
 11161	406357'	260 17 0 00 000000*						6076
 11162	406360'	202 01 0 00 000000*		MOVEM	AC1,XFR%TIME			; AC1,XFR%TIME
 11163						POPJ	SP,				; SP,					
 11164	406361'	263 17 0 00 000000 						5975
 11165
 11166					; Routine Size:  44 words
 11167
 11168
 11169					;   6078  1	%SBTTL 'Statistics -- Finish message transfer'
 11170					;   6079  1	ROUTINE END%STATS : NOVALUE =
 11171					;   6080  1	
 11172					;   6081  1	!++
 11173					;   6082  1	! FUNCTIONAL DESCRIPTION:
 11174					;   6083  1	!
 11175					;   6084  1	!	This routine will end the collection of the statistices.  It will
 11176					;   6085  1	!	update the various overall statistic parameters.
 11177					;   6086  1	!
 11178					;   6087  1	! CALLING SEQUENCE:
 11179					;   6088  1	!
 11180					;   6089  1	!	END%STATS ();
 11181					;   6090  1	!
 11182					;   6091  1	! INPUT PARAMETERS:
 11183					;   6092  1	!
 11184					;   6093  1	!	None.
 11185					;   6094  1	!
 11186					;   6095  1	! IMPLICIT INPUTS:
 11187					;   6096  1	!
 11188					;   6097  1	!	None.
 11189					;   6098  1	!
 11190					;   6099  1	! OUTPUT PARAMETERS:
 11191					;   6100  1	!
 11192					;   6101  1	!	None.
 11193					;   6102  1	!
 11194					;   6103  1	! IMPLICIT OUTPUTS:
 11195					;   6104  1	!
 11196					;   6105  1	!	None.
 11197					;   6106  1	!
 11198					;   6107  1	! COMPLETION CODES:
 11199					;   6108  1	!
 11200					;   6109  1	!	None.
 11201					;   6110  1	!
 11202					;   6111  1	! SIDE EFFECTS:
 11203					;   6112  1	!
 11204					;   6113  1	!	None.
 11205					;   6114  1	!
 11206					;   6115  1	!--
 11207					;   6116  1	
 11208					;   6117  2	    BEGIN
 11209					;   6118  2	    SND%COUNT = .SND%COUNT + .SMSG%COUNT;
 11210					;   6119  2	    RCV%COUNT = .RCV%COUNT + .RMSG%COUNT;
 11211					;   6120  2	    SND%TOTAL%CHARS = .SND%TOTAL%CHARS + .SMSG%TOTAL%CHARS;
 11212					;   6121  2	    SND%DATA%CHARS = .SND%DATA%CHARS + .SMSG%DATA%CHARS;
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-206
KERMSG	MAC	18-Jan-73 17:20	

 11213					;   6122  2	    RCV%TOTAL%CHARS = .RCV%TOTAL%CHARS + .RMSG%TOTAL%CHARS;
 11214					;   6123  2	    RCV%DATA%CHARS = .RCV%DATA%CHARS + .RMSG%DATA%CHARS;
 11215					;   6124  2	    SND%NAKS = .SND%NAKS + .SMSG%NAKS;
 11216					;   6125  2	    RCV%NAKS = .RCV%NAKS + .RMSG%NAKS;
 11217					;   6126  2	    XFR%TIME = SY%TIME () - .XFR%TIME;
 11218					;   6127  2	    TOTAL%TIME = .TOTAL%TIME + .XFR%TIME;
 11219					;   6128  1	    END;					! End of END%STATS
 11220
 11221
 11222					; END%STATS
 11223					U.18:	MOVE	AC1,SMSG%COUNT			; AC1,SMSG%COUNT			
 11224	406362'	200 01 0 00 406353*						6118
 11225	406363'	272 01 0 00 000000*		ADDM	AC1,SND%COUNT			; AC1,SND%COUNT
 11226						MOVE	AC1,RMSG%COUNT			; AC1,RMSG%COUNT			
 11227	406364'	200 01 0 00 406354*						6119
 11228	406365'	272 01 0 00 000000*		ADDM	AC1,RCV%COUNT			; AC1,RCV%COUNT
 11229						MOVE	AC1,SMSG%TOTAL%CHARS		; AC1,SMSG%TOTAL%CHARS			
 11230	406366'	200 01 0 00 406347*						6120
 11231	406367'	272 01 0 00 000000*		ADDM	AC1,SND%TOTAL%CHARS		; AC1,SND%TOTAL%CHARS
 11232						MOVE	AC1,SMSG%DATA%CHARS		; AC1,SMSG%DATA%CHARS			
 11233	406370'	200 01 0 00 406351*						6121
 11234	406371'	272 01 0 00 000000*		ADDM	AC1,SND%DATA%CHARS		; AC1,SND%DATA%CHARS
 11235						MOVE	AC1,RMSG%TOTAL%CHARS		; AC1,RMSG%TOTAL%CHARS			
 11236	406372'	200 01 0 00 406350*						6122
 11237	406373'	272 01 0 00 000000*		ADDM	AC1,RCV%TOTAL%CHARS		; AC1,RCV%TOTAL%CHARS
 11238						MOVE	AC1,RMSG%DATA%CHARS		; AC1,RMSG%DATA%CHARS			
 11239	406374'	200 01 0 00 406352*						6123
 11240	406375'	272 01 0 00 000000*		ADDM	AC1,RCV%DATA%CHARS		; AC1,RCV%DATA%CHARS
 11241						MOVE	AC1,SMSG%NAKS			; AC1,SMSG%NAKS				
 11242	406376'	200 01 0 00 406356*						6124
 11243	406377'	272 01 0 00 000000*		ADDM	AC1,SND%NAKS			; AC1,SND%NAKS
 11244						MOVE	AC1,RMSG%NAKS			; AC1,RMSG%NAKS				
 11245	406400'	200 01 0 00 406355*						6125
 11246	406401'	272 01 0 00 000000*		ADDM	AC1,RCV%NAKS			; AC1,RCV%NAKS
 11247						PUSHJ	SP,SY%TIME			; SP,SY%TIME				
 11248	406402'	260 17 0 00 406357*						6126
 11249	406403'	277 01 0 00 406360*		SUBB	AC1,XFR%TIME			; AC1,XFR%TIME
 11250						ADDM	AC1,TOTAL%TIME			; AC1,TOTAL%TIME			
 11251	406404'	272 01 0 00 000000*						6127
 11252						POPJ	SP,				; SP,					
 11253	406405'	263 17 0 00 000000 						6079
 11254
 11255					; Routine Size:  20 words
 11256
 11257
 11258					;   6129  1	%SBTTL 'Status type out -- STS%OUTPUT'
 11259					;   6130  1	ROUTINE STS%OUTPUT : NOVALUE =
 11260					;   6131  1	
 11261					;   6132  1	!++
 11262					;   6133  1	! FUNCTIONAL DESCRIPTION:
 11263					;   6134  1	!
 11264					;   6135  1	!	This routine will output the current status of a transfer.
 11265					;   6136  1	!	This is used when the user types a ^A during a transfer.
 11266					;   6137  1	!
 11267					;   6138  1	! CALLING SEQUENCE:
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-207
KERMSG	MAC	18-Jan-73 17:20	

 11268					;   6139  1	!
 11269					;   6140  1	!	STS%OUTPUT ()
 11270					;   6141  1	!
 11271					;   6142  1	! INPUT PARAMETERS:
 11272					;   6143  1	!
 11273					;   6144  1	!	None.
 11274					;   6145  1	!
 11275					;   6146  1	! IMPLICIT INPUTS:
 11276					;   6147  1	!
 11277					;   6148  1	!	Statistics blocks, file names, etc.
 11278					;   6149  1	!
 11279					;   6150  1	! OUPTUT PARAMETERS:
 11280					;   6151  1	!
 11281					;   6152  1	!	None.
 11282					;   6153  1	!
 11283					;   6154  1	! IMPLICIT OUTPUTS:
 11284					;   6155  1	!
 11285					;   6156  1	!	None.
 11286					;   6157  1	!
 11287					;   6158  1	! COMPLETION CODES:
 11288					;   6159  1	!
 11289					;   6160  1	!	None.
 11290					;   6161  1	!
 11291					;   6162  1	! SIDE EFFECTS:
 11292					;   6163  1	!
 11293					;   6164  1	!	None.
 11294					;   6165  1	!
 11295					;   6166  1	!--
 11296					;   6167  1	
 11297					;   6168  2	    BEGIN
 11298					;   6169  2	    TT%CHAR (%C'[');				! Start the message
 11299					;   6170  2	
 11300					;   6171  2	    CASE .STATE FROM STATE%MIN TO STATE%MAX OF
 11301					;   6172  2		SET
 11302					;   6173  2	
 11303					;   6174  2		[STATE%ID, STATE%II] :
 11304					;   6175  2		    TT%TEXT (UPLIT (%ASCIZ'Idle in server mode'));
 11305					;   6176  2	
 11306					;   6177  2		[STATE%S, STATE%SF] :
 11307					;   6178  3		    BEGIN
 11308					;   6179  3		    TT%TEXT (UPLIT (%ASCIZ'Initializing for sending file '));
 11309					;   6180  3		    TT%TEXT (FILE%NAME);
 11310					;   6181  2		    END;
 11311					;   6182  2	
 11312					;   6183  2		[STATE%SI] :
 11313					;   6184  2		    TT%TEXT (UPLIT (%ASCIZ'Initializing for remote command'));
 11314					;   6185  2	
 11315					;   6186  2		[STATE%SG] :
 11316					;   6187  2		    TT%TEXT (UPLIT (%ASCIZ'Waiting for response to remote command'))
 11317					;
 11318					;   6188  2	
 11319					;   6189  2		[STATE%SD] :
 11320					;   6190  3		    BEGIN
 11321					;   6191  3		    TT%NUMBER (.FILE%CHARS);
 11322					;   6192  3		    TT%TEXT (UPLIT (%ASCIZ' characters sent for file '));
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-208
KERMSG	MAC	18-Jan-73 17:20	

 11323					;   6193  3		    TT%TEXT (FILE%NAME);
 11324					;   6194  2		    END;
 11325					;   6195  2	
 11326					;   6196  2		[STATE%SZ] :
 11327					;   6197  3		    BEGIN
 11328					;   6198  3		    TT%TEXT (UPLIT (%ASCIZ'At end of file '));
 11329					;   6199  3		    TT%TEXT (FILE%NAME);
 11330					;   6200  2		    END;
 11331					;   6201  2	
 11332					;   6202  2		[STATE%SB] :
 11333					;   6203  2		    TT%TEXT (UPLIT (%ASCIZ'Finishing transfer session'));
 11334					;   6204  2	
 11335					;   6205  2		[STATE%R] :
 11336					;   6206  2		    TT%TEXT (UPLIT (%ASCIZ'Waiting for initialization'));
 11337					;   6207  2	
 11338					;   6208  2		[STATE%RF] :
 11339					;   6209  2		    TT%TEXT (UPLIT (%ASCIZ'Waiting for next file or end of session')
 11340					);
 11341					;   6210  2	
 11342					;   6211  2		[STATE%RD] :
 11343					;   6212  3		    BEGIN
 11344					;   6213  3		    TT%NUMBER (.FILE%CHARS);
 11345					;   6214  3		    TT%TEXT (UPLIT (%ASCIZ' characters received for file '));
 11346					;   6215  3		    TT%TEXT (FILE%NAME);
 11347					;   6216  2		    END;
 11348					;   6217  2	
 11349					;   6218  2		[STATE%C] :
 11350					;   6219  2		    TT%TEXT (UPLIT (%ASCIZ' Session complete'));
 11351					;   6220  2	
 11352					;   6221  2		[STATE%A] :
 11353					;   6222  2		    TT%TEXT (UPLIT (%ASCIZ' Session aborted'));
 11354					;   6223  2	
 11355					;   6224  2		[INRANGE, OUTRANGE] :
 11356					;   6225  2		    TT%TEXT (UPLIT (%ASCIZ' Unknown state'));
 11357					;   6226  2		TES;
 11358					;   6227  2	
 11359					;   6228  2	    SELECTONE .STATE OF
 11360					;   6229  2		SET
 11361					;   6230  2	
 11362					;   6231  2		[STATE%S, STATE%SF, STATE%SD, STATE%SZ, STATE%SB] :
 11363					;   6232  3		    BEGIN
 11364					;   6233  3	
 11365					;   6234  3		    IF .RMSG%NAKS GTR 0
 11366					;   6235  3		    THEN
 11367					;   6236  4			BEGIN
 11368					;   6237  4			TT%TEXT (UPLIT (%ASCIZ', '));
 11369					;   6238  4			TT%NUMBER (.RMSG%NAKS);
 11370					;   6239  4			TT%TEXT (UPLIT (%ASCIZ' NAKs received'));
 11371					;   6240  3			END;
 11372					;   6241  3	
 11373					;   6242  2		    END;
 11374					;   6243  2	
 11375					;   6244  2		[STATE%R, STATE%RF, STATE%RD] :
 11376					;   6245  3		    BEGIN
 11377					;   6246  3	
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-209
KERMSG	MAC	18-Jan-73 17:20	

 11378					;   6247  3		    IF .SMSG%NAKS GTR 0
 11379					;   6248  3		    THEN
 11380					;   6249  4			BEGIN
 11381					;   6250  4			TT%TEXT (UPLIT (%ASCIZ', '));
 11382					;   6251  4			TT%NUMBER (.SMSG%NAKS);
 11383					;   6252  4			TT%TEXT (UPLIT (%ASCIZ' NAKs sent'));
 11384					;   6253  3			END;
 11385					;   6254  3	
 11386					;   6255  2		    END;
 11387					;   6256  2		TES;
 11388					;   6257  2	
 11389					;   6258  2	    TT%CHAR (%C']');				! End the line
 11390					;   6259  2	    TT%CRLF ();					! with a CRLF
 11391					;   6260  1	    END;					! End of STS%OUTPUT
 11392
 11393
 11394	406406'	111 144 154 145 040 0 	P.AAP:	BYTE	(7)"I","d","l","e"," "		; Idle
 11395	406407'	151 156 040 163 145 0 		BYTE	(7)"i","n"," ","s","e"		; in se
 11396	406410'	162 166 145 162 040 0 		BYTE	(7)"r","v","e","r"," "		; rver
 11397	406411'	155 157 144 145 000 0 		BYTE	(7)"m","o","d","e",000		; mode
 11398	406412'	111 156 151 164 151 0 	P.AAQ:	BYTE	(7)"I","n","i","t","i"		; Initi
 11399	406413'	141 154 151 172 151 0 		BYTE	(7)"a","l","i","z","i"		; alizi
 11400	406414'	156 147 040 146 157 0 		BYTE	(7)"n","g"," ","f","o"		; ng fo
 11401	406415'	162 040 163 145 156 0 		BYTE	(7)"r"," ","s","e","n"		; r sen
 11402	406416'	144 151 156 147 040 0 		BYTE	(7)"d","i","n","g"," "		; ding
 11403	406417'	146 151 154 145 040 0 		BYTE	(7)"f","i","l","e"," "		; file
 11404	406420'	000 000 000 000 000 0 		BYTE	(7)000,000,000,000,000
 11405	406421'	111 156 151 164 151 0 	P.AAR:	BYTE	(7)"I","n","i","t","i"		; Initi
 11406	406422'	141 154 151 172 151 0 		BYTE	(7)"a","l","i","z","i"		; alizi
 11407	406423'	156 147 040 146 157 0 		BYTE	(7)"n","g"," ","f","o"		; ng fo
 11408	406424'	162 040 162 145 155 0 		BYTE	(7)"r"," ","r","e","m"		; r rem
 11409	406425'	157 164 145 040 143 0 		BYTE	(7)"o","t","e"," ","c"		; ote c
 11410	406426'	157 155 155 141 156 0 		BYTE	(7)"o","m","m","a","n"		; omman
 11411	406427'	144 000 000 000 000 0 		BYTE	(7)"d",000,000,000,000		; d
 11412	406430'	127 141 151 164 151 0 	P.AAS:	BYTE	(7)"W","a","i","t","i"		; Waiti
 11413	406431'	156 147 040 146 157 0 		BYTE	(7)"n","g"," ","f","o"		; ng fo
 11414	406432'	162 040 162 145 163 0 		BYTE	(7)"r"," ","r","e","s"		; r res
 11415	406433'	160 157 156 163 145 0 		BYTE	(7)"p","o","n","s","e"		; ponse
 11416	406434'	040 164 157 040 162 0 		BYTE	(7)" ","t","o"," ","r"		;  to r
 11417	406435'	145 155 157 164 145 0 		BYTE	(7)"e","m","o","t","e"		; emote
 11418	406436'	040 143 157 155 155 0 		BYTE	(7)" ","c","o","m","m"		;  comm
 11419	406437'	141 156 144 000 000 0 		BYTE	(7)"a","n","d",000,000		; and
 11420	406440'	040 143 150 141 162 0 	P.AAT:	BYTE	(7)" ","c","h","a","r"		;  char
 11421	406441'	141 143 164 145 162 0 		BYTE	(7)"a","c","t","e","r"		; acter
 11422	406442'	163 040 163 145 156 0 		BYTE	(7)"s"," ","s","e","n"		; s sen
 11423	406443'	164 040 146 157 162 0 		BYTE	(7)"t"," ","f","o","r"		; t for
 11424	406444'	040 146 151 154 145 0 		BYTE	(7)" ","f","i","l","e"		;  file
 11425	406445'	040 000 000 000 000 0 		BYTE	(7)" ",000,000,000,000
 11426	406446'	101 164 040 145 156 0 	P.AAU:	BYTE	(7)"A","t"," ","e","n"		; At en
 11427	406447'	144 040 157 146 040 0 		BYTE	(7)"d"," ","o","f"," "		; d of
 11428	406450'	146 151 154 145 040 0 		BYTE	(7)"f","i","l","e"," "		; file
 11429	406451'	000 000 000 000 000 0 		BYTE	(7)000,000,000,000,000
 11430	406452'	106 151 156 151 163 0 	P.AAV:	BYTE	(7)"F","i","n","i","s"		; Finis
 11431	406453'	150 151 156 147 040 0 		BYTE	(7)"h","i","n","g"," "		; hing
 11432	406454'	164 162 141 156 163 0 		BYTE	(7)"t","r","a","n","s"		; trans
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-210
KERMSG	MAC	18-Jan-73 17:20	

 11433	406455'	146 145 162 040 163 0 		BYTE	(7)"f","e","r"," ","s"		; fer s
 11434	406456'	145 163 163 151 157 0 		BYTE	(7)"e","s","s","i","o"		; essio
 11435	406457'	156 000 000 000 000 0 		BYTE	(7)"n",000,000,000,000		; n
 11436	406460'	127 141 151 164 151 0 	P.AAW:	BYTE	(7)"W","a","i","t","i"		; Waiti
 11437	406461'	156 147 040 146 157 0 		BYTE	(7)"n","g"," ","f","o"		; ng fo
 11438	406462'	162 040 151 156 151 0 		BYTE	(7)"r"," ","i","n","i"		; r ini
 11439	406463'	164 151 141 154 151 0 		BYTE	(7)"t","i","a","l","i"		; tiali
 11440	406464'	172 141 164 151 157 0 		BYTE	(7)"z","a","t","i","o"		; zatio
 11441	406465'	156 000 000 000 000 0 		BYTE	(7)"n",000,000,000,000		; n
 11442	406466'	127 141 151 164 151 0 	P.AAX:	BYTE	(7)"W","a","i","t","i"		; Waiti
 11443	406467'	156 147 040 146 157 0 		BYTE	(7)"n","g"," ","f","o"		; ng fo
 11444	406470'	162 040 156 145 170 0 		BYTE	(7)"r"," ","n","e","x"		; r nex
 11445	406471'	164 040 146 151 154 0 		BYTE	(7)"t"," ","f","i","l"		; t fil
 11446	406472'	145 040 157 162 040 0 		BYTE	(7)"e"," ","o","r"," "		; e or
 11447	406473'	145 156 144 040 157 0 		BYTE	(7)"e","n","d"," ","o"		; end o
 11448	406474'	146 040 163 145 163 0 		BYTE	(7)"f"," ","s","e","s"		; f ses
 11449	406475'	163 151 157 156 000 0 		BYTE	(7)"s","i","o","n",000		; sion
 11450	406476'	040 143 150 141 162 0 	P.AAY:	BYTE	(7)" ","c","h","a","r"		;  char
 11451	406477'	141 143 164 145 162 0 		BYTE	(7)"a","c","t","e","r"		; acter
 11452	406500'	163 040 162 145 143 0 		BYTE	(7)"s"," ","r","e","c"		; s rec
 11453	406501'	145 151 166 145 144 0 		BYTE	(7)"e","i","v","e","d"		; eived
 11454	406502'	040 146 157 162 040 0 		BYTE	(7)" ","f","o","r"," "		;  for
 11455	406503'	146 151 154 145 040 0 		BYTE	(7)"f","i","l","e"," "		; file
 11456	406504'	000 000 000 000 000 0 		BYTE	(7)000,000,000,000,000
 11457	406505'	040 123 145 163 163 0 	P.AAZ:	BYTE	(7)" ","S","e","s","s"		;  Sess
 11458	406506'	151 157 156 040 143 0 		BYTE	(7)"i","o","n"," ","c"		; ion c
 11459	406507'	157 155 160 154 145 0 		BYTE	(7)"o","m","p","l","e"		; omple
 11460	406510'	164 145 000 000 000 0 		BYTE	(7)"t","e",000,000,000		; te
 11461	406511'	040 123 145 163 163 0 	P.ABA:	BYTE	(7)" ","S","e","s","s"		;  Sess
 11462	406512'	151 157 156 040 141 0 		BYTE	(7)"i","o","n"," ","a"		; ion a
 11463	406513'	142 157 162 164 145 0 		BYTE	(7)"b","o","r","t","e"		; borte
 11464	406514'	144 000 000 000 000 0 		BYTE	(7)"d",000,000,000,000		; d
 11465	406515'	040 125 156 153 156 0 	P.ABB:	BYTE	(7)" ","U","n","k","n"		;  Unkn
 11466	406516'	157 167 156 040 163 0 		BYTE	(7)"o","w","n"," ","s"		; own s
 11467	406517'	164 141 164 145 000 0 		BYTE	(7)"t","a","t","e",000		; tate
 11468	406520'	054 040 000 000 000 0 	P.ABC:	BYTE	(7)","," ",000,000,000		; ,
 11469	406521'	040 116 101 113 163 0 	P.ABD:	BYTE	(7)" ","N","A","K","s"		;  NAKs
 11470	406522'	040 162 145 143 145 0 		BYTE	(7)" ","r","e","c","e"		;  rece
 11471	406523'	151 166 145 144 000 0 		BYTE	(7)"i","v","e","d",000		; ived
 11472	406524'	054 040 000 000 000 0 	P.ABE:	BYTE	(7)","," ",000,000,000		; ,
 11473	406525'	040 116 101 113 163 0 	P.ABF:	BYTE	(7)" ","N","A","K","s"		;  NAKs
 11474	406526'	040 163 145 156 164 0 		BYTE	(7)" ","s","e","n","t"		;  sent
 11475	406527'	000 000 000 000 000 0 		BYTE	(7)000,000,000,000,000
 11476
 11477
 11478					; STS%OUTPUT
 11479					U.33:	PUSH	SP,C.103			; SP,[133]				
 11480	406530'	261 17 0 00 406666'						6169
 11481	406531'	260 17 0 00 000000*		PUSHJ	SP,TT%CHAR			; SP,TT%CHAR
 11482						MOVE	AC1,U.49			; AC1,STATE				
 11483	406532'	200 01 0 00 000014'						6171
 11484	406533'	361 01 0 00 406563'		SOJL	AC1,L.432			; AC1,L.432
 11485	406534'	305 01 0 00 000024 		CAIGE	AC1,24				; AC1,24
 11486	406535'	254 00 0 01 406537'		JRST	L.431(AC1)			; L.431(AC1)
 11487	406536'	254 00 0 00 406563'		JRST	L.432				; L.432
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-211
KERMSG	MAC	18-Jan-73 17:20	

 11488	406537'	254 00 0 00 406567'	L.431:	JRST	L.434				; L.434
 11489	406540'	254 00 0 00 406567'		JRST	L.434				; L.434
 11490	406541'	254 00 0 00 406575'		JRST	L.437				; L.437
 11491	406542'	254 00 0 00 406601'		JRST	L.438				; L.438
 11492	406543'	254 00 0 00 406607'		JRST	L.440				; L.440
 11493	406544'	254 00 0 00 406611'		JRST	L.441				; L.441
 11494	406545'	254 00 0 00 406613'		JRST	L.442				; L.442
 11495	406546'	254 00 0 00 406615'		JRST	L.443				; L.443
 11496	406547'	254 00 0 00 406625'		JRST	L.445				; L.445
 11497	406550'	254 00 0 00 406627'		JRST	L.446				; L.446
 11498	406551'	254 00 0 00 406563'		JRST	L.432				; L.432
 11499	406552'	254 00 0 00 406573'		JRST	L.436				; L.436
 11500	406553'	254 00 0 00 406571'		JRST	L.435				; L.435
 11501	406554'	254 00 0 00 406565'		JRST	L.433				; L.433
 11502	406555'	254 00 0 00 406565'		JRST	L.433				; L.433
 11503	406556'	254 00 0 00 406563'		JRST	L.432				; L.432
 11504	406557'	254 00 0 00 406563'		JRST	L.432				; L.432
 11505	406560'	254 00 0 00 406563'		JRST	L.432				; L.432
 11506	406561'	254 00 0 00 406563'		JRST	L.432				; L.432
 11507	406562'	254 00 0 00 406563'		JRST	L.432				; L.432
 11508					L.432:	PUSH	SP,C.104			; SP,[0,,P.ABB]				
 11509	406563'	261 17 0 00 406667'						6225
 11510	406564'	254 00 0 00 406630'		JRST	L.447				; L.447
 11511					L.433:	PUSH	SP,C.105			; SP,[0,,P.AAP]				
 11512	406565'	261 17 0 00 406670'						6175
 11513	406566'	254 00 0 00 406630'		JRST	L.447				; L.447
 11514					L.434:	PUSH	SP,C.106			; SP,[0,,P.AAQ]				
 11515	406567'	261 17 0 00 406671'						6179
 11516	406570'	254 00 0 00 406602'		JRST	L.439				; L.439
 11517					L.435:	PUSH	SP,C.107			; SP,[0,,P.AAR]				
 11518	406571'	261 17 0 00 406672'						6184
 11519	406572'	254 00 0 00 406630'		JRST	L.447				; L.447
 11520					L.436:	PUSH	SP,C.108			; SP,[0,,P.AAS]				
 11521	406573'	261 17 0 00 406673'						6187
 11522	406574'	254 00 0 00 406630'		JRST	L.447				; L.447
 11523					L.437:	PUSH	SP,U.60				; SP,FILE%CHARS				
 11524	406575'	261 17 0 00 000105'						6191
 11525	406576'	260 17 0 00 000000*		PUSHJ	SP,TT%NUMBER			; SP,TT%NUMBER
 11526						PUSH	SP,C.109			; SP,[0,,P.AAT]				
 11527	406577'	261 17 0 00 406674'						6192
 11528	406600'	254 00 0 00 406620'		JRST	L.444				; L.444
 11529					L.438:	PUSH	SP,C.110			; SP,[0,,P.AAU]				
 11530	406601'	261 17 0 00 406675'						6198
 11531	406602'	260 17 0 00 405175*	L.439:	PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
 11532						PUSH	SP,C.35				; SP,[0,,FILE%NAME]			
 11533	406603'	261 17 0 00 401660'						6199
 11534	406604'	260 17 0 00 406602*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
 11535						ADJSP	SP,-1				; SP,-1					
 11536	406605'	105 17 0 00 777777 						6197
 11537						JRST	L.448				; L.448					
 11538	406606'	254 00 0 00 406631'						6171
 11539					L.440:	PUSH	SP,C.111			; SP,[0,,P.AAV]				
 11540	406607'	261 17 0 00 406676'						6203
 11541	406610'	254 00 0 00 406630'		JRST	L.447				; L.447
 11542					L.441:	PUSH	SP,C.112			; SP,[0,,P.AAW]				
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-212
KERMSG	MAC	18-Jan-73 17:20	

 11543	406611'	261 17 0 00 406677'						6206
 11544	406612'	254 00 0 00 406630'		JRST	L.447				; L.447
 11545					L.442:	PUSH	SP,C.113			; SP,[0,,P.AAX]				
 11546	406613'	261 17 0 00 406700'						6209
 11547	406614'	254 00 0 00 406630'		JRST	L.447				; L.447
 11548					L.443:	PUSH	SP,U.60				; SP,FILE%CHARS				
 11549	406615'	261 17 0 00 000105'						6213
 11550	406616'	260 17 0 00 406576*		PUSHJ	SP,TT%NUMBER			; SP,TT%NUMBER
 11551						PUSH	SP,C.114			; SP,[0,,P.AAY]				
 11552	406617'	261 17 0 00 406701'						6214
 11553	406620'	260 17 0 00 406604*	L.444:	PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
 11554						PUSH	SP,C.35				; SP,[0,,FILE%NAME]			
 11555	406621'	261 17 0 00 401660'						6215
 11556	406622'	260 17 0 00 406620*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
 11557						ADJSP	SP,-2				; SP,-2					
 11558	406623'	105 17 0 00 777776 						6212
 11559						JRST	L.448				; L.448					
 11560	406624'	254 00 0 00 406631'						6171
 11561					L.445:	PUSH	SP,C.115			; SP,[0,,P.AAZ]				
 11562	406625'	261 17 0 00 406702'						6219
 11563	406626'	254 00 0 00 406630'		JRST	L.447				; L.447
 11564					L.446:	PUSH	SP,C.116			; SP,[0,,P.ABA]				
 11565	406627'	261 17 0 00 406703'						6222
 11566	406630'	260 17 0 00 406622*	L.447:	PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
 11567					L.448:	MOVE	AC1,U.49			; AC1,STATE				
 11568	406631'	200 01 0 00 000014'						6228
 11569						JUMPLE	AC1,L.449			; AC1,L.449				
 11570	406632'	323 01 0 00 406645'						6231
 11571	406633'	303 01 0 00 000005 		CAILE	AC1,5				; AC1,5
 11572	406634'	254 00 0 00 406645'		JRST	L.449				; L.449
 11573						SKIPG	RMSG%NAKS			; RMSG%NAKS				
 11574	406635'	337 00 0 00 406400*						6234
 11575	406636'	254 00 0 00 406661'		JRST	L.451				; L.451
 11576						PUSH	SP,C.117			; SP,[0,,P.ABC]				
 11577	406637'	261 17 0 00 406704'						6237
 11578	406640'	260 17 0 00 406630*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
 11579						PUSH	SP,RMSG%NAKS			; SP,RMSG%NAKS				
 11580	406641'	261 17 0 00 406635*						6238
 11581	406642'	260 17 0 00 406616*		PUSHJ	SP,TT%NUMBER			; SP,TT%NUMBER
 11582						PUSH	SP,C.118			; SP,[0,,P.ABD]				
 11583	406643'	261 17 0 00 406705'						6239
 11584	406644'	254 00 0 00 406657'		JRST	L.450				; L.450
 11585					L.449:	CAIL	AC1,6				; AC1,6					
 11586	406645'	301 01 0 00 000006 						6244
 11587	406646'	303 01 0 00 000010 		CAILE	AC1,10				; AC1,10
 11588	406647'	254 00 0 00 406661'		JRST	L.451				; L.451
 11589						SKIPG	SMSG%NAKS			; SMSG%NAKS				
 11590	406650'	337 00 0 00 406376*						6247
 11591	406651'	254 00 0 00 406661'		JRST	L.451				; L.451
 11592						PUSH	SP,C.119			; SP,[0,,P.ABE]				
 11593	406652'	261 17 0 00 406706'						6250
 11594	406653'	260 17 0 00 406640*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
 11595						PUSH	SP,SMSG%NAKS			; SP,SMSG%NAKS				
 11596	406654'	261 17 0 00 406650*						6251
 11597	406655'	260 17 0 00 406642*		PUSHJ	SP,TT%NUMBER			; SP,TT%NUMBER
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-213
KERMSG	MAC	18-Jan-73 17:20	

 11598						PUSH	SP,C.120			; SP,[0,,P.ABF]				
 11599	406656'	261 17 0 00 406707'						6252
 11600	406657'	260 17 0 00 406653*	L.450:	PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
 11601						ADJSP	SP,-3				; SP,-3					
 11602	406660'	105 17 0 00 777775 						6249
 11603					L.451:	PUSH	SP,C.121			; SP,[135]				
 11604	406661'	261 17 0 00 406710'						6258
 11605	406662'	260 17 0 00 406531*		PUSHJ	SP,TT%CHAR			; SP,TT%CHAR
 11606						PUSHJ	SP,TT%CRLF			; SP,TT%CRLF				
 11607	406663'	260 17 0 00 405176*						6259
 11608						ADJSP	SP,-3				; SP,-3					
 11609	406664'	105 17 0 00 777775 						6168
 11610						POPJ	SP,				; SP,					
 11611	406665'	263 17 0 00 000000 						6130
 11612	406666'	000000	000133		C.103:	EXP	133				; 133
 11613	406667'	000000	406515'		C.104:	XWD	0,P.ABB				; 0,P.ABB
 11614	406670'	000000	406406'		C.105:	XWD	0,P.AAP				; 0,P.AAP
 11615	406671'	000000	406412'		C.106:	XWD	0,P.AAQ				; 0,P.AAQ
 11616	406672'	000000	406421'		C.107:	XWD	0,P.AAR				; 0,P.AAR
 11617	406673'	000000	406430'		C.108:	XWD	0,P.AAS				; 0,P.AAS
 11618	406674'	000000	406440'		C.109:	XWD	0,P.AAT				; 0,P.AAT
 11619	406675'	000000	406446'		C.110:	XWD	0,P.AAU				; 0,P.AAU
 11620	406676'	000000	406452'		C.111:	XWD	0,P.AAV				; 0,P.AAV
 11621	406677'	000000	406460'		C.112:	XWD	0,P.AAW				; 0,P.AAW
 11622	406700'	000000	406466'		C.113:	XWD	0,P.AAX				; 0,P.AAX
 11623	406701'	000000	406476'		C.114:	XWD	0,P.AAY				; 0,P.AAY
 11624	406702'	000000	406505'		C.115:	XWD	0,P.AAZ				; 0,P.AAZ
 11625	406703'	000000	406511'		C.116:	XWD	0,P.ABA				; 0,P.ABA
 11626	406704'	000000	406520'		C.117:	XWD	0,P.ABC				; 0,P.ABC
 11627	406705'	000000	406521'		C.118:	XWD	0,P.ABD				; 0,P.ABD
 11628	406706'	000000	406524'		C.119:	XWD	0,P.ABE				; 0,P.ABE
 11629	406707'	000000	406525'		C.120:	XWD	0,P.ABF				; 0,P.ABF
 11630	406710'	000000	000135		C.121:	EXP	135				; 135
 11631
 11632					; Routine Size:  113 words
 11633
 11634
 11635					;   6261  1	%SBTTL 'TYPE%CHAR - Type out a character'
 11636					;   6262  1	ROUTINE TYPE%CHAR (CHARACTER) =
 11637					;   6263  1	
 11638					;   6264  1	!++
 11639					;   6265  1	! FUNCTIONAL DESCRIPTION:
 11640					;   6266  1	!
 11641					;   6267  1	! This routine is used as an alternate output routine for BFR%EMPTY.
 11642					;   6268  1	! It will type the character on the terminal, and always return a
 11643					;   6269  1	! true status.
 11644					;   6270  1	!
 11645					;   6271  1	! CALLING SEQUENCE:
 11646					;   6272  1	!
 11647					;   6273  1	!	STATUS = TYPE%CHAR (.CHARACTER);
 11648					;   6274  1	!
 11649					;   6275  1	! INPUT PARAMETERS:
 11650					;   6276  1	!
 11651					;   6277  1	!	CHARACTER - The character to type
 11652					;   6278  1	!
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-214
KERMSG	MAC	18-Jan-73 17:20	

 11653					;   6279  1	! IMPLICIT INPUTS:
 11654					;   6280  1	!
 11655					;   6281  1	!	None.
 11656					;   6282  1	!
 11657					;   6283  1	! OUPTUT PARAMETERS:
 11658					;   6284  1	!
 11659					;   6285  1	!	None.
 11660					;   6286  1	!
 11661					;   6287  1	! IMPLICIT OUTPUTS:
 11662					;   6288  1	!
 11663					;   6289  1	!	None.
 11664					;   6290  1	!
 11665					;   6291  1	! COMPLETION CODES:
 11666					;   6292  1	!
 11667					;   6293  1	!	None.
 11668					;   6294  1	!
 11669					;   6295  1	! SIDE EFFECTS:
 11670					;   6296  1	!
 11671					;   6297  1	!	None.
 11672					;   6298  1	!
 11673					;   6299  1	!--
 11674					;   6300  1	
 11675					;   6301  2	    BEGIN
 11676					;   6302  2	    TT%CHAR (.CHARACTER);			! Type the character
 11677					;   6303  2	    RETURN KER%NORMAL;				! And return OK
 11678					;   6304  1	    END;					! End of TYPE%CHAR
 11679
 11680
 11681					; TYPE%CHAR
 11682					U.31:	PUSH	SP,-1(SP)			; SP,CHARACTER				
 11683	406711'	261 17 0 17 777777 						6302
 11684	406712'	260 17 0 00 406662*		PUSHJ	SP,TT%CHAR			; SP,TT%CHAR
 11685						ADJSP	SP,-1				; SP,-1					
 11686	406713'	105 17 0 00 777777 						6303
 11687						MOVEI	AC1,13				; AC1,13				
 11688	406714'	201 01 0 00 000013 						6301
 11689						POPJ	SP,				; SP,					
 11690	406715'	263 17 0 00 000000 						6262
 11691
 11692					; Routine Size:  5 words
 11693
 11694
 11695					;   6305  1	%SBTTL 'Debugging -- DBG%SEND'
 11696					;   6306  1	ROUTINE DBG%SEND (ADDRESS, LENGTH) : NOVALUE =
 11697					;   6307  1	
 11698					;   6308  1	!++
 11699					;   6309  1	! FUNCTIONAL DESCRIPTION:
 11700					;   6310  1	!
 11701					;   6311  1	!	This routine will output the message that is going to be sent
 11702					;   6312  1	!	as part of the debugging information that is turned on in the
 11703					;   6313  1	!	SET DEBUG command.
 11704					;   6314  1	!
 11705					;   6315  1	! CALLING SEQUENCE:
 11706					;   6316  1	!
 11707					;   6317  1	!	DBG%SEND(MSG%ADDRESS, MSG%LENGTH);
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-215
KERMSG	MAC	18-Jan-73 17:20	

 11708					;   6318  1	!
 11709					;   6319  1	! INPUT PARAMETERS:
 11710					;   6320  1	!
 11711					;   6321  1	!	MSG%ADDRESS - Address of the message that is going to be sent
 11712					;   6322  1	!		to the remote KERMIT.  The bytes are CHR%SIZE.
 11713					;   6323  1	!	MSG%LENGTH - Length of the message.
 11714					;   6324  1	!
 11715					;   6325  1	! IMPLICIT INPUTS:
 11716					;   6326  1	!
 11717					;   6327  1	!	None.
 11718					;   6328  1	!
 11719					;   6329  1	! OUTPUT PARAMETERS:
 11720					;   6330  1	!
 11721					;   6331  1	!	None.
 11722					;   6332  1	!
 11723					;   6333  1	! IMPLICIT OUTPUTS:
 11724					;   6334  1	!
 11725					;   6335  1	!	None.
 11726					;   6336  1	!
 11727					;   6337  1	! COMPLETION CODES:
 11728					;   6338  1	!
 11729					;   6339  1	!	None.
 11730					;   6340  1	!
 11731					;   6341  1	! SIDE EFFECTS:
 11732					;   6342  1	!
 11733					;   6343  1	!	None.
 11734					;   6344  1	!
 11735					;   6345  1	!--
 11736					;   6346  1	
 11737					;   6347  2	    BEGIN
 11738					;   6348  2	
 11739					;   6349  2	    BIND
 11740					;   6350  2		SEND%TEXT = UPLIT (%ASCIZ'Sending...');
 11741					;   6351  2	
 11742					;   6352  2	    IF .DEBUG%FLAG
 11743					;   6353  2	    THEN
 11744					;   6354  3		BEGIN
 11745					;   6355  3	
 11746					;   6356  3		LOCAL
 11747					;   6357  3		    OLD%RTN;
 11748					;   6358  3	
 11749					;   6359  3		OLD%RTN = TT%SET%OUTPUT (DBG%DUMP);
 11750					;   6360  3		TT%TEXT (SEND%TEXT);
 11751					;   6361  3		DBG%MESSAGE (.ADDRESS, .LENGTH);
 11752					;   6362  3		TT%SET%OUTPUT (.OLD%RTN);
 11753					;   6363  2		END;
 11754					;   6364  2	
 11755					;   6365  1	    END;					! End of DBG%SEND
 11756
 11757
 11758	406716'	123 145 156 144 151 0 	P.ABG:	BYTE	(7)"S","e","n","d","i"		; Sendi
 11759	406717'	156 147 056 056 056 0 		BYTE	(7)"n","g",".",".","."		; ng...
 11760	406720'	000 000 000 000 000 0 		BYTE	(7)000,000,000,000,000
 11761
 11762
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-216
KERMSG	MAC	18-Jan-73 17:20	

 11763					; SEND%TEXT
 11764			406716'		U.100=		    P.ABG
 11765
 11766
 11767					; DBG%SEND
 11768					U.35:	PUSH	SP,AC16				; SP,AC16				
 11769	406721'	261 17 0 00 000016 						6306
 11770						MOVEI	AC1,1				; AC1,1					
 11771	406722'	201 01 0 00 000001 						6352
 11772	406723'	616 01 0 00 404722*		TDNN	AC1,DEBUG%FLAG			; AC1,DEBUG%FLAG
 11773	406724'	254 00 0 00 406740'		JRST	L.452				; L.452
 11774						PUSH	SP,C.91				; SP,[0,,DBG%DUMP]			
 11775	406725'	261 17 0 00 405206'						6359
 11776	406726'	260 17 0 00 404733*		PUSHJ	SP,TT%SET%OUTPUT		; SP,TT%SET%OUTPUT
 11777	406727'	200 16 0 00 000001 		MOVE	AC16,AC1			; OLD%RTN,AC1
 11778						PUSH	SP,C.122			; SP,[0,,SEND%TEXT]			
 11779	406730'	261 17 0 00 406742'						6360
 11780	406731'	260 17 0 00 406657*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
 11781						PUSH	SP,-5(SP)			; SP,ADDRESS				
 11782	406732'	261 17 0 17 777773 						6361
 11783	406733'	261 17 0 17 777773 		PUSH	SP,-5(SP)			; SP,LENGTH
 11784	406734'	260 17 0 00 407056'		PUSHJ	SP,U.34				; SP,DBG%MESSAGE
 11785						MOVEM	AC16,0(SP)			; OLD%RTN,0(SP)				
 11786	406735'	202 16 0 17 000000 						6362
 11787	406736'	260 17 0 00 406726*		PUSHJ	SP,TT%SET%OUTPUT		; SP,TT%SET%OUTPUT
 11788						ADJSP	SP,-4				; SP,-4					
 11789	406737'	105 17 0 00 777774 						6354
 11790					L.452:	POP	SP,AC16				; SP,AC16				
 11791	406740'	262 17 0 00 000016 						6306
 11792	406741'	263 17 0 00 000000 		POPJ	SP,				; SP,
 11793	406742'	000000	406716'		C.122:	XWD	0,U.100				; 0,SEND%TEXT
 11794
 11795					; Routine Size:  18 words
 11796
 11797
 11798					;   6366  1	%SBTTL 'Debugging -- DBG%RECEIVE'
 11799					;   6367  1	ROUTINE DBG%RECEIVE (ADDRESS) : NOVALUE =
 11800					;   6368  1	
 11801					;   6369  1	!++
 11802					;   6370  1	! FUNCTIONAL DESCRIPTION:
 11803					;   6371  1	!
 11804					;   6372  1	!	This routine will output the message that was received from
 11805					;   6373  1	!	the remote KERMIT.  This routine is called only if the DEBUG%FLAG
 11806					;   6374  1	!	is true.
 11807					;   6375  1	!
 11808					;   6376  1	! CALLING SEQUENCE:
 11809					;   6377  1	!
 11810					;   6378  1	!	DBG%RECEIVE(MSG%ADDRESS);
 11811					;   6379  1	!
 11812					;   6380  1	! INPUT PARAMETERS:
 11813					;   6381  1	!
 11814					;   6382  1	!	MSG%ADDRESS - Address of the message received by the remote KERMIT.
 11815					;   6383  1	!
 11816					;   6384  1	! IMPLICIT INPUTS:
 11817					;   6385  1	!
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-217
KERMSG	MAC	18-Jan-73 17:20	

 11818					;   6386  1	!	None.
 11819					;   6387  1	!
 11820					;   6388  1	! OUTPUT PARAMETERS:
 11821					;   6389  1	!
 11822					;   6390  1	!	None.
 11823					;   6391  1	!
 11824					;   6392  1	! IMPLICIT OUTPUTS:
 11825					;   6393  1	!
 11826					;   6394  1	!	None.
 11827					;   6395  1	!
 11828					;   6396  1	! COMPLETION CODES:
 11829					;   6397  1	!
 11830					;   6398  1	!	None.
 11831					;   6399  1	!
 11832					;   6400  1	! SIDE EFFECTS:
 11833					;   6401  1	!
 11834					;   6402  1	!	None.
 11835					;   6403  1	!
 11836					;   6404  1	!--
 11837					;   6405  1	
 11838					;   6406  2	    BEGIN
 11839					;   6407  2	
 11840					;   6408  2	    BIND
 11841					;   6409  2		RECEIVE%TEXT = UPLIT (%ASCIZ'Received...');
 11842					;   6410  2	
 11843					;   6411  2	    IF .DEBUG%FLAG
 11844					;   6412  2	    THEN
 11845					;   6413  3		BEGIN
 11846					;   6414  3	
 11847					;   6415  3		LOCAL
 11848					;   6416  3		    OLD%RTN;
 11849					;   6417  3	
 11850					;   6418  3		OLD%RTN = TT%SET%OUTPUT (DBG%DUMP);
 11851					;   6419  3		TT%TEXT (RECEIVE%TEXT);
 11852					;   6420  3		DBG%MESSAGE (.ADDRESS, .REC%LENGTH);
 11853					;   6421  3		TT%SET%OUTPUT (.OLD%RTN);
 11854					;   6422  2		END;
 11855					;   6423  2	
 11856					;   6424  1	    END;					! End of DBG%RECEIVE
 11857
 11858
 11859	406743'	122 145 143 145 151 0 	P.ABH:	BYTE	(7)"R","e","c","e","i"		; Recei
 11860	406744'	166 145 144 056 056 0 		BYTE	(7)"v","e","d",".","."		; ved..
 11861	406745'	056 000 000 000 000 0 		BYTE	(7)".",000,000,000,000		; .
 11862
 11863
 11864					; RECEIVE%TEXT
 11865			406743'		U.101=		    P.ABH
 11866
 11867
 11868					; DBG%RECEIVE
 11869					U.36:	PUSH	SP,AC16				; SP,AC16				
 11870	406746'	261 17 0 00 000016 						6367
 11871						MOVEI	AC1,1				; AC1,1					
 11872	406747'	201 01 0 00 000001 						6411
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-218
KERMSG	MAC	18-Jan-73 17:20	

 11873	406750'	616 01 0 00 406723*		TDNN	AC1,DEBUG%FLAG			; AC1,DEBUG%FLAG
 11874	406751'	254 00 0 00 406765'		JRST	L.453				; L.453
 11875						PUSH	SP,C.91				; SP,[0,,DBG%DUMP]			
 11876	406752'	261 17 0 00 405206'						6418
 11877	406753'	260 17 0 00 406736*		PUSHJ	SP,TT%SET%OUTPUT		; SP,TT%SET%OUTPUT
 11878	406754'	200 16 0 00 000001 		MOVE	AC16,AC1			; OLD%RTN,AC1
 11879						PUSH	SP,C.123			; SP,[0,,RECEIVE%TEXT]			
 11880	406755'	261 17 0 00 406767'						6419
 11881	406756'	260 17 0 00 406731*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
 11882						PUSH	SP,-4(SP)			; SP,ADDRESS				
 11883	406757'	261 17 0 17 777774 						6420
 11884	406760'	261 17 0 00 000022'		PUSH	SP,U.55				; SP,REC%LENGTH
 11885	406761'	260 17 0 00 407056'		PUSHJ	SP,U.34				; SP,DBG%MESSAGE
 11886						MOVEM	AC16,0(SP)			; OLD%RTN,0(SP)				
 11887	406762'	202 16 0 17 000000 						6421
 11888	406763'	260 17 0 00 406753*		PUSHJ	SP,TT%SET%OUTPUT		; SP,TT%SET%OUTPUT
 11889						ADJSP	SP,-4				; SP,-4					
 11890	406764'	105 17 0 00 777774 						6413
 11891					L.453:	POP	SP,AC16				; SP,AC16				
 11892	406765'	262 17 0 00 000016 						6367
 11893	406766'	263 17 0 00 000000 		POPJ	SP,				; SP,
 11894	406767'	000000	406743'		C.123:	XWD	0,U.101				; 0,RECEIVE%TEXT
 11895
 11896					; Routine Size:  18 words
 11897
 11898
 11899					;   6425  1	%SBTTL 'Debugging -- DBG%MESSAGE'
 11900					;   6426  1	ROUTINE DBG%MESSAGE (MSG%ADDRESS, MSG%LENGTH) : NOVALUE =
 11901					;   6427  1	
 11902					;   6428  1	!++
 11903					;   6429  1	! FUNCTIONAL DESCRIPTION:
 11904					;   6430  1	!
 11905					;   6431  1	!	This routine will display a message that is either being sent
 11906					;   6432  1	!	or received on the user's terminal.
 11907					;   6433  1	!
 11908					;   6434  1	! CALLING SEQUENCE:
 11909					;   6435  1	!
 11910					;   6436  1	!	DBG%MESSAGE(MSG%ADDRESS, MSG%LENGTH);
 11911					;   6437  1	!
 11912					;   6438  1	! INPUT PARAMETERS:
 11913					;   6439  1	!
 11914					;   6440  1	!	MSG%ADDRESS - Address of the message to be output
 11915					;   6441  1	!	MSG%LENGTH - Length of the message to be output.
 11916					;   6442  1	!
 11917					;   6443  1	! IMPLICIT INPUTS:
 11918					;   6444  1	!
 11919					;   6445  1	!	None.
 11920					;   6446  1	!
 11921					;   6447  1	! OUTPUT PARAMETERS:
 11922					;   6448  1	!
 11923					;   6449  1	!	None.
 11924					;   6450  1	!
 11925					;   6451  1	! IMPLICIT OUTPUTS:
 11926					;   6452  1	!
 11927					;   6453  1	!	None.
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-219
KERMSG	MAC	18-Jan-73 17:20	

 11928					;   6454  1	!
 11929					;   6455  1	! COMPLETION CODES:
 11930					;   6456  1	!
 11931					;   6457  1	!	None.
 11932					;   6458  1	!
 11933					;   6459  1	! SIDE EFFECTS:
 11934					;   6460  1	!
 11935					;   6461  1	!	None.
 11936					;   6462  1	!
 11937					;   6463  1	!--
 11938					;   6464  1	
 11939					;   6465  2	    BEGIN
 11940					;   6466  2	
 11941					;   6467  2	    MAP
 11942					;   6468  2		MSG%ADDRESS : REF VECTOR [CH$ALLOCATION (MAX%MSG, CHR%SIZE)];	! Po
 11943					int to the vector
 11944					;   6469  2	
 11945					;   6470  2	    LOCAL
 11946					;   6471  2		OLD%RTN,				! Old type out routine
 11947					;   6472  2		CHKSUM,					! Numeric value of block che
 11948					ck
 11949					;   6473  2		TEMP%POINTER,				! Temporary character pointe
 11950					r
 11951					;   6474  2		MSG%LEN;
 11952					;   6475  2	
 11953					;   6476  2	!
 11954					;   6477  2	! Message type text
 11955					;   6478  2	!
 11956					;   6479  2	
 11957					;   6480  2	    BIND
 11958					;   6481  2		DATA%TEXT = UPLIT (%ASCIZ' (Data)'),
 11959					;   6482  2		ACK%TEXT = UPLIT (%ASCIZ' (ACK)'),
 11960					;   6483  2		NAK%TEXT = UPLIT (%ASCIZ' (NAK)'),
 11961					;   6484  2		SND%INIT%TEXT = UPLIT (%ASCIZ' (Send init)'),
 11962					;   6485  2		BREAK%TEXT = UPLIT (%ASCIZ' (Break)'),
 11963					;   6486  2		TEXT%TEXT = UPLIT (%ASCIZ' (Text header)'),
 11964					;   6487  2		FILE%TEXT = UPLIT (%ASCIZ' (File header)'),
 11965					;   6488  2		EOF%TEXT = UPLIT (%ASCIZ' (EOF)'),
 11966					;   6489  2		ERROR%TEXT = UPLIT (%ASCIZ' (Error)'),
 11967					;   6490  2		RCV%INIT%TEXT = UPLIT (%ASCIZ' (Receive initiate)'),
 11968					;   6491  2		COMMAND%TEXT = UPLIT (%ASCIZ' (Command)'),
 11969					;   6492  2		KERMIT%TEXT = UPLIT (%ASCIZ' (Generic KERMIT command)');
 11970					;   6493  2	
 11971					;   6494  2	!
 11972					;   6495  2	! Header information
 11973					;   6496  2	!
 11974					;   6497  2	
 11975					;   6498  2	    BIND
 11976					;   6499  2		MN%TEXT = UPLIT (%ASCIZ'Message number: '),
 11977					;   6500  2		LENGTH%TEXT = UPLIT (%ASCIZ'	Length: '),
 11978					;   6501  2		DEC%TEXT = UPLIT (%ASCIZ' (dec)'),
 11979					;   6502  2		MSG%TYP%TEXT = UPLIT (%ASCIZ'Message type: '),
 11980					;   6503  2		CHKSUM%TEXT = UPLIT (%ASCIZ'Checksum: '),
 11981					;   6504  2		CHKSUM%NUM%TEXT = UPLIT (%ASCIZ' = '),
 11982					;   6505  2		OPT%DATA%TEXT = UPLIT (%ASCIZ'Optional data: '),
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-220
KERMSG	MAC	18-Jan-73 17:20	

 11983					;   6506  2		PRE%CHAR%TEXT = UPLIT (%ASCIZ' "');
 11984					;   6507  2	
 11985					;   6508  2	!
 11986					;   6509  2	! Ensure that the type out will go to the debugging location
 11987					;   6510  2	!
 11988					;   6511  2	    OLD%RTN = TT%SET%OUTPUT (DBG%DUMP);
 11989					;   6512  2	!
 11990					;   6513  2	! Preliminary calculations
 11991					;   6514  2	!
 11992					;   6515  2	    MSG%LEN = UNCHAR (CH$RCHAR (CH$PTR (.MSG%ADDRESS, PKT%COUNT, CHR%SIZE)))
 11993					;
 11994					;   6516  2	!
 11995					;   6517  2	! First output some header information for the packet.
 11996					;   6518  2	!
 11997					;   6519  2	    TT%CRLF ();
 11998					;   6520  2	    TT%TEXT (MN%TEXT);
 11999					;   6521  2	    TT%NUMBER (UNCHAR (CH$RCHAR (CH$PTR (.MSG%ADDRESS, PKT%SEQ, CHR%SIZE))))
 12000					;
 12001					;   6522  2	    TT%TEXT (DEC%TEXT);
 12002					;   6523  2	    TT%TEXT (LENGTH%TEXT);
 12003					;   6524  2	    TT%NUMBER (.MSG%LEN);
 12004					;   6525  2	    TT%TEXT (DEC%TEXT);
 12005					;   6526  2	    TT%CRLF ();
 12006					;   6527  2	!
 12007					;   6528  2	! Now output the message type and dependent information
 12008					;   6529  2	!
 12009					;   6530  2	    TT%TEXT (MSG%TYP%TEXT);
 12010					;   6531  2	    TT%CHAR (CH$RCHAR (CH$PTR (.MSG%ADDRESS, PKT%TYPE, CHR%SIZE)));
 12011					;   6532  2	
 12012					;   6533  2	    SELECTONE CH$RCHAR (CH$PTR (.MSG%ADDRESS, PKT%TYPE, CHR%SIZE)) OF
 12013					;   6534  2		SET
 12014					;   6535  2	
 12015					;   6536  2		[MSG%DATA] :
 12016					;   6537  2		    TT%TEXT (DATA%TEXT);
 12017					;   6538  2	
 12018					;   6539  2		[MSG%ACK] :
 12019					;   6540  2		    TT%TEXT (ACK%TEXT);
 12020					;   6541  2	
 12021					;   6542  2		[MSG%NAK] :
 12022					;   6543  2		    TT%TEXT (NAK%TEXT);
 12023					;   6544  2	
 12024					;   6545  2		[MSG%SND%INIT] :
 12025					;   6546  2		    TT%TEXT (SND%INIT%TEXT);
 12026					;   6547  2	
 12027					;   6548  2		[MSG%BREAK] :
 12028					;   6549  2		    TT%TEXT (BREAK%TEXT);
 12029					;   6550  2	
 12030					;   6551  2		[MSG%FILE] :
 12031					;   6552  2		    TT%TEXT (FILE%TEXT);
 12032					;   6553  2	
 12033					;   6554  2		[MSG%TEXT] :
 12034					;   6555  2		    TT%TEXT (TEXT%TEXT);
 12035					;   6556  2	
 12036					;   6557  2		[MSG%EOF] :
 12037					;   6558  2		    TT%TEXT (EOF%TEXT);
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-221
KERMSG	MAC	18-Jan-73 17:20	

 12038					;   6559  2	
 12039					;   6560  2		[MSG%ERROR] :
 12040					;   6561  2		    TT%TEXT (ERROR%TEXT);
 12041					;   6562  2	
 12042					;   6563  2		[MSG%GENERIC] :
 12043					;   6564  2		    TT%TEXT (KERMIT%TEXT);
 12044					;   6565  2	
 12045					;   6566  2		[MSG%COMMAND] :
 12046					;   6567  2		    TT%TEXT (COMMAND%TEXT);
 12047					;   6568  2		TES;
 12048					;   6569  2	
 12049					;   6570  2	    TT%CRLF ();
 12050					;   6571  2	!
 12051					;   6572  2	! Now output any of the optional data.
 12052					;   6573  2	!
 12053					;   6574  2	
 12054					;   6575  2	    IF .MSG%LEN - PKT%OVR%HEAD - (.BLK%CHK%TYPE - CHK%1CHAR) NEQ 0
 12055					;   6576  2	    THEN
 12056					;   6577  3		BEGIN
 12057					;   6578  3		TT%TEXT (OPT%DATA%TEXT);
 12058					;   6579  3		TT%CRLF ();
 12059					;   6580  3		TEMP%POINTER = CH$PTR (.MSG%ADDRESS, PKT%MSG, CHR%SIZE);
 12060					;   6581  3	
 12061					;   6582  3		INCR I FROM 1 TO .MSG%LEN - PKT%OVR%HEAD - (.BLK%CHK%TYPE - CHK%1CHA
 12062					R) DO
 12063					;   6583  4		    BEGIN
 12064					;   6584  4	
 12065					;   6585  4		    IF (.I MOD 10) EQL 1
 12066					;   6586  4		    THEN
 12067					;   6587  5			BEGIN
 12068					;   6588  5			TT%CRLF ();
 12069					;   6589  5			TT%CHAR (CHR%TAB);
 12070					;   6590  4			END;
 12071					;   6591  4	
 12072					;   6592  4		    TT%TEXT (PRE%CHAR%TEXT);
 12073					;   6593  4		    TT%CHAR (CH$RCHAR%A (TEMP%POINTER));
 12074					;   6594  4		    TT%CHAR (%C'"');
 12075					;   6595  3		    END;
 12076					;   6596  3	
 12077					;   6597  3		IF ((.MSG%LEN - PKT%OVR%HEAD - (.BLK%CHK%TYPE - CHK%1CHAR)) MOD 10) 
 12078					EQL 1 THEN TT%CRLF ();
 12079					;   6598  3	
 12080					;   6599  3		TT%CRLF ();
 12081					;   6600  2		END;
 12082					;   6601  2	
 12083					;   6602  2	!
 12084					;   6603  2	! Now output the checksum for the message that we received
 12085					;   6604  2	!
 12086					;   6605  2	! This could be either 1 two or three characters.
 12087					;   6606  2	    TT%TEXT (CHKSUM%TEXT);
 12088					;   6607  2	    TEMP%POINTER = CH$PTR (.MSG%ADDRESS,
 12089					;   6608  2		PKT%MSG + .MSG%LEN + PKT%CHKSUM - PKT%OVR%HEAD - (.BLK%CHK%TYPE - CH
 12090					K%1CHAR), CHR%SIZE);
 12091					;   6609  2	
 12092					;   6610  2	    CASE .BLK%CHK%TYPE FROM CHK%1CHAR TO CHK%CRC OF
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-222
KERMSG	MAC	18-Jan-73 17:20	

 12093					;   6611  2		SET
 12094					;   6612  2	
 12095					;   6613  2		[CHK%1CHAR] :
 12096					;   6614  3		    BEGIN
 12097					;   6615  3		    TT%TEXT (PRE%CHAR%TEXT);
 12098					;   6616  3		    TT%CHAR (CH$RCHAR (.TEMP%POINTER));
 12099					;   6617  3		    TT%CHAR (%C'"');
 12100					;   6618  3		    CHKSUM = UNCHAR (CH$RCHAR (.TEMP%POINTER));
 12101					;   6619  2		    END;
 12102					;   6620  2	
 12103					;   6621  2		[CHK%2CHAR] :
 12104					;   6622  3		    BEGIN
 12105					;   6623  3		    CHKSUM = 0;
 12106					;   6624  3		    TT%TEXT (PRE%CHAR%TEXT);
 12107					;   6625  3		    TT%CHAR (CH$RCHAR (.TEMP%POINTER));
 12108					;   6626  3		    TT%CHAR (%C'"');
 12109					;   6627  3		    CHKSUM<6, 6> = UNCHAR (CH$RCHAR%A (TEMP%POINTER));
 12110					;   6628  3		    TT%TEXT (PRE%CHAR%TEXT);
 12111					;   6629  3		    TT%CHAR (CH$RCHAR (.TEMP%POINTER));
 12112					;   6630  3		    TT%CHAR (%C'"');
 12113					;   6631  3		    CHKSUM<0, 6> = UNCHAR (CH$RCHAR (.TEMP%POINTER));
 12114					;   6632  2		    END;
 12115					;   6633  2	
 12116					;   6634  2		[CHK%CRC] :
 12117					;   6635  3		    BEGIN
 12118					;   6636  3		    CHKSUM = 0;
 12119					;   6637  3		    TT%TEXT (PRE%CHAR%TEXT);
 12120					;   6638  3		    TT%CHAR (CH$RCHAR (.TEMP%POINTER));
 12121					;   6639  3		    TT%CHAR (%C'"');
 12122					;   6640  3		    CHKSUM<12, 4> = UNCHAR (CH$RCHAR%A (TEMP%POINTER));
 12123					;   6641  3		    TT%TEXT (PRE%CHAR%TEXT);
 12124					;   6642  3		    TT%CHAR (CH$RCHAR (.TEMP%POINTER));
 12125					;   6643  3		    TT%CHAR (%C'"');
 12126					;   6644  3		    CHKSUM<6, 6> = UNCHAR (CH$RCHAR%A (TEMP%POINTER));
 12127					;   6645  3		    TT%TEXT (PRE%CHAR%TEXT);
 12128					;   6646  3		    TT%CHAR (CH$RCHAR (.TEMP%POINTER));
 12129					;   6647  3		    TT%CHAR (%C'"');
 12130					;   6648  3		    CHKSUM<0, 6> = UNCHAR (CH$RCHAR (.TEMP%POINTER));
 12131					;   6649  2		    END;
 12132					;   6650  2		TES;
 12133					;   6651  2	
 12134					;   6652  2	    TT%TEXT (CHKSUM%NUM%TEXT);
 12135					;   6653  2	    TT%NUMBER (.CHKSUM);
 12136					;   6654  2	    TT%TEXT (DEC%TEXT);
 12137					;   6655  2	    TT%CRLF ();
 12138					;   6656  2	    TT%SET%OUTPUT (.OLD%RTN);			! Reset output destination
 12139					;   6657  1	    END;					! End of DBG%MESSAGE
 12140
 12141
 12142	406770'	040 050 104 141 164 0 	P.ABI:	BYTE	(7)" ","(","D","a","t"		;  (Dat
 12143	406771'	141 051 000 000 000 0 		BYTE	(7)"a",")",000,000,000		; a)
 12144	406772'	040 050 101 103 113 0 	P.ABJ:	BYTE	(7)" ","(","A","C","K"		;  (ACK
 12145	406773'	051 000 000 000 000 0 		BYTE	(7)")",000,000,000,000		; )
 12146	406774'	040 050 116 101 113 0 	P.ABK:	BYTE	(7)" ","(","N","A","K"		;  (NAK
 12147	406775'	051 000 000 000 000 0 		BYTE	(7)")",000,000,000,000		; )
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-223
KERMSG	MAC	18-Jan-73 17:20	

 12148	406776'	040 050 123 145 156 0 	P.ABL:	BYTE	(7)" ","(","S","e","n"		;  (Sen
 12149	406777'	144 040 151 156 151 0 		BYTE	(7)"d"," ","i","n","i"		; d ini
 12150	407000'	164 051 000 000 000 0 		BYTE	(7)"t",")",000,000,000		; t)
 12151	407001'	040 050 102 162 145 0 	P.ABM:	BYTE	(7)" ","(","B","r","e"		;  (Bre
 12152	407002'	141 153 051 000 000 0 		BYTE	(7)"a","k",")",000,000		; ak)
 12153	407003'	040 050 124 145 170 0 	P.ABN:	BYTE	(7)" ","(","T","e","x"		;  (Tex
 12154	407004'	164 040 150 145 141 0 		BYTE	(7)"t"," ","h","e","a"		; t hea
 12155	407005'	144 145 162 051 000 0 		BYTE	(7)"d","e","r",")",000		; der)
 12156	407006'	040 050 106 151 154 0 	P.ABO:	BYTE	(7)" ","(","F","i","l"		;  (Fil
 12157	407007'	145 040 150 145 141 0 		BYTE	(7)"e"," ","h","e","a"		; e hea
 12158	407010'	144 145 162 051 000 0 		BYTE	(7)"d","e","r",")",000		; der)
 12159	407011'	040 050 105 117 106 0 	P.ABP:	BYTE	(7)" ","(","E","O","F"		;  (EOF
 12160	407012'	051 000 000 000 000 0 		BYTE	(7)")",000,000,000,000		; )
 12161	407013'	040 050 105 162 162 0 	P.ABQ:	BYTE	(7)" ","(","E","r","r"		;  (Err
 12162	407014'	157 162 051 000 000 0 		BYTE	(7)"o","r",")",000,000		; or)
 12163	407015'	040 050 122 145 143 0 	P.ABR:	BYTE	(7)" ","(","R","e","c"		;  (Rec
 12164	407016'	145 151 166 145 040 0 		BYTE	(7)"e","i","v","e"," "		; eive
 12165	407017'	151 156 151 164 151 0 		BYTE	(7)"i","n","i","t","i"		; initi
 12166	407020'	141 164 145 051 000 0 		BYTE	(7)"a","t","e",")",000		; ate)
 12167	407021'	040 050 103 157 155 0 	P.ABS:	BYTE	(7)" ","(","C","o","m"		;  (Com
 12168	407022'	155 141 156 144 051 0 		BYTE	(7)"m","a","n","d",")"		; mand)
 12169	407023'	000 000 000 000 000 0 		BYTE	(7)000,000,000,000,000
 12170	407024'	040 050 107 145 156 0 	P.ABT:	BYTE	(7)" ","(","G","e","n"		;  (Gen
 12171	407025'	145 162 151 143 040 0 		BYTE	(7)"e","r","i","c"," "		; eric
 12172	407026'	113 105 122 115 111 0 		BYTE	(7)"K","E","R","M","I"		; KERMI
 12173	407027'	124 040 143 157 155 0 		BYTE	(7)"T"," ","c","o","m"		; T com
 12174	407030'	155 141 156 144 051 0 		BYTE	(7)"m","a","n","d",")"		; mand)
 12175	407031'	000 000 000 000 000 0 		BYTE	(7)000,000,000,000,000
 12176	407032'	115 145 163 163 141 0 	P.ABU:	BYTE	(7)"M","e","s","s","a"		; Messa
 12177	407033'	147 145 040 156 165 0 		BYTE	(7)"g","e"," ","n","u"		; ge nu
 12178	407034'	155 142 145 162 072 0 		BYTE	(7)"m","b","e","r",":"		; mber:
 12179	407035'	040 000 000 000 000 0 		BYTE	(7)" ",000,000,000,000
 12180	407036'	011 114 145 156 147 0 	P.ABV:	BYTE	(7)011,"L","e","n","g"		;  Leng
 12181	407037'	164 150 072 040 000 0 		BYTE	(7)"t","h",":"," ",000		; th:
 12182	407040'	040 050 144 145 143 0 	P.ABW:	BYTE	(7)" ","(","d","e","c"		;  (dec
 12183	407041'	051 000 000 000 000 0 		BYTE	(7)")",000,000,000,000		; )
 12184	407042'	115 145 163 163 141 0 	P.ABX:	BYTE	(7)"M","e","s","s","a"		; Messa
 12185	407043'	147 145 040 164 171 0 		BYTE	(7)"g","e"," ","t","y"		; ge ty
 12186	407044'	160 145 072 040 000 0 		BYTE	(7)"p","e",":"," ",000		; pe:
 12187	407045'	103 150 145 143 153 0 	P.ABY:	BYTE	(7)"C","h","e","c","k"		; Check
 12188	407046'	163 165 155 072 040 0 		BYTE	(7)"s","u","m",":"," "		; sum:
 12189	407047'	000 000 000 000 000 0 		BYTE	(7)000,000,000,000,000
 12190	407050'	040 075 040 000 000 0 	P.ABZ:	BYTE	(7)" ","="," ",000,000		;  =
 12191	407051'	117 160 164 151 157 0 	P.ACA:	BYTE	(7)"O","p","t","i","o"		; Optio
 12192	407052'	156 141 154 040 144 0 		BYTE	(7)"n","a","l"," ","d"		; nal d
 12193	407053'	141 164 141 072 040 0 		BYTE	(7)"a","t","a",":"," "		; ata:
 12194	407054'	000 000 000 000 000 0 		BYTE	(7)000,000,000,000,000
 12195	407055'	040 042 000 000 000 0 	P.ACB:	BYTE	(7)" ",042,000,000,000		;  "
 12196
 12197
 12198					; DATA%TEXT
 12199			406770'		U.103=		    P.ABI
 12200					; ACK%TEXT
 12201			406772'		U.104=		    P.ABJ
 12202					; NAK%TEXT
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-224
KERMSG	MAC	18-Jan-73 17:20	

 12203			406774'		U.105=		    P.ABK
 12204					; SND%INIT%TEXT
 12205			406776'		U.106=		    P.ABL
 12206					; BREAK%TEXT
 12207			407001'		U.107=		    P.ABM
 12208					; TEXT%TEXT
 12209			407003'		U.108=		    P.ABN
 12210					; FILE%TEXT
 12211			407006'		U.109=		    P.ABO
 12212					; EOF%TEXT
 12213			407011'		U.110=		    P.ABP
 12214					; ERROR%TEXT
 12215			407013'		U.111=		    P.ABQ
 12216					; RCV%INIT%TEXT
 12217			407015'		U.112=		    P.ABR
 12218					; COMMAND%TEXT
 12219			407021'		U.113=		    P.ABS
 12220					; KERMIT%TEXT
 12221			407024'		U.114=		    P.ABT
 12222					; MN%TEXT
 12223			407032'		U.115=		    P.ABU
 12224					; LENGTH%TEXT
 12225			407036'		U.116=		    P.ABV
 12226					; DEC%TEXT
 12227			407040'		U.117=		    P.ABW
 12228					; MSG%TYP%TEXT
 12229			407042'		U.118=		    P.ABX
 12230					; CHKSUM%TEXT
 12231			407045'		U.119=		    P.ABY
 12232					; CHKSUM%NUM%TEXT
 12233			407050'		U.120=		    P.ABZ
 12234					; OPT%DATA%TEXT
 12235			407051'		U.121=		    P.ACA
 12236					; PRE%CHAR%TEXT
 12237			407055'		U.122=		    P.ACB
 12238
 12239
 12240					; DBG%MESSAGE
 12241					U.34:	PUSH	SP,AC0				; SP,AC0				
 12242	407056'	261 17 0 00 000000 						6426
 12243	407057'	261 17 0 00 000010 		PUSH	SP,AC10				; SP,AC10
 12244	407060'	261 17 0 00 000011 		PUSH	SP,AC11				; SP,AC11
 12245	407061'	261 17 0 00 000012 		PUSH	SP,AC12				; SP,AC12
 12246	407062'	261 17 0 00 000013 		PUSH	SP,AC13				; SP,AC13
 12247	407063'	261 17 0 00 000014 		PUSH	SP,AC14				; SP,AC14
 12248	407064'	261 17 0 00 000016 		PUSH	SP,AC16				; SP,AC16
 12249						PUSH	SP,C.91				; SP,[0,,DBG%DUMP]			
 12250	407065'	261 17 0 00 405206'						6511
 12251	407066'	260 17 0 00 406763*		PUSHJ	SP,TT%SET%OUTPUT		; SP,TT%SET%OUTPUT
 12252	407067'	200 00 0 00 000001 		MOVE	AC0,AC1				; OLD%RTN,AC1
 12253						MOVE	AC12,-12(SP)			; AC12,MSG%ADDRESS			
 12254	407070'	200 12 0 17 777766 						6515
 12255	407071'	201 01 0 12 000000 		MOVEI	AC1,0(AC12)			; AC1,0(AC12)
 12256	407072'	505 01 0 00 341000 		HRLI	AC1,341000			; AC1,341000
 12257	407073'	134 02 0 00 000001 		ILDB	AC2,AC1				; AC2,AC1
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-225
KERMSG	MAC	18-Jan-73 17:20	

 12258	407074'	200 14 0 00 000002 		MOVE	AC14,AC2			; MSG%LEN,AC2
 12259	407075'	275 14 0 00 000040 		SUBI	AC14,40				; MSG%LEN,40
 12260						PUSHJ	SP,TT%CRLF			; SP,TT%CRLF				
 12261	407076'	260 17 0 00 406663*						6519
 12262						PUSH	SP,C.127			; SP,[0,,MN%TEXT]			
 12263	407077'	261 17 0 00 407441'						6520
 12264	407100'	260 17 0 00 406756*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
 12265						MOVEI	AC1,0(AC12)			; AC1,0(AC12)				
 12266	407101'	201 01 0 12 000000 						6521
 12267	407102'	505 01 0 00 241000 		HRLI	AC1,241000			; AC1,241000
 12268	407103'	134 01 0 00 000001 		ILDB	AC1,AC1				; AC1,AC1
 12269	407104'	275 01 0 00 000040 		SUBI	AC1,40				; AC1,40
 12270	407105'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
 12271	407106'	260 17 0 00 406655*		PUSHJ	SP,TT%NUMBER			; SP,TT%NUMBER
 12272						PUSH	SP,C.128			; SP,[0,,DEC%TEXT]			
 12273	407107'	261 17 0 00 407442'						6522
 12274	407110'	260 17 0 00 407100*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
 12275						PUSH	SP,C.129			; SP,[0,,LENGTH%TEXT]			
 12276	407111'	261 17 0 00 407443'						6523
 12277	407112'	260 17 0 00 407110*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
 12278						MOVEM	AC14,0(SP)			; MSG%LEN,0(SP)				
 12279	407113'	202 14 0 17 000000 						6524
 12280	407114'	260 17 0 00 407106*		PUSHJ	SP,TT%NUMBER			; SP,TT%NUMBER
 12281						PUSH	SP,C.128			; SP,[0,,DEC%TEXT]			
 12282	407115'	261 17 0 00 407442'						6525
 12283	407116'	260 17 0 00 407112*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
 12284						PUSHJ	SP,TT%CRLF			; SP,TT%CRLF				
 12285	407117'	260 17 0 00 407076*						6526
 12286						PUSH	SP,C.130			; SP,[0,,MSG%TYP%TEXT]			
 12287	407120'	261 17 0 00 407444'						6530
 12288	407121'	260 17 0 00 407116*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
 12289						MOVEI	AC1,0(AC12)			; AC1,0(AC12)				
 12290	407122'	201 01 0 12 000000 						6531
 12291	407123'	505 01 0 00 141000 		HRLI	AC1,141000			; AC1,141000
 12292	407124'	134 01 0 00 000001 		ILDB	AC1,AC1				; AC1,AC1
 12293	407125'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
 12294	407126'	260 17 0 00 406712*		PUSHJ	SP,TT%CHAR			; SP,TT%CHAR
 12295						MOVEI	AC1,0(AC12)			; AC1,0(AC12)				
 12296	407127'	201 01 0 12 000000 						6533
 12297	407130'	505 01 0 00 141000 		HRLI	AC1,141000			; AC1,141000
 12298	407131'	134 16 0 00 000001 		ILDB	AC16,AC1			; AC16,AC1
 12299						CAIE	AC16,104			; AC16,104				
 12300	407132'	302 16 0 00 000104 						6536
 12301	407133'	254 00 0 00 407136'		JRST	L.454				; L.454
 12302						PUSH	SP,C.131			; SP,[0,,DATA%TEXT]			
 12303	407134'	261 17 0 00 407445'						6537
 12304	407135'	254 00 0 00 407205'		JRST	L.464				; L.464
 12305					L.454:	CAIE	AC16,131			; AC16,131				
 12306	407136'	302 16 0 00 000131 						6539
 12307	407137'	254 00 0 00 407142'		JRST	L.455				; L.455
 12308						PUSH	SP,C.132			; SP,[0,,ACK%TEXT]			
 12309	407140'	261 17 0 00 407446'						6540
 12310	407141'	254 00 0 00 407205'		JRST	L.464				; L.464
 12311					L.455:	CAIE	AC16,116			; AC16,116				
 12312	407142'	302 16 0 00 000116 						6542
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-226
KERMSG	MAC	18-Jan-73 17:20	

 12313	407143'	254 00 0 00 407146'		JRST	L.456				; L.456
 12314						PUSH	SP,C.133			; SP,[0,,NAK%TEXT]			
 12315	407144'	261 17 0 00 407447'						6543
 12316	407145'	254 00 0 00 407205'		JRST	L.464				; L.464
 12317					L.456:	CAIE	AC16,123			; AC16,123				
 12318	407146'	302 16 0 00 000123 						6545
 12319	407147'	254 00 0 00 407152'		JRST	L.457				; L.457
 12320						PUSH	SP,C.134			; SP,[0,,SND%INIT%TEXT]			
 12321	407150'	261 17 0 00 407450'						6546
 12322	407151'	254 00 0 00 407205'		JRST	L.464				; L.464
 12323					L.457:	CAIE	AC16,102			; AC16,102				
 12324	407152'	302 16 0 00 000102 						6548
 12325	407153'	254 00 0 00 407156'		JRST	L.458				; L.458
 12326						PUSH	SP,C.135			; SP,[0,,BREAK%TEXT]			
 12327	407154'	261 17 0 00 407451'						6549
 12328	407155'	254 00 0 00 407205'		JRST	L.464				; L.464
 12329					L.458:	CAIE	AC16,106			; AC16,106				
 12330	407156'	302 16 0 00 000106 						6551
 12331	407157'	254 00 0 00 407162'		JRST	L.459				; L.459
 12332						PUSH	SP,C.136			; SP,[0,,FILE%TEXT]			
 12333	407160'	261 17 0 00 407452'						6552
 12334	407161'	254 00 0 00 407205'		JRST	L.464				; L.464
 12335					L.459:	CAIE	AC16,130			; AC16,130				
 12336	407162'	302 16 0 00 000130 						6554
 12337	407163'	254 00 0 00 407166'		JRST	L.460				; L.460
 12338						PUSH	SP,C.137			; SP,[0,,TEXT%TEXT]			
 12339	407164'	261 17 0 00 407453'						6555
 12340	407165'	254 00 0 00 407205'		JRST	L.464				; L.464
 12341					L.460:	CAIE	AC16,132			; AC16,132				
 12342	407166'	302 16 0 00 000132 						6557
 12343	407167'	254 00 0 00 407172'		JRST	L.461				; L.461
 12344						PUSH	SP,C.138			; SP,[0,,EOF%TEXT]			
 12345	407170'	261 17 0 00 407454'						6558
 12346	407171'	254 00 0 00 407205'		JRST	L.464				; L.464
 12347					L.461:	CAIE	AC16,105			; AC16,105				
 12348	407172'	302 16 0 00 000105 						6560
 12349	407173'	254 00 0 00 407176'		JRST	L.462				; L.462
 12350						PUSH	SP,C.139			; SP,[0,,ERROR%TEXT]			
 12351	407174'	261 17 0 00 407455'						6561
 12352	407175'	254 00 0 00 407205'		JRST	L.464				; L.464
 12353					L.462:	CAIE	AC16,107			; AC16,107				
 12354	407176'	302 16 0 00 000107 						6563
 12355	407177'	254 00 0 00 407202'		JRST	L.463				; L.463
 12356						PUSH	SP,C.140			; SP,[0,,KERMIT%TEXT]			
 12357	407200'	261 17 0 00 407456'						6564
 12358	407201'	254 00 0 00 407205'		JRST	L.464				; L.464
 12359					L.463:	CAIE	AC16,103			; AC16,103				
 12360	407202'	302 16 0 00 000103 						6566
 12361	407203'	254 00 0 00 407207'		JRST	L.465				; L.465
 12362						PUSH	SP,C.141			; SP,[0,,COMMAND%TEXT]			
 12363	407204'	261 17 0 00 407457'						6567
 12364	407205'	260 17 0 00 407121*	L.464:	PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
 12365	407206'	105 17 0 00 777777 		ADJSP	SP,-1				; SP,-1
 12366					L.465:	PUSHJ	SP,TT%CRLF			; SP,TT%CRLF				
 12367	407207'	260 17 0 00 407117*						6570
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-227
KERMSG	MAC	18-Jan-73 17:20	

 12368						MOVE	AC11,AC14			; AC11,MSG%LEN				
 12369	407210'	200 11 0 00 000014 						6575
 12370	407211'	275 11 0 00 000003 		SUBI	AC11,3				; AC11,3
 12371	407212'	200 01 0 00 000011'		MOVE	AC1,U.46			; AC1,BLK%CHK%TYPE
 12372	407213'	275 01 0 00 000061 		SUBI	AC1,61				; AC1,61
 12373	407214'	316 11 0 00 000001 		CAMN	AC11,AC1			; AC11,AC1
 12374	407215'	254 00 0 00 407265'		JRST	L.469				; L.469
 12375						PUSH	SP,C.142			; SP,[0,,OPT%DATA%TEXT]			
 12376	407216'	261 17 0 00 407460'						6578
 12377	407217'	260 17 0 00 407205*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
 12378						PUSHJ	SP,TT%CRLF			; SP,TT%CRLF				
 12379	407220'	260 17 0 00 407207*						6579
 12380						MOVEI	AC16,0(AC12)			; AC16,0(AC12)				
 12381	407221'	201 16 0 12 000000 						6580
 12382	407222'	505 16 0 00 041000 		HRLI	AC16,41000			; AC16,41000
 12383						MOVE	AC2,AC11			; AC2,AC11				
 12384	407223'	200 02 0 00 000011 						6582
 12385	407224'	274 02 0 00 000011'		SUB	AC2,U.46			; AC2,BLK%CHK%TYPE
 12386	407225'	200 10 0 00 000002 		MOVE	AC10,AC2			; AC10,AC2
 12387	407226'	271 10 0 00 000061 		ADDI	AC10,61				; AC10,61
 12388	407227'	400 13 0 00 000000 		SETZ	AC13,				; I,
 12389	407230'	254 00 0 00 407251'		JRST	L.468				; L.468
 12390					L.466:	MOVE	AC1,AC13			; AC1,I					
 12391	407231'	200 01 0 00 000013 						6585
 12392	407232'	231 01 0 00 000012 		IDIVI	AC1,12				; AC1,12
 12393	407233'	302 02 0 00 000001 		CAIE	AC2,1				; AC2,1
 12394	407234'	254 00 0 00 407241'		JRST	L.467				; L.467
 12395						PUSHJ	SP,TT%CRLF			; SP,TT%CRLF				
 12396	407235'	260 17 0 00 407220*						6588
 12397						PUSH	SP,C.21				; SP,[11]				
 12398	407236'	261 17 0 00 401016'						6589
 12399	407237'	260 17 0 00 407126*		PUSHJ	SP,TT%CHAR			; SP,TT%CHAR
 12400						ADJSP	SP,-1				; SP,-1					
 12401	407240'	105 17 0 00 777777 						6587
 12402					L.467:	PUSH	SP,C.143			; SP,[0,,PRE%CHAR%TEXT]			
 12403	407241'	261 17 0 00 407461'						6592
 12404	407242'	260 17 0 00 407217*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
 12405						ILDB	AC1,AC16			; AC1,TEMP%POINTER			
 12406	407243'	134 01 0 00 000016 						6593
 12407	407244'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
 12408	407245'	260 17 0 00 407237*		PUSHJ	SP,TT%CHAR			; SP,TT%CHAR
 12409						PUSH	SP,C.144			; SP,[42]				
 12410	407246'	261 17 0 00 407462'						6594
 12411	407247'	260 17 0 00 407245*		PUSHJ	SP,TT%CHAR			; SP,TT%CHAR
 12412						ADJSP	SP,-3				; SP,-3					
 12413	407250'	105 17 0 00 777775 						6583
 12414					L.468:	ADDI	AC13,1				; I,1					
 12415	407251'	271 13 0 00 000001 						6582
 12416	407252'	317 13 0 00 000010 		CAMG	AC13,AC10			; I,AC10
 12417	407253'	254 00 0 00 407231'		JRST	L.466				; L.466
 12418						MOVE	AC2,AC11			; AC2,AC11				
 12419	407254'	200 02 0 00 000011 						6597
 12420	407255'	274 02 0 00 000011'		SUB	AC2,U.46			; AC2,BLK%CHK%TYPE
 12421	407256'	271 02 0 00 000061 		ADDI	AC2,61				; AC2,61
 12422	407257'	200 01 0 00 000002 		MOVE	AC1,AC2				; AC1,AC2
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-228
KERMSG	MAC	18-Jan-73 17:20	

 12423	407260'	231 01 0 00 000012 		IDIVI	AC1,12				; AC1,12
 12424	407261'	306 02 0 00 000001 		CAIN	AC2,1				; AC2,1
 12425	407262'	260 17 0 00 407235*		PUSHJ	SP,TT%CRLF			; SP,TT%CRLF
 12426						PUSHJ	SP,TT%CRLF			; SP,TT%CRLF				
 12427	407263'	260 17 0 00 407262*						6599
 12428						ADJSP	SP,-1				; SP,-1					
 12429	407264'	105 17 0 00 777777 						6577
 12430					L.469:	PUSH	SP,C.145			; SP,[0,,CHKSUM%TEXT]			
 12431	407265'	261 17 0 00 407463'						6606
 12432	407266'	260 17 0 00 407242*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
 12433						MOVE	AC1,U.46			; AC1,BLK%CHK%TYPE			
 12434	407267'	200 01 0 00 000011'						6608
 12435	407270'	274 14 0 00 000001 		SUB	AC14,AC1			; MSG%LEN,AC1
 12436	407271'	271 14 0 00 000062 		ADDI	AC14,62				; AC14,62
 12437	407272'	201 02 0 12 000000 		MOVEI	AC2,0(AC12)			; AC2,0(AC12)
 12438	407273'	505 02 0 00 441000 		HRLI	AC2,-337000			; AC2,-337000
 12439	407274'	133 14 0 00 000002 		ADJBP	AC14,AC2			; AC14,AC2
 12440	407275'	200 16 0 00 000014 		MOVE	AC16,AC14			; TEMP%POINTER,AC14
 12441						SUBI	AC1,61				; AC1,61				
 12442	407276'	275 01 0 00 000061 						6610
 12443	407277'	254 00 0 01 407300'		JRST	L.470(AC1)			; L.470(AC1)
 12444	407300'	254 00 0 00 407303'	L.470:	JRST	L.471				; L.471
 12445	407301'	254 00 0 00 407317'		JRST	L.472				; L.472
 12446	407302'	254 00 0 00 407351'		JRST	L.473				; L.473
 12447					L.471:	PUSH	SP,C.143			; SP,[0,,PRE%CHAR%TEXT]			
 12448	407303'	261 17 0 00 407461'						6615
 12449	407304'	260 17 0 00 407266*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
 12450						MOVE	AC14,AC16			; AC14,TEMP%POINTER			
 12451	407305'	200 14 0 00 000016 						6616
 12452	407306'	134 01 0 00 000014 		ILDB	AC1,AC14			; AC1,AC14
 12453	407307'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
 12454	407310'	260 17 0 00 407247*		PUSHJ	SP,TT%CHAR			; SP,TT%CHAR
 12455						PUSH	SP,C.144			; SP,[42]				
 12456	407311'	261 17 0 00 407462'						6617
 12457	407312'	260 17 0 00 407310*		PUSHJ	SP,TT%CHAR			; SP,TT%CHAR
 12458						MOVE	AC14,AC16			; AC14,TEMP%POINTER			
 12459	407313'	200 14 0 00 000016 						6618
 12460	407314'	134 14 0 00 000014 		ILDB	AC14,AC14			; AC14,AC14
 12461	407315'	275 14 0 00 000040 		SUBI	AC14,40				; AC14,40
 12462						JRST	L.474				; L.474					
 12463	407316'	254 00 0 00 407414'						6610
 12464					L.472:	SETZ	AC14,				; CHKSUM,				
 12465	407317'	400 14 0 00 000000 						6623
 12466						PUSH	SP,C.143			; SP,[0,,PRE%CHAR%TEXT]			
 12467	407320'	261 17 0 00 407461'						6624
 12468	407321'	260 17 0 00 407304*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
 12469						MOVE	AC2,AC16			; AC2,TEMP%POINTER			
 12470	407322'	200 02 0 00 000016 						6625
 12471	407323'	134 01 0 00 000002 		ILDB	AC1,AC2				; AC1,AC2
 12472	407324'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
 12473	407325'	260 17 0 00 407312*		PUSHJ	SP,TT%CHAR			; SP,TT%CHAR
 12474						PUSH	SP,C.144			; SP,[42]				
 12475	407326'	261 17 0 00 407462'						6626
 12476	407327'	260 17 0 00 407325*		PUSHJ	SP,TT%CHAR			; SP,TT%CHAR
 12477						ILDB	AC1,AC16			; AC1,TEMP%POINTER			
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-229
KERMSG	MAC	18-Jan-73 17:20	

 12478	407330'	134 01 0 00 000016 						6627
 12479	407331'	275 01 0 00 000040 		SUBI	AC1,40				; AC1,40
 12480	407332'	137 01 0 00 407436'		DPB	AC1,C.124			; AC1,[POINT 6,CHKSUM,29]  <6,6>
 12481						PUSH	SP,C.143			; SP,[0,,PRE%CHAR%TEXT]			
 12482	407333'	261 17 0 00 407461'						6628
 12483	407334'	260 17 0 00 407321*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
 12484						MOVE	AC2,AC16			; AC2,TEMP%POINTER			
 12485	407335'	200 02 0 00 000016 						6629
 12486	407336'	134 01 0 00 000002 		ILDB	AC1,AC2				; AC1,AC2
 12487	407337'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
 12488	407340'	260 17 0 00 407327*		PUSHJ	SP,TT%CHAR			; SP,TT%CHAR
 12489						PUSH	SP,C.144			; SP,[42]				
 12490	407341'	261 17 0 00 407462'						6630
 12491	407342'	260 17 0 00 407340*		PUSHJ	SP,TT%CHAR			; SP,TT%CHAR
 12492						MOVE	AC2,AC16			; AC2,TEMP%POINTER			
 12493	407343'	200 02 0 00 000016 						6631
 12494	407344'	134 01 0 00 000002 		ILDB	AC1,AC2				; AC1,AC2
 12495	407345'	275 01 0 00 000040 		SUBI	AC1,40				; AC1,40
 12496	407346'	137 01 0 00 407437'		DPB	AC1,C.125			; AC1,[POINT 6,CHKSUM,35]  <0,6>
 12497						ADJSP	SP,-3				; SP,-3					
 12498	407347'	105 17 0 00 777775 						6622
 12499						JRST	L.474				; L.474					
 12500	407350'	254 00 0 00 407414'						6610
 12501					L.473:	SETZ	AC14,				; CHKSUM,				
 12502	407351'	400 14 0 00 000000 						6636
 12503						PUSH	SP,C.143			; SP,[0,,PRE%CHAR%TEXT]			
 12504	407352'	261 17 0 00 407461'						6637
 12505	407353'	260 17 0 00 407334*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
 12506						MOVE	AC2,AC16			; AC2,TEMP%POINTER			
 12507	407354'	200 02 0 00 000016 						6638
 12508	407355'	134 01 0 00 000002 		ILDB	AC1,AC2				; AC1,AC2
 12509	407356'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
 12510	407357'	260 17 0 00 407342*		PUSHJ	SP,TT%CHAR			; SP,TT%CHAR
 12511						PUSH	SP,C.144			; SP,[42]				
 12512	407360'	261 17 0 00 407462'						6639
 12513	407361'	260 17 0 00 407357*		PUSHJ	SP,TT%CHAR			; SP,TT%CHAR
 12514						ILDB	AC1,AC16			; AC1,TEMP%POINTER			
 12515	407362'	134 01 0 00 000016 						6640
 12516	407363'	275 01 0 00 000040 		SUBI	AC1,40				; AC1,40
 12517	407364'	137 01 0 00 407440'		DPB	AC1,C.126			; AC1,[POINT 4,CHKSUM,23]  <12,4>
 12518						PUSH	SP,C.143			; SP,[0,,PRE%CHAR%TEXT]			
 12519	407365'	261 17 0 00 407461'						6641
 12520	407366'	260 17 0 00 407353*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
 12521						MOVE	AC2,AC16			; AC2,TEMP%POINTER			
 12522	407367'	200 02 0 00 000016 						6642
 12523	407370'	134 01 0 00 000002 		ILDB	AC1,AC2				; AC1,AC2
 12524	407371'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
 12525	407372'	260 17 0 00 407361*		PUSHJ	SP,TT%CHAR			; SP,TT%CHAR
 12526						PUSH	SP,C.144			; SP,[42]				
 12527	407373'	261 17 0 00 407462'						6643
 12528	407374'	260 17 0 00 407372*		PUSHJ	SP,TT%CHAR			; SP,TT%CHAR
 12529						ILDB	AC1,AC16			; AC1,TEMP%POINTER			
 12530	407375'	134 01 0 00 000016 						6644
 12531	407376'	275 01 0 00 000040 		SUBI	AC1,40				; AC1,40
 12532	407377'	137 01 0 00 407436'		DPB	AC1,C.124			; AC1,[POINT 6,CHKSUM,29]  <6,6>
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-230
KERMSG	MAC	18-Jan-73 17:20	

 12533						PUSH	SP,C.143			; SP,[0,,PRE%CHAR%TEXT]			
 12534	407400'	261 17 0 00 407461'						6645
 12535	407401'	260 17 0 00 407366*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
 12536						MOVE	AC2,AC16			; AC2,TEMP%POINTER			
 12537	407402'	200 02 0 00 000016 						6646
 12538	407403'	134 01 0 00 000002 		ILDB	AC1,AC2				; AC1,AC2
 12539	407404'	261 17 0 00 000001 		PUSH	SP,AC1				; SP,AC1
 12540	407405'	260 17 0 00 407374*		PUSHJ	SP,TT%CHAR			; SP,TT%CHAR
 12541						PUSH	SP,C.144			; SP,[42]				
 12542	407406'	261 17 0 00 407462'						6647
 12543	407407'	260 17 0 00 407405*		PUSHJ	SP,TT%CHAR			; SP,TT%CHAR
 12544						ILDB	AC1,AC16			; AC1,AC16				
 12545	407410'	134 01 0 00 000016 						6648
 12546	407411'	275 01 0 00 000040 		SUBI	AC1,40				; AC1,40
 12547	407412'	137 01 0 00 407437'		DPB	AC1,C.125			; AC1,[POINT 6,CHKSUM,35]  <0,6>
 12548						ADJSP	SP,-6				; SP,-6					
 12549	407413'	105 17 0 00 777772 						6635
 12550					L.474:	PUSH	SP,C.146			; SP,[0,,CHKSUM%NUM%TEXT]		
 12551	407414'	261 17 0 00 407464'						6652
 12552	407415'	260 17 0 00 407401*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
 12553						MOVEM	AC14,0(SP)			; CHKSUM,0(SP)				
 12554	407416'	202 14 0 17 000000 						6653
 12555	407417'	260 17 0 00 407114*		PUSHJ	SP,TT%NUMBER			; SP,TT%NUMBER
 12556						PUSH	SP,C.128			; SP,[0,,DEC%TEXT]			
 12557	407420'	261 17 0 00 407442'						6654
 12558	407421'	260 17 0 00 407415*		PUSHJ	SP,TT%TEXT			; SP,TT%TEXT
 12559						PUSHJ	SP,TT%CRLF			; SP,TT%CRLF				
 12560	407422'	260 17 0 00 407263*						6655
 12561						MOVEM	AC0,0(SP)			; OLD%RTN,0(SP)				
 12562	407423'	202 00 0 17 000000 						6656
 12563	407424'	260 17 0 00 407066*		PUSHJ	SP,TT%SET%OUTPUT		; SP,TT%SET%OUTPUT
 12564						ADJSP	SP,-16				; SP,-16				
 12565	407425'	105 17 0 00 777762 						6465
 12566						POP	SP,AC16				; SP,AC16				
 12567	407426'	262 17 0 00 000016 						6426
 12568	407427'	262 17 0 00 000014 		POP	SP,AC14				; SP,AC14
 12569	407430'	262 17 0 00 000013 		POP	SP,AC13				; SP,AC13
 12570	407431'	262 17 0 00 000012 		POP	SP,AC12				; SP,AC12
 12571	407432'	262 17 0 00 000011 		POP	SP,AC11				; SP,AC11
 12572	407433'	262 17 0 00 000010 		POP	SP,AC10				; SP,AC10
 12573	407434'	262 17 0 00 000000 		POP	SP,AC0				; SP,AC0
 12574	407435'	263 17 0 00 000000 		POPJ	SP,				; SP,
 12575	407436'	06 06 0 00 000014 	C.124:	POINT	6,AC14,29			; 6,CHKSUM,29
 12576	407437'	00 06 0 00 000014 	C.125:	POINT	6,AC14,35			; 6,CHKSUM,35
 12577	407440'	14 04 0 00 000014 	C.126:	POINT	4,AC14,23			; 4,CHKSUM,23
 12578	407441'	000000	407032'		C.127:	XWD	0,U.115				; 0,MN%TEXT
 12579	407442'	000000	407040'		C.128:	XWD	0,U.117				; 0,DEC%TEXT
 12580	407443'	000000	407036'		C.129:	XWD	0,U.116				; 0,LENGTH%TEXT
 12581	407444'	000000	407042'		C.130:	XWD	0,U.118				; 0,MSG%TYP%TEXT
 12582	407445'	000000	406770'		C.131:	XWD	0,U.103				; 0,DATA%TEXT
 12583	407446'	000000	406772'		C.132:	XWD	0,U.104				; 0,ACK%TEXT
 12584	407447'	000000	406774'		C.133:	XWD	0,U.105				; 0,NAK%TEXT
 12585	407450'	000000	406776'		C.134:	XWD	0,U.106				; 0,SND%INIT%TEXT
 12586	407451'	000000	407001'		C.135:	XWD	0,U.107				; 0,BREAK%TEXT
 12587	407452'	000000	407006'		C.136:	XWD	0,U.109				; 0,FILE%TEXT
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1-231
KERMSG	MAC	18-Jan-73 17:20	

 12588	407453'	000000	407003'		C.137:	XWD	0,U.108				; 0,TEXT%TEXT
 12589	407454'	000000	407011'		C.138:	XWD	0,U.110				; 0,EOF%TEXT
 12590	407455'	000000	407013'		C.139:	XWD	0,U.111				; 0,ERROR%TEXT
 12591	407456'	000000	407024'		C.140:	XWD	0,U.114				; 0,KERMIT%TEXT
 12592	407457'	000000	407021'		C.141:	XWD	0,U.113				; 0,COMMAND%TEXT
 12593	407460'	000000	407051'		C.142:	XWD	0,U.121				; 0,OPT%DATA%TEXT
 12594	407461'	000000	407055'		C.143:	XWD	0,U.122				; 0,PRE%CHAR%TEXT
 12595	407462'	000000	000042		C.144:	EXP	42				; 42
 12596	407463'	000000	407045'		C.145:	XWD	0,U.119				; 0,CHKSUM%TEXT
 12597	407464'	000000	407050'		C.146:	XWD	0,U.120				; 0,CHKSUM%NUM%TEXT
 12598
 12599					; Routine Size:  263 words
 12600
 12601
 12602					;   6658  1	%SBTTL 'End of KERMSG'
 12603					;   6659  1	END
 12604					;   6660  1	
 12605					;   6661  0	ELUDOM
 12606
 12607
 12608
 12609						END

NO ERRORS DETECTED

HI-SEG. BREAK IS 407465
PROGRAM BREAK IS 000143
CPU TIME USED 08:37.844

14P CORE USED
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page S-1
KERMSG	MAC	18-Jan-73 17:20		SYMBOL TABLE

ABT%AL		403116'	ext	C.133		407447'		C.51		403021'		CHK%CR		000063	sin	
ABT%CU		403111'	ext	C.134		407450'		C.52		403315'		CHKTYP		406333'	ext	
ABT%FL		403263'	ext	C.135		407451'		C.53		403316'		CONNEC		403224'	ext	
AC0		000000		C.136		407452'		C.54		403317'		CRCCLC		405262'	ext	
AC1		000001		C.137		407453'		C.55		403320'		DBG%DU		405206'	ext	
AC10		000010		C.138		407454'		C.56		403664'		DEBUG%		406750'	ext	
AC11		000011		C.139		407455'		C.57		403665'		DELAY		400176'	ext	
AC12		000012		C.14		400602'		C.58		403666'		DEV%PA		406215'	ext	
AC13		000013		C.140		407456'		C.59		403667'		DO%GEN		400262'	int	
AC14		000014		C.141		407457'		C.6		400170'		DP%FUL		000000	sin	
AC16		000016		C.142		407460'		C.60		403670'		DP%HAL		000001	sin	
AC2		000002		C.143		407461'		C.61		403671'		DUPLEX		400044'	ext	
AC3		000003		C.144		407462'		C.62		403672'		ECHO%F		400047'	ext	
AC4		000004		C.145		407463'		C.63		403723'		FIL%NO		402664'	ext	
AC5		000005		C.146		407464'		C.64		403754'		FILE%C		403251'	ext	
AC6		000006		C.15		400603'		C.65		404345'		FILE%N		401660'	ext	
AC7		000007		C.16		400604'		C.66		404346'		FILE%O		402676'	ext	
C.1		400142'		C.17		400605'		C.67		404347'		FILE%S		403537'	ext	
C.10		400257'		C.18		401013'		C.68		404350'		FNM%FU		000002	sin	
C.100		405542'		C.19		401014'		C.69		404351'		FNM%NO		000001	sin	
C.101		406133'		C.2		400144'		C.7		400171'		FNM%UN		000004	sin	
C.102		406305'		C.20		401015'		C.70		404352'		FP		000015		
C.103		406666'		C.21		401016'		C.71		404353'		GC%COM		000017	sin	
C.104		406667'		C.22		401017'		C.72		404354'		GC%CON		000011	sin	
C.105		406670'		C.23		401020'		C.73		404416'		GC%COP		000013	sin	
C.106		406671'		C.24		401021'		C.74		404417'		GC%DEL		000004	sin	
C.107		406672'		C.25		401022'		C.75		404420'		GC%DIR		000002	sin	
C.108		406673'		C.26		401023'		C.76		404421'		GC%DIS		000003	sin	
C.109		406674'		C.27		401124'		C.77		404422'		GC%EXI		000001	sin	
C.11		400260'		C.28		401340'		C.78		404423'		GC%HEL		000006	sin	
C.110		406675'		C.29		401341'		C.79		404424'		GC%JOU		000021	sin	
C.111		406676'		C.3		400145'		C.8		400220'		GC%KER		000020	sin	
C.112		406677'		C.30		401342'		C.80		404425'		GC%LGN		000010	sin	
C.113		406700'		C.31		401343'		C.81		404630'		GC%LOG		000007	sin	
C.114		406701'		C.32		401344'		C.82		404631'		GC%MAX		000023	sin	
C.115		406702'		C.33		401656'		C.83		404632'		GC%MIN		000001	sin	
C.116		406703'		C.34		401657'		C.84		404633'		GC%PRO		000023	sin	
C.117		406704'		C.35		401660'		C.85		404634'		GC%REN		000012	sin	
C.118		406705'		C.36		401661'		C.86		404635'		GC%SEN		000015	sin	
C.119		406706'		C.37		401662'		C.87		404636'		GC%STA		000016	sin	
C.12		400261'		C.38		401663'		C.88		404637'		GC%TYP		000005	sin	
C.120		406707'		C.39		402027'		C.89		404640'		GC%VAR		000022	sin	
C.121		406710'		C.4		400146'		C.9		400256'		GC%WHO		000014	sin	
C.122		406742'		C.40		402344'		C.90		405205'		GEN%1D		402344'	ext	
C.123		406767'		C.41		402345'		C.91		405206'		GEN%1S		403747'	ext	
C.124		407436'		C.42		402346'		C.92		405207'		GEN%2D		402345'	ext	
C.125		407437'		C.43		402347'		C.93		405210'		GEN%2S		403725'	ext	
C.126		407440'		C.44		402350'		C.94		405211'		GEN%3D		402346'	ext	
C.127		407441'		C.45		402434'		C.95		405212'		GEN%3S		403726'	ext	
C.128		407442'		C.46		402510'		C.96		405213'		GEN%PA		406242'	int	
C.129		407443'		C.47		403015'		C.97		405214'		GET%FI		406337'	ext	
C.13		400412'		C.48		403016'		C.98		405517'		IBM%CH		400064'	ext	
C.130		407444'		C.49		403017'		C.99		405520'		IBM%FL		406243'	ext	
C.131		407445'		C.5		400167'		CHK%1C		000061	sin	IBM%WA		404606'	ext	
C.132		407446'		C.50		403020'		CHK%2C		000062	sin	KRM%ER		405513'	ext	
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page S-2
KERMSG	MAC	18-Jan-73 17:20		SYMBOL TABLE

L.1		400123'		L.149		402241'		L.199		403153'		L.248		403655'		
L.10		400332'		L.15		400350'		L.2		400150'		L.249		403660'		
L.100		401424'		L.150		402262'		L.20		400363'		L.25		400376'		
L.101		401426'		L.151		402301'		L.200		403155'		L.250		403705'		
L.102		401436'		L.152		402317'		L.201		403173'		L.251		403736'		
L.103		401446'		L.153		402331'		L.202		403204'		L.252		403777'		
L.104		401453'		L.154		402336'		L.203		403223'		L.253		404035'		
L.105		401455'		L.155		402342'		L.204		403240'		L.254		404036'		
L.106		401471'		L.156		402356'		L.205		403242'		L.255		404040'		
L.107		401472'		L.157		402376'		L.206		403243'		L.256		404047'		
L.108		401504'		L.158		402400'		L.207		403246'		L.257		404053'		
L.109		401516'		L.159		402411'		L.208		403256'		L.258		404060'		
L.11		400335'		L.16		400352'		L.209		403260'		L.259		404075'		
L.110		401520'		L.160		402416'		L.21		400365'		L.26		400401'		
L.111		401521'		L.161		402423'		L.210		403267'		L.260		404076'		
L.112		401541'		L.162		402425'		L.211		403271'		L.261		404077'		
L.113		401543'		L.163		402442'		L.212		403273'		L.262		404113'		
L.114		401553'		L.164		402455'		L.213		403275'		L.263		404114'		
L.115		401563'		L.165		402456'		L.214		403307'		L.264		404126'		
L.116		401570'		L.166		402460'		L.215		403312'		L.265		404127'		
L.117		401572'		L.167		402467'		L.216		403313'		L.266		404141'		
L.118		401604'		L.168		402522'		L.217		403344'		L.267		404142'		
L.119		401611'		L.169		402524'		L.218		403366'		L.268		404153'		
L.12		400340'		L.17		400354'		L.219		403367'		L.269		404154'		
L.120		401613'		L.170		402546'		L.22		400370'		L.27		400403'		
L.121		401615'		L.171		402574'		L.220		403416'		L.270		404166'		
L.122		401617'		L.172		402613'		L.221		403447'		L.271		404167'		
L.123		401632'		L.173		402617'		L.222		403462'		L.272		404200'		
L.124		401651'		L.174		402624'		L.223		403475'		L.273		404201'		
L.125		401654'		L.175		402626'		L.224		403476'		L.274		404210'		
L.126		401672'		L.176		402663'		L.225		403477'		L.275		404211'		
L.127		401704'		L.177		402674'		L.226		403500'		L.276		404225'		
L.128		401713'		L.178		402704'		L.227		403514'		L.277		404227'		
L.129		401717'		L.179		402727'		L.228		403526'		L.278		404232'		
L.13		400342'		L.18		400356'		L.229		403555'		L.279		404233'		
L.130		401725'		L.180		402751'		L.23		400373'		L.28		400404'		
L.131		401727'		L.181		402765'		L.230		403556'		L.280		404234'		
L.132		401734'		L.182		402767'		L.231		403560'		L.281		404241'		
L.133		401761'		L.183		402774'		L.232		403564'		L.282		404242'		
L.134		401774'		L.184		402777'		L.233		403570'		L.283		404250'		
L.135		401776'		L.185		403001'		L.234		403574'		L.284		404253'		
L.136		402007'		L.186		403010'		L.235		403600'		L.285		404260'		
L.137		402024'		L.187		403013'		L.236		403604'		L.286		404264'		
L.138		402071'		L.188		403032'		L.237		403610'		L.287		404270'		
L.139		402112'		L.189		403041'		L.238		403614'		L.288		404300'		
L.14		400345'		L.19		400360'		L.239		403620'		L.289		404307'		
L.140		402125'		L.190		403043'		L.24		400374'		L.29		400405'		
L.141		402146'		L.191		403073'		L.240		403624'		L.290		404310'		
L.142		402147'		L.192		403105'		L.241		403630'		L.291		404315'		
L.143		402151'		L.193		403115'		L.242		403634'		L.292		404320'		
L.144		402156'		L.194		403121'		L.243		403640'		L.293		404325'		
L.145		402165'		L.195		403125'		L.244		403644'		L.294		404327'		
L.146		402213'		L.196		403126'		L.245		403650'		L.295		404334'		
L.147		402222'		L.197		403144'		L.246		403651'		L.296		404342'		
L.148		402227'		L.198		403150'		L.247		403653'		L.297		404343'		
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page S-3
KERMSG	MAC	18-Jan-73 17:20		SYMBOL TABLE

L.298		404462'		L.347		405275'		L.397		405771'		L.446		406627'		
L.299		404523'		L.348		405323'		L.398		406002'		L.447		406630'		
L.3		400164'		L.349		405330'		L.399		406005'		L.448		406631'		
L.30		400410'		L.35		400476'		L.4		400201'		L.449		406645'		
L.300		404526'		L.350		405331'		L.40		400544'		L.45		400556'		
L.301		404532'		L.351		405332'		L.400		406013'		L.450		406657'		
L.302		404541'		L.352		405344'		L.401		406014'		L.451		406661'		
L.303		404553'		L.353		405352'		L.402		406020'		L.452		406740'		
L.304		404570'		L.354		405355'		L.403		406024'		L.453		406765'		
L.305		404573'		L.355		405360'		L.404		406025'		L.454		407136'		
L.306		404614'		L.356		405363'		L.405		406040'		L.455		407142'		
L.307		404623'		L.357		405370'		L.406		406057'		L.456		407146'		
L.308		404642'		L.358		405374'		L.407		406060'		L.457		407152'		
L.309		404652'		L.359		405402'		L.408		406071'		L.458		407156'		
L.31		400422'		L.36		400522'		L.409		406072'		L.459		407162'		
L.310		404664'		L.360		405403'		L.41		400546'		L.46		400560'		
L.311		404674'		L.361		405407'		L.410		406103'		L.460		407166'		
L.312		404706'		L.362		405410'		L.411		406111'		L.461		407172'		
L.313		404707'		L.363		405413'		L.412		406120'		L.462		407176'		
L.314		404735'		L.364		405434'		L.413		406121'		L.463		407202'		
L.315		404742'		L.365		405444'		L.414		406123'		L.464		407205'		
L.316		404755'		L.366		405445'		L.415		406124'		L.465		407207'		
L.317		404764'		L.367		405446'		L.416		406144'		L.466		407231'		
L.318		404767'		L.368		405460'		L.417		406155'		L.467		407241'		
L.319		404775'		L.369		405470'		L.418		406202'		L.468		407251'		
L.32		400423'		L.37		400531'		L.419		406225'		L.469		407265'		
L.320		405034'		L.370		405474'		L.42		400550'		L.47		400562'		
L.321		405037'		L.371		405505'		L.420		406233'		L.470		407300'		
L.322		405044'		L.372		405510'		L.421		406236'		L.471		407303'		
L.323		405051'		L.373		405515'		L.422		406247'		L.472		407317'		
L.324		405062'		L.374		405540'		L.423		406252'		L.473		407351'		
L.325		405063'		L.375		405560'		L.424		406257'		L.474		407414'		
L.326		405100'		L.376		405571'		L.425		406261'		L.48		400564'		
L.327		405103'		L.377		405572'		L.426		406263'		L.49		400566'		
L.328		405130'		L.378		405601'		L.427		406265'		L.5		400241'		
L.329		405132'		L.379		405603'		L.428		406301'		L.50		400570'		
L.33		400431'		L.38		400536'		L.429		406302'		L.51		400572'		
L.330		405133'		L.380		405606'		L.43		400552'		L.52		400574'		
L.331		405135'		L.381		405611'		L.430		406303'		L.53		400575'		
L.332		405144'		L.382		405616'		L.431		406537'		L.54		400577'		
L.333		405147'		L.383		405632'		L.432		406563'		L.55		400662'		
L.334		405156'		L.384		405633'		L.433		406565'		L.56		400714'		
L.335		405201'		L.385		405642'		L.434		406567'		L.57		400716'		
L.336		405223'		L.386		405646'		L.435		406571'		L.58		400747'		
L.337		405224'		L.387		405671'		L.436		406573'		L.59		400753'		
L.338		405227'		L.388		405701'		L.437		406575'		L.6		400276'		
L.339		405232'		L.389		405722'		L.438		406601'		L.60		400757'		
L.34		400455'		L.39		400542'		L.439		406602'		L.61		400763'		
L.340		405234'		L.390		405737'		L.44		400554'		L.62		400767'		
L.341		405237'		L.391		405745'		L.440		406607'		L.63		400770'		
L.342		405243'		L.392		405747'		L.441		406611'		L.64		400773'		
L.343		405251'		L.393		405752'		L.442		406613'		L.65		400776'		
L.344		405255'		L.394		405753'		L.443		406615'		L.66		401000'		
L.345		405260'		L.395		405763'		L.444		406620'		L.67		401007'		
L.346		405265'		L.396		405765'		L.445		406625'		L.68		401010'		
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page S-4
KERMSG	MAC	18-Jan-73 17:20		SYMBOL TABLE

L.69		401036'		P.AAR		406421'		RCV%QU		405502'	ext	U.105		406774'		
L.7		400321'		P.AAS		406430'		RCV%SO		400013'	ext	U.106		406776'		
L.70		401071'		P.AAT		406440'		RCV%TI		404361'	ext	U.107		407001'		
L.71		401072'		P.AAU		406446'		RCV%TO		406373'	ext	U.108		407003'		
L.72		401074'		P.AAV		406452'		REC%SW		400221'	int	U.109		407006'		
L.73		401107'		P.AAW		406460'		RECEIV		404745'	ext	U.11		402444'		
L.74		401111'		P.AAX		406466'		RMSG%C		406364'	ext	U.110		407011'		
L.75		401114'		P.AAY		406476'		RMSG%D		406374'	ext	U.111		407013'		
L.76		401117'		P.AAZ		406505'		RMSG%N		406641'	ext	U.112		407015'		
L.77		401121'		P.ABA		406511'		RMSG%T		406372'	ext	U.113		407021'		
L.78		401146'		P.ABB		406515'		SEND		404621'	ext	U.114		407024'		
L.79		401166'		P.ABC		406520'		SEND%S		400172'	int	U.115		407032'		
L.8		400326'		P.ABD		406521'		SEND%T		406324'	ext	U.116		407036'		
L.80		401170'		P.ABE		406524'		SERVER		400147'	int	U.117		407040'		
L.81		401202'		P.ABF		406525'		SET%RE		406335'	ext	U.118		407042'		
L.82		401212'		P.ABG		406716'		SI%RET		402552'	ext	U.119		407045'		
L.83		401222'		P.ABH		406743'		SMSG%C		406362'	ext	U.12		402533'		
L.84		401224'		P.ABI		406770'		SMSG%D		406370'	ext	U.120		407050'		
L.85		401240'		P.ABJ		406772'		SMSG%N		406654'	ext	U.121		407051'		
L.86		401244'		P.ABK		406774'		SMSG%T		406366'	ext	U.122		407055'		
L.87		401251'		P.ABL		406776'		SND%CO		406363'	ext	U.13		403061'		
L.88		401266'		P.ABM		407001'		SND%DA		406371'	ext	U.14		403374'		
L.89		401301'		P.ABN		407003'		SND%EO		406325'	ext	U.15		403673'		
L.9		400330'		P.ABO		407006'		SND%ER		400077'	int	U.16		403724'		
L.90		401306'		P.ABP		407011'		SND%NA		406377'	ext	U.17		403755'		
L.91		401307'		P.ABQ		407013'		SND%NP		406317'	ext	U.18		406362'		
L.92		401312'		P.ABR		407015'		SND%PA		406321'	ext	U.19		405215'		
L.93		401320'		P.ABS		407021'		SND%PK		406315'	ext	U.2		401026'		
L.94		401326'		P.ABT		407024'		SND%QU		406327'	ext	U.20		404355'		
L.95		401331'		P.ABU		407032'		SND%SO		404465'	ext	U.21		404103'		
L.96		401355'		P.ABV		407036'		SND%TI		406323'	ext	U.22		406211'		
L.97		401364'		P.ABW		407040'		SND%TO		406367'	ext	U.23		406242'		
L.98		401365'		P.ABX		407042'		SP		000017		U.24		404426'		
L.99		401405'		P.ABY		407045'		SRV%TI		400534'	ext	U.25		404641'		
LAST%E		405214'	ext	P.ABZ		407050'		SY%DIS		400177'	ext	U.26		404716'		
MAX%MS		000140	sin	P.ACA		407051'		SY%GEN		403771'	ext	U.27		405277'		
MSG%IN		400000'	int	P.ACB		407055'		SY%LOG		403522'	ext	U.28		406030'		
NEXT%F		401602'	ext	PARITY		406306'	ext	SY%TIM		406402'	ext	U.29		405543'		
P.AAA		400413'		PKT%RE		404643'	ext	TERM%D		000000	ext	U.3		401137'		
P.AAB		401125'		PR%EVE		000002	sin	TOTAL%		406404'	ext	U.30		406157'		
P.AAC		401132'		PR%MAR		000001	sin	TT%CHA		407407'	ext	U.31		406711'		
P.AAD		401135'		PR%MAX		000004	sin	TT%CRL		407422'	ext	U.32		406306'		
P.AAE		401474'		PR%MIN		000000	sin	TT%NUM		407417'	ext	U.33		406530'		
P.AAF		401745'		PR%NON		000000	sin	TT%OUT		403274'	ext	U.34		407056'		
P.AAG		402061'		PR%ODD		000003	sin	TT%SET		407424'	ext	U.35		406721'		
P.AAH		402062'		PR%SPA		000004	sin	TT%TEX		407421'	ext	U.36		406746'		
P.AAI		402526'		PUT%FI		406341'	ext	TY%FIL		403227'	ext	U.37		000000'		
P.AAJ		402531'		RCV%8Q		406307'	ext	TY%PKT		400067'	ext	U.38		000001'		
P.AAK		402532'		RCV%CO		406365'	ext	TYP%ST		404741'	ext	U.39		000002'		
P.AAL		403045'		RCV%DA		406375'	ext	U.1		400416'		U.4		401345'		
P.AAM		403050'		RCV%EO		404375'	ext	U.10		400606'		U.40		000003'		
P.AAN		403057'		RCV%NA		406401'	ext	U.100		406716'		U.41		000004'		
P.AAO		404711'		RCV%NP		404365'	ext	U.101		406743'		U.42		000005'		
P.AAP		406406'		RCV%PA		404371'	ext	U.103		406770'		U.43		000006'		
P.AAQ		406412'		RCV%PK		404355'	ext	U.104		406772'		U.44		000007'		
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page S-5
KERMSG	MAC	18-Jan-73 17:20		SYMBOL TABLE

U.45		000010'		XFR%TI		406403'	ext	
U.46		000011'		
U.47		000012'		
U.48		000013'		
U.49		000014'		
U.5		401747'		
U.50		000015'		
U.51		000016'		
U.52		000017'		
U.53		000020'		
U.54		000021'		
U.55		000022'		
U.56		000023'		
U.57		000024'		
U.58		000054'		
U.59		000104'		
U.6		402063'		
U.60		000105'		
U.61		000106'		
U.62		000107'		
U.63		000110'		
U.64		000111'		
U.65		000112'		
U.66		000113'		
U.67		000114'		
U.7		401476'		
U.74		401024'		
U.75		402030'		
U.76		402435'		
U.77		402511'		
U.78		403022'		
U.79		403321'		
U.8		401664'		
U.80		404711'		
U.81		000115'		
U.82		000116'		
U.83		000117'		
U.84		000120'		
U.85		000121'		
U.86		000126'		
U.87		000127'		
U.88		000130'		
U.89		000135'		
U.9		402351'		
U.90		405426'		
U.91		405521'		
U.92		000136'		
U.93		000137'		
U.94		000140'		
U.95		000141'		
U.96		000142'		
U.97		406134'		
U.98		406146'		
WARN%F		400046'	ext	
XFR%ST		405147'	ext	

KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1
KERMSG	MAC	18-Jan-73 17:20	


Symbol cross reference

ABT%AL	  1374#	  3562	  3580	  3594	  3624	  3793	  4085	  4152	  5682	  6268
ABT%CU	  1374#	  3554	  3577	  3601	  3632	  3791	  4082	  5680	  6261
ABT%FL	  1372#	  1522	  2563	  6377	  6394	  6408
AC0	  1424#	 12241	 12252	 12561	 12573
AC1	  1425#	  1444	  1446	  1451	  1453	  1454	  1456	  1457	  1459	  1460	  1462	  1463	  1465	  1466
	  1468	  1469	  1471	  1476	  1478	  1479	  1481	  1482	  1484	  1485	  1487	  1488	  1490	  1491
	  1493	  1494	  1496	  1497	  1499	  1508	  1510	  1511	  1513	  1514	  1520	  1522	  1527	  1529
	  1530	  1532	  1535	  1537	  1538	  1540	  1541	  1543	  1618	  1619	  1620	  1636	  1637	  1641
	  1644	  1738	  1747	  1826	  1828	  1844	  1851	  1954	  1956	  1957	  1962	  1975	  1982	  2166
	  2168	  2171	  2173	  2174	  2175	  2201	  2204	  2207	  2212	  2217	  2220	  2225	  2230	  2233
	  2236	  2239	  2242	  2247	  2250	  2255	  2260	  2263	  2265	  2270	  2273	  2276	  2278	  2494
	  2496	  2497	  2499	  2526	  2529	  2531	  2535	  2537	  2539	  2540	  2550	  2552	  2556	  2557
	  2560	  2561	  2563	  2564	  2572	  2574	  2580	  2582	  2583	  2585	  2586	  2589	  2597	  2637
	  2851	  2865	  2875	  2879	  2881	  2882	  2884	  2885	  2887	  2888	  2890	  2891	  2893	  2894
	  2896	  2897	  2899	  2900	  2902	  2903	  2905	  2906	  2912	  2914	  2919	  2930	  2932	  2934
	  2941	  2962	  2967	  2968	  2969	  2978	  3014	  3016	  3018	  3026	  3027	  3028	  3033	  3101
	  3180	  3182	  3184	  3194	  3199	  3202	  3220	  3223	  3227	  3229	  3231	  3232	  3236	  3240
	  3244	  3246	  3249	  3254	  3471	  3473	  3478	  3484	  3488	  3492	  3495	  3497	  3499	  3502
	  3512	  3513	  3526	  3529	  3534	  3538	  3540	  3543	  3544	  3546	  3548	  3549	  3557	  3560
	  3562	  3565	  3567	  3574	  3576	  3577	  3579	  3580	  3582	  3585	  3587	  3589	  3590	  3592
	  3594	  3599	  3601	  3613	  3615	  3620	  3626	  3633	  3636	  3642	  3795	  3797	  3799	  3805
	  3807	  3812	  3814	  3820	  3839	  3843	  3846	  3848	  3850	  3853	  3857	  3859	  3860	  3872
	  3873	  3880	  3881	  3883	  3887	  3889	  3896	  3898	  3900	  4068	  4070	  4072	  4078	  4079
	  4080	  4082	  4084	  4085	  4087	  4089	  4092	  4096	  4100	  4111	  4115	  4117	  4118	  4130
	  4131	  4138	  4139	  4141	  4145	  4147	  4150	  4152	  4155	  4165	  4167	  4170	  4172	  4173
	  4175	  4187	  4189	  4191	  4192	  4208	  4324	  4326	  4328	  4338	  4340	  4344	  4347	  4349
	  4351	  4355	  4366	  4370	  4372	  4374	  4376	  4379	  4381	  4384	  4472	  4474	  4476	  4477
	  4488	  4490	  4496	  4498	  4500	  4501	  4502	  4504	  4516	  4518	  4520	  4521	  4532	  4618
	  4620	  4621	  4623	  4624	  4626	  4627	  4628	  4632	  4633	  4636	  4637	  4639	  4642	  4645
	  4829	  4831	  4833	  4837	  4839	  4840	  4843	  4845	  4847	  4849	  4852	  4854	  4864	  4866
	  4867	  4869	  4877	  4879	  4880	  4882	  4888	  4890	  4899	  4901	  4903	  4904	  4907	  4912
	  4914	  4916	  4917	  4935	  4938	  4942	  4945	  4947	  4949	  4955	  4968	  4979	  4981	  4982
	  4984	  4987	  4989	  4994	  5000	  5002	  5003	  5005	  5026	  5028	  5031	  5033	  5038	  5044
	  5046	  5054	  5062	  5069	  5192	  5194	  5196	  5206	  5210	  5213	  5215	  5217	  5220	  5224
	  5226	  5227	  5234	  5237	  5239	  5243	  5246	  5247	  5249	  5253	  5255	  5258	  5321	  5323
	  5325	  5327	  5361	  5363	  5369	  5376	  5378	  5387	  5389	  5390	  5392	  5395	  5397	  5402
	  5474	  5476	  5477	  5479	  5480	  5482	  5485	  5488	  5688	  5690	  5693	  5695	  5697	  5706
	  5708	  5714	  5716	  5722	  5724	  5726	  5735	  5737	  5750	  5753	  5760	  5777	  5781	  5782
	  5783	  5784	  5786	  5788	  5789	  5801	  5803	  5817	  5827	  5829	  5835	  5837	  5840	  5842
	  5848	  5851	  5853	  5855	  5857	  5858	  5860	  5881	  5883	  5886	  5888	  5893	  5896	  5899
	  5901	  5908	  5918	  5924	  5998	  6000	  6002	  6007	  6010	  6012	  6013	  6015	  6018	  6233
	  6235	  6238	  6240	  6242	  6249	  6251	  6257	  6259	  6261	  6266	  6268	  6272	  6273	  6285
	  6287	  6290	  6292	  6297	  6300	  6302	  6305	  6307	  6309	  6313	  6315	  6328	  6331	  6334
	  6336	  6349	  6351	  6355	  6357	  6359	  6361	  6362	  6365	  6367	  6369	  6370	  6375	  6377
	  6392	  6394	  6395	  6398	  6401	  6406	  6408	  6410	  6412	  6415	  6425	  6427	  6429	  6434
	  6440	  6552	  6553	  6554	  6565	  6568	  6570	  6571	  6572	  6573	  6575	  6577	  6580	  6582
	  6584	  6585	  6586	  6588	  6589	  6591	  6773	  6775	  6776	  6787	  6799	  6801	  6804	  6805
	  6808	  6809	  6810	  6812	  6813	  6816	  6818	  6823	  6830	  6832	  6837	  6844	  6846	  6851
	  6862	  6864	  6865	  6876	  6891	  6897	  6902	  6904	  6906	  6907	  6909	  6914	  6916	  6918
	  6919	  6921	  6924	  7032	  7129	  7144	  7230	  7245	  7375	  7376	  7377	  7378	  7379	  7380
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1
KERMSG	MAC	18-Jan-73 17:20	


Symbol cross reference

	  7383	  7385	  7393	  7394	  7395	  7399	  7401	  7402	  7412	  7420	  7422	  7424	  7427	  7429	  7430
	  7436	  7438	  7443	  7445	  7446	  7448	  7450	  7451	  7453	  7458	  7460	  7462	  7463	  7465
	  7468	  7735	  7737	  7741	  7743	  7744	  7747	  7749	  7751	  7753	  7758	  7760	  7761	  7764
	  7766	  7768	  7770	  7775	  7777	  7778	  7781	  7783	  7785	  7787	  7792	  7794	  7795	  7796
	  7798	  7800	  7802	  7807	  7809	  7810	  7813	  7815	  7817	  7819	  7824	  7826	  7829	  7831
	  7837	  7838	  7840	  7841	  7845	  7847	  7852	  7854	  7857	  7865	  7867	  7871	  7872	  7874
	  7875	  7876	  7878	  7880	  7882	  7883	  7887	  7889	  7891	  7893	  7896	  7898	  7900	  7902
	  7904	  7908	  7910	  7912	  7913	  7919	  7921	  7926	  7928	  7930	  7932	  7933	  7936	  7937
	  7939	  7942	  7949	  7952	  7954	  7956	  7957	  7960	  8041	  8042	  8046	  8047	  8051	  8052
	  8056	  8057	  8061	  8062	  8065	  8066	  8069	  8070	  8073	  8074	  8077	  8078	  8266	  8271
	  8275	  8277	  8281	  8283	  8284	  8285	  8286	  8292	  8293	  8296	  8297	  8303	  8305	  8307
	  8309	  8310	  8312	  8317	  8318	  8319	  8337	  8361	  8363	  8364	  8367	  8369	  8392	  8394
	  8406	  8409	  8427	  8428	  8538	  8540	  8547	  8554	  8561	  8575	  8577	  8578	  8587	  8589
	  8884	  8886	  8891	  8902	  8904	  8912	  8913	  8915	  8934	  8937	  8939	  8943	  8946	  8948
	  8950	  8951	  8952	  8954	  8955	  8956	  8957	  8958	  8960	  8961	  8962	  8970	  8971	  8972
	  8993	  9057	  9070	  9072	  9074	  9088	  9090	  9093	  9095	  9099	  9120	  9246	  9248	  9249
	  9256	  9258	  9259	  9266	  9275	  9279	  9288	  9291	  9293	  9295	  9297	  9298	  9299	  9301
	  9497	  9499	  9500	  9501	  9514	  9524	  9530	  9598	  9600	  9601	  9603	  9787	  9789	  9790
	  9794	  9797	  9800	  9803	  9804	  9808	  9810	  9811	  9813	  9817	  9819	  9823	  9824	  9830
	  9835	  9839	  9844	  9846	  9847	  9849	  9858	  9861	  9864	  9906	  9907	  9909	  9911	  9913
	  9914	  9916	  9918	  9919	  9922	  9923	 10138	 10141	 10143	 10144	 10146	 10148	 10150	 10156
	 10158	 10160	 10162	 10164	 10165	 10169	 10171	 10176	 10177	 10180	 10187	 10189	 10198	 10199
	 10233	 10234	 10236	 10237	 10239	 10240	 10242	 10243	 10244	 10245	 10247	 10248	 10249	 10250
	 10252	 10253	 10255	 10257	 10259	 10260	 10263	 10265	 10266	 10268	 10271	 10273	 10274	 10275
	 10281	 10283	 10284	 10289	 10291	 10293	 10298	 10299	 10301	 10307	 10309	 10509	 10624	 10625
	 10626	 10629	 10662	 10664	 10665	 10668	 10707	 10709	 10711	 10713	 10714	 10716	 10717	 10719
	 10720	 10722	 10723	 10725	 10726	 10728	 10729	 10731	 10732	 10735	 10737	 10738	 10740	 10741
	 10743	 10816	 10818	 10820	 10822	 10828	 10830	 10831	 10833	 10928	 10930	 10932	 10936	 10938
	 10944	 10947	 10950	 10952	 10953	 10955	 10958	 10959	 10962	 10963	 10965	 10967	 10969	 10971
	 10972	 11093	 11095	 11097	 11100	 11102	 11103	 11105	 11106	 11108	 11109	 11111	 11112	 11114
	 11115	 11117	 11118	 11120	 11121	 11123	 11124	 11126	 11127	 11129	 11130	 11132	 11133	 11135
	 11162	 11223	 11225	 11226	 11228	 11229	 11231	 11232	 11234	 11235	 11237	 11238	 11240	 11241
	 11243	 11244	 11246	 11249	 11250	 11482	 11484	 11485	 11486	 11567	 11569	 11571	 11585	 11587
	 11687	 11770	 11772	 11777	 11871	 11873	 11878	 12252	 12255	 12256	 12257	 12265	 12267	 12268
	 12269	 12270	 12289	 12291	 12292	 12293	 12295	 12297	 12298	 12371	 12372	 12373	 12390	 12392
	 12405	 12407	 12422	 12423	 12433	 12435	 12441	 12443	 12452	 12453	 12471	 12472	 12477	 12479
	 12480	 12486	 12487	 12494	 12495	 12496	 12508	 12509	 12514	 12516	 12517	 12523	 12524	 12529
	 12531	 12532	 12538	 12539	 12544	 12546	 12547
AC10	  1432#	  9484	  9493	  9588	  9590	  9610	 10458	 10517	 12243	 12386	 12387	 12416	 12572
AC11	  1433#	  9486	  9491	  9581	  9583	  9609	 10460	 10465	 10472	 10482	 10486	 10516	 12244	 12368
	 12370	 12373	 12383	 12418	 12571
AC12	  1434#	  6541	  6546	  6548	  6568	  6586	  6591	  6596	  9487	  9493	  9568	  9592	  9600	  9608
	 10461	 10467	 10469	 10474	 10488	 10515	 12245	 12253	 12255	 12265	 12289	 12295	 12380	 12437
	 12570
AC13	  1435#	  6543	  6549	  6554	  6555	  6572	  6577	  6582	  6588	  6595	  8255	  8268	  8269	  8270
	  8298	  8300	  8317	  8321	  8324	  8327	  8424	  9488	  9495	  9505	  9538	  9564	  9575	  9607
	 10462	 10472	 10476	 10486	 10494	 10514	 10519	 10812	 10824	 10837	 10842	 12246	 12388	 12390
	 12414	 12416	 12569
AC14	  1436#	  1613	  1621	  1622	  1633	  1654	  2489	  2524	  2528	  2633	  2637	  2641	  2846	  2851
	  2852	  2855	  2865	  2866	  2875	  2877	  2919	  2920	  3031	  3175	  3199	  3205	  3258	  6544
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1
KERMSG	MAC	18-Jan-73 17:20	


Symbol cross reference

	  6555	  6557	  6561	  6571	  6594	  6769	  6787	  6788	  6814	  6819	  6823	  6824	  6828	  6833	  6837
	  6838	  6842	  6847	  6851	  6852	  6932	  6939	  6946	  6953	  6960	  6967	  6974	  6981	  6988
	  6995	  7002	  7009	  7016	  7023	  7035	  7042	  7365	  7388	  7390	  7396	  7402	  7412	  7431
	  7474	  8257	  8300	  8301	  8302	  8305	  8321	  8323	  8351	  8365	  8372	  8374	  8413	  8417
	  8423	  8880	  8891	  8897	  8915	  8916	  8923	  8926	  8928	  8930	  8934	  8980	  9014	  9016
	  9035	  9059	  9125	  9489	  9506	  9518	  9573	  9606	 10286	 10312	 10463	 10484	 10485	 10492
	 10513	 10814	 10826	 10835	 10837	 10841	 12247	 12258	 12259	 12278	 12368	 12435	 12436	 12439
	 12440	 12450	 12452	 12458	 12460	 12461	 12464	 12501	 12553	 12568	 12575	 12576	 12577
AC16	  1438#	  1615	  1616	  1618	  1638	  1652	  1727	  1738	  1741	  1744	  1747	  1749	  1824	  1844
	  1851	  1853	  1943	  1945	  1966	  1972	  1975	  1982	  1984	  2158	  2169	  2210	  2215	  2223
	  2228	  2245	  2253	  2258	  2268	  2279	  2283	  2491	  2582	  2590	  2639	  2848	  2858	  2860
	  2909	  2947	  2987	  2994	  3001	  3029	  3177	  3202	  3208	  3211	  3214	  3216	  3218	  3236
	  3237	  3256	  3789	  3809	  3811	  3833	  3901	  4066	  4100	  4101	  4104	  4106	  4108	  4155
	  4156	  4157	  4160	  4162	  4209	  6227	  6353	  6363	  6372	  6392	  6403	  6444	  6545	  6551
	  6552	  6578	  6584	  6585	  6592	  6771	  6865	  6866	  6879	  6894	  6929	  6936	  6943	  6950
	  6957	  6964	  6971	  6978	  6985	  6992	  6999	  7006	  7013	  7020	  7041	  7367	  7391	  7393
	  7427	  7473	  8258	  8313	  8315	  8329	  8340	  8346	  8350	  8356	  8360	  8364	  8369	  8376
	  8378	  8395	  8397	  8398	  8400	  8402	  8422	  8536	  8554	  8555	  8557	  8559	  8561	  8564
	  8591	  8882	  8966	  8968	  8979	  8990	  8996	  9002	  9009	  9040	  9042	  9053	  9054	  9124
	  9490	  9491	  9528	  9532	  9604	 10153	 10207	 10275	 10310	 10464	 10505	 10511	 10815	 10822
	 10823	 10828	 10833	 10839	 11768	 11777	 11785	 11790	 11869	 11878	 11886	 11891	 12248	 12298
	 12299	 12305	 12311	 12317	 12323	 12329	 12335	 12341	 12347	 12353	 12359	 12380	 12382	 12405
	 12440	 12450	 12458	 12469	 12477	 12484	 12492	 12506	 12514	 12521	 12529	 12536	 12544	 12566
AC2	  1426#	  1638	  1640	  1959	  2499	  2500	  2501	  2502	  2553	  2555	  2556	  2561	  2915	  2916
	  2965	  2967	  2970	  3474	  3476	  3506	  3509	  3517	  3531	  3532	  3535	  3536	  3552	  3554
	  3568	  3569	  3622	  3624	  3630	  3632	  3815	  3816	  3868	  3870	  3877	  3890	  3891	  4076
	  4079	  4126	  4128	  4135	  4148	  4149	  4352	  4354	  4355	  4358	  4360	  4362	  4364	  4382
	  4383	  4621	  4622	  4629	  4631	  4633	  4637	  4638	  4859	  4861	  4872	  4874	  4883	  4885
	  4909	  4950	  4952	  4955	  4958	  4960	  4990	  4991	  4997	  5034	  5035	  5041	  5057	  5256
	  5257	  5366	  5368	  5369	  5371	  5373	  5398	  5399	  5700	  5702	  5709	  5710	  5729	  5731
	  5738	  5739	  5756	  5758	  5778	  5783	  5843	  5844	  5889	  5890	  6004	  6005	  6245	  6247
	  6263	  6270	  6273	  6293	  6294	  6316	  6317	  6430	  6431	  6578	  6797	  6801	  6802	  6805
	  6806	  6809	  6899	  7754	  7756	  7771	  7773	  7788	  7790	  7803	  7805	  7820	  7822	  7833
	  7835	  7842	  7868	  7914	  7916	  7917	  7937	  8038	  8040	  8042	  8043	  8045	  8047	  8048
	  8050	  8052	  8053	  8055	  8057	  8058	  8060	  8062	  8063	  8066	  8067	  8070	  8071	  8074
	  8075	  8078	  8266	  8290	  8293	  8294	  8297	  8311	  8312	  8327	  8328	  8329	  8330	  8332
	  8333	  8337	  8339	  8340	  8343	  8345	  8346	  8347	  8349	  8350	  8353	  8355	  8356	  8357
	  8359	  8360	  8974	  8976	  8978	  8979	  8984	  8985	  8986	  8990	  8992	  8993	  8996	  8998
	  9000	  9002	  9004	  9007	  9009	  9011	  9013	  9023	  9024	  9025	  9026	  9028	  9030	  9032
	  9033	  9037	  9039	  9044	  9045	  9046	  9048	  9050	  9052	  9053	  9054	  9056	  9057	  9095
	  9237	  9242	  9253	  9260	  9262	  9268	  9275	  9277	  9278	  9279	  9503	  9508	  9510	  9512
	  9514	  9516	  9530	  9534	  9537	  9540	  9542	  9544	  9547	  9548	  9552	  9558	  9560	  9561
	  9566	  9594	  9815	  9840	  9842	  9854	  9868	  9921	  9922	 10141	 10143	 10194	 10196	 10198
	 10205	 10236	 10263	 10265	 10284	 10286	 10479	 10480	 10482	 10497	 10498	 10622	 10625	 10955
	 10957	 10958	 10959	 10961	 10962	 12257	 12258	 12383	 12385	 12386	 12393	 12418	 12420	 12421
	 12422	 12424	 12437	 12438	 12439	 12469	 12471	 12484	 12486	 12492	 12494	 12506	 12508	 12521
	 12523	 12536	 12538
AC3	  1427#	  1951	  1953	  1957	  1960	  1964	  2548	  2551	  2554	  2559	  2963	  2969	  3508	  3511
	  3519	  3874	  3875	  4132	  4133	  4634	  4641	  4644	  4841	  4850	  4862	  4866	  4875	  4879
	  4886	  4890	  4905	  4918	  4963	  4965	  5780	  5782	  6274	  6278	  6282	  7848	  7850	  7860
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1
KERMSG	MAC	18-Jan-73 17:20	


Symbol cross reference

	  7862	  8260	  8262	  8273	  8278	  8279	  8326	  8328	  8977	  8978	  8982	  8984	  9019	  9023	  9035
	  9051	  9052	  9243	  9245	  9258	  9273	  9280	  9282	  9512	  9513	  9522	  9526	  9528	  9578
	  9580	  9581	  9585	  9587	  9588	  9818	  9821	  9837	 10199	 10200	 10201	 10203	 10205	 10206
	 10207	 10209	 10211	 10213	 10215	 10218	 10220	 10222	 10224	 10225	 10227	 10230	 10232	 10233
	 10934	 10944	 10947	 10976
AC4	  1428#	  1642	  1960	  2966	  2968	  3514	  3515	  4640	  4910	  6579	  6900	  8267	  8999	  9000
	  9005	  9007	  9012	  9013	  9097	  9237	  9259	  9288	  9295	  9299	  9300	  9301	  9501	  9524
	  9566	  9594	  9603	  9826	  9828	  9832	  9834	 10196	 10197	 10201
AC5	  1429#	  1643	  1961	  4641	  4644	  4911	  6575	  6576	  6901	  8263	  8265	  9098	  9271	  9282
	  9550	  9556	  9570
AC6	  1430#
AC7	  1431#
C.1	  1644	  1656#	  6580	  6902	  9099
C.10	  1959	  1988#	  2950	  3818	  5765	  6901
C.100	  9909	  9916	  9927#
C.101	 10519#
C.102	 10950	 10953	 10969	 10972	 10976#
C.103	 11479	 11612#
C.104	 11508	 11613#
C.105	 11511	 11614#
C.106	 11514	 11615#
C.107	 11517	 11616#
C.108	 11520	 11617#
C.109	 11526	 11618#
C.11	  1961	  1989#	  4909	  6799	  6899	  7132	  7233
C.110	 11529	 11619#
C.111	 11539	 11620#
C.112	 11542	 11621#
C.113	 11545	 11622#
C.114	 11551	 11623#
C.115	 11561	 11624#
C.116	 11564	 11625#
C.117	 11576	 11626#
C.118	 11582	 11627#
C.119	 11592	 11628#
C.12	  1970	  1978	  1990#	  2937	  5823	  8919	  9078	  9084
C.120	 11598	 11629#
C.121	 11603	 11630#
C.122	 11778	 11793#
C.123	 11879	 11894#
C.124	 12480	 12532	 12575#
C.125	 12496	 12547	 12576#
C.126	 12517	 12577#
C.127	 12262	 12578#
C.128	 12272	 12281	 12556	 12579#
C.129	 12275	 12580#
C.13	  2196	  2286#	  7027
C.130	 12286	 12581#
C.131	 12302	 12582#
C.132	 12308	 12583#
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1
KERMSG	MAC	18-Jan-73 17:20	


Symbol cross reference

C.133	 12314	 12584#
C.134	 12320	 12585#
C.135	 12326	 12586#
C.136	 12332	 12587#
C.137	 12338	 12588#
C.138	 12344	 12589#
C.139	 12350	 12590#
C.14	  2542	  2643#
C.140	 12356	 12591#
C.141	 12362	 12592#
C.142	 12375	 12593#
C.143	 12402	 12447	 12466	 12481	 12503	 12518	 12533	 12594#
C.144	 12409	 12455	 12474	 12489	 12511	 12526	 12541	 12595#
C.145	 12430	 12596#
C.146	 12550	 12597#
C.15	  2567	  2644#	  3634	  4183	  4512	  5821	  6423
C.16	  2569	  2645#
C.17	  2576	  2646#	  8542
C.18	  2915	  3033#	  3514	  3568	  3874	  3890	  4132	  4148	  4382	  4990	  5034	  5256	  5398	  5709
	  5738	  5843	  5889	  6293	  6316	  6430	  8347	  9012	  9300
C.19	  2966	  3034#	  5780
C.2	  1623	  1625	  1658#	  1841	  2953	  3821	  3823	  3892	  4919	  4921	  5768	  5813	  6778	  7135
	  7236	  7397	  7404	  7432	  9104
C.20	  2870	  2924	  3035#	  4974	  5021	  5382	  5717	  5741	  5830	  5876	  5911	  6280	  6319	  6344
	  6869	  6882	  7414
C.21	  2872	  2926	  3036#	  3190	  4334	  4976	  5384	  5719	  5807	 12397
C.22	  2944	  2981	  3037#	  3521	  3862	  4120	  5064	  5229	  5903	  5921	  6338	  6437	  6558	  6790
	  7124	  7225	  7944
C.23	  2952	  3038#	  5767
C.24	  3008	  3039#
C.25	  3020	  3040#	  8384	  8567	  8580	  9080
C.26	  3022	  3023	  3041#	  3570	  3617	  4492	  5023	  5202	  5743	  5832	  5878	  5913	  6321	  6346
	  6871	  6884	  8569	  8582
C.27	  3196	  3260#
C.28	  3482	  3645#
C.29	  3546	  3646#	  6359	  7741	 10465
C.3	  1643	  1659#	  9098	  9101
C.30	  3596	  3647#
C.31	  3603	  3648#
C.32	  3606	  3649#
C.33	  4078	  4212#	  6272	  8041
C.34	  4090	  4213#
C.35	  4177	  4197	  4214#	  4506	  4523	  5794	  5805	 11532	 11554
C.36	  4178	  4215#	  4507	  5806
C.37	  4179	  4180	  4216#	  4508	  4509	  9797
C.38	  4194	  4217#
C.39	  4479	  4536#
C.4	  1646	  1660#
C.40	  4863	  5074#	  6820
C.41	  4876	  5075#	  6834
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1
KERMSG	MAC	18-Jan-73 17:20	


Symbol cross reference

C.42	  4887	  5076#	  6848
C.43	  5009	  5077#
C.44	  5014	  5078#
C.45	  5200	  5262#
C.46	  5357	  5406#
C.47	  5684	  5930#
C.48	  5791	  5931#
C.49	  5808	  5932#
C.5	  1731	  1752#	  1845	  1976	  8920
C.50	  5864	  5933#
C.51	  5869	  5934#
C.52	  6229	  6447#
C.53	  6379	  6448#
C.54	  6382	  6449#
C.55	  6385	  6450#
C.56	  6777	  7044#	  7134	  7235	  9103
C.57	  6804	  7045#
C.58	  6808	  7046#
C.59	  6821	  7047#
C.6	  1733	  1753#	  1837	  1968	  2935	  2972	  3188	  6910	  7454
C.60	  6835	  7048#
C.61	  6849	  7049#
C.62	  6912	  7050#	  7456
C.63	  7145	  7151#
C.64	  7246	  7252#
C.65	  7758	  7964#
C.66	  7775	  7965#
C.67	  7792	  7966#
C.68	  7807	  7967#
C.69	  7824	  7968#
C.7	  1735	  1754#
C.70	  7837	  7969#
C.71	  7845	  7970#
C.72	  7871	  7971#
C.73	  8046	  8081#
C.74	  8051	  8082#
C.75	  8056	  8083#
C.76	  8061	  8084#
C.77	  8065	  8085#
C.78	  8069	  8086#
C.79	  8073	  8087#
C.8	  1839	  1847	  1856#	  2974	  4185	  4332	  4514	  8382	  8388
C.80	  8077	  8088#
C.81	  8326	  8426#
C.82	  8343	  8357	  8427#	  9005
C.83	  8353	  8428#	  8999
C.84	  8292	  8429#
C.85	  8296	  8430#
C.86	  8303	  8313	  8431#
C.87	  8311	  8432#
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1
KERMSG	MAC	18-Jan-73 17:20	


Symbol cross reference

C.88	  8370	  8411	  8415	  8433#
C.89	  8390	  8434#	  9086
C.9	  1962	  1987#	  4642	  4912	  8269
C.90	  8977	  9051	  9127#
C.91	  8888	  9128#	 11774	 11875	 12249
C.92	  8892	  9129#
C.93	  8910	  8963	  9130#
C.94	  8948	  9131#
C.95	  8952	  8966	  9040	  9132#
C.96	  8958	  9133#
C.97	  9113	  9134#
C.98	  9817	  9868#	 10484
C.99	  9802	  9869#
CHK%1C	  1418#
CHK%2C	  1419#
CHK%CR	  1420#
CHKTYP	  1372#	  1513	  2902	  7857	 11124
CONNEC	  1374#	  1828	  2537	  3587	  4189	  4474	  4518	  5786	  6367
CRCCLC	  1380#	  9287
DBG%DU	  1378#	  9128
DEBUG%	  1372#	  1502	  8886	 11772	 11873
DELAY	  1372#	  1499	  1830
DEV%PA	  1372#	  1516	 10818
DO%GEN	  2157#
DP%FUL	  1416#
DP%HAL	  1417#
DUPLEX	  1372#	  1500
ECHO%F	  1374#	  1506
FIL%NO	  1376#	  1537	  4175	  4504	  5803
FILE%C	  1382#	  2565	  3618	  6396
FILE%N	  1370#	  1988	  3034	  4214
FILE%O	  1382#	  4494	  5815
FILE%S	  1370#	  1951	  2962	  2965	  3812	  4215	  5777	  5781	  6906
FNM%FU	  1386#
FNM%NO	  1385#
FNM%UN	  1387#
FP	  1437#
GC%COM	  1410#
GC%CON	  1404#
GC%COP	  1406#
GC%DEL	  1399#
GC%DIR	  1397#
GC%DIS	  1398#
GC%EXI	  1396#
GC%HEL	  1401#
GC%JOU	  1412#
GC%KER	  1411#
GC%LGN	  1403#
GC%LOG	  1402#
GC%MAX	  1415#
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1
KERMSG	MAC	18-Jan-73 17:20	


Symbol cross reference

GC%MIN	  1395#
GC%PRO	  1414#
GC%REN	  1405#
GC%SEN	  1408#
GC%STA	  1409#
GC%TYP	  1400#
GC%VAR	  1413#
GC%WHO	  1407#
GEN%1D	  1376#	  1989	  5074
GEN%1S	  1376#	  1964	  4852	  4901	  4904	  4905	  4907	  4910	  6793	  6897	  6904	  7047	  7115	  7144
	  7216	  7245
GEN%2D	  1376#	  5075	  7045
GEN%2S	  1376#	  4855	  4867	  6795	  7048	  7117	  7218
GEN%3D	  1377#	  5076	  7046
GEN%3S	  1378#	  4857	  4870	  4880	  6797	  7049	  7119	  7220
GEN%PA	 10927#
GET%FI	  1382#	  1538	 11130
IBM%CH	  1374#	  1529
IBM%FL	  1374#	  1525	  8394	 10930
IBM%WA	  1378#	  8404
KRM%ER	  1380#	  2198	  2577	  2983	  3010	  3523	  3864	  4122	  5066	  5231	  5905	  5923	  6340	  6439
	  6560	  7029	  7126	  7227	  7946	  8544	  8931	  9862
L.1	  1635	  1638#
L.10	  2178	  2210#
L.100	  3840	  3853#
L.101	  3845	  3857#
L.102	  3861	  3868#
L.103	  3871	  3877#
L.104	  3849	  3851	  3876	  3883#
L.105	  3879	  3882	  3885#
L.106	  3867	  3897	  3900#
L.107	  3800	  3855	  3884	  3899	  3901#
L.108	  4071	  4074#
L.109	  4083	  4087#
L.11	  2179	  2215#
L.110	  4086	  4089#
L.111	  4088	  4090#
L.112	  4097	  4111#
L.113	  4103	  4115#
L.114	  4119	  4126#
L.115	  4129	  4135#
L.116	  4107	  4109	  4134	  4141#
L.117	  4137	  4140	  4143#
L.118	  4153	  4156#
L.119	  4159	  4162#
L.12	  2180	  2220#
L.120	  4125	  4165#
L.121	  4164	  4167#
L.122	  4161	  4170#
L.123	  4176	  4183#
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1
KERMSG	MAC	18-Jan-73 17:20	


Symbol cross reference

L.124	  4190	  4193	  4204#
L.125	  4073	  4113	  4142	  4166	  4168	  4209#
L.126	  4327	  4330#
L.127	  4339	  4342#
L.128	  4350	  4352#
L.129	  4346	  4358#
L.13	  2181	  2223#
L.130	  4361	  4366#
L.131	  4365	  4368#
L.132	  4371	  4374#
L.133	  4475	  4478	  4486#
L.134	  4497	  4500#
L.135	  4491	  4502#
L.136	  4505	  4512#
L.137	  4519	  4522	  4530#
L.138	  4832	  4835#
L.139	  4854	  4856	  4859#
L.14	  2182	  2228#
L.140	  4869	  4872#
L.141	  4882	  4893#
L.142	  4871	  4895#
L.143	  4846	  4899#
L.144	  4902	  4905#
L.145	  4858	  4897	  4914#
L.146	  4936	  4940#
L.147	  4948	  4950#
L.148	  4944	  4958#
L.149	  4969	  4972#
L.15	  2184	  2233#
L.150	  4962	  4997#
L.151	  5008	  5021#
L.152	  4999	  5041#
L.153	  5043	  5057#
L.154	  5059	  5064#
L.155	  4834	  4939	  4957	  4971	  4996	  5040	  5056	  5063	  5071#
L.156	  5195	  5198#
L.157	  5207	  5220#
L.158	  5212	  5224#
L.159	  5228	  5237#
L.16	  2185	  2236#
L.160	  5241	  5243#
L.161	  5216	  5218	  5242	  5249#
L.162	  5245	  5248	  5251#
L.163	  5324	  5327#
L.164	  5365	  5368#
L.165	  5367	  5369#
L.166	  5362	  5371#
L.167	  5377	  5380#
L.168	  5478	  5481	  5485#
L.169	  5484	  5488#
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1
KERMSG	MAC	18-Jan-73 17:20	


Symbol cross reference

L.17	  2186	  2239#
L.170	  5689	  5695#
L.171	  5699	  5726#
L.172	  5725	  5746#
L.173	  5728	  5753#
L.174	  5703	  5732	  5760#
L.175	  5759	  5762#
L.176	  5787	  5790	  5801#
L.177	  5804	  5811#
L.178	  5818	  5821#
L.179	  5755	  5848#
L.18	  2187	  2242#
L.180	  5863	  5876#
L.181	  5847	  5893#
L.182	  5850	  5896#
L.183	  5764	  5854	  5903#
L.184	  5692	  5820	  5908#
L.185	  5902	  5911#
L.186	  5711	  5740	  5898	  5921#
L.187	  5752	  5895	  5920	  5926#
L.188	  6003	  6007#
L.189	  6001	  6006	  6009	  6015#
L.19	  2188	  2245#
L.190	  6011	  6014	  6018#
L.191	  6234	  6240#
L.192	  6248	  6255#
L.193	  6262	  6266#
L.194	  6265	  6272#
L.195	  6269	  6278#
L.196	  6276	  6280#
L.197	  6244	  6300#
L.198	  6303	  6305#
L.199	  6252	  6309#
L.2	  1729#	  1745
L.20	  2189	  2250#
L.200	  6253	  6308	  6311#
L.201	  6304	  6331#
L.202	  6337	  6344#
L.203	  6358	  6365#
L.204	  6378	  6382#
L.205	  6374	  6385#
L.206	  6381	  6384	  6387#
L.207	  6368	  6371	  6392#
L.208	  6237	  6258	  6343	  6401#
L.209	  6399	  6403#
L.21	  2190	  2253#
L.210	  6409	  6412#
L.211	  6405	  6415#
L.212	  6352	  6419#
L.213	  6411	  6413	  6417	  6423#
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1
KERMSG	MAC	18-Jan-73 17:20	


Symbol cross reference

L.214	  6318	  6333	  6437#
L.215	  6299	  6330	  6436	  6442#
L.216	  6239	  6310	  6402	  6444#
L.217	  6557	  6568#
L.218	  6548	  6591#
L.219	  6567	  6589	  6592#
L.22	  2191	  2258#
L.220	  6788	  6793#
L.221	  6824	  6828#
L.222	  6838	  6842#
L.223	  6852	  6856#
L.224	  6842	  6858#
L.225	  6828	  6860#
L.226	  6814	  6862#
L.227	  6868	  6879#
L.228	  6881	  6894#
L.229	  6917	  6920	  6924#
L.23	  2192	  2263#
L.230	  6923	  6925#
L.231	  6896	  6929#
L.232	  6931	  6936#
L.233	  6938	  6943#
L.234	  6945	  6950#
L.235	  6952	  6957#
L.236	  6959	  6964#
L.237	  6966	  6971#
L.238	  6973	  6978#
L.239	  6980	  6985#
L.24	  2262	  2265#
L.240	  6987	  6992#
L.241	  6994	  6999#
L.242	  7001	  7006#
L.243	  7008	  7013#
L.244	  7015	  7020#
L.245	  7022	  7027#
L.246	  6792	  7029#
L.247	  6827	  6841	  6855	  7032#
L.248	  6934	  6941	  6948	  6955	  6962	  6969	  6976	  6983	  6990	  6997	  7004	  7011	  7018	  7025
	  7035#
L.249	  6878	  6893	  6927	  7034	  7039#
L.25	  2195	  2268#
L.250	  7123	  7132#
L.251	  7224	  7233#
L.252	  7384	  7388#
L.253	  7421	  7424#
L.254	  7423	  7425#
L.255	  7413	  7427#
L.256	  7403	  7436#
L.257	  7390	  7443#
L.258	  7441	  7445	  7451#
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1
KERMSG	MAC	18-Jan-73 17:20	


Symbol cross reference

L.259	  7461	  7464	  7468#
L.26	  2193	  2273#
L.260	  7467	  7469#
L.261	  7387	  7426	  7471#
L.262	  7740	  7747#
L.263	  7737	  7745	  7749#
L.264	  7757	  7764#
L.265	  7753	  7762	  7766#
L.266	  7774	  7781#
L.267	  7770	  7779	  7783#
L.268	  7791	  7796#
L.269	  7787	  7798#
L.27	  2194	  2276#
L.270	  7806	  7813#
L.271	  7802	  7811	  7815#
L.272	  7823	  7829#
L.273	  7819	  7827	  7831#
L.274	  7836	  7840#
L.275	  7839	  7841#
L.276	  7851	  7857#
L.277	  7855	  7860#
L.278	  7844	  7865#
L.279	  7856	  7859	  7867#
L.28	  2206	  2209	  2214	  2219	  2222	  2227	  2232	  2235	  2238	  2241	  2244	  2249	  2252	  2257
	  2272	  2275	  2278#
L.280	  7863	  7868#
L.281	  7870	  7874#
L.282	  7873	  7875#
L.283	  7879	  7882#
L.284	  7881	  7887#
L.285	  7890	  7893#
L.286	  7895	  7898#
L.287	  7892	  7897	  7899	  7902#
L.288	  7911	  7914#
L.289	  7918	  7924#
L.29	  2266	  2279#
L.290	  7922	  7926#
L.291	  7929	  7932#
L.292	  7931	  7936#
L.293	  7935	  7938	  7942#
L.294	  7885	  7901	  7906	  7944#
L.295	  7941	  7943	  7952#
L.296	  7955	  7959#
L.297	  7958	  7960#
L.298	  8262	  8290#
L.299	  8333	  8334#
L.3	  1743	  1747#
L.30	  2203	  2283#
L.300	  8334	  8337#
L.301	  8335	  8343#
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1
KERMSG	MAC	18-Jan-73 17:20	


Symbol cross reference

L.302	  8336	  8353#
L.303	  8341	  8351	  8367#
L.304	  8379	  8386#
L.305	  8385	  8391#
L.306	  8396	  8399	  8403	  8407	  8411#
L.307	  8410	  8420#
L.308	  8538#	  8573
L.309	  8541	  8550#
L.31	  2496#	  2596	  2602	  2605	  2608	  2611	  2614	  2617	  2620	  2623	  2626	  2629	  2632
L.310	  8558	  8560	  8564#
L.311	  8566	  8575#
L.312	  8579	  8589#
L.313	  8549	  8563	  8591#
L.314	  8887	  8902#
L.315	  8905	  8910#
L.316	  8918	  8923#
L.317	  8929	  8932#
L.318	  8925	  8937#
L.319	  8940	  8946#
L.32	  2497#	  2592
L.320	  8986	  8987#
L.321	  8987	  8990#
L.322	  8989	  8996#
L.323	  8988	  9002#
L.324	  8995	  9001	  9008	  9014#
L.325	  8994	  9016#
L.326	  9022	  9027	  9032#
L.327	  9031	  9035#
L.328	  9058	  9064#
L.329	  9034	  9068#
L.33	  2502	  2504#
L.330	  9063	  9070#
L.331	  9018	  9066	  9072#
L.332	  9075	  9082#
L.333	  9081	  9087#
L.334	  9091	  9095#
L.335	  8936	  8945	  9071	  9094	  9122#
L.336	  9241	  9245#
L.337	  9244	  9246#
L.338	  9249	  9250#
L.339	  9250	  9251	  9253#
L.34	  2500	  2503	  2513	  2514	  2522	  2523	  2524#
L.340	  9256#	  9263
L.341	  9255	  9260#
L.342	  9252	  9266#
L.343	  9275#	  9283
L.344	  9274	  9280#
L.345	  9270	  9284#
L.346	  9264	  9291#
L.347	  9294	  9301#
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1
KERMSG	MAC	18-Jan-73 17:20	


Symbol cross reference

L.348	  9514#	  9522
L.349	  9513	  9517	  9522#
L.35	  2538	  2541	  2548#
L.350	  9508	  9520	  9524#
L.351	  9526#	  9568	  9574	  9582	  9589	  9596
L.352	  9536	  9540#
L.353	  9543	  9547#
L.354	  9539	  9541	  9546	  9550#
L.355	  9549	  9556#
L.356	  9554	  9561#
L.357	  9563	  9570#
L.358	  9572	  9575#
L.359	  9580	  9583#
L.36	  2532	  2572#
L.360	  9577	  9585#
L.361	  9587	  9590#
L.362	  9583	  9592#
L.363	  9529	  9598#
L.364	  9789	  9797#
L.365	  9799	  9808#
L.366	  9796	  9810#
L.367	  9806	  9811#
L.368	  9820	  9823#
L.369	  9829	  9832#
L.37	  2517	  2580#
L.370	  9822	  9825	  9831	  9837#
L.371	  9836	  9852#
L.372	  9814	  9858#
L.373	  9850	  9856	  9860	  9864#
L.374	  9908	  9912	  9915	  9923#
L.378	 10141#	 10147
L.379	 10140	 10144#
L.38	  2583	  2587#
L.380	 10148#	 10270
L.381	 10153#	 10302
L.382	 10160#	 10179	 10185	 10192
L.383	 10172	 10175#
L.384	 10174	 10176#
L.385	 10182	 10187#
L.386	 10163	 10166	 10194#
L.387	 10212	 10218#
L.388	 10208	 10230#
L.389	 10202
L.39	  2518	  2594#
L.395	 10263#	 10269
L.396	 10262	 10266#
L.397	 10159	 10271#
L.398	 10284#	 10289
L.399	 10283	 10289#
L.4	  1829	  1833#
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1
KERMSG	MAC	18-Jan-73 17:20	


Symbol cross reference

L.40	  2519	  2520	  2597#
L.400	 10294	 10297#
L.401	 10296	 10298#
L.402	 10155	 10221	 10228	 10256	 10276	 10304#
L.403	 10306	 10309#
L.404	 10308	 10310#
L.405	 10469#	 10507
L.406	 10478	 10481	 10492#
L.407	 10490	 10494#
L.408	 10496
L.41	  2506	  2600#
L.411	 10505
L.412	 10500	 10503#
L.413	 10505#
L.414	 10471	 10509#
L.415	 10502	 10511#
L.416	 10619	 10629#
L.417	 10659	 10668#
L.418	 10710	 10735#
L.419	 10828#	 10838
L.42	  2505	  2603#
L.420	 10827	 10835#
L.421	 10819	 10839#
L.422	 10931	 10934#
L.423	 10938	 10939#
L.424	 10939	 10944#
L.425	 10940	 10947#
L.426	 10942	 10950#
L.427	 10941	 10953#
L.428	 10966	 10969#
L.429	 10933	 10949	 10971#
L.43	  2507	  2606#
L.430	 10943	 10968	 10972#
L.431	 11486	 11488#
L.432	 11484	 11487	 11498	 11503	 11504	 11505	 11506	 11507	 11508#
L.433	 11501	 11502	 11511#
L.434	 11488	 11489	 11514#
L.435	 11500	 11517#
L.436	 11499	 11520#
L.437	 11490	 11523#
L.438	 11491	 11529#
L.439	 11516	 11531#
L.44	  2504	  2609#
L.440	 11492	 11539#
L.441	 11493	 11542#
L.442	 11494	 11545#
L.443	 11495	 11548#
L.444	 11528	 11553#
L.445	 11496	 11561#
L.446	 11497	 11564#
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1
KERMSG	MAC	18-Jan-73 17:20	


Symbol cross reference

L.447	 11510	 11513	 11519	 11522	 11541	 11544	 11547	 11563	 11566#
L.448	 11537	 11559	 11567#
L.449	 11569	 11572	 11585#
L.45	  2521	  2612#
L.450	 11584	 11600#
L.451	 11575	 11588	 11591	 11603#
L.452	 11773	 11790#
L.453	 11874	 11891#
L.454	 12301	 12305#
L.455	 12307	 12311#
L.456	 12313	 12317#
L.457	 12319	 12323#
L.458	 12325	 12329#
L.459	 12331	 12335#
L.46	  2516	  2615#
L.460	 12337	 12341#
L.461	 12343	 12347#
L.462	 12349	 12353#
L.463	 12355	 12359#
L.464	 12304	 12310	 12316	 12322	 12328	 12334	 12340	 12346	 12352	 12358	 12364#
L.465	 12361	 12366#
L.466	 12390#	 12417
L.467	 12394	 12402#
L.468	 12389	 12414#
L.469	 12374	 12430#
L.47	  2515	  2618#
L.470	 12443	 12444#
L.471	 12444	 12447#
L.472	 12445	 12464#
L.473	 12446	 12501#
L.474	 12462	 12499	 12550#
L.48	  2508	  2621#
L.49	  2511	  2624#
L.5	  1953	  1968#
L.50	  2510	  2627#
L.51	  2509	  2630#
L.52	  2512	  2633#
L.53	  2575	  2579	  2635#
L.54	  2599	  2639#
L.55	  2862	  2909#
L.56	  2867	  2878	  2921	  2931	  2944#
L.57	  2911	  2947#
L.58	  2970	  2981#
L.59	  2949	  2987#
L.6	  2175	  2177#
L.60	  2989	  2994#
L.61	  2996	  3001#
L.62	  3003	  3008#
L.63	  2946	  3010#
L.64	  2857	  3014#
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1
KERMSG	MAC	18-Jan-73 17:20	


Symbol cross reference

L.65	  2986	  3013	  3018#
L.66	  3017	  3020#
L.67	  2854	  3028#
L.68	  2908	  2943	  2980	  2992	  2999	  3006	  3019	  3029#
L.69	  3183	  3186#
L.7	  2173	  2176	  2196#
L.70	  3217	  3219	  3223#
L.71	  3222	  3224#
L.72	  3213	  3227#
L.73	  3195	  3240#
L.74	  3238	  3242#
L.75	  3210	  3247#
L.76	  3230	  3233	  3252#
L.77	  3185	  3225	  3241	  3251	  3256#
L.78	  3477	  3480#
L.79	  3489	  3502#
L.8	  2177	  2204#
L.80	  3494	  3506#
L.81	  3510	  3517#
L.82	  3520	  3529#
L.83	  3498	  3500	  3516	  3538#
L.84	  3533	  3537	  3540#
L.85	  3551	  3557#
L.86	  3542	  3545	  3555	  3559	  3563#
L.87	  3473	  3570#
L.88	  3575	  3578	  3581	  3585#
L.89	  3595	  3599#
L.9	  2183	  2207#
L.90	  3602	  3606#
L.91	  3598	  3605	  3608#
L.92	  3588	  3591	  3613#
L.93	  3616	  3620#
L.94	  3625	  3630#
L.95	  3628	  3634#
L.96	  3798	  3801#
L.97	  3808	  3811#
L.98	  3810	  3812#
L.99	  3814	  3817	  3833#
LAST%E	  1370#	  1659	  9134
MAX%MS	  1421#
MSG%IN	  1443#
NEXT%F	  1382#	  4154
P.AAA	  2483#	  2643
P.AAB	  3458#	  3647
P.AAC	  3463#	  3648
P.AAD	  3466#	  3649
P.AAE	  4061#	  4217
P.AAF	  4467#	  4536
P.AAG	  4822#	  5077
P.AAH	  4823#	  5078
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1
KERMSG	MAC	18-Jan-73 17:20	


Symbol cross reference

P.AAI	  5672#	  5931
P.AAJ	  5675#	  5933
P.AAK	  5676#	  5934
P.AAL	  6212#	  6448
P.AAM	  6215#	  6449
P.AAN	  6222#	  6450
P.AAO	  8868#	  8876
P.AAP	 11394#	 11614
P.AAQ	 11398#	 11615
P.AAR	 11405#	 11616
P.AAS	 11412#	 11617
P.AAT	 11420#	 11618
P.AAU	 11426#	 11619
P.AAV	 11430#	 11620
P.AAW	 11436#	 11621
P.AAX	 11442#	 11622
P.AAY	 11450#	 11623
P.AAZ	 11457#	 11624
P.ABA	 11461#	 11625
P.ABB	 11465#	 11613
P.ABC	 11468#	 11626
P.ABD	 11469#	 11627
P.ABE	 11472#	 11628
P.ABF	 11473#	 11629
P.ABG	 11758#	 11764
P.ABH	 11859#	 11865
P.ABI	 12142#	 12199
P.ABJ	 12144#	 12201
P.ABK	 12146#	 12203
P.ABL	 12148#	 12205
P.ABM	 12151#	 12207
P.ABN	 12153#	 12209
P.ABO	 12156#	 12211
P.ABP	 12159#	 12213
P.ABQ	 12161#	 12215
P.ABR	 12163#	 12217
P.ABS	 12167#	 12219
P.ABT	 12170#	 12221
P.ABU	 12176#	 12223
P.ABV	 12180#	 12225
P.ABW	 12182#	 12227
P.ABX	 12184#	 12229
P.ABY	 12187#	 12231
P.ABZ	 12190#	 12233
P.ACA	 12191#	 12235
P.ACB	 12195#	 12237
PARITY	  1372#	  1518	  9239	 10936	 11091
PKT%RE	  1371#	  1493	  3476	  3797	  4070	  4831	  5194	  5731	  6251	  6307	  8540
PR%EVE	  1391#
PR%MAR	  1390#
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1
KERMSG	MAC	18-Jan-73 17:20	


Symbol cross reference

PR%MAX	  1394#
PR%MIN	  1388#
PR%NON	  1389#
PR%ODD	  1392#
PR%SPA	  1393#
PUT%FI	  1382#	  1541	 11133
RCV%8Q	  1362#	  1465	  2899	 11093
RCV%CO	  1366#	 11228
RCV%DA	  1366#	 11240
RCV%EO	  1360#	  1456	  8058
RCV%NA	  1366#	 11246
RCV%NP	  1360#	  1447	  8048
RCV%PA	  1360#	  1449	  8053
RCV%PK	  1360#	  1446	  8038
RCV%QU	  1360#	  1459	  7904	  7939	  8063	  9824	  9847
RCV%SO	  1361#	  1462
RCV%TI	  1360#	  1453	  8043
RCV%TO	  1365#	 11237
REC%SW	  1942#
RECEIV	  1378#	  8914
RMSG%C	  1368#	  9082	 11154	 11226
RMSG%D	  1369#	 11150	 11238
RMSG%N	  1370#	  9076	 11156	 11244	 11573	 11579
RMSG%T	  1368#	  8946	 11146	 11235
SEND	  1378#	  8287	  8418
SEND%S	  1823#
SEND%T	  1364#	  2580	  2586	  2590	  2882	  7766	 11114
SERVER	  1727#
SET%RE	  1362#	  1468	  2905	 11127
SI%RET	  1371#	  1496	  3016	  3182	  4326	  5702
SMSG%C	  1367#	  8386	 11152	 11223
SMSG%D	  1368#	 10240	 10244	 10277	 11148	 11232
SMSG%N	  1369#	  8380	 11158	 11241	 11589	 11595
SMSG%T	  1368#	  8273	  8374	 11144	 11229
SND%CO	  1366#	 11225
SND%DA	  1366#	 11234
SND%EO	  1363#	  1481	  2893	  7800	 11115
SND%ER	  1612#
SND%NA	  1366#	 11243
SND%NP	  1362#	  1472	  2887	  7768	 11106
SND%PA	  1362#	  1474	  2890	  7785	 11109
SND%PK	  1362#	  1471	  2881	  7735	 11103
SND%QU	  1364#	  1484	  2896	  7817	 11118
SND%SO	  1364#	  1487	  8294
SND%TI	  1363#	  1478	  2884	  7751	 11112
SND%TO	  1364#	 11231
SP	  1439#	  1544	  1613	  1615	  1616	  1620	  1621	  1622	  1623	  1624	  1625	  1627	  1628	  1630
	  1631	  1632	  1637	  1641	  1646	  1648	  1649	  1650	  1651	  1652	  1654	  1655	  1727	  1729
	  1731	  1733	  1734	  1735	  1737	  1739	  1749	  1751	  1824	  1830	  1831	  1832	  1833	  1837
	  1839	  1840	  1841	  1843	  1845	  1847	  1848	  1849	  1853	  1855	  1943	  1949	  1968	  1970
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1
KERMSG	MAC	18-Jan-73 17:20	


Symbol cross reference

	  1971	  1972	  1974	  1976	  1978	  1979	  1980	  1984	  1986	  2158	  2160	  2171	  2196	  2198	  2199
	  2279	  2281	  2282	  2283	  2285	  2489	  2491	  2494	  2542	  2544	  2545	  2546	  2564	  2565
	  2566	  2567	  2569	  2570	  2571	  2576	  2577	  2578	  2587	  2594	  2600	  2603	  2606	  2609
	  2612	  2615	  2618	  2621	  2624	  2627	  2630	  2635	  2639	  2641	  2642	  2846	  2848	  2849
	  2863	  2868	  2870	  2872	  2873	  2874	  2876	  2917	  2922	  2924	  2926	  2927	  2928	  2929
	  2935	  2937	  2938	  2939	  2944	  2950	  2952	  2953	  2954	  2955	  2957	  2959	  2960	  2961
	  2972	  2974	  2975	  2976	  2981	  2983	  2984	  2990	  2997	  3004	  3008	  3010	  3011	  3020
	  3022	  3023	  3024	  3025	  3029	  3031	  3032	  3103	  3175	  3177	  3178	  3188	  3190	  3191
	  3192	  3193	  3196	  3198	  3200	  3203	  3205	  3207	  3224	  3234	  3239	  3247	  3252	  3256
	  3258	  3259	  3479	  3482	  3484	  3485	  3486	  3487	  3490	  3504	  3521	  3523	  3524	  3528
	  3539	  3570	  3572	  3573	  3584	  3596	  3603	  3606	  3608	  3609	  3611	  3617	  3618	  3619
	  3634	  3636	  3637	  3640	  3643	  3789	  3818	  3820	  3821	  3822	  3823	  3825	  3826	  3828
	  3829	  3830	  3831	  3833	  3835	  3836	  3837	  3838	  3841	  3862	  3864	  3865	  3892	  3894
	  3895	  3901	  3903	  4066	  4090	  4092	  4093	  4094	  4095	  4098	  4120	  4122	  4123	  4154
	  4177	  4178	  4179	  4180	  4181	  4182	  4183	  4185	  4186	  4194	  4196	  4197	  4199	  4200
	  4202	  4206	  4209	  4211	  4322	  4329	  4332	  4334	  4335	  4336	  4337	  4341	  4342	  4357
	  4367	  4368	  4373	  4386	  4479	  4481	  4482	  4484	  4492	  4494	  4495	  4499	  4506	  4507
	  4508	  4509	  4510	  4511	  4512	  4514	  4515	  4523	  4525	  4526	  4528	  4530	  4534	  4618
	  4622	  4623	  4624	  4626	  4628	  4629	  4632	  4634	  4636	  4639	  4640	  4645	  4647	  4827
	  4837	  4840	  4849	  4859	  4861	  4862	  4863	  4864	  4865	  4872	  4874	  4875	  4876	  4877
	  4878	  4883	  4885	  4886	  4887	  4888	  4889	  4891	  4893	  4895	  4911	  4914	  4917	  4918
	  4919	  4920	  4921	  4923	  4924	  4926	  4927	  4928	  4929	  4931	  4932	  4933	  4934	  4937
	  4940	  4953	  4966	  4970	  4972	  4974	  4976	  4977	  4978	  4992	  5009	  5011	  5012	  5014
	  5016	  5017	  5019	  5021	  5023	  5024	  5025	  5036	  5047	  5051	  5052	  5060	  5064	  5066
	  5067	  5071	  5073	  5197	  5200	  5202	  5203	  5204	  5205	  5208	  5222	  5229	  5231	  5232
	  5236	  5250	  5260	  5326	  5328	  5357	  5359	  5360	  5370	  5374	  5379	  5380	  5382	  5384
	  5385	  5386	  5400	  5404	  5487	  5489	  5684	  5686	  5687	  5694	  5712	  5717	  5719	  5720
	  5721	  5741	  5743	  5744	  5745	  5748	  5761	  5765	  5767	  5768	  5769	  5770	  5772	  5774
	  5775	  5776	  5791	  5793	  5794	  5796	  5797	  5799	  5805	  5806	  5807	  5808	  5809	  5810
	  5813	  5815	  5816	  5819	  5821	  5823	  5824	  5830	  5832	  5833	  5834	  5845	  5864	  5866
	  5867	  5869	  5871	  5872	  5874	  5876	  5878	  5879	  5880	  5891	  5903	  5905	  5906	  5910
	  5911	  5913	  5914	  5915	  5916	  5921	  5923	  5926	  5928	  6017	  6019	  6227	  6229	  6231
	  6232	  6255	  6280	  6282	  6283	  6284	  6295	  6319	  6321	  6322	  6323	  6326	  6338	  6340
	  6341	  6344	  6346	  6347	  6348	  6379	  6382	  6385	  6387	  6388	  6390	  6395	  6396	  6397
	  6400	  6419	  6421	  6423	  6425	  6426	  6432	  6437	  6439	  6442	  6444	  6446	  6541	  6543
	  6544	  6545	  6546	  6549	  6551	  6558	  6560	  6563	  6573	  6592	  6594	  6595	  6596	  6597
	  6769	  6771	  6772	  6773	  6776	  6777	  6778	  6779	  6780	  6782	  6784	  6785	  6786	  6790
	  6810	  6813	  6816	  6818	  6819	  6820	  6821	  6822	  6826	  6830	  6832	  6833	  6834	  6835
	  6836	  6840	  6844	  6846	  6847	  6848	  6849	  6850	  6854	  6856	  6858	  6860	  6862	  6869
	  6871	  6872	  6873	  6874	  6882	  6884	  6885	  6886	  6887	  6889	  6910	  6912	  6913	  6925
	  7027	  7029	  7030	  7035	  7037	  7038	  7039	  7041	  7042	  7043	  7124	  7126	  7127	  7131
	  7132	  7134	  7135	  7136	  7137	  7139	  7141	  7142	  7143	  7145	  7147	  7148	  7149	  7225
	  7227	  7228	  7232	  7233	  7235	  7236	  7237	  7238	  7240	  7242	  7243	  7244	  7246	  7248
	  7249	  7250	  7365	  7367	  7368	  7369	  7371	  7373	  7375	  7376	  7377	  7378	  7379	  7380
	  7381	  7382	  7388	  7391	  7395	  7396	  7397	  7398	  7404	  7406	  7407	  7409	  7410	  7411
	  7414	  7416	  7417	  7418	  7419	  7425	  7430	  7431	  7432	  7433	  7434	  7439	  7443	  7454
	  7456	  7457	  7469	  7471	  7473	  7474	  7475	  7944	  7946	  7947	  7951	  7962	  8079	  8255
	  8257	  8258	  8259	  8263	  8268	  8271	  8275	  8277	  8279	  8280	  8281	  8283	  8286	  8287
	  8288	  8290	  8298	  8307	  8315	  8319	  8320	  8370	  8372	  8373	  8376	  8382	  8384	  8388
	  8390	  8391	  8404	  8408	  8411	  8413	  8414	  8415	  8417	  8418	  8419	  8420	  8422	  8423
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1
KERMSG	MAC	18-Jan-73 17:20	


Symbol cross reference

	  8424	  8425	  8536	  8542	  8544	  8545	  8552	  8567	  8569	  8570	  8571	  8572	  8575	  8577	  8580
	  8582	  8583	  8584	  8585	  8591	  8593	  8880	  8882	  8883	  8888	  8890	  8892	  8894	  8895
	  8897	  8899	  8900	  8906	  8910	  8912	  8913	  8914	  8919	  8920	  8921	  8922	  8930	  8931
	  8932	  8937	  8941	  8963	  8965	  8968	  8972	  8973	  9042	  9046	  9047	  9061	  9064	  9068
	  9078	  9080	  9084	  9086	  9087	  9092	  9101	  9103	  9104	  9105	  9106	  9108	  9110	  9111
	  9112	  9113	  9115	  9116	  9118	  9122	  9124	  9125	  9126	  9256	  9262	  9266	  9271	  9284
	  9286	  9287	  9289	  9303	  9484	  9486	  9487	  9488	  9489	  9490	  9497	  9503	  9510	  9526
	  9578	  9585	  9598	  9604	  9606	  9607	  9608	  9609	  9610	  9611	  9802	  9803	  9805	  9861
	  9862	  9863	  9866	  9904	  9925	 10173	 10175	 10295	 10297	 10310	 10312	 10313	 10458	 10460
	 10461	 10462	 10463	 10464	 10501	 10503	 10511	 10513	 10514	 10515	 10516	 10517	 10518	 10622
	 10628	 10630	 10662	 10667	 10669	 10709	 10711	 10714	 10717	 10734	 10744	 10812	 10814	 10815
	 10820	 10824	 10831	 10832	 10834	 10839	 10841	 10842	 10843	 10932	 10934	 10946	 10974	 11160
	 11163	 11247	 11252	 11479	 11481	 11508	 11511	 11514	 11517	 11520	 11523	 11525	 11526	 11529
	 11531	 11532	 11534	 11535	 11539	 11542	 11545	 11548	 11550	 11551	 11553	 11554	 11556	 11557
	 11561	 11564	 11566	 11576	 11578	 11579	 11581	 11582	 11592	 11594	 11595	 11597	 11598	 11600
	 11601	 11603	 11605	 11606	 11608	 11610	 11682	 11684	 11685	 11689	 11768	 11774	 11776	 11778
	 11780	 11781	 11783	 11784	 11785	 11787	 11788	 11790	 11792	 11869	 11875	 11877	 11879	 11881
	 11882	 11884	 11885	 11886	 11888	 11889	 11891	 11893	 12241	 12243	 12244	 12245	 12246	 12247
	 12248	 12249	 12251	 12253	 12260	 12262	 12264	 12270	 12271	 12272	 12274	 12275	 12277	 12278
	 12280	 12281	 12283	 12284	 12286	 12288	 12293	 12294	 12302	 12308	 12314	 12320	 12326	 12332
	 12338	 12344	 12350	 12356	 12362	 12364	 12365	 12366	 12375	 12377	 12378	 12395	 12397	 12399
	 12400	 12402	 12404	 12407	 12408	 12409	 12411	 12412	 12425	 12426	 12428	 12430	 12432	 12447
	 12449	 12453	 12454	 12455	 12457	 12466	 12468	 12472	 12473	 12474	 12476	 12481	 12483	 12487
	 12488	 12489	 12491	 12497	 12503	 12505	 12509	 12510	 12511	 12513	 12518	 12520	 12524	 12525
	 12526	 12528	 12533	 12535	 12539	 12540	 12541	 12543	 12548	 12550	 12552	 12553	 12555	 12556
	 12558	 12559	 12561	 12563	 12564	 12566	 12568	 12569	 12570	 12571	 12572	 12573	 12574
SRV%TI	  1364#	  1490	  2585
SY%DIS	  1382#	  1831
SY%GEN	  1381#	  7381
SY%LOG	  1380#	  6887
SY%TIM	  1382#	 11160	 11247
TERM%D	  1378#
TOTAL%	  1370#	 11250
TT%CHA	  1379#	 11481	 11605	 11684	 12294	 12399	 12408	 12411	 12454	 12457	 12473	 12476	 12488	 12491
	 12510	 12513	 12525	 12528	 12540	 12543
TT%CRL	  1379#	  2546	  3609	  5017	  5051	  5872	  6388	  6419	  8895	  9116	 11606	 12260	 12284	 12366
	 12378	 12395	 12425	 12426	 12559
TT%NUM	  1380#	 11525	 11550	 11581	 11597	 12271	 12280	 12555
TT%OUT	  1380#	  3203	  4200	  4482	  4526	  5797	  6421
TT%SET	  1378#	  3198	  3207	  8890	  8899	 11776	 11787	 11877	 11888	 12251	 12563
TT%TEX	  1380#	  2544	  3608	  4196	  4199	  4481	  4525	  5011	  5016	  5793	  5796	  5866	  5871	  6387
	  8894	  9115	 11531	 11534	 11553	 11556	 11566	 11578	 11594	 11600	 11780	 11881	 12264	 12274
	 12277	 12283	 12288	 12364	 12377	 12404	 12432	 12449	 12468	 12483	 12505	 12520	 12535	 12552
	 12558
TY%FIL	  1376#	  1532	  2540	  3590	  4192	  4477	  4521	  5789	  6370
TY%PKT	  1376#	  1533
TYP%ST	  1375#	  8904	  8908
U.1	  1737	  1843	  1974	  2281	  2489#
U.10	  2587	  2594	  2846#
U.100	 11764#	 11793
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1
KERMSG	MAC	18-Jan-73 17:20	


Symbol cross reference

U.101	 11865#	 11894
U.103	 12199#	 12582
U.104	 12201#	 12583
U.105	 12203#	 12584
U.106	 12205#	 12585
U.107	 12207#	 12586
U.108	 12209#	 12588
U.109	 12211#	 12587
U.11	  2630	  5357#
U.110	 12213#	 12589
U.111	 12215#	 12590
U.112	 12217#
U.113	 12219#	 12592
U.114	 12221#	 12591
U.115	 12223#	 12578
U.116	 12225#	 12580
U.117	 12227#	 12579
U.118	 12229#	 12581
U.119	 12231#	 12596
U.12	  2627	  5680#
U.120	 12233#	 12597
U.121	 12235#	 12593
U.122	 12237#	 12594
U.13	  2624	  6227#
U.14	  2990	  6769#
U.15	  2997	  7115#
U.16	  3004	  7216#
U.17	  7037	  7147	  7248	  7365#
U.18	  2635	 11223#
U.19	  8320	  8973	  9047	  9237#
U.2	  2615	  3175#
U.20	  2868	  2922	  3178	  4322	  4972	  5380	  5712	  8038#
U.21	  2863	  2917	  3234	  4368	  4966	  5374	  7735#
U.22	  8280	  8414	 10812#
U.23	 10832	 10926#
U.24	  1650	  2874	  2928	  3024	  3192	  3486	  3837	  4094	  4336	  4933	  4978	  5025	  5204	  5386
	  5721	  5745	  5834	  5880	  5915	  6284	  6323	  6348	  6873	  6886	  7418	  8255#	  8571	  8584
U.25	  5359	  5686	  6231	  8536#
U.26	  2849	  3200	  3490	  3841	  4098	  4342	  4940	  5208	  8552	  8880#
U.27	  4181	  4510	  5809	  9484#
U.28	  2955	  5012	  5047	  5770	  5867	  6255	  6780	  7137	  7238	  9106	 10458#
U.29	  1627	  3572	  3825	  3894	  4923	  7406
U.3	  2600	  3471#
U.30	  1624	  1632	  2954	  2961	  3822	  3830	  4920	  4928	  5769	  5776	  6779	  6786	  7136	  7143
	  7237	  7244	  7398	  7411	  7433	  9105	  9112	 10707#
U.31	  5003	  5044	  5858	 11682#
U.32	  1729	  1833	  1949	  2160	 11091#
U.33	  8906	 11479#
U.34	 11784	 11885	 12241#
U.35	  8373	 11768#
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1
KERMSG	MAC	18-Jan-73 17:20	


Symbol cross reference

U.36	  8965	 11869#
U.37	  1297#	  7912	 11097	 11100
U.38	  1299#	  2903	  7875	  7926	  7954	  8075	  9830	 10234	 10476	 11129
U.39	  1301#	  2879	  7399	  7749	 11105
U.4	  2603	  3789#
U.40	  1303#	  2885	  7783	  8260	  8284	 11108
U.41	  1305#	  2888	  7798	  8270	 11111
U.42	  1307#	  2891	  7815	  8367	 11117
U.43	  1309#	  2894	  7831	  7876	  7902	  7936	 11120
U.44	  1311#	  2897	  7841	  7887	  7910	  7913	  7914	  8067	  9835	  9921	 10494	 11102
U.45	  1313#	  1514	  2900	  2932	  4374	  4979	  5387	  5722	  6919	  7463	  7862	  7867	  8071	 11126
U.46	  1315#	  1510	  2934	  4376	  4981	  5389	  5716	  5724	  6918	  7462	  8301	  8330	  8955	  8982
	  9039	  9059	  9246	  9293	 11123	 12371	 12385	 12420	 12433
U.47	  1317#	  7921	  7924	  9834	  9914	 10171	 10293	 10498
U.48	  1319#	  7957	  7959	  9828	 10158	 10480
U.49	  1321#	  2496	  2497	  2548	  2574	  2589	  3027	  3223	  3254	  3538	  3883	  4141	  4352	  4366
	  4950	  5062	  5249	  5750	  6328	  6916	  7460	 11482	 11567
U.5	  2612	  4472#
U.50	  1323#	  1648	  3471	  3803	  3835	  4931	  7416	 10153	 10203	 10271	 10287	 10304
U.51	  1325#	  4984	  5028	  5392	  5700	  5704	  5729	  5733	  5837	  5883	  6249	  6287	  6305	  6311
U.52	  1327#	  2162	  2492	  3014	  3180	  3186	  3242	  3474	  3480	  3563	  3795	  3801	  3885	  4068
	  4074	  4143	  4324	  4330	  4377	  4829	  4835	  4982	  4985	  5026	  5029	  5192	  5198	  5251
	  5390	  5393	  5746	  5835	  5838	  5881	  5884	  6285	  6288	  6324	  8538	  8550	 11098
U.53	  1329#	  1649	  1947	  2164	  2916	  3191	  3232	  3485	  3512	  3536	  3565	  3569	  3836	  3872
	  3881	  3887	  3891	  4093	  4130	  4139	  4145	  4149	  4335	  4364	  4379	  4383	  4932	  4965
	  4977	  4987	  4991	  5024	  5031	  5035	  5203	  5247	  5253	  5257	  5373	  5385	  5395	  5399
	  5706	  5735	  5756	  5833	  5840	  5844	  5851	  5879	  5886	  5890	  5899	  6245	  6290	  6294
	  6313	  6334	  6427	  6431	  8570	 11142
U.54	  1331#	  2873	  2912	  2927	  3231	  3515	  3535	  3875	  3880	  4133	  4138	  4362	  4963	  5240
	  5246	  5371	  5710	  5720	  5739	  5744	  5758	  5853	  5901	  5914	  6247	  6283	  6317	  6322
	  6336	  6347	  6872	  6885	  7417	  8583	  8962	  9021
U.55	  1333#	  3544	  5006	  5049	  5762	  5861	  6357	  7121	  7222	  7738	  7756	  7773	  7790	  7805
	  7822	  7833	  8957	  8970	  8974	  9026	  9044	  9048	 10469	 11884
U.56	  1335#	  2858	  3229	  3506	  3532	  3857	  3868	  4115	  4126	  4360	  4958	  5224	  5237	  5323
	  5474	  5695	  5998	  6240	  7850	  8951	  9030	  9033	  9074	  9090
U.57	  1337#	  3646	  7964	  7965	  7966	  7967	  7968	  7969	  7970	  7971	  9127	  9130	  9131	  9132
	  9133
U.58	  1339#	  4212	  8081	  8082	  8083	  8084	  8085	  8086	  8087	  8088	  8426	  8429	  8430	  8431
	  8432	  8433
U.59	  1341#	  1523	  2531	  2533	  3615	  3638	  4172	  4501	  5829	  6353
U.6	  2618	  4827#
U.60	  1343#	  4204	  4486	  5811	 10245	 10249	 10279	 11523	 11548
U.61	  1345#	  1835	  3807	  5002	  5825	  5857	  6005	  6013	  6351	  6909	  7453	 11136
U.62	  1347#	  3816	  4490	  7438	  7450	 11138
U.63	  1349#	  3246	 11140
U.64	  1351#	  1956	  2168	  2265	  4845	  4929
U.65	  1353#	  2278	  4847
U.66	  1355#	  1540	  7446	  9800	 10720	 10728	 10737	 11132
U.67	  1357#	  1543	  5005	  5046	  5860	 10723	 10731	 10740	 11135
U.7	  2606	  4066#
KERMSG	MACRO %53B(1155)-2 15:27  3-Oct-85 Page 1
KERMSG	MAC	18-Jan-73 17:20	


Symbol cross reference

U.74	  3101#	  3260
U.75	  4618#	  4865	  4878	  4889
U.76	  5321#	  5406
U.77	  5474#	  5930
U.78	  5998#	  6447
U.79	  6541#	  6822	  6836	  6850
U.8	  2609	  4322#
U.80	  8876#	  9129
U.81	  9766#	  9787	  9792	 10215	 10224
U.82	  9768#	  9804	  9810	  9811	  9864	  9906	  9923	 10176	 10227	 10255	 10298	 10301	 10309
U.83	  9770#	 10151	 10165	 10167	 10200	 10216	 10230	 10242	 10247	 10252
U.84	  9772#	  9790	  9815	  9869	 10160	 10183	 10189	 10209	 10213	 10220	 10257
U.85	  9774#	  9842	  9849	  9854	  9911	  9918	  9922	  9927	 10141	 10263	 10284
U.86	  9776#	  9846	  9852	  9919	 10146	 10148	 10190	 10268	 10273	 10281
U.87	  9778#	 10162	 10211	 10259
U.88	  9780#	 10143	 10233	 10236	 10265
U.89	  9782#	 10150	 10194	 10239
U.9	  2621	  5192#
U.90	  9787#	  9904	 10175	 10297
U.91	  9904#	 10173	 10295
U.92	 10604#	 10624	 10664	 10713
U.93	 10606#	 10617	 10620	 10657	 10660	 10719	 10743
U.94	 10608#	 10716	 10741
U.95	 10610#	 10722	 10735
U.96	 10612#	 10725	 10738
U.97	 10617#	 10726
U.98	 10657#	 10729
WARN%F	  1373#	  1504
XFR%ST	  1380#	  1734	  1840	  1848	  1971	  1979	  2570	  2938	  2975	  3637	  4186	  4515	  5824	  6426
	  6913	  7457	  8391	  8921	  9087
XFR%TI	  1370#	 11162	 11249  ? 		
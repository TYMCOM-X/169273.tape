KMCLOD - LOAD THE KMC	MACRO 12.5-46.0 16:31 20-SEP-82 PAGE 1
KMCLOD.MAC	24-FEB-81 14:52		INITIALIZATION

				SALL
			000000	DEBUG==0
				TITLE KMCLOD - LOAD THE KMC
				SUBTTL INITIALIZATION

				DEFINE REGDEF(X) <
				ZZ==0
				IRP X,<X==ZZ
				ZZ==ZZ+1
				>>
				REGDEF(<F,A,B,RTN,KMCIN,T,DEVADR,CH,TEMP,L,P,GW,Q,E,E1,V>)

				DEFINE ERROR(X) <
					XCT [	JSR .ERR
						ASCIZ\X\
						]
				
				>

				DEFINE NAME(XX),<CSR'XX==XX>
			000000		XX==0
					REPEAT 8,<
					NAME (\XX)
					XX==XX+1>
			000010

				DEFINE IOREG(DEV,REGADR,BITLST,BITMSK)
				<ZZ==100000
				IFNB <BITMSK>,<ZZ==BITMSK>
				DEV'ADR: 3,,REGADR
				IRP BITLST,<DEV'BITLST==ZZ
				ZZ==ZZ/2
				>>

	000000'	000003	760540	IOREG(CSR,760540,<RUN,MCL,CR,,,RMO,RMI,STP,,,,,,,>)

	000001'	777750	000001'	PDP:	-30,,.
	000002'				BLOCK 30
	000032'			CODHDL:	BLOCK 4
	000036'	535543	435744	KMCCOD:	SIXBIT/KMCCODBIN   /
	000037'	425156	000000
	000040'	637163	000000	ACTNAM:	SIXBIT/SYS         /	;
	000041'	000000	000000
	000042'	777600	000043'	NFB:	-200,,FB-1
	000043'	000000	000000		Z
	000044'			FB:	BLOCK 200

				OPDEF CALL [PUSHJ P,]
				OPDEF RET [POPJ P,]

				;DEFINE KS10 IOT INSTRUCTIONS

				OPDEF WRIO  [713B8]
KMCLOD - LOAD THE KMC	MACRO 12.5-46.0 16:31 20-SEP-82 PAGE 1-2
KMCLOD.MAC	24-FEB-81 14:52		INITIALIZATION

				OPDEF WRIOB [723B8]
				OPDEF RDIO  [712B8]
				OPDEF RDIOB [722B8]
				OPDEF TIOE  [710B8]
				OPDEF TIOEB [720B8]
				OPDEF TION  [711B8]
				OPDEF TIONB [721B8]
				OPDEF BSIO  [714B8]
				OPDEF BSIOB [724B8]
				OPDEF BCIO  [715B8]
				OPDEF BCIOB [725B8]

			001400	FILLEN==1400		;Expected file length
			001000	CRAMLN==1000		;Length of KMC CRAM data
			000400	DATLEN==400		;Length of KMC data
			000200	BLKLEN==200		;pdp 10 words in buffer
			000000	STKMC==0		;address for start of KMC load
			136400	IN1TOM==136400		;KMC instruction to input 1 byte to memory +inc.
			100400	JMPTO0==100400		;Jump to 0 KMC instruction
			010000	MARLOD==010000		;MAR lod
			004000	MARLDX==004000		;Load extended MAR

	000244'	000000	000000	TMPMSG: Z
	000245'	000000	000000		Z
	000246'	000000	000000		Z	
	000247'	000000	000000		Z
			000000	.STTY0==0		;Output to operator console
			000000	.GTSTS==0		;Get job status bits
			000004	JLOG==4			;Logged in flag






KMCLOD - LOAD THE KMC	MACRO 12.5-46.0 16:31 20-SEP-82 PAGE 2
KMCLOD.MAC	24-FEB-81 14:52		EXECUTABLE CODE

				SUBTTL  EXECUTABLE CODE
	000250'	047000	000000	START:	RESET
	000251'	200500	000001'		MOVE P,PDP
	000252'	474040	000000		SETO A,
				IFE DEBUG,<
	000253'	047040	000025		TRPSET A,	;Set user iot
					 JRST [OUTSTR [ASCIZ/ Insufficent license to run./] 
	000254'	254000	000530'		       EXIT]
	000255'	561040	000000		HRROI A,.GTSTS	;Get job status bits
	000256'	047040	000041		GETTAB A,
	000257'	256000	000532'		 ERROR (<GETTAB for job status failed>)
	000260'	603040	000004		TLNE A,JLOG	;Check if already logged in
	000261'	255000	000000		 JFCL	;**D*EXIT		;Quit if logged in
				>;END IFE DEBUG
	000262'	260500	000304'		CALL LODKMC
					MOVE A,[.STTY0,,[ASCIZ/
				KMC sucessfully loaded
	000263'	200040	000547'	/]]
	000264'	047040	000075		SETUUO A,	;Send successful message to console
	000265'	255000	000000		 JFCL
				;;;;;;;	LOGOUT
			000011		.GTCNF=11	;CONFIG DATA
			000025		.CNLGO=25	;INDEX TO LOGOUT PROGRAM NAME
	000266'	200040	000550'	KMCLOG:	MOVE A,[.CNLGO,,.GTCNF]
	000267'	047000	000042		GETTAB A	;GET NAME OF MONITOR'S LOGOUT PROGRAM
	000270'	200040	000551'		  MOVE A,[SIXBIT /LOGOUT/]	;DEFAULT ON ERROR
	000271'	202040	000277'		MOVEM A,RUNNAM
	000272'	201040	000276'		MOVEI A,RUNBLK
	000273'	505040	000001		HRLI A,1
	000274'	047040	000035		RUN A,
	000275'	254200	000275'		HALT .
	000276'	637163	000000	RUNBLK:	SIXBIT /SYS/
	000277'	545747	576564	RUNNAM:	SIXBIT /LOGOUT/
	000300'	000000	000000		OCT 0,0,0,0
	000301'	000000	000000
	000302'	000000	000000
	000303'	000000	000000

				;LODKMC. Load the KMC from file, (SYS)KMCCOD.BIN
				;The format of this file is:
				; 1st section is 1024 decimal pdp11 16 bit words packed into
				;   512 pdp10 words inthe form 
				;   xx1111111111111111xx2222222222222222
				;
				; 2nd section is 1024 decimal pdp11 8 bit bytes packed into
				;   256 pdp10 words in the form 
				;   xx2222222211111111xx4444444433333333

	000304'	201200	000000	LODKMC:	MOVEI KMCIN,STKMC	;Set first KMC address
	000305'	200300	000000'		MOVE DEVADR,CSRADR	;Set up device address
	000306'	201100	040000		MOVEI B,CSRMCL		;Send master clear to KMC
	000307'	260500	000400'		CALL BOTCMD		
	000310'	260500	000402'		CALL CLRCSR		;Clear all the KMC CSR's
KMCLOD - LOAD THE KMC	MACRO 12.5-46.0 16:31 20-SEP-82 PAGE 2-2
KMCLOD.MAC	24-FEB-81 14:52		EXECUTABLE CODE

	000311'	201100	000036'		MOVEI B,KMCCOD		;Setup to open file
	000312'	260500	000331'	 	CALL OPNFIL
	000313'	201440	001000		MOVEI L,CRAMLN		;Set the length to the KMC CRAM length
	000314'	201140	000411'		MOVEI RTN,SNDWRD	;Set routine to SNDWRD
	000315'	260500	000352'		CALL COPFIL
	000316'	201440	000400		MOVEI L,DATLEN		;Set the length to the KMC data length
	000317'	201140	000433'		MOVEI RTN,SNDDAT	;Set routine to SNDDAT
	000320'	260500	000455'		CALL SETMAR		;Set MAR to address 0
	000321'	260500	000352'		CALL COPFIL
	000322'	260500	000350'		CALL CLOFIL
	000323'	201040	100400		MOVEI A,JMPTO0		;Set the KMC PC to 0
	000324'	260500	000445'		CALL MPEX
	000325'	260500	000402'		CALL CLRCSR		;Leave the KMC CSR's clear
				;	MOVEI B,220		;**D*
				;	WRIOB B,CSR3(DEVADR)	;**D*
				;	WRIOB B,CSR4(DEVADR)	;**D*
	000326'	201100	100000		MOVEI B,CSRRUN		
	000327'	260500	000400'		CALL BOTCMD		;Set the run bit
	000330'	263500	000000		RET

				OPNFIL:	OPEN [	17
						'DSK   '
	000331'	050000	000552'			0]
	000332'	256000	000555'		 ERROR(<Can't open DSK:.>)
	000333'	260500	000343'		CALL SETHDL
	000334'	076000	000032'		LOOKUP CODHDL
	000335'	256000	000562'		 ERROR(<Can't find code file.>)
	000336'	574440	000035'		HLRE L,CODHDL+3
	000337'	213000	000011		MOVNS L			;# -10 words in file
	000340'	302440	001400		CAIE L,FILLEN		;COMPARE WITH THE EXPECTED FILE LENGTH
	000341'	256000	000570'		 ERROR(<Code file incorrect length.>)
	000342'	263500	000000		RET
	000343'	120042	000000	SETHDL:	DMOVE A,(B)
	000344'	124040	000032'		DMOVEM A,CODHDL
	000345'	201040	000040'		MOVEI A,ACTNAM
	000346'	202040	000035'		MOVEM A,CODHDL+3
	000347'	263500	000000	   	RET

	000350'	071000	000000	CLOFIL: RELEASE
	000351'	263500	000000		RET

	000352'	201540	000366'	COPFIL:	MOVEI GW,FI0		;Start reading task at block start.
	000353'	201740	000200	LN1:	MOVEI V,BLKLEN
	000354'	313740	000011		CAMLE V,L
	000355'	200740	000011		 MOVE V,L		;V:=MIN(L,BLKLEN)
	000356'	275457	000000		SUBI L,(V)
	000357'	240740	000001		ASH V,1
	000360'	265253	000000	LN2:	JSP T,(GW)
	000361'	256000	000577'		 ERROR (<Error reading code file.>)
	000362'	260503	000000		CALL (RTN)
	000363'	367740	000360'		SOJG V,LN2
	000364'	326440	000353'		JUMPN L,LN1		;Send another block if more in file.
	000365'	263500	000000		RET
KMCLOD - LOAD THE KMC	MACRO 12.5-46.0 16:31 20-SEP-82 PAGE 2-3
KMCLOD.MAC	24-FEB-81 14:52		EXECUTABLE CODE



				;Coroutine to select -11 words from code file open on ch. 0.
				;Return next word in B.  Acs Q and GW are guarenteed preserved
				; by the other coroutine.
	000366'	056000	000042'	FI0:	IN NFB		;Get next file block.
	000367'	254000	000371'		 JRST .+2
	000370'	256000	000605'		  ERROR(<node code file too short>)
	000371'	205600	777600		MOVSI Q,-200		;-10 words left in buffer.
	000372'	135100	000613'	FI2:	LDB B,[POINT 16,FB(Q),17]
	000373'	265545	000001		JSP GW,1(T)
	000374'	135100	000614'		LDB B,[POINT 16,FB(Q),35]
	000375'	265545	000001		JSP GW,1(T)
	000376'	253600	000372'		AOBJN Q,FI2
	000377'	254000	000366'		JRST FI0


				;BOTCMD.  Send command in B to node.
				IFE DEBUG,<
	000400'	713106	000000	BOTCMD:	WRIO B,CSR0(DEVADR)
	000401'	263500	000000		RET
				>;END IFE DEBUG
				IFN DEBUG,<
				BOTCMD: CALL SNDWRD
					RET
				>;END IFN DEBUG

				;CLRCSR. Clear all the KMC's CSRs
				IFE DEBUG,<
	000402'	201100	000010	CLRCSR:	MOVEI B,8			;Number of 8 bit CSRs
	000403'	200400	000000'		MOVE TEMP,CSRADR		;Address of the 1st CSR
	000404'	400040	000000		SETZ A,
	000405'	723060	000010	CLRCS1:	WRIOB A,@TEMP			;Write register
	000406'	350000	000010		AOS TEMP			;Advance address
	000407'	367100	000405'		SOJG B,CLRCS1			;See if done
	000410'	263500	000000		RET
				>;END IFE DEBUG
				IFN DEBUG,<
				CLRCSR:	RET
				>;END IFN DEBUG


				;SNDWRD.  Send a word to the node. 
				IFE DEBUG,<
	000411'	201040	002000	SNDWRD:	MOVEI A,CSRRMO
	000412'	713046	000000		WRIO A,CSR0(DEVADR)		;Select cram
	000413'	713206	000004		WRIO KMCIN,CSR4(DEVADR)		;Load address
	000414'	713106	000006		WRIO B,CSR6(DEVADR)		;Put data
	000415'	201040	020000		MOVEI A,CSRCR
	000416'	714046	000000		BSIO A,CSR0(DEVADR)		;Clock it
	000417'	551040	000000		HRRZI A,0		;Clear
	000420'	713046	000000		WRIO A,CSR0(DEVADR)		;Clear csr0 status
	000421'	713046	000004		WRIO A,CSR4(DEVADR)		;Clear csr4 addr
KMCLOD - LOAD THE KMC	MACRO 12.5-46.0 16:31 20-SEP-82 PAGE 2-4
KMCLOD.MAC	24-FEB-81 14:52		EXECUTABLE CODE

	000422'	713046	000006		WRIO A,CSR6(DEVADR)		;Clear csr6 data
	000423'	201040	002000		MOVEI A,CSRRMO			
	000424'	713046	000000		WRIO A,CSR0(DEVADR)		;Read current cram location
	000425'	713206	000004		WRIO KMCIN,CSR4(DEVADR)		;Load address again
	000426'	712046	000006		RDIO A,CSR6(DEVADR)		;Read instruction
	000427'	312040	000002		CAME A,B
	000430'	256000	000615'		 ERROR (<Compare error during KMC load.>)
	000431'	350000	000004		AOS KMCIN
	000432'	263500	000000		RET
				>;IFE DEBUG
				IFN DEBUG,<
				SNDWRD:	MOVEI E,(B)
					CALL ERRNUM
					SETZ CH,
					IDPB CH,E		;put zero byte to terminate string
					OUTSTR TMPMSG
					OUTCHI 40
					RET
				>;IFN DEBUG

				IFE DEBUG,<
	000433'	261500	000002	SNDDAT:	PUSH P,B
	000434'	405100	000377		ANDI B,377		;Get 1st byte
	000435'	723106	000000		WRIOB B,CSR0(DEVADR)
	000436'	201040	136400		MOVEI A,IN1TOM
	000437'	260500	000445'		CALL MPEX
	000440'	262500	000002		POP P,B			;Restore b
	000441'	242100	777770		LSH B,-8		;Get the 2nd byte
	000442'	723106	000000		WRIOB B,CSR0(DEVADR)
	000443'	260500	000445'		CALL MPEX
	000444'	263500	000000		RET
				>;END IFE DEBUG
				IFN DEBUG,<
				SNDDAT: CALL SNDWRD
					RET
				>;END IFN DEBUG

	000445'	201400	001000	MPEX:	MOVEI TEMP,CSRRMI	;Set xct flag
	000446'	714406	000000		BSIO TEMP,CSR0(DEVADR)
	000447'	713046	000006		WRIO A,CSR6(DEVADR)	;Give the instruction to the KMC
	000450'	201400	000400		MOVEI TEMP,CSRSTP	;Execute the instruction
	000451'	714406	000000		BSIO TEMP,CSR0(DEVADR)
	000452'	400400	000000		SETZ TEMP,		;Disable the device
	000453'	723406	000001		WRIOB TEMP,CSR1(DEVADR)
	000454'	263500	000000		RET
				;SETMAR - SETS THE MAR, A CONTAINS THE NEW VALUE FOR THE MAR

				IFE DEBUG,<
	000455'	201040	010000	SETMAR:	MOVEI A,MARLOD		;Make into KMC instruction
	000456'	260500	000445'		CALL MPEX		;Do it
	000457'	201040	004000		MOVEI A,MARLDX		;Make into KMC instruction
	000460'	260500	000445'		CALL MPEX		;Do it
	000461'	263500	000000		RET
KMCLOD - LOAD THE KMC	MACRO 12.5-46.0 16:31 20-SEP-82 PAGE 2-5
KMCLOD.MAC	24-FEB-81 14:52		EXECUTABLE CODE

				>;END IFE DEBUG
				IFN DEBUG,<
				SETMAR:	RET
				>;END IFN DEBUG

				;.ERR.  JSR here with PC pointing to one greater than
				; execute of JSR, JSR to be followed by asciz
				; string of error message.
	000462'	000000	000000	.ERR:	0
					MOVEI E,[ASCIZ/
				*** KMCLOD reports an error in the downloading of the communications
				    interface:
	000463'	201640	000625'	/]
	000464'	260500	000504'		CALL ERRSTR
	000465'	201640	000647'		MOVEI E,[ASCIZ/    At PC /]
	000466'	260500	000504'		CALL ERRSTR
	000467'	550640	000462'		HRRZ E,.ERR
	000470'	260500	000510'		CALL ERRNUM
	000471'	201640	000244'		MOVEI E,TMPMSG
	000472'	260500	000504'		CALL ERRSTR
	000473'	201640	000652'		MOVEI E,[ASCIZ/: /]
	000474'	260500	000504'		CALL ERRSTR
	000475'	550640	000462'		HRRZ E,.ERR
	000476'	550655	777777		HRRZ E,-1(E)
	000477'	551655	000001		HRRZI E,1(E)
	000500'	260500	000504'		CALL ERRSTR
					MOVEI E,[ASCIZ/
				    Further loading operations have been aborted. ***
	000501'	201640	000653'	/]
	000502'	260500	000504'		CALL ERRSTR
	000503'	254000	000266'		JRST KMCLOG			;LOGOUT
	000504'	661640	000000	ERRSTR:	TLO E,.STTY0
	000505'	047640	000075		SETUUO E,		;output to operator CTY
	000506'	255000	000000		 JFCL
	000507'	263500	000000		RET
	000510'	231640	000010	ERRNUM:	IDIVI E,10
	000511'	506712	000000		HRLM E1,(P)
	000512'	332000	000015		SKIPE E
	000513'	260500	000510'		 CALL ERRNUM
	000514'	336000	000015		SKIPN E
	000515'	200640	000667'		 MOVE E,[POINT 7,TMPMSG]
	000516'	554352	000000		HLRZ CH,(P)
	000517'	435340	000060		IORI CH,"0"
	000520'	136340	000015		IDPB CH,E
	000521'	263500	000000		RET
			000250'	END START

NO ERRORS DETECTED
PROGRAM BREAK IS 000670
3K CORE USED
KMCLOD - LOAD THE KMC	MACRO 12.5-46.0 16:31 20-SEP-82 PAGE 3
KMCLOD.MAC	24-FEB-81 14:52		SYMBOL TABLE

A		000001	SPD	KMCLOG		000266'		
ACTNAM		000040'		L		000011	SPD	
B		000002	SPD	LN1		000353'		
BCIO	715000	000000		LN2		000360'		
BCIOB	725000	000000		LODKMC		000304'		
BLKLEN		000200	SPD	MARLDX		004000	SPD	
BOTCMD		000400'		MARLOD		010000	SPD	
BSIO	714000	000000		MPEX		000445'		
BSIOB	724000	000000		NFB		000042'		
CALL	260500	000000		OPNFIL		000331'		
CH		000007	SPD	OUTSTR	051140	000000		
CLOFIL		000350'		P		000012	SPD	
CLRCS1		000405'		PDP		000001'		
CLRCSR		000402'		Q		000014	SPD	
CODHDL		000032'		RDIO	712000	000000		
COPFIL		000352'		RDIOB	722000	000000		
CRAMLN		001000	SPD	RESET	047000	000000		
CSR		000002	SPD	RET	263500	000000		
CSR0		000000	SPD	RTN		000003	SPD	
CSR1		000001	SPD	RUN	047000	000035		
CSR2		000002	SPD	RUNBLK		000276'		
CSR3		000003	SPD	RUNNAM		000277'		
CSR4		000004	SPD	SETHDL		000343'		
CSR5		000005	SPD	SETMAR		000455'		
CSR6		000006	SPD	SETUUO	047000	000075		
CSR7		000007	SPD	SNDDAT		000433'		
CSRADR		000000'		SNDWRD		000411'		
CSRCR		020000	SPD	START		000250'		
CSRMCL		040000	SPD	STKMC		000000	SPD	
CSRRMI		001000	SPD	T		000005	SPD	
CSRRMO		002000	SPD	TEMP		000010	SPD	
CSRRUN		100000	SPD	TIOE	710000	000000		
CSRSTP		000400	SPD	TIOEB	720000	000000		
DATLEN		000400	SPD	TION	711000	000000		
DEBUG		000000	SPD	TIONB	721000	000000		
DEVADR		000006	SPD	TMPMSG		000244'		
E		000015	SPD	TRPSET	047000	000025		
E1		000016	SPD	V		000017	SPD	
ERRNUM		000510'		WRIO	713000	000000		
ERRSTR		000504'		WRIOB	723000	000000		
EXIT	047000	000012		XX		000010	SPD	
F		000000	SPD	ZZ		000001	SPD	
FB		000044'		.CNLGO		000025		
FI0		000366'		.ERR		000462'		
FI2		000372'		.GTCNF		000011		
FILLEN		001400	SPD	.GTSTS		000000	SPD	
GETTAB	047000	000041		.STTY0		000000	SPD	
GW		000013	SPD	
IN1TOM		136400	SPD	
JLOG		000004	SPD	
JMPTO0		100400	SPD	
KMCCOD		000036'		

KSFEFS - Set up KS10 front-end file system	MACRO %53B(1155)-2 13:43 28-May-87 Page 1
KSFEFS	MAC	20-Dec-75 20:42	

     1					TITLE	KSFEFS - Set up KS10 front-end file system
     2
     3					;This hack written by Daniel S. Blom in 1980
     4					;Modified by Joe Smith in 1986.
     5
     6					; This program runs under Tymcom-X and creates the Front-End
     7					; file system used by the console processor.  The format of
     8					; the system is the same as that described in the TOPS-10 help file
     9					; SMFILE.TXT, except that the bootstrap program is pages 11 and 12 (octal)
    10					; of every disk formatted with P034P or earlier.  BOOTS has moved to pages
    11					; 3, 4, and 5 in P035 and later (COMMON/MONBTS and REFSTR have changed).
    12
    13					;Accumulator names
    14			000000		zz==0
    15					define loser(x)<
    16					irp x,<x=zz
    17					zz==zz+1>>
    18					loser <f,a,b,c,d,e,t,t1,pt,pt1,pt2,ch,fs,L,p>^
    19
    20		260700	000000		opdef	call	[pushj p,]
    21		263700	000000		opdef	ret	[popj p,]
    22
    23
    24
    25					;Disk parameters.
    26	000000'	44 63 53 42 00 00 	STR:	SIXBIT	/DSKB/
    27	000001'	000000	000000		lbplc:	0		;Logical blocks per logical cylinder (multiple of 4)
    28	000002'	000000	000000		bpt:	0		;Blocks per track
    29
    30					;Filename: HOME.SYS     FEFILE.SYS
    31					;FFILEP:    ^O10        3*95 or 3*37    Now starts on 4th cylinder
    32					;NFILEP:   ^O100        ^D95 or ^D37    Assign entire cylinder (was 64 pages)
    33					;LFILEP:   ^D110        4*94 or 4*37    For checking if past last file page
    34					;NBOOTP:   2,,11        3,,3            Number of boot pages, starting page
    35	000003'	000000	000000		FFILEP:	0	;First file page
    36	000004'	000000	000000		NFILEP:	0	;Number of pages
    37	000005'	000000	000000		LFILEP:	0	;Last file page plus 1
    38	000006'	000000	000000		NBOOTP:	0	;Number and location of BOOTS pages
    39
    40	000007'				pag:	block	1000
    41	001007'				fedir:	block	1000		;FE file directory built here
    42	002007'	777750	002007'		pdl:	-30,,.
    43	002010'					block	30
    44
    45	002040'				dcblk:	block	30
    46	002070'	000000	000000		uniidx:	0
    47
    48			000010		nunits==8			;Up to 8. units on system.
    49
    50					;Software I/O channels: channel 0 is used for file input;
    51					; channel 1 for absolute disk writes.
KSFEFS - Set up KS10 front-end file system	MACRO %53B(1155)-2 13:43 28-May-87 Page 2
KSFEFS	MAC	20-Dec-75 20:42		Main program

    52					SUBTTL	Main program
    53
    54	002071'	047 00 0 00 000000 	start:	reset
    55	002072'	200 16 0 00 002007'		move	p,pdl
    56	002073'	260 16 0 00 002312'		call	initia			;Initialize core, disk channels.
    57	002074'	260 16 0 00 002156'		CALL	FILES			;Get file names
    58	002075'	205 01 0 00 777770 		movsi	a,-nunits		;For each unit do
    59	002076'	202 01 0 00 002070'	unilp:	movem	a,uniidx
    60	002077'	260 16 0 00 002401'		call	iniuni			;Setup for new unit.
    61	002100'	254 00 0 00 002146'		 jrst	unilp0			;Not accessible.
    62	002101'	200 01 0 00 003164'		move	a,[pag,,pag+1]		;Setup page 0 pointers for 8080.
    63	002102'	402 00 0 01 777777 		setzm	-1(a)
    64	002103'	251 01 0 00 001006'		blt	a,pag+777
    65	002104'	200 01 0 00 003165'		move	a,[sixbit/HOM/]		; TOPS-10 'HOM'
    66	002105'	202 01 0 00 000207'		movem	a,pag+200		;   Block #1
    67	002106'	200 01 0 00 000003'		MOVE	A,FFILEP		; First file page
    68	002107'	242 01 0 00 000002 		LSH	A,2			; Convert to blocks
    69					;;;	hrli	a,100000		; TOPS-20 does this for some reason.
    70										; TOPS-10 does not set 1B2
    71	002110'	202 01 0 00 000310'		movem	a,pag+200+101		; Store for PDP-10.
    72	002111'	260 16 0 00 002461'		call	lbtda
    73	002112'	202 01 0 00 000312'		movem	a,pag+200+103		; Store for 8080.
    74	002113'	200 01 0 00 000004'		MOVE	A,NFILEP		; Number of pages in FE file
    75	002114'	242 01 0 00 000002 		LSH	A,2
    76	002115'	202 01 0 00 000311'		movem	a,pag+200+102		; Store for PDP-10.
    77	002116'	201 10 0 00 000007'		movei	pt,pag
    78	002117'	201 11 0 00 000000 		movei	pt1,0			;Write PAG to absolute page 0
    79	002120'	051 03 0 00 003166'		OUTSTR	[ASCIZ /.   Writing HOM block in page/]
    80	002121'	260 16 0 00 002345'		call	wapag			;Set up pointers for the 8080
    81	002122'	200 01 0 00 003174'		move	a,[fedir,,fedir+1]	;Zero out directory
    82	002123'	402 00 0 01 777777 		setzm	-1(a)
    83	002124'	251 01 0 00 002006'		blt	a,fedir+777
    84	002125'	200 11 0 00 000003'		MOVE	PT1,FFILEP		;First file page
    85	002126'	271 11 0 00 000001 		ADDI	PT1,1			;First free page is after directory
    86	002127'	260 16 0 00 002201'		call	copy			;Copy the files.
    87	002130'	200 01 0 00 000011 		move	a,pt1			;First free page after the copy
    88	002131'	260 16 0 00 002460'		call	lptda
    89	002132'	202 01 0 00 001007'		movem	a,fedir+0		;Disk address of first free page
    90	002133'	274 11 0 00 000003'		SUB	PT1,FFILEP
    91	002134'	516 11 0 00 001010'		hrlzm	pt1,fedir+1		;First logical free page
    92	002135'	200 01 0 00 000005'		MOVE	A,LFILEP		;Last file page
    93	002136'	275 01 0 11 000000 		subi	a,(pt1)
    94	002137'	542 01 0 00 001010'		hrrm	a,fedir+1		;Number of free pages
    95	002140'	201 10 0 00 001007'		movei	pt,fedir		;Write out the directory
    96	002141'	200 11 0 00 000003'		MOVE	PT1,FFILEP		;Write directory in first file page
    97						OUTSTR	[ASCIZ /
    98	002142'	051 03 0 00 003175'	Writing 8080 directory to page/]
    99	002143'	260 16 0 00 002345'		call	wapag
   100	002144'	260 16 0 00 002217'		CALL	COPBTS			;Copy BOOTS to pages 3,4,5 if needed
   101	002145'	051 03 0 00 002155'		OUTSTR	CRLF
   102	002146'	200 01 0 00 002070'	unilp0:	move	a,uniidx
   103	002147'	334 00 0 00 000000 		skipa			;*HACK* do only DSKB0 for now.
   104	002150'	253 01 0 00 002076'		aobjn	a,unilp
   105	002151'	051 03 0 00 003204'		OUTSTR	[ASCIZ /Done./]
   106	002152'	047 00 0 00 000000 	quit:	reset
KSFEFS - Set up KS10 front-end file system	MACRO %53B(1155)-2 13:43 28-May-87 Page 2-1
KSFEFS	MAC	20-Dec-75 20:42		Main program

   107	002153'	047 01 0 00 000012 		EXIT	1,
   108	002154'	254 00 0 00 002152'		JRST	QUIT
   109
   110	002155'				CRLF:	ASCIZ /
   111	002155'	015 012 000 000 000 	/
   112
   113	002156'	205 15 0 00 777767 	FILES:	MOVSI	L,-PTL
   114	002157'	550 01 0 15 002301'	FILES1:	hrrz	a,protab(L)		;Read the file name and open the file
   115	002160'	200 10 0 15 002303'		move	pt,protab+2(L)
   116	002161'	260 16 0 00 002467'		call	getfil
   117	002162'	260 16 0 00 002233'		call	chklen			;Check that the length is reasonable.
   118	002163'	254 00 0 00 002157'		 jrst	FILES1
   119	002164'	562 10 0 15 002303'		hrrom	pt,protab+2(L)		;Flag to not ask next time
   120	002165'	270 15 0 00 003206'		ADD	L,[2,,2]
   121	002166'	253 15 0 00 002157'		AOBJN	L,FILES1
   122	002167'	051 03 0 00 003207'		OUTSTR	[ASCIZ /Structure to write on {DSKB} : /]
   123	002170'	260 16 0 00 002772'		CALL	GETCH
   124	002171'	260 16 0 00 002745'		call	scan
   125	002172'	302 01 0 00 000000 		caie	a,t.id
   126	002173'	254 00 0 00 002542'		 jrst	synerr
   127	002174'	202 02 0 00 000000'		MOVEM	B,STR
   128	002175'	260 16 0 00 002745'		call	scan
   129	002176'	302 01 0 00 000005 		caie	a,t.eol
   130	002177'	254 00 0 00 002542'		 jrst	synerr
   131	002200'	263 16 0 00 000000 		RET
   132
   133					;Copy files to the front end file area.
   134
   135	002201'	205 15 0 00 777767 	copy:	movsi	L,-PTL
   136	002202'	550 01 0 15 002301'	COPY1:	hrrz	a,protab(L)		;Read the file name and open the file
   137	002203'	200 10 0 15 002303'		move	pt,protab+2(L)
   138	002204'	260 16 0 00 002774'		call	opnfil			;Re-open file
   139	002205'	254 04 0 00 002205'		 halt	.			;Oops
   140	002206'	550 10 0 15 002303'		hrrz	pt,protab+2(L)
   141						OUTSTR	[ASCIZ /
   142	002207'	051 03 0 00 003216'	Writing /]
   143	002210'	260 16 0 00 003024'		CALL	PRTHDL
   144	002211'	051 03 0 00 003221'		OUTSTR	[ASCIZ / to page /]
   145	002212'	554 12 0 15 002301'		hlrz	pt2,protab(L)
   146	002213'	260 16 0 00 002320'		call	copfil			;Copy file, set directory pointer
   147	002214'	270 15 0 00 003206'		add	L,[2,,2]
   148	002215'	253 15 0 00 002202'		aobjn	L,copy1
   149	002216'	263 16 0 00 000000 		ret
   150
   151	002217'	200 11 0 00 000006'	COPBTS:	MOVE	PT1,NBOOTP		;Check on location of BOOTS
   152	002220'	312 11 0 00 003223'		CAME	PT1,[3,,3]		;In new location?
   153	002221'	263 16 0 00 000000 		 RET				;No
   154						OUTSTR	[ASCIZ /
   155	002222'	051 03 0 00 003224'	Duplicating BOOTS in page /]
   156	002223'	201 15 0 00 000000 		MOVEI	L,0			;Back to BOOTS.DMP
   157	002224'	550 01 0 15 002301'		HRRZ	A,PROTAB(L)
   158	002225'	200 10 0 15 002303'		MOVE	PT,PROTAB+2(L)
   159	002226'	260 16 0 00 002774'		PUSHJ	P,OPNFIL		;  "   "
   160	002227'	254 04 0 00 002227'		 HALT	.			;Got deleted?
   161	002230'	550 11 0 00 000006'		HRRZ	PT1,NBOOTP		;Destination page
KSFEFS - Set up KS10 front-end file system	MACRO %53B(1155)-2 13:43 28-May-87 Page 2-2
KSFEFS	MAC	20-Dec-75 20:42		Main program

   162	002231'	554 01 0 00 000006'		HLRZ	A,NBOOTP		;Positive number of pages
   163	002232'	254 00 0 00 002330'		JRST	COPLP0			;Copy BOOTS to where COMMON expects it
   164
   165					;Check length of file whose handle is in Pt, warn user if needed.
   166					; Single return if he decided he wants to use another file.
   167
   168	002233'	554 02 0 15 002302'	chklen:	hlrz	b,protab+1(L)
   169	002234'	316 01 0 00 000002 		camn	a,b
   170	002235'	254 00 0 00 003015'		 jrst	cpopj1
   171	002236'	051 03 0 00 003232'		outstr	[asciz/That file is /]
   172	002237'	260 16 0 00 002262'		call	prtpag
   173	002240'	051 03 0 00 003235'		outstr	[asciz/ long; we expected it to have /]
   174	002241'	554 01 0 15 002302'		hlrz	a,protab+1(L)
   175	002242'	260 16 0 00 002262'		call	prtpag
   176	002243'	051 03 0 00 003244'		outstr	[asciz/./]
   177	002244'	550 01 0 15 002302'		hrrz	a,protab+1(L)
   178	002245'	332 00 0 00 000001 		skipe	a
   179	002246'	051 03 0 01 000000 		 outstr	(a)
   180	002247'	200 03 0 00 000005'		MOVE	C,LFILEP		;Last file page number
   181	002250'	275 03 0 11 000000 		subi	c,(pt1)
   182	002251'	315 03 0 10 000007 		camge	c,7(pt)
   183						 outstr	[asciz/
   184	002252'	051 03 0 00 003245'	In addition, the file is too large to fit!/]
   185						outstr	[asciz/
   186	002253'	051 03 0 00 003256'	Continue anyway (Y or N)? /]
   187	002254'	051 00 0 00 000001 		inchrw	a
   188	002255'	302 01 0 00 000171 		caie	a,"y"
   189	002256'	306 01 0 00 000131 		 cain	a,"Y"
   190	002257'	254 00 0 00 003015'		  jrst	cpopj1
   191						outstr	[asciz/
   192					Ok, try again, then.
   193	002260'	051 03 0 00 003264'	/]
   194	002261'	263 16 0 00 000000 		ret
   195
   196	002262'	306 01 0 00 000001 	prtpag:	cain	a,1
   197	002263'	254 00 0 00 002267'		 jrst	prtpa1
   198	002264'	260 16 0 00 002271'		call	decprt
   199	002265'	051 03 0 00 003271'		outstr	[asciz/ pages/]
   200	002266'	263 16 0 00 000000 		ret
   201	002267'	051 03 0 00 003273'	prtpa1:	outstr	[asciz/1 page/]
   202	002270'	263 16 0 00 000000 		ret
   203
   204
   205					;Print number in A in radix 10.
   206	002271'	231 01 0 00 000012 	decprt:	idivi	a,12
   207	002272'	322 01 0 00 002276'		jumpe	a,decpr1
   208	002273'	506 02 0 16 000000 		hrlm	b,(p)
   209	002274'	260 16 0 00 002271'		call	decprt
   210	002275'	554 02 0 16 000000 		hlrz	b,(p)
   211	002276'	271 02 0 00 000060 	decpr1:	addi	b,"0"
   212	002277'	051 01 0 00 000002 		outchr	b
   213	002300'	263 16 0 00 000000 		ret
   214
   215
   216					;This table controls which files are to be copied to the front end file
KSFEFS - Set up KS10 front-end file system	MACRO %53B(1155)-2 13:43 28-May-87 Page 2-3
KSFEFS	MAC	20-Dec-75 20:42		Main program

   217					; area.  For each file there is a three word entry which contains:
   218					; Word 0: Lh:Offset of the fe file sysem directory pointer to this file
   219					;	  Rh:Address of an ASCIZ string to use to prompt the user for
   220					;	     the file name.
   221					; Word 1: Lh:The expected length, in pages, of the file.
   222					;	  Rh:Address of an ASCIZ string to print if the expected length
   223					;	     doesn't match the actual length, or 0 if none.
   224					; Word 2: Lh:-1 if specification read.
   225					;	  Rh:Address of file handle.
   226					;Note that the bootstrap program must be first for P034P and earlier since
   227					;COMMON looks in page 11 and 12 when loading BOOTS during a crash.
   228					;With P035 and later, BOOTS is in pages 3, 4, and 6 just like on KI/KL/F3.
   229
   230	002301'	000014	003275'		protab:	14,,[asciz/Name of file containing bootstrap program {(SYS)BOOTS.DMP} : /]
   231						2,,[asciz/
   232					The pre-boots program (KSBLOD) expects the bootstrap program
   233	002302'	000002	003312'		be exactly 2 pages long./]
   234	002303'	000000	000000			0
   235	002304'	000002	003334'			2,,[asciz/Name of file containing microcode {(SYS)MCODE} : /]
   236	002305'	000014	000000			14,,0
   237	002306'	000000	000000			0
   238	002307'	000004	003346'			4,,[asciz/Name of file containing pre-boot program: {(SYS)KSBLOD.DMP} : /]
   239						1,,[asciz/
   240	002310'	000001	003363'		The front-end expects the pre-boot program to be exactly 1 page long./]
   241	002311'	000000	000000			0
   242			000011		ptl==.-protab
   243
   244
   245
   246					;Initialize some things.
   247
   248	002312'	201 14 0 00 003054'	initia:	movei	fs,FSDATA
   249	002313'	205 15 0 00 777767 		movsi	L,-PTL
   250	002314'	402 00 0 15 002303'	inilp:	setzm	protab+2(L)
   251	002315'	270 15 0 00 003206'		add	L,[2,,2]
   252	002316'	253 15 0 00 002314'		aobjn	L,inilp
   253	002317'	263 16 0 00 000000 		ret
   254
   255
   256					;Copy a file into the front end file area.
   257					;Call PT/ File handle
   258					;     PT1/ First absolute page of destination.
   259					;     PT2/ Offset of directory entry for this file.
   260					;On return the file will have been copied and the directory entry
   261					; updated appropriately.
   262
   263	002320'	201 01 0 11 000000 	copfil:	movei	a,(pt1)			;Set 8080 disk address of this file
   264	002321'	260 16 0 00 002460'		call	lptda
   265	002322'	202 01 0 12 001007'		movem	a,fedir(pt2)
   266	002323'	201 01 0 11 000000 		movei	a,(pt1)			;Disk page number
   267	002324'	274 01 0 00 000003'		SUB	A,FFILEP		;Relative page number
   268	002325'	516 01 0 12 001010'		hrlzm	a,fedir+1(pt2)		;Set logical page number of this file
   269	002326'	550 01 0 10 000007 		hrrz	a,7(pt)
   270	002327'	542 01 0 12 001010'		hrrm	a,fedir+1(pt2)		;Set the length of the file in pages
   271	002330'	213 00 0 00 000001 	COPLP0:	movns	a			;A has file length
KSFEFS - Set up KS10 front-end file system	MACRO %53B(1155)-2 13:43 28-May-87 Page 2-4
KSFEFS	MAC	20-Dec-75 20:42		Main program

   272	002331'	517 00 0 00 000001 		hrlzs	a
   273	002332'	201 10 0 00 000007'		movei	pt,pag
   274	002333'	260 16 0 00 002340'	coplp:	call	rfpag			;Read page "A" from file
   275	002334'	260 16 0 00 002345'		call	wapag			;Write page "PT1" to disk
   276	002335'	340 11 0 00 000000 		aoj	pt1,
   277	002336'	253 01 0 00 002333'		aobjn	a,coplp
   278	002337'	263 16 0 00 000000 		ret
   279
   280
   281					;Read page number A of open file into PAG.
   282	002340'	201 06 0 01 000000 	rfpag:	movei	t,(a)
   283	002341'	242 06 0 00 000002 		lsh	t,2			;Block number
   284	002342'	074 00 0 06 000001 		useti	1(t)
   285						input	[IOWD 1000,PAG
   286	002343'	066 00 0 00 003402'			 0]
   287	002344'	263 16 0 00 000000 		ret
   288
   289
   290					;Write core page starting at PT into absolute page PT1 of
   291					; currently selected unit.
   292
   293	002345'	322 11 0 00 002355'	wapag:	jumpe	pt1,wapag0		;First make sure request is within the
   294	002346'	301 11 0 00 000003 		CAIL	PT1,3		;3,4,5 ARE OK
   295	002347'	303 11 0 00 000005 		CAILE	PT1,5
   296	002350'	334 00 0 00 000000 		 SKIPA
   297	002351'	254 00 0 00 002355'		  JRST	WAPAG0		;OK
   298	002352'	311 11 0 00 000003'		CAML	PT1,FFILEP		; FE file area or page 0.
   299	002353'	311 11 0 00 000005'		CAML	PT1,LFILEP
   300	002354'	254 00 0 00 002374'		 jrst	waperr
   301	002355'	051 01 0 00 003404'	wapag0:	OUTCHR	[" "]
   302	002356'	261 16 0 00 000001 		PUSH	P,A
   303	002357'	550 01 0 00 000011 		HRRZ	A,PT1
   304	002360'	260 16 0 00 002271'		PUSHJ	P,DECPRT
   305	002361'	262 16 0 00 000001 		POP	P,A
   306	002362'	201 06 0 11 000000 		movei	t,(pt1)			;Page number
   307	002363'	242 06 0 00 000002 		lsh	t,2
   308	002364'	075 01 0 06 000000 		useto	1,(t)
   309	002365'	201 02 0 10 777777 		movei	b,-1(pt)		;Addr of data
   310	002366'	505 02 0 00 777000 		hrli	b,-1000
   311	002367'	400 03 0 00 000000 		setz	c,
   312	002370'	057 01 0 00 000002 	WAPAG1:	OUT	1,b			;Put a JFCL here when debugging
   313	002371'	263 16 0 00 000000 		  ret				;OK
   314						OUTSTR	[ASCIZ /failed!
   315					Do you have WA (Write Absolute) license set?
   316	002372'	051 03 0 00 003405'	/]
   317	002373'	254 00 0 00 002152'		jrst	quit
   318	002374'				waperr:	outstr [asciz/
   319	002374'	051 03 0 00 003421'	Sorry, illegal attempt to write into disk page /]
   320	002375'	550 01 0 00 000011 		hrrz	a,pt1
   321	002376'	260 16 0 00 002271'		call	decprt
   322						outstr	[asciz/.  We give up.
   323					The front-end file area has not been completely initialized.
   324	002377'	051 03 0 00 003433'	/]
   325	002400'	254 00 0 00 002152'		jrst	quit
   326					;Open channel, set unit type for unit # in Rh(A).
KSFEFS - Set up KS10 front-end file system	MACRO %53B(1155)-2 13:43 28-May-87 Page 2-5
KSFEFS	MAC	20-Dec-75 20:42		Main program

   327					;Skip if unit could be opened.  Single return otherwise.
   328
   329	002401'	201 04 0 01 000020 	iniuni:	movei	d,'0'(a)		;2020 can only have DSKB0 thru DSKB7
   330	002402'	242 04 0 00 000006 		lsh	d,6
   331	002403'	434 04 0 00 000000'		ior	d,STR
   332	002404'	202 04 0 00 002040VEM	D,DCBLK
   333	002405'	051 03 0 00 003453'		OUTSTR	[ASCIZ /  /]
   334	002406'	201 01 0 00 002040'		MOVEI	a,DCBLK
   335	002407'	201 02 0 00 000006 		movei	b,6
   336	002410'	260 16 0 00 003045'		call	sixprt
   337	002411'	051 03 0 00 003454'		OUTSTR	[ASCIZ /:  /]
   338	002412'	201 03 0 00 000017 		movei	c,17
   339	002413'	200 04 0 00 002040'		MOVE	D,DCBLK
   340	002414'	400 05 0 00 000000 		setz	e,
   341	002415'	050 01 0 00 000003 		open	1,c
   342	002416'	260 16 0 00 002454'	          PUSHJ	P,inierr
   343	002417'	200 01 0 00 003455'		move	a,[27,,dcblk]
   344	002420'	047 01 0 00 000045 		dskchr	a,
   345	002421'	260 16 0 00 002454'	          PUSHJ	P,inierr
   346	002422'	550 01 0 00 002045'		HRRZ	A,DCBLK+5		;Blocks per cylinder
   347	002423'	306 01 0 00 000045 		CAIN	A,^D37			;Old monitor with RM03?
   348	002424'	242 01 0 00 000002 		 LSH	A,2			;Yes, 148 usable blocks per cylinder
   349	002425'	306 01 0 00 000137 		CAIN	A,^D95			;Old monitor with RP06?
   350	002426'	242 01 0 00 000002 		 LSH	A,2			;Yes, 380 blocks per cylinder
   351	002427'	202 01 0 00 000001'		movem	a,lbplc
   352	002430'	135 02 0 00 003456'		LDB	B,[POINT 9,DCBLK+5,17]	;Blocks per track
   353	002431'	202 02 0 00 000002'		movem	b,bpt
   354	002432'	336 01 0 00 002052'		SKIPN	A,DCBLK+12		;New length ,, page for FE file
   355	002433'	200 01 0 00 002062'		 MOVE	A,DCBLK+22		;If UNIFEP is zero, use UNIBSA
   356	002434'	315 01 0 00 003457'		CAMGE	A,[20,,10]		;Must have at least ^D16 pages
   357	002435'	260 16 0 00 002454'		 PUSHJ	P,INIERR
   358	002436'	552 01 0 00 000003'		HRRZM	A,FFILEP		;First file page
   359	002437'	556 01 0 00 000004'		HLRZM	A,NFILEP		;Number of pages
   360	002440'	270 01 0 00 000004'		ADD	A,NFILEP		;Last file page + 1
   361	002441'	552 01 0 00 000005'		HRRZM	A,LFILEP		;Number of first page after FE file
   362	002442'	200 01 0 00 002062'		MOVE	A,DCBLK+22		;Number ,, first boot page
   363	002443'	316 01 0 00 003460'		CAMN	A,[100,,10]		;Has the FE file been moved?
   364	002444'	200 01 0 00 003461'		 MOVE	A,[2,,11]		;No, old boots is 2 pages at 11-12
   365	002445'	202 01 0 00 000006'		MOVEM	A,NBOOTP		;New boots is 3 pages at 3-5
   366	002446'	200 01 0 00 000004'		MOVE	A,NFILEP
   367	002447'	260 16 0 00 002271'		PUSHJ	P,DECPRT
   368	002450'	051 03 0 00 003462'		OUTSTR	[ASCIZ / pages starting at /]
   369	002451'	200 01 0 00 000003'		MOVE	A,FFILEP
   370	002452'	260 16 0 00 002271'		PUSHJ	P,DECPRT
   371	002453'	254 00 0 00 003015'		jrst	cpopj1
   372
   373					inierr: outstr	[asciz/does not exist
   374	002454'	051 03 0 00 003466'	/]
   375	002455'	262 16 0 00 002457'		POP	P,ERRPC
   376	002456'	263 16 0 00 000000 	        ret
   377	002457'	000000	000000		ERRPC:	0
   378
   379
   380					;This diagram is from page 2 of SMFILE.TXT (see also DSQDF.LST on microfiche)
   381					;	          3-11              23-27            31-35
KSFEFS - Set up KS10 front-end file system	MACRO %53B(1155)-2 13:43 28-May-87 Page 2-6
KSFEFS	MAC	20-Dec-75 20:42		Main program

   382					;	------------------------------------------------------
   383					;	I 000 I           I 0'S I           I 000 I          I
   384					;	------------------------------------------------------
   385					;		  ^		     ^			^
   386					;		  I                  I			I
   387					;	       CYLINDER            TRACK              SECTOR
   388
   389					;Convert logical page into 8080 style disk address.
   390					;  BYTE (3) 0 (9) CYL (8) 0,TRACK,SECTOR	;CYL must be 511. or less!
   391					;LPTDA = Logical page to disk address, call with page # in A.
   392					;LBTDA = Logical block to disk address, call with block # in A.
   393					;Returns 8080 disk address in A, uses B and C.
   394
   395	002460'	242 01 0 00 000002 	lptda:	lsh	a,2			;Page to block number
   396	002461'	230 01 0 00 000001'	lbtda:	idiv	a,lbplc			;A gets cylinder
   397	002462'	230 02 0 00 000002'		idiv	b,bpt			;B gets track, C gets sector
   398	002463'	137 02 0 00 003472'		DPB	B,[POINT 8,C,27]	;Combine track & sector (DA word)
   399	002464'	137 01 0 00 003473'		DPB	A,[POINT 12,C,11]	;Cylinder in LH
   400	002465'	200 01 0 00 000003 		move	a,c			;Return pointer in A
   401	002466'	263 16 0 00 000000 		ret
   402
   403
   404					;Parse a Tymcom-X file specification and open the file.
   405					; Returns with PT pointing to the file name.  Prints an error message
   406					; and quits if can't find the file.
   407					; block suitable for use by LOOKUP.
   408
   409	002467'	261 16 0 00 000001 	getfil:	push	p,a
   410	002470'	200 01 0 16 000000 	getfi0:	move	a,(p)
   411	002471'	260 16 0 00 002477'		call	parfn			;Parse the filename.
   412	002472'	254 00 0 00 002470'		 jrst	getfi0
   413	002473'	260 16 0 00 002774'		call	opnfil			;Open the file.
   414	002474'	254 00 0 00 002470'		 jrst	getfi0
   415	002475'	262 16 0 16 000000 		pop	p,(p)
   416	002476'	263 16 0 00 000000 		ret
   417
   418					;Parse a Tymcomp-X file specification.
   419
   420	002477'	051 03 0 01 000000 	parfn:	outstr	(a)
   421	002500'	505 01 0 14 000000 		hrli	a,(fs)
   422	002501'	541 01 0 14 000001 		hrri	a,1(fs)
   423	002502'	402 00 0 01 777777 		setzm	-1(a)
   424	002503'	251 01 0 14 000007 		blt	a,7(fs)
   425	002504'	260 16 0 00 002772'		call	getch
   426	002505'	260 16 0 00 002745'	pn4:	call	scan
   427	002506'	302 01 0 00 000003 		caie	a,t.opar
   428	002507'	254 00 0 00 002522'		 jrst	pn2
   429	002510'	260 16 0 00 002745'		call	scan
   430	002511'	302 01 0 00 000000 		caie	a,t.id
   431	002512'	254 00 0 00 002542'		 jrst	synerr
   432	002513'	124 02 0 14 000005 		dmovem	b,5(fs)
   433	002514'	551 01 0 14 000005 		hrrzi	a,5(fs)
   434	002515'	552 01 0 14 000003 		hrrzm	a,3(fs)
   435	002516'	260 16 0 00 002745'		call	scan
   436	002517'	302 01 0 00 000004 		caie	a,t.cpar
KSFEFS - Set up KS10 front-end file system	MACRO %53B(1155)-2 13:43 28-May-87 Page 2-7
KSFEFS	MAC	20-Dec-75 20:42		Main program

   437	002520'	254 00 0 00 002542'		 jrst	synerr
   438	002521'	260 16 0 00 002745'		call	scan
   439	002522'	302 01 0 00 000000 	pn2:	caie	a,t.id
   440	002523'	254 00 0 00 002542'		 jrst	synerr
   441	002524'	202 02 0 14 000000 		movem	b,0(fs)
   442	002525'	260 16 0 00 002745'		call	scan
   443	002526'	302 01 0 00 000001 		caie	a,t.dot
   444	002527'	254 00 0 00 002535'		 jrst	pn3
   445	002530'	260 16 0 00 002745'		call	scan
   446	002531'	302 01 0 00 000000 		caie	a,t.id
   447	002532'	254 00 0 00 002542'		 jrst	synerr
   448	002533'	512 02 0 14 000001 		hllzm	b,1(fs)
   449	002534'	260 16 0 00 002745'		call	scan
   450	002535'	302 01 0 00 000005 	pn3:	caie	a,t.eol
   451	002536'	254 00 0 00 002542'		 jrst	synerr
   452	002537'	201 10 0 14 000000 		movei	pt,(fs)
   453	002540'	271 14 0 00 000010 		addi	fs,10
   454	002541'	254 00 0 00 003015'		jrst	cpopj1
   455	002542'				synerr:	outstr	[asciz/
   456					Sorry, I can't parse that file specification.  Try again.
   457	002542'	051 03 0 00 003474'	/]
   458	002543'	263 16 0 00 000000 		ret
   459
   460
   461
   462			400000		c.let==400000
   463			000000		t.id==0
   464			000001		t.dot==1
   465			000002		t.semi==2
   466			000003		t.opar==3
   467			000004		t.cpar==4
   468			000005		t.eol==5
   469
   470	002544'				scntbl:	repeat 11-0+1,<scnign>
   471	002544'	000000	002744'		scnign
   472	002545'	000000	002744'		scnign
   473	002546'	000000	002744'		scnign
   474	002547'	000000	002744'		scnign
   475	002550'	000000	002744'		scnign
   476	002551'	000000	002744'		scnign
   477	002552'	000000	002744'		scnign
   478	002553'	000000	002744'		scnign
   479	002554'	000000	002744'		scnign
   480	002555'	000000	002744'		scnign
   481	002556'	000000	002770'			scneol
   482						repeat "'"-13+1,<scnign>
   483	002557'	000000	002744'		scnign
   484	002560'	000000	002744'		scnign
   485	002561'	000000	002744'		scnign
   486	002562'	000000	002744'		scnign
   487	002563'	000000	002744'		scnign
   488	002564'	000000	002744'		scnign
   489	002565'	000000	002744'		scnign
   490	002566'	000000	002744'		scnign
   491	002567'	000000	002744'		scnign
KSFEFS - Set up KS10 front-end file system	MACRO %53B(1155)-2 13:43 28-May-87 Page 2-8
KSFEFS	MAC	20-Dec-75 20:42		Main program

   492	002570'	000000	002744'		scnign
   493	002571'	000000	002744'		scnign
   494	002572'	000000	002744'		scnign
   495	002573'	000000	002744'		scnign
   496	002574'	000000	002744'		scnign
   497	002575'	000000	002744'		scnign
   498	002576'	000000	002744'		scnign
   499	002577'	000000	002744'		scnign
   500	002600'	000000	002744'		scnign
   501	002601'	000000	002744'		scnign
   502	002602'	000000	002744'		scnign
   503	002603'	000000	002744'		scnign
   504	002604'	000000	002744'		scnign
   505	002605'	000000	002744'		scnign
   506	002606'	000000	002744'		scnign
   507	002607'	000000	002744'		scnign
   508	002610'	000000	002744'		scnign
   509	002611'	000000	002744'		scnign
   510	002612'	000000	002744'		scnign
   511	002613'	000000	002744'		scnign
   512	002614'	000000	002762'			scnop
   513	002615'	000000	002763'			scncp
   514						repeat 4,<scnign>
   515	002616'	000000	002744'		scnign
   516	002617'	000000	002744'		scnign
   517	002620'	000000	002744'		scnign
   518	002621'	000000	002744'		scnign
   519	002622'	000000	002765'			scndot
   520	002623'	000000	002744'			scnign
   521						repeat "9"-"0"+1,<c.let,,scnid>
   522	002624'	400000	002746'		c.let,,scnid
   523	002625'	400000	002746'		c.let,,scnid
   524	002626'	400000	002746'		c.let,,scnid
   525	002627'	400000	002746'		c.let,,scnid
   526	002630'	400000	002746'		c.let,,scnid
   527	002631'	400000	002746'		c.let,,scnid
   528	002632'	400000	002746'		c.let,,scnid
   529	002633'	400000	002746'		c.let,,scnid
   530	002634'	400000	002746'		c.let,,scnid
   531	002635'	400000	002746'		c.let,,scnid
   532	002636'	000000	002744'			scnign
   533	002637'	000000	002766'			scnsem
   534						repeat 5,<scnign>
   535	002640'	000000	002744'		scnign
   536	002641'	000000	002744'		scnign
   537	002642'	000000	002744'		scnign
   538	002643'	000000	002744'		scnign
   539	002644'	000000	002744'		scnign
   540						repeat "z"-"a"+1,<c.let,,scnid>
   541	002645'	400000	002746'		c.let,,scnid
   542	002646'	400000	002746'		c.let,,scnid
   543	002647'	400000	002746'		c.let,,scnid
   544	002650'	400000	002746'		c.let,,scnid
   545	002651'	400000	002746'		c.let,,scnid
   546	002652'	400000	002746'		c.let,,scnid
KSFEFS - Set up KS10 front-end file system	MACRO %53B(1155)-2 13:43 28-May-87 Page 2-9
KSFEFS	MAC	20-Dec-75 20:42		Main program

   547	002653'	400000	002746'		c.let,,scnid
   548	002654'	400000	002746'		c.let,,scnid
   549	002655'	400000	002746'		c.let,,scnid
   550	002656'	400000	002746'		c.let,,scnid
   551	002657'	400000	002746'		c.let,,scnid
   552	002660'	400000	002746'		c.let,,scnid
   553	002661'	400000	002746'		c.let,,scnid
   554	002662'	400000	002746'		c.let,,scnid
   555	002663'	400000	002746'		c.let,,scnid
   556	002664'	400000	002746'		c.let,,scnid
   557	002665'	400000	002746'		c.let,,scnid
   558	002666'	400000	002746'		c.let,,scnid
   559	002667'	400000	002746'		c.let,,scnid
   560	002670'	400000	002746'		c.let,,scnid
   561	002671'	400000	002746'		c.let,,scnid
   562	002672'	400000	002746'		c.let,,scnid
   563	002673'	400000	002746'		c.let,,scnid
   564	002674'	400000	002746'		c.let,,scnid
   565	002675'	400000	002746'		c.let,,scnid
   566	002676'	400000	002746'		c.let,,scnid
   567						repeat 6,<scnign>
   568	002677'	000000	002744'		scnign
   569	002700'	000000	002744'		scnign
   570	002701'	000000	002744'		scnign
   571	002702'	000000	002744'		scnign
   572	002703'	000000	002744'		scnign
   573	002704'	000000	002744'		scnign
   574						repeat "z"-"a"+1,<c.let,,scnid>
   575	002705'	400000	002746'		c.let,,scnid
   576	002706'	400000	002746'		c.let,,scnid
   577	002707'	400000	002746'		c.let,,scnid
   578	002710'	400000	002746'		c.let,,scnid
   579	002711'	400000	002746'		c.let,,scnid
   580	002712'	400000	002746'		c.let,,scnid
   581	002713'	400000	002746'		c.let,,scnid
   582	002714'	400000	002746'		c.let,,scnid
   583	002715'	400000	002746'		c.let,,scnid
   584	002716'	400000	002746'		c.let,,scnid
   585	002717'	400000	002746'		c.let,,scnid
   586	002720'	400000	002746'		c.let,,scnid
   587	002721'	400000	002746'		c.let,,scnid
   588	002722'	400000	002746'		c.let,,scnid
   589	002723'	400000	002746'		c.let,,scnid
   590	002724'	400000	002746'		c.let,,scnid
   591	002725'	400000	002746'		c.let,,scnid
   592	002726'	400000	002746'		c.let,,scnid
   593	002727'	400000	002746'		c.let,,scnid
   594	002730'	400000	002746'		c.let,,scnid
   595	002731'	400000	002746'		c.let,,scnid
   596	002732'	400000	002746'		c.let,,scnid
   597	002733'	400000	002746'		c.let,,scnid
   598	002734'	400000	002746'		c.let,,scnid
   599	002735'	400000	002746'		c.let,,scnid
   600	002736'	400000	002746'		c.let,,scnid
   601						repeat 5,<scnign>
KSFEFS - Set up KS10 front-end file system	MACRO %53B(1155)-2 13:43 28-May-87 Page 2-10
KSFEFS	MAC	20-Dec-75 20:42		Main program

   602	002737'	000000	002744'		scnign
   603	002740'	000000	002744'		scnign
   604	002741'	000000	002744'		scnign
   605	002742'	000000	002744'		scnign
   606	002743'	000000	002744'		scnign
   607
   608
   609	002744'	260 16 0 00 002772'	scnign:	call	getch
   610	002745'	254 00 1 13 002544'	scan:	jrst	@scntbl(ch)
   611
   612	002746'	200 10 0 00 003511'	scnid:	move	pt,[440600,,b]
   613	002747'	403 02 0 00 000003 		setzb	b,c
   614	002750'	622 13 0 00 000100 	scnid3:	trze	ch,100
   615	002751'	664 13 0 00 000040 		 troa	ch,40
   616	002752'	620 13 0 00 000040 		  trz	ch,40
   617	002753'	312 10 0 00 003512'		came	pt,[000600,,c]
   618	002754'	136 13 0 00 000010 		 idpb	ch,pt
   619	002755'	260 16 0 00 002772'		call	getch
   620	002756'	500 13 0 13 002544'		hll	ch,scntbl(ch)
   621	002757'	321 13 0 00 002750'		jumpl	ch,scnid3
   622	002760'	201 01 0 00 000000 		movei	a,t.id
   623	002761'	263 16 0 00 000000 		ret
   624	002762'	334 01 0 00 003513'	scnop:	skipa	a,[t.opar]
   625	002763'	201 01 0 00 000004 	scncp:	movei	a,t.cpar
   626	002764'	254 00 0 00 002772'		jrst	getch
   627	002765'	334 01 0 00 003514'	scndot:	skipa	a,[t.dot]
   628	002766'	201 01 0 00 000002 	scnsem:	movei	a,t.semi
   629	002767'	254 00 0 00 002772'		 jrst	getch
   630	002770'	201 01 0 00 000005 	scneol:	movei	a,t.eol
   631	002771'	263 16 0 00 000000 		ret
   632	002772'	051 04 0 00 000013 	getch:	inchwl	ch
   633	002773'	263 16 0 00 000000 		ret
   634
   635
   636
   637					;If the LOOKUP on the file fails, return +1 after printing an error message.
   638					; Otherwise skip and return the number of pages in the file in A and LENGTH.
   639
   640					opnfil:	open	[ 17
   641							  sixbit/dsk/
   642	002774'	050 00 0 00 003515'			  0 ]
   643	002775'	254 04 0 00 002775'		 jrst	4,.
   644	002776'	513 00 0 10 000001 		hllzs	1(pt)
   645	002777'	261 16 0 10 000003 		push	p,3(pt)
   646	003000'	076 00 0 10 000000 		lookup	(pt)
   647	003001'	254 00 0 00 003017'		 jrst	opnerr
   648	003002'	574 01 0 10 000003 		hlre	a,3(pt)			;set up size
   649	003003'	325 01 0 00 003012'		jumpge	a,opnfi1
   650	003004'	213 00 0 00 000001 		movns	a
   651	003005'	360 01 0 00 000000 		soj	a,
   652	003006'	622 01 0 00 000777 		trze	a,777			;Round up to pages
   653	003007'	271 01 0 00 001000 		 addi	a,1000
   654	003010'	242 01 0 00 777767 		lsh	a,-9
   655	003011'	334 00 0 00 000000 		skipa
   656	003012'	242 01 0 00 000002 	opnfi1:	 lsh	a,2			;Convert from blocks to pages
KSFEFS - Set up KS10 front-end file system	MACRO %53B(1155)-2 13:43 28-May-87 Page 2-11
KSFEFS	MAC	20-Dec-75 20:42		Main program

   657	003013'	202 01 0 10 000007 		movem	a,7(pt)
   658	003014'	262 16 0 10 000003 		pop	p,3(pt)
   659	003015'	350 00 0 16 000000 	cpopj1:	aos	(p)
   660	003016'	263 16 0 00 000000 	cpopj:	ret
   661
   662	003017'	262 16 0 10 000003 	opnerr:	pop	p,3(pt)
   663						outstr	[asciz/
   664	003020'	051 03 0 00 003520'	Sorry, can't find /]
   665	003021'	260 16 0 00 003024'		call	prthdl
   666						outstr	[asciz/.  Try again.
   667	003022'	051 03 0 00 003525'	/]
   668	003023'	263 16 0 00 000000 		ret
   669
   670					;Print file handle in PT.
   671
   672	003024'	336 01 0 10 000003 	prthdl:	skipn	a,3(pt)
   673	003025'	254 00 0 00 003032'		 jrst	prthd1
   674	003026'	051 01 0 00 003531'		outchr	["("]
   675	003027'	201 02 0 00 000014 		movei	b,14
   676	003030'	260 16 0 00 003045'		call	sixprt
   677	003031'	051 01 0 00 003532'		outchr	[")"]
   678	003032'	201 01 0 10 000000 	prthd1:	movei	a,(pt)
   679	003033'	201 02 0 00 000006 		movei	b,6
   680	003034'	260 16 0 00 003045'		call	sixprt
   681	003035'	513 00 0 10 000001 		hllzs	1(pt)
   682	003036'	336 00 0 10 000001 		skipn	1(pt)
   683	003037'	263 16 0 00 000000 		 ret
   684	003040'	051 01 0 00 003533'		outchr	["."]
   685	003041'	201 02 0 00 000003 		movei	b,3
   686	003042'	201 01 0 10 000001 		movei	a,1(pt)
   687	003043'	260 16 0 00 003045'		call	sixprt
   688	003044'	263 16 0 00 000000 		ret
   689
   690					;Print up to B sixbit characters pointed at by A.
   691
   692	003045'	661 01 0 00 440600 	sixprt:	tlo	a,440600
   693	003046'	134 03 0 00 000001 	sixpr1:	ildb	c,a
   694	003047'	322 03 0 00 003016'		jumpe	c,cpopj
   695	003050'	271 03 0 00 000040 		addi	c,40
   696	003051'	051 01 0 00 000003 		outchr	c
   697	003052'	367 02 0 00 003046'		sojg	b,sixpr1
   698	003053'	263 16 0 00 000000 		ret
   699
   700	003054'				FSDATA:	BLOCK	^D9*10		;Room for 9 file specs
KSFEFS - Set up KS10 front-end file system	MACRO %53B(1155)-2 13:43 28-May-87 Page 3
KSFEFS	MAC	20-Dec-75 20:42		Disk pre-boot from SMFILE.LST (DSQDF)

   701					SUBTTL	Disk pre-boot from SMFILE.LST (DSQDF)
   702
   703					REPEAT 0,<
   704					DRM03P:	SKIPN	TOPS10		;If TOPS-20 or TYMCOM-X
   705						 IDIVI	T1,^D<30*5>-2	; then only 148 blocks used per cyl (37 pages)
   706						SKIPE	TOPS10		;But TOPS-10
   707						 IDIVI	T1,^D<30*5>	; uses all 150 blocks per cylinder
   708						AOS	(P)		;Skip over the RP06 idivi
   709						POPJ	P,
   710					
   711					;Routine convert LBN to RH11 CYL and DA
   712					TBOOTB:	LSH	T1,2		;Convert page to logical block number
   713					TBOOTP:	TLZ	T1,77774		;Max block address is 37,,777777
   714						SKIPE	RM03F		;If RM03
   715						 PUSHJ	P,DRM03P	; divide by 148 or 150 and skip
   716						  IDIVI	T1,^D<20*19>	;RP06 blocks per cylinder
   717						PUSH	P,T1		;Save cylinder number
   718						MOVE	T1,T2		;Position within cylinder
   719						SKIPN	RM03F
   720						 IDIVI	T1,^D20		;RP06 sector # in T2
   721						SKIPE	RM03F
   722						 IDIVI	T1,^D30		;RM03 sector # in T2
   723						LSH	T1,^D8		;Head # in high byte
   724						IOR	T1,T2		;Sector # in low byte
   725						POP	P,T2		;Cylinder #
   726						HRL	T1,T2		; in left half of word
   727						POPJ	P,		;BYTE (2)0(16)CYL(2)0(8)HEAD,SECTOR
   728					
   729					;Disk pre-boot.  The 8080 loads this into page 1.  Starting address is 1000.
   730					
   731					;Low core definitions
   732						KPALIV=31	;Keep alive fail counter and bits
   733						MSRN=  36	;RH number to boot from
   734						MSDRIV=37	;Disk drive to boot from
   735					
   736					;RH11 definitions
   737						RPCS1==00	;Status word 1
   738						  RIPST==    21	;Read-in preset function
   739						  RDATA==    71	;Read data
   740						  RDY==     200	;Ready bit
   741						  MCPE==  20000	;Massbus Control parity error
   742						  TRE==   40000	;Transfer error
   743						RPWC== 02	;Word count
   744						RPBA== 04	;Base address (UNIBUS addr of start of data)
   745						RPDA== 06	;Disk address (track and sector)
   746						RPCS2==10	;Status word 2
   747						  RHCLR==40	;Clear RH11
   748						RBDS== 12	;Drive status
   749						RPER1==14	;Error status 1
   750						RPDC== 34	;Desired cylinder
   751						RPER2==40	;Error status 2
   752						RPER3==42	;Error status 3
   753					
   754					
   755					
KSFEFS - Set up KS10 front-end file system	MACRO %53B(1155)-2 13:43 28-May-87 Page 3-1
KSFEFS	MAC	20-Dec-75 20:42		Disk pre-boot from SMFILE.LST (DSQDF)

   756					
   757					BTSTR1:	PHASE	1000
   758					BTSTRT:!JRST	BTSTAR		;1000 Starting address
   759					BTHLT0:!HALT	.		;1001 Tried to overwrite pre-boot
   760					BTHLT1:!HALT	.		;1002 Disk/tape retry failure
   761					BTHLT2:!HALT	.		;1003 No RH11 base address
   762					BTHLT3:!HALT	.		;1004 Magtape skip EOF error
   763					
   764					BTSTAR:!MOVSI	17,-17		;Zero the ACs
   765						SETZM	(17)
   766						AOBJN	17,.-1
   767						SETZM	17
   768					
   769						MOVE	P1,MSRN		;Get RH address from location 36
   770						MOVEM	P1,MSRNSV	;Preserve it
   771						SKIPN	P1		;8080 should have set it up for us
   772						 JRST	BTHLT2		;Halt at 1003 - no RH address specified
   773						HLLM	P1,BTUBP0	;Select right UBA paging RAM
   774						HLLM	P1,BTUBST	;Select right UBA status location
   775					
   776						MOVE	T1,KPALIV	;Get keep-alive word from location 31
   777						MOVEM	T1,MNKPAL	;Preserve it
   778					
   779						MOVEI	T1,RHCLR
   780						WRIO	T1,RPCS2(P1)	;Clear RH11 controller
   781						MOVE	T1,MSDRIV	;Get drive number from location 37
   782						MOVEM	T1,MSDRSV	;Preserve it
   783						WRIO	T1,RPCS2(P1)	;Select drive
   784						MOVEI	T2,RDY		;Wait for ready
   785						TION	T2,RPDS(P1)	;Did it come up yet?
   786						 JRST	.-1		;No, wait for it
   787					
   788						MOVEI	T3,RPPAG	;Point to list of address pairs
   789						MOVEI	T5,^D10		;Retry count
   790					
   791					RDAPAG:!MOVE	T4,0(T3)	;Get disk address <CYL,,DA>
   792						JUMPL	T4,RDADON	;Sign bit set at end
   793						AOS	T3		;Point to physical page number
   794						WRIO	T4,RPDA(P1)	;Set disk address (track and sector)
   795						MOVSS	T4		;Now the LH
   796						WRIO	T4,RPDC(P1)	;Set desired cylinder
   797						MOVNI	T4,1000_1	;512 PDP10 words = 1024 PDP11 words
   798						WRIO	T4,RPWC(P1)	;Set word count
   799						SETZ	T4,		;Clear base address
   800						WRIO	T4,RPBA(P1)	; (to use UNIBUS address 0)
   801						MOVE	T4,0(T3)	;Get KS10 physical page #
   802						AOS	T3		;Point to next pair
   803						CAIN	T4,1		;Attempting to write into page 1?
   804						 JRST	RDBADR		;Error, store info and halt
   805						IORI	T4,UBVBIT!UBV36X
   806						WRIO	T4,@BTUBP0	;Set up UNIBUS adaptor page 0
   807					
   808						MOVEI	T4,RDATA	;READ DATA command and GO bit
   809						WRIO	T4,RPCS1(P1)	;Tell RH11 to go
   810						RDIO	T4,RPCS1(P1)	;Wait for ready bit to come back on
KSFEFS - Set up KS10 front-end file system	MACRO %53B(1155)-2 13:43 28-May-87 Page 3-2
KSFEFS	MAC	20-Dec-75 20:42		Disk pre-boot from SMFILE.LST (DSQDF)

   811						TRNN	T4,RDY
   812						 JRST	.-2
   813					
   814						TRNN	T4,TRE!MCPE	;Check error condition summary
   815						 JRST	RDAPAG		;OK, do next page
   816						SUBI	T3,2		;Error, back up to same entry
   817						SOJLE	T5,RDFAIL	;Fail if retry count exhausted
   818					
   819					RDRTRY:!MOVEI	T1,RHCLR	;Error, clear and try again
   820						WRIO	T1,RPCS2(P1)	;Clear controller
   821						MOVE	T1,MSDRIV
   822						WRIO	T1,RPCS2(P1)	;Re-select drive
   823						JRST	RDAPAG		;Try reading page again
   824					
   825					RDBADR:!MOVEI	17,BTHLT0	;Halt at 1001 if no RH11 address
   826						SUBI	T3,2		;Point to failing entry
   827						JRST	.+2
   828					
   829					RDFAIL:! MOVEI	17,BTHLT1	;Halt at 1002 if too many read errors
   830						MOVE	0,0(T3)
   831						MOVEM	0,100		;CYL,,TRACK*256+SECTOR
   832						MOVE	0,1(T3)
   833						MOVEM	0,101		;Memory page #
   834						MOVEM	T3,102		;Save selection pickup pointer
   835						RDIO	0,RPCS1(P1)
   836						MOVEM	0,103		;Control and status 1
   837						RDIO	0,RPCS2(P1)
   838						MOVEM	0,104		;Control and status 2
   839						RDIO	0,RPDS(P1)
   840						MOVEM	0,105		;Drive status
   841						RDIO	0,RPER1(P1)
   842						MOVEM	0,106		;Error status 1
   843						RDIO	0,RPER2(P1)
   844						MOVEM	0,107		;Error status 2
   845						RDIO	0,RPER3(P1)
   846						MOVEM	0,110		;Error status 3
   847						RDIO	0,@BTUBP0
   848						MOVEM	0,111		;UBA paging translation for page 0
   849						RDIO	0,@BTUBST
   850						MOVEM	0,112		;UBA status reg
   851						MOVE	0,BTVER
   852						MOVEM	0,113		;Pre-boot version
   853					
   854						MOVE	0,MSRHSV
   855						MOVEM	0,MSRH		;Reinstall RH-11 base address in location 36
   856						MOVE	0,MSDRSV
   857						MOVEM	0,MSDRIV	;Reinstall drive number
   858						MOVE	0,MSKPAL
   859						MOVEM	0,KPALIV	;Reinstall keep-alive
   860					
   861						JRST	@17		;Jump to HALT at 1001 or 1002
KSFEFS - Set up KS10 front-end file system	MACRO %53B(1155)-2 13:43 28-May-87 Page 4
KSFEFS	MAC	20-Dec-75 20:42		Disk pre-boot from SMFILE.LST (DSQDF)

   862					
   863					RDADON:!MOVE	0,1(T3)		;Get starting address
   864						MOVEM	0,20		;Save
   865					
   866						WRUBR	ACBLK7
   867						MOVSI	17,-17
   868						SETZM	(17)		;Zero ACs
   869						AOBJN	17,.-1
   870						SETZM	17
   871					
   872						WRUBR	ACBLK6
   873						MOVSI	17,-17
   874						SETZM	(17)		;Zero ACs
   875						AOBJN	17,.-1
   876						SETZM	17
   877					
   878						WRUBR	ACBLK5
   879						MOVSI	17,-17
   880						SETZM	(17)		;Zero ACs
   881						AOBJN	17,.-1
   882						SETZM	17
   883					
   884						WRUBR	ACBLK4
   885						MOVSI	17,-17
   886						SETZM	(17)		;Zero ACs
   887						AOBJN	17,.-1
   888						SETZM	17
   889					
   890						WRUBR	ACBLK3
   891						MOVSI	17,-17
   892						SETZM	(17)		;Zero ACs
   893						AOBJN	17,.-1
   894						SETZM	17
   895					
   896						WRUBR	ACBLK2
   897						MOVSI	17,-17
   898						SETZM	(17)		;Zero ACs
   899						AOBJN	17,.-1
   900						SETZM	17
   901					
   902						WRUBR	ACBLK1
   903						MOVSI	17,-17
   904						SETZM	(17)		;Zero ACs
   905						AOBJN	17,.-1
   906						SETZM	17
   907					
   908						WRUBR	ACBLK0
   909						MOVSI	17,-17
   910						SETZM	(17)		;Zero ACs
   911						AOBJN	17,.-1
   912						SETZM	17
KSFEFS - Set up KS10 front-end file system	MACRO %53B(1155)-2 13:43 28-May-87 Page 5
KSFEFS	MAC	20-Dec-75 20:42		Disk pre-boot from SMFILE.LST (DSQDF)

   913						MOVE	0,MSRHSV
   914						MOVEM	0,MSRH		;Reinstall RH-11 base address in location 36
   915						MOVE	0,MSDRSV
   916						MOVEM	0,MSDRIV	;Reinstall drive number
   917						MOVE	0,MSKPAL
   918						MOVEM	0,KPALIV	;Reinstall keep-alive
   919						SETZ	0,		;Zero AC again
   920						JRST	@20		;Now start BOOT
   921					
   922					ACBLK7:!	1B0!7B8		;WRUBR arguments
   923					ACBLK6:!	1B0!6B8
   924					ACBLK5:!	1B0!5B8
   925					ACBLK4:!	1B0!4B8
   926					ACBLK3:!	1B0!3B8
   927					ACBLK2:!	1B0!2B8
   928					ACBLK1:!	1B0!1B8
   929					ACBLK0:!	1B0!0B8
   930					
   931					MSKPAL:!	0		;Keep-alive and status word
   932					MSRHSV:!	0		;RH-11 base address
   933					MSDRSV:!	0		;Drive number
   934					
   935						MCNVER==0
   936						DECVER==3
   937					BTVER:!	MCNVER,,DECVER		;Pre-boot version
   938					
   939					BTUBP0:!	1,,76300	;Address of UBA translation for page 0
   940					BTUBST:!	1,,763100	;Address of UBA status
   941					  UBVBIT=040000		;Set the VALID bit
   942					  UBV36X=100000		;Use 36-bit transfers
   943					
   944					RDPAG:!	BLOCK	100		;Pairs for locating pages of BOOTS
   945						DEPHASE
   946					RDPAGD=BTSTR1+RDPAG-1000	;Unphased address of BLOCK 100 above
   947					RDPAGX=RDPAGD+100		;End of BLT
   948					
   949					>  ;End REPEAT 0
   950
   951			002071'		LITS:	end	start

NO ERRORS DETECTED

PROGRAM BREAK IS 003534
CPU TIME USED 00:53.977

12P CORE USED
KSFEFS - Set up KS10 front-end file system	MACRO %53B(1155)-2 13:43 28-May-87 Page S-1
KSFEFS	MAC	20-Dec-75 20:42		SYMBOL TABLE

A		000001		P		000016		
B		000002		PAG		000007'		
BPT		000002'		PARFN		002477'		
C		000003		PDL		002007'		
C.LET		400000	spd	PN2		002522'		
CALL	260700	000000		PN3		002535'		
CH		000013		PN4		002505'		
CHKLEN		002233'		PROTAB		002301'		
COPBTS		002217'		PRTHD1		003032'		
COPFIL		002320'		PRTHDL		003024'		
COPLP		002333'		PRTPA1		002267'		
COPLP0		002330'		PRTPAG		002262'		
COPY		002201'		PT		000010		
COPY1		002202'		PT1		000011		
CPOPJ		003016'		PT2		000012		
CPOPJ1		003015'		PTL		000011	spd	
CRLF		002155'		QUIT		002152'		
D		000004		RESET	047000	000000		
DCBLK		002040'		RET	263700	000000		
DECPR1		002276'		RFPAG		002340'		
DECPRT		002271'		SCAN		002745'		
DSKCHR	047000	000045		SCNCP		002763'		
E		000005		SCNDOT		002765'		
ERRPC		002457'		SCNEOL		002770'		
EXIT	047000	000012		SCNID		002746'		
F		000000		SCNID3		002750'		
FEDIR		001007'		SCNIGN		002744'		
FFILEP		000003'		SCNOP		002762'		
FILES		002156'		SCNSEM		002766'		
FILES1		002157'		SCNTBL		002544'		
FS		000014		SIXPR1		003046'		
FSDATA		003054'		SIXPRT		003045'		
GETCH		002772'		START		002071'		
GETFI0		002470'		STR		000000'		
GETFIL		002467'		SYNERR		002542'		
INCHRW	051000	000000		T		000006		
INCHWL	051200	000000		T.CPAR		000004	spd	
INIERR		002454'		T.DOT		000001	spd	
INILP		002314'		T.EOL		000005	spd	
INITIA		002312'		T.ID		000000	spd	
INIUNI		002401'		T.OPAR		000003	spd	
L		000015		T.SEMI		000002	spd	
LBPLC		000001'		T1		000007		
LBTDA		002461'		UNIIDX		002070'		
LFILEP		000005'		UNILP		002076'		
LITS		003164'		UNILP0		002146'		
LPTDA		002460'		WAPAG		002345'		
NBOOTP		000006'		WAPAG0		002355'		
NFILEP		000004'		WAPAG1		002370'		
NUNITS		000010	spd	WAPERR		002374'		
OPNERR		003017'		ZZ		000017	spd	
OPNFI1		003012'		
OPNFIL		002774'		
OUTCHR	051040	000000		
OUTSTR	051140	000000		

KSFEFS - Set up KS10 front-end file system	MACRO %53B(1155)-2 13:43 28-May-87 Page 1
KSFEFS	MAC	20-Dec-75 20:42	


Symbol cross reference

A	    19#	    58	    59	    62	    63	    64	    65	    66	    67	    68	    71	    73	    74	    75
	    76	    81	    82	    83	    87	    89	    92	    93	    94	   102	   104	   114	   125	   129
	   136	   157	   162	   169	   174	   177	   178	   179	   187	   188	   189	   196	   206	   207
	   263	   265	   266	   267	   268	   269	   270	   271	   272	   277	   282	   302	   303	   305
	   320	   329	   334	   343	   344	   346	   347	   348	   349	   350	   351	   354	   355	   356
	   358	   359	   360	   361	   362	   363	   364	   365	   366	   369	   395	   396	   399	   400
	   409	   410	   420	   421	   422	   423	   424	   427	   430	   433	   434	   436	   439	   443
	   446	   450	   622	   624	   625	   627	   628	   630	   648	   649	   650	   651	   652	   653
	   654	   656	   657	   672	   678	   686	   692	   693
B	    19#	   127	   168	   169	   208	   210	   211	   212	   309	   310	   312	   335	   352	   353
	   397	   398	   432	   441	   448	   612	   613	   675	   679	   685	   697
BPT	    28#	   353	   397
C	    19#	   180	   181	   182	   311	   338	   341	   398	   399	   400	   613	   617	   693	   694
	   695	   696
C.LET	   462#	   522	   523	   524	   525	   526	   527	   528	   529	   530	   531	   541	   542	   543
	   544	   545	   546	   547	   548	   549	   550	   551	   552	   553	   554	   555	   556	   557
	   558	   559	   560	   561	   562	   563	   564	   565	   566	   575	   576	   577	   578	   579
	   580	   581	   582	   583	   584	   585	   586	   587	   588	   589	   590	   591	   592	   593
	   594	   595	   596	   597	   598	   599	   600
CH	    19#	   610	   614	   615	   616	   618	   620	   621	   632
CHKLEN	   117	   168#
COPBTS	   100	   151#
COPFIL	   146	   263#
COPLP	   274#	   277
COPLP0	   163	   271#
COPY	    86	   135#
COPY1	   136#	   148
CPOPJ	   660#	   694
CPOPJ1	   170	   190	   371	   454	   659#
CRLF	   101	   110#
D	    19#	   329	   330	   331	   332	   339
DCBLK	    45#	   332	   334	   339	   343	   346	   352	   354	   355	   362
DECPR1	   207	   211#
DECPRT	   198	   206#	   209	   304	   321	   367	   370
E	    19#	   340
ERRPC	   375	   377#
F	    19#
FEDIR	    41#	    81	    83	    89	    91	    94	    95	   265	   268	   270
FFILEP	    35#	    67	    84	    90	    96	   267	   298	   358	   369
FILES	    57	   113#
FILES1	   114#	   118	   121
FS	    19#	   248	   421	   422	   424	   432	   433	   434	   441	   448	   452	   453
FSDATA	   248	   700#
GETCH	   123	   425	   609	   619	   626	   629	   632#
GETFI0	   410#	   412	   414
GETFIL	   116	   409#
INIERR	   342	   345	   357	   373#
INILP	   250#	   252
INITIA	    56	   248#
INIUNI	    60	   329#
KSFEFS - Set up KS10 front-end file system	MACRO %53B(1155)-2 13:43 28-May-87 Page 1
KSFEFS	MAC	20-Dec-75 20:42	


Symbol cross reference

L	    19#	   113	   114	   115	   119	   120	   121	   135	   136	   137	   140	   145	   147	   148
	   156	   157	   158	   168	   174	   177	   249	   250	   251	   252
LBPLC	    27#	   351	   396
LBTDA	    72	   396#
LFILEP	    37#	    92	   180	   299	   361
LITS	   951#
LPTDA	    88	   264	   395#
NBOOTP	    38#	   151	   161	   162	   365
NFILEP	    36#	    74	   359	   360	   366
NUNITS	    48#	    58
OPNERR	   647	   662#
OPNFI1	   649	   656#
OPNFIL	   138	   159	   413	   640#
P	    19#	    20	    21	    55	   159	   208	   210	   302	   304	   305	   342	   345	   357	   367
	   370	   375	   409	   410	   415	   645	   658	   659	   662
PAG	    40#	    62	    64	    66	    71	    73	    76	    77	   273	   285
PARFN	   411	   420#
PDL	    42#	    55
PN2	   428	   439#
PN3	   444	   450#
PN4	   426#
PROTAB	   114	   115	   119	   136	   137	   140	   145	   157	   158	   168	   174	   177	   230#	   242
	   250
PRTHD1	   673	   678#
PRTHDL	   143	   665	   672#
PRTPA1	   197	   201#
PRTPAG	   172	   175	   196#
PT	    19#	    77	    95	   115	   119	   137	   140	   158	   182	   269	   273	   309	   452	   612
	   617	   618	   644	   645	   646	   648	   657	   658	   662	   672	   678	   681	   682	   686
PT1	    19#	    78	    84	    85	    87	    90	    91	    93	    96	   151	   152	   161	   181	   263
	   266	   276	   293	   294	   295	   298	   299	   303	   306	   320
PT2	    19#	   145	   265	   268	   270
PTL	   113	   135	   242#	   249
QUIT	   106#	   108	   317	   325
RFPAG	   274	   282#
SCAN	   124	   128	   426	   429	   435	   438	   442	   445	   449	   610#
SCNCP	   513	   625#
SCNDOT	   519	   627#
SCNEOL	   481	   630#
SCNID	   522	   523	   524	   525	   526	   527	   528	   529	   530	   531	   541	   542	   543	   544
	   545	   546	   547	   548	   549	   550	   551	   552	   553	   554	   555	   556	   557	   558
	   559	   560	   561	   562	   563	   564	   565	   566	   575	   576	   577	   578	   579	   580
	   581	   582	   583	   584	   585	   586	   587	   588	   589	   590	   591	   592	   593	   594
	   595	   596	   597	   598	   599	   600	   612#
SCNID3	   614#	   621
SCNIGN	   471	   472	   473	   474	   475	   476	   477	   478	   479	   480	   483	   484	   485	   486
	   487	   488	   489	   490	   491	   492	   493	   494	   495	   496	   497	   498	   499	   500
	   501	   502	   503	   504	   505	   506	   507	   508	   509	   510	   511	   515	   516	   517
	   518	   520	   532	   535	   536	   537	   538	   539	   568	   569	   570	   571	   572	   573
	   602	   603	   604	   605	   606	   609#
KSFEFS - Set up KS10 front-end file system	MACRO %53B(1155)-2 13:43 28-May-87 Page 1
KSFEFS	MAC	20-Dec-75 20:42	


Symbol cross reference

SCNOP	   512	   624#
SCNSEM	   533	   628#
SCNTBL	   470#	   610	   620
SIXPR1	   693#	   697
SIXPRT	   336	   676	   680	   687	   692#
START	    54#	   951
STR	    26#	   127	   331
SYNERR	   126	   130	   431	   437	   440	   447	   451	   455#
T	    19#	   282	   283	   284	   306	   307	   308
T.CPAR	   436	   467#	   625
T.DOT	   443	   464#	   627
T.EOL	   129	   450	   468#	   630
T.ID	   125	   430	   439	   446	   463#	   622
T.OPAR	   427	   466#	   624
T.SEMI	   465#	   628
T1	    19#
UNIIDX	    46#	    59	   102
UNILP	    59#	   104
UNILP0	    61	   102#
WAPAG	    80	    99	   275	   293#
WAPAG0	   293	   297	   301#
WAPAG1	   312#
WAPERR	   300	   318#
ZZ	    14#	    19	    19#
KSFEFS - Set up KS10 front-end file system	MACRO %53B(1155)-2 13:43 28-May-87 Page 1
KSFEFS	MAC	20-Dec-75 20:42	


Macro/Opdef cross reference

CALL	    20#	    56	    57	    60	    72	    80	    86	    88	    99	   100	   116	   117	   123	   124
	   128	   138	   143	   146	   172	   175	   198	   209	   264	   274	   275	   321	   336	   411
	   413	   425	   426	   429	   435	   438	   442	   445	   449	   609	   619	   665	   676	   680
	   687
DSKCHR	   344
EXIT	   107
INCHRW	   187
INCHWL	   632
LOSER	    15#	    18
OUTCHR	   212	   301	   674	   677	   684	   696
OUTSTR	    79	    97	   101	   105	   122	   141	   144	   154	   171	   173	   176	   179	   183	   185
	   191	   199	   201	   314	   318	   322	   333	   337	   368	   373	   420	   455	   663	   666
RESET	    54	   106
RET	    21#	   131	   149	   153	   194	   200	   202	   213	   253	   278	   287	   313	   376	   401
	   416	   458	   623	   631	   633	   660	   668	   683	   688	   698"VP
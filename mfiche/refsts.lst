REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 1
S.MAC	13-JAN-88 11:55		S.MAC - with system parameter file for P035/D, January 1988

     1				SUBTTL	S.MAC - with system parameter file for P035/D, January 1988
     2
     3				IF2,<IFNDEF LISTSN,<TAPE>>	;Skip to PASS2 in all but COMMON.LST
     4				;THIS MODULE ASSEMBLED WITH KS-10 PARAMETER FILE - KSSYM.MAC
     5
     6					IF2,<IFNDEF LISTSN,<		;LIST KSSYM.MAC IN COMMON ONLY
     7					.CREF
     8									TAPE>>
     9				; This file is PRINTF.MAC
    10				DEFINE PRINTF(A,B,C,D),<IF2,<;;Output message on MONKS build only
    11				PRINTX A B C D>>
    12
    13				TITLE REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE
    14
    15				ENTRY	REFRSH,PAKREF,SCNBAT	;Main entry points
    16				ENTRY	TSTSUP,PREAD,PWRITE	;Debugging/maintenance routines
    17				INTERN	REFSTT,REFLNR,REFLNP	;Start of phased code, lengths
    18				INTERN	RANNO			;Set at GETRAN in ONCDSK
    19
    20				EXTERN RIBALP,RIBCOD,RIBUNM,RIBRPS,RBYPNO,RBYUNI,RIBUN1
    21				EXTERN RIBEXT,RIBNAM,RIBPPN,RIBQTF,RIBQTO,RIBSIZ,RIBPVW
    22				EXTERN RIBSLF,RIBSTS,RIBUSD,RIBVER,RIPDIR,RIPNDL,RIPNFS
    23				EXTERN RIBLST,RIBSNM,RIBSFS,RIBRIB,CODRIB
    24				EXTERN RBREAL,RIBSZS,RIBPFS,RBLVPR,RBLVSP,RIBMXA,RBSPAR,RIBPRV
    25
    26				EXTERN UNISTT,UNISTR,UNIPPU
    27				EXTERN UNYPPY,UNYSPU,UNYLUN
    28
    29				EXTERN HOMREF,HOMHSH,HOMRAN
    30
    31				EXTERN STRREF,STRP4C,STRUNI,STRUNM,STRHSH,STRDDB,STRBTS
    32
    33				EXTERN STTAOB,STTLEN,STTPTR,STTFPC,STTSTS
    34
    35				EXTERN %HOM.P,%HMR.P,%STR.P,%STA.P,%BAT.P,%TMP.P,%T2P.P
    36
    37				EXTERN CPOPJ1,REFLAG,SAVT,MFDRIB,CORZER,CORONZ
    38				EXTERN RIBEX1,RIBEX2,RIBEX3,RIBEX4
    39				EXTERN BATFIR,BAYNBB,BATNBB,BATELB,FSFPPN
    40				EXTERN OPAGIN,OPAGOT,WTBOTH,GETBAT,GETHOM
    41				EXTERN SAVE1,SAVE4,OCONM,OPOUT,CONMES
    42				EXTERN UNTTBL,UFDHSI
    43
    44
    45				IFNDEF FTSPAG,<XP FTSPAG,-1>	;; -1 == FT Spare Pages on CYL 1 and 2
    46
    47	000000'			REFSTT:
    48	770000			PHASE %REF
    49		777777	010000'		%R==REFSTT-REFSTR	;To look at LABEL, use LABEL+%R
    50
    51					STOPCD(,ENTRY,REFSTR)^
    52					ENTRY	REFSTR		;For library searches
    53	000000'	260040	000000*	REFSTR::PUSHJ	P,DIE		;**** Default stopcode for "REFSTR" ****
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 1
REFSTR.MAC	20-NOV-87 22:23		S.MAC - with system parameter file for P035/D, January 1988

    54	000001'	624546	636462		SIXBIT	/REFSTR/  	;Title of module
    55	000002'	000000	000000		S$NONAME,,0		;?NONAME stopcode "REFSTR+nnn(nnnnnn)"
    56			770000	S$NAME==REFSTR			;For STOPCDs with no arguments
    57					SALL>
    58				^
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 2
REFSTR.MAC	20-NOV-87 22:23		REFSTR definitions

    59				SUBTTL	REFSTR definitions
    60
    61				;QUOTAS FOR UFD'S WE CREATE
    62
    63		377777	777777	ND QF,377777777777	;FIRST COME, FIRST SERVED QUOTA.
    64		377777	777777	ND QO,377777777777	;LOGGED OUT QUOTA.
    65	000003'	377777	777777	QUOTAF: EXP QF		;To patch this in SAV file, use QUOTAF+%R/
    66	000004'	377777	777777	QUOTAO: EXP QO
    67
    68				;SOME DEFINITIONS FOR HOME AND BAT PAGES AND BOOTS AND SAT.SYS RIB:
    69				;(ALL MUST BE IN THE 1ST SAT ON THE UNIT.).
    70
    71			000000	XP LPN000,0		;Page 0 is reserved (has TOPS-10 HOM block on KS2020)
    72			000001	XP LPNHOM,1		;Logical page # of first HOME page
    73			000002	XP LPNBAT,2		;  "       "    of first BAT page
    74			000003	XP FBOOTB,3		;First BOOTS page (see BOTLOD and MONBTS)
    75			000003	XP NBOOTP,3		; # of pages reserved for BOOTS (pages 3,4,5)
    76			000006	XP LP2HOM,6		;Logical page # of second HOME page
    77			000007	XP LP2BAT,7		;  "       "    of second BAT page
    78			000010	XP LPNSAT,10		;  "       "    of RIB to SAT.SYS
    79							;1st SAT page is 11 on DSKB0, page 10 on all others
    80
    81				IFN FTSPAG,<		;The size of a cylinder depends on the type of disk
    82				; XP LPNSPG,<CYL*1>	;START OF SPARE PAGES AREA (CYL 1 & 2)
    83				; XP SPGLEN,<CYL*2>	;LENGTH IN PAGES OF SPARE PAGES AREA
    84				> ; End IFN FTSPAG
    85
    86			000100	IFCPU(KS),< XP FEFLEN,100 >	;LENGTH IN PAGES OF FE FILE AREA
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 3
REFSTR.MAC	20-NOV-87 22:23		REFSTR definitions

    87				DEFINE MSGDIE (A)
    88				<PUSHJ P,[MOVEI T1,A
    89					PUSHJ P,OCONM
    90					PUSHJ P,OPOUT
    91					STOPCD ()]>
    92
    93				DEFINE MSGSFE (A)
    94				<PUSHJ P,[MOVEI T1,A
    95					PUSHJ P,OCONM
    96					PUSHJ P,OPOUT
    97					MOVEI T1,SOFERR;;CALL PDP-10 OPERATING SYSTEMS GROUP
    98					PUSHJ P,OCONM
    99					PUSHJ P,OPOUT
   100					STOPCD ()]>
   101
   102				DEFINE MSGLIV (A)
   103				<PUSHJ P,[MOVEI T1,A
   104					PUSHJ P,OCONM
   105					PUSHJ P,OPOUT
   106					POP  P,(P);;Dump most recent PUSHJ return address
   107					POPJ P,]>
   108
   109	770005			IOFAL:	ASCIZ /
   110	000005'	064250	551244	ERROR ON DISK TRANSFER.
	000006'	476444	047634
	000007'	202111	151626
	000010'	202512	240634
	000011'	516150	551134
   111	000012'	064240	000000	/
   112
   113	770013			OGTPG: ASCIZ /
   114	000013'	064251	752650	OUT OF ROOM ON DISK.
	000014'	202370	620244
	000015'	476371	520236
	000016'	471010	444646
   115	000017'	455341	505000	/
   116
   117	770020			BATBAD:	ASCIZ /
   118	000020'	064250	240650	BAT PAGE CONSISTENCY ERROR.
	000021'	202410	143612
	000022'	202071	747246
	000023'	446472	442634
	000024'	416624	042644
	000025'	512372	227032
   119	000026'	050000	000000	/
   120
   121	770027			RBNOUT:	ASCIZ /
   122	000027'	064251	752650	OUT OF RETRIEVAL POINTER SPACE IN NON-EXTENDED FILE.
	000030'	202370	620244
	000031'	426512	244612
	000032'	532031	420240
	000033'	476231	652212
	000034'	511012	350202
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 3-2
REFSTR.MAC	20-NOV-87 22:23		REFSTR definitions

	000035'	416124	044634
	000036'	202351	747132
	000037'	426612	442634
	000040'	422130	420214
	000041'	446310	527032
   123	000042'	050000	000000	/
   124
   125	770043			RBEOUT:	ASCIZ /
   126	000043'	064251	752650	OUT OF RETRIEVAL POINTER SPACE IN EXTENDED FILE.
	000044'	202370	620244
	000045'	426512	244612
	000046'	532031	420240
	000047'	476231	652212
	000050'	511012	350202
	000051'	416124	044634
	000052'	202133	052212
	000053'	472110	542100
	000054'	432231	442534
   127	000055'	064240	000000	/
   128
   129	770056			UFDERR:	ASCIZ /
   130	000056'	064251	752650	OUT OF ROOM IN A ONE PAGE UFD.
	000057'	202370	620244
	000060'	476371	520222
	000061'	471010	120236
	000062'	472124	050202
	000063'	436124	052614
   131	000064'	421341	505000	/
   132
   133	770065			NOTAVL:	ASCIZ /
   134	000065'	064252	242646	RESERVED PAGE HAS ALREADY BEEN ALLOCATED.
	000066'	426452	642610
	000067'	202410	143612
	000070'	202210	151500
	000071'	406312	242602
	000072'	422624	041212
	000073'	426344	040630
	000074'	462370	340650
   135	000075'	426105	606424	/
	000076'	000000	000000
   136
   137	770077			RIBFAL:	ASCIZ/
   138	000077'	064250	640652	FAULTY RIB STRUCTURE.
	000100'	462513	120244
	000101'	446044	051650
	000102'	512530	352252
   139	000103'	512125	606424	/
	000104'	000000	000000
   140
   141	770105			SOFERR:	ASCIZ /
   142	000105'	064252	347614	SOFTWARE ERROR.
	000106'	522570	151212
	000107'	202132	251236
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 3-3
REFSTR.MAC	20-NOV-87 22:23		REFSTR definitions

   143	000110'	511341	505206	CALL PDP-10 OPERATING SYSTEMS GROUP.
	000111'	406311	420240
	000112'	422405	530540
	000113'	202372	042644
	000114'	406511	147216
	000115'	202473	151650
	000116'	426332	320216
	000117'	512372	550134
   144	000120'	064240	000000	/
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 4
REFSTR.MAC	20-NOV-87 22:23		REFRSH - Refresh a complete file structure

   145				SUBTTL	REFRSH - Refresh a complete file structure
   146				;ARGS	P2=ADDR OF STR DATA BLOCK
   147				;	F=ADDR OF DDB
   148
   149	000121'	265440	000000*	REFRSH::JSP	T4,SAVE4	;SAVE PERMANENT ACS
   150	000122'	554255	000000*		HLRZ	U,STRUNI(P2)	;U=ADDR OF FIRST UNIT IN STR
   151	000123'	202240	772243		MOVEM	U,FSTUNI	;REMEMBER FIRST UNIT.
   152	000124'	402000	772244		SETZM	REFUNI		;Not doing PAKREF
   153	000125'	402000	772176		SETZM	R.ZERB		;ZERO OUT LOCS RECORDING FIRST PAGE NOS.
   154	000126'	200300	772253		MOVE	T1,[XWD R.ZERB,R.ZERB+1] ;NEVER ON PAGE 0 SO WE KNOW
   155	000127'	251300	772215		BLT	T1,R.ZERE	;IF REALLY SET UP.
   156	000130'	402000	772246		SETZM	SATDSK		;MARK NO SAT IN CORE IN %STA.
   157
   158				;SET UP RIB IN CORE FOR HOME.SYS.
   159
   160	000131'	200300	772156		MOVE	T1,HOMFIL	;NAME OF HOME.SYS FILE
   161	000132'	200340	772166		MOVE	T2,HOMEXP	;Extension and protection
   162	000133'	200400	000000*		MOVE	T3,SYSPPN	;IN SYS UFD
   163	000134'	201440	752000		MOVEI	T4,%HMR		;PNTR TO HOME.SYS RIB IN CORE.
   164	000135'	201740	000000*		MOVEI	P4,RIPNDL!RIPNFS ;NO DELETE, NO FAILSAFE BITS
   165	000136'	260040	772076		PUSHJ	P,RIBSET	;SET UP RIB FOR HOME.SYS.
   166	000137'	505300	000000*		HRLI	T1,-RBLVPR-1	;SET UP AOBJN WORD TO
   167	000140'	541300	751777*		HRRI	T1,%HMR+RIBPFS-1
   168	000141'	202300	772226		MOVEM	T1,HOMRBP	;RETREVIAL AREA.
   169
   170				;SET UP RIB IN CORE FOR SAT.SYS.
   171
   172	000142'	200300	772157		MOVE	T1,SATFIL	;NAME OF SAT.SYS FILE
   173	000143'	200340	772167		MOVE	T2,SATEXP	;Extension and protection
   174	000144'	200400	000133*		MOVE	T3,SYSPPN	;IN SYS UFD
   175	000145'	201440	750000		MOVEI	T4,%STR		;PNTR TO SAT.SYS RIB IN CORE.
   176	000146'	201740	000000*		MOVEI	P4,RIPNDL!RIPNFS ;NO DELETE, NO FAILSAVE BITS
   177	000147'	260040	772076		PUSHJ	P,RIBSET	;SET UP RIB FOR SAT.SYS.
   178	000150'	505300	000000*		HRLI	T1,-RBLVPR-1	;SET UP AOBJN WORD TO
   179	000151'	541300	747777*		HRRI	T1,%STR+RIBPFS-1
   180	000152'	202300	772227		MOVEM	T1,SATRBP	;RETREVIAL POINTER AREA+1.
   181
   182				;SPAGES.SYS is set up later
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 5
REFSTR.MAC	20-NOV-87 22:23		REFRSH - Refresh a complete file structure

   183				;HERE IS THE LOOP FOR EACH UNIT IN THE STR.
   184
   185	000153'	260040	000000*	NXUNIT:	PUSHJ	P,GETBAT	;READ BAT PAGE(S).
   186	000154'	254000	770474		  JRST	REFFAL
   187	000155'	260040	771115		PUSHJ	P,SATCLC	;SET BEGSAT, SVSBTL, LPGSAT, AND SATIND.
   188
   189				;HERE IS THE LOOP FOR EACH SAT ON THE UNIT.
   190
   191	000156'	260040	770737	NXTSAT:	PUSHJ	P,INISAT	;Reserve special pages, build RIB to SAT.SYS
   192	000157'	254000	770474		  JRST	REFFAL		; and RIB to HOME.SYS
   193
   194	000160'	260040	771075		PUSHJ	P,NXCLC		;ANOTHER SAT FOR THIS UNIT?
   195	000161'	254000	770156		  JRST	NXTSAT		;YES, GO DO IT.
   196
   197	000162'	554245	000000*		HLRZ	U,UNISTR(U)	;NEXT UNIT IN STR.
   198	000163'	326240	770153		JUMPN	U,NXUNIT	;LOOP FOR ALL UNITS IN STR.
   199
   200				;HERE AFTER ALL SATS ON ALL UNITS ARE WRITTEN.
   201
   202	000164'	200240	772243		MOVE	U,FSTUNI	;RESET TO FIRST UNIT IN STR
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 6
REFSTR.MAC	20-NOV-87 22:23		REFRSH - Refresh a complete file structure

   203				;WRITE RIBS FOR SAT.SYS AND HOME.SYS ON FIRST UNIT.
   204
   205				    ;WRITE RIB FOR SAT.SYS (IT IS PRE-ALLOCATED)
   206	000165'	201300	750000		MOVEI	T1,%STR		;Set RIBSIZ
   207	000166'	260040	772152		PUSHJ	P,CNVSIZ	;
   208	000167'	400340	000000		SETZ	T2,		;STORE THE EOF AND
   209	000170'	260040	771602		PUSHJ	P,SATRBS	;COUNT THE PRIME RIB IN ALP.
   210	000171'	201440	000010		MOVEI	T4,LPNSAT	;BUILD THE RETRIEVAL POINTER TO
   211	000172'	661440	000000*		TLO	T4,RBREAL	;THE SAT.SYS RIB AND
   212	000173'	202440	750000*		MOVEM	T4,%STR+RIBSLF	;STORE IT.
   213	000174'	202440	772207		MOVEM	T4,SATRBD	;REMEMBER LOGICAL PAGE NUMBER OF SAT.SYS RIB
   214	000175'	621440	000172*		TLZ	T4,RBREAL	;(U is set to first unit)
   215	000176'	201140	000000*		MOVEI	PG,%STR.P	;WRITE OUT THE RIB OF
   216	000177'	260040	000000*		PUSHJ	P,OPAGOT	;SAT.SYS (page 10 = RIB, page 11 = data)
   217	000200'	254000	770474		  JRST	REFFAL
   218	000201'	200300	750000*		MOVE	T1,%STR+RIBALP
   219	000202'	202300	772177		MOVEM	T1,SATALP	;# of pages allocated to SAT.SYS
   220
   221				    ;ALLOCATE AND WRITE RIB FOR HOME.SYS.
   222
   223	000203'	201300	752000		MOVEI	T1,%HMR		;Set RIBSIZ
   224	000204'	260040	772152		PUSHJ	P,CNVSIZ	;
   225	000205'	400340	000000		SETZ	T2,		;STORE THE EOF AND
   226	000206'	260040	771611		PUSHJ	P,HOMRBS	;COUNT THE PRIME RIB IN ALP.
   227	000207'	260040	771511		PUSHJ	P,OGETPG	;ALLOCATE A PAGE FOR HOME.SYS RIB.
   228	000210'	254000	770474		  JRST	REFFAL
   229	000211'	202340	752000*		MOVEM	T2,%HMR+RIBSLF
   230	000212'	202340	772206		MOVEM	T2,HOMRBD	;REMEMBER LOG. PAGE NUMBER OF RIB FOR HOME.SYS.
   231	000213'	135440	000000*		LDB	T4,RBYPNO	;PAGE NO. OF RIB.
   232	000214'	201140	000000*		MOVEI	PG,%HMR.P	;WRITE OUT THE RIB OF
   233	000215'	260040	000177*		PUSHJ	P,OPAGOT	;HOME.SYS (page 12)
   234	000216'	254000	770474		  JRST	REFFAL
   235	000217'	200300	752000*		MOVE	T1,%HMR+RIBALP	;
   236	000220'	202300	772176		MOVEM	T1,HOMALP	;# of pages allocated to HOME.SYS
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 7
REFSTR.MAC	20-NOV-87 22:23		REFRSH - Refresh a complete file structure

   237				;ALLOCATE SPACE FOR SPAGES.SYS - SPECIAL/SPARE PAGES CYL 1 & 2
   238
   239				IFN FTSPAG,<
   240	000221'	200240	772243		MOVE	U,FSTUNI	;USE FIRST UNIT FOR RIB
   241	000222'	200300	772161		MOVE	T1,SPGFIL	;NAME OF SPAGES.SYS FILE
   242	000223'	200340	772171		MOVE	T2,SPGEXP	;Extension and protection
   243	000224'	200400	000144*		MOVE	T3,SYSPPN	;IN SYS UFD
   244	000225'	201440	746000		MOVEI	T4,%TMP		;ADDRESS OF RIB IN MEMORY.
   245	000226'	201740	000000*		MOVEI	P4,RIPNDL!RIPNFS ;NO DELETE, NO FAILSAFE BITS
   246	000227'	260040	772076		PUSHJ	P,RIBSET	;SET UP RIB IN MEMORY.
   247
   248	000230'	505300	000000*		HRLI	T1,-RBLVPR-1	;SET UP AOBJN WORD
   249	000231'	541300	745777*		HRRI	T1,%TMP+RIBPFS-1 ; TO RETREVIAL
   250	000232'	202300	772231		MOVEM	T1,TMPRBP	; AREA FOR PTREXT.
   251
   252	000233'	260040	771511		PUSHJ	P,OGETPG	;Allocate page 13 for RIB to SPAGES.SYS
   253	000234'	254000	770474		  JRST	REFFAL
   254	000235'	202340	746000*		MOVEM	T2,%TMP+RIBSLF	;REMEMBER LOG. PAGE # OF RIB
   255	000236'	202340	772211		MOVEM	T2,SPGRBD	; FOR SPAGES.SYS IN HOM PAGE.
   256	000237'	135300	000000*		LDB	T1,UNYPPY	;GET # PAGES PER CYLINDER
   257	000240'	242300	000001		LSH	T1,1		; 2 cylinders each unit
   258	000241'	550705	000162*		HRRZ	P3,UNISTR(U)	; Up pointer to STR
   259	000242'	550716	000000*		HRRZ	P3,STRUNM(P3)	; Number of units on structure
   260	000243'	220300	000016		IMUL	T1,P3		;Calculate number of pages
   261	000244'	202300	746000*		MOVEM	T1,%TMP+RIBALP	;Set current pages
   262	000245'	350000	746000*		AOS	%TMP+RIBALP	; plus 1 for prime rib
   263	000246'	242300	000011		LSH	T1,P2WLSH	;Convert to words
   264	000247'	202300	746000*		MOVEM	T1,%TMP+RIBSIZ	;Store
   265
   266	000250'	402000	772250		SETZM	PGSRIB		;CLEAR # OF SPARE RIBS
   267	000251'	135300	000237*	SPGCRE:	LDB	T1,UNYPPY	;GET # PAGES PER CYLINDER	(REMEMBER
   268	000252'	210700	000006		MOVN	P3,T1		; NEGATE AND POSITION		 THESE WERE
   269	000253'	242700	000023		LSH	P3,^D<18+1>	; FOR AOBJN LENGTH (-n*2,,0)	 RESERVED
   270	000254'	540700	000006		HRR	P3,T1		;GET FIRST PAGE AS POINTER	 BY INISAT).
   271
   272	000255'	550300	000016	SPGCR1:	HRRZ	T1,P3		;GET THIS PAGE NEXT
   273	000256'	260040	771154		PUSHJ	P,MAKPAG	; CONVERT T1 TO RETRIEVAL POINTER
   274	000257'	260040	771716		PUSHJ	P,PTREXT	;PUT THE PAGE IN THE RIB
   275	000260'	254000	770474		  JRST	REFFAL
   276	000261'	253700	770255		AOBJN	P3,SPGCR1	;LOOP FOR ALL PAGES THIS UNIT
   277	000262'	554245	000241*		HLRZ	U,UNISTR(U)	;ANOTHER UNIT?
   278	000263'	326240	770251		JUMPN	U,SPGCRE	;YES, GO TO IT
   279
   280	000264'	200240	772243		MOVE	U,FSTUNI	;RETRIEVE THE UNIT POINTER
   281	000265'	201300	746000		MOVEI	T1,%TMP		;POINT TO RIB PAGE
   282	000266'	260040	771372		PUSHJ	P,RBNFL9	;STORE EOF, ADJUST RIBALP, WRITE RIB
   283	000267'	254000	770474		  JRST	REFFAL
   284	000270'	200300	746000*		MOVE	T1,%TMP+RIBALP	;REMEMBER ALLOCATED PAGES
   285	000271'	202300	772201		MOVEM	T1,SPGALP	;FOR LATER
   286				> ; End IFN FTSPAG
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 8
REFSTR.MAC	20-NOV-87 22:23		REFRSH - Refresh a complete file structure

   287				;ALLOCATE SPACE FOR FEFILE.SYS ON KS-10s ONLY (for now)
   288
   289				IFCPU(KS),<			;; KS-10 HAS FE-FILE AREA FOR 8080
   290	000272'	200240	772243		MOVE	U,FSTUNI	;USE FIRST UNIT FOR RIB
   291	000273'	200300	772162		MOVE	T1,FEFFIL	;NAME OF FEFILE.SYS FILE
   292	000274'	200340	772172		MOVE	T2,FEFEXP	;Extension and protection
   293	000275'	200400	000224*		MOVE	T3,SYSPPN	;IN SYS UFD
   294	000276'	201440	746000		MOVEI	T4,%TMP		;ADDRESS OF RIB IN MEMORY.
   295	000277'	201740	000000*		MOVEI	P4,RIPNDL!RIPNFS ;NO DELETE, NO FAILSAFE BITS
   296	000300'	260040	772076		PUSHJ	P,RIBSET	;SET UP RIB IN MEMORY.
   297
   298	000301'	505300	000000*		HRLI	T1,-RBLVPR-1	;SET UP AOBJN WORD
   299	000302'	541300	745777*		HRRI	T1,%TMP+RIBPFS-1 ; TO RETREVIAL
   300	000303'	202300	772231		MOVEM	T1,TMPRBP	; AREA FOR PTREXT.
   301
   302	000304'	260040	771511		PUSHJ	P,OGETPG	;Allocate page 14 for RIB to FEFILE.SYS
   303	000305'	254000	770474		  JRST	REFFAL
   304	000306'	202340	746000*		MOVEM	T2,%TMP+RIBSLF	;REMEMBER LOG. PAGE # OF RIB
   305	000307'	202340	772212		MOVEM	T2,FEFRBD	; FOR FEFILE.SYS (IN HOM PAGE?).
   306	000310'	201300	000100		MOVEI	T1,FEFLEN	;# of pages in FEFILE
   307	000311'	202300	746000*		MOVEM	T1,%TMP+RIBALP	;Set cu pages
   308	000312'	350000	746000*		AOS	%TMP+RIBALP	; plus 1 for prime rib
   309	000313'	242300	000011		LSH	T1,P2WLSH	;Convert to words
   310	000314'	202300	746000*		MOVEM	T1,%TMP+RIBSIZ	;Store
   311
   312	000315'	402000	772250		SETZM	PGSRIB		;CLEAR # OF SPARE RIBS
   313	000316'	135700	000251*	FEFCRE:	LDB	P3,UNYPPY	;GET # PAGES PER CYLINDER	(REMEMBER
   314				IFN FTSPAG,<	;IF SPAGES EXISTS START ON CYL 3 ELSE CYL 1	 THESE WERE
   315	000317'	221700	000003		IMULI	P3,3 >		; MAKE FIRST PAGE ON CYLINDER 3	 RESERVED
   316	000320'	505700	777700		HRLI	P3,-FEFLEN	;GET LENGTH OF FE AREA		 BY INISAT).
   317
   318	000321'	550300	000016	FEFCR1:	HRRZ	T1,P3		;GET THIS PAGE NEXT
   319	000322'	260040	771154		PUSHJ	P,MAKPAG	; CONVERT T1 TO RETRIEVAL POINTER
   320	000323'	260040	771716		PUSHJ	P,PTREXT	;PUT THE PAGE IN THE RIB
   321	000324'	254000	770474		  JRST	REFFAL
   322	000325'	253700	770321		AOBJN	P3,FEFCR1	;LOOP FOR ALL PAGES UNIT 0 (ONLY)
   323	000326'	201300	746000		MOVEI	T1,%TMP		;POINT TO RIB PAGE
   324	000327'	260040	771372		PUSHJ	P,RBNFL9	;STORE EOF, ADJUST RIBALP, WRITE RIB
   325	000330'	254000	770474		  JRST	REFFAL
   326	000331'	200300	746000*		MOVE	T1,%TMP+RIBALP	;REMEMBER ALLOCATED PAGES
   327	000332'	202300	772202		MOVEM	T1,FEFALP	;FOR LATER
   328				> ; End IFCPU(KS)
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 9
REFSTR.MAC	20-NOV-87 22:23		REFRSH - Refresh a complete file structure

   329				;ALLOCATE SPACE FOR CRASH.SAV - SPACE TO WRITE OUT A CRASH FILE.
   330
   331	000333'	200645	000262*	CRSCRE:	MOVE	P2,UNISTR(U)	;SEE IF A
   332	000334'	550455	000000*		HRRZ	T4,STRP4C(P2)	;  CRASH FILE
   333	000335'	336000	000011		SKIPN	T4		;  ON THIS STR.
   334	000336'	254000	770352		 JRST	NORCV		;NO
   335	000337'	200240	772243		MOVE	U,FSTUNI	;PUT IT ON FIRST UNIT.
   336	000340'	200300	772160		MOVE	T1,CRSFIL	;File name
   337	000341'	200340	772170		MOVE	T2,CRSEXP	;Extension and protection
   338	000342'	200400	000275*		MOVE	T3,SYSPPN	;In (SYS)
   339	000343'	201740	000000*		MOVEI	P4,RIPNDL!RIPNFS ;SET UP THE RIB IN %TMP AND
   340	000344'	260040	771310		PUSHJ	P,RBNFIL	;THE FILE.
   341	000345'	254000	770474		  JRST	REFFAL		;
   342	000346'	200340	746000*		MOVE	T2,%TMP+RIBALP	;SAVE THE NO. OF PAGES IN THIS
   343	000347'	202340	772200		MOVEM	T2,CRSALP	;FILE + RIB PAGES FOR RIBUSD.
   344	000350'	200340	746000*		MOVE	T2,%TMP+RIBSLF	;
   345	000351'	202340	772210		MOVEM	T2,CRSRBD	;
   346
   347				;CREATE PRINT UFD.
   348
   349	000352'	200240	772243	NORCV:	MOVE	U,FSTUNI	;
   350	000353'	403600	000015		SETZB	P1,P2		;NO FILES= SUM OF ALPS=0.
   351	000354'	200300	000000*		MOVE	T1,SPLPPN	;PPN for print UFD
   352	000355'	202300	772164		MOVEM	T1,SPLUFD	; is filename for MFD
   353	000356'	200340	772174		MOVE	T2,SPLEXP	;'UFD' and protection
   354	000357'	260040	771163		PUSHJ	P,UFDSET	;Build RIB for UFD and write it out
   355	000360'	254000	770474		  JRST	REFFAL		;
   356	000361'	202340	772214		MOVEM	T2,SPLRBD	;SAVE LOGICAL PAGE NUM OF RIB.
   357	000362'	200440	746000*		MOVE	T4,%TMP+RIBALP
   358	000363'	202440	772204		MOVEM	T4,SPLALP	;PAGES ALLOCATED TO (SPOOLING).UFD
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 10
REFSTR.MAC	20-NOV-87 22:23		REFRSH - Refresh a complete file structure

   359				;CREATE SYS UFD AND ITS RIB.
   360
   361	000364'	200240	772243		MOVE	U,FSTUNI	;FIRST UNIT ON STR
   362	000365'	400640	000000		SETZ	P2,
   363	000366'	205300	777773		MOVSI	T1,-NFILE	;FIND SUM OF
   364	000367'	270646	772176		ADD	P2,R.SIZE(T1)	;ALPS FOR
   365	000370'	253300	770367		AOBJN	T1,.-1		;ITS FILES.
   366	000371'	205600	777773		MOVSI	P1,-NFILE	;
   367	000372'	200300	000342*		MOVE	T1,SYSPPN	;PPN for SYS UFD
   368	000373'	202300	772163		MOVEM	T1,SYSUFD	; is filename for MFD
   369	000374'	200340	772173		MOVE	T2,SYSEXP	;'UFD' and protection
   370	000375'	260040	771163		PUSHJ	P,UFDSET	;SET UP & WRITE OUT INFO IN THE RIB FOR SYS.UFD.
   371	000376'	254000	770474		  JRST	REFFAL
   372	000377'	202340	772213		MOVEM	T2,SYSRBD	;Ret Ptr to RIB
   373	000400'	200440	746000*		MOVE	T4,%TMP+RIBALP
   374	000401'	202440	772203		MOVEM	T4,SYSALP	;UFD has 7 data pages
   375	000402'	205600	777773		MOVSI	P1,-NFILE	;MAKE ENTRIES IN THE UFD FOR THE FILES
   376	000403'	260040	771221		PUSHJ	P,SETUFD	;SET UP AND WRITE OUT THE UFD ITSELF.
   377	000404'	254000	770474		  JRST	REFFAL
   378
   379
   380				;CREATE (1,1).UFD (MFD) AND ITS RIB.
   381
   382	000405'	400640	000000		SETZ	P2,		;Sum up the ALPs
   383	000406'	200300	772254		MOVE	T1,[-NUFDS,,NFILE]; of all the UFDs
   384	000407'	270646	772176		ADD	P2,R.SIZE(T1)
   385	000410'	253300	770407		AOBJN	T1,.-1
   386	000411'	271640	000002		ADDI	P2,2		;COUNT MFDALP ALSO.
   387	000412'	200600	772254		MOVE	P1,[-NUFDS,,NFILE]
   388	000413'	200300	000000*		MOVE	T1,MFDPPN	;PPN for MFD UFD
   389	000414'	202300	772165		MOVEM	T1,MFDUFD	; is filename for MFD
   390	000415'	200340	772175		MOVE	T2,MFDEXP	;'UFD' and protection
   391	000416'	260040	771163		PUSHJ	P,UFDSET	;SET UP AND WRITE OUT INFO IN THE RIB FOR MFD.
   392	000417'	254000	770474		  JRST	REFFAL
   393	000420'	202340	772215		MOVEM	T2,MFDRBD	;Ret Ptr to RIB
   394	000421'	202340	000000*		MOVEM	T2,MFDRIB	;Store for FILRIB
   395	000422'	200440	746000*		MOVE	T4,%TMP+RIBALP
   396	000423'	202440	772205		MOVEM	T4,MFDALP	;7 data pages in UFD
   397	000424'	200600	772254		MOVE	P1,[-NUFDS,,NFILE]	;MAKE ENTRIES IN THE MFD FOR THE UFDS
   398	000425'	260040	771221		PUSHJ	P,SETUFD	;SET UP AND WRITE OUT THE MFD ITSELF.
   399	000426'	254000	770474		  JRST	REFFAL
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 11
REFSTR.MAC	20-NOV-87 22:23		REFRSH - Refresh a complete file structure

   400	000427'	260040	771540		PUSHJ	P,CNDSWT	;IF THERE IS A SAT IN CORE, WRITE IT.
   401	000430'	254000	770474		  JRST	REFFAL
   402
   403				;HERE TO UPDATE THE HOME PAGES ON EACH UNIT OF THE STR.
   404
   405
   406	000431'	200240	772243		MOVE	U,FSTUNI	;START WITH THE FIRST UNIT.
   407	000432'	260040	000000*	HOMUPD:	PUSHJ	P,GETHOM	;READ HOME PAGES.
   408	000433'	254000	770474		  JRST	REFFAL
   409	000434'	402000	753000*		SETZM	%HOM+HOMREF	;CLEAR NEEDS REFRESHING FLAG
   410				IFCPU(KS),<
   411	000435'	135300	000316*		LDB	T1,UNYPPY	;GET # PAGES PER CYL
   412				IFN FTSPAG,<	;; Use CYL 1 if no special/spare pages ELSE use CYL 3
   413	000436'	221300	000003		IMULI	T1,3		;STARTS AT CYL 3
   414				> ; End IFN FTSPAG
   415	000437'	505300	000100		HRLI	T1,FEFLEN	;FOR FEFLEN PAGES
   416	000440'	312240	772243		CAME	U,FSTUNI	;But only on unit 0
   417				> ; End IFCPU(KS)
   418	000441'	201300	000000		 MOVEI	T1,0		;Nothing for KI,KL,F3 and other units on KS
   419	000442'	202300	753014		MOVEM	T1,%HOM+HOMFEP	;SET POINTER TO FE FILE
   420	000443'	201300	000000*		MOVEI	T1,UFDHSI	;RESET HASH
   421	000444'	516300	753000*		HRLZM	T1,%HOM+HOMHSH	;AND
   422	000445'	550300	772236		HRRZ	T1,RANNO
   423	000446'	542300	753000*		HRRM	T1,%HOM+HOMRAN	;RANDOM PACK-SET MOUNT COUNT TO SAME
   424	000447'	205300	777770		MOVSI	T1,-NFILE-NUFDS	;*.SYS and *.UFD
   425	000450'	200346	772206	HOMUP1:	MOVE	T2,R.RIBS(T1)	;Ret Ptr to RIB of this file or UFD
   426	000451'	135400	772255		LDB	T3,[POINT 9,R.EXPR(T1),35];Get index (zero if none)
   427	000452'	332000	000010		SKIPE	T3		;If it belongs in the HOM page
   428	000453'	202350	753000		 MOVEM	T2,%HOM(T3)	; put it there
   429	000454'	253300	770450		AOBJN	T1,HOMUP1	;Update HOMTAB (HOMSAT thru HOMMFD)
   430	000455'	260040	000000*		PUSHJ	P,WTBOTH	;P4 & PG STILL SET UP FROM GETHOM.
   431	000456'	256000	770000		 STOPCD			;WTBOTH HAS TYPED AN ERR MSG.
   432	000457'	554245	000333*		HLRZ	U,UNISTR(U)
   433	000460'	326240	770432		JUMPN	U,HOMUPD	;LOOP FOR ALL UNITS IN STR
   434	000461'	260040	771631		PUSHJ	P,CLSAOB	;Clear STTAOB on all SATs
   435
   436				;HERE WHEN ALL DONE
   437
   438	000462'	200300	000000*		MOVE	T1,FSFPPN	;FAILSAFE PPN
   439	000463'	202300	000000*		MOVEM	T1,REFLAG	;SET REFLAG NON-ZERO
   440	000464'	200240	772243		MOVE	U,FSTUNI	;RESET U TO FIRST UNIT
   441	000465'	550645	000457*		HRRZ	P2,UNISTR(U)	;TO RESET P2 WHICH WAS CLOBBERED
   442	000466'	201300	000443*		MOVEI	T1,UFDHSI	;  FIXING HOME PAGES.
   443	000467'	542315	000000*		HRRM	T1,STRHSH(P2)	;Update STR datablock
   444	000470'	201300	000000*		MOVEI	T1,SRPREF##	;Mark the STR
   445	000471'	436315	000000*		IORM	T1,STRBTS(P2)	; has having been refreshed
   446	000472'	553015	000000*		HRRZS	STRREF(P2)	;CLEAR NEEDS REFRESHING FLAG IN CORE
   447	000473'	254000	000000*		JRST	CPOPJ1		;SKIP RETURN
   448
   449
   450	000474'	263040	000000	REFFAL:	POPJ	P,		;ERROR EXIT.
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 12
REFSTR.MAC	20-NOV-87 22:23		PAKREF - Refresh a single pack which is being added to a STR

   451				SUBTTL	PAKREF - Refresh a single pack which is being added to a STR
   452				;ENTER WITH U/ UNIT DB AND P2/ STR DB.
   453
   454				;The RIB to HOME.SYS needs to be updated to include the additional HOM pages.
   455				;The RIB to SAT.SYS needs to be updated to include the additional SATs.
   456				;The RIB to SPAGES.SYS needs to be updated to include the new cylinders.
   457				;Then the new HOM page is rewritten.
   458
   459	000475'	202240	772244	PAKREF::MOVEM	U,REFUNI	;SAVE UNIT BEING REFRESHED.
   460	000476'	402000	772243		SETZM	FSTUNI		;FLAG FOR INISAT.
   461	000477'	542645	000465*		HRRM	P2,UNISTR(U)	;PUT STR HERE, SOME LOOK FOR IT.
   462	000500'	554255	000122*		HLRZ	U,STRUNI(P2)	;GET THE 1ST UNIT IN THE STR.
   463	000501'	402000	772246		SETZM	SATDSK		;MARK NO SAT IN CORE IN %STA.
   464	000502'	402000	772176		SETZM	R.ZERB		;Zero out R.RIBS and R.SIZE
   465	000503'	200300	772253		MOVE	T1,[XWD R.ZERB,R.ZERB+1]
   466	000504'	251300	772215		BLT	T1,R.ZERE
   467
   468	000505'	260040	000432*		PUSHJ	P,GETHOM	;GET HOME PAGES FROM FIRST UNIT.
   469	000506'	254000	770677		  JRST	PAKLEV		;ERROR.
   470	000507'	205300	777770		MOVSI	T1,-NFILE-NUFDS	;Loop thru entire table
   471	000510'	135400	772255	PREF1:	LDB	T3,[POINT 9,R.EXPR(T1),35]
   472	000511'	332000	000010		SKIPE	T3		;If it comes from the HOM page
   473	000512'	200410	753000		 MOVE	T3,%HOM(T3)	; get it, else use zero
   474	000513'	202406	772206		MOVEM	T3,R.RIBS(T1)	;Ret Ptr to RIB of this file or ufd
   475	000514'	253300	770510		AOBJN	T1,PREF1	;Read HOMTAB (HOMSAT thru HOMMFD)
   476
   477				  ;Read the current RIBs for HOME,SAT,SPAGES into %HMR,%STR,%TMP
   478	000515'	205740	777773		MOVSI	P4,-NFILE	;P4/ LOOP INDEX.
   479	000516'	332017	772216	PREF2:	SKIPE	R.PCBS(P4)	;Only SAT,HOME,SPAGES belong on added packs
   480	000517'	336457	772206		SKIPN	T4,R.RIBS(P4)	;T4/ PAGE NO. OF PRIME RIB FIRST UNIT.
   481	000520'	254000	770567		 JRST	PRFNST		;No big deal if no RIB to SPAGES.SYS (SWAP.SYS)
   482	000521'	621440	000175*		TLZ	T4,RBREAL	;Page within unit, unit 0 always
   483
   484	000522'	550157	772216		HRRZ	PG,R.PCBS(P4)	;PG/ %XXX.P = PCB
   485	000523'	554617	772216		HLRZ	P1,R.PCBS(P4)	;P1/ %XXX   = virtual address
   486	000524'	200240	772244		MOVE	U,REFUNI	;Requested unit
   487	000525'	550645	000477*		HRRZ	P2,UNISTR(U)	;STR it belongs to
   488	000526'	554255	000500*		HLRZ	U,STRUNI(P2)	;First unit of that STR
   489	000527'	260040	000000*		PUSHJ	P,OPAGIN	;Read RIB of this file
   490	000530'	254000	770677		  JRST	PAKLEV
   491	000531'	200654	000000*		MOVE	P2,RIBSIZ(P1)	;CALC NO. OF THE LAST PAGE IN
   492	000532'	231640	001000		IDIVI	P2,1000		;FILE. (NB NOT TRUE IN GENERAL.)
   493	000533'	200414	000000*	PREF3:	MOVE	T3,RIBSZS(P1)	;FOUND RIGHT RIB IF
   494	000534'	302400	000001		CAIE	T3,1		;AT LOWEST LEVEL.
   495	000535'	254000	770542		 JRST	PREF4		;
   496	000536'	271654	000000*		ADDI	P2,RIBPFS(P1)	;P2/ ADDR OF EOF PNTR.
   497	000537'	332014	000000*		SKIPE	RIBRIB(P1)	;
   498	000540'	271640	000000*		 ADDI	P2,RIBSFS-RIBPFS;Spare RIBs start at a different location
   499	000541'	254000	770561		JRST	PREF11		;
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 13
REFSTR.MAC	20-NOV-87 22:23		PAKREF - Refresh a single pack which is being added to a STR

   500				;GO DOWN A LEVEL INTO A SPARE RIB
   501
   502	000542'	230654	000533*	PREF4:	IDIV	P2,RIBSZS(P1)	;ELSE P2/ #PRECED SPARE PNTRS, P3/ INDEX
   503	000543'	271654	000536*		ADDI	P2,RIBPFS(P1)	;P2/ ADDR OF NEXT PNTR.
   504	000544'	332014	000537*		SKIPE	RIBRIB(P1)	;
   505	000545'	271640	000000*		 ADDI	P2,RIBSFS-RIBPFS;Third level of RIBs
   506	000546'	200355	000000		MOVE	T2,(P2)		;IS THE PNTR
   507	000547'	607340	000000*		TLNN	T2,RBSPAR	;A SPARE RIB PNTR?
   508	000550'	254000	770560		 JRST	PREF5		;NO, WE ARE IN THIS RIB.
   509	000551'	200640	000016		MOVE	P2,P3		;YES, WE MUST READ
   510	000552'	135240	000000*		LDB	U,RBYUNI	;IN
   511	000553'	200245	000000*		MOVE	U,UNTTBL(U)	;THE
   512	000554'	135440	000213*		LDB	T4,RBYPNO	;LOWER
   513	000555'	260040	000527*		PUSHJ	P,OPAGIN	;RIB.
   514	000556'	254000	770677		  JRST	PAKLEV		;
   515	000557'	254000	770533		JRST	PREF3		;P2 has index into the current RIB
   516
   517	000560'	271656	000000	PREF5:	ADDI	P2,(P3)		;Index to a real pointer following a spare
   518
   519				    ;HERE WITH ADDR OF EOF PNTR IN P2.
   520
   521	000561'	200300	000015	PREF11:	MOVE	T1,P2		;BUILD
   522	000562'	274640	000014		SUB	P2,P1		; AN
   523	000563'	275640	000002*		SUBI	P2,RIBLST+2	; AOBJN
   524	000564'	506640	000006		HRLM	P2,T1		; POINTER
   525	000565'	541306	777777		HRRI	T1,-1(T1)	; IN T1.
   526	000566'	202317	772226		MOVEM	T1,R.RBPS(P4)	;Store for adding more RIB pointers
   527	000567'	253740	770516	PRFNST:	AOBJN	P4,PREF2	;Locate all 3 files
   528
   529				    ;READ THE BAT PAGE INTO %BAT.
   530	000570'	200240	772244		MOVE	U,REFUNI	;READ THE
   531	000571'	260040	000153*		PUSHJ	P,GETBAT	;BAT PAGE.
   532	000572'	254000	770677		  JRST	PAKLEV		;
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 14
REFSTR.MAC	20-NOV-87 22:23		PAKREF - Refresh a single pack which is being added to a STR

   533				;HERE FOR THE SATS FOR THIS UNIT.
   534
   535	000573'	260040	771115		PUSHJ	P,SATCLC	;CALC BEGSAT, SVSBTL, LPGSAT, AND SATIND.
   536
   537				    ;THIS IS THE LOOP FOR EACH SAT.
   538
   539	000574'	260040	770737	RFNXST:	PUSHJ	P,INISAT	;SET UP A SAT AND PART OF HOME.SYS.
   540	000575'	256000	770000		 STOPCD
   541
   542	000576'	260040	771075		PUSHJ	P,NXCLC		;CALC INFO FOR NEXT SAT.
   543	000577'	254000	770574		  JRST	RFNXST		;Loop for all SATs on new unit
   544
   545
   546				    ;SET NEW RIBSIZ'S IN THE RIBS FOR HOME.SYS AND SAT.SYS
   547
   548	000600'	201300	752000		MOVEI	T1,%HMR		;		HOME
   549	000601'	260040	772151		PUSHJ	P,CNVSZM	;
   550	000602'	400340	000000		SETZ	T2,		;STORE THE
   551	000603'	260040	771611		PUSHJ	P,HOMRBS	;EOF POINTER.
   552
   553	000604'	201300	750000		MOVEI	T1,%STR		;		SAT
   554	000605'	260040	772151		PUSHJ	P,CNVSZM	;
   555	000606'	400340	000000		SETZ	T2,		;
   556	000607'	260040	771602		PUSHJ	P,SATRBS	;STORE EOF POINTER
   557
   558				IFN FTSPAG,<    ;SET NEW RIBSIZ'S IN THE RIB FOR SPAGES.SYS
   559	000610'	336000	772231		SKIPN	TMPRBP		;Is there a file to be added to?
   560	000611'	254000	770632		 JRST	PAKSP0		;No
   561				;INISAT has reserved cylinders 1 and 2 for SPAGES.SYS
   562	000612'	135300	000435*		LDB	T1,UNYPPY	;GET # PAGES PER CYLINDER
   563	000613'	242300	000001		LSH	T1,1		; 2 cylinders
   564	000614'	272300	746000*		ADDM	T1,%TMP+RIBALP	;Add to allocated pages
   565	000615'	242300	000011		LSH	T1,P2WLSH	; # of words
   566	000616'	272300	746000*		ADDM	T1,%TMP+RIBSIZ	;Add to written words
   567	000617'	135300	000612*		LDB	T1,UNYPPY	;GET # PAGES PER CYLINDER
   568	000620'	210700	000006		MOVN	P3,T1		; NEGATE AND POSITION
   569	000621'	242700	000023		LSH	P3,^D<18+1>	; FOR AOBJN LENGTH (-N*2,,0)
   570	000622'	540700	000006		HRR	P3,T1		;First page is start of cyl 1
   571
   572	000623'	550300	000016	PAKSPG:	HRRZ	T1,P3		;GET THIS PAGE NEXT
   573	000624'	260040	771154		PUSHJ	P,MAKPAG	; CONVERT T1 TO RETRIEVAL POINTER
   574	000625'	260040	771716		PUSHJ	P,PTREXT	;PUT THE PAGE IN THE RIB
   575	000626'	254000	770677		  JRST	PAKLEV
   576	000627'	253700	770623		AOBJN	P3,PAKSPG	;LOOP FOR ALL PAGES THIS UNIT
   577
   578	000630'	400340	000000		SETZ	T2,		;STORE THE
   579	000631'	260040	771716		PUSHJ	P,PTREXT	;NEW EOF POINTER
   580	770632			PAKSP0:
   581				>  ;end IFN FTSPAG
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 15
REFSTR.MAC	20-NOV-87 22:23		PAKREF - Refresh a single pack which is being added to a STR

   582				;NOW FIX UP THE HOME PAGES ON THIS UNIT.
   583
   584	000632'	200240	772244	FIXHOM:	MOVE	U,REFUNI	;Read HOM page on unit in question
   585	000633'	260040	000505*		PUSHJ	P,GETHOM
   586	000634'	256000	770000		 STOPCD
   587	000635'	402000	753000*		SETZM	%HOM+HOMREF	;Clear "needs refreshing" flag
   588	000636'	402000	753014		SETZM	%HOM+HOMFEP	;Front-end file system on DSKB0 only
   589	000637'	550300	000000*		HRRZ	T1,STRDDB+STRHSH
   590	000640'	516300	753000*		HRLZM	T1,%HOM+HOMHSH	;
   591	000641'	550300	772236		HRRZ	T1,RANNO	;
   592	000642'	542300	753000*		HRRM	T1,%HOM+HOMRAN	;
   593	000643'	205300	777770		MOVSI	T1,-NFILE-NUFDS
   594	000644'	200346	772206	FIXHM1:	MOVE	T2,R.RIBS(T1)	;Ret Ptr to RIB of this file or ufd
   595	000645'	135400	772255		LDB	T3,[POINT 9,R.EXPR(T1),35]
   596	000646'	332000	000010		SKIPE	T3		;If it belongs in the HOM page
   597	000647'	202350	753000		 MOVEM	T2,%HOM(T3)	; put it there
   598	000650'	253300	770644		AOBJN	T1,FIXHM1	;Update HOMTAB (HOMSAT thru HOMMFD)
   599	000651'	260040	000455*		PUSHJ	P,WTBOTH	;NOW WRITE THEM OUT.
   600	000652'	256000	770000		 STOPCD
   601	000653'	550645	000525*		HRRZ	P2,UNISTR(U)	;
   602	000654'	201300	000466*		MOVEI	T1,UFDHSI	;
   603	000655'	542315	000467*		HRRM	T1,STRHSH(P2)	;
   604
   605				    ;NOW WRITE OUT THE RIBS FOR HOME AND SAT and maybe SPAGES.
   606
   607	000656'	205740	777773		MOVSI	P4,-NFILE	;
   608	000657'	332017	772216	PAKRB1:	SKIPE	R.PCBS(P4)	;Do only the 3 special files
   609	000660'	336017	772206		SKIPN	R.RIBS(P4)	;Was this RIB read in?
   610	000661'	254000	770672		 JRST	PKRB1A		;No, OK for RIB to SPAGES.SYS to be missing
   611	000662'	554417	772216		HLRZ	T3,R.PCBS(P4)	;Virtual address
   612	000663'	200350	000000*		MOVE	T2,RIBSLF(T3)	;Self pointer says where to write the data
   613	000664'	135440	000554*		LDB	T4,RBYPNO	;Page within unit
   614	000665'	135240	000552*		LDB	U,RBYUNI	;Unit number
   615	000666'	200245	000553*		MOVE	U,UNTTBL(U)	;Unit data block
   616	000667'	550157	772216		HRRZ	PG,R.PCBS(P4)	;Physical address
   617	000670'	260040	000215*		PUSHJ	P,OPAGOT	;Write it out
   618	000671'	256000	770000		 STOPCD
   619	000672'	253740	770657	PKRB1A:	AOBJN	P4,PAKRB1	;Do all 3 files
   620	000673'	260040	771540		PUSHJ	P,CNDSWT	;Write out SAT if any
   621	000674'	256000	770000		 STOPCD
   622	000675'	260040	771622		PUSHJ	P,CLUAOB	;Clear SATAOB
   623	000676'	350001	000000		AOS	(P)		;SUCCESS RETURN
   624
   625	000677'	200240	772244	PAKLEV:	MOVE	U,REFUNI	;Restore U and P2
   626	000700'	550645	000653*		HRRZ	P2,UNISTR(U)	;
   627	000701'	263040	000000		POPJ	P,		;End of PAKREF
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 16
REFSTR.MAC	20-NOV-87 22:23		SCNBAT - Scan BAT pages

   628				SUBTTL	SCNBAT - Scan BAT pages
   629
   630				COMMENT #
   631				@@SUBROUTINE SCNBAT
   632				@@PURPOSE
   633				SUBR TO SCAN BAT AREA AND EXECUTE AN INSTRUCTION FOR EACH BAD PAGE.
   634				@@ENTRY
   635				EXPECTS T2/ INSTRUCTION TO EXECUTE (AND IF CALLING SETBTS,
   636				T3/ ADDR OF STT ENTRY.).
   637				@@ACCUM
   638				DESTROYS T1, T2, AND T4.
   639				@@EXIT
   640				SKIP RETURNS UNLESS ERROR, IN WHICH CASE NON-SKIP RETURNS.
   641				@@ #
   642
   643				;Called from INISAT to mark bad pages as unuseable.
   644				;The old version of PAKCOP interpreted the numbers in the BAT pages as being
   645				;block numbers, it has been corrected to use page numbers.
   646				;See also UPERBT (update error BAT) routine in CORE1.
   647
   648	000702'	265440	000121*	SCNBAT::JSP	T4,SAVE4	;SAVE P1-P4
   649	000703'	200640	000007		MOVE	P2,T2		;P2=INSTRUCTION TO EXECUTE.
   650	000704'	201740	747000		MOVEI	P4,%BAT		;P4/ -NO. OF WORDS IN AREA,,
   651	000705'	270740	747000*		ADD	P4,%BAT+BATFIR	;ADDR OF 1ST ENTRY.
   652
   653				    ;HERE FOR EACH ENTRY.
   654	000706'	336017	000000*	SCNBT2:	SKIPN	BATNBB(P4)	;AT END?
   655	000707'	254000	000473*		 JRST	CPOPJ1		;YES.
   656	000710'	550340	000017		HRRZ	T2,P4		;Put addr in T2 for BAYNBB
   657	000711'	135700	000000*		LDB	P3,BAYNBB	;NUMBER BAD PAGES-1.
   658	000712'	334617	000000*		SKIPA	P1,BATELB(P4)	;P1=1ST BAD PAGE.
   659				    ;HERE FOR EACH BAD PAGE.
   660	000713'	271600	000001	SCNBT3:	 ADDI	P1,1		;P1=NEXT BAD PAGE.
   661	000714'	200300	000014		MOVE	T1,P1		;ARG FOR INSTRUCTION.
   662	000715'	256000	000015		XCT	P2		;MARK THIS PAGE IN SAT.
   663	000716'	365700	770713		SOJGE	P3,SCNBT3	;LOOP FOR ALL BAD PAGES THIS REGION.
   664	000717'	252740	770721		AOBJP	P4,.+2		;COMPENSATE FOR 2 WORD ENTRIES.
   665	000720'	253740	770706		AOBJN	P4,SCNBT2	;LOOP FOR ALL ENTRIES
   666	000721'	260040	772256		 MSGLIV	BATBAD		;Output message if BAT is completely full
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 17
REFSTR.MAC	20-NOV-87 22:23		SCNBAT - Scan BAT pages

   667				COMMENT #
   668				@@SUBROUTINE SETBTS
   669				@@PURPOSE
   670				SUBR TO CLEAR AN F BIT IN %STA AND DECREMENT STTFPC.
   671				This marks the page as being "in use".
   672				@@ENTRY
   673				EXPECTS T1/ PAGE NO. OF BIT AND T3/ ADDR OF STT ENTRY.
   674				@@ACCUM
   675				DESTROYS T1, T2, AND T4.
   676				@@ #
   677
   678	000722'	311300	772240	SETBTS:	CAML	T1,BEGSAT	;SKIP IF BEFORE BEGINNING OF CURRENT SAT.
   679	000723'	313300	772242		CAMLE	T1,LPGSAT	;SKIP IF WITHIN CURRENT SAT (NOT PAST END)
   680	000724'	263040	000000		 POPJ	P,		;PAGE NOT IN CURRENT SAT.
   681	000725'	274300	772240		SUB	T1,BEGSAT	;
   682	000726'	231300	000044		IDIVI	T1,^D36		;T1=INDEX IN PAGE OF BIT.
   683	000727'	213000	000007		MOVNS	T2		;T2=BITS TO SHIFT RIGHT
   684	000730'	205440	400000		MOVSI	T4,400000	;SET LEFTMOST BIT
   685	000731'	242447	000000		LSH	T4,(T2)		;POSITION BIT
   686	000732'	616446	751000		TDNN	T4,%STA(T1)	;SKIP IF BIT SET.
   687	000733'	263040	000000		 POPJ	P,		;ALREADY CLEAR, JUST RETURN.
   688	000734'	412446	751000		ANDCAM	T4,%STA(T1)	;SO CLEAR IT.
   689	000735'	370010	000000*		SOS	STTFPC(T3)	;NOTE ONE LESS FREE PAGE.
   690	000736'	263040	000000		POPJ	P,
   691
   692
   693				SUBTTL VARIOUS SUBROUTINES.
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 18
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

   694				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   695				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   696				;;									;;
   697				;;	INISAT	Set all the bits in %STA to represent available pages,	;;
   698				;;		except for BAD pages, the HOME, BAT and BOOT pages, on	;;
   699				;;		KS-10 the FEFILE pages, the special spare pages on all	;;
   700				;;		disk units, non-existent pages and page 0.		;;
   701				;;		Also, make the STT entry and write out the SAT.		;;
   702				;;									;;
   703				;;		Destroys T1 thru T4, P1 thru P4 and PG.			;;
   704				;;		calls: CORONZ, SCNBAT, SETBTS, GETHMP, SATSRH, SATRBS,	;;
   705				;;		       OPAGOT, TAKPAG and CPOPJ1.			;;
   706				;;									;;
   707				;;	expects	BEGSAT, SVSBTL, LPGSAT and SATIND setup.		;;
   708				;;		U/ UNIT DB						;;
   709				;;		F/ DDB							;;
   710				;;									;;
   711				;;	returns	SKIP if no errors.					;;
   712				;;		NON-SKIP if anything goes wrong.			;;
   713				;;									;;
   714				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   715				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   716
   717				    ;HERE TO MAKE THE STT ENTRY.
   718	000737'	260040	771540	INISAT:	PUSHJ	P,CNDSWT	;WRITE OUT ANY SAT IN CORE BEFORE
   719	000740'	263040	000000		  POPJ	P,		; WE WIPE IT OUT.
   720	000741'	350300	772245		AOS	T1,SATIND	;GET INTO T1 THE
   721	000742'	221300	000000*		IMULI	T1,STTLEN	;ADDR OF THE
   722	000743'	550345	000000*		HRRZ	T2,UNISTT(U)	;STT
   723	000744'	271307	000000		ADDI	T1,(T2)		;ENTRY.
   724	000745'	402006	000000*		SETZM	STTAOB(T1)	;CLEAR AOBJN POINTER.
   725	000746'	200340	772241		MOVE	T2,SVSBTL	;SET THE COUNT OF
   726	000747'	202346	000735*		MOVEM	T2,STTFPC(T1)	;FREE PAGES.
   727	000750'	402006	000000*		SETZM	STTSTS(T1)	;CLEAR THE STATUS.
   728	000751'	261040	000006		PUSH	P,T1		;SAVE ENTRY ADDR FOR BELOW.
   729
   730				    ;HERE TO SET ALL SAT BITS AND THEN CLEAR BITS OF NON-EXISTENT PAGES.
   731	000752'	551300	751000		HRRZI	T1,%STA		;SET THE ENTIRE
   732	000753'	476000	751000		SETOM	%STA		;AREA REPRESENTED IN THIS
   733	000754'	260040	000000*		PUSHJ	P,CORONZ	;SAT TO AVAILABLE.
   734	000755'	200340	772241		MOVE	T2,SVSBTL	;ANY NON-EXISTENT PAGES
   735	000756'	301340	022000		CAIL	T2,400*^D36	;AT THE END OF THE SAT?
   736	000757'	254000	770777		 JRST	INISA3		;NO.
   737	000760'	400300	000000		SETZ	T1,		;YES, DOES A PARTIAL
   738	000761'	231340	000044		IDIVI	T2,^D36		;WORD IN THE SAT HAVE
   739	000762'	322400	770766		JUMPE	T3,INISA2	;TO BE SET?
   740	000763'	205300	400000		MOVSI	T1,400000	;YES.  SET
   741	000764'	211410	777777		MOVNI	T3,-1(T3)	;THE PARTIAL
   742	000765'	240310	000000		ASH	T1,(T3)		;WORD.
   743	000766'	202307	751000	INISA2:	MOVEM	T1,%STA(T2)	;SET PARTIAL WORD OR NEXT WORD.
   744	000767'	301340	000377		CAIL	T2,377		;ANY MORE WORDS TO SET?
   745	000770'	254000	770777		 JRST	INISA3		;NO.
   746				page
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 19
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

   747	000771'	402007	751001		SETZM	%STA+1(T2)	;YES, PREPARE TO BLT.
   748	000772'	301340	000376		CAIL	T2,376		;BUT NOT IF ONLY ONE
   749	000773'	254000	770777		 JRST	INISA3		;WORD TO DO.
   750	000774'	551347	751002		HRRZI	T2,%STA+2(T2)	;SET THE REST OF
   751	000775'	505347	777777		HRLI	T2,-1(T2)	;THE SAT TO
   752	000776'	251340	751377		BLT	T2,%STA+377	;UNAVAILABLE.
   753
   754				    ;HERE TO SCAN BAT AREA AND MARK BAD PAGES IN SAT.
   755
   756	000777'	262040	000010	INISA3:	POP	P,T3		;RESTORE STT ENTRY ADDRESS.
   757	001000'	200340	772263		MOVE T2,[PUSHJ P,SETBTS];INSTRUCTION TO EXECUTE
   758	001001'	260040	770702		PUSHJ	P,SCNBAT	;FOR EACH BAD PAGE.
   759	001002'	263040	000000		  POPJ	P,
   760
   761	001003'	332000	772240	INISA5:	SKIPE	BEGSAT		;SKIP IF THIS IS 1ST SAT ON THIS UNIT
   762	001004'	254000	771043		 JRST	INISA6
   763
   764				    ;HERE TO ALLOCATE PAGES (HOME, BAT, AND BOOTS) IN HOME.SYS FILE
   765				    ;AND PAGE FOR SAT.SYS RIB.
   766				    ;(DONE ONLY IF THIS IS THE FIRST SAT ON THIS UNIT.).
   767	001005'	205700	777773		MOVSI	P3,-LBNLEN
   768	001006'	200316	771070	INISAA:	MOVE	T1,LBNLST(P3)
   769	001007'	260040	771124		PUSHJ	P,GETHMP	;GET NEXT PAGE IN THE GROUP.
   770	001010'	263040	000000		  POPJ	P,		;CAN'T GET IT.
   771	001011'	253700	771006		AOBJN	P3,INISAA	;LOOP FOR ALL OF THE GROUP
   772	001012'	200700	772264		MOVE	P3,[XWD -NBOOTP,FBOOTB]	;P3=-# PAGES FOR BOOTS, 1ST PAGE.
   773	001013'	550300	000016	INISAB:	HRRZ	T1,P3		;NEXT PAGE TO ALLOCATE.
   774	001014'	260040	771124		PUSHJ	P,GETHMP	;ALLOCATE THE PAGE, STORE IN %HMR
   775	001015'	263040	000000		  POPJ	P,
   776	001016'	253700	771013		AOBJN	P3,INISAB	;LOOP FOR ALL PAGES TO ALLOCATE FOR BOOTS.
   777				IFN FTSPAG,<	;;Allocate 2 cylinders in SAT even if no RIB for SPAGES.SYS
   778	001017'	135300	000617*		LDB	T1,UNYPPY	;GET # PAGES PER CYLINDER
   779	001020'	210700	000006		MOVN	P3,T1		; NEGATE AND POSITION
   780	001021'	242700	000023		LSH	P3,^D<18+1>	; FOR AOBJN LENGTH (-N*2,,0)
   781	001022'	540700	000006		HRR	P3,T1		;GET FIRST PAGE AS POINTER
   782	001023'	550300	000016	INISAC:	HRRZ	T1,P3		; NEED TO GET THIS PAGE #
   783	001024'	260040	771130		PUSHJ	P,TAKPAG	;RESERVE THE PAGE SO NOBODY ELSE GETS IT.
   784	001025'	263040	000000		  POPJ	P,
   785	001026'	253700	771023		AOBJN	P3,INISAC	;LOOP FOR ALL PAGES ON CYL 1 AND 2
   786				> ; End IFN FTSPAG
   787
   788	001027'	312240	772243		CAME	U,FSTUNI	;If not first unit,
   789	001030'	254000	771043		 JRST	INISA6		; skip the rest
   790				IFCPU(KS),<			;KS-10 HAS FE-FILE AREA FOR 8080
   791	001031'	135700	001017*		LDB	P3,UNYPPY	;GET # PAGES PER CYLINDER
   792	001032'	221700	000003	IFN FTSPAG,<IMULI P3,3>		;Skip over cylinders 0,1,2,3 if SPAGES
   793	001033'	505700	777700		HRLI	P3,-FEFLEN	;GET LENGTH OF FE AREA
   794	001034'	550300	000016	INISAD:	HRRZ	T1,P3		; NEED TO GET THIS PAGE #
   795	001035'	260040	771130		PUSHJ	P,TAKPAG	;RESERVE THE PAGE SO NOBODY ELSE GETS IT.
   796	001036'	263040	000000		  POPJ	P,
   797	001037'	253700	771034		AOBJN	P3,INISAD	;LOOP FOR ALL PAGES TO ALLOCATE FE AREA
   798				> ; End IFCPU(KS)
   799				page
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 20
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

   800	001040'	201300	000010		MOVEI	T1,LPNSAT	;ALLOCATE PAGE 10 FOR THE RIB TO
   801	001041'	260040	771130		PUSHJ	P,TAKPAG	; SAT.SYS SO NOBODY ELSE GETS IT.
   802	001042'	263040	000000		  POPJ	P,		;End of first-unit-only stuff
   803				    ;HERE TO WRITE THIS SAT PAGE OUT TO THE DISK.
   804
   805	001043'	200600	000010	INISA6:	MOVE	P1,T3		;P1 HAS INDEX FOR SATSRH AND SAFETY.
   806	001044'	333014	000747*		SKIPLE	STTFPC(P1)	;ROOM IN THIS SAT FOR ITSELF?
   807	001045'	254000	771060		 JRST	INISA8		;YES. (always is)
   808	001046'	550305	000743*		HRRZ	T1,UNISTT(U)	;NO.  TRY TO
   809	001047'	306606	000000		CAIN	P1,(T1)		;FIND ROOM
   810	001050'	260040	772265		 MSGLIV	OGTPG		;IN AN EARLIER SAT, IF THERE IS ONE.
   811	001051'	200300	772272		MOVE	T1,[XWD %STA,%T2P] ;MEANWHILE, SAVE US
   812	001052'	251300	745777		BLT	T1,%T2P+777	;IN %T2P.
   813	001053'	402014	000000*		SETZM	STTPTR(P1)	;DON'T LET OGETPG GET PAST US.
   814	001054'	260040	771511		PUSHJ	P,OGETPG	;TRY TO GET A PAGE IN AN EARLIER SAT.
   815	001055'	263040	000000		  POPJ	P,		;
   816	001056'	201140	000000*		MOVEI	PG,%T2P.P	;REMEMBER WE WANT TO WRITE OUT %T2P.
   817	001057'	254000	771064		JRST	INISA9		;
   818	001060'	201640	000001	INISA8:	MOVEI	P2,1		;HERE TO GET A PAGE
   819	001061'	260040	771412		PUSHJ	P,SATSRH	;IN OURSELVES.
   820	001062'	263040	000000		  POPJ	P,
   821	001063'	201140	000000*		MOVEI	PG,%STA.P	;REMEMBER WE WANT TO WRITE OUT %STA.
   822	001064'	202354	001053*	INISA9:	MOVEM	T2,STTPTR(P1)	;STORE THE DISK PNTR TO THE SAT.
   823	001065'	260040	771602		PUSHJ	P,SATRBS	; " IN SAT.SYS RIB.
   824	001066'	135440	000664*		LDB	T4,RBYPNO	;WRITE OUT THE
   825	001067'	324740	000670*		PJRST	OPAGOT		;SAT PAGE, SKIP RETURN
   826
   827	001070'	000000	000000	LBNLST:	0		;Page 0 is reserved (TOPS-10 HOM block on KS)
   828	001071'	000000	000001		LPNHOM		;Primary HOM
   829	001072'	000000	000006		LP2HOM		;Secondary HOM
   830	001073'	000000	000002		LPNBAT		;Primary BAT
   831	001074'	000000	000007		LP2BAT		;Secondary BAT
   832			000005	LBNLEN==.-LBNLST
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 21
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

   833				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   834				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   835				;;									;;
   836				;;	NXCLC	See if this unit needs more SATs than we have already	;;
   837				;;		created.  Destroys T2.					;;
   838				;;									;;
   839				;;	expects	U/ UNIT DB						;;
   840				;;		BEGSAT and SVSBTL setup.				;;
   841				;;									;;
   842				;;	returns	SKIP if no more SATs for this unit.			;;
   843				;;		NON-SKIP with BEGSAT, LPGSAT and SVSBTL set up.		;;
   844				;;									;;
   845				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   846				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   847
   848	001075'	200340	772241	NXCLC:	MOVE	T2,SVSBTL	;PAGES IN THIS SAT.
   849	001076'	270340	772240		ADD	T2,BEGSAT	;LAST PAGE IN THIS SAT+1. NEXT
   850	001077'	311345	000000*		CAML	T2,UNIPPU(U)	;SAT WOULD BE PAST E O UNIT?
   851	001100'	254000	000707*		 JRST	CPOPJ1		;YES, NO MORE SATS THIS UNIT.
   852	001101'	202340	772240		MOVEM	T2,BEGSAT	;NO, ANOTHER SAT FOR THIS UNIT.
   853	001102'	270340	772241		ADD	T2,SVSBTL	;COMPUTE END OF NEXT
   854	001103'	275340	000001		SUBI	T2,1		;SAT.
   855	001104'	202340	772242		MOVEM	T2,LPGSAT	;REMEMBER LAST PAGE NEW SAT.
   856	001105'	271340	000001		ADDI	T2,1		;SKIP IF NEW SAT WOULD GO
   857	001106'	317345	001077*		CAMG	T2,UNIPPU(U)	;PAST END OF UNIT.
   858	001107'	263040	000000		 POPJ	P,		;NO, KEEP GOING.
   859	001110'	274345	001106*		SUB	T2,UNIPPU(U)	;YES. FIND OUT HOW
   860	001111'	213000	000007		MOVNS	T2		;MUCH OVER.
   861	001112'	272340	772241		ADDM	T2,SVSBTL	;CORRECT SIZE OF SAT
   862	001113'	272340	772242		ADDM	T2,LPGSAT	;AND LAST PAGE.
   863	001114'	263040	000000		POPJ	P,		;MORE SATS THIS UNIT.
   864
   865
   866				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   867				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   868				;;									;;
   869				;;	SATCLC	Set BEGSTA, SVSBTL, LPGSAT and SATIND for the first	;;
   870				;;		SAT on a unit.  Destroys T1.				;;
   871				;;									;;
   872				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   873				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   874
   875	001115'	402000	772240	SATCLC:	SETZM	BEGSAT		;BEGSAT/ 1ST SAT ON A UNIT.
   876	001116'	201300	022000		MOVEI	T1,400*^D36	;SVSBTL/ NO. OF REAL
   877	001117'	202300	772241		MOVEM	T1,SVSBTL	;ENTRIES IN THIS SAT.
   878	001120'	275300	000001		SUBI	T1,1		;LPGSAT/ LAST PAGE IN
   879	001121'	202300	772242		MOVEM	T1,LPGSAT	;THE FIRST SAT.
   880	001122'	476000	772245		SETOM	SATIND		;SAT INDEX,
   881	001123'	263040	000000		POPJ	P,		;SET TO -1 (BECAUSE WE AOS.).
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 22
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

   882				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   883				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   884				;;									;;
   885				;;	GETHMP	Allocate 1 page in current SAT for HOME.SYS while	;;
   886				;;		creating SATs.  (Only works for first SAT on a unit).	;;
   887				;;		Destroys T1 and T2.					;;
   888				;;		calls: TAKPAG and HOMRBS.				;;
   889				;;									;;
   890				;;	expects	T1/ LOGICAL PAGE NO. TO ALLOCATE			;;
   891				;;		T3/ STT ENTRY ADDRESS					;;
   892				;;		U/  UNIT DB						;;
   893				;;									;;
   894				;;	returns	NON-SKIP IF CAN'T HAVE PAGE.				;;
   895				;;		SKIP IF GET PAGE, RETRIEVAL POINTER STORED IN RIB	;;
   896				;;		OF HOME.SYS IN MEMORY.					;;
   897				;;									;;
   898				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   899				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   900
   901	001124'	260040	771130	GETHMP:	PUSHJ	P,TAKPAG	;
   902	001125'	263040	000000		  POPJ	P,		;NOT AVAILABLE.
   903	001126'	260040	771611		PUSHJ	P,HOMRBS	;
   904	001127'	254000	001100*		JRST	CPOPJ1
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 23
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

   905				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   906				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   907				;;									;;
   908				;;	TAKPAG	Marks a page taken and adjust SSTFPC.			;;
   909				;;		Destroys T1 and T2.					;;
   910				;;									;;
   911				;;	expects	T1/ LOGICAL PAGE NO. TO ALLOCATE			;;
   912				;;		T3/ STT ENTRY ADDRESS					;;
   913				;;		U/  UNIT DB						;;
   914				;;									;;
   915				;;	returns	NON-SKIP RETURN IF CAN'T HAVE PAGE.			;;
   916				;;		SKIP RETURN IF GET PAGE, WITH THE RETRIEVAL POINTER	;;
   917				;;		TO THE PAGE IN T2.					;;
   918				;;									;;
   919				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   920				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   921
   922	001130'	265440	000000*	TAKPAG:	JSP	T4,SAVE1	;SAVE P1
   923	001131'	261040	000006		PUSH	P,T1		;SAVE PAGE NEEDED (FOR PNTR.).
   924	001132'	311300	772240		CAML	T1,BEGSAT	;Make sure it is in the SAT that
   925	001133'	313300	772242		CAMLE	T1,LPGSAT	; T3 points to
   926	001134'	260040	772273		 MSGLIV	NOTAVL		;The caller goofed
   927	001135'	274300	772240		SUB	T1,BEGSAT	;Page with the SAT
   928	001136'	231300	000044		IDIVI	T1,^D36
   929	001137'	271300	751000		ADDI	T1,%STA		;
   930	001140'	213000	000007		MOVNS	T2		;
   931	001141'	205600	400000		MOVSI	P1,400000
   932	001142'	242607	000000		LSH	P1,(T2)		;SHIFT BIT INTO POSITION
   933	001143'	262040	000007		POP	P,T2		;
   934	001144'	616606	000000		TDNN	P1,(T1)		;SKIP IF AVAILABLE.
   935	001145'	260040	772273		 MSGLIV	NOTAVL		;NOT AVAILABLE.
   936	001146'	432606	000000		XORM	P1,(T1)		;MARK THE PAGE UNAVAILABLE.
   937	001147'	661340	000521*		TLO	T2,RBREAL	;MAKE T2
   938	001150'	135300	000000*		LDB	T1,UNYLUN	;A
   939	001151'	137300	000665*		DPB	T1,RBYUNI	;RETRIEVAL POINTER.
   940	001152'	370010	001044*		SOS	STTFPC(T3)	;
   941	001153'	254000	001127*		JRST	CPOPJ1
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 24
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

   942				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   943				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   944				;;									;;
   945				;;	MAKPAG	Makes a retrieval pointer out of the page number in	;;
   946				;;		T1 and returns it in T2.				;;
   947				;;									;;
   948				;;	expects	T1/ logical page number on unit				;;
   949				;;		U/  unit data block					;;
   950				;;									;;
   951				;;	returns	T2/ retrieval pointer					;;
   952				;;									;;
   953				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   954				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   955
   956	001154'	261040	000006	MAKPAG:	PUSH	P,T1		; Save page.
   957	001155'	200340	000006		MOVE	T2,T1		; Copy for pointer.
   958	001156'	661340	001147*		TLO	T2,RBREAL	; Make T2
   959	001157'	135300	001150*		LDB	T1,UNYLUN	; a
   960	001160'	137300	001151*		DPB	T1,RBYUNI	; Retrieval pointer.
   961	001161'	262040	000006		POP	P,T1		; Restore page
   962	001162'	263040	000000		POPJ	P,		;  and return
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 25
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

   963				COMMENT #
   964				@@SUBROUTINE UFDSET
   965				@@PURPOSE
   966				SUBR TO SET UP INFORMATION IN A UFD RIB IN %TMP AND THEN WRITE IT OUT.
   967				@@ENTRY
   968				EXPECTS T1/ FILENAME OF UFD, T2/EXT+PROT     U/ UNIT DB, P1/ AOBJN PNTR TO
   969				FILENAMES, AND P2/ ARG. FOR RIBUSD.
   970				@@CALLS
   971				HASH, RIBSET, OGETPG, AND TMPOUT.
   972				@@EXIT
   973				NON-SKIP RETURNS IF ERROR, ELSE SKIP RETURNS WITH
   974				T2/ DISK PNTR TO RIB ITSELF.
   975				@@ #
   976
   977	001163'	261040	000015	UFDSET:	PUSH	P,P2		;RIBUSD
   978	001164'	200400	000413*		MOVE	T3,MFDPPN	;T1&T2 HAVE NAME & EXT & PROT
   979	001165'	201440	746000		MOVEI	T4,%TMP		;
   980	001166'	201740	000000*		MOVEI	P4,RIPDIR	;SET DIRECTORY BIT IN STATUS
   981	001167'	260040	772076		PUSHJ	P,RIBSET	;SET UP INFO IN RIB IN CORE.
   982	001170'	262040	000007		POP	P,T2		;STORE NO. OF PAGES IN ALL THE
   983	001171'	202340	746000*		MOVEM	T2,%TMP+RIBUSD	;FILES THIS UFD POINTS TO.
   984	001172'	202340	746000*		MOVEM	T2,%TMP+RIBMXA	;
   985				    ;SET UP UFDHSI NON-EXISTENT PNTRS.
   986	001173'	201300	000654*		MOVEI	T1,UFDHSI	;SET UP UFDHSI
   987	001174'	201340	434164		MOVEI	T2,(SIXBIT/CAT/) ;NON-EXISTENT PNTRS
   988	001175'	202346	745777*		MOVEM	T2,%TMP+RIBPFS-1(T1) ;IN THE PRIME
   989	001176'	367300	771175		SOJG	T1,.-1		;RIB.
   990				    ;SET UP THE REAL PNTRS.
   991	001177'	201700	000001		MOVEI	P3,1		;COUNT FOR RIBALP.
   992	001200'	322600	771207		JUMPE	P1,UFDST3	;All done if UFD has no files
   993				REPEAT 0,<;Removed 15-May-87, changed to allocate 7 data pages)
   994				PRINTF (<[Should allocate all 14. data pages in UFDSET for UFD project]>)
   995				UFDST1:	MOVE	T1,R.FILE(P1)	;GET T1/ FIRST FILENME.
   996					PUSHJ	P,HASH		;HASH IT TO T1.
   997					MOVE	T2,%TMP+RIBPFS-1(T1) ;PNTR FOR THIS FILE'S PAGE.
   998					TLNE	T2,RBREAL	;HAS IT ALREADY BEEN MADE REAL?
   999					  JRST	UFDST2		;YES.
  1000					MOVE	P2,T1		;SAVE PLACE.
  1001					PUSHJ	P,OGETPG	;NO, GET A PAGE FOR IT.
  1002					  POPJ	P,		;LOST.
  1003					ADDI	P3,1		;COUNT FOR RIBALP.
  1004					MOVEM	T2,%TMP+RIBPFS-1(P2) ;STORE THE REAL PNTR.
  1005				UFDST2:	AOBJN	P1,UFDST1	;CONTINUE FOR ALL FILES.
  1006				>  ;End of REPEAT 0
  1007				page
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 26
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1008				;If the UFD has any files in it at all, allocate UFDHSI data pages.
  1009				;P3 starts at 1, gets set to total pages (including RIB page).
  1010
  1011	001201'	201640	001173*		MOVEI	P2,UFDHSI	;Number of hash buckets
  1012	001202'	260040	771511	UFDST1:	PUSHJ	P,OGETPG	;Get a UFD data pages
  1013	001203'	263040	000000		  POPJ	P,		;Error
  1014	001204'	202356	745777*		MOVEM	T2,%TMP+RIBPFS-1(P3)
  1015	001205'	271700	000001		ADDI	P3,1		;Count for RIBALP
  1016	001206'	367640	771202		SOJG	P2,UFDST1	;Do all 7
  1017				;End of new code added 15-May-87
  1018
  1019	001207'	202700	746000*	UFDST3:	MOVEM	P3,%TMP+RIBALP	;STORE RIBALP.
  1020	001210'	201700	000000*		MOVEI	P3,UFDHSI*1000	;CALC AND
  1021	001211'	202700	746000*		MOVEM	P3,%TMP+RIBSIZ	;STORE RIBSIZ.
  1022	001212'	260040	771511		PUSHJ	P,OGETPG	;GET A PAGE FOR THE
  1023	001213'	263040	000000		  POPJ	P,
  1024	001214'	202340	746000*		MOVEM	T2,%TMP+RIBSLF	;RIB.
  1025	001215'	260040	771637		PUSHJ	P,TMPOUT	;WRITE OUT THE RIB.
  1026	001216'	263040	000000		  POPJ	P,
  1027	001217'	200340	746000*		MOVE	T2,%TMP+RIBSLF	;
  1028	001220'	254000	001153*		JRST	CPOPJ1
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 27
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1029				COMMENT #
  1030				@@SUBROUTINE SETUFD
  1031				@@PURPOSE
  1032				SUBR TO SET UP INFO IN THE PAGES OF A UFD AND THEN WRITE THEM OUT.
  1033				@@ENTRY
  1034				EXPECTS P1/ -LOOP COUNTER,,INDEX TO FIRST FILENAME.
  1035				EXPECTS PRIME RIB TO BE SET UP IN %TMP.
  1036				@@ACCUM
  1037				DESTROYS contents of page %T2P
  1038				@@EXIT
  1039				SKIP RETURNS UNLESS ERROR, IN WHICH CASE NON-SKIP RETURNS.
  1040				@@ #
  1041
  1042	001221'	261040	000015	SETUFD:	PUSH	P,P2		;SAVE P2.
  1043	001222'	201640	000001		MOVEI	P2,1		;P2/ CURRENT HASH NUMBER.
  1044
  1045	001223'	200355	745777*	SETUF1:	MOVE	T2,%TMP+RIBPFS-1(P2) ;T2/ ASSOCIATED RIB PNTR.
  1046	001224'	603340	001156*		TLNE	T2,RBREAL	;ANY FILE WITH THIS HASH?
  1047	001225'	254000	771232		 JRST	SETUF2		;YES, GO MAKE ENTRIES.
  1048
  1049				    ;HERE TO TRY NEXT HASH NUMBER, OR TO FINISH UP.
  1050	001226'	305640	001201*	SETUFN:	CAIGE	P2,UFDHSI	;ALL DONE?
  1051	001227'	344640	771223		 AOJA	P2,SETUF1	;NO, CONTINUE.
  1052	001230'	262040	000015		POP	P,P2		;YES, RESTORE P2.
  1053	001231'	254000	001220*		JRST	CPOPJ1		;End of SETUFD
  1054
  1055				    ;HERE TO MAKE ENTRIES IN ONE PAGE OF THE UFD.
  1056	001232'	201300	745000	SETUF2:	MOVEI	T1,%T2P		;CLEAR AN AREA FOR
  1057	001233'	260040	000000*		PUSHJ	P,CORZER	;THE UFD IN CORE, IN %T2P.
  1058	001234'	200300	772300		MOVE	T1,[XWD -776,%T2P] ;776 DIVIDES EVENLY BY 5.
  1059	001235'	202300	772237		MOVEM	T1,UFDSTP	;SET UP AOBJN PNTR FOR ENTUFD.
  1060	001236'	261040	000014		PUSH	P,P1		;P1.
  1061	001237'	200314	772156	SETUF4:	MOVE	T1,R.FILE(P1)	;Get filename or PPN
  1062	001240'	260040	771255		PUSHJ	P,HASH		;GET HASH TO T1.
  1063	001241'	306315	000000		CAIN	T1,(P2)		;MATCH FOR THIS BLOCK?
  1064	001242'	260040	771261		 PUSHJ	P,ENTUFD	;YES, MAKE THE UFD
  1065	001243'	253600	771237		AOBJN	P1,SETUF4	;
  1066	001244'	262040	000014	SETUF5:	POP	P,P1		;RESTORE P1
  1067	001245'	201140	001056*		MOVEI	PG,%T2P.P	;WRITE
  1068	001246'	200355	745777*		MOVE	T2,%TMP+RIBPFS-1(P2)	;OUT
  1069	001247'	135440	001066*		LDB	T4,RBYPNO	;THE
  1070	001250'	135240	001160*		LDB	U,RBYUNI	;PAGE
  1071	001251'	200245	000666*		MOVE	U,UNTTBL(U)	;OF THE
  1072	001252'	260040	001067*		PUSHJ	P,OPAGOT	;UFD.
  1073	001253'	263040	000000		  POPJ	P,
  1074	001254'	254000	771226		JRST	SETUFN		;Next hash bucket
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 28
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1075				;LITTLE SUBR TO HASH A FILENAME FOR A UFD.
  1076				;EXPECTS FILENAME IN T1, RETURNS HASH IN T2, DESTROYS T1.
  1077
  1078	001255'	621300	400000	HASH:	TLZ	T1,(1B0)	;Clear sign bit (so remainder is positive)
  1079	001256'	231300	001226*		IDIVI	T1,UFDHSI
  1080	001257'	201307	000001		MOVEI	T1,1(T2)	;By convention, the first bucket is 1 not 0
  1081	001260'	263040	000000		POPJ	P,
  1082
  1083
  1084
  1085				COMMENT #
  1086				@@SUBROUTINE ENTUFD
  1087				@@PURPOSE
  1088				SUBR TO MAKE AN ENTRY IN A UFD.
  1089				@@ENTRY
  1090				EXPECTS P1/ TABLE INDEX OF FILE TO ENTER
  1091				AND UFDSTP/ AOBJN POINTER TO UFD IN CORE.
  1092				@@ACCUM
  1093				DESTROYS T1 THRU T4 AND U.
  1094				@@ #
  1095
  1096			000000	XP UFDNAM,0	;File name
  1097			000001	XP UFDEXT,1	;Extension, file flags, protection
  1098			000002	XP UFDCDT,2	;Creation date and time
  1099			000003	XP UFDLIC,3	;File size and license
  1100			000004	XP UFDRIB,4	;Retrieval pointer to the RIB
  1101			000005	XP UFDSIZ,5	;Number of words in a UFD entry
  1102
  1103	001261'	336314	772206	ENTUFD:	SKIPN	T1,R.RIBS(P1)	;Do we have a RIB for this file?
  1104	001262'	263040	000000		 POPJ	P,
  1105	001263'	331440	772237		SKIPL	T4,UFDSTP	;SKIP IF STILL ROOM IN THIS PAGE.
  1106	001264'	260040	772301		 MSGSFE	UFDERR
  1107	001265'	202311	000004		MOVEM	T1,UFDRIB(T4)	;STORE RETRIEVAL POINTER
  1108	001266'	200314	772156		MOVE	T1,R.FILE(P1)	;FILE NAME
  1109	001267'	510354	772166		HLLZ	T2,R.EXPR(P1)	;EXTENSION
  1110	001270'	202311	000000		MOVEM	T1,UFDNAM(T4)	;STORE FILE NAME
  1111	001271'	502351	000001		HLLM	T2,UFDEXT(T4)	;AND EXTENSION.
  1112	001272'	135340	772310		LDB	T2,[POINT 9,R.EXPR(P1),^D26]
  1113	001273'	542351	000001		HRRM	T2,UFDEXT(T4)	;NO FLAG BITS, PROTECTION IN BITS 27-35
  1114	001274'	550340	000000*		HRRZ	T2,THSDAT##	;Today's date
  1115	001275'	135400	772311		LDB	T3,[POINT 2,T2,23]
  1116	001276'	137400	772312		DPB	T3,[POINT 2,T2,6];High two bits
  1117	001277'	202351	000002		MOVEM	T2,UFDCDT(T4)	;Creation date
  1118	001300'	200340	000000*		MOVE	T2,TIME##	;Ticks since midnight
  1119	001301'	230340	000000*		IDIV	T2,JFYSEC##	;Convert to seconds
  1120	001302'	137340	772313		DPB	T2,[POINT 17,UFDCDT(T4),23]
  1121	001303'	200354	772176		MOVE	T2,R.SIZE(P1)
  1122	001304'	516351	000003		HRLZM	T2,UFDLIC(T4)	;ALLOCATED SIZE, NO LICENSE
  1123	001305'	270440	772314		ADD	T4,[XWD UFDSIZ,UFDSIZ]	;BUMP POINTER
  1124	001306'	202440	772237		MOVEM	T4,UFDSTP	;RESTORE POINTER
  1125	001307'	263040	000000		POPJ	P,
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 29
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1126				COMMENT #
  1127				@@SUBROUTINE RBNFIL
  1128				@@PURPOSE
  1129				SUBR TO SET UP A RIB IN CORE IN %TMP.P, GET A SPECIFIED
  1130				NO. OF PAGES ON A UNIT, STORE THEIR RETRIEVAL PNTRS
  1131				IN THE RIB(S), AND WRITE OUT THE RIB(S).
  1132				@@ENTRY
  1133				EXPECTS:
  1134					T1/ FILE NAME
  1135					T2/ EXT,,PROT
  1136					T3/ PPN
  1137					T4/ NUMBER OF PAGES TO ALLOCATE (NOT INCLUDING RIBS).
  1138					P4/ BITS TO SET IN STATUS WORD
  1139					U/ UNIT DB
  1140				@@ACCUM
  1141				DESTROYS
  1142				@@CALLS
  1143				RIBSET, OGETPG, OPAGOT, SATSRH, GETSAT, GETPRM, AND PTREXT.
  1144				@@EXIT
  1145				IF ERROR, NON-SKIP RETURNS, ELSE SKIP
  1146				RETURNS WITH PRIME RIB IN %TMP (ALREADY WRITTEN OUT)
  1147				AND PGSRIB INCREMENTED FOR EACH RIB (OTHER THAN THE PRIME RIB)
  1148				GENERATED.
  1149				@@ #
  1150
  1151				    ;SET UP THE PRIME RIB IN CORE.
  1152	001310'	202440	771411	RBNFIL:	MOVEM	T4,PAGNED	;SAVE NO. OF PAGES REQUESTED.
  1153	001311'	402000	772250		SETZM	PGSRIB		;PGSRIB HOLDS NO. OF SPARE RIBS GENERATED.
  1154	001312'	201440	746000		MOVEI	T4,%TMP		;SET UP THE
  1155	001313'	260040	772076		PUSHJ	P,RIBSET	;RIB AREA.
  1156	001314'	201440	000001		MOVEI	T4,1		;SET NO. OF PAGES
  1157	001315'	270440	771411		ADD	T4,PAGNED	;PLUS ONE
  1158	001316'	202440	746000*		MOVEM	T4,%TMP+RIBALP	;RIB.
  1159	001317'	260040	771511		PUSHJ	P,OGETPG	;GET A DISK PAGE FOR THE RIB.
  1160	001320'	263040	000000		  POPJ	P,
  1161	001321'	202340	746000*		MOVEM	T2,%TMP+RIBSLF	;STORE SELF RIB PNTR.
  1162	001322'	505300	000000*		HRLI	T1,-RBLVPR-1	;SET UP
  1163	001323'	541300	745777*		HRRI	T1,%TMP+RIBPFS-1
  1164	001324'	202300	772231		MOVEM	T1,TMPRBP	;PNTR TO RIB AREA.
  1165
  1166				    ;LOOK FOR DISK SPACE. SEARCH FOR THE SAT ON THIS UNIT WITH THE MOST SPACE.
  1167
  1168	001325'	403600	000015	RBNFL1:	SETZB	P1,P2		;CLR MAX FOUND AND INDEX.
  1169	001326'	550305	001046*		HRRZ	T1,UNISTT(U)	;T1/ INDEX INTO STT.
  1170	001327'	336346	001064*	RBNFL2:	SKIPN	T2,STTPTR(T1)	;AT E O TABLE?
  1171	001330'	254000	771343		 JRST	RBNFL4		;YES.
  1172	001331'	336406	001152*		SKIPN	T3,STTFPC(T1)	;NO. ANY FREE PAGES IN THIS SAT?
  1173	001332'	254000	771341		 JRST	RBNFL3		;NO.
  1174	001333'	311400	771411		CAML	T3,PAGNED	;YES. ENOUGH TO SATISFY REQUEST?
  1175	001334'	254000	771347		 JRST	RBNFL6		;YES.
  1176	001335'	317400	000015		CAMG	T3,P2		;NO. FOUND MORE THAN MAX SEEN ALREADY?
  1177	001336'	254000	771341		 JRST	RBNFL3		;NO.
  1178	001337'	200640	000010		MOVE	P2,T3		;YES, SAVE IT AS
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 29-2
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1179	001340'	200600	000006		MOVE	P1,T1		;MAX.
  1180	001341'	271300	000742*	RBNFL3:	ADDI	T1,STTLEN	;NO.  LOOK AT NEXT
  1181	001342'	254000	771327		JRST	RBNFL2		;SAT ENTRY IN STT.
  1182
  1183				      ;HERE AT END OF TABLE.
  1184	001343'	326640	771345	RBNFL4:	JUMPN	P2,.+2		;BETTER HAVE FOUND SOMETHING.
  1185	001344'	260040	772265		 MSGLIV	OGTPG
  1186	001345'	261040	000014		PUSH	P,P1		;SAVE SAT'S INDEX IN STT.
  1187	001346'	334354	001327*		SKIPA	T2,STTPTR(P1)	;T2/ SAT'S DISK POINTER.
  1188
  1189				    ;HERE TO READ IN THE SAT.
  1190	001347'	261040	000006	RBNFL6:	PUSH	P,T1		;SAVE SAT'S INDEX IN STT.
  1191	001350'	260040	771552		PUSHJ	P,GETSAT	;
  1192					  JRST	[POP  P,T1
  1193	001351'	254000	772315			 POPJ P,]
  1194	001352'	200640	771411		MOVE	P2,PAGNED	;SET UP ARGS
  1195	001353'	262040	000014		POP	P,P1		;FOR SATSRH. (CLRS BITS & RETURNS
  1196
  1197				    ;HERE TO GET SOME SPACE IN THE SAT.
  1198	001354'	260040	771412	RBNFL7:	PUSHJ	P,SATSRH	;T2/ DISK PNTR AND T1/ COUNT.).
  1199	001355'	263040	000000		  POPJ	P,
  1200	001356'	200700	000006		MOVE	P3,T1		;P3/ # PAGES GOTTEN.
  1201	001357'	200640	771411		MOVE	P2,PAGNED	;CALC NO.
  1202	001360'	274640	000016		SUB	P2,P3		;LEFT TO
  1203	001361'	202640	771411		MOVEM	P2,PAGNED	;GET.
  1204	001362'	260040	771716	RBNFL8:	PUSHJ	P,PTREXT 	;STORE THE
  1205	001363'	263040	000000		  POPJ	P,
  1206	001364'	363700	771366		SOJLE	P3,.+2		;DISK POINTERS
  1207	001365'	344340	771362		AOJA	T2,RBNFL8	;TO GOTTEN SPACE.
  1208
  1209	001366'	323640	771372		JUMPLE	P2,RBNFL9	;MORE PAGES TO GET?
  1210	001367'	333014	001331*		SKIPLE	STTFPC(P1)	;YES.  MORE ROOM IN THIS SAT?
  1211	001370'	254000	771354		 JRST	RBNFL7		;YES.
  1212	001371'	254000	771325		JRST	RBNFL1		;NO.
  1213
  1214				    ;HERE WHEN DONE STORING PNTRS (EXCEPT FOR EOF PNTR).
  1215	001372'	400340	000000	RBNFL9:	SETZ	T2,		;STORE
  1216	001373'	260040	771716		PUSHJ	P,PTREXT	;EOF PNTR.
  1217	001374'	263040	000000		  POPJ	P,
  1218	001375'	336000	772250		SKIPN	PGSRIB		;MORE THAN JUST A PRIME RIB?
  1219	001376'	254000	771403		 JRST	RBNF10		;NO.
  1220	001377'	260040	772054		PUSHJ	P,GETPRM	;YES, GET IT AND
  1221	001400'	263040	000000		  POPJ	P,
  1222	001401'	200600	772250		MOVE	P1,PGSRIB	;ADJUST
  1223	001402'	272600	746000*		ADDM	P1,%TMP+RIBALP	;RIBALP.
  1224	001403'	200340	746000*	RBNF10:	MOVE	T2,%TMP+RIBSLF	;
  1225	001404'	135440	001247*		LDB	T4,RBYPNO	;WRITE
  1226	001405'	201140	000000*		MOVEI	PG,%TMP.P	;IT
  1227	001406'	260040	001252*		PUSHJ	P,OPAGOT	;OUT.
  1228	001407'	263040	000000		  POPJ	P,
  1229	001410'	254000	001231*		JRST	CPOPJ1
  1230
  1231	001411'	000000	000000	PAGNED: Z		;TEMP STORAGE FOR RBNFIL.
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 30
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1232				COMMENT #
  1233				@@SUBROUTINE SATSRH
  1234				@@PURPOSE
  1235				SUBR TO GET SOME CONTIGUOUS FREE PAGES ON A SAT IN %STA, AND SET THEM IN USE.
  1236				SAT IS GUARANTEED TO HAVE SOME PAGES FREE ON ENTRY.
  1237				@@ENTRY
  1238				EXPECTS P1/ STT ENTRY ADDR OF SAT, P2/ MAX NO. OF PAGES
  1239				TO GET, U/ UNIT NO., AND F/ DDB.
  1240				@@ACCUM
  1241				DESTROYS T1 THRU T4 AND P2.
  1242				@@EXIT
  1243				IF ERROR, NON-SKIP RETURNS
  1244				 ELSE SKIP RETURNS WITH
  1245					T2/ DISK POINTER TO FIRST PAGE GOTTEN
  1246					T1/ NO. OF PAGES ACTUALLY GOTTEN
  1247					THE SAT HAS THE PAGES TAKEN MARKED IN USE.
  1248					STTFPC AND STTAOB ARE ALSO ADJUSTED.
  1249				@@ #
  1250
  1251	001412'	336314	000745*	SATSRH:	SKIPN	T1,STTAOB(P1)	;T1/ CURRENT AOBJN POINTER.
  1252	001413'	254000	771417		 JRST	SATSR2		;START AT START OF SAT IF NONE.
  1253	001414'	332346	000000		SKIPE	T2,(T1)		;ANY FREE BITS IN THIS WORD?
  1254	001415'	254000	771424		 JRST	SATSR3		;YES.
  1255	001416'	253300	771414		AOBJN	T1,.-2		;NO, TRY NEXT WORD.
  1256
  1257	001417'	200300	772317	SATSR2:	MOVE	T1,[XWD -400,%STA] ;T1/ AOBJN PNTR TO START OF SAT.
  1258	001420'	332346	000000		SKIPE	T2,(T1)		;ANY FREE BITS IN THIS WORD?
  1259	001421'	254000	771424		  JRST	SATSR3		;YES.
  1260	001422'	253300	771420		AOBJN	T1,.-2		;NO, TRY NEXT WORD.
  1261	001423'	260040	772265		MSGLIV	OGTPG
  1262
  1263				    ;HERE ON FOUND FIRST FREE PAGE.  BUILD THE DISK POINTER TO IT.
  1264
  1265	001424'	243340	771426	SATSR3:	JFFO	T2,.+2		;GET T3/ NO. OF BITS INTO WORD.
  1266	001425'	256000	770000		 STOPCD
  1267	001426'	551446	027000		HRRZI	T4,-%STA(T1)	;Page # =
  1268	001427'	221440	000044		IMULI	T4,^D36		;         (word in SAT * 36)
  1269	001430'	271450	000000		ADDI	T4,(T3)		;          + (bit in word)
  1270	001431'	550345	001326*		HRRZ	T2,UNISTT(U)	;          + (starting page in SAT)
  1271	001432'	274340	000014		SUB	T2,P1		;
  1272	001433'	213000	000007		MOVNS	T2		;Offset into STT for this unit
  1273	001434'	261040	000010		PUSH	P,T3		;
  1274	001435'	231340	001341*		IDIVI	T2,STTLEN	;
  1275	001436'	221340	022000		IMULI	T2,400*^D36	;Starting page in this SAT
  1276	001437'	262040	000010		POP	P,T3		;
  1277	001440'	271447	000000		ADDI	T4,(T2)		;
  1278	001441'	205340	001224*		MOVSI	T2,RBREAL	;Build a Ret Ptr in T2
  1279	001442'	137440	001404*		DPB	T4,RBYPNO	; (page)
  1280	001443'	135440	001157*		LDB	T4,UNYLUN	;
  1281	001444'	137440	001250*		DPB	T4,RBYUNI	; (unit)
  1282	001445'	261040	000007		PUSH	P,T2		;SAVE IT.
  1283
  1284				    ;NOW FIND ALL THE CONTIGUOUS PAGES WE CAN/WANT, AND MARK THEM TAKEN.
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 30-2
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1285
  1286	001446'	200346	000000		MOVE	T2,(T1)		;T2/ SAT WORD AGAIN.
  1287	001447'	515440	400000		HRLZI	T4,400000	;BUILD THE
  1288	001450'	213000	000010		MOVNS	T3		;MASK IN
  1289	001451'	242450	000000		LSH	T4,(T3)		;T4.
  1290	001452'	202314	001412*		MOVEM	T1,STTAOB(P1)	;SAVE THE AOBJN POINTER.
  1291	001453'	400300	000000		SETZ	T1,		;T1/ # OF FREE PAGES.
  1292	001454'	271400	000044		ADDI	T3,^D36		;T3/ MAX NO.
  1293	001455'	313400	000015		CAMLE	T3,P2		;OF BITS TO LOOK
  1294	001456'	200400	000015		 MOVE	T3,P2		;AT IN THIS WORD.
  1295	001457'	636340	000011	SATSR5:	TDZN	T2,T4		;NEXT PAGE IS FREE?
  1296	001460'	254000	771502		 JRST	SATSR8		;NO, DONE.
  1297	001461'	271300	000001		ADDI	T1,1		;YES, COUNT IT.
  1298	001462'	242440	777777		LSH	T4,-1		;ADJUST THE MASK.
  1299	001463'	367400	771457		SOJG	T3,SATSR5	;CONTINUE IN THIS WORD.
  1300	001464'	311300	000015		CAML	T1,P2		;NEED MORE?
  1301	001465'	254000	771502		 JRST	SATSR8		;NO.
  1302	001466'	200414	001452*		MOVE	T3,STTAOB(P1)	;YES, TRY TO GET
  1303	001467'	252400	771502		AOBJP	T3,SATSR8	;NEXT WORD.  IS THERE ONE?
  1304	001470'	202350	777777		MOVEM	T2,-1(T3)	;YES.
  1305	001471'	336350	000000		SKIPN	T2,(T3)		; ANY FREE PAGES IN IT?
  1306	001472'	254000	771504		 JRST	SATSR9		;NO.  DONE.
  1307	001473'	202414	001466*		MOVEM	T3,STTAOB(P1)	;YES.  SAVE AOBJN PNTR.
  1308	001474'	515440	400000		HRLZI	T4,400000	;SET UP MASK FOR NEW WORD.
  1309	001475'	200400	000015		MOVE	T3,P2		;SET UP T3 TO
  1310	001476'	274400	000006		SUB	T3,T1		;MAX. NO. OF
  1311	001477'	303400	000044		CAILE	T3,^D36		;BITS TO LOOK AT
  1312	001500'	201400	000044		 MOVEI	T3,^D36		;IN THIS WORD.
  1313	001501'	254000	771457		JRST	SATSR5		;GO LOOK AT THIS WORD.
  1314
  1315				    ;HERE ON DONE.
  1316
  1317	001502'	200414	001473*	SATSR8:	MOVE	T3,STTAOB(P1)	;
  1318	001503'	202350	000000		MOVEM	T2,(T3)		;
  1319	001504'	200414	001367*	SATSR9:	MOVE	T3,STTFPC(P1)	;ADJUST THE
  1320	001505'	274400	000006		SUB	T3,T1		;FREE PAGE
  1321	001506'	202414	001504*		MOVEM	T3,STTFPC(P1)	;COUNT.
  1322	001507'	262040	000007		POP	P,T2		;RESTORE T2/ DISK POINTER.
  1323	001510'	254000	001410*		JRST	CPOPJ1
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 31
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1324				COMMENT #
  1325				@@SUBROUTINE OGETPG
  1326				@@PURPOSE
  1327				SUBR TO GET ONE PAGE ON THE DISK.
  1328				@@ENTRY
  1329				EXPECTS F/ DDB AND U/ UNIT DB.
  1330				@@ACCUM
  1331				DESTROYS T1 THRU T4 AND PG.
  1332				@@CALLS
  1333				SATSRH AND GETSAT.
  1334				@@EXIT
  1335				NON-SKIP RETURNS IF NO PAGE AVAILABLE,
  1336				ELSE SKIP RETURNS WITH T2/ DISK PNTR TO THE PAGE.
  1337				@@ #
  1338
  1339	001511'	261040	000014	OGETPG:	PUSH	P,P1		;SAVE P1 AND
  1340	001512'	261040	000015		PUSH	P,P2		;P2.
  1341	001513'	201640	000001		MOVEI	P2,1		;TELL SATSRH WE WANT ONE PAGE.
  1342	001514'	550605	001431*		HRRZ	P1,UNISTT(U)	;P1/ STT ENTRY ADDR.
  1343	001515'	332354	001346*	OGETP2:	SKIPE	T2,STTPTR(P1)	;AT END OF STT?
  1344	001516'	254000	771522		 JRST	OGETP3
  1345	001517'	262040	000015		POP	P,P2
  1346	001520'	262040	000014		POP	P,P1
  1347	001521'	260040	772265		MSGLIV	OGTPG
  1348	001522'	332014	001506*	OGETP3:	SKIPE	STTFPC(P1)	;NO.  ANY FREE PAGES IN THIS SAT?
  1349	001523'	254000	771526		 JRST	OGETP4		;YES.
  1350	001524'	271600	001435*		ADDI	P1,STTLEN	;NO, CONTINUE.
  1351	001525'	254000	771515		JRST	OGETP2		;
  1352
  1353	001526'	260040	771552	OGETP4:	PUSHJ	P,GETSAT	;Read in SAT
  1354	001527'	254000	771535		  JRST	OGETP5
  1355	001530'	260040	771412		PUSHJ	P,SATSRH	;GET T2/ DISK PNTR TO 1ST FREE PAGE.
  1356	001531'	254000	771535		  JRST	OGETP5
  1357	001532'	262040	000015		POP	P,P2		;RESTORE P2 AND
  1358	001533'	262040	000014		POP	P,P1		;P1.
  1359	001534'	254000	001510*		JRST	CPOPJ1
  1360
  1361	001535'	262040	000015	OGETP5:	POP	P,P2
  1362	001536'	262040	000014		POP	P,P1
  1363	001537'	263040	000000		POPJ	P,
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 32
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1364				COMMENT #
  1365				@@SUBROUTINE CNDSWT
  1366				@@PURPOSE
  1367				SUBR TO CONDITIONALLY WRITE OUT A SAT IN CORE.
  1368				@@ACCUM
  1369				DESTROYS U, PG,
  1370				@@EXIT
  1371				SKIP RETURNS UNLESS ERROR, IN WHICH CASE, NON-SKIP RETURNS.
  1372				@@ #
  1373
  1374	001540'	336340	772246	CNDSWT:	SKIPN	T2,SATDSK	;IS THERE A SAT IN %STA?
  1375	001541'	254000	001534*		 JRST	CPOPJ1		;NO, NO NEED TO DO ANYTHING.
  1376	001542'	135440	001442*		LDB	T4,RBYPNO	;YES,
  1377	001543'	135240	001444*		LDB	U,RBYUNI	; WRITE
  1378	001544'	200245	001251*		MOVE	U,UNTTBL(U)	; IT
  1379	001545'	201140	001063*		MOVEI	PG,%STA.P	; OUT.
  1380	001546'	260040	001406*		PUSHJ	P,OPAGOT	;
  1381	001547'	260040	772320		 MSGLIV	IOFAL
  1382	001550'	402000	772246		SETZM	SATDSK		;MARK NO SAT IN CORE.
  1383	001551'	254000	001541*		JRST	CPOPJ1		;SUCCESS RETURN.
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 33
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1384				COMMENT #
  1385				@@SUBROUTINE GETSAT
  1386				@@PURPOSE
  1387				SUBR TO GET A SAT INTO CORE, POSSIBLY WRITING OUT A SAT FIRST.
  1388				@@ENTRY
  1389				EXPECTS T2/ DISK ADDRESS OF DESIRED SAT, U/ UNIT DB, AND F/ DDB.
  1390				@@ACCUM
  1391				DESTROYS
  1392				@@EXIT
  1393				SKIP RETURNS UNLESS ERROR, IN WHICH CASE, NON-SKIP RETURNS.
  1394				@@ #
  1395
  1396	001552'	316340	772246	GETSAT:	CAMN	T2,SATDSK	;ALREADY HAVE THIS SAT IN CORE?
  1397	001553'	254000	001551*		 JRST	CPOPJ1		;YES.  JUST TAKE SUCCESS RETURN.
  1398	001554'	201140	001545*		MOVEI	PG,%STA.P	;NO, IS THERE
  1399	001555'	250340	772246		EXCH	T2,SATDSK	;A SAT
  1400	001556'	322340	771566		JUMPE	T2,GTSAT6	;IN CORE?
  1401	001557'	135440	001542*		LDB	T4,RBYPNO	;YES.  WRITE IT
  1402	001560'	261040	000005		PUSH	P,U		;
  1403	001561'	135240	001543*		LDB	U,RBYUNI	;
  1404	001562'	200245	001544*		MOVE	U,UNTTBL(U)	;
  1405	001563'	260040	001546*		PUSHJ	P,OPAGOT	;OUT.
  1406					  PUSHJ	P,[POP P,T2	;
  1407						EXCH T2,(P)	;
  1408	001564'	260040	772325			MSGLIV 	IOFAL]
  1409	001565'	262040	000005		POP	P,U		;
  1410	001566'	200340	772246	GTSAT6:	MOVE	T2,SATDSK	;HERE TO READ OUR SAT
  1411	001567'	135440	001557*		LDB	T4,RBYPNO	;INTO CORE.
  1412	001570'	260040	000555*		PUSHJ	P,OPAGIN	;
  1413	001571'	260040	772320		 MSGLIV	IOFAL
  1414	001572'	254000	001553*		JRST	CPOPJ1		;
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 34
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1415				COMMENT #
  1416				@@SUBROUTINE SATRBS/HOMRBS
  1417				@@PURPOSE
  1418				VARIOUS SUBRS TO STORE A RETRIEVAL POINTER AND INC RIBALP.
  1419				@@ENTRY
  1420				EXPECTS T2/ RETRIEVAL POINTER TO STORE AND XXXRBP TO BE AN AOBJN POINTER.
  1421				@@ACCUM
  1422				DESTROYS T1.
  1423				@@EXIT
  1424				STOPCDS IF AOBJN POINTER RUNS OUT.
  1425				ELSE RETURNS WITH NEW AOBJN POINTER STORED AND RIBALC ADJUSTED.
  1426				@@ #
  1427
  1428	001573'	200300	772231	TMPRBS:	MOVE	T1,TMPRBP
  1429	001574'	253300	771576		AOBJN	T1,TMPRS1
  1430	001575'	260040	772334		 MSGSFE	RBNOUT
  1431	001576'	202300	772231	TMPRS1:	MOVEM	T1,TMPRBP
  1432	001577'	260040	000000*		PUSHJ	P,SAVT		;SAVE T2,T3,T4
  1433	001600'	201400	746000		MOVEI	T3,%TMP
  1434	001601'	254000	771617		JRST	HOMRS2
  1435
  1436	001602'	200300	772227	SATRBS:	MOVE	T1,SATRBP
  1437	001603'	253300	771605		AOBJN	T1,SATRS1
  1438	001604'	260040	772334		 MSGSFE	RBNOUT
  1439	001605'	202300	772227	SATRS1:	MOVEM	T1,SATRBP
  1440	001606'	260040	001577*		PUSHJ	P,SAVT		;SAVE T2,T3,T4
  1441	001607'	201400	750000		MOVEI	T3,%STR
  1442	001610'	254000	771617		JRST	HOMRS2
  1443
  1444	001611'	200300	772226	HOMRBS:	MOVE	T1,HOMRBP
  1445	001612'	253300	771614		AOBJN	T1,HOMRS1
  1446	001613'	260040	772334		 MSGSFE	RBNOUT
  1447	001614'	202300	772226	HOMRS1:	MOVEM	T1,HOMRBP
  1448	001615'	260040	001606*		PUSHJ	P,SAVT
  1449	001616'	201400	752000		MOVEI	T3,%HMR
  1450	001617'	202346	000000	HOMRS2:	MOVEM	T2,(T1)
  1451	001620'	350010	000000*		AOS	RIBALP(T3)	;COUNT NO. OF PAGES IN THIS FILE.
  1452	001621'	263040	000000		POPJ	P,
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 35
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1453				COMMENT #
  1454				@@SUBROUTINE CLUAOB/CLSAOB
  1455				@@PURPOSE
  1456				SUBRS TO CLEAR OUT THE STTAOB ENTRIES FOR A UNIT (CLUAOB)
  1457				OR FOR ALL UNITS IN A STR (CLSAOB).
  1458				@@ENTRY
  1459				CLUAOB EXPECTS UNIT DB ADDR IN REFUNI.  CLSAOB EXPECTS
  1460				DB ADDB OF FIRST UNIT ON THE STR IN FTSUNI.
  1461				@@ACCUM
  1462				DESTROYS U AND T1.
  1463				@@ #
  1464
  1465	001622'	200240	772244	CLUAOB:	MOVE	U,REFUNI
  1466	001623'	550305	001514*	CLUAB1:	HRRZ	T1,UNISTT(U)	;
  1467	001624'	336006	001515*	CLUAB2:	SKIPN	STTPTR(T1)	;
  1468	001625'	263040	000000		  POPJ	P,
  1469	001626'	402006	001502*		SETZM	STTAOB(T1)	;Zero the AOBJN pointer
  1470	001627'	271300	001524*		ADDI	T1,STTLEN
  1471	001630'	254000	771624		JRST	CLUAB2		;
  1472
  1473	001631'	200240	772243	CLSAOB:	MOVE	U,FSTUNI	;First unit
  1474	001632'	260040	771623		PUSHJ	P,CLUAB1	;
  1475	001633'	554245	000700*		HLRZ	U,UNISTR(U)	;Next unit
  1476	001634'	326240	771632		JUMPN	U,.-2		;
  1477	001635'	263040	000000		POPJ	P,
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 36
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1478				COMMENT #
  1479				@@SUBROUTINE TMPIN/TMPOUT
  1480				@@PURPOSE
  1481				LITTLE SUBRS TO SET UP ARGS AND CALL OPAGIN/OT FOR IO TO/FROM %TMP.
  1482				@@ENTRY
  1483				EXPECT T2/ DISK POINTER OF PAGE TO BE TRANSFERRED.
  1484				@@CALLS
  1485				OPAGIN AND OPAGOT.
  1486				@@ACCUM
  1487				DESTROYS
  1488				@@EXIT
  1489				SKIP RETURN ON SUCCESS.
  1490				@@ #
  1491
  1492	001636'	334400	772343	TMPIN:	SKIPA	T3,[OPAGIN]	;Input
  1493	001637'	201400	001563*	TMPOUT:	 MOVEI	T3,OPAGOT	;Output
  1494	001640'	135440	001567*		LDB	T4,RBYPNO	;GET PAGE NO. FROM T2.
  1495	001641'	135240	001561*		LDB	U,RBYUNI	;GET UNIT DB
  1496	001642'	200245	001562*		MOVE	U,UNTTBL(U)	;ADDR FROM T2 AND UNTTBL.
  1497	001643'	201140	001405*		MOVEI	PG,%TMP.P	;IO TO/FROM %TMP.
  1498	001644'	260050	000000		PUSHJ	P,(T3)		;READ OR WRITE THE PAGE.
  1499	001645'	260040	772320		 MSGLIV	IOFAL
  1500	001646'	254000	001572*		JRST	CPOPJ1		;WON.
  1501
  1502				;Routines to do what TSTSUP.SAV does - read/patch/write disk pages.
  1503
  1504	001647'	202040	772251	TSTSUP::MOVEM	P,SAVEP
  1505					MOVEI	T1,[ASCIZ /TSTSUP routines.
  1506	001650'	201300	772344	Set page number in PAGE, then use PREAD$G to read, and PWRITE$G to write./]
  1507	001651'	260040	771713		PUSHJ	P,CONOUT
  1508					MOVEI	T1,[ASCIZ /
  1509				Data is in %TMP<%TMP+777>0$N.   Use FILES$G to get back to "FILES*".
  1510	001652'	201300	772367	/]
  1511	001653'	260040	771713		PUSHJ	P,CONOUT
  1512	001654'	201340	000001		MOVEI	T2,LPNHOM	;Reset to first HOM page on unit 0
  1513	001655'	202340	772252		MOVEM	T2,PAGE
  1514	001656'	260040	771636		PUSHJ	P,TMPIN		;Read it
  1515	001657'	254000	771711		  JRST	PREAD4
  1516				;*;	JRST	PREAD1		;Show what's been read it
  1517	001660'	201000	772406		MOVEI	0,[ASCIZ \C REFSTR: %TMP6T/ PAGE[\]
  1518	001661'	254000	000001*		JRST	DDT+1		;Tell DDT to unlock the symbol table
  1519
  1520
  1521	001662'	336040	772251	FILES::	SKIPN	P,SAVEP		;Reset PDL
  1522	001663'	254000	000000*		 JRST	SYSDSP##	;If no stack, do 140$G
  1523	001664'	263040	000000		POPJ	P,		;Return to "FILES*" in ONCDSK
  1524
  1525					PURGE	D		;Get rid of D=17 (for dump mode)
  1526			746000		D=%TMP			;Local symbol (only if REFSTR$:)
  1527					EXTERN	DDT
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 37
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1528				;Write data from %TMP to disk address in PAGE
  1529
  1530	001665'	260040	771675	PWRITE::PUSHJ	P,PREAD0	;TSTSUP routine to write a page
  1531	001666'	260040	771637		PUSHJ	P,TMPOUT
  1532	001667'	254000	771711		  JRST	PREAD4		;Error
  1533					PFALL	PREAD		;Verify by reading it back in again
  1534
  1535				;Read data from disk address in PAGE to %TMP
  1536
  1537	001670'	260040	771675	PREAD::	PUSHJ	P,PREAD0	;TSTSUP routine to read a page
  1538	001671'	260040	771636		PUSHJ	P,TMPIN
  1539	001672'	254000	771711		  JRST	PREAD4		;Error
  1540	771673			PREAD1:				;Type out the contents of PAGE
  1541				;*;	MOVEI	T1,[ASCIZ \PAGE/  \]
  1542				;*;	PUSHJ	P,CONMES
  1543				;*;	MOVE	T1,PAGE
  1544				;*;	PUSHJ	P,PRT22A##	;Print 22-bit address
  1545				;*;	PUSHJ	P,CRLFOP
  1546				;*;	JRST	DDT
  1547	001673'	201000	772414		MOVEI	0,[ASCIZ .PAGE/.]
  1548	001674'	254000	000001*		JRST	DDT+1		;Let EDDT type out the data
  1549
  1550	001675'	200340	772252	PREAD0:	MOVE	T2,PAGE		;Set up T2 for TMPIN/TMPOUT
  1551	001676'	135240	001641*		LDB	U,RBYUNI	;Get unit # from bits 9-16 of T2
  1552	001677'	307240	000000*		CAIG	U,UNTLEN##	;Don't exceed size of UNTTBL
  1553	001700'	336245	001642*		SKIPN	U,UNTTBL(U)	;Check if UNTTBL has been set up
  1554	001701'	254000	771705		 JRST	PREAD2		;Out of range or did not go thru FILES
  1555	001702'	135440	001640*		LDB	T4,RBYPNO	;Get page # from T2
  1556	001703'	315445	001110*		CAMGE	T4,UNIPPU(U)	;Within range of page addresses?
  1557	001704'	263040	000000		 POPJ	P,		;OK
  1558	001705'	201300	772416	PREAD2:	MOVEI	T1,[ASCIZ \? PAGE out of range or UNTTBL not set up.  \]
  1559	001706'	260040	000000*		PUSHJ	P,CONMES
  1560	001707'	262041	000000		POP	P,(P)		;Dump return address
  1561	001710'	254000	771673		JRST	PREAD1
  1562
  1563	001711'	201300	772427	PREAD4:	MOVEI	T1,[ASCIZ \?I/O error on \]
  1564	001712'	254000	771673		JRST	PREAD1
  1565
  1566	001713'	260040	001706*	CONOUT:	PUSHJ	P,CONMES	;String in T1 + CRLF + output buffer
  1567	001714'	260040	000000*	CRLFOP:	PUSHJ	P,CRLF##
  1568	001715'	324740	000000*		PJRST	OPOUT
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 38
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1569				COMMENT #
  1570				@@SUBROUTINE PTREXT
  1571				@@PURPOSE
  1572				SUBR TO STORE A RETRIEVAL POINTER IN %TMP ACCORDING TO TMPRBP,
  1573				TAKING INTO ACCOUNT AN EXTENDED RIB STRUCTURE.
  1574				(THIS REALLY DOESN'T NEED THREE LEVELS; ALSO PERHAPS THE
  1575				OGETPG CALLS SHOULD LOOK AT MORE THAN ONE UNIT.)
  1576				@@ENTRY
  1577				EXPECTS TMPRBP AND THE RIB IN %TMP TO BE SET UP,
  1578				T2/ THE RETRIEVAL POINTER TO BE STORED, AND F/ DDB.
  1579				@@CALLS
  1580				RIBEX1, RIBEX2, RIBEX3, RIBEX4, OGETPG, TMPOUT, TMPIN, CORZER AND MOROOM.
  1581				@@ACCUM
  1582				DESTROYS T1, T3, T4, AND PG.
  1583				PRESERVES U.
  1584				@@EXIT
  1585				IF ERROR, NON-SKIP RETURNS, ELSE SKIP RETURNS.
  1586				ON EXIT, THE RIB IN %TMP MAY NOT BE THE RIB THAT WAS THERE
  1587				ON ENTRY.  ON SUCCESSFUL EXIT, TMPRBP WILL BE SET UP PROPERLY
  1588				AND PGSRIB IS INCREMENTED FOR EACH ADDITIONAL RIB GENERATED.
  1589				@@ #
  1590
  1591	001716'	200300	772231	PTREXT:	MOVE	T1,TMPRBP	;GET THE AOBJN PNTR TO THE
  1592	001717'	253300	771726		AOBJN	T1,PTROT2	;RETRIEVAL PNTR STORAGE AREA.
  1593	001720'	261040	000005		PUSH	P,U		;PRESERVE U.
  1594	001721'	254000	771731		JRST	PTREX1		;OUT OF ROOM.
  1595
  1596	001722'	262040	000015	PTROU0:	POP	P,P2		;
  1597	001723'	262040	000014		POP	P,P1
  1598	001724'	262040	000007	PTROUT:	POP	P,T2		;RESTORE THE RETRIEVAL POINTER.
  1599	001725'	262040	000005		POP	P,U		;RESTORE U.
  1600	001726'	202300	772231	PTROT2:	MOVEM	T1,TMPRBP	;STORE THE AOBJN
  1601	001727'	202346	000000		MOVEM	T2,(T1)		;PNTR & RETRIEVAL PNTR.
  1602	001730'	254000	001646*		JRST	CPOPJ1
  1603
  1604				    ;HERE WHEN WE MUST GET ANOTHER RIB.
  1605	001731'	261040	000007	PTREX1:	PUSH	P,T2		;SAVE RET PNTR WE WANT TO STORE.
  1606	001732'	332340	746000*		SKIPE	T2,%TMP+RIBSLF	;GET A DISK PAGE TO WRITE US
  1607	001733'	254000	771737		  JRST	PTREX2		;OUT TO, UNLESS
  1608	001734'	260040	771511		PUSHJ	P,OGETPG	;WE HAVE
  1609	001735'	254000	772042		  JRST	PTRFAL		;ONE
  1610	001736'	202340	746000*		MOVEM	T2,%TMP+RIBSLF	;ALREADY.
  1611	001737'	200300	746000*	PTREX2:	MOVE	T1,%TMP+RIBSZS	;IF NOT AT LOWEST LEVEL
  1612	001740'	367300	771765		SOJG	T1,PTREX3	;AND EO RIB WITH REAL PNTR,
  1613	001741'	336000	746000*		SKIPN	%TMP+RIBRIB	;OR IF ONLY ONE RIB, WE
  1614	001742'	254000	771765		  JRST	PTREX3		;HAVE TO EXPAND.
  1615
  1616				    ;HERE WHEN WE ARE AT LOWEST LEVEL AND THERE IS A HIGHER RIB.
  1617				    ;WE MAY OR MAY NOT HAVE TO EXPAND.
  1618
  1619	001743'	261040	746000*		PUSH	P,%TMP+RIBRPS	;SAVE OUR POSITION FOR MOROOM.
  1620	001744'	260040	771637		PUSHJ	P,TMPOUT	;(WE HAVE ALREADY SET UP T2), SO
  1621	001745'	254000	772041		  JRST	PTRFL1		;WRITE US OUT.
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 38-2
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1622	001746'	200340	746000*		MOVE	T2,%TMP+RIBRIB	;READ IN THE
  1623	001747'	260040	771636		PUSHJ	P,TMPIN		;HIGHER RIB.
  1624	001750'	254000	772041		  JRST	PTRFL1
  1625	001751'	262040	000006		POP	P,T1		;RESTORE OUR POINTER.
  1626	001752'	260040	772045		PUSHJ	P,MOROOM	;ROOM FOR ANY MORE PNTRS IN IT?
  1627	001753'	254000	771724		  JRST	PTROUT		;YES.
  1628	001754'	336340	746000*		SKIPN	T2,%TMP+RIBRIB	;NO. IF THIS IS THE HIGHEST,
  1629	001755'	254000	771765		  JRST	PTREX3		;GO EXPAND.
  1630	001756'	261040	746000*		PUSH	P,%TMP+RIBRPS	;SAVE OUR POSITION FOR MOROOM.
  1631	001757'	260040	771636		PUSHJ	P,TMPIN		;READ IN THE HIGHER
  1632	001760'	254000	772041		  JRST	PTRFL1		;RIB.
  1633	001761'	262040	000006		POP	P,T1		;RESTORE OUR POSITION.
  1634	001762'	260040	772045		PUSHJ	P,MOROOM	;ROOM FOR ANY MORE PNTRS?
  1635	001763'	254000	771724		  JRST	PTROUT		;YES.
  1636	001764'	260040	772433		MSGSFE	RBEOUT		;EXCEEDED 3 LEVELS (IMPOSSIBLE!)
  1637
  1638				    ;HERE TO EXPAND THE RIB STRUCTURE.
  1639
  1640	001765'	201300	745000	PTREX3:	MOVEI	T1,%T2P		;CLEAR OUT A SPARE RIB
  1641	001766'	260040	001233*		PUSHJ	P,CORZER	;IN %T2P.
  1642	001767'	350000	772250		AOS	PGSRIB		;COUNT IT.
  1643	001770'	260040	771511		PUSHJ	P,OGETPG	;GET A PAGE
  1644	001771'	254000	772042		  JRST	PTRFAL		;FOR
  1645	001772'	202340	745000*		MOVEM	T2,%T2P+RIBSLF	;IT.
  1646	001773'	201300	000000*		MOVEI	T1,CODRIB	;SET ITS
  1647	001774'	202300	745000*		MOVEM	T1,%T2P+RIBCOD	;RIBCOD.
  1648	001775'	261040	000014		PUSH	P,P1		;SET UP THE
  1649	001776'	261040	000015		PUSH	P,P2		;ARGS
  1650	001777'	201600	746000		MOVEI	P1,%TMP		;FOR
  1651	002000'	201640	745000		MOVEI	P2,%T2P		;THE RIBEX? SUBRS.
  1652	002001'	200300	746000*		MOVE	T1,%TMP+RIBLST	;JUMP UNLESS LAST PNTR IN OUR
  1653	002002'	325300	772006		JUMPGE	T1,PTREX4	;SOURCE RIB IS A SPARE RIB PNTR.
  1654
  1655				    ;HERE TO EXPAND FROM TWO LEVELS TO THREE.
  1656
  1657	002003'	260040	000000*		PUSHJ	P,RIBEX1	;SET UP INFO IN BOTH RIBS.
  1658	002004'	201440	000000*		MOVEI	T4,RIBSFS+RBLVPR-1 ;
  1659	002005'	254000	772024		JRST	PTRE45		;
  1660
  1661
  1662				    ;HERE ON ALL RIB EXPANSION EXCEPT FROM TWO LEVELS TO THREE.
  1663
  1664	002006'	260040	000000*	PTREX4:	PUSHJ	P,RIBEX2	;SET UP INFO IN BOTH RIBS.
  1665	002007'	254000	772024		  JRST	PTRE45		;NEED NO INTERMED RIB.
  1666	002010'	261040	000011		PUSH	P,T4		;NEED INTERMED RIB.  SAVE RPS.
  1667	002011'	260040	771511		PUSHJ	P,OGETPG	;
  1668	002012'	254000	772035		  JRST	PTRFL2
  1669	002013'	350000	772250		AOS	PGSRIB		;COUNT THE INTERMEDIATE RIB.
  1670	002014'	260040	000000*		PUSHJ	P,RIBEX3	;LINK IT IN.
  1671	002015'	200340	746000*		MOVE	T2,%TMP+RIBSLF	;
  1672	002016'	260040	771637		PUSHJ	P,TMPOUT	;WRITE OUT THE
  1673	002017'	254000	772035		  JRST	PTRFL2		;HIGHEST RIB.
  1674	002020'	201300	746000		MOVEI	T1,%TMP		;CLEAR SPACE FOR THE
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 38-3
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1675	002021'	260040	001766*		PUSHJ	P,CORZER	;INTERMEDIATE RIB.
  1676	002022'	265440	000000*		JSP	T4,RIBEX4	;SET UP MORE STUFF.
  1677	002023'	262040	000011		POP	P,T4		;RESTORE RPS.
  1678
  1679
  1680	002024'	515611	000000*	PTRE45:	HRLZI	P1,-RIBLST(T4)	;SET UP THE AOBJN PNTR
  1681	002025'	541611	746001		HRRI	P1,%TMP+1(T4)	;FOR PTROU0.
  1682	002026'	200340	746000*		MOVE	T2,%TMP+RIBSLF	;WRITE OUT
  1683	002027'	260040	771637		PUSHJ	P,TMPOUT	;A RIB.
  1684	002030'	254000	772036		  JRST	PTRFL0
  1685	002031'	200300	772442		MOVE	T1,[XWD %T2P,%TMP] ;COPY THE NEW RIB TO
  1686	002032'	251300	746777		BLT	T1,%TMP+777	;THE CURRENT RIB AREA.
  1687	002033'	200300	000014		MOVE	T1,P1		;GET AOBJN PNTR FOR PTROUT.
  1688	002034'	254000	771722		JRST	PTROU0		;
  1689
  1690
  1691	002035'	262040	000006	PTRFL2:	POP	P,T1		;VARIOUS
  1692	002036'	262040	000015	PTRFL0:	POP	P,P2
  1693	002037'	262040	000014		POP	P,P1		;ERROR
  1694	002040'	254000	772042		JRST	PTRFAL
  1695
  1696	002041'	262040	000006	PTRFL1:	POP	P,T1		;EXITS.
  1697	002042'	262040	000007	PTRFAL:	POP	P,T2
  1698	002043'	262040	000005		POP	P,U
  1699	002044'	263040	000000		POPJ	P,
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 39
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1700				COMMENT #
  1701				@@SUBROUTINE MOROOM
  1702				@@PURPOSE
  1703				LITTLE SUBR TO SEE IF THERE IS ANY MORE ROOM IN A RIB IN
  1704				%TMP TO STORE POINTERS.
  1705				@@ENTRY
  1706				EXPECTS T1/RIBRPS FROM LOWER RIB.
  1707				@@ACCUM
  1708				DESTROYS T1 AND T2.
  1709				@@EXIT
  1710				SKIP RETURNS IF NO MORE ROOM.  NON-SKIP RETURNS IF THERE IS
  1711				MORE ROOM, WITH T1/ AOBJN POINTER TO ROOM.
  1712				@@ #
  1713
  1714	002045'	271300	746001	MOROOM:	ADDI	T1,%TMP+1	;GET ADDR OF NEXT POINTER.
  1715	002046'	303300	746000*		CAILE	T1,%TMP+RIBLST	;PAST E O RIB?
  1716	002047'	254000	001730*		 JRST	CPOPJ1		;YES, RETURN.
  1717	002050'	201346	000000		MOVEI	T2,(T1)		;NO.  MAKE THE USED AOBJN
  1718	002051'	275340	746000*		SUBI	T2,%TMP+RIBLST	;PNTR IN T1,
  1719	002052'	505307	777777		HRLI	T1,-1(T2)	;AND TAKE THE
  1720	002053'	263040	000000		POPJ	P,		;SUCCESSFUL RETURN.
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 40
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1721				COMMENT #
  1722				@@SUBROUTINE GETPRM
  1723				@@PURPOSE
  1724				SUBR TO WRITE OUT THE RIB IN CORE IN %TMP AND THEN GET
  1725				ITS PRIME RIB INTO %TMP.
  1726				@@CALLS
  1727				TMPIN AND TMPOUT.
  1728				@@ACCUM
  1729				DESTROYS
  1730				@@EXIT
  1731				SKIP RETURNS UNLESS ERROR, IN WHICH CASE NON-SKIP RETURNS.
  1732				@@ #
  1733
  1734	002054'	336000	746000*	GETPRM:	SKIPN	%TMP+RIBRIB	;Check if there is a pointer to upper level
  1735	002055'	254000	002047*		 JRST	CPOPJ1		;Already at prime RIB
  1736	002056'	201600	000002		MOVEI	P1,2		;CHECK FOR 2 more levels
  1737	002057'	261040	746000*	GETPR4:	PUSH	P,%TMP+RIBRIB	;SAVE ADDR OF HIGHER RIB.
  1738	002060'	332340	746000*		SKIPE	T2,%TMP+RIBSLF	;IF NECESSARY, GET
  1739	002061'	254000	772064		  JRST	GETPR5		;
  1740	002062'	260040	771511		PUSHJ	P,OGETPG	;A PAGE FOR THE
  1741					  JRST	[POP  P,T1
  1742	002063'	254000	772315			 POPJ P,]
  1743	002064'	202340	746000*	GETPR5:	MOVEM	T2,%TMP+RIBSLF	;CURRENT RIB.
  1744	002065'	260040	771637		PUSHJ	P,TMPOUT	;
  1745					  JRST	[POP  P,T1
  1746	002066'	254000	772315			 POPJ P,]
  1747	002067'	262040	000007		POP	P,T2		;READ IN THE
  1748	002070'	260040	771636		PUSHJ	P,TMPIN		;HIGHER RIB.
  1749	002071'	263040	000000		  POPJ	P,
  1750	002072'	336000	746000*		SKIPN	%TMP+RIBRIB	;DONE?
  1751	002073'	254000	002055*		 JRST	CPOPJ1		;YES
  1752	002074'	367600	772057		SOJG	P1,GETPR4	;NO, DON'T DO MORE THAN 3 LEVELS.
  1753	002075'	260040	772443		MSGSFE	RIBFAL
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 41
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1754				COMMENT #
  1755				@@SUBROUTINE RIBSET
  1756				@@PURPOSE
  1757				SUBR TO SET UP PRIME RIB INFORMATION IN A SPECIFIED AREA IN CORE.
  1758				@@ENTRY
  1759				EXPECTS:
  1760					T1=NAME OF FILE
  1761					T2=EXT,,PROTECTION
  1762					T3=PPN
  1763					T4=ADDR OF CORE AREA TO BE SET UP.
  1764					P4=BITS TO SET IN STATUS WORD
  1765				@@ACCUM
  1766				DESTROYS T1 AND T2.
  1767				@@CALLS
  1768				CORZER.
  1769				@@ #
  1770
  1771	002076'	261040	000006	RIBSET:	PUSH	P,T1		;SAVE T1 AND
  1772	002077'	261040	000007		PUSH	P,T2		;T2 FROM CORZER.
  1773	002100'	200300	000011		MOVE	T1,T4		;ARG FOR CORZER.
  1774	002101'	260040	002021*		PUSHJ	P,CORZER	;CLEAR OUT THE RIB AREA.
  1775	002102'	262040	000007		POP	P,T2		;RESTORE T2 AND
  1776	002103'	262040	000006		POP	P,T1		;T1.
  1777	002104'	202311	000000*		MOVEM	T1,RIBNAM(T4)	;File name
  1778	002105'	512351	000000*		HLLZM	T2,RIBEXT(T4)	;Extension
  1779	002106'	620340	000777		TRZ	T2,777		;Clear possible HOM index from protection
  1780	002107'	516351	000000*		HRLZM	T2,RIBPRV(T4)	;Set protection code
  1781	002110'	202411	000000*		MOVEM	T3,RIBPPN(T4)	;PPN
  1782	002111'	550400	001274*		HRRZ	T3,THSDAT##	;Today's date
  1783	002112'	542411	002107*		HRRM	T3,RIBPRV(T4)	;Set 12-bits creation date (and 2 bits time)
  1784	002113'	542411	002105*		HRRM	T3,RIBEXT(T4)	;Set 14-bits access date
  1785	002114'	242400	777764		LSH	T3,-^D12	;High-order 2 bits of creation date
  1786	002115'	137400	772452		DPB	T3,[POINT 2,RIBEXT(T4),21]
  1787	002116'	200340	001300*		MOVE	T2,TIME##	;Ticks since midnight
  1788	002117'	230340	000000*		IDIV	T2,JFYMIN##	;Convert to minutes
  1789	002120'	137340	772453		DPB	T2,[POINT 11,RIBPVW(T4),23] ;Creation time
  1790	002121'	201400	000001		MOVEI	T3,1		;Single-level RIB structure
  1791	002122'	202411	000542*		MOVEM	T3,RIBSZS(T4)	;
  1792	002123'	201400	001773*		MOVEI	T3,CODRIB	;UNLIKELY CODE
  1793	002124'	202411	000000*		MOVEM	T3,RIBCOD(T4)	;FOR RIB.
  1794	002125'	202751	000000*		MOVEM	P4,RIBSTS(T4)	;
  1795	002126'	606740	001166*		TRNN	P4,RIPDIR	;UFD OR MFD?
  1796	002127'	263040	000000		 POPJ	P,		;NO, RETURN.
  1797				        PFALL	RIBSTU
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 42
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1798				    ;HERE ONLY FOR MFD OR UFDS.
  1799	002130'	200400	770003	RIBSTU:	MOVE	T3,QUOTAF	;YES, SET FCFS
  1800	002131'	202411	000000*		MOVEM	T3,RIBQTF(T4)	; AND
  1801	002132'	200400	770004		MOVE	T3,QUOTAO	; LOGGED OUT
  1802	002133'	202411	000000*		MOVEM	T3,RIBQTO(T4)	; QUOTAS.
  1803	002134'	200340	772454		MOVE	T2,[SIXBIT /UFD/];SET UP
  1804	002135'	316300	772165		CAMN	T1,MFDUFD	; RIBUNM
  1805	002136'	254000	772147		 JRST	RIBST8		; WITH
  1806	002137'	200340	772455		MOVE	T2,[SIXBIT /SYS/];THE
  1807	002140'	316300	772163		CAMN	T1,SYSUFD	; APPROPRIATE
  1808	002141'	254000	772147		 JRST	RIBST8		; NAME
  1809	002142'	312300	772164		CAME	T1,SPLUFD
  1810	002143'	263040	000000		 POPJ	P,		;Unknown PPN, don't set name
  1811	002144'	200340	772456		MOVE	T2,[SIXBIT /NG/]
  1812	002145'	202351	000000*		MOVEM	T2,RIBUN1(T4)
  1813	002146'	200340	772457		MOVE	T2,[SIXBIT /SPOOLI/]
  1814	002147'	202351	000000*	RIBST8:	MOVEM	T2,RIBUNM(T4)
  1815	002150'	263040	000000		POPJ	P,
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 43
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1816				COMMENT #
  1817				@@SUBROUTINE CNVSIZ/CNVSZM
  1818				@@PURPOSE
  1819				LITTLE SUBRS TO SET RIBSIZ.
  1820				@@ENTRY
  1821				EXPECTS T1/ ADDR OF RIB IN CORE.
  1822				@@ACCUM
  1823				DESTROYS T2.
  1824				@@ #
  1825
  1826	002151'	374346	001620*	CNVSZM:	SOSA	T2,RIBALP(T1)	;Decrement for later increment (PAKREF)
  1827	002152'	200346	002151*	CNVSIZ:	MOVE	T2,RIBALP(T1)	;Allocated pages so far (excluding RIB)
  1828	002153'	242340	000011		LSH	T2,P2WLSH	;CALCULATE WORDS
  1829	002154'	202346	000531*		MOVEM	T2,RIBSIZ(T1)	;
  1830	002155'	263040	000000		POPJ	P,
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 44
REFSTR.MAC	20-NOV-87 22:23		Tables and storage

  1831				SUBTTL	Tables and storage
  1832
  1833				;The following definitions and table need to be updated if COMMOD is changed.
  1834				;The offsets into the HOM page are defined here for easy reference, LOADER
  1835				;will complain if they differ from the definitions in COMMOD.
  1836
  1837			000014	XP HOMFEP,014	;# of FEFILE data pages ,, First FEFILE data page (unit 0 only)
  1838			000017	XP HOMSAT,017	;RIB for SAT.SYS
  1839			000020	XP HOMHMS,020	;RIB for HOME.SYS
  1840			000021	XP HOMSPG,021	;Prime RIB for SPAGES.SYS (formerly SWAP.SYS)
  1841			000022	XP HOMCRS,022	;Prime RIB for CRASH.SAV (8192+ pages on KL)
  1842			000023	XP HOMSUF,023	;RIB for (SYS) [1,4].UFD
  1843			000024	XP HOMPUF,024	;RIB for (SPOOLING) [11653,115244].UFD
  1844			000025	XP HOMMFD,025	;RIB for (UFD) [1,1].UFD
  1845			000026	XP HOMP4C,026	;Number of pages allocated to CRASH.SAV
  1846				EXTERN SYRDPR,SYNRPR	;Read and no-read protection for *.SYS files
  1847				EXTERN SYSPPN,SYSPRV	;PPN for SYS and protection for that directory
  1848				EXTERN MFDPPN,MFDPRV	;PPN for MFD and protection for that directory
  1849				EXTERN SPLPPN		;PPN for (SPOOLING)
  1850
  1851				DEFINE ITEMS<;;SYS files must come before UFDs, otherwise can be in any order
  1852				;;NAM,FILENAME,EXT,PROT,INDEX,PCB
  1853				X HOM,HOME  ,SYS,SYRDPR,HOMHMS,HMR;;020  HOME.SYS   HOME, BAT and BOOTS
  1854				X SAT,SAT   ,SYS,SYRDPR,HOMSAT,STR;;017  SAT.SYS    SAT file
  1855				X CRS,CRASH ,SAV,SYNRPR,HOMCRS    ;;022  CRASH.SAV  (later .EXE) crash file
  1856				X SPG,SPAGES,SYS,SYNRPR,HOMSPG,TMP;;021  SPAGES.SYS Spare PAGES file, cyl 1 & 2
  1857				IFCPU (KS),<;;Note: pointer to RIB is NOT stored in HOM page.
  1858				X FEF,FEFILE,SYS,SYNRPR,0 >       ;;014  FEFILE.SYS for 2020 front-end
  1859				  ;;The UFDs must be last
  1860				X SYS,SYSPPN,UFD,SYSPRV,HOMSUF    ;;023  (SYS).UFD
  1861				X SPL,SPLPPN,UFD,754000,HOMPUF    ;;024  (SPOOLING).UFD
  1862				X MFD,MFDPPN,UFD,MFDPRV,HOMMFD    ;;025  (UFD).UFD
  1863				> ; End Define ITEMS
  1864
  1865			000000		NFILE==<NUFDS==0>	;Initialize counters
  1866				DEFINE X(NAM,FILE,EXT,PROT,INDEX,PCB),<
  1867				    IFDIF <EXT>,<UFD>,<NFILE==NFILE+1;;Count number of nonUFD files
  1868				            IFG NUFDS,<PRINTX ? UFDs must be last in ITEMS macro>
  1869				  NAM'FIL: SIXBIT /FILE/>
  1870				    IFIDN <EXT>,<UFD>,<NUFDS==NUFDS+1;;Count number of UFDs
  1871				  NAM'UFD: EXP 0 >;;PPN will be filled in later
  1872				>
  1873	002156'	505755	450000	R.FILE:	ITEMS	
  1874	002157'	634164	000000
  1875	002160'	436241	635000
  1876	002161'	636041	474563
  1877	002162'	464546	515445
  1878	002163'	000000	000000
  1879	002164'	000000	000000
  1880	002165'	000000	000000
  1881						;File names or addr of PPN
  1882
  1883				DEFINE X(NAM,FILE,EXT,PROT,INDEX,PCB),<
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 44-2
REFSTR.MAC	20-NOV-87 22:23		Tables and storage

  1884				  NAM'EXP: XWD ''EXT'',PROT+INDEX>
  1885	002166'	637163	000020*	R.EXPR:	ITEMS	
  1886	002167'	637163	000017*
  1887	002170'	634166	000022*
  1888	002171'	637163	000021*
  1889	002172'	637163	000000*
  1890	002173'	654644	000023*
  1891	002174'	654644	754024
  1892	002175'	654644	000025*
  1893						;Extension, protection, index into %HOM
  1894
  1895				DEFINE X(NAM,FILE,EXT,PROT,INDEX,PCB),<
  1896				  NAM'ALP: 0>
  1897	772176			R.ZERB:!			;Start of area to zero
  1898	002176'	000000	000000	R.SIZE:	ITEMS	
  1899	002177'	000000	000000
  1900	002200'	000000	000000
  1901	002201'	000000	000000
  1902	002202'	000000	000000
  1903	002203'	000000	000000
  1904	002204'	000000	000000
  1905	002205'	000000	000000
  1906						;Allocated size
  1907								;R.SIZE+R.RIBS zeroed before REFRESH
  1908				DEFINE X(NAM,FILE,EXT,PROT,INDEX,PCB),<
  1909				  NAM'RBD: 0>
  1910	002206'	000000	000000	R.RIBS:	ITEMS	
  1911	002207'	000000	000000
  1912	002210'	000000	000000
  1913	002211'	000000	000000
  1914	002212'	000000	000000
  1915	002213'	000000	000000
  1916	002214'	000000	000000
  1917	002215'	000000	000000
  1918						;RIB data (retrieval pointer)
  1919			772215	R.ZERE==.-1			;End of area to zero
  1920
  1921				DEFINE X(NAM,FILE,EXT,PROT,INDEX,PCB),<;;Generates 0 if PCB is blank
  1922				  NAM'CTL: IFNB <PCB>,<XWD %'PCB,%'PCB'.P;> 0>
  1923	002216'	752000	000214*	R.PCBS:	ITEMS	
  1924	002217'	750000	000176*
  1925	002220'	000000	000000
  1926	002221'	746000	001643*
  1927	002222'	000000	000000
  1928	002223'	000000	000000
  1929	002224'	000000	000000
  1930	002225'	000000	000000
  1931						;PCB data for files that are on all units
  1932
  1933				DEFINE X(NAM,FILE,EXT,PROT,INDEX,PCB),<IFNB <PCB>,<PCB'RBP:>
  1934				  NAM'RBP: 0 >
  1935	002226'	000000	000000	R.RBPS:	ITEMS	
  1936	002227'	000000	000000
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 44-3
REFSTR.MAC	20-NOV-87 22:23		Tables and storage

  1937	002230'	000000	000000
  1938	002231'	000000	000000
  1939	002232'	000000	000000
  1940	002233'	000000	000000
  1941	002234'	000000	000000
  1942	002235'	000000	000000
  1943						;Pointers into RIB for adding new pages
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 45
REFSTR.MAC	20-NOV-87 22:23		MISC. DATA LOCATIONS.

  1944				SUBTTL	MISC. DATA LOCATIONS.
  1945
  1946	772236			RANNO::	BLOCK	1	;Holder for RANDOM # for REFRESH
  1947	772237			UFDSTP:	BLOCK	1	;PNTR TO SPACE IN UFD RIB FOR PNTRS.
  1948
  1949	772240			BEGSAT:	BLOCK	1	;First page in SAT
  1950	772241			SVSBTL:	BLOCK	1	;# of pages in SAT
  1951	772242			LPGSAT:	BLOCK	1	;Last page in current SAT
  1952
  1953	772243			FSTUNI:	BLOCK	1	;ADDR OF FIRST UNIT IN STR (FOR REFRSH)
  1954	772244			REFUNI:	BLOCK	1	;STORAGE FOR PAKREF.  (UNIT CURRENTLY BEING REFRESHED)
  1955
  1956	772245			SATIND:	BLOCK	1	;USED AS A TEMPORARY.
  1957
  1958	772246			SATDSK:	BLOCK	1	;FLAG TO PREVENT UNNECESSARY IO ON SAT PAGE.
  1959
  1960	772247			PGSSPG:	BLOCK	1	;USED BY SPAGES AND FEFILE
  1961	772250			PGSRIB:	BLOCK	1	;USED BY RBNFIL, ETC. TO KEEP TRACK OF COUNT OF
  1962							;RIBS AND MAYBE OF PAGES.
  1963
  1964	772251			SAVEP:	BLOCK	1	;Saved PDL
  1965	772252			PAGE::	BLOCK	1	;Current disk page number for TSTSUP
  1966
  1967	772253			REFLIT:	LIT
  1968	002253'	772176	772177
  1969	002254'	777775	000005
  1970	002255'	001106	772166
  1971	002256'	201300	770020
  1972	002257'	260040	000000*
  1973	002260'	260040	001715*
  1974	002261'	262041	000000
  1975	002262'	263040	000000
  1976	002263'	260040	770722
  1977	002264'	777775	000003
  1978	002265'	201300	770013
  1979	002266'	260040	002257*
  1980	002267'	260040	002260*
  1981	002270'	262041	000000
  1982	002271'	263040	000000
  1983	002272'	751000	745000
  1984	002273'	201300	770065
  1985	002274'	260040	002266*
  1986	002275'	260040	002267*
  1987	002276'	262041	000000
  1988	002277'	263040	000000
  1989	002300'	777002	745000
  1990	002301'	201300	770056
  1991	002302'	260040	002274*
  1992	002303'	260040	002275*
  1993	002304'	201300	770105
  1994	002305'	260040	002302*
  1995	002306'	260040	002303*
  1996	002307'	256000	770000
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 45-2
REFSTR.MAC	20-NOV-87 22:23		MISC. DATA LOCATIONS.

  1997	002310'	111114	772166
  1998	002311'	140200	000007
  1999	002312'	350200	000007
  2000	002313'	142111	000002
  2001	002314'	000005	000005
  2002	002315'	262040	000006
  2003	002316'	263040	000000
  2004	002317'	777400	751000
  2005	002320'	201300	770005
  2006	002321'	260040	002305*
  2007	002322'	260040	002306*
  2008	002323'	262041	000000
  2009	002324'	263040	000000
  2010	002325'	262040	000007
  2011	002326'	250341	000000
  2012	002327'	260040	772320
  2013	002330'	260040	002321*
  2014	002331'	260040	002322*
  2015	002332'	262041	000000
  2016	002333'	263040	000000
  2017	002334'	201300	770027
  2018	002335'	260040	002330*
  2019	002336'	260040	002331*
  2020	002337'	201300	770105
  2021	002340'	260040	002335*
  2022	002341'	260040	002336*
  2023	002342'	256000	770000
  2024	002343'	000000	001570*
  2025	002344'	522472	451652
  2026	002345'	501016	267752
  2027	002346'	723235	662746
  2028	002347'	270321	251712
  2029	002350'	721016	060716
  2030	002351'	625015	672732
  2031	002352'	613136	220322
  2032	002353'	671012	040616
  2033	002354'	425304	072320
  2034	002355'	627344	072746
  2035	002356'	625012	051212
  2036	002357'	406104	443500
  2037	002360'	723364	071312
  2038	002361'	607105	420302
  2039	002362'	673104	050256
  2040	002363'	512232	442510
  2041	002364'	435016	467500
  2042	002365'	737455	172312
  2043	002366'	270000	000000
  2044	002367'	064250	460750
  2045	002370'	605015	171500
  2046	002371'	647344	022650
  2047	002372'	466407	422650
  2048	002373'	466405	333556
  2049	002374'	335746	022234
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 45-3
REFSTR.MAC	20-NOV-87 22:23		MISC. DATA LOCATIONS.

  2050	002375'	271004	020252
  2051	002376'	717124	043222
  2052	002377'	462132	322216
  2053	002400'	203515	720316
  2054	002401'	627504	061302
  2055	002402'	617264	072336
  2056	002403'	201050	644630
  2057	002404'	426465	221134
  2058	002405'	064240	000000
  2059	002406'	154670	320244
  2060	002407'	426152	352244
  2061	002410'	155644	022650
  2062	002411'	466403	333250
  2063	002412'	275012	040616
  2064	002413'	426660	000000
  2065	002414'	502030	742536
  2066	002415'	000000	000000
  2067	002416'	375012	040616
  2068	002417'	425015	772750
  2069	002420'	203374	620344
  2070	002421'	607354	762500
  2071	002422'	677444	052634
  2072	002423'	522510	246100
  2073	002424'	673376	420346
  2074	002425'	627504	072740
  2075	002426'	271004	000000
  2076	002427'	035771	127636
  2077	002430'	203136	271336
  2078	002431'	711015	767100
  2079	002432'	000000	000000
  2080	002433'	201300	770043
  2081	002434'	260040	002340*
  2082	002435'	260040	002341*
  2083	002436'	201300	770105
  2084	002437'	260040	002434*
  2085	002440'	260040	002435*
  2086	002441'	256000	770000
  2087	002442'	745000	746000
  2088	002443'	201300	770077
  2089	002444'	260040	002437*
  2090	002445'	260040	002440*
  2091	002446'	201300	770105
  2092	002447'	260040	002444*
  2093	002450'	260040	002445*
  2094	002451'	256000	770000
  2095	002452'	160211	002113*
  2096	002453'	141311	000000*
  2097	002454'	654644	000000
  2098	002455'	637163	000000
  2099	002456'	564700	000000
  2100	002457'	636057	575451
  2101	772465				VAR
  2102
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 45-4
REFSTR.MAC	20-NOV-87 22:23		MISC. DATA LOCATIONS.

  2103
  2104			002466	REFLNR==.-%REF+1	;# of words in REFSTR
  2105			003000	REFLNP==<REFLNR!777>+1	;Rounded up to page boundry
  2106
  2107				ONSZCK(REFSTR,REF)	;CHECK TO SEE IF ENOUGH PAGES ALLOCATED
  2108
  2109	002465'			DEPHASE
  2110
  2111	002465'			REFEND:	END		;Cannot use $END in PHASEd code
  2112
NO ERRORS DETECTED
PROGRAM BREAK IS 002465
8K CORE USED
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 46
REFSTR.MAC	20-NOV-87 22:23		SYMBOL TABLE

BATBAD		770020		GETHOM		000633'	EXT	LPNSAT		000010	SIN	PREAD4		771711	
BATELB		000712'	EXT	GETPR4		772057		MAKPAG		771154		PREF1		770510	
BATFIR		000000	EXT	GETPR5		772064		MFDALP		772205		PREF11		770561	
BATNBB		000706'	EXT	GETPRM		772054		MFDCTL		772225		PREF2		770516	
BAYNBB		000711'	EXT	GETSAT		771552		MFDEXP		772175		PREF3		770533	
BEGSAT		772240		GTSAT6		771566		MFDPPN		001164'	EXT	PREF4		770542	
CLSAOB		771631		HASH		771255		MFDPRV		000000	EXT	PREF5		770560	
CLUAB1		771623		HMRRBP		772226		MFDRBD		772215		PRFNST		770567	
CLUAB2		771624		HOMALP		772176		MFDRBP		772235		PTRE45		772024	
CLUAOB		771622		HOMCRS		000022	SIN	MFDRIB		000421'	EXT	PTREX1		771731	
CNDSWT		771540		HOMCTL		772216		MFDUFD		772165		PTREX2		771737	
CNVSIZ		772152		HOMEXP		772166		MOROOM		772045		PTREX3		771765	
CNVSZM		772151		HOMFEP		000014	SIN	NBOOTP		000003	SIN	PTREX4		772006	
CODRIB		002123'	EXT	HOMFIL		772156		NFILE		000005	SPD	PTREXT		771716	
CONMES		001713'	EXT	HOMHMS		000020	SIN	NODIE		000000	EXT	PTRFAL		772042	
CONOUT		771713		HOMHSH		000000	EXT	NORCV		770352		PTRFL0		772036	
CORONZ		000754'	EXT	HOMMFD		000025	SIN	NOTAVL		770065		PTRFL1		772041	
CORZER		002101'	EXT	HOMP4C		000026	SIN	NUFDS		000003	SPD	PTRFL2		772035	
CPOPJ1		002073'	EXT	HOMPUF		000024	SIN	NXCLC		771075		PTROT2		771726	
CPUKS		000003	SPD	HOMRAN		000000	EXT	NXTSAT		770156		PTROU0		771722	
CPUTYP		000003	SPD	HOMRBD		772206		NXUNIT		770153		PTROUT		771724	
CPZZ		000001	SPD	HOMRBP		772226		OCONM		002447'	EXT	PWRITE		771665	ENT
CRLF		001714'	EXT	HOMRBS		771611		OGETP2		771515		QF	377777	777777	SIN
CRLFOP		771714		HOMREF		000000	EXT	OGETP3		771522		QO	377777	777777	SIN
CRSALP		772200		HOMRS1		771614		OGETP4		771526		QUOTAF		770003	
CRSCRE		770333		HOMRS2		771617		OGETP5		771535		QUOTAO		770004	
CRSCTL		772220		HOMSAT		000017	SIN	OGETPG		771511		R.EXPR		772166	
CRSEXP		772170		HOMSPG		000021	SIN	OGTPG		770013		R.FILE		772156	
CRSFIL		772160		HOMSUF		000023	SIN	OPAGIN		002343'	EXT	R.PCBS		772216	
CRSRBD		772210		HOMUP1		770450		OPAGOT		001637'	EXT	R.RBPS		772226	
CRSRBP		772230		HOMUPD		770432		OPOUT		002450'	EXT	R.RIBS		772206	
D		746000		INISA2		770766		P		000001	INT	R.SIZE		772176	
DDT		000000	EXT	INISA3		770777		P1		000014	INT	R.ZERB		772176	SPD
DIE		000000'	EXT	INISA5		771003		P2		000015	INT	R.ZERE		772215	SPD
ENTUFD		771261		INISA6		771043		P2WLSH		000011	SPD	RANNO		772236	INT
FBOOTB		000003	SIN	INISA8		771060		P3		000016	INT	RBEOUT		770043	
FEFALP		772202		INISA9		771064		P4		000017	INT	RBLVPR		000000	EXT
FEFCR1		770321		INISAA		771006		PAGE		772252	INT	RBLVSP		000000	EXT
FEFCRE		770316		INISAB		771013		PAGNED		771411		RBNF10		771403	
FEFCTL		772222		INISAC		771023		PAKLEV		770677		RBNFIL		771310	
FEFEXP		772172		INISAD		771034		PAKRB1		770657		RBNFL1		771325	
FEFFIL		772162		INISAT		770737		PAKREF		770475	ENT	RBNFL2		771327	
FEFLEN		000100	SIN	IOFAL		770005		PAKSP0		770632		RBNFL3		771341	
FEFRBD		772212		JFYMIN		002117'	EXT	PAKSPG		770623		RBNFL4		771343	
FEFRBP		772232		JFYSEC		001301'	EXT	PG		000003	INT	RBNFL6		771347	
FILES		771662	INT	LBNLEN		000005	SPD	PGSRIB		772250		RBNFL7		771354	
FIXHM1		770644		LBNLST		771070		PGSSPG		772247		RBNFL8		771362	
FIXHOM		770632		LP2BAT		000007	SIN	PJRST	324740	000000		RBNFL9		771372	
FSFPPN		000462'	EXT	LP2HOM		000006	SIN	PKRB1A		770672		RBNOUT		770027	
FSTUNI		772243		LPGSAT		772242		PREAD		771670	ENT	RBREAL		001441'	EXT
FTSPAG	777777	777777	SIN	LPN000		000000	SIN	PREAD0		771675		RBSPAR		000547'	EXT
GETBAT		000571'	EXT	LPNBAT		000002	SIN	PREAD1		771673		RBYPNO		001702'	EXT
GETHMP		771124		LPNHOM		000001	SIN	PREAD2		771705		RBYUNI		001676'	EXT
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88 PAGE 46-2
REFSTR.MAC	20-NOV-87 22:23		SYMBOL TABLE

REFEND		002465'		SATALP		772177		STRREF		000472'	EXT	UNYSPU		000000	EXT
REFFAL		770474		SATCLC		771115		STRUNI		000526'	EXT	WTBOTH		000651'	EXT
REFLAG		000463'	EXT	SATCTL		772217		STRUNM		000242'	EXT	%BAT		747000	SIN
REFLIT		772253		SATDSK		772246		STTAOB		001626'	EXT	%BAT.P		000000	EXT
REFLNP		003000	SIN	SATEXP		772167		STTFPC		001522'	EXT	%HMR		752000	SIN
REFLNR		002466	SIN	SATFIL		772157		STTLEN		001627'	EXT	%HMR.P		002216'	EXT
REFRSH		770121	ENT	SATIND		772245		STTPTR		001624'	EXT	%HOM		753000	SIN
REFSTR		770000	ENT	SATRBD		772207		STTSTS		000750'	EXT	%HOM.P		000000	EXT
REFSTT		000000'	INT	SATRBP		772227		SVSBTL		772241		%R	777777	010000'	SPD
REFUNI		772244		SATRBS		771602		SYNRPR		002172'	EXT	%REF		770000	SIN
RFNXST		770574		SATRS1		771605		SYRDPR		000000	EXT	%STA		751000	SIN
RIBALP		002152'	EXT	SATSR2		771417		SYSALP		772203		%STA.P		001554'	EXT
RIBCOD		002124'	EXT	SATSR3		771424		SYSCTL		772223		%STR		750000	SIN
RIBEX1		002003'	EXT	SATSR5		771457		SYSDSP		001663'	EXT	%STR.P		002217'	EXT
RIBEX2		002006'	EXT	SATSR8		771502		SYSEXP		772173		%T2P		745000	SIN
RIBEX3		002014'	EXT	SATSR9		771504		SYSPPN		000372'	EXT	%T2P.P		001245'	EXT
RIBEX4		002022'	EXT	SATSRH		771412		SYSPRV		000000	EXT	%TMP		746000	SIN
RIBEXT		002452'	EXT	SAVE1		001130'	EXT	SYSRBD		772213		%TMP.P		002221'	EXT
RIBFAL		770077		SAVE4		000702'	EXT	SYSRBP		772233		
RIBLST		000000	EXT	SAVEP		772251		SYSUFD		772163		
RIBMXA		000000	EXT	SAVT		001615'	EXT	T1		000006	INT	
RIBNAM		002104'	EXT	SCNBAT		770702	ENT	T2		000007	INT	
RIBPFS		000543'	EXT	SCNBT2		770706		T3		000010	INT	
RIBPPN		002110'	EXT	SCNBT3		770713		T4		000011	INT	
RIBPRV		002112'	EXT	SETBTS		770722		TAKPAG		771130		
RIBPVW		002453'	EXT	SETUF1		771223		THSDAT		002111'	EXT	
RIBQTF		002131'	EXT	SETUF2		771232		TIME		002116'	EXT	
RIBQTO		002133'	EXT	SETUF4		771237		TMPIN		771636		
RIBRIB		000544'	EXT	SETUF5		771244		TMPOUT		771637		
RIBRPS		000000	EXT	SETUFD		771221		TMPRBP		772231		
RIBSET		772076		SETUFN		771226		TMPRBS		771573		
RIBSFS		000000	EXT	SIZREF		000003	SIN	TMPRS1		771576		
RIBSIZ		002154'	EXT	SOFERR		770105		TSTSUP		771647	ENT	
RIBSLF		000663'	EXT	SPGALP		772201		U		000005	INT	
RIBSNM		000000	EXT	SPGCR1		770255		UFDCDT		000002	SIN	
RIBST8		772147		SPGCRE		770251		UFDERR		770056		
RIBSTS		002125'	EXT	SPGCTL		772221		UFDEXT		000001	SIN	
RIBSTU		772130		SPGEXP		772171		UFDHSI		001256'	EXT	
RIBSZS		002122'	EXT	SPGFIL		772161		UFDLIC		000003	SIN	
RIBUN1		002145'	EXT	SPGRBD		772211		UFDNAM		000000	SIN	
RIBUNM		002147'	EXT	SPGRBP		772231		UFDRIB		000004	SIN	
RIBUSD		000000	EXT	SPLALP		772204		UFDSET		771163		
RIBVER		000000	EXT	SPLCTL		772224		UFDSIZ		000005	SIN	
RIPDIR		002126'	EXT	SPLEXP		772174		UFDST1		771202		
RIPNDL		000000	EXT	SPLPPN		000354'	EXT	UFDST3		771207		
RIPNFS		000000	EXT	SPLRBD		772214		UFDSTP		772237		
S$ENTR	777777	777775	SIN	SPLRBP		772234		UNIPPU		001703'	EXT	
S$HALT	777777	777777	SIN	SPLUFD		772164		UNISTR		001633'	EXT	
S$NAME		770000	SPD	SRPREF		000470'	EXT	UNISTT		001623'	EXT	
S$NONA		000000	SIN	STRBTS		000471'	EXT	UNTLEN		001677'	EXT	
S$TEMP		000000	SPD	STRDDB		000000	EXT	UNTTBL		001700'	EXT	
S$XCT	777777	777776	SIN	STRHSH		000655'	EXT	UNYLUN		001443'	EXT	
SATALP		772177		

REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88
REFSTR.MAC	20-NOV-87 22:23		Symbol cross reference

BATBAD	   117#	   666
BATELB	    39%	   658
BATFIR	    39%	   651
BATNBB	    39%	   654
BAYNBB	    39%	   657
BEGSAT	   678	   681	   761	   849	   852	   875	   924	   927	  1949#
CLSAOB	   434	  1473#
CLUAB1	  1466#	  1474
CLUAB2	  1467#	  1471
CLUAOB	   622	  1465#
CNDSWT	   400	   620	   718	  1374#
CNVSIZ	   207	   224	  1827#
CNVSZM	   549	   554	  1826#
CODRIB	    23%	  1646	  1792
CONMES	    41%	  1559	  1566
CONOUT	  1507	  1511	  1566#
CORONZ	    37%	   733
CORZER	    37%	  1057	  1641	  1675	  1774
CPOPJ1	    37%	   447	   655	   851	   904	   941	  1028	  1053	  1229	  1323	  1359	  1375	  1383	  1397
	  1414	  1500	  1602	  1716	  1735	  1751
CPUKS	    86	   289	   410	   790	  1877	  1889	  1902	  1914	  1927	  1939
CPUTYP	    86	   289	   410	   790	  1877	  1889	  1902	  1914	  1927	  1939
CPZZ	    86#	    86	   289#	   289	   410#	   410	   790#	   790	  1877#	  1877	  1889#	  1889	  1902#	  1902
	  1914#	  1914	  1927#	  1927	  1939#	  1939
CRLF	  1567%	  1567
CRLFOP	  1567#
CRSALP	   343	  1900#
CRSCRE	   331#
CRSCTL	  1925#
CRSEXP	   337	  1887#
CRSFIL	   336	  1875#
CRSRBD	   345	  1912#
CRSRBP	  1937#
D	  1525	  1526#
DDT	  1518	  1527%	  1548
DIE	    52	    52%	    53
ENTUFD	  1064	  1103#
FBOOTB	    74#	   772
FEFALP	   327	  1902#
FEFCR1	   318#	   322
FEFCRE	   313#
FEFCTL	  1927#
FEFEXP	   292	  1889#
FEFFIL	   291	  1877#
FEFLEN	    86#	   306	   316	   415	   793
FEFRBD	   305	  1914#
FEFRBP	  1939#
FILES	  1521#
FIXHM1	   594#	   598
FIXHOM	   584#
FSFPPN	    39%	   438
FSTUNI	   151	   202	   240	   280	   290	   335	   349	   361	   406	   416	   440	   460	   788	  1473
	  1953#
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88
REFSTR.MAC	20-NOV-87 22:23		Symbol cross reference

FTSPAG	    45	    81	   239	   314	   412	   558	   777	   792
GETBAT	    40%	   185	   531
GETHMP	   769	   774	   901#
GETHOM	    40%	   407	   468	   585
GETPR4	  1737#	  1752
GETPR5	  1739	  1743#
GETPRM	  1220	  1734#
GETSAT	  1191	  1353	  1396#
GTSAT6	  1400	  1410#
HASH	  1062	  1078#
HMRRBP	  1935#
HOMALP	   236	  1898#
HOMCRS	  1841#	  1887
HOMCTL	  1923#
HOMEXP	   161	  1885#
HOMFEP	   419	   588	  1837#
HOMFIL	   160	  1873#
HOMHMS	  1839#	  1885
HOMHSH	    29%	   421	   590
HOMMFD	  1844#	  1892
HOMP4C	  1845#
HOMPUF	  1843#	  1891
HOMRAN	    29%	   423	   592
HOMRBD	   230	  1910#
HOMRBP	   168	  1444	  1447	  1935#
HOMRBS	   226	   551	   903	  1444#
HOMREF	    29%	   409	   587
HOMRS1	  1445	  1447#
HOMRS2	  1434	  1442	  1450#
HOMSAT	  1838#	  1886
HOMSPG	  1840#	  1888
HOMSUF	  1842#	  1890
HOMUP1	   425#	   429
HOMUPD	   407#	   433
INISA2	   739	   743#
INISA3	   736	   745	   749	   756#
INISA5	   761#
INISA6	   762	   789	   805#
INISA8	   807	   818#
INISA9	   817	   822#
INISAA	   768#	   771
INISAB	   773#	   776
INISAC	   782#	   785
INISAD	   794#	   797
INISAT	   191	   539	   718#
IOFAL	   109#	  1381	  1408	  1413	  1499
JFYMIN	  1788%	  1788
JFYSEC	  1119%	  1119
LBNLEN	   767	   832#
LBNLST	   768	   827#	   832
LISTSN	     3	     6
LP2BAT	    77#	   831
LP2HOM	    76#	   829
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88
REFSTR.MAC	20-NOV-87 22:23		Symbol cross reference

LPGSAT	   679	   855	   862	   879	   925	  1951#
LPN000	    71#
LPNBAT	    73#	   830
LPNHOM	    72#	   828	  1512
LPNSAT	    78#	   210	   800
MAKPAG	   273	   319	   573	   956#
MFDALP	   396	  1905#
MFDCTL	  1930#
MFDEXP	   390	  1892#
MFDPPN	   388	   978	  1848%
MFDPRV	  1848%	  1892
MFDRBD	   393	  1917#
MFDRBP	  1942#
MFDRIB	    37%	   394
MFDUFD	   389	  1804	  1880#
MOROOM	  1626	  1634	  1714#
NBOOTP	    75#	   772
NFILE	   363	   366	   375	   383	   387	   397	   424	   470	   478	   593	   607	  1865#	  1873	  1873#
	  1874	  1874#	  1875	  1875#	  1876	  1876#	  1877	  1877#
NODIE	    52%
NORCV	   334	   349#
NOTAVL	   133#	   926	   935
NUFDS	   383	   387	   397	   424	   470	   593	  1865#	  1873	  1874	  1875	  1876	  1877	  1878	  1878#
	  1879	  1879#	  1880	  1880#
NXCLC	   194	   542	   848#
NXTSAT	   191#	   195
NXUNIT	   185#	   198
OCONM	    41%	   666	   810	   926	   935	  1106	  1185	  1261	  1347	  1381	  1408	  1413	  1430	  1438
	  1446	  1499	  1636	  1753
OGETP2	  1343#	  1351
OGETP3	  1344	  1348#
OGETP4	  1349	  1353#
OGETP5	  1354	  1356	  1361#
OGETPG	   227	   252	   302	   814	  1012	  1022	  1159	  1339#	  1608	  1643	  1667	  1740
OGTPG	   113#	   810	  1185	  1261	  1347
OPAGIN	    40%	   489	   513	  1412	  1492
OPAGOT	    40%	   216	   233	   617	   825	  1072	  1227	  1380	  1405	  1493
OPOUT	    41%	   666	   810	   926	   935	  1106	  1185	  1261	  1347	  1381	  1408	  1413	  1430	  1438
	  1446	  1499	  1568	  1636	  1753
P	    53	   165	   177	   185	   187	   191	   194	   207	   209	   216	   224	   226	   227	   233
	   246	   252	   273	   274	   282	   296	   302	   319	   320	   324	   340	   354	   370	   376
	   391	   398	   400	   407	   430	   434	   450	   468	   489	   513	   531	   535	   539	   542
	   549	   551	   554	   556	   573	   574	   579	   585	   599	   617	   620	   622	   623	   627
	   666	   680	   687	   690	   718	   719	   728	   733	   756	   757	   758	   759	   769	   770
	   774	   775	   783	   784	   795	   796	   801	   802	   810	   814	   815	   819	   820	   823
	   858	   863	   881	   901	   902	   903	   923	   926	   933	   935	   956	   961	   962	   977
	   981	   982	  1012	  1013	  1022	  1023	  1025	  1026	  1042	  1052	  1057	  1060	  1062	  1064
	  1066	  1072	  1073	  1081	  1104	  1106	  1125	  1155	  1159	  1160	  1185	  1186	  1190	  1191
	  1192	  1193	  1195	  1198	  1199	  1204	  1205	  1216	  1217	  1220	  1221	  1227	  1228	  1261
	  1273	  1276	  1282	  1322	  1339	  1340	  1345	  1346	  1347	  1353	  1355	  1357	  1358	  1361
	  1362	  1363	  1380	  1381	  1402	  1405	  1406	  1407	  1408	  1409	  1412	  1413	  1430	  1432
	  1438	  1440	  1446	  1448	  1452	  1468	  1474	  1477	  1498	  1499	  1504	  1507	  1511	  1514
	  1521	  1523	  1530	  1531	  1537	  1538	  1557	  1559	  1560	  1566	  1567	  1593	  1596	  1597
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88
REFSTR.MAC	20-NOV-87 22:23		Symbol cross reference

	  1598	  1599	  1605	  1608	  1619	  1620	  1623	  1625	  1626	  1630	  1631	  1633	  1634	  1636	  1641
	  1643	  1648	  1649	  1657	  1664	  1666	  1667	  1670	  1672	  1675	  1677	  1683	  1691	  1692
	  1693	  1696	  1697	  1698	  1699	  1720	  1737	  1740	  1741	  1742	  1744	  1745	  1746	  1747
	  1748	  1749	  1753	  1771	  1772	  1774	  1775	  1776	  1796	  1810	  1815	  1830
P1	   350	   366	   375	   387	   397	   485	   491	   493	   496	   497	   502	   503	   504	   522
	   658	   660	   661	   805	   806	   809	   813	   822	   931	   932	   934	   936	   992	  1060
	  1061	  1065	  1066	  1103	  1108	  1109	  1112	  1121	  1168	  1179	  1186	  1187	  1195	  1210
	  1222	  1223	  1251	  1271	  1290	  1302	  1307	  1317	  1319	  1321	  1339	  1342	  1343	  1346
	  1348	  1350	  1358	  1362	  1597	  1648	  1650	  1680	  1681	  1687	  1693	  1736	  1752
P2	   150	   331	   332	   350	   362	   364	   382	   384	   386	   441	   443	   445	   446	   461
	   462	   487	   488	   491	   492	   496	   498	   502	   503	   505	   506	   509	   517	   521
	   522	   523	   524	   601	   603	   626	   649	   662	   818	   977	  1011	  1016	  1042	  1043
	  1045	  1050	  1051	  1052	  1063	  1068	  1168	  1176	  1178	  1184	  1194	  1201	  1202	  1203
	  1209	  1293	  1294	  1300	  1309	  1340	  1341	  1345	  1357	  1361	  1596	  1649	  1651	  1692
P2WLSH	   263	   309	   565	  1828
P3	   258	   259	   260	   268	   269	   270	   272	   276	   313	   315	   316	   318	   322	   509
	   517	   568	   569	   570	   572	   576	   657	   663	   767	   768	   771	   772	   773	   776
	   779	   780	   781	   782	   785	   791	   792	   793	   794	   797	   991	  1014	  1015	  1019
	  1020	  1021	  1200	  1202	  1206
P4	   164	   176	   245	   295	   339	   478	   479	   480	   484	   485	   526	   527	   607	   608
	   609	   611	   616	   619	   650	   651	   654	   656	   658	   664	   665	   980	  1794	  1795
PAGE	  1513	  1550	  1965#
PAGNED	  1152	  1157	  1174	  1194	  1201	  1203	  1231#
PAKLEV	   469	   490	   514	   532	   575	   625#
PAKRB1	   608#	   619
PAKREF	    15	   459#
PAKSP0	   560	   580#
PAKSPG	   572#	   576
PG	   215	   232	   484	   616	   816	   821	  1067	  1226	  1379	  1398	  1497
PGSRIB	   266	   312	  1153	  1218	  1222	  1642	  1669	  1961#
PGSSPG	  1960#
PKRB1A	   610	   619#
PREAD	    16	  1533	  1537#
PREAD0	  1530	  1537	  1550#
PREAD1	  1540#	  1561	  1564
PREAD2	  1554	  1558#
PREAD4	  1515	  1532	  1539	  1563#
PREF1	   471#	   475
PREF11	   499	   521#
PREF2	   479#	   527
PREF3	   493#	   515
PREF4	   495	   502#
PREF5	   508	   517#
PRFNST	   481	   527#
PTRE45	  1659	  1665	  1680#
PTREX1	  1594	  1605#
PTREX2	  1607	  1611#
PTREX3	  1612	  1614	  1629	  1640#
PTREX4	  1653	  1664#
PTREXT	   274	   320	   574	   579	  1204	  1216	  1591#
PTRFAL	  1609	  1644	  1694	  1697#
PTRFL0	  1684	  1692#
PTRFL1	  1621	  1624	  1632	  1696#
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88
REFSTR.MAC	20-NOV-87 22:23		Symbol cross reference

PTRFL2	  1668	  1673	  1691#
PTROT2	  1592	  1600#
PTROU0	  1596#	  1688
PTROUT	  1598#	  1627	  1635
PWRITE	    16	  1530#
QF	    63	    63#	    65
QO	    64	    64#	    66
QUOTAF	    65#	  1799
QUOTAO	    66#	  1801
R.EXPR	   426	   471	   595	  1109	  1112	  1885#
R.FILE	  1061	  1108	  1873#
R.PCBS	   479	   484	   485	   608	   611	   616	  1923#
R.RBPS	   526	  1935#
R.RIBS	   425	   474	   480	   594	   609	  1103	  1910#
R.SIZE	   364	   384	  1121	  1898#
R.ZERB	   153	   154	   464	   465	  1897#
R.ZERE	   155	   466	  1919#
RANNO	    18	   422	   591	  1946#
RBEOUT	   125#	  1636
RBLVPR	    24%	   166	   178	   248	   298	  1162	  1658
RBLVSP	    24%
RBNF10	  1219	  1224#
RBNFIL	   340	  1152#
RBNFL1	  1168#	  1212
RBNFL2	  1170#	  1181
RBNFL3	  1173	  1177	  1180#
RBNFL4	  1171	  1184#
RBNFL6	  1175	  1190#
RBNFL7	  1198#	  1211
RBNFL8	  1204#	  1207
RBNFL9	   282	   324	  1209	  1215#
RBNOUT	   121#	  1430	  1438	  1446
RBREAL	    24%	   211	   214	   482	   937	   958	  1046	  1278
RBSPAR	    24%	   507
RBYPNO	    20%	   231	   512	   613	   824	  1069	  1225	  1279	  1376	  1401	  1411	  1494	  1555
RBYUNI	    20%	   510	   614	   939	   960	  1070	  1281	  1377	  1403	  1495	  1551
REFEND	  2111#
REFFAL	   186	   192	   217	   228	   234	   253	   275	   283	   303	   321	   325	   341	   355	   371
	   377	   392	   399	   401	   408	   450#
REFLAG	    37%	   439
REFLIT	  1967#
REFLNP	    17	  2105#	  2107
REFLNR	    17	  2104#	  2105
REFRSH	    15	   149#
REFSTR	    49	    52	    53#	    56
REFSTT	    17	    47#	    49
REFUNI	   152	   459	   486	   530	   584	   625	  1465	  1954#
RFNXST	   539#	   543
RIBALP	    20%	   218	   235	   261	   262	   284	   307	   308	   326	   342	   357	   373	   395	   564
	  1019	  1158	  1223	  1451	  1826	  1827
RIBCOD	    20%	  1647	  1793
RIBEX1	    38%	  1657
RIBEX2	    38%	  1664
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88
REFSTR.MAC	20-NOV-87 22:23		Symbol cross reference

RIBEX3	    38%	  1670
RIBEX4	    38%	  1676
RIBEXT	    21%	  1778	  1784	  1786
RIBFAL	   137#	  1753
RIBLST	    23%	   523	  1652	  1680	  1715	  1718
RIBMXA	    24%	   984
RIBNAM	    21%	  1777
RIBPFS	    24%	   167	   179	   249	   299	   496	   498	   503	   505	   988	  1014	  1045	  1068	  1163
RIBPPN	    21%	  1781
RIBPRV	    24%	  1780	  1783
RIBPVW	    21%	  1789
RIBQTF	    21%	  1800
RIBQTO	    21%	  1802
RIBRIB	    23%	   497	   504	  1613	  1622	  1628	  1734	  1737	  1750
RIBRPS	    20%	  1619	  1630
RIBSET	   165	   177	   246	   296	   981	  1155	  1771#
RIBSFS	    23%	   498	   505	  1658
RIBSIZ	    21%	   264	   310	   491	   566	  1021	  1829
RIBSLF	    22%	   212	   229	   254	   304	   344	   612	  1024	  1027	  1161	  1224	  1606	  1610	  1645
	  1671	  1682	  1738	  1743
RIBSNM	    23%
RIBST8	  1805	  1808	  1814#
RIBSTS	    22%	  1794
RIBSTU	  1797	  1799#
RIBSZS	    24%	   493	   502	  1611	  1791
RIBUN1	    20%	  1812
RIBUNM	    20%	  1814
RIBUSD	    22%	   983
RIBVER	    22%
RIPDIR	    22%	   980	  1795
RIPNDL	    22%	   164	   176	   245	   295	   339
RIPNFS	    22%	   164	   176	   245	   295	   339
S$ENTR	    52	    58	   431	   540	   586	   600	   618	   621	  1106	  1266	  1430	  1438	  1446	  1636
	  1753
S$HALT	    52	   431	   540	   586	   600	   618	   621	  1106	  1266	  1430	  1438	  1446	  1636	  1753
S$NAME	    56#	   431	   540	   586	   600	   618	   621	  1106	  1266	  1430	  1438	  1446	  1636	  1753
S$NONA	    55	    58	   431	   540	   586	   600	   618	   621	  1106	  1266	  1430	  1438	  1446	  1636
	  1753
S$TEMP	    52#	    52	   431#	   431	   540#	   540	   586#	   586	   600#	   600	   618#	   618	   621#	   621
	  1106#	  1106	  1266#	  1266	  1430#	  1430	  1438#	  1438	  1446#	  1446	  1636#	  1636	  1753#	  1753
S$XCT	    58	   431	   540	   586	   600	   618	   621	  1106	  1266	  1430	  1438	  1446	  1636	  1753
SATALP	   219	  1899#
SATCLC	   187	   535	   875#
SATCTL	  1924#
SATDSK	   156	   463	  1374	  1382	  1396	  1399	  1410	  1958#
SATEXP	   173	  1886#
SATFIL	   172	  1874#
SATIND	   720	   880	  1956#
SATRBD	   213	  1911#
SATRBP	   180	  1436	  1439	  1936#
SATRBS	   209	   556	   823	  1436#
SATRS1	  1437	  1439#
SATSR2	  1252	  1257#
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88
REFSTR.MAC	20-NOV-87 22:23		Symbol cross reference

SATSR3	  1254	  1259	  1265#
SATSR5	  1295#	  1299	  1313
SATSR8	  1296	  1301	  1303	  1317#
SATSR9	  1306	  1319#
SATSRH	   819	  1198	  1251#	  1355
SAVE1	    41%	   922
SAVE4	    41%	   149	   648
SAVEP	  1504	  1521	  1964#
SAVT	    37%	  1432	  1440	  1448
SCNBAT	    15	   648#	   758
SCNBT2	   654#	   665
SCNBT3	   660#	   663
SETBTS	   678#	   757
SETUF1	  1045#	  1051
SETUF2	  1047	  1056#
SETUF4	  1061#	  1065
SETUF5	  1066#
SETUFD	   376	   398	  1042#
SETUFN	  1050#	  1074
SIZREF	  2107
SOFERR	   141#	  1106	  1430	  1438	  1446	  1636	  1753
SPGALP	   285	  1901#
SPGCR1	   272#	   276
SPGCRE	   267#	   278
SPGCTL	  1926#
SPGEXP	   242	  1888#
SPGFIL	   241	  1876#
SPGRBD	   255	  1913#
SPGRBP	  1938#
SPLALP	   358	  1904#
SPLCTL	  1929#
SPLEXP	   353	  1891#
SPLPPN	   351	  1849%
SPLRBD	   356	  1916#
SPLRBP	  1941#
SPLUFD	   352	  1809	  1879#
SRPREF	   444%	   444
STRBTS	    31%	   445
STRDDB	    31%	   589
STRHSH	    31%	   443	   589	   603
STRP4C	    31%	   332
STRRBP	  1936#
STRREF	    31%	   446
STRUNI	    31%	   150	   462	   488
STRUNM	    31%	   259
STTAOB	    33%	   724	  1251	  1290	  1302	  1307	  1317	  1469
STTFPC	    33%	   689	   726	   806	   940	  1172	  1210	  1319	  1321	  1348
STTLEN	    33%	   721	  1180	  1274	  1350	  1470
STTPTR	    33%	   813	   822	  1170	  1187	  1343	  1467
STTSTS	    33%	   727
SVSBTL	   725	   734	   848	   853	   861	   877	  1950#
SYNRPR	  1846%	  1887	  1888	  1889
SYRDPR	  1846%	  1885	  1886
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88
REFSTR.MAC	20-NOV-87 22:23		Symbol cross reference

SYSALP	   374	  1903#
SYSCTL	  1928#
SYSDSP	  1522%	  1522
SYSEXP	   369	  1890#
SYSPPN	   162	   174	   243	   293	   338	   367	  1847%
SYSPRV	  1847%	  1890
SYSRBD	   372	  1915#
SYSRBP	  1940#
SYSUFD	   368	  1807	  1878#
T1	   154	   155	   160	   166	   167	   168	   172	   178	   179	   180	   206	   218	   219	   223
	   235	   236	   241	   248	   249	   250	   256	   257	   260	   261	   263	   264	   267	   268
	   270	   272	   281	   284	   285	   291	   298	   299	   300	   306	   307	   309	   310	   318
	   323	   326	   327	   336	   351	   352	   363	   364	   365	   367	   368	   383	   384	   385
	   388	   389	   411	   413	   415	   418	   419	   420	   421	   422	   423	   424	   425	   426
	   429	   438	   439	   442	   443	   444	   445	   465	   466	   470	   471	   474	   475	   521
	   524	   525	   526	   548	   553	   562	   563	   564	   565	   566	   567	   568	   570	   572
	   589	   590	   591	   592	   593	   594	   595	   598	   602	   603	   661	   666	   678	   679
	   681	   682	   686	   688	   720	   721	   723	   724	   726	   727	   728	   731	   737	   740
	   742	   743	   768	   773	   778	   779	   781	   782	   794	   800	   808	   809	   810	   811
	   812	   876	   877	   878	   879	   923	   924	   925	   926	   927	   928	   929	   934	   935
	   936	   938	   939	   956	   957	   959	   960	   961	   986	   988	   989	  1056	  1058	  1059
	  1061	  1063	  1078	  1079	  1080	  1103	  1106	  1107	  1108	  1110	  1162	  1163	  1164	  1169
	  1170	  1172	  1179	  1180	  1185	  1190	  1192	  1200	  1251	  1253	  1255	  1257	  1258	  1260
	  1261	  1267	  1286	  1290	  1291	  1297	  1300	  1310	  1320	  1347	  1381	  1408	  1413	  1428
	  1429	  1430	  1431	  1436	  1437	  1438	  1439	  1444	  1445	  1446	  1447	  1450	  1466	  1467
	  1469	  1470	  1499	  1505	  1508	  1558	  1563	  1591	  1592	  1600	  1601	  1611	  1612	  1625
	  1633	  1636	  1640	  1646	  1647	  1652	  1653	  1674	  1685	  1686	  1687	  1691	  1696	  1714
	  1715	  1717	  1719	  1741	  1745	  1753	  1771	  1773	  1776	  1777	  1804	  1807	  1809	  1826
	  1827	  1829
T2	   161	   173	   208	   225	   229	   230	   242	   254	   255	   292	   304	   305	   337	   342
	   343	   344	   345	   353	   356	   369	   372	   390	   393	   394	   425	   428	   506	   507
	   550	   555	   578	   594	   597	   612	   649	   656	   683	   685	   722	   723	   725	   726
	   734	   735	   738	   743	   744	   747	   748	   750	   751	   752	   757	   822	   848	   849
	   850	   852	   853	   854	   855	   856	   857	   859	   860	   861	   862	   930	   932	   933
	   937	   957	   958	   982	   983	   984	   987	   988	  1014	  1024	  1027	  1045	  1046	  1068
	  1080	  1109	  1111	  1112	  1113	  1114	  1115	  1116	  1117	  1118	  1119	  1120	  1121	  1122
	  1161	  1170	  1187	  1207	  1215	  1224	  1253	  1258	  1265	  1270	  1271	  1272	  1274	  1275
	  1277	  1278	  1282	  1286	  1295	  1304	  1305	  1318	  1322	  1343	  1374	  1396	  1399	  1400
	  1406	  1407	  1410	  1450	  1512	  1513	  1550	  1598	  1601	  1605	  1606	  1610	  1622	  1628
	  1645	  1671	  1682	  1697	  1717	  1718	  1719	  1738	  1743	  1747	  1772	  1775	  1778	  1779
	  1780	  1787	  1788	  1789	  1803	  1806	  1811	  1812	  1813	  1814	  1826	  1827	  1828	  1829
T3	   162	   174	   243	   293	   338	   426	   427	   428	   471	   472	   473	   474	   493	   494
	   595	   596	   597	   611	   612	   689	   739	   741	   742	   756	   805	   940	   978	  1115
	  1116	  1172	  1174	  1176	  1178	  1269	  1273	  1276	  1288	  1289	  1292	  1293	  1294	  1299
	  1302	  1303	  1304	  1305	  1307	  1309	  1310	  1311	  1312	  1317	  1318	  1319	  1320	  1321
	  1433	  1441	  1449	  1451	  1492	  1493	  1498	  1781	  1782	  1783	  1784	  1785	  1786	  1790
	  1791	  1792	  1793	  1799	  1800	  1801	  1802
T4	   149	   163	   175	   210	   211	   212	   213	   214	   231	   244	   294	   332	   333	   357
	   358	   373	   374	   395	   396	   480	   482	   512	   613	   648	   684	   685	   686	   688
	   824	   922	   979	  1069	  1105	  1107	  1110	  1111	  1113	  1117	  1120	  1122	  1123	  1124
	  1152	  1154	  1156	  1157	  1158	  1225	  1267	  1268	  1269	  1277	  1279	  1280	  1281	  1287
	  1289	  1295	  1298	  1308	  1376	  1401	  1411	  1494	  1555	  1556	  1658	  1666	  1676	  1677
	  1680	  1681	  1773	  1777	  1778	  1780	  1781	  1783	  1784	  1786	  1789	  1791	  1793	  1794
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88
REFSTR.MAC	20-NOV-87 22:23		Symbol cross reference

	  1800	  1802	  1812	  1814
TAKPAG	   783	   795	   801	   901	   922#
THSDAT	  1114%	  1114	  1782%	  1782
TIME	  1118%	  1118	  1787%	  1787
TMPIN	  1492#	  1514	  1538	  1623	  1631	  1748
TMPOUT	  1025	  1493#	  1531	  1620	  1672	  1683	  1744
TMPRBP	   250	   300	   559	  1164	  1428	  1431	  1591	  1600	  1938#
TMPRBS	  1428#
TMPRS1	  1429	  1431#
TSTSUP	    16	  1504#
U	   150	   151	   197	   198	   202	   240	   258	   277	   278	   280	   290	   331	   335	   349
	   361	   406	   416	   432	   433	   440	   441	   459	   461	   462	   486	   487	   488	   510
	   511	   530	   584	   601	   614	   615	   625	   626	   722	   788	   808	   850	   857	   859
	  1070	  1071	  1169	  1270	  1342	  1377	  1378	  1402	  1403	  1404	  1409	  1465	  1466	  1473
	  1475	  1476	  1495	  1496	  1551	  1552	  1553	  1556	  1593	  1599	  1698
UFDCDT	  1098#	  1117	  1120
UFDERR	   129#	  1106
UFDEXT	  1097#	  1111	  1113
UFDHSI	    42%	   420	   442	   602	   986	  1011	  1020	  1050	  1079
UFDLIC	  1099#	  1122
UFDNAM	  1096#	  1110
UFDRIB	  1100#	  1107
UFDSET	   354	   370	   391	   977#
UFDSIZ	  1101#	  1123
UFDST1	  1012#	  1016
UFDST3	   992	  1019#
UFDSTP	  1059	  1105	  1124	  1947#
UNIPPU	    26%	   850	   857	   859	  1556
UNISTR	    26%	   197	   258	   277	   331	   432	   441	   461	   487	   601	   626	  1475
UNISTT	    26%	   722	   808	  1169	  1270	  1342	  1466
UNTLEN	  1552%	  1552
UNTTBL	    42%	   511	   615	  1071	  1378	  1404	  1496	  1553
UNYLUN	    27%	   938	   959	  1280
UNYPPY	    27%	   256	   267	   313	   411	   562	   567	   778	   791
UNYSPU	    27%
WTBOTH	    40%	   430	   599
%BAT	   650	   651
%BAT.P	    35%
%HMR	   163	   167	   223	   229	   235	   548	  1449	  1923
%HMR.P	    35%	   232	  1923
%HOM	   409	   419	   421	   423	   428	   473	   587	   588	   590	   592	   597
%HOM.P	    35%
%R	    49#
%REF	    48	  2104
%STA	   686	   688	   731	   732	   743	   747	   750	   752	   811	   929	  1257	  1267
%STA.P	    35%	   821	  1379	  1398
%STR	   175	   179	   206	   212	   218	   553	  1441	  1924
%STR.P	    35%	   215	  1924
%T2P	   811	   812	  1056	  1058	  1640	  1645	  1647	  1651	  1685
%T2P.P	    35%	   816	  1067
%TMP	   244	   249	   254	   261	   262	   264	   281	   284	   294	   299	   304	   307	   308	   310
	   323	   326	   342	   344	   357	   373	   395	   564	   566	   979	   983	   984	   988	  1014
	  1019	  1021	  1024	  1027	  1045	  1068	  1154	  1158	  1161	  1163	  1223	  1224	  1433	  1526
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88
REFSTR.MAC	20-NOV-87 22:23		Symbol cross reference

	  1606	  1610	  1611	  1613	  1619	  1622	  1628	  1630	  1650	  1652	  1671	  1674	  1681	  1682	  1685
	  1686	  1714	  1715	  1718	  1734	  1737	  1738	  1743	  1750	  1926
%TMP.P	    35%	  1226	  1497	  1926
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:22 13-JAN-88
REFSTR.MAC	20-NOV-87 22:23		Macro/Opdef cross reference

IFCPU	    86	   289	   410	   790	  1877	  1889	  1902	  1914	  1927	  1939
ITEMS	  1851#	  1873	  1885	  1898	  1910	  1923	  1935
MSGDIE	    88#
MSGLIV	   103#	   666	   810	   926	   935	  1185	  1261	  1347	  1381	  1408	  1413	  1499
MSGSFE	    94#	  1106	  1430	  1438	  1446	  1636	  1753
ND	    63	    64
ONSZCK	  2107
PFALL	  1533	  1797
PJRST	   825	  1568
PRINTF	    10#
STOPCD	    51	   431	   540	   586	   600	   618	   621	  1106	  1266	  1430	  1438	  1446	  1636	  1753
X	  1866#	  1873	  1874	  1875	  1876	  1877	  1878	  1879	  1880	  1883#	  1885	  1886	  1887	  1888
	  1889	  1890	  1891	  1892	  1895#	  1898	  1899	  1900	  1901	  1902	  1903	  1904	  1905	  1908#
	  1910	  1911	  1912	  1913	  1914	  1915	  1916	  1917	  1921#	  1923	  1924	  1925	  1926	  1927
	  1928	  1929	  1930	  1933#	  1935	  1936	  1937	  1938	  1939	  1940	  1941	  1942	  2107#
XP	    71	    72	    73	    74	    75	    76	    77	    78	    86	  1096	  1097	  1098	  1099	  1100
	  1101	  1837	  1838	  1839	  1840	  1841	  1842	  1843	  1844	  1845  I@s
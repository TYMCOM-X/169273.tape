CIOPR UUO TO FIDDLE WITH COMMUNICATIONS INTERFACE.	MACRO 12.5-46.0 15:04 13-JAN-88 PAGE 1
S.MAC	13-JAN-88 11:55		S.MAC - with system parameter file for P035/D, January 1988

     1				SUBTTL	S.MAC - with system parameter file for P035/D, January 1988
     2
     3				IF2,<IFNDEF LISTSN,<TAPE>>	;Skip to PASS2 in all but COMMON.LST
     4				;THIS MODULE ASSEMBLED WITH FOONLY PARAMETER FILE - F3SYM.MAC
     5
     6					IF2,<IFNDEF LISTSN,<		;LIST F3SYM.MAC IN COMMON ONLY
     7								TAPE>>
     8				TITLE CIOPR UUO TO FIDDLE WITH COMMUNICATIONS INTERFACE.
     9
    10					STOPCD(,ENTRY,CIOPR)^
    11					ENTRY	CIOPR		;For library searches
    12	000000'	260040	000000*	CIOPR::PUSHJ	P,DIE		;**** Default stopcode for "CIOPR" ****
    13	000001'	435157	606200		SIXBIT	/CIOPR/  	;Title of module
    14	000002'	000000	000000		S$NONAME,,0		;?NONAME stopcode "CIOPR+nnn(nnnnnn)"
    15			000000'	S$NAME==CIOPR			;For STOPCDs with no arguments
    16					SALL>
    17				^
    18					lall
    19
    20				;(who is JMS? Joseph M Smith did not work for TYMSHARE in 1980)
    21				; **jms4480** KMC SUPPORT FOR NODLOD.SAI ADDED 4-4-1980 /JMS
    22				; **gl 7180** PROTECTIVE CODE FOR UNEXPECTED INTERRUPTS
    23				; **lb 7780** SET/CLEAR MANUAL DOWN FLAG WHEN LOADING DRS
    24
    25				EXTERNAL CPOPJ,CPOPJ1
    26
    27				;Enter here from UUOCON
    28
    29	000003'			CI.OPR::UMOVE	T1,(W)		;FUNCTION,,ADR OF ARG BLOCK
    30				XCTFU	<MOVE T1,(W)		>^SALL
    31	000003'	256200	000145'
    32	000004'	554340	000006		HLRZ	T2,T1		;T2:=FUNCTION CODE
    33	000005'	303340	000005		CAILE	T2,DLFTL-1	;IN RANGE?
    34					 JRST	[SETO T1,
    35	000006'	254000	000146'			 JRST DLEE]
    36	000007'	256007	000013'		XCT	DLFT(T2)	;YES, PERFORM FUNCTION.
    37	000010'	354001	000000		 AOSA (P)		;SUCCESS
    38	000011'	256200	000150'	DLEE:	  UMOVEM T1,(W)		;ERROR CODE FOR USER.
    39	000012'	263040	000000		POPJ P,
    40
    41
    42				IFCPU (KS),<	;ENDS ON LAST PAGE.
    43									; Default definition to JFCL
    44					DEFINE KMCMDN,<JFCL 0>
    45					DEFINE KMCMUP,<JFCL 0>
    46				
    47				IFKMC<					; If this is for a KMC system
    48				  IFDEF KMCVEC,<			;   and the KMC is defined
    49					DEFINE KMCMDN,<PUSHJ P,KMCSMN##>
    50					DEFINE KMCMUP,<PUSHJ P,KMCCMN##>>>
    51				
    52				;DR11C hardware parameters.
    53				
CIOPR UUO TO FIDDLE WITH COMMUNICATIONS INTERFACE.	MACRO 12.5-46.0 15:04 13-JAN-88 PAGE 1
CIOPR.MAC	17-SEP-87 16:44		S.MAC - with system parameter file for P035/D, January 1988

    54				DEFINE IOREG(REGISTERNAME,OFFSET,BITNAMES,MSB),<
    55				 BIT==100000
    56				IFNB <MSB>,<BIT==MSB>
    57				DR'REGISTERNAME==OFFSET
    58				IRP BITNAMES,<REGISTERNAME'BITNAMES==BIT
    59				              BIT==BIT/2>
    60				>
    61				
    62				IOREG(CSR,0,<RB,,,,,,,,RA,IEA,IEB,,,,1,0>)
    63				 DRFN==CSR0   ;Data ready for node (set by KS10 after loading OB).
    64				 ODOFS==1	;High vector = dispatch when node's read OB.
    65				 KRFMD==CSR1  ;KS10 ready for more data (set by KS10 after reading IB).
    66				 IROFS==0	;Low vector = dispatch when node's written IB.
    67				IOREG(OB,2)
    68				IOREG(IB,4)
    69				
    70				;Macro to make a DR11c known to the system.
    71				;Since the concatenation operator can't be used outside of
    72				; macro definitions, we have to use the SETxxx macros.
    73				
    74				DEFINE SETBASEADDRESS(N,ADDRESS),<DR'N'BA==ADDRESS>
    75				
    76				DEFINE SETVECTORADDRESS(N,ADDRESS),<DR'N'VL==ADDRESS>
    77				
    78				DEFINE DR11C(BASEADDRESS,VECTORBASE),<
    79				SETBASEADR(\NUMDR,BASEADDRESS)
    80				SETVECTORADDRESS(\NUMDR,VECTORADDRESS)
    81				IF1,<BLOCK 8>
    82				IF2,<DRINTH(\NUMDR)>
    83				NUMDR==NUMDR+1
    84				>
    85				
    86				NUMDR==0
    87				
    88				;macro to protect against & count unexpected dr interrupts. /GL 7-1-80
    89				;  and to move a JSR DX#INT into EPT+base+vec.
    90				DEFINE DRXJSR(N,UBA,VEC),<
    91					JRST	DY'N'CNT+1
    92				DX'N'INT: EXP 0
    93					AOS DX'N'CNT
    94					JEN @DX'N'INT
    95				DX'N'CNT: EXP 0
    96				DY'N'INT: EXP 0
    97					AOS DY'N'CNT
    98					JEN @DY'N'INT
    99				DY'N'CNT: EXP 0
   100					MOVE	T2,EPT+100+UBA	;T2/ BASE VECTOR ADDRESS
   101					MOVE	T1,[JSR DX'N'INT]
   102					MOVEM	T1,VEC'/4(T2)
   103					HRRI	T1,DY'N'INT
   104					MOVEM	T1,VEC'/4+1(T2)
   105				>  ;End of DEFINE DRXJSR
   106				
CIOPR UUO TO FIDDLE WITH COMMUNICATIONS INTERFACE.	MACRO 12.5-46.0 15:04 13-JAN-88 PAGE 1-2
CIOPR.MAC	17-SEP-87 16:44		S.MAC - with system parameter file for P035/D, January 1988

   107				;Insert definitions here.
   108				DR11C(767770,300/4)
   109				DR11C(767760,310/4)		; **jms4480**
   110				DR11C(767750,320/4)		; **jms4480**
   111				DR11C(767740,330/4)		; **jms4480**
   112				
   113				DEFINE DRINTH(N),<	;DR'N interrupt handler
   114				DR'N'IRF:0
   115				DR'N'IR:0
   116					SETOM DR'N'IRF
   117					JEN @DR'N'IR
   118				DR'N'ODF:-1
   119				DR'N'OD:0
   120					SETOM DR'N'ODF
   121					JEN @DR'N'OD
   122				>;DEFINE DRINTH
   123				
   124				DRIVTB:			;Interrupt vector table
   125				DEFINE DRVECL(N) <
   126					DR'N'VL
   127				>
   128				
   129				IF1,<BLOCK NUMDR>
   130				IF2,<
   131				ZZ==0
   132				REPEAT NUMDR,<
   133					DRVECL(\ZZ)
   134				ZZ==ZZ+1
   135				>>
   136				
   137				DRFLTB:			;Flag address table
   138				DEFINE DRFLAG(N) <
   139					DR'N'IRF,,DR'N'ODF
   140				>
   141				IF1,<BLOCK NUMDR>
   142				IF2,<
   143				ZZ==0
   144				REPEAT NUMDR,<
   145					DRFLAG(\ZZ)
   146				ZZ==ZZ+1
   147				>>
   148				
   149				DRBATB:			;Base address table
   150				DEFINE DRBADR(N) <
   151					3,,DR'N'BA
   152				>
   153				IF1,<BLOCK NUMDR>
   154				IF2,<
   155				ZZ==0
   156				REPEAT NUMDR,<
   157					DRBADR(\ZZ)
   158				ZZ==ZZ+1
   159				>>
CIOPR UUO TO FIDDLE WITH COMMUNICATIONS INTERFACE.	MACRO 12.5-46.0 15:04 13-JAN-88 PAGE 1-3
CIOPR.MAC	17-SEP-87 16:44		S.MAC - with system parameter file for P035/D, January 1988

   160				CIOPR UUO TO FIDDLE WITH COMMUNICATIONS INTERFACE.	MACRO 12.5-46.0 15:04 13-JAN-88 PAGE 2
CIOPR.MAC	17-SEP-87 16:44		S.MAC - with system parameter file for P035/D, January 1988

   161				SUBTTL	Dispatch for KS version of CIOPR
   162				
   163				;FUNCTION HANDLERS ARE PASSED ADR OF ARG BLOCK IN T1.RH.
   164				;SINGLE RETURN IF FUNCTION EXECUTED NORMALLY.
   165				;ON ERROR, SKIP RETURN WITH ERROR CODE IN T1.
   166				DLFT:	PUSHJ	P,DLSCI		;0 SELECT COMMUNICATIONS INTERFACE.
   167					PUSHJ	P,DLSEDR	;1 PREPARE DR11C FOR DATA.
   168					PUSHJ	P,DLWDR		;2 WRITE WORD TO DR11C.
   169					PUSHJ	P,DLRDR		;3 READ WORD FROM DR11C.
   170					PUSHJ	P,DLDDR		;4 RELEASE DR11C TO KMC & NEXILIS NODE.
   171					PUSHJ	P,DLKMCD	;5 GIVES ERROR RETURN IF KMCDO IS 0
   172				DLFTL==.-DLFT
   173				
   174				;DLKMCD (FUNCTION 5) - TEST IF KMC IS SELECTED
   175				
   176				DLKMCD:	SKIPN	KMCDO##		;(5) CHECK IF KMCDO IS SET
   177					  AOS	(P)
   178					POPJ	P,
   179				
   180				;DLSCI (FUNCTION 0) - SELECT COMMUNICATIONS INTERFACE.
   181				; ARG 0: INTERFACE TYPE: 0=CTYSIM, 1=DZKON, 2=TYMBASE NODE, 3=DR11C
   182				; **jms4480** THIS FUNCTION DOES NOT ALLOW  FOR MULTIPLE
   183				; **jms4480** DR'S (ALSO DR0 MUST BE USED). TO USE MORE THAN
   184				; **jms4480** 1 DR, THE KMC IS REQUIRED IN WHICH CASE THE (KMC)
   185				; **jms4480** INTERFACE SHOULD BE CLEARED FROM USER LEVEL.
   186				
   187				DLSCI:	PUSHJ	P,DLREI		;REMOVE EXISTING INTERFACES.
   188					UHRRZ	T2,(T1)		;GET INTERFACE TYPE.
   189					CAILE	T2,3
   190					 JRST	DLE0		;ILLEGAL INTERFACE TYPE.
   191					JRST	@.+1(T2)
   192					DLICTY		;0 CTY
   193					DLIDZ		;1 DZ
   194					DLINN		;2 KMC
   195					DLIDR		;3 DR
   196				;*;	DLREI
   197				
   198				;DLREI.  REMOVE LINKS BETWEEN DZKON, CTYSIM AND SYSTEM.
   199				DLREI:	SKIPE	CTYDO##
   200					 JFCL	;**D*	 PUSHJ P,DLRCTY
   201					SKIPE	DZDO##
   202					 PUSHJ	P,DLRDZ
   203					SKIPE	DRDO##
   204					 PUSHJ	P,DLRDRI
   205					SKIPE	KMCDO##
   206					 JFCL			;KMC IS NEVER REMOVED
   207					POPJ	P,
   208				
   209				EXTERNAL EPT,CPOPJ1
   210				
   211				;Remove DR interface
   212				
   213				DLRDRI:	MOVEI	T2,0		;Clear DR0's CSR
CIOPR UUO TO FIDDLE WITH COMMUNICATIONS INTERFACE.	MACRO 12.5-46.0 15:04 13-JAN-88 PAGE 2-2
CIOPR.MAC	17-SEP-87 16:44		S.MAC - with system parameter file for P035/D, January 1988

   214					MOVE	T3,DRBATB	; **jms4480** ONLY DR0 SUPPORTED
   215								; **jms4480** AT THIS LEVEL.
   216					WRIO	T2,DRCSR(T3)
   217					MOVEI	T3,CH7##
   218					MOVEI	T2,CLKDR##
   219					WRPI	LI.PIF
   220					PUSHJ	P,DLUIR		;Unlink CLKDR from CH7
   221					  STOPCD
   222					WRPI	LI.PIN
   223					POPJ	P,
   224				
   225				;Remove CTY interface
   226				
   227				DLRCTY:	MOVEI	T3,CH7##
   228					MOVEI	T2,CH7LK##
   229					WRPI	LI.PIF
   230					PUSHJ	P,DLUIR		;Unlink CH7LK from CH7
   231					  STOPCD
   232					MOVEI	T3,CH6##
   233					MOVEI	T2,CH6LK##
   234					PUSHJ	P,DLUIR		;Unlink CH6LK from CH6
   235					  STOPCD
   236					MOVEI	T3,CH6##
   237					MOVEI	T2,CH6KST##
   238					PUSHJ	P,DLUIR		;Unlink CH6KST from CH6
   239					  STOPCD
   240					SETZM	CTYDO##
   241					WRPI	LI.PIN
   242					POPJ	P,
   243				
   244				;Remove DZ interface
   245				
   246				DLRDZ:	WRPI	LI.PIF
   247					PUSHJ	P,DZREM##	;TURN OFF DZ11S.
   248					MOVEI	T3,CH7##
   249					MOVEI	T2,DZPINT##
   250					PUSHJ	P,DLUIR		;Unlink DZPINT from CH7
   251					  STOPCD
   252					MOVEI	T3,CH6##
   253					MOVEI	T2,PERINT##
   254					PUSHJ	P,DLUIR		;Unlink PERINT from CH6
   255					  STOPCD
   256					MOVEI	T3,CH6##
   257					MOVEI	T2,CONINT##
   258					PUSHJ	P,DLUIR		;Unlink CONINT from CH6
   259					  STOPCD
   260					SETZM	DZDO##
   261					WRPI	LI.PIN
   262					POPJ	P,
   263				
   264				;DLUIR.  UNLINK INTERRUPT ROUTINE WHOSE ADDRESS IS IN
   265				; T2 FROM CHAIN ON CHANNEL IN T3.
   266				;SINGLE RETURN IF COULDN'T FIND THE ROUTINE.  OTHERWISE
CIOPR UUO TO FIDDLE WITH COMMUNICATIONS INTERFACE.	MACRO 12.5-46.0 15:04 13-JAN-88 PAGE 2-3
CIOPR.MAC	17-SEP-87 16:44		S.MAC - with system parameter file for P035/D, January 1988

   267				; SKIP AFTER UNLINKING IT.
   268				DLUIR:	SKIPA	P2,T3		;Unlink Interrupt Routine
   269				DLUIR0:	 SKIPA	T3,T4		;PREVIOUS:=CURRENT
   270					  HRRZI	T4,(T3)		;T3:=PREVIOUS
   271					HRRZ	T4,1(T4)	;T4:=CURRENT
   272					CAIN	T4,(P2)		;LOOPED AROUND?
   273					 POPJ	P,		;YEP, DIDN'T FIND IT.
   274					CAIE	T4,(T2)
   275					 JRST	DLUIR0
   276				DLUIR1:	MOVE	T4,1(T4)	;PREVIOUS.NEXT:=CURRENT.NEXT.
   277					MOVEM	T4,1(T3)
   278					JRST	CPOPJ1
   279				
   280				;Install DR11C interface to NEXILIS node
   281				
   282				DLIDR:	WRPI	LI.PIF
   283					SETOM	DRDO##
   284					PUSHJ	P,DRINI##
   285					WRPI	LI.PIN
   286					POPJ	P,
   287				
   288				;Install CTY interface
   289				
   290				DLICTY:	WRPI	LI.PIF
   291					SETOM	CTYDO##
   292					SETOM	NOWIN##		;SAY PORT LOGGED IN.
   293					PUSHJ	P,CTYSET##
   294					WRPI	LI.PIN
   295					POPJ	P,
   296				
   297				;Install DZ-11 driver interface
   298				
   299				DLIDZ:	WRPI	LI.PIF
   300					SETOM	DZDO##
   301					PUSHJ	P,DZINI##
   302					WRPI	LI.PIN
   303					POPJ	P,
   304				
   305				;Install KMC to NEXILIS node interface
   306				
   307				DLINN:
   308				;*;	SETOM	KMCDO##		;ASSUME KMCDO IS ALREADY SET
   309					POPJ	P,
   310				
   311				;DLWDR (FUNCTION 2) - WRITE WORD TO SELECTED DR11C.
   312				; ARG 0: DR11C#,,16 BIT WORD TO SEND
   313				DLWDR:	PUSHJ	P,DLSDR		;GET DR11C BASE ADDRESS.
   314					  JRST	CPOPJ1		;ERROR.
   315					HRRZ	T4,DRFLTB(T2)	;SEE IF PREVIOUS OUTPUT TAKEN.
   316					SKIPN	(T4)
   317					 JSP	T1,DLWAIT
   318					WRPI	LI.PIF
   319					SETZM	(T4)		;CLEAR TAKEN FLAG.
CIOPR UUO TO FIDDLE WITH COMMUNICATIONS INTERFACE.	MACRO 12.5-46.0 15:04 13-JAN-88 PAGE 2-4
CIOPR.MAC	17-SEP-87 16:44		S.MAC - with system parameter file for P035/D, January 1988

   320					WRIO	T3,DROB(P1)	;SEND WORD
   321					MOVEI	T3,DRFN
   322					BCIO	T3,DRCSR(P1)
   323					BSIO	T3,DRCSR(P1)	;TELL DR NEW DATA IS READY
   324					WRPI	LI.PIN
   325					POPJ	P,
   326				
   327				;DLRDR (FUNCTION 3) - READ WORD FROM SELECTED DR11C.
   328				; ARG 0: DR11C #,,ADR TO RECEIVE WORD READ.
   329				DLRDR:	PUSHJ	P,DLSDR		;GET DR11C BASE ADDRESS.
   330					  JRST	CPOPJ1		;ERROR.
   331					HLRZ	T4,DRFLTB(T2)	;CHECK IF PREVIOUS INPUT RECEIVED.
   332					SKIPN	(T4)
   333					 JSP	T1,DLWAIT
   334					WRPI	LI.PIF
   335					SETZM	(T4)		;CLEAR FLAG.
   336					RDIO	T4,DRIB(P1)	;GET WORD
   337					UMOVEM	T4,(T3)		;GIVE IT TO USER
   338					MOVEI	T4,KRFMD
   339					BCIO	T4,DRCSR(P1)
   340					BSIO	T4,DRCSR(P1)	;TELL DR INPUT HAS BEEN READ
   341					WRPI	LI.PIN
   342					POPJ	P,
   343				
   344				;DLSEDR (FUNCTION 1) - SELECT DR11C FOR USE BY THE 2020.
   345				; ARG 0: DR11C #,,0
   346				DLSEDR:	PUSHJ	P,DLSDR		;GET HANDLES ON DR11C
   347					 JRST	CPOPJ1		;ERROR.
   348					MOVE	T1,T2		;SET UP T1 FOR SETTING MANUAL DOWN FLAG
   349					SKIPE	KMCDO##		;DONT SET IF NO KMC
   350					  KMCMDN		;SET DR MANUALLY DOWN
   351					HRRZ	T4,EPT+103	;SETUP INTERRUPT VECTORS.
   352					ADD	T4,DRIVTB(T2)
   353					HLRZ	T1,DRFLTB(T2)
   354					ADD	T1,[JSR 1]
   355					MOVEM	T1,IROFS(T4)
   356					HRRZ	T1,DRFLTB(T2)
   357					ADD	T1,[JSR 1]
   358					MOVEM	T1,ODOFS(T4)
   359					MOVEI	T1,CSRIEA+CSRIEB ;ENABLE BOTH INTERRUPTS
   360					WRIO	T1,DRCSR(P1)
   361					MOVEI	T1,^D1000	;GIVE IT A CHANCE TO INTERRUPT
   362					SOJG	T1,.		;ASSUME NO INT PENDING AFTER THIS.
   363					HLRZ	T4,DRFLTB(T2)	;CLEAR INPUT READY FLAG
   364					SETZM	(T4)
   365					HRRZ	T4,DRFLTB(T2)	;SET DR11C READY FOR OUR OUTPUT FLAG
   366					SETOM	(T4)
   367					POPJ	P,
   368				
   369				;DLDDR (FUNCTION 4) - DESELECT DR11C.
   370				; ARG 0: DR11C #,,0
   371				DLDDR:	PUSHJ P,DLSDR		;GET HANDLES ON DR11C
   372					 JRST CPOPJ1		;ERROR.
CIOPR UUO TO FIDDLE WITH COMMUNICATIONS INTERFACE.	MACRO 12.5-46.0 15:04 13-JAN-88 PAGE 2-5
CIOPR.MAC	17-SEP-87 16:44		S.MAC - with system parameter file for P035/D, January 1988

   373					HRRZ T4,DRFLTB(T2)	;MAKE SURE LAST OUTPUT TAKEN.
   374					MOVEI P2,-1		;SET COUNT OF 777777
   375				DLDDR1:	SKIPN (T4)		;CHECK FOR DATA ACCEPTED
   376					 SOJG P2,DLDDR1		;KEEP TRYING
   377					MOVEI T1,0		;DISABLE INTERRUPTS
   378					WRIO T1,DRCSR(P1)
   379					SKIPN (T4)
   380					 JSP T1,DLWAIT
   381					MOVE T1,T2		
   382					SKIPE	CTYDO##
   383					  POPJ	P,		;IF RUNNING FORM CONSOLE QUIT NOW.
   384					SKIPN KMCDO##		;DONT REINSTALL DR DRIVER IF KMC ACTIVE
   385					 PUSHJ P,DLIDR		;REINSTALL DR11C DRIVER
   386					SKIPE KMCDO##		;DO CLEAR MANUAL DOWN FLAG IF KMC ACTIVE
   387					 KMCMUP			;"MANUALLY UP"
   388					POPJ P,			;WITH OR WITHOUT KMC
   389					POPJ P,
   390				
   391				;DLSDR.  LOAD P1 WITH BASE ADDRESS OF DR11C SPECIFIED BY USER.
   392				; IN ARG 0.  SKIP IF LEGAL DR11C, SINGLE RETURN OTHERWISE.
   393				; T3.RH HAS ARG0.RH.  T2 HAS DR11C NUMBER.
   394				DLSDR:	UMOVE T3,(T1)
   395					HLRZ T2,T3		;DR11C NUMBER
   396					CAILE T2,NUMDR-1
   397					 JRST DLE0		;ILLEGAL DR11C NUMBER.
   398					MOVE P1,DRBATB(T2)	;T2:=DR11C BASE ADDRESS.
   399					JRST CPOPJ1
   400				
   401				;DLWAIT.  WAIT UNTIL PREDICATE TRUE (SKIPS).  PUT PREDICATE
   402				; BEFORE JSP T1,DLWAIT.  IF PREDICATE FAILS, SLEEPS FOR
   403				; A WHILE, THEN TRIES AGAIN.  UP TO 100 TRIES ARE ALLOWED.
   404				DLWAIT:	MOVEI P2,-1
   405				DLWT1:	MOVEI P3,2		;RESCHEDULE
   406				;	SLEEP P3,	;**D* REMOVED ??
   407					XCT -2(T1)		;EXECUTE TEST INSTRUCTION
   408					 SOJG P2,DLWT1		;RE EXECUTE LOOP IF TEST FAILED
   409					JUMPE P2,DLE1		;GO HANDLE ERROR IF P2 WENT TO ZERO
   410					JRST (T1)		;TEST SUCCEEDED-  RETURN TO CALLER
   411				
   412				;ROUTINES FOR RETURNING ERROR CODES.
   413				DLE0:	JSP T1,DLERR
   414				DLE1:	JSP T1,DLERR
   415				DLE2:	JSP T1,DLERR
   416				DLERR:	HRRZI T1,-DLE0+1(T1)
   417					JRST CPOPJ1
   418				
   419				;ROUTINE TO SETUP EPT FOR DR INTERRUPT PROTECTION. /GL 7-1-80
   420				DRPROT::		;DESTROYS T1
   421					DRXJSR(1,3,300)		;DR#,UBA#,11VECTOR
   422					DRXJSR(2,3,310)
   423					DRXJSR(3,3,320)
   424					DRXJSR(4,3,330)
   425					POPJ	P,
CIOPR UUO TO FIDDLE WITH COMMUNICATIONS INTERFACE.	MACRO 12.5-46.0 15:04 13-JAN-88 PAGE 2-6
CIOPR.MAC	17-SEP-87 16:44		S.MAC - with system parameter file for P035/D, January 1988

   426				
   427				> ;END IFCPU (KS) STARTING PAGE 1.
CIOPR UUO TO FIDDLE WITH COMMUNICATIONS INTERFACE.	MACRO 12.5-46.0 15:04 13-JAN-88 PAGE 3
CIOPR.MAC	17-SEP-87 16:44		Dispatch for F3 version of CIOPR

   428				SUBTTL	Dispatch for F3 version of CIOPR
   429
   430				IFCPU (F3),<
   431				;FUNCTION HANDLERS ARE PASSED ADR OF ARG BLOCK IN T1.RH.
   432				;SINGLE RETURN IF FUNCTION EXECUTED NORMALLY.
   433				;ON ERROR, SKIP RETURN WITH ERROR CODE IN T1.
   434	000013'	260040	000026'	DLFT:	PUSHJ	P,DLSCI		;0 SELECT COMMUNICATIONS INTERFACE.
   435	000014'	260040	000043'		PUSHJ	P,DLSEDR	;1 PREPARE DR11C FOR DATA.
   436	000015'	260040	000061'		PUSHJ	P,DLWDR		;2 WRITE WORD TO DR11C.
   437	000016'	260040	000077'		PUSHJ	P,DLRDR		;3 READ WORD FROM DR11C.
   438	000017'	260040	000115'		PUSHJ	P,DLDDR		;4 RELEASE DR11C TO KMC & NEXILIS NODE.
   439	000020'	260040	000133'		PUSHJ	P,DLKMCD	;5 GIVES ERROR RETURN IF KMCDO IS 0
   440			000006	DLFTL==.-DLFT
   441
   442				;ERROR CODE RETURNS
   443	000021'	265300	000024'	ERRET0:	JSP T1,ERRETN	;ERROR RETURN WITH T1/ ERROR CODE
   444	000022'	265300	000024'	ERRET1:	JSP T1,ERRETN
   445	000023'	265300	000024'	ERRET2:	JSP T1,ERRETN
   446	000024'	551306	000000*	ERRETN:	HRRZI T1,-ERRET0+1(T1)
   447	000025'	254000	000000*		JRST CPOPJ1
   448
   449
   450
   451	000256200	000151'	DLSCI:	UHRRZ	T2,(T1)		;(0) GET INTERFACE TYPE
   452	000027'	402000	000006		SETZM	T1
   453	000030'	302340	000002		CAIE	T2,2		;ONLY TYMBASE IS LEGAL
   454	000031'	254000	000021'		 JRST	ERRET0		;ERROR RETURN 0
   455	000032'	263040	000000		POPJ	P,		;NON-ERROR RETURN
   456				repeat 10,<jfcl>
   457	000033'	255000	000000
   458	000034'	255000	000000
   459	000035'	255000	000000
   460	000036'	255000	000000
   461	000037'	255000	000000
   462	000040'	255000	000000
   463	000041'	255000	000000
   464	000042'	255000	000000
   465
   466	000043'	256200	000152'	DLSEDR:	UMOVE	T3,(T1)	        ;(1) SELECT DR
   467	000044'	402000	000006		SETZM	T1
   468	000045'	554340	000010		HLRZ	T2,T3		;/T2 INTERFACE NUMBER
   469	000046'	302340	000000		CAIE	T2,0		;ONLY ALLOWED TO SELECT DR 0
   470	000047'	254000	000021'		 JRST ERRET0
   471	000050'	263040	000000		POPJ P,
   472				repeat 10,<jfcl>
   473	000051'	255000	000000
   474	000052'	255000	000000
   475	000053'	255000	000000
   476	000054'	255000	000000
   477	000055'	255000	000000
   478	000056'	255000	000000
   479	000057'	255000	000000
   480	000060'	255000	000000
CIOPR UUO TO FIDDLE WITH COMMUNICATIONS INTERFACE.	MACRO 12.5-46.0 15:04 13-JAN-88 PAGE 3-2
CIOPR.MAC	17-SEP-87 16:44		Dispatch for F3 version of CIOPR

   481
   482	000061'	256200	000152'	DLWDR:	UMOVE	T3,(T1)		;(2) WRITE TO DR
   483	000062'	402000	000006		SETZM	T1
   484	000063'	554340	000010		HLRZ	T2,T3		;/T2 INTERFACE NUMBER
   485	000064'	302340	000000		CAIE	T2,0
   486	000065'	254000	000021'		 JRST	ERRET0
   487				PRINTF	(<[No code to let F3 load its own base]>)
   488	000066'	263040	000000		POPJ	P,		;NOOP
   489				repeat 10,<jfcl>
   490	000067'	255000	000000
   491	000070'	255000	000000
   492	000071'	255000	000000
   493	000072'	255000	000000
   494	000073'	255000	000000
   495	000074'	255000	000000
   496	000075'	255000	000000
   497	000076'	255000	000000
   498
   499	000077'	256200	000152'	DLRDR:	UMOVE	T3,(T1)		;(3) READ FROM DR
   500	000100'	402000	000006		SETZM	T1
   501	000101'	554340	000010		HLRZ	T2,T3		;/T2 INTERFACE NUMBER
   502	000102'	302340	000000		CAIE	T2,0
   503	000103'	254000	000021'		 JRST	ERRET0
   504	000104'	263040	000000		POPJ	P,		;NOOP
   505				repeat 10,<jfcl>
   506	000105'	255000	000000
   507	000106'	255000	000000
   508	000107'	255000	000000
   509	000110'	255000	000000
   510	000111'	255000	000000
   511	000112'	255000	000000
   512	000113'	255000	000000
   513	000114'	255000	000000
   514
   515	000115'	256200	000152'	DLDDR:	UMOVE	T3,(T1)		;(4) DONE WITH DR
   516	000116'	402000	000006		SETZM	T1
   517	000117'	554340	000010		HLRZ	T2,T3		;/T2 INTERFACE NUMBER
   518	000120'	302340	000000		CAIE	T2,0
   519	000121'	254000	000021'		 JRST	ERRET0
   520	000122'	263040	000000		POPJ	P,		;NOOP
   521				repeat 10,<jfcl>
   522	000123'	255000	000000
   523	000124'	255000	000000
   524	000125'	255000	000000
   525	000126'	255000	000000
   526	000127'	255000	000000
   527	000130'	255000	000000
   528	000131'	255000	000000
   529	000132'	255000	000000
   530
   531	000133'	476000	000006	DLKMCD:	SETOM	T1		;(5) CHECK IF KMCDO IS SET
   532	000134'	254000	000025*		JRST	CPOPJ1		;SKIP RETURN FOR ERROR (NO KMC ON F3s)
   533				repeat 10,<jfcl>
CIOPR UUO TO FIDDLE WITH COMMUNICATIONS INTERFACE.	MACRO 12.5-46.0 15:04 13-JAN-88 PAGE 3-3
CIOPR.MAC	17-SEP-87 16:44		Dispatch for F3 version of CIOPR

   534	000135'	255000	000000
   535	000136'	255000	000000
   536	000137'	255000	000000
   537	000140'	255000	000000
   538	000141'	255000	000000
   539	000142'	255000	000000
   540	000143'	255000	000000
   541	000144'	255000	000000
   542
   543				>  ;End IFCPU(F3)
   544
   545	000145'	200312	000000		$END	(CIO)

   546	000146'	474300	000000

   547	000147'	254000	000011'

   548	000150'	202312	000000

   549	000151'	550346	000000

   550	000152'	200406	000000

   551						;End of CIOSER (CIOLIT: CIOEND:)
   552
NO ERRORS DETECTED
PROGRAM BREAK IS 000153
6K CORE USED
CIOPR UUO TO FIDDLE WITH COMMUNICATIONS INTERFACE.	MACRO 12.5-46.0 15:04 13-JAN-88 PAGE 4
CIOPR.MAC	17-SEP-87 16:44		SYMBOL TABLE

CI.OPR		000003'	INT	
CIOEND		000152'	INT	
CIOLIT		000145'	INT	
CIOPR		000000'	ENT	
CPOPJ		000000	EXT	
CPOPJ1		000134'	EXT	
CPUF3		000004	SPD	
CPUKS		000003	SPD	
CPUTYP		000004	SPD	
CPZZ		000001	SPD	
DIE		000000'	EXT	
DLDDR		000115'		
DLEE		000011'		
DLFT		000013'		
DLFTL		000006	SPD	
DLKMCD		000133'		
DLRDR		000077'		
DLSCI		000026'		
DLSEDR		000043'		
DLWDR		000061'		
ERRET0		000021'		
ERRET1		000022'		
ERRET2		000023'		
ERRETN		000024'		
NODIE		000000	EXT	
P		000001	INT	
PX.MEM		000004	SPD	
PXCT	256000	000000		
S$ENTR	777777	777775	SIN	
S$HALT	777777	777777	SIN	
S$NAME		000000'	SPD	
S$NONA		000000	SIN	
S$TEMP	777775	000000	SPD	
S$XCT	777777	777776	SIN	
T1		000006	INT	
T2		000007	INT	
T3		000010	INT	
W		000012	INT	
ZZ	000055	576645	SPD	

CIOPR UUO TO FIDDLE WITH COMMUNICATIONS INTERFACE.	MACRO 12.5-46.0 15:04 13-JAN-88
CIOPR.MAC	17-SEP-87 16:44		Symbol cross reference

CI.OPR	    29#
CIOEND	   551#
CIOLIT	   545#
CIOPR	    11	    12#	    15
CPOPJ	    25%
CPOPJ1	    25%	   447	   532
CPUF3	   430
CPUKS	    42
CPUTYP	    42	   430
CPZZ	    42#	    42	   430#	   430
DIE	    11	    11%	    12
DLDDR	   438	   515#
DLEE	    35	    38#
DLFT	    36	   434#	   440
DLFTL	    33	   440#
DLKMCD	   439	   531#
DLRDR	   437	   499#
DLSCI	   434	   451#
DLSEDR	   435	   466#
DLWDR	   436	   482#
ERRET0	   443#	   446	   454	   470	   486	   503	   519
ERRET1	   444#
ERRET2	   445#
ERRETN	   443	   444	   445	   446#
GINST	    31#	    31	    32	    38#	    38	    39	   451#	   451	   452	   466#	   466	   467	   482#	   482
	   483	   499#	   499	   500	   515#	   515	   516
LISTSN	     3	     6
NODIE	    11%
P	    12	    37	    39	   434	   435	   436	   437	   438	   439	   455	   471	   488	   504	   520
PX.MEM	    31	    38	   451	   466	   482	   499	   515
S$ENTR	    11	    17
S$HALT	    11
S$NAME	    15#
S$NONA	    14	    17
S$TEMP	    11#	    11
S$XCT	    17
T1	    31	    32	    34	    38	   443	   444	   445	   446	   451	   452	   466	   467	   482	   483
	   499	   500	   515	   516	   531
T2	    32	    33	    36	   451	   453	   468	   469	   484	   485	   501	   502	   517	   518
T3	   466	   468	   482	   484	   499	   501	   515	   517
W	    31	    38
ZZ	    31#	    31	    38#	    38	   451#	   451	   466#	   466	   482#	   482	   499#	   499	   515#	   515
ZZ1	    31#	    31	    38#	    38	   451#	   451	   466#	   466	   482#	   482	   499#	   499	   515#	   515
CIOPR UUO TO FIDDLE WITH COMMUNICATIONS INTERFACE.	MACRO 12.5-46.0 15:04 13-JAN-88
CIOPR.MAC	17-SEP-87 16:44		Macro/Opdef cross reference

IFCPU	    42	   430
PRINTF	   487
PXCT	    31	    38	   451	   466	   482	   499	   515
PXGEN	    31	    38	   451	   466	   482	   499	   515
STOPCD	    10
UHRRZ	   451
UMOVE	    29	   466	   482	   499	   515
UMOVEM	    38
XCTBU	   451
XCTFU	    30	   466	   482	   499	   515
XCTTU	    38
$END	   545 8*
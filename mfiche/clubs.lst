CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 1
S.MAC	13-JAN-88 11:55		S.MAC - with system parameter file for P035/D, January 1988

     1				SUBTTL	S.MAC - with system parameter file for P035/D, January 1988
     2
     3				IF2,<IFNDEF LISTSN,<TAPE>>	;Skip to PASS2 in all but COMMON.LST
     4				;THIS MODULE ASSEMBLED WITH KL-10 PARAMETER FILE - KLSYM.MAC
     5
     6					IF2,<IFNDEF LISTSN,<		;LIST KLSYM.MAC IN COMMON ONLY
     7								TAPE>>
     8				TITLE	CLUBS	UUOS FOR CLUBS
     9
    10					STOPCD(,ENTRY,CLUBS)^
    11					ENTRY	CLUBS		;For library searches
    12	000000'	260040	000000*	CLUBS::PUSHJ	P,DIE		;**** Default stopcode for "CLUBS" ****
    13	000001'	435465	426300		SIXBIT	/CLUBS/  	;Title of module
    14	000002'	000000	000000		S$NONAME,,0		;?NONAME stopcode "CLUBS+nnn(nnnnnn)"
    15			000000'	S$NAME==CLUBS			;For STOPCDs with no arguments
    16					SALL>
    17				^
    18
    19				;KAREN KOLLING		FEBRUARY 1978
    20				;MURRAY BOWLES		OCTOBER 1978 (MULTIPLE CLUBS PER JOB)
    21
    22				;EXTERNALS
    23
    24				EXTERN JBTCLB
    25				EXTERN %UPLMA,LMMEXS,LMPMXW
    26				EXTERN FCREQ,GETWDS,FCWAIT,GIVWDS
    27				EXTERN JBTSTS,PJBSTS,SETRUN,WSCHED,ISQ,JBTQ,ILWQ
    28				EXTERN HNGMON,JBYWAK,TAKTRP,JBTAWQ,ABTUUO
    29				EXTERN PUUOAC,CPOPJ,CPOPJ1,TPOPJ,RBREAL,GETDPA,JOB,RBMASK
    30
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 2
CLUBS.MAC	17-SEP-87 16:45		CLUB DATA BASE

    31				SUBTTL CLUB DATA BASE
    32
    33				;CLUB MEMBERSHIP CARD (CMC) -- EACH JOB BELONGING TO A CLUB HAS
    34				;  A MEMBERSHIP CARD FOR THAT CLUB. EACH MEMBERSHIP CARD HAS TWO
    35				;  DOUBLY-LINKED LISTS RUNNING THROUGH IT: A LIST OF ALL THE
    36				;  MEMBERSHIP CARDS HELD BY THE JOB HOLDING THE CARD, AND A
    37				;  LIST OF ALL THE MEMBERSHIP CARDS FOR THE CLUB.
    38
    39	000000			PHASE 0
    40
    41	000003'	000000	000000	CMCCLK::!	0	;PREV,,NEXT CMC FOR THIS CLUB (0 FOR END OF LIST)
    42
    43	000004'	000000	000000	CMCJLK::!	0	;PREV,,NEXT CMC FOR THIS JOB (0 FOR END OF LIST)
    44
    45	000002			CMCSTS::!		;IN LH
    46			400000	 CM.FRC==(1B0)	;1ST-CLASS CLUB MEMBER
    47			376000	 CM.UNU==(177B7)	;UNUSED BITS OF STATUS FIELD
    48	000002			CMCJOB::!		;ALSO IN LH
    49			001777	 CM.JMK==(1777B17)	;MASK FOR JOB
    50	000005'	000000	000000	CMCCDB::! 0	;RH=CDB ADDR
    51
    52	000003			CMCVPG::!
    53			000010	 CMNVPG==^D8
    54			000011	 CMSVPG==^D9
    55	000006'	000000	000000	CMCCID::! 0
    56			000043	 CMNCID==^D35
    57			000033	 CMSCID==^D27
    58
    59			000004	LENCMC==.-CMCCLK
    60	000007'			DEPHASE
    61
    62	000007'	331106	000003	CMYVPG:	POINT CMSVPG,CMCVPG(T1),CMNVPG
    63	000010'	003306	000003	CMYCID:	POINT CMSCID,CMCCID(T1),CMNCID
    64
    65				;CLUB DATA BLOCK (CDB) -- EACH CLUB HAS A DATA BLOCK, WHICH DESCRIBES
    66				;  THE STATUS OF THE CLUB
    67
    68	000000			PHASE 0
    69
    70	000011'	000000	000000	CDBRET::!	0	;RETRIEVAL POINTER FOR CLUB PAGE
    71	000001			CDBLOK::!		;LH = CMC ADDR OF INTERLOCKER, OR 0 IF NOT INTERLOCKED
    72	000012'	000000	000000	CDBCMC::!	0	;RH = ADDR OF FIRST CMC FOR THIS CLUB
    73	000002			CDBSTS::!		;LH = STATUS BITS
    74			200000		CD.NML==200000	;1 IF LAST INTERLOCK RELEASE WAS NORMAL
    75							;(INITIALLY 0 FOR A NEW CLUB)
    76			100000		CD.EVI==100000	;1 IF THIS CLUB HAS EVER BEEN INTERLOCKED
    77	000013'	000000	000000	CDBHLK::!	0	;RH = HASH LINK (0 OR ADDR OF NEXT CDB IN BUCKET)
    78	000014'	000000	000000	CDBCID::!	0	;LAST JOB-WITHIN-CLUB ID GIVEN OUT
    79
    80			000004	LENCDB==.-CDBRET
    81	000015'			DEPHASE
    82
    83				;LOCATION WHICH COUNTS NUMBER OF TIMES SOMEONE LEFT CLUB.
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 2-2
CLUBS.MAC	17-SEP-87 16:45		CLUB DATA BASE

    84				; USED FOR MAKING SURE THAT NO ONE HAS LEFT CLUB WHILE IN
    85				; PROCESS OF SCANNING CMCS TO RETURN CLUB IDS IN CLBMEM
    86				; UUO. IF COUNTER CHANGES WHILE IN CLBMEM SCANNING ROUTINE,
    87				; CMC CHAIN HAS BEEN CHANGED AND MUST START THE SCAN OVER.
    88
    89	000015'	000000	000000	LVCCNT:	0
    90
    91				;CLBTBL IS A HSHCLB-LONG HASH TABLE MAPPING A DISK ADDRESS ONTO
    92				;  THE ADDRESS OF THE FIRST CDB FOR THAT HASH CODE (OR 0 IF THERE
    93				;  IS NONE)
    94
    95			000013	HSHCLB==^D11
    96	000016'			CLBTBL:	BLOCK HSHCLB
    97
    98				;JBTCLB IS A JOB TABLE MAPPING A JOB NUMBER ONTO THE ADDRESS OF
    99				;  THE FIRST CMC FOR THAT JOB (OR 0 IF THERE IS NONE)
   100
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 3
CLUBS.MAC	17-SEP-87 16:45		CLUB UUO ERROR CODES

   101				SUBTTL CLUB UUO ERROR CODES
   102
   103			000001	ERRVPR==:1	;VP NUMBER OUT OF LEGAL RANGE.
   104
   105			000002	ERRNEX==:2	;VP HAS NO DISK PAGE MAPPED INTO IT (DOES NOT
   106						;EXIST.).
   107
   108			000003	ERRINC==:3	;JOB IS ALREADY IN A CLUB FOR THIS VP
   109
   110			000004	ERRIDO==:4	;THIS CLUB'S ID NUMBER WOULD OVERFLOW IF
   111						;ANOTHER JOB WERE ADDED TO IT.
   112
   113			000005	ERRNIC==:5	;YOU MUST BE IN A CLUB TO EXECUTE THIS UUO,
   114						;AND YOU ARE NOT IN ANY CLUB.
   115
   116			000006	ERRVPM==:6	;VP MISMATCH.  (THE VP SPECIFIED IS NOT THE VP
   117						;THROUGH WHICH YOU ENTERED ANY OF THE CLUBS YOU'RE
   118						;NOW IN)
   119
   120			000007	ERRHIL==:7	;THIS UUO CANNOT BE EXECUTED BECAUSE YOU HAVE
   121						;THE CLUB INTERLOCK.
   122
   123			000010	ERRAIL==:10	;VALID ATTEMPT TO GET INTERLOCK, BUT IT IS BUSY.
   124
   125			000011	ERRNIL==:11	;ATTEMPT TO RELEASE INTERLOCK WHEN YOU DON'T
   126						;HAVE IT.
   127
   128			000012	ERRCNT==:12	;REQUESTED COUNT OF CLUB MEMBERS IS <0.
   129
   130			000013	ERRNFC==:13	;THIS UUO CAN ONLY BE EXECUTED BY FIRST CLASS
   131						;MEMBERS OF THE CLUB, AND YOU ARE ONLY A
   132						;SECOND CLASS MEMBER.
   133
   134			000014	ERRJNI==:14	;ATTEMPT TO PERFORM AN OPERATION ON OR GET
   135						;INFORMATION ABOUT A JOB WHICH IS NOT IN YOUR
   136						;CLUB.
   137
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 4
CLUBS.MAC	17-SEP-87 16:45		CLUB UUO COMMON DISPATCH CODE

   138				SUBTTL CLUB UUO COMMON DISPATCH CODE
   139				COMMENT #
   140				@@SUBROUTINE KCBKER
   141				@@PURPOSE
   142				KERNEL SUBR FOR THE VARIOUS CLUB UUOS.
   143				@@ENTRY
   144				EXPECTS P1/ ADDRESS OF THE MAIN ROUTINE FOR THE PARTICULAR UUO.
   145				EXPECTS USER ARGS IN T1 AND T2.  T1 IS ALWAYS THE VP NUMBER.
   146				THERE MAY OR MAY NOT BE A SECOND ARG, DEPENDING ON THE UUO.
   147				ALSO EXPECTS M/ USER'S DECODED UUO, SO VALUES CAN BE RETURNED.
   148				@@ACCUM
   149				DESTROYS T1-T4, P1-P4, J, U, PG, AND W.
   150				@@EXIT
   151				SKIP RETURNS ON SUCCESS, WITH VALUE RETURNED, IF ANY, ALREADY
   152				STORED.
   153				NON-SKIP RETURNS ON FAILURE, WITH ERROR CODE STORED IN USER'S
   154				AC.
   155				@@ #
   156
   157				EXTERNAL %UPT,UPTLDC,REDLMA
   158
   159				    ;CHECK THAT THE VP NUMBER IS IN RANGE AND THE VP EXISTS.
   160				    ;INDIVIDUAL ROUTINES WILL CHECK THE SECOND ARGUMENT IF ANY.
   161				    ;SET UP P3 AND P4/ LMA INFORMATION, P2/ SECOND ARG,
   162				    ;J/ JOB NUMBER, AND W/ VP NUMBER.
   163	000031'	331500	000006	KCBKER::SKIPL	W,T1		;SET UP W/ VP FOR GETUPT.
   164	000032'	303500	000777		CAILE	W,^D511		;VP IN RANGE?
   165					JRST	[MOVEI T1,ERRVPR ;NO.
   166	000033'	254000	000554'			JRST KCBERR]	;
   167	000034'	200640	000007		MOVE	P2,T2		;SAVE P2/ SECOND ARG, IF ANY.
   168	000035'	260040	000000*		PUSHJ	P,REDLMA	;GET LMAP SLOT IN P3 AND P4
   169	000036'	607700	000000*		TLNN	P3,LMMEXS	;MUST BE EXISTENT PG
   170					JRST	[MOVEI T1,ERRNEX
   171	000037'	254000	000556'			JRST KCBERR]	;
   172	000040'	200100	000000*		MOVE	J,JOB		;SET UP J/ OUR JOB NUMBER.
   173				    ;DISPATCH TO APPROPRIATE ROUTINE.
   174	000041'	260054	000000		PUSHJ	P,(P1)		;PASS P3,P4 LMAP SLOT
   175	000042'	254000	000044'		JRST	.+2		;TAKE FAIL RETURN.
   176	000043'	254000	000000*		JRST	CPOPJ1		;SUCCESS RETURN.
   177	000044'	256200	000560'	KCBERR:	UMOVEM	T1,(M)		;STORE ERROR FLAG IN USER'S AC.
   178	000045'	263040	000000		POPJ	P,
   179
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 5
CLUBS.MAC	17-SEP-87 16:45		JOIN AND LEAVE CLUBS

   180				SUBTTL JOIN AND LEAVE CLUBS
   181				COMMENT #
   182				@@SUBROUTINE KCBADD
   183				@@PURPOSE
   184				SUBR FOR THE CLBADD UUO.  ADDS A JOB TO A CLUB.  IF NECESSARY,
   185				CREATES THE CLUB.
   186				@@ENTRY
   187				EXPECTS W/ VP NUMBER, J/ JOB NUMBER, AND P3 AND P4/ LMA
   188				INFORMATION.  EXPECTS THE VP TO EXIST.
   189				EXPECTS M/ USER'S DECODED UUO, SO ID NUMBER CAN BE RETURNED.
   190				@@ACCUM
   191				DESTROYS T1-T4, P1-P4, J, U, PG, AND W.
   192				@@EXIT
   193				SKIP RETURNS ON SUCCESS, WITH THE JOB'S ID NUMBER STORED IN THE
   194				USER'S AC.
   195				NON-SKIP RETURNS ON FAIL, WITH THE ERROR CODE IN THE RH(T1)
   196				AS FOLLOWS: ERRINC, ERRIDO.
   197				@@ #
   198
   199	000046'	260040	000544'	KCBADD::PUSHJ	P,SRCCMC	;ARE WE ALREADY IN A CLUB FOR THIS VP?
   200	000047'	254000	000052'		JRST	KCBAD2		;NO -- OK
   201	000050'	201300	000003		MOVEI	T1, ERRINC
   202	000051'	254000	000044'		JRST	KCBERR		;YES -- ERROR-RETURN
   203	000052'	260040	000512'	KCBAD2:	PUSHJ	P,SRCBTB	;LOOK FOR OUR DISK PAGE'S CLUB.
   204	000053'	254000	000055'		JRST	KCBAD3		;CLUB NOT FOUND
   205	000054'	254000	000073'		JRST	KCBAD4		;FOUND
   206
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 6
CLUBS.MAC	17-SEP-87 16:45		JOIN AND LEAVE CLUBS

   207				;HERE TO CREATE A NEW CLUB FOR THIS DISK PAGE
   208
   209	000055'	261040	000007	KCBAD3:	PUSH	P,T2		;SAVE RETRIEVAL POINTER
   210	000056'	261040	000010		PUSH	P,T3		;SAVE CLBTBL HASH INDEX
   211
   212				    ;ALLOCATE A NEW CLUB DATA BLOCK
   213
   214	000057'	201340	000004	KCBA3A:	MOVEI	T2,LENCDB	;T2/ CDB SIZE
   215	000060'	335000	000000*		SKIPGE	FCREQ		;ARE OTHER JOBS WAITING FOR FREECORE?
   216	000061'	260040	000000*		PUSHJ	P,GETWDS	;IS THERE ENOUGH FREECORE FOR US?
   217					JRST	[		;OTHERS WAITING OR NOT ENOUGH
   218						AOS	FCREQ
   219						PUSHJ	P, FCWAIT
   220						SOS	FCREQ
   221						JRST	KCBA3A	;WAIT, THEN TRY AGAIN
   222	000062'	254000	000561'		]
   223
   224				    ;INITIALIZE THE NEW CLUB DATA BLOCK (T1/ CDB ADDR)
   225
   226	000063'	200440	000006		MOVE	T4, T1		;T4/ NEW CDB
   227	000064'	262040	000010		POP	P, T3		;T3/ CLBTBL HASH INDEX
   228	000065'	550310	000016'		HRRZ	T1, CLBTBL(T3)	;T1/ 0,,OLD 1ST CDB
   229	000066'	552450	000016'		HRRZM	T4, CLBTBL(T3)	;WE'RE NOW 1ST CDB
   230	000067'	552311	000002		HRRZM	T1, CDBHLK(T4)	;STATUS BITS 0,,HASH LINK=OLD 1ST
   231	000070'	262051	000000		POP	P,CDBRET(T4)	;RETRIEVAL POINTER
   232	000071'	402011	000003		SETZM	CDBCID(T4)	;FIRST JOB-IN-CLUB ID WILL BE 1
   233	000072'	402011	000001		SETZM	CDBCMC(T4)	;NO INTERLOCKER,,NOBODY IN CLUB
   234
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 7
CLUBS.MAC	17-SEP-87 16:45		JOIN AND LEAVE CLUBS

   235				;HERE TO ADD A JOB TO AN EXISTING CLUB (T4/ CDB ADDR)
   236
   237	000073'	350351	000003	KCBAD4:	AOS	T2, CDBCID(T4)	;T2/ NEW JOB-IN-CLUB ID
   238	000074'	311340	000565'		CAML	T2,[1B<CMNCID>_<CMSCID>]	;OVERFLOW?
   239					JRST	[			;YES --
   240						SOS	CDBCID(T4)	;  RESTORE THE VALUE
   241						MOVEI	T1, ERRIDO
   242						POPJ	P,		;  AND ERROR-RETURN
   243	000075'	254000	000566'		]
   244	000076'	261040	000007		PUSH	P, T2		;SAVE JOB-IN-CLUB ID
   245	000077'	261040	000011		PUSH	P, T4		;SAVE CDB ADDR
   246	000100'	201340	000004	KCBA4A:	MOVEI	T2, LENCMC	;T2/ CLUB MEMBERSHIP CARD SIZE
   247	000101'	335000	000060*		SKIPGE	FCREQ		;ARE OTHER JOBS WAITING FOR FREECORE?
   248	000102'	260040	000061*		PUSHJ	P, GETWDS	;IS THERE ENOUGH FREECORE FOR US?
   249					JRST	[		;OTHERS WAITING OR NOT ENOUGH
   250						AOS	FCREQ
   251						PUSHJ	P, FCWAIT
   252						SOS	FCREQ
   253						JRST	KCBA4A	;WAIT, THEN TRY AGAIN
   254	000103'	254000	000571'		]
   255	000104'	262040	000011		POP	P, T4		;T4/ CDB ADDR
   256
   257				    ;LINK THE CMC TO THE CDB (T1/ CMC ADDR)
   258
   259	000105'	550351	000001		HRRZ	T2, CDBCMC(T4)	;T2/ 0 OR 1ST CMC FOR CLUB
   260	000106'	322340	000110'		JUMPE	T2, .+2		;IF THERE IS A 1ST CMC,
   261	000107'	506307	000000		HRLM	T1, CMCCLK(T2)	;  POINT IT BACK TO US
   262	000110'	552346	000000		HRRZM	T2, CMCCLK(T1)	;BACK=0,,FORW=OLD 1ST OR 0
   263	000111'	542311	000001		HRRM	T1, CDBCMC(T4)	;WE BECOME NEW 1ST
   264
   265				    ;LINK THE CMC TO OTHERS FOR THE JOB
   266
   267	000112'	550342	000000*		HRRZ	T2, JBTCLB(J)	;T2/ 1ST CMC FOR JOB OR 0
   268	000113'	322340	000115'		JUMPE	T2, .+2		;IF THERE IS A 1ST CMC,
   269	000114'	506307	000001		HRLM	T1, CMCJLK(T2)	;  POINT IT BACK TO US
   270	000115'	552346	000001		HRRZM	T2, CMCJLK(T1)	;BACK=0,,FORW=OLD 1ST OR 0
   271	000116'	542302	000112*		HRRM	T1, JBTCLB(J)	;WE BECOME NEW 1ST
   272
   273				    ;INITIALIZE THE REST OF THE CMC
   274
   275	000117'	504440	000002		HRL	T4, J		;T4/ JOB#,,CDB ADDR
   276	000120'	603700	000000*		TLNE	P3, LMPMXW	;IF WE'RE FIRST-CLASS MEMBERS,
   277	000121'	661440	400000		TLO	T4, CM.FRC	;  SET THE FIRST-CLASS BIT
   278	000122'	202446	000002		MOVEM	T4,CMCJOB&CMCSTS&CMCCDB(T1) ;GET ALL REFS IN CREF
   279	000123'	137500	000007'		DPB	W,CMYVPG	;VP#
   280	000124'	262040	000007		POP	P, T2		;T2/ JOB-IN-CLUB ID
   281	000125'	137340	000010'		DPB	T2,CMYCID
   282	000126'	135300	000000*		LDB	T1, PUUOAC
   283	000127'	256200	000575'		UMOVEM	T2, (T1)	;AND GIVE IT TO THE CALLER
   284	000130'	254000	000043*		JRST	CPOPJ1		;AND SUCCESS-RETURN
   285
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 8
CLUBS.MAC	17-SEP-87 16:45		JOIN AND LEAVE CLUBS

   286				COMMENT #
   287				@@SUBROUTINE KCBLEV
   288				@@PURPOSE
   289				SUBR FOR THE CLBLEV UUO.  REMOVES A JOB FROM A CLUB, AND IF THAT
   290				WAS THE ONLY JOB IN THE CLUB, DELETES THE CLUB.
   291				@@ENTRY
   292				EXPECTS W/ VP NUMBER, J/ JOB NUMBER, AND P3 AND P4/ LMA
   293				INFORMATION.  EXPECTS THE VP TO EXIST.
   294				@@ACCUM
   295				DESTROYS T1-T4, P1-P4, J, U, PG, AND W.
   296				@@EXIT
   297				SKIP RETURNS ON SUCCESS.
   298				NON-SKIP RETURNS ON FAIL, WITH THE ERROR CODE IN THE RH(T1)
   299				AS FOLLOWS: ERRNIC, ERRVPM, ERRHIL.
   300				@@ #
   301
   302	000131'	336002	000116*	KCBLEV::SKIPN	JBTCLB(J)	;ARE WE IN ANY CLUBS?
   303					JRST	[		;NO -- ERROR-RETURN
   304						MOVEI	T1, ERRNIC
   305						POPJ	P,
   306	000132'	254000	000576'		]
   307	000133'	260040	000544'		PUSHJ	P, SRCCMC	;ARE WE IN A CLUB WITH THIS VP?
   308					JRST	[		;NO -- ERROR-RETURN
   309						MOVEI	T1, ERRVPM
   310						POPJ	P,
   311	000134'	254000	000600'		]
   312
   313				    ;HERE WITH T1/ ADDR OF CMC FOR CLUB WE'RE LEAVING
   314
   315	000135'	550346	000002		HRRZ	T2, CMCCDB(T1)	;T2/ CDB ADDR
   316	000136'	554347	000001		HLRZ	T2, CDBLOK(T2)	;T2/ INTERLOCKER CMC
   317	000137'	316300	000007		CAMN	T1, T2		;IS IT US?
   318					JRST	[		;YES -- ERROR-RETURN
   319						MOVEI	T1, ERRHIL
   320						POPJ	P,
   321	000140'	254000	000602'		]
   322	000141'	350001	000000		AOS	(P)		;PREPARE FOR SUCCESS-RETURN
   323				;	PJRST	RELCLB		;LEAVE (AND MAYBE DELETE) THE CLUB
   324
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 9
CLUBS.MAC	17-SEP-87 16:45		JOIN AND LEAVE CLUBS

   325				COMMENT #
   326				@@SUBROUTINE RELCLB
   327				@@PURPOSE
   328				REMOVES A JOB FROM A CLUB, AND IF THAT WAS THE ONLY JOB IN THE
   329				CLUB, DELETES THE CLUB.
   330				@@ENTRY
   331				EXPECTS T1/ ADDR OF MEMBERSHIP CARD
   332				EXPECTS THE JOB TO BE IN THE CLUB AND TO NOT HAVE THE CLUB'S
   333				INTERLOCK.
   334				@@ACCUM
   335				DESTROYS T1-T4.
   336				@@ #
   337
   338	000142'	350000	000015'	RELCLB:	AOS	LVCCNT		;INCREMENT COUNTER SO ANYONE IN MIDDLE OF
   339								; SCANNING MEMBERS WILL START OVER
   340	000143'	550346	000002		HRRZ	T2, CMCCDB(T1)	;T2/ CDB ADDR FOR CLUB
   341
   342				    ;REMOVE US FROM THE JOB'S CMC CHAIN
   343
   344	000144'	550406	000001		HRRZ	T3, CMCJLK(T1)	;T3/ NEXT CMC FOR JOB
   345	000145'	554446	000001		HLRZ	T4, CMCJLK(T1)	;T4/ PREV CMC FOR JOB
   346	000146'	332000	000010		SKIPE	T3		;IF WE HAD A SUCCESSOR,
   347	000147'	506450	000001		HRLM	T4, CMCJLK(T3)	;  POINT IT AT OUR PREDECESSOR
   348	000150'	322440	000153'		JUMPE	T4, .+3		;IF WE HAD A PREDECESSOR,
   349	000151'	542411	000001		HRRM	T3, CMCJLK(T4)	;  POINT IT AT OUR SUCCESSOR
   350	000152'	254000	000154'		JRST	.+2		;OTHERWISE,
   351	000153'	542402	000131*		HRRM	T3, JBTCLB(J)	;  POINT JBTCLB AT OUR SUCCESSOR
   352
   353				    ;REMOVE US FROM THE CLUB'S CMC CHAIN
   354
   355	000154'	550406	000000		HRRZ	T3, CMCCLK(T1)	;T3/ NEXT CMC FOR CLUB
   356	000155'	554446	000000		HLRZ	T4, CMCCLK(T1)	;T4/ PREV CMC FOR CLUB
   357	000156'	332000	000010		SKIPE	T3		;IF WE HAD A SUCCESSOR,
   358	000157'	506450	000000		HRLM	T4, CMCCLK(T3)	;  POINT IT AT OUR PREDECESSOR
   359	000160'	322440	000163'		JUMPE	T4, .+3		;IF WE HAD A PREDECESSOR,
   360	000161'	542411	000000		HRRM	T3, CMCCLK(T4)	;  POINT IT AT OUR SUCCESSOR
   361	000162'	254000	000164'		JRST	.+2		;OTHERWISE,
   362	000163'	542407	000001		HRRM	T3, CDBCMC(T2)	;  POINT THE CDB AT OUR SUCCESSOR
   363
   364				    ;GIVE BACK THE CMC FREECORE
   365
   366	000164'	261040	000007		PUSH	P, T2		;SAVE CDB ADDR
   367	000165'	200340	000006		MOVE	T2, T1		;T2/ CMC ADDR
   368	000166'	201300	000004		MOVEI	T1, LENCMC	;T1/ CMC LENGTH
   369	000167'	260040	000000*		PUSHJ	P, GIVWDS	;RETURN THE FREECORE
   370
   371				    ;DELETE THE CLUB IF WE WERE THE LAST MEMBER
   372
   373	000170'	262040	000011		POP	P, T4		;T4/ CDB ADDR
   374	000171'	550311	000001		HRRZ	T1, CDBCMC(T4)	;T1/ 1ST CMC
   375	000172'	326300	000000*		JUMPN	T1, CPOPJ	;IF THERE IS ONE, RETURN
   376	000173'	260040	000526'		PUSHJ	P, ULKCDB	;OTHERWISE, UNLINK THE CDB,
   377	000174'	200340	000011		MOVE	T2, T4		;  T2/ CDB ADDR
CLUBS	UUR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 9-2
CLUBS.MAC	17-SEP-87 16:45		JOIN AND LEAVE CLUBS

   378	000175'	201300	000004		MOVEI	T1, LENCDB	;  T1/ CDB LENGTH
   379	000176'	324740	000167*		PJRST	GIVWDS		;  AND GIVE BACK ITS FREECORE
   380
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 10
CLUBS.MAC	17-SEP-87 16:45		GET AND RELEASE CLUB INTERLOCKS

   381				SUBTTL GET AND RELEASE CLUB INTERLOCKS
   382				COMMENT #
   383				@@SUBROUTINE KCBINW/CLBINI
   384				@@PURPOSE
   385				SUBR FOR THE CLBINW AND CLBINI UUOS.  GETS THE CLUB INTERLOCK.
   386				IF THE INTERLOCK IS BUSY, KCBINI ERROR RETURNS BUT KCBINW
   387				WAITS FOR THE INTERLOCK.
   388				THIS UUO HAS TO BE REINITIALIZABLE SINCE SOFTWARE INTERRUPTS
   389				CAN HAPPEN DURING ILW.
   390				@@ENTRY
   391				EXPECTS W/ VP NUMBER, J/ JOB NUMBER, AND P3 AND P4/ LMA
   392				INFORMATION.  EXPECTS THE VP TO EXIST.
   393				EXPECTS P1/ KCBINI OR KCBINW.
   394				EXPECTS M/ USER'S DECODED UUO, SO THAT, IF NECESSARY, KCBINI CAN
   395				RETURN THE ID NUMBER OF THE JOB HAVING THE INTERLOCK.
   396				@@ACCUM
   397				DESTROYS T1-T4, P1-P4, J, U, PG, AND W.
   398				@@EXIT
   399				SKIP RETURNS ON SUCCESS, WITH NORMAL RELEASE OF INTERLOCK FLAG
   400				AND THE EVER BEEN INTERLOCKED FLAG RETURNED IN THE USER'S AC.
   401				NON-SKIP RETURNS ON FAIL, WITH THE ERROR CODE IN THE RH(T1)
   402				AS FOLLOWS: ERRNIC, ERRVPM, ERRNFC, ERRHIL, ERRAIL.
   403				(MAY ALSO EXIT THRU ABTUUO IF A TRAP NEEDS TO BE TAKEN.).
   404				@@ #
   405
   406	000177'	254000	000200'	KCBINI::JRST	.+1		;MAKE NOT SAME ADDR AS CLBINW.
   407	000200'	335002	000000*	KCBINW::SKIPGE	JBTAWQ(J)	;IF AN INTERRUPT IS WAITING,
   408	000201'	324740	000000*		PJRST	ABTUUO		;  BACK UP THE PC AND TAKE THE TRAP
   409	000202'	260040	000462'		PUSHJ	P,CHKFRC	;IN CLUB, VP MATCH, 1ST CLASS?
   410	000203'	263040	000000		POPJ	P,		;NO -- ERROR-RETURN(CODE ALREADY IN T1)
   411	000204'	550446	000002		HRRZ	T4, CMCCDB(T1)	;T4/ CDB ADDRESS
   412	000205'	554351	000001		HLRZ	T2, CDBLOK(T4)	;T2/ INTERLOCKER CMC OR 0
   413					JUMPE	T2,	[		;IF CLUB IS NOT INTERLOCKED,
   414						HRLM	T1, CDBLOK(T4)	;  SET US AS THE INTERLOCKER
   415						JRST	KCBIW2		;RETURN WITH THE INTERLOCK
   416	000206'	322340	000604'		]
   417
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 11
CLUBS.MAC	17-SEP-87 16:45		GET AND RELEASE CLUB INTERLOCKS

   418				    ;HERE IF SOMEONE HAS THE CLUB INTERLOCKED
   419				    ;(T1/ OUR CMC, T2/ INTERLOCKER CMC, T4/ CLUB DATA BLOCK)
   420
   421	000207'	316300	000007		CAMN	T1, T2		;ARE WE THE INTERLOCKER?
   422					JRST	[		;YES -- ERROR-RETURN
   423						MOVEI	T1, ERRHIL
   424						POPJ	P,
   425	000210'	254000	000602'		]
   426	000211'	306600	000177'		CAIN	P1, KCBINI	;IF THE CALLER DOESN'T WANT TO WAIT,
   427					JRST	[
   428						MOVE	T1,T2
   429						LDB	T1,CMYCID	;T1/INTERLOCKER ID
   430						LDB	T2, PUUOAC
   431						UMOVE	T2, (T2)
   432						UMOVEM	T1, (T2)	;RETURN IT
   433						MOVEI	T1, ERRAIL	;AND "ALREADY INTERLOCKED" CODE
   434						POPJ	P,
   435	000212'	254000	000610'		]
   436
   437				    ;HERE TO WAIT FOR THE CLUB INTERLOCK
   438
   439	000213'	506302	000153*		HRLM	T1, JBTCLB(J)	;STORE CMC OF AWAITED CLUB
   440	000214'	201340	000000*		MOVEI	T2, ILWQ
   441	000215'	137340	000000*		DPB	T2, PJBSTS
   442	000216'	260040	000000*		PUSHJ	P, WSCHED	;WAIT FOR INTERLOCK
   443	000217'	554351	000001		HLRZ	T2, CDBLOK(T4)
   444	000220'	316340	000006		CAMN	T2, T1		;WERE WE GIVEN THE INTERLOCK?
   445	000221'	254000	000224'		JRST	KCBIW2		;YES
   446	000222'	553002	000213*		HRRZS	JBTCLB(J)	;NO -- CLEAR AWAITED CMC
   447	000223'	324740	000201*		PJRST	ABTUUO		;      AND TAKE TRAP AND RETRY
   448
   449				    ;HERE TO RETURN WITH THE INTERLOCK
   450
   451	000224'	510311	000002	KCBIW2:	HLLZ	T1, CDBSTS(T4)	;T1/ CLUB STATUS BITS
   452	000225'	205340	100000		MOVSI	T2, CD.EVI
   453	000226'	436351	000002		IORM	T2, CDBSTS(T4)	;SET "EVER INTERLOCKED"
   454	000227'	135340	000126*		LDB	T2, PUUOAC
   455	000230'	256200	000607'		UMOVEM	T1, (T2)	;RETURN THE CLUB STATUS
   456	000231'	254000	000130*		JRST	CPOPJ1
   457
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 12
CLUBS.MAC	17-SEP-87 16:45		GET AND RELEASE CLUB INTERLOCKS

   458				COMMENT #
   459				@@SUBROUTINE KCBRLI
   460				@@PURPOSE
   461				SUBR FOR THE CLBRLI UUO.  RELEASES THE CLUB INTERLOCK, IFF
   462				THIS JOB HAS IT, AND STARTS UP NEXT IN ILWQ FOR THIS CLUB.
   463				@@ENTRY
   464				EXPECTS W/ VP NUMBER, J/ JOB NUMBER, AND P3 AND P4/ LMA
   465				INFORMATION.  EXPECTS THE VP TO EXIST.
   466				@@ACCUM
   467				DESTROYS T1-T4, P1-P4, J, U, PG, AND W.
   468				@@EXIT
   469				SKIP RETURNS ON SUCCESS.
   470				NON-SKIP RETURNS ON FAIL, WITH THE ERROR CODE IN THE RH(T1)
   471				AS FOLLOWS: ERRNIC, ERRVPM, ERRNFC, ERRNIL.
   472				@@ #
   473
   474	000232'	260040	000462'	KCBRLI::PUSHJ	P, CHKFRC	;IN CLUB, VP MATCH, 1ST CLASS?
   475	000233'	263040	000000		POPJ	P,		;NO.
   476	000234'	550446	000002		HRRZ	T4, CMCCDB(T1)	;T4/ CDB ADDR
   477	000235'	554351	000001		HLRZ	T2, CDBLOK(T4)	;T2/ INTERLOCKER CMC
   478	000236'	312340	000006		CAME	T2, T1		;ARE WE THE INTERLOCKER?
   479					JRST	[		;NO -- ERROR-RETURN
   480						MOVEI	T1, ERRNIL
   481						POPJ	P,
   482	000237'	254000	000617'		]
   483	000240'	260040	000244'		PUSHJ	P, RELINL	;RELEASE INTERLOCK, START 1ST WAITER
   484	000241'	205340	200000		MOVSI	T2, CD.NML
   485	000242'	436351	000002		IORM	T2, CDBSTS(T4)	;SET "NORMAL RELEASE"
   486	000243'	254000	000231*		JRST	CPOPJ1
   487
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 13
CLUBS.MAC	17-SEP-87 16:45		GET AND RELEASE CLUB INTERLOCKS

   488				COMMENT #
   489				@@SUBROUTINE RELINL
   490				@@PURPOSE
   491				RELEASES THE INTERLOCK FOR A CLUB AND RESTARTS
   492				THE FIRST WAITER, IF THERE IS ONE, FOR THE CLUB'S INTERLOCK.
   493				@@ENTRY
   494				EXPECTS J/ JOB NUMBER OF INTERLOCKER
   495				EXPECTS T4/ INTERLOCKED CLUB CDB ADDRESS
   496				@@ACCUM
   497				DESTROYS T1-T3, PRESERVES T4.
   498				@@EXIT
   499				@@ #
   500
   501				EXTERNAL UPTIME
   502
   503			000017		RNDMSK==17		;EVERY TIME UPTIME HAS THIS BIT ON, GIVE IT
   504								; TO FIRST WAITER REGARDLESS OF MRQ AS
   505								; A FAIRNESS CONSIDERATION.
   506
   507	000244'	570300	000000*	RELINL:	HRRE	T1, JBTQ-ILWQ	;T1/ 1ST JOB IN ILWQ
   508	000245'	321300	000275'		JUMPL	T1, RELIN7	;NONE
   509	000246'	261040	000014		PUSH	P,P1		;P1 WILL HAVE MRQ JOB IF ANY
   510	000247'	400600	000000		SETZ	P1,
   511	000250'	554346	000222*	RELIN2:	HLRZ	T2, JBTCLB(T1)	;T2/ AWAITED CMC FOR JOB
   512	000251'	322340	000266'		JUMPE	T2,RELIN3	;JUMP IF ALREADY AWAKENED
   513	000252'	550407	000002		HRRZ	T3, CMCCDB(T2)	;T3/ ITS CDB
   514	000253'	316400	000011		CAMN	T3, T4		;WAITING FOR THIS CLUB?
   515	000254'	306106	000000		CAIN	J, (T1)		;AND NOT THE CURRENT JOB?
   516	000255'	254000	000266'		JRST	RELIN3
   517	000256'	200400	000000*		MOVE	T3,UPTIME	;JOB IS OK TO GIVE LOCK TO.
   518	000257'	606400	000017		TRNN	T3,RNDMSK	;TIME TO GIVE TO HIM EVEN IF CAN'T RUN YET?
   519	000260'	254000	000277'		JRST	RELIN5		;YES.
   520	000261'	200406	000000*		MOVE	T3,JBTSTS(T1)	;NOT YET, SEE IF MRQ ON
   521	000262'	607400	100000		TLNN	T3,MRQ		;IS IT?
   522	000263'	254000	000277'		JRST	RELIN5		;NO, GIVE LOCK TO HIM.
   523	000264'	336000	000014		SKIPN	P1		;SEE ANOTHER JOB BEFORE THIS IN QUEUE WITH MRQ?
   524	000265'	200600	000006		MOVE	P1,T1		;NO, THIS GETS LOCK IF NO ONE ELSE WANTS IT
   525				;	JRST	RELIN3		;AND GO SCAN FOR A BETTER JOB
   526	000266'	570306	000000*	RELIN3:	HRRE	T1, JBTQ(T1)	;T1/ NEXT JOB
   527	000267'	325300	000250'		JUMPGE	T1, RELIN2
   528
   529				    ;HERE IF NO ONE WITHOUT MRQ IS WAITING FOR THE INTERLOCK.
   530
   531	000270'	322600	000274'	RELIN4:	JUMPE	P1,RELIN6	;JUMP IF NO ONE AT ALL WANTS THE LOCK.
   532	000271'	200300	000014		MOVE	T1,P1		;SOMEONE WITH MRQ WANTS IT, GIVE IT AWAY TO HIM
   533	000272'	554346	000250*		HLRZ	T2,JBTCLB(T1)	;RELIN5 EXPECTS CMC IN T2
   534	000273'	254000	000277'		JRST	RELIN5
   535	000274'	262040	000014	RELIN6:	POP	P,P1		;RESTORE P1
   536	000275'	553011	000001	RELIN7:	HRRZS	CDBLOK(T4)	;CLEAR THE INTERLOCKER FIELD
   537	000276'	263040	000000		POPJ	P,
   538
   539				    ;HERE TO WAKE UP A WAITER (T1/ WAITER'S JOB #, T2/ CMC)
   540
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 13-2
CLUBS.MAC	17-SEP-87 16:45		GET AND RELEASE CLUB INTERLOCKS

   541	000277'	506351	000001	RELIN5:	HRLM	T2, CDBLOK(T4)	;GIVE IT THE INTERLOCK
   542	000300'	553006	000272*		HRRZS	JBTCLB(T1)	;CLEAR ITS AWAITED CMC
   543	000301'	261040	000002		PUSH	P, J		;SAVE J
   544	000302'	550100	000006		HRRZ	J, T1
   545	000303'	201300	000000*		MOVEI	T1, ISQ		;INTERLOCK SATISFIED (NOT A REAL SEPERATE CODE)
   546	000304'	137300	000215*		DPB	T1, PJBSTS
   547	000305'	260040	000000*		PUSHJ	P, SETRUN	;MARK IT RUNNABLE
   548	000306'	262040	000002		POP	P, J		;RESTORE J
   549	000307'	262040	000014		POP	P,P1		;AND P1
   550	000310'	263040	000000		POPJ	P,
   551
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 14
CLUBS.MAC	17-SEP-87 16:45		CLBMEM UUO

   552				SUBTTL CLBMEM UUO
   553				COMMENT #
   554				@@SUBROUTINE KCBMEM
   555				@@PURPOSE
   556				SUBR FOR THE CLBMEM UUO.  GETS THE COUNT OF MEMBERS IN THE CLUB
   557				AND AS MANY OF THEIR ID NUMBERS AS THE USER HAS ASKED FOR.
   558				@@ENTRY
   559				EXPECTS W/ VP NUMBER, J/ JOB NUMBER, AND P3 AND P4/ LMA
   560				INFORMATION.  EXPECTS THE VP TO EXIST.
   561				EXPECTS P2/ COUNT ARG FROM USER.
   562				EXPECTS M/ USER'S DECODED UUO, SO VALUES CAN BE RETURNED.
   563				@@ACCUM
   564				DESTROYS T1-T4, P1-P4, J, U, PG, AND W.
   565				@@EXIT
   566				SKIP RETURNS ON SUCCESS, WITH VALUES STORED IN USER AREA.
   567				NON-SKIP RETURNS ON FAIL, WITH THE ERROR CODE IN THE RH(T1)
   568				AS FOLLOWS: ERRNIC, ERRVPM, ERRNFC, ERRCNT.
   569				@@ #
   570
   571	000311'	260040	000462'	KCBMEM::PUSHJ	P,CHKFRC	;IN CLUB, VP MATCHES, 1ST CLASS?
   572	000312'	263040	000000		POPJ	P,		;NO.
   573					JUMPL	P2, [		;IF COUNT < 0, ERROR-RETURN
   574						MOVEI	T1, ERRCNT
   575						POPJ	P,
   576	000313'	321640	000621'		]
   577	000314'	550606	000002		HRRZ	P1, CMCCDB(T1)	;P1/ CDB ADDR
   578	000315'	200740	000015		MOVE	P4,P2		;SAVE COUNT IN CASE HAVE TO START OVER
   579	000316'	135340	000227*		LDB	T2, PUUOAC
   580	000317'	256200	000606'		UMOVE	T2, (T2)	;T2/ USER SPACE COUNT ADDRESS
   581	000320'	261040	000007		PUSH	P,T2		;SAVE IT
   582	000321'	200700	000015'		MOVE	P3,LVCCNT	;GET COUNT OF NUMBER OF TIMES SOMEONE LEFT A CLUB
   583	000322'	400400	000000	KCBME0:	SETZ	T3,		;T3/ COUNT
   584	000323'	271340	000001		ADDI	T2, 1		;T2/ USER SPACE ID ADDRESS
   585	000324'	550314	000001		HRRZ	T1, CDBCMC(P1)	;T1/ 1ST CMC FOR CLUB
   586	000325'	326300	000327'		JUMPN	T1, .+2
   587	000326'	256000	000000'		  STOPCD		;AT LEAST CURRENT JOB MUST BE IN CLUB
   588	000327'	340400	000000	KCBME2:	AOJ	T3,		;T3/ COUNT OF JOBS IN CLUB
   589	000330'	361640	000336'		SOJL	P2, KCBME4	;IF THERE'S ROOM TO STORE THIS ID,
   590	000331'	135440	000010'		LDB	T4,CMYCID	; T4/ JOB-IN-CLUB ID
   591	000332'	256200	000623'		UMOVEM	T4, (T2)	;  STORE IT IN CALLER'S TABLE
   592	000333'	312700	000015'		CAME	P3,LVCCNT	;ANYONE POSSIBLY DESTROY THE CHAIN?
   593	000334'	254000	000343'		JRST	KCBMRS		;YES, MUST RESTART THE UUO
   594	000335'	201347	000001		MOVEI	T2, 1(T2)	;  AND UPDATE THE ADDRESS
   595	000336'	550306	000000	KCBME4:	HRRZ	T1, CMCCLK(T1)	;T1/ NEXT CMC FOR CLUB
   596	000337'	326300	000327'		JUMPN	T1, KCBME2
   597	000340'	262040	000007		POP	P, T2		;RESTORE COUNT ADDRESS
   598	000341'	256200	000624'		UMOVEM	T3, (T2)	;AND STORE THE JOB COUNT
   599	000342'	254000	000243*		JRST	CPOPJ1
   600
   601				;HERE IF SOMEONE LEFT A CLUB SOMEWHERE ON THE SYSTEM. MUST
   602				; START FROM THE FIRST CMC FOR THE CLUB AGAIN, SINCE WE DON'T KNOW
   603				; WHICH CMC CHAIN WAS BROKEN AND WHERE (COULD HAVE BEEN THE ONE
   604				; WE WERE SCANNING).
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 14-2
CLUBS.MAC	17-SEP-87 16:45		CLBMEM UUO

   605
   606	000343'	200640	000017	KCBMRS:	MOVE	P2,P4		;RESTORE NUMBER OF WORDS IN USER SPACE THERE ARE
   607	000344'	200700	000015'		MOVE	P3,LVCCNT	;GET NEW COUNT OF FRAMES THAT HAVE LEFT CLUBS
   608	000345'	200341	000000		MOVE	T2,(P)		;GET ADDRESS OF USER ARG BLOCK.
   609	000346'	254000	000322'		JRST	KCBME0		;AND RESTART.
   610
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 15
CLUBS.MAC	17-SEP-87 16:45		DISCOVER THINGS ABOUT JOBS IN YOUR CLUB

   611				SUBTTL DISCOVER THINGS ABOUT JOBS IN YOUR CLUB
   612				COMMENT #
   613				@@SUBROUTINE KCBSTS
   614				@@PURPOSE
   615				SUBR FOR CLBSTS UUO. GETS A SPECIFIED CLUB MEMBER'S JBTSTS BITS.
   616				@@ENTRY
   617				EXPECTS W/ VP NUMBER, J/ JOB NUMBER, AND P3 AND P4/ LMA
   618				INFORMATION.  EXPECTS THE VP TO EXIST.
   619				EXPECTS P2/ ID NUMBER OF SPECIFIED JOB.
   620				EXPECTS M/ USER'S DECODED UUO, SO VALUES CAN BE RETURNED.
   621				@@ACCUM
   622				DESTROYS T1-T4
   623				@@EXIT
   624				SKIP RETURNS ON SUCCESS, WITH THE VALUES STORED IN THE USER'S
   625				AC.
   626				NON-SKIP RETURNS ON FAIL, WITH THE ERROR CODE IN THE RH(T1)
   627				AS FOLLOWS: ERRNIC, ERRVPM, ERRNFC, ERRJNI.
   628				@@ #
   629
   630	000347'	260040	000472'	KCBSTS::PUSHJ	P,FNDJOB	;CHECK US, LOOK FOR JOB.
   631	000350'	263040	000000		POPJ	P,		;FAILURE.
   632
   633				    ;HERE ON FOUND JOB.
   634
   635	000351'	200306	000261*		MOVE	T1, JBTSTS(T1)	;T1/ JOB STATUS BITS
   636	000352'	135340	000316*		LDB	T2, PUUOAC
   637	000353'	256200	000607'		UMOVEM	T1, (T2)	;GIVE IT TO THE LUSER
   638	000354'	254000	000342*		JRST	CPOPJ1
   639
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 16
CLUBS.MAC	17-SEP-87 16:45		DO THINGS TO JOBS IN YOUR CLUB

   640				SUBTTL DO THINGS TO JOBS IN YOUR CLUB
   641				COMMENT #
   642				@@SUBROUTINE KCBWAK
   643				@@PURPOSE
   644				SUBR FOR THE CLBWAK UUO.  WAKES UP A JOB IN THE SAME CLUB.
   645				@@ENTRY
   646				EXPECTS W/ VP NUMBER, J/ JOB NUMBER, AND P3 AND P4/ LMA
   647				INFORMATION.  EXPECTS THE VP TO EXIST.
   648				EXPECTS P2/ ID NUMBER OF SPECIFIED JOB.
   649				@@ACCUM
   650				DESTROYS T1-T4, P1-P4, J, U, PG, AND W.
   651				@@EXIT
   652				SKIP RETURNS ON SUCCESS.
   653				NON-SKIP RETURNS ON FAIL, WITH THE ERROR CODE IN THE RH(T1)
   654				AS FOLLOWS: ERRNIC, ERRVPM, ERRNFC, ERRJNI.
   655				@@ #
   656
   657	000355'	260040	000472'	KCBWAK::PUSHJ	P,FNDJOB	;CHECK US, LOOK AT JOB.
   658	000356'	263040	000000		POPJ	P,		;FAILURE.
   659
   660				    ;HERE ON FOUND JOB.
   661
   662	000357'	350001	000000		AOS	(P)		;SET UP FOR SKIP RETURN.
   663	000360'	201106	000000		MOVEI	J,(T1)		;GET JOB'S NUMBER IN J.
   664	000361'	135300	000000*		LDB	T1,JBYWAK	;JUMP IF HIBERING OR IF ENABLED
   665	000362'	326300	000000*		JUMPN	T1,TAKTRP	;FOR SOFTWRE INTRPT ON WAKE UUO.
   666	000363'	201300	200000		MOVEI	T1,WAKFLG	;SAY
   667	000364'	436302	000351*		IORM	T1,JBTSTS(J)	;"WAKE UP!"
   668	000365'	263040	000000		POPJ	P,		;AND
   669								;RETURN
   670								;TO
   671								;THE
   672								;USER
   673
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 17
CLUBS.MAC	17-SEP-87 16:45		DO THINGS TO JOBS IN YOUR CLUB

   674				COMMENT #
   675				@@SUBROUTINE KCBHNG
   676				@@PURPOSE
   677				SUBR FOR THE CLBHNG UUO.  HANGS UP A JOB IN THE SAME CLUB.
   678				@@ENTRY
   679				EXPECTS W/ VP NUMBER, J/ JOB NUMBER, AND P3 AND P4/ LMA
   680				INFORMATION.  EXPECTS THE VP TO EXIST.
   681				EXPECTS P2/ ID NUMBER OF SPECIFIED JOB.
   682				@@ACCUM
   683				DESTROYS T1-T4, P1-P4, J, U, PG, AND W.
   684				@@EXIT
   685				SKIP RETURNS ON SUCCESS.
   686				NON-SKIP RETURNS ON FAIL, WITH THE ERROR CODE IN THE RH(T1)
   687				AS FOLLOWS: ERRNIC, ERRVPM, ERRNFC, ERRJNI.
   688				@@ #
   689
   690	000366'	260040	000472'	KCBHNG::PUSHJ	P,FNDJOB	;IN CLUB, VP MATCHES, 1ST CLAS?
   691	000367'	263040	000000		POPJ	P,		;FAILURE.
   692
   693				    ;HERE ON FOUND JOB.
   694
   695	000370'	661300	000003		TLO	T1,3		;TELL HNGMON THIS IS A JOB # AND
   696	000371'	260040	000000*		PUSHJ	P,HNGMON	;FORCE LOGOUT EVN IF DET ON DIS.
   697	000372'	256000	000000'		STOPCD
   698	000373'	254000	000354*		JRST	CPOPJ1		;
   699
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 18
CLUBS.MAC	17-SEP-87 16:45		FORCE JOBS OUT OF CLUBS

   700				SUBTTL FORCE JOBS OUT OF CLUBS
   701				COMMENT #
   702				@@SUBROUTINE CBREMV
   703				@@PURPOSE
   704				CALLED WHEN A VP IS REMOVED FROM A JOB'S MAP TO THROW THE
   705				JOB OUT OF THE CLUB IT ENTERED VIA THAT VP, IF THERE
   706				IS SUCH A CLUB.
   707				@@ENTRY
   708				EXPECTS J/ JOB NUMBER
   709				EXPECTS W/ VP NUMBER
   710				@@ACCUM
   711				DESTROYS T1-T4
   712				@@ #
   713
   714	000374'	260040	000544'	CBREMV::PUSHJ	P, SRCCMC	;IN A CLUB WITH THIS VP?
   715	000375'	263040	000000		POPJ	P,		;NO -- JUST RETURN
   716
   717				    ;HERE TO LEAVE CLUB (T1/ CMC ADDR)
   718
   719	000376'	550446	000002		HRRZ	T4, CMCCDB(T1)	;T4/ CDB ADDR
   720	000377'	554351	000001		HLRZ	T2, CDBLOK(T4)	;T2/ INTERLOCKER CMC
   721	000400'	312300	000007		CAME	T1, T2		;IF IT'S NOT THE INTERLOCKER,
   722	000401'	324740	000142'		PJRST	RELCLB		;  JUST LEAVE THE CLUB
   723
   724				    ;HERE TO RELEASE THE INTERLOCK
   725
   726	000402'	261040	000006		PUSH	P, T1		;SAVE CMC ADDR
   727	000403'	260040	000244'		PUSHJ	P, RELINL	;RELEASE THE INTERLOCK
   728	000404'	205340	200000		MOVSI	T2, CD.NML
   729	000405'	412351	000002		ANDCAM	T2, CDBSTS(T4)	;AND MARK ABNORMAL RELEASE
   730	000406'	262040	000006		POP	P, T1		;RESTORE CMC ADDR
   731	000407'	324740	000142'		PJRST	RELCLB		;LEAVE THE CLUB AND RETURN
   732
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 19
CLUBS.MAC	17-SEP-87 16:45		FORCE JOBS OUT OF CLUBS

   733				COMMENT #
   734				@@SUBROUTINE CBSWER
   735				@@PURPOSE
   736				CALLED WHEN A JOB IS ABOUT TO BE ZAPPED BECAUSE OF A CONTEXT-PAGE
   737				SWAP ERROR TO FORCE THE JOB OUT OF ALL THE CLUBS IT'S IN.
   738				@@ENTRY
   739				EXPECTS J/ JOB NUMBER
   740				@@ACCUM
   741				DESTROYS T1-T4
   742				@@ #
   743
   744	000410'	550302	000300*	CBSWER::HRRZ	T1, JBTCLB(J)	;T1/ FIRST CMC FOR JOB
   745	000411'	322300	000172*		JUMPE	T1, CPOPJ	;NONE -- JUST RETURN
   746	000412'	261040	000006		PUSH	P, T1		;0(P)/ CMC ADDR
   747	000413'	550446	000002	CBSWE2:	HRRZ	T4, CMCCDB(T1)	;T4/ ITS CDB
   748	000414'	554351	000001		HLRZ	T2, CDBLOK(T4)	;T2/ ITS INTERLOCKER CMC
   749	000415'	312300	000007		CAME	T1, T2		;IF IT'S THE INTERLOCKER,
   750	000416'	254000	000422'		JRST	CBSWE3
   751	000417'	260040	000244'		PUSHJ	P, RELINL	;  RELEASE THE INTERLOCK
   752	000420'	205340	200000		MOVSI	T2, CD.NML
   753	000421'	412351	000002		ANDCAM	T2, CDBSTS(T4)	;  AND MARK ABNORMAL RELEASE
   754	000422'	200301	000000	CBSWE3:	MOVE	T1, 0(P)	;T1/ CMC ADDR
   755	000423'	260040	000142'		PUSHJ	P, RELCLB	;LEAVE THE CLUB
   756	000424'	200301	000000		MOVE	T1, 0(P)	;T1/ CMC ADDR (AGAIN?)
   757	000425'	550306	000001		HRRZ	T1, CMCJLK(T1)	;T1/ NEXT CMC FOR JOB
   758	000426'	322300	000000*		JUMPE	T1, TPOPJ
   759	000427'	202301	000000		MOVEM	T1, 0(P)
   760	000430'	254000	000413'		JRST	CBSWE2
   761
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 20
CLUBS.MAC	17-SEP-87 16:45		FORCE JOBS OUT OF CLUBS

   762				COMMENT #
   763				@@SUBROUTINE CBJERR
   764				@@PURPOSE
   765				CALLED BY THE CODE THAT SETS JERR TO KICK THE JOB OUT OF ALL
   766				THE CLUBS IT'S IN
   767				@@ENTRY
   768				EXPECTS J/ JOB NUMBER.
   769				@@ACCUM
   770				DESTROYS T1.
   771				@@ #
   772
   773	000431'	261040	000007	CBJERR::PUSH	P, T2
   774	000432'	261040	000010		PUSH	P, T3
   775	000433'	261040	000011		PUSH	P, T4		;SAVE T2-T4 FROM CBSWER
   776	000434'	260040	000410'		PUSHJ	P, CBSWER	;EXPEL JOB FROM CLUBS IT'S IN
   777	000435'	262040	000011		POP	P, T4
   778	000436'	262040	000010		POP	P, T3
   779	000437'	262040	000007		POP	P, T2		;RESTORE T2-T4
   780	000440'	263040	000000		POPJ	P,
   781
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 21
CLUBS.MAC	17-SEP-87 16:45		CHECK INTERLOCK AVAILABILITY ON CONTINUE

   782				SUBTTL CHECK INTERLOCK AVAILABILITY ON CONTINUE
   783				COMMENT #
   784				@@SUBROUTINE CBCONT
   785				@@PURPOSE
   786				SUBR CALLED BY SETRUN, WHEN SETRUN IS ABOUT TO SEND A JOB INTO
   787				ILWQ.  CBCONT CHECKS TO SEE IF THE JOB'S CLUB IS STILL INTER-
   788				LOCKED, AND IF IT ISN'T, GIVES THE INTERLOCK TO THE JOB AND SETS
   789				THE JOB UP TO GO INTO THE RNQ INSTEAD FOR THE ILWQ.
   790				@@ENTRY
   791				EXPECTS J/ JOB NUMBER AND T1/ ILWQ.
   792				@@ACCUM
   793				DESTROYS NO ACS EXCEPT PUTS ISQ IN T1 IF NECESSARY, SINCE
   794				SETRUN EXPECTS THIS.
   795				@@EXIT
   796				SEE ACCUM
   797				@@ #
   798
   799	000441'	554302	000410*	CBCONT::HLRZ	T1, JBTCLB(J)	;T1/ AWAITED CMC
   800	000442'	326300	000444'		JUMPN	T1, .+2
   801	000443'	256000	000000'		  STOPCD		;CAN'T GO INTO ILWQ WITHOUT ONE
   802	000444'	261040	000007		PUSH	P, T2
   803	000445'	261040	000011		PUSH	P, T4
   804
   805	000446'	550446	000002		HRRZ	T4, CMCCDB(T1)	;T4/ CDB ADDR
   806	000447'	554351	000001		HLRZ	T2, CDBLOK(T4)	;T2/ INTERLOCKER CMC
   807	000450'	322340	000453'		JUMPE	T2, CBCON2	;IF IT'S STILL INTERLOCKED,
   808	000451'	201300	000214*		MOVEI	T1, ILWQ	;  GO INTO ILWQ
   809	000452'	254000	000457'		JRST	CBCON3
   810
   811				    ;HERE WHEN CLUB IS NOT STILL INTERLOCKED
   812
   813	000453'	506311	000001	CBCON2:	HRLM	T1, CDBLOK(T4)	;MAKE US THE INTERLOCKER
   814	000454'	553002	000441*		HRRZS	JBTCLB(J)	;MARK US NO LONGER WAITING
   815	000455'	201300	000303*		MOVEI	T1, ISQ
   816	000456'	137300	000304*		DPB	T1, PJBSTS	;CHANGE WAIT STATE
   817
   818	000457'	262040	000011	CBCON3:	POP	P, T4
   819	000460'	262040	000007		POP	P, T2
   820	000461'	263040	000000		POPJ	P,
   821
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 22
CLUBS.MAC	17-SEP-87 16:45		LITTLE SUBROUTINES

   822				SUBTTL LITTLE SUBROUTINES
   823				COMMENT #
   824				@@SUBROUTINE CHKFRC
   825				@@PURPOSE
   826				CHECKS THAT THE JOB IS A FIRST-CLASS MEMBER OF THE CLUB
   827				SPECIFIED BY THE VP NUMBER IN W, AND FINDS THE CMC FOR THE
   828				CLUB.
   829				@@ENTRY
   830				EXPECTS W/ VP NUMBER, AND J/ JOB NUMBER.
   831				@@ACCUM
   832				DESTROYS T1-T2.
   833				@@EXIT
   834				SKIP-RETURNS IF OK, WITH T1/ CMC ADDR.
   835				NONSKIP-RETURNS ON ERRORS, WITH T1/ ERROR CODE (ERRNIC,
   836				ERRVPM, ERRNFC).
   837				@@ #
   838
   839	000462'	336002	000454*	CHKFRC:	SKIPN	JBTCLB(J)	;ARE WE IN A CLUB?
   840					JRST	[		;NO -- ERROR-RETURN
   841						MOVEI	T1, ERRNIC
   842						POPJ	P,
   843	000463'	254000	000576'		]
   844	000464'	260040	000544'		PUSHJ	P, SRCCMC	;ARE WE IN A CLUB WITH THIS VP?
   845					JRST	[		;NO -- ERROR-RETURN
   846						MOVEI	T1, ERRVPM
   847						POPJ	P,
   848	000465'	254000	000600'		]
   849	000466'	205340	400000		MOVSI	T2, CM.FRC
   850	000467'	616346	000002		TDNN	T2, CMCSTS(T1)	;ARE WE FIRST-CLASS?
   851					JRST	[		;NO -- ERROR-RETURN
   852						MOVEI	T1, ERRNFC
   853						POPJ	P,
   854	000470'	254000	000625'		]
   855	000471'	254000	000373*		JRST	CPOPJ1
   856
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 23
CLUBS.MAC	17-SEP-87 16:45		LITTLE SUBROUTINES

   857				COMMENT #
   858				@@SUBROUTINE FNDJOB
   859				@@PURPOSE
   860				CHECKS THAT THE CALLER IS A FIRST-CLASS MEMBER OF THE CLUB
   861				SPECIFIED, AND LOOKS FOR THE SPECIFIED JOB
   862				@@ENTRY
   863				EXPECTS W/ VP NUMBER, J/ JOB NUMBER, AND P2/ ID NUMBER OF
   864				SPECIFIED JOB.
   865				EXPECTS P3 AND P4 TO BE THE LMA INFORMATION. (NOT USED /AAA)
   866				@@ACCUM
   867				DESTROYS T1-T4 AND PG.
   868				@@EXIT
   869				SKIP RETURNS IF OKAY, WITH T1/ NUMBER OF SPECIFIED JOB.
   870				ELSE, NON-SKIP RETURNS WITH ERROR CODE ALREADY SET UP IN RH(T1)
   871				AS FOLLOWS: ERRNIC, ERRVPM, ERRNFC, ERRJNI.
   872				@@ #
   873
   874	000472'	260040	000462'	FNDJOB:	PUSHJ	P,CHKFRC	;IN CLUB, VP MATCHES, 1ST CLASS?
   875	000473'	263040	000000		POPJ	P,		;NO.
   876
   877				    ;LOOK FOR A JOB HAVING THE SPECIFIED ID
   878				    ;(T1/ CURRENT JOB'S CMC FOR THE CLUB)
   879
   880	000474'	550446	000002		HRRZ	T4, CMCCDB(T1)	;T4/ CDB ADDR
   881	000475'	550311	000001		HRRZ	T1, CDBCMC(T4)	;T1/ 1ST CMC FOR CLUB
   882	000476'	326300	000500'		JUMPN	T1, .+2
   883	000477'	256000	000000'		  STOPCD		;AT LEAST CURRENT JOB MUST BE IN CLUB
   884	000500'	135340	000010'	FNDJB2:	LDB	T2,CMYCID
   885	000501'	316640	000007		CAMN	P2,T2		;IS THISTHE SPECIFIED CLUB MEMBER
   886	000502'	254000	000507'		JRST	FNDJB3		;YES -- GO GET ITS JOB NUMBER
   887	000503'	550306	000000		HRRZ	T1, CMCCLK(T1)	;T1/ NEXT CMC FOR CLUB
   888	000504'	326300	000500'		JUMPN	T1, FNDJB2	;MORE JOBS IN CLUB?
   889	000505'	201300	000014		MOVEI	T1, ERRJNI	;NO -- ERROR-RETURN
   890	000506'	263040	000000		POPJ	P,
   891
   892				    ;HERE WITH T1/ THE CMC OF THE SPECIFIED JOB
   893
   894	000507'	554306	000002	FNDJB3:	HLRZ	T1, CMCJOB(T1)	;T1/ JOB NUMBER + ETC.
   895	000510'	405300	001777		ANDI	T1,CM.JMK	;T1/JOB NUMBER
   896	000511'	254000	000471*		JRST	CPOPJ1
   897
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 24
CLUBS.MAC	17-SEP-87 16:45		LITTLE SUBROUTINES

   898				COMMENT #
   899				@@SUBROUTINE SRCBTB
   900				@@PURPOSE
   901				SUBROUTINE TO SEARCH THE CLUB TABLE FOR A MATCH WITH THE
   902				RETRIEVAL PNTR ASSOCIATED WITH OUR LMA SLOT.
   903				@@ENTRY
   904				EXPECTS P3 AND P4 TO BE THE LMA SLOTS, J/ JOB NUMBER.
   905				EXPECTS THE PAGE TO EXIST.
   906				@@ACCUM
   907				DESTROYS T1-T4 AND PG.
   908				@@EXIT
   909				IF THERE IS A MATCH, SKIP RETURNS WITH T4/ ADDR OF ENTRY.
   910				IF THERE IS NO MATCH, NON-SKIP RETURNS WITH T2/ RETRIEVAL PNTR
   911				WITH RBREAL ON AND T3/ REL ADDR OF BASE ENTRY IN CLBTBL FOR THIS
   912				HASH CODE.
   913				@@ #
   914
   915	000512'	260040	000000*	SRCBTB:	PUSHJ	P,GETDPA	;GET T2/ RET PNTR FOR THIS PAGE.
   916	000513'	200400	000007		MOVE	T3,T2		;SET UP T3 FOR HASH.
   917	000514'	661340	000000*		TLO	T2,RBREAL	;MAKE GOOD RET PNTR.
   918	000515'	231400	000013		IDIVI	T3,HSHCLB 	;GET T4/ ADDRESS OF CLBTBL
   919	000516'	200400	000011		MOVE	T3,T4		;BASE FOR THIS HASH AND SAVE
   920	000517'	336451	000016'		SKIPN	T4,CLBTBL(T4)	;T4/ CDB ADDR OR 0
   921	000520'	263040	000000		POPJ	P,		;NO CDBS -- NONSKIP-RETURN
   922	000521'	316351	000000	SRCBT4:	CAMN	T2,CDBRET(T4)	;MATCH?
   923	000522'	254000	000511*		JRST	CPOPJ1		;YES, SUCCESS.
   924	000523'	550451	000002		HRRZ	T4,CDBHLK(T4)	;TRY FOR ANOTHER.
   925	000524'	326440	000521'		JUMPN	T4,SRCBT4	;JUMP IF THERE IS ONE.
   926	000525'	263040	000000		POPJ	P,		;OUR RET PNTR NOT FOUND.
   927
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 25
CLUBS.MAC	17-SEP-87 16:45		LITTLE SUBROUTINES

   928				COMMENT #
   929				@@SUBROUTINE ULKCDB
   930				@@PURPOSE
   931				SUBROUTINE TO REMOVE A CDB FROM THE CLBTBL HASH CHAIN IT'S IN.
   932				@@ENTRY
   933				EXPECTS T4/ CDB ADDR
   934				@@ACCUM
   935				DESTROYS T1-T2.
   936				@@EXIT
   937				EITHER NONSKIP-RETURNS WITH THE CDB DELETED FROM THE HASH CHAIN
   938				OR STOPCDS IF IT CAN'T FIND THE CDB.
   939				@@ #
   940
   941	000526'	200311	000000	ULKCDB:	MOVE	T1, CDBRET(T4)	;T1/ RETRIEVAL POINTER
   942	000527'	621300	000000*		TLZ	T1, RBMASK	;TURN OFF NON-ADDRESS BITS
   943	000530'	231300	000013		IDIVI	T1, HSHCLB	;T2/ HASH INDEX
   944	000531'	550307	000016'		HRRZ	T1, CLBTBL(T2)	;T1/ 1ST CDB ADDR FOR CHAIN
   945	000532'	316300	000011		CAMN	T1, T4		;IF IT'S US,
   946					JRST	[
   947						HRRZ	T1, CDBHLK(T1)
   948						MOVEM	T1, CLBTBL(T2)	;POINT CLBTBL AROUND US
   949						POPJ	P,		;AND RETURN
   950	000533'	254000	000627'		]
   951	000534'	336000	000006		SKIPN	T1		;IF IT'S 0,
   952	000535'	256000	000000'		  STOPCD		;  CRASH (CDB MUST BE IN TABLE)
   953	000536'	550346	000002	ULKCD2:	HRRZ	T2, CDBHLK(T1)	;T2/ SUCCESSOR
   954	000537'	316340	000011		CAMN	T2, T4		;IF IT'S US,
   955					JRST	[
   956						HRR	T2, CDBHLK(T2)
   957						HRRM	T2, CDBHLK(T1)	;POINT PREDECESSOR AROUND US
   958						POPJ	P,		;AND RETURN
   959	000540'	254000	000632'		]
   960	000541'	336300	000007		SKIPN	T1, T2		;IF IT'S 0,
   961	000542'	256000	000000'		  STOPCD		;  CRASH (CDB MUST BE IN TABLE)
   962	000543'	254000	000536'		JRST	ULKCD2
   963
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 26
CLUBS.MAC	17-SEP-87 16:45		LITTLE SUBROUTINES

   964				COMMENT #
   965				@@SUBROUTINE SRCCMC
   966				@@PURPOSE
   967				SUBROUTINE TO FIND THE CMC (IF THERE IS ONE) FOR A PARTICULAR
   968				VP FOR THIS JOB.
   969				@@ENTRY
   970				EXPECTS J/ JOB NUMBER, W/ VP NUMBER
   971				@@ACCUM
   972				DESTROYS T1-T2.
   973				@@EXIT
   974				SKIP-RETURNS WITH T1/ THE ADDRESS OF THE CMC FOR THE VP,
   975				OR NONSKIP-RETURNS IF THERE IS NONE.
   976				@@ #
   977
   978	000544'	550302	000462*	SRCCMC:	HRRZ	T1, JBTCLB(J)	;T1/ ADDR OF 1ST CMC FOR JOB
   979	000545'	322300	000411*		JUMPE	T1, CPOPJ	;NONE -- FAIL-RETURN
   980	000546'	135340	000007'	SRCCM2:	LDB	T2,CMYVPG
   981	000547'	316500	000007		CAMN	W, T2		;IF IT'S THE RIGHT CMC,
   982	000550'	254000	000522*		JRST	CPOPJ1		;  RETURN ITS ADDR
   983	000551'	550306	000001		HRRZ	T1, CMCJLK(T1)	;T1/ ADDR OF NEXT CMC
   984	000552'	326300	000546'		JUMPN	T1, SRCCM2
   985	000553'	263040	000000		POPJ	P,		;NO MORE -- FAIL-RETURN
   986
   987	000554'	201300	000001		$END	(CLB)

   988	000555'	254000	000044'

   989	000556'	201300	000002

   990	000557'	254000	000044'

   991	000560'	202313	000000

   992	000561'	350000	000101*

   993	000562'	260040	000000*

   994	000563'	370000	000561*

   995	000564'	254000	000057'

   996	000565'	001000	000000

   997	000566'	370011	000003

   998	000567'	201300	000004

   999	000570'	263040	000000

  1000	000571'	350000	000563*

  1001	000572'	260040	000562*

CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 26-2
CLUBS.MAC	17-SEP-87 16:45		LITTLE SUBROUTINES

  1002	000573'	370000	000571*

  1003	000574'	254000	000100'

  1004	000575'	202346	000000

  1005	000576'	201300	000005

  1006	000577'	263040	000000

  1007	000600'	201300	000006

  1008	000601'	263040	000000

  1009	000602'	201300	000007

  1010	000603'	263040	000000

  1011	000604'	506311	000001

  1012	000605'	254000	000224'

  1013	000606'	200347	000000

  1014	000607'	202307	000000

  1015	000610'	200300	000007

  1016	000611'	135300	000010'

  1017	000612'	135340	000352*

  1018	000613'	256200	000606'

  1019	000614'	256200	000607'

  1020	000615'	201300	000010

  1021	000616'	263040	000000

  1022	000617'	201300	000011

  1023	000620'	263040	000000

  1024	000621'	201300	000012

  1025	000622'	263040	000000

  1026	000623'	202447	000000

  1027	000624'	202407	000000

  1028	000625'	201300	000013
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 26-3
CLUBS.MAC	17-SEP-87 16:45		LITTLE SUBROUTINES


  1029	000626'	263040	000000

  1030	000627'	550306	000002

  1031	000630'	202307	000016'

  1032	000631'	263040	000000

  1033	000632'	540347	000002

  1034	000633'	542346	000002

  1035	000634'	263040	000000

  1036						;End of CLUBS (CLBLIT: CLBEND:)
  1037
NO ERRORS DETECTED
PROGRAM BREAK IS 000635
7K CORE USED
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 27
CLUBS.MAC	17-SEP-87 16:45		SYMBOL TABLE

ABTUUO		000223'	EXT	FCREQ		000573'	EXT	PJBSTS		000456'	EXT	
CBCON2		000453'		FCWAIT		000572'	EXT	PJRST	324740	000000		
CBCON3		000457'		FNDJB2		000500'		PUUOAC		000612'	EXT	
CBCONT		000441'	INT	FNDJB3		000507'		PX.MEM		000004	SPD	
CBJERR		000431'	INT	FNDJOB		000472'		PXCT	256000	000000		
CBREMV		000374'	INT	GETDPA		000512'	EXT	RBMASK		000527'	EXT	
CBSWE2		000413'		GETWDS		000102'	EXT	RBREAL		000514'	EXT	
CBSWE3		000422'		GIVWDS		000176'	EXT	REDLMA		000035'	EXT	
CBSWER		000410'	INT	HNGMON		000371'	EXT	RELCLB		000142'		
CD.EVI		100000	SPD	HSHCLB		000013	SPD	RELIN2		000250'		
CD.NML		200000	SPD	ILWQ		000451'	EXT	RELIN3		000266'		
CDBCID		000003	SIN	ISQ		000455'	EXT	RELIN4		000270'		
CDBCMC		000001	SIN	J		000002	INT	RELIN5		000277'		
CDBHLK		000002	SIN	JBTAWQ		000200'	EXT	RELIN6		000274'		
CDBLOK		000001	SIN	JBTCLB		000544'	EXT	RELIN7		000275'		
CDBRET		000000	SIN	JBTQ		000266'	EXT	RELINL		000244'		
CDBSTS		000002	SIN	JBTSTS		000364'	EXT	RNDMSK		000017	SPD	
CHKFRC		000462'		JBYWAK		000361'	EXT	S$ENTR	777777	777775	SIN	
CLBEND		000634'	INT	JOB		000040'	EXT	S$HALT	777777	777777	SIN	
CLBLIT		000554'	INT	KCBA3A		000057'		S$NAME		000000'	SPD	
CLBTBL		000016'		KCBA4A		000100'		S$NONA		000000	SIN	
CLUBS		000000'	ENT	KCBAD2		000052'		S$TEMP		000000	SPD	
CM.FRC		400000	SPD	KCBAD3		000055'		S$XCT	777777	777776	SIN	
CM.JMK		001777	SPD	KCBAD4		000073'		SETRUN		000305'	EXT	
CM.UNU		376000	SPD	KCBADD		000046'	INT	SRCBT4		000521'		
CMCCDB		000002	SIN	KCBERR		000044'		SRCBTB		000512'		
CMCCID		000003	SIN	KCBHNG		000366'	INT	SRCCM2		000546'		
CMCCLK		000000	SIN	KCBINI		000177'	INT	SRCCMC		000544'		
CMCJLK		000001	SIN	KCBINW		000200'	INT	T1		000006	INT	
CMCJOB		000002	SIN	KCBIW2		000224'		T2		000007	INT	
CMCSTS		000002	SIN	KCBKER		000031'	INT	T3		000010	INT	
CMCVPG		000003	SIN	KCBLEV		000131'	INT	T4		000011	INT	
CMNCID		000043	SPD	KCBME0		000322'		TAKTRP		000362'	EXT	
CMNVPG		000010	SPD	KCBME2		000327'		TPOPJ		000426'	EXT	
CMSCID		000033	SPD	KCBME4		000336'		ULKCD2		000536'		
CMSVPG		000011	SPD	KCBMEM		000311'	INT	ULKCDB		000526'		
CMYCID		000010'		KCBMRS		000343'		UPTIME		000256'	EXT	
CMYVPG		000007'		KCBRLI		000232'	INT	UPTLDC		000000	EXT	
CPOPJ		000545'	EXT	KCBSTS		000347'	INT	W		000012	INT	
CPOPJ1		000550'	EXT	KCBWAK		000355'	INT	WAKFLG		200000	SIN	
DIE		000000'	EXT	LENCDB		000004	SPD	WSCHED		000216'	EXT	
ERRAIL		000010	SIN	LENCMC		000004	SPD	ZZ	005557	664555	SPD	
ERRCNT		000012	SIN	LMMEXS		000036'	EXT	%UPLMA		000000	EXT	
ERRHIL		000007	SIN	LMPMXW		000120'	EXT	%UPT		000000	EXT	
ERRIDO		000004	SIN	LVCCNT		000015'		
ERRINC		000003	SIN	M		000013	INT	
ERRJNI		000014	SIN	MRQ		100000	SIN	
ERRNEX		000002	SIN	NODIE		000000	EXT	
ERRNFC		000013	SIN	P		000001	INT	
ERRNIC		000005	SIN	P1		000014	INT	
ERRNIL		000011	SIN	P2		000015	INT	
ERRVPM		000006	SIN	P3		000016	INT	
ERRVPR		000001	SIN	P4		000017	INT	

CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88
CLUBS.MAC	17-SEP-87 16:45		Symbol cross reference

ABTUUO	    28%	   408	   447
CBCON2	   807	   813#
CBCON3	   809	   818#
CBCONT	   799#
CBJERR	   773#
CBREMV	   714#
CBSWE2	   747#	   760
CBSWE3	   750	   754#
CBSWER	   744#	   776
CD.EVI	    76#	   452
CD.NML	    74#	   484	   728	   752
CDBCID	    78#	   232	   237	   240
CDBCMC	    72#	   233	   259	   263	   362	   374	   585	   881
CDBHLK	    77#	   230	   924	   947	   953	   956	   957
CDBLOK	    71#	   316	   412	   414	   443	   477	   536	   541	   720	   748	   806	   813
CDBRET	    70#	    80	   231	   922	   941
CDBSTS	    73#	   451	   453	   485	   729	   753
CHKFRC	   409	   474	   571	   839#	   874
CLBEND	  1036#
CLBLIT	   987#
CLBTBL	    96#	   228	   229	   920	   944	   948
CLUBS	    11	    12#	    15
CM.FRC	    46#	   277	   849
CM.JMK	    49#	   895
CM.UNU	    47#
CMCCDB	    50#	   278	   315	   340	   411	   476	   513	   577	   719	   747	   805	   880
CMCCID	    55#	    63
CMCCLK	    41#	    59	   261	   262	   355	   356	   358	   360	   595	   887
CMCJLK	    43#	   269	   270	   344	   345	   347	   349	   757	   983
CMCJOB	    48#	   278	   894
CMCSTS	    45#	   278	   850
CMCVPG	    52#	    62
CMNCID	    56#	    63	   238
CMNVPG	    53#	    62
CMSCID	    57#	    63	   238
CMSVPG	    54#	    62
CMYCID	    63#	   281	   429	   590	   884
CMYVPG	    62#	   279	   980
CPOPJ	    29%	   375	   745	   979
CPOPJ1	    29%	   176	   284	   456	   486	   599	   638	   698	   855	   896	   923	   982
DIE	    11	    11%	    12
ERRAIL	   123#	   433
ERRCNT	   128#	   574
ERRHIL	   120#	   319	   423
ERRIDO	   110#	   241
ERRINC	   108#	   201
ERRJNI	   134#	   889
ERRNEX	   105#	   170
ERRNFC	   130#	   852
ERRNIC	   113#	   304	   841
ERRNIL	   125#	   480
ERRVPM	   116#	   309	   846
ERRVPR	   103#	   165
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88
CLUBS.MAC	17-SEP-87 16:45		Symbol cross reference

FCREQ	    26%	   215	   218	   220	   247	   250	   252
FCWAIT	    26%	   219	   251
FNDJB2	   884#	   888
FNDJB3	   886	   894#
FNDJOB	   630	   657	   690	   874#
GETDPA	    29%	   915
GETWDS	    26%	   216	   248
GINST	   177#	   177	   178	   283#	   283	   284	   431#	   431	   432#	   432	   455#	   455	   456	   580#
	   580	   581	   591#	   591	   592	   598#	   598	   599	   637#	   637	   638
GIVWDS	    26%	   369	   379
HNGMON	    28%	   696
HSHCLB	    95#	    96	   918	   943
ILWQ	    27%	   440	   507	   808
ISQ	    27%	   545	   815
J	   172	   267	   271	   275	   302	   351	   407	   439	   446	   515	   543	   544	   548	   663
	   667	   744	   799	   814	   839	   978
JBTAWQ	    28%	   407
JBTCLB	    24%	   267	   271	   302	   351	   439	   446	   511	   533	   542	   744	   799	   814	   839
	   978
JBTQ	    27%	   507	   526
JBTSTS	    27%	   520	   635	   667
JBYWAK	    28%	   664
JOB	    29%	   172
KCBA3A	   214#	   221
KCBA4A	   246#	   253
KCBAD2	   200	   203#
KCBAD3	   204	   209#
KCBAD4	   205	   237#
KCBADD	   199#
KCBERR	   166	   171	   177#	   202
KCBHNG	   690#
KCBINI	   406#	   426
KCBINW	   407#
KCBIW2	   415	   445	   451#
KCBKER	   163#
KCBLEV	   302#
KCBME0	   583#	   609
KCBME2	   588#	   596
KCBME4	   589	   595#
KCBMEM	   571#
KCBMRS	   593	   606#
KCBRLI	   474#
KCBSTS	   630#
KCBWAK	   657#
LENCDB	    80#	   214	   378
LENCMC	    59#	   246	   368
LISTSN	     3	     6
LMMEXS	    25%	   169
LMPMXW	    25%	   276
LVCCNT	    89#	   338	   582	   592	   607
M	   177
MRQ	   521
NODIE	    11%
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88
CLUBS.MAC	17-SEP-87 16:45		Symbol cross reference

P	    12	   168	   174	   178	   199	   203	   209	   210	   216	   219	   227	   231	   242	   244
	   245	   248	   251	   255	   280	   305	   307	   310	   320	   322	   366	   369	   373	   376
	   409	   410	   424	   434	   442	   474	   475	   481	   483	   509	   535	   537	   543	   547
	   548	   549	   550	   571	   572	   575	   581	   597	   608	   630	   631	   657	   658	   662
	   668	   690	   691	   696	   714	   715	   726	   727	   730	   746	   751	   754	   755	   756
	   759	   773	   774	   775	   776	   777	   778	   779	   780	   802	   803	   818	   819	   820
	   842	   844	   847	   853	   874	   875	   890	   915	   921	   926	   949	   958	   985
P1	   174	   426	   509	   510	   523	   524	   531	   532	   535	   549	   577	   585
P2	   167	   573	   578	   589	   606	   885
P3	   169	   276	   582	   592	   607
P4	   578	   606
PJBSTS	    27%	   441	   546	   816
PUUOAC	    29%	   282	   430	   454	   579	   636
PX.MEM	   177	   283	   431	   432	   455	   580	   591	   598	   637
RBMASK	    29%	   942
RBREAL	    29%	   917
REDLMA	   157%	   168
RELCLB	   338#	   722	   731	   755
RELIN2	   511#	   527
RELIN3	   512	   516	   526#
RELIN4	   531#
RELIN5	   519	   522	   534	   541#
RELIN6	   531	   535#
RELIN7	   508	   536#
RELINL	   483	   507#	   727	   751
RNDMSK	   503#	   518
S$ENTR	    11	    17	   587	   697	   801	   883	   952	   961
S$HALT	    11	   587	   697	   801	   883	   952	   961
S$NAME	    15#	   587	   697	   801	   883	   952	   961
S$NONA	    14	    17	   587	   697	   801	   883	   952	   961
S$TEMP	    11#	    11	   587#	   587	   697#	   697	   801#	   801	   883#	   883	   952#	   952	   961#	   961
S$XCT	    17	   587	   697	   801	   883	   952	   961
SETRUN	    27%	   547
SRCBT4	   922#	   925
SRCBTB	   203	   915#
SRCCM2	   980#	   984
SRCCMC	   199	   307	   714	   844	   978#
T1	    62	    63	   163	   165	   170	   177	   201	   226	   228	   230	   241	   261	   262	   263
	   269	   270	   271	   278	   282	   283	   304	   309	   315	   317	   319	   340	   344	   345
	   355	   356	   367	   368	   374	   375	   378	   411	   414	   421	   423	   428	   429	   432
	   433	   439	   444	   451	   455	   476	   478	   480	   507	   508	   511	   515	   520	   524
	   526	   527	   532	   533	   542	   544	   545	   546	   574	   577	   585	   586	   595	   596
	   635	   637	   663	   664	   665	   666	   667	   695	   719	   721	   726	   730	   744	   745
	   746	   747	   749	   754	   756	   757	   758	   759	   799	   800	   805	   808	   813	   815
	   816	   841	   846	   850	   852	   880	   881	   882	   887	   888	   889	   894	   895	   941
	   942	   943	   944	   945	   947	   948	   951	   953	   957	   960	   978	   979	   983	   984
T2	   167	   209	   214	   237	   238	   244	   246	   259	   260	   261	   262	   267	   268	   269
	   270	   280	   281	   283	   315	   316	   317	   340	   362	   366	   367	   377	   412	   413
	   421	   428	   430	   431	   432	   440	   441	   443	   444	   452	   453	   454	   455	   477
	   478	   484	   485	   511	   512	   513	   533	   541	   579	   580	   581	   584	   591	   594
	   597	   598	   608	   636	   637	   720	   721	   728	   729	   748	   749	   752	   753	   773
	   779	   802	   806	   807	   819	   849	   850	   884	   885	   916	   917	   922	   944	   948
	   953	   954	   956	   957	   960	   980	   981
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88
CLUBS.MAC	17-SEP-87 16:45		Symbol cross reference

T3	   210	   227	   228	   229	   344	   346	   347	   349	   351	   355	   357	   358	   360	   362
	   513	   514	   517	   518	   520	   521	   583	   588	   598	   774	   778	   916	   918	   919
T4	   226	   229	   230	   231	   232	   233	   237	   240	   245	   255	   259	   263	   275	   277
	   278	   345	   347	   348	   349	   356	   358	   359	   360	   373	   374	   377	   411	   412
	   414	   443	   451	   453	   476	   477	   485	   514	   536	   541	   590	   591	   719	   720
	   729	   747	   748	   753	   775	   777	   803	   805	   806	   813	   818	   880	   881	   919
	   920	   922	   924	   925	   941	   945	   954
TAKTRP	    28%	   665
TPOPJ	    29%	   758
ULKCD2	   953#	   962
ULKCDB	   376	   941#
UPTIME	   501%	   517
UPTLDC	   157%
W	   163	   164	   279	   981
WAKFLG	   666
WSCHED	    27%	   442
ZZ	   177#	   177	   283#	   283	   431#	   431	   432#	   432	   455#	   455	   580#	   580	   591#	   591
	   598#	   598	   637#	   637
ZZ1	   177#	   177	   283#	   283	   431#	   431	   432#	   432	   455#	   455	   580#	   580	   591#	   591
	   598#	   598	   637#	   637
%UPLMA	    25%
%UPT	   157%
CLUBS	UUOS FOR CLUBS	MACRO 12.5-46.0 14:29 13-JAN-88
CLUBS.MAC	17-SEP-87 16:45		Macro/Opdef cross reference

PJRST	   379	   408	   447	   722	   731
PXCT	   177	   283	   431	   432	   455	   580	   591	   598	   637
PXGEN	   177	   283	   431	   432	   455	   580	   591	   598	   637
STOPCD	    10	   587	   697	   801	   883	   952	   961
UMOVE	   431	   580
UMOVEM	   177	   283	   432	   455	   591	   598	   637
XCTFU	   431	   580
XCTTU	   177	   283	   432	   455	   591	   598	   637
$END	   987YMful
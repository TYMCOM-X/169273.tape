APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)	MACRO 12.5-46.0 14:59 13-JAN-88 PAGE 1
S.MAC	13-JAN-88 11:55		S.MAC - with system parameter file for P035/D, January 1988

     1				SUBTTL	S.MAC - with system parameter file for P035/D, January 1988
     2
     3				IF2,<IFNDEF LISTSN,<TAPE>>	;Skip to PASS2 in all but COMMON.LST
     4				;THIS MODULE ASSEMBLED WITH FOONLY PARAMETER FILE - F3SYM.MAC
     5
     6					IF2,<IFNDEF LISTSN,<		;LIST F3SYM.MAC IN COMMON ONLY
     7								TAPE>>
     8				TITLE	APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)
     9
    10					STOPCD(,ENTRY,APXKON)^
    11					ENTRY	APXKON		;For library searches
    12	000000'	260040	000010	APXKON::PUSHJ	P,DIE		;**** Default stopcode for "APXKON" ****
    13	000001'	416070	535756		SIXBIT	/APXKON/  	;Title of module
    14	000002'	000000	000000		S$NONAME,,0		;?NONAME stopcode "APXKON+nnn(nnnnnn)"
    15			000000'	S$NAME==APXKON			;For STOPCDs with no arguments
    16					SALL>
    17				^
    18
    19			000000		ND	FTDPAG,0	;Use UNIBLK instead of UNIPAG
    20				EXTERN BITTBL,APACB
    21				EXTERN UNIPPU,UNYPPY,UNYPUN,UNICYL,UNITWC,UNISBS,UNISBH,SBSIZ
    22				EXTERN KCMOFL,%OFLER,%OFLRS,KONCUA,KCMPOS
    23				EXTERN KCMDTA,KONPTR
    24				EXTERN KCMFUS,KCMERR,KCMRER
    25				EXTERN UNIRCT,UNPDEV,EPT,UNIDES,UNYUTP,UNPFUS,UNPOFL
    26				EXTERN UNYOCV,UNYRTO,UNYRCO,UNYOS,UNIRC1,UNISB,UNICHR,UNIONC
    27				IFE FTDPAG,<EXTERN UNIBLK,UNYBPT>	;Position, blocks per track
    28				IFN FTDPAG,<EXTERN UNIPAG,UNYPPT>	;Position, pages per track
    29
    30				DEFINE DSKOFF<CONO PI,DSKPIF##>
    31				DEFINE DSKON<CONO PI,DSKPIN##>
    32
    33			000000	DSKCHN==APXCHN##	;PIA FOR DISK CONTROLLER
    34
    35				;BIT TABLE, LSB=INDEX 0
    36			000001	ZOT==1
    37	000003'			TIBTBL::
    38				REPEAT ^D36,<ZOT
    39				ZOT==ZOT+ZOT>
    40	000003'	000000	000001
    41	000004'	000000	000002
    42	000005'	000000	000004
    43	000006'	000000	000010
    44	000007'	000000	000020
    45	000010'	000000	000040
    46	000011'	000000	000100
    47	000012'	000000	000200
    48	000013'	000000	000400
    49	000014'	000000	001000
    50	000015'	000000	002000
    51	000016'	000000	004000
    52	000017'	000000	010000
    53	000020'	000000	020000
APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)	MACRO 12.5-46.0 14:59 13-JAN-88 PAGE 1
APXKON.MAC	17-SEP-87 16:39		S.MAC - with system parameter file for P035/D, January 1988

    54	000021'	000000	040000
    55	000022'	000000	100000
    56	000023'	000000	200000
    57	000024'	000000	400000
    58	000025'	000001	000000
    59	000026'	000002	000000
    60	000027'	000004	000000
    61	000030'	000010	000000
    62	000031'	000020	000000
    63	000032'	000040	000000
    64	000033'	000100	000000
    65	000034'	000200	000000
    66	000035'	000400	000000
    67	000036'	001000	000000
    68	000037'	002000	000000
    69	000040'	004000	000000
    70	000041'	010000	000000
    71	000042'	020000	000000
    72	000043'	040000	000000
    73	000044'	100000	000000
    74	000045'	200000	000000
    75	000046'	400000	000000
    76
    77				OPDEF CALL [PUSHJ P,]		;SUBROUTINE ENTRY/EXIT
    78				OPDEF RET [POPJ P,]
    79
    80			020000	RTYCNT==20000			;HOW MANY CYCLES TO WAIT
APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)	MACRO 12.5-46.0 14:59 13-JAN-88 PAGE 2
APXKON.MAC	17-SEP-87 16:39		Disk geometry

    81				SUBTTL	Disk geometry
    82			000000	AMPEX==0	; 75 megabyte
    83			000001	CDC==  1	;150 megabyte
    84			000002	NAMPEX==2	;300 megabyte
    85
    86			000001	DRVTYP==CDC	;X930 and X62 both use CDC disks
    87
    88				IFE DRVTYP-CDC,<  ;150 megabyte
    89			000010	PPT==^D8		;Sectors (pages) per track
    90			000012	TPC==^D10		;Tracks per cylinder (# of heads)
    91			001455	CPU==^D823-^D10		;Cylinders per unit (minus 10 maintainence cylinders)
    92			041624	USPR==^D17300		;Microseconds per revoluntion
    93				>
    94				IFE DRVTYP-AMPEX,< ;Old 75 megabyte
    95				PPT==^D8		;Sectors (pages) per track
    96				TPC==^D5		;Tracks per cylinder (# of heads)
    97				CPU==^D815-^D5		;Cylinders per unit (minus 5 for maintainence)
    98				USPR==^D17300		;Microseconds per revoluntion
    99				>
   100				IFE DRVTYP-NAMPEX,< ;New 300 megabyte
   101				PPT==^D?		;SECTORS PER TRACK
   102				TPC==^D?		;TRACKS PER CYL (NUMBER OF HEADS)
   103				CPU==^D???-^D?		;CYLINDERS PER UNIT (TAKE AWAY SOME FOR MAINTAINENCE)
   104				USPR==^D?		;Microseconds per revoluntion
   105				>
   106			000120	PPC==PPT*TPC		;Pages per cylinder
   107			177020	PPU==PPC*CPU		;Pages per unit
   108			000040	BPT==PPT*4		;Blocks per track
   109			000500	BPC==PPC*4		;Blocks per cylinder
   110
   111				SUBTTL	DISK IOTS AND REGISTER BIT NAMES.
   112				OPDEF	RCMD	[715000000000]	;READ DISK COMMAND REGISTER
   113		400000	000000		SUNT==1B0		;SELECTED UNIT NOT THERE (SELECT ERROR)
   114		200000	000000		SUWP==1B1		;SELECTED UNIT WRITE PROTECT
   115		100000	000000		SUNR==1B2		;SELECTED UNIT NOT READY
   116				;---
   117		040000	000000		SUOC==1B3		;SELECTED UNIT ON CYLINDER
   118								; SHOULD ALWAYS BE SET EXCEPT AFTER RECAL UNTIL HEADS ALIGN
   119		020000	000000		SUSE==1B4		;SELECTED UNIT SEEK ERROR (DETECTED BY DRIVE)
   120								; RECAL MANDATORY AFTER THIS ERROR, FAULT CLEAR WILL NOT TURN T
   121				HIS OFF.
   122		010000	000000		SUF==1B5		;SELECTED UNIT FAULT (DETECTED BY DRIVE)
   123				;---
   124		004000	000000		SUA==1B6		;SELECTED UNIT ATTENTION
   125								; SET BY LEADING EDGE OF ON CYLINDER (BIT 3)
   126		002000	000000		HDECC==1B7		;ECC ERROR ON HEADER
   127		001000	000000		CI==1B8			;CONTROL IDLE (ONLY IF NO DATA XFER AND NO SEEKS OR RECALS GOIN

   128				G)
   129				;---
   130		000400	000000		SECC==1B9		;SOFT ECC ERROR (NOT YET IMPLEMENTED IN F3 MICROCODE)
   131		000200	000000		HECC==1B10		;ECC UNRECOVERABLE ERROR
   132
APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)	MACRO 12.5-46.0 14:59 13-JAN-88 PAGE 2-2
APXKON.MAC	17-SEP-87 16:39		DISK IOTS AND REGISTER BIT NAMES.

   133				;FOLLOWING BITS ARE DETECTED BY CONTROLLER:
   134		000100	000000		ROE==1B11		;READ OVERRUN ERROR
   135				;---
   136		000040	000000		WOE==1B12		;WRITE OVERRUN ERROR
   137		000020	000000		SOE==1B13		;SECTOR OVERRUN ERROR
   138		000010	000000		IPE==1B14		;INTERNAL PARITY ERROR (ONLY VALID IF AE, BIT 28, IS ZERO)
   139				;---
   140
   141				;FOLLOWING ARE FROM LAST LCMD
   142
   143		000004	000000		USC==1B15		;USE SECTOR COUNTER (FOR RPS, TELLS
   144								; CONTROLLER TO LISTEN TO DRIVE POSITION)
   145		000002	000000		REL==1B16		;RELEASE (FOR MULTI-PROCESSOR INTERLOCKING)
   146		000001	000000		RECAL==1B17		;RECALIBRATE (RESETS SEEK ERROR) (USE WITH CF AND FC)
   147				;---
   148			400000		FC==1B18		;FAULT CLEAR (RESETS SEL UNIT FAULT - USE COMMAND 4)
   149				;	19 UNUSED
   150				;	20 UNUSED
   151				;---
   152			040000		SOM==1B21		;SERVO OFFSET MINUS
   153			020000		SOP==1B22		;SERVO OFFSET PLUS (OFFSET ONLY ON AMPEX DRIVES, NOT CDC)
   154			010000		CFM==1B23		;COMMAND FROM MEMORY
   155								; SENDS DATA FROM MEMORY TO DISK (USE WITH WRITE COMMANDS)
   156				;---
   157			004000		CMD0==1B24		;COMMAND BITS
   158			002000		CMD1==1B25
   159			001000		CMD2==1B26
   160				;---
   161			000400		CMD32==1B27		;32 BIT MODE PACKING
   162			000000			READ==0B26		;READ PAGE
   163			011000			WRITE==CFM+1B26	;WRITE PAGE (WITH CFM FOR CONVENIENCE)
   164			003000			WRITEA==3B26	;WRITE ALL (SECTOR AND FORMAT DATA)
   165			004000			CF==4B26		;CONTROL FUNCTION
   166				;		SEEK==5B26		;SEEK. (NOT IMPLEMENTED YET . . .)
   167
   168				;END OF FROM RCMD BITS
   169			000200		AE==1B28		;ANY  ERROR (EXCEPT IPE, BIT 14)
   170			000100		AA==1B29		;ANY UNIT ATTENTION
   171				;---
   172
   173				;FROM LCMD
   174			000040		AAIE==1B30		;ANY ATTENTION INTERRUPT ENABLE
   175
   176			000020		NA==1B31		;NOT ACTIVE
   177			000010		DIE==1B32		;DONE INTERRUPT ENABLE (SET BY DCONO WITH NOZERO PI ASSIGNMENT)

   178
   179				;---
   180				;BITS 33, 34 NOT IMPLEMENTED.
   181
   182			000001		MPE==1B35		;MEMORY PARITY ERROR
   183				;---
   184				OPDEF	RMA	[716000000000]	;READ DISK MEMORY ADDRESS
APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)	MACRO 12.5-46.0 14:59 13-JAN-88 PAGE 2-3
APXKON.MAC	17-SEP-87 16:39		DISK IOTS AND REGISTER BIT NAMES.

   185				OPDEF	RDA	[717000000000]	;READ DISK ADDRESS (IN PAGES)
   186			000003		AMSUNI==^D3		;SIZE OF UNIT BYTE
   187			000006		AMPUNI==^D6		;RIGHTMOST BIT
   188		777777	777771		ROTUNI==-<AMPUNI+1>	;NUMBER OF PLACES TO ROTATE TO GET UNIT FIELD IN
   189			000014		AMSCYL==^D12
   190			000023		AMPCYL==^D19
   191			000010		AMSTRK==^D8
   192			000033		AMPTRK==^D27
   193			000010		AMSSEC==^D8
   194			000043		AMPSEC==^D35
   195		034000	177400		LDAMSK==034000,,177400	;MASK FOR $0% AND $0O IN DDT
   196				OPDEF	RECC	[720000000000]	;READ DISK CONTROL REGISTER
   197				OPDEF	LCMD	[721000000000]	;LOAD DISK COMMAND REGISTER
   198		000004	000000		USC==1B15		;USE SECTOR COUNTER (FOR RPS, TELLS
   199								; CONTROLLER TO LISTEN TO DRIVE POSITION)
   200		000002	000000		REL==1B16		;RELEASE (FOR MULTI-PROCESSOR INTERLOCKING)
   201		000001	000000		RECAL==1B17		;RECALIBRATE (RESETS SEEK ERROR) (USE WITH CF AND FC)
   202			400000		FC==1B18		;FAULT CLEAR (RESETS SEL UNIT FAULT - USE COMMAND 4)
   203			040000		SOM==1B21		;SERVO OFFSET MINUS
   204			020000		SOP==1B22		;SERVO OFFSET PLUS (OFFSET ONLY ON AMPEX DRIVES, NOT CDC)
   205			010000		CFM==1B23		;COMMAND FROM MEMORY
   206								; SENDS DATA FROM MEMORY TO DISK (USE WITH WRITE COMMANDS)
   207			004000		CMD0==1B24		;COMMAND BITS
   208			002000		CMD1==1B25
   209			001000		CMD2==1B26
   210			000400		CMD32==1B27		;32 BIT MODE PACKING
   211			000000			READ==0B26		;READ PAGE
   212			011000			WRITE==CFM+1B26	;WRITE PAGE (WITH CFM FOR CONVENIENCE)
   213			003000			WRITEA==3B26	;WRITE ALL (SECTOR AND FORMAT DATA)
   214			004000			CF==4B26		;CONTROL FUNCTION
   215				;		SEEK==5B26		;SEEK. (NOT IMPLEMENTED YET . . .)
   216			000040		AAIE==1B30		;ANY ATTENTION INTERRUPT ENABLE
   217			000010		DIE==1B32		;DONE INTERRUPT ENABLE (SET BY DCONO WITH NOZERO PI ASSIGNMENT)

   218
   219				OPDEF	LMA	[722000000000]	;LOAD DISK MEMORY ADDRESS
   220				OPDEF	LDA	[723000000000]	;LOAD DISK ADDRESS
   221		002000	000000		SU==1B7			;SELECT UNIT
   222								;MUST BE CLEARED AND SET TO SELECT A UNIT.
   223				OPDEF	LECC	[724000000000]	;CLEARS ECC LOGIC, STARTS AND INITS CONTROL.
   224			000001		SC==1			;START CONTROL
   225			000002		IC==2			;INIT CONTROL (SEND BEFORE STARTING CMD)
   226				OPDEF	DCONO	[740000000000]	;CONO TO DISK CONTROL TO SET PI ASSIGNMENT
   227			000020		ATNENB==20		;ENABLE FOR ATTENTION BIT
   228				OPDEF	DCONI	[741000000000]	;CONI FROM DISK CONTROL OPCODE
   229			000010		DIDLE==10		;SET IF CONTROL IS IDLE
   230			000007		DPIA==7B35		;PI ASSIGNMENT.
   231								;NOTE THAT NONZERO PI ASSIGNMENT SETS DIE (SEE LCMD)
   232				OPDEF	DCONSO	[742000000000]	;DISK CONSO
   233				OPDEF	DCONSZ	[743000000000]	;DISK CONSZ
APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)	MACRO 12.5-46.0 14:59 13-JAN-88 PAGE 3
APXKON.MAC	17-SEP-87 16:39		BITS FOR FAKED UP CONI

   234				SUBTTL	BITS FOR FAKED UP CONI
   235
   236			000040	ERRCMR==1B30			;COMMAND REJECT (WRITE LOCK, ETC)
   237			000100	ERRBOP==1B29			;BUS OUT PARITY
   238			000200	ERRBIP==1B28	;BUS IN PARITY
   239			001000	ERRUNK==1B26	;UNKNOWN ERROR (NO BITS CHECK BUT UNIT CHECK)
   240			002000	ERROVR==1B25	;OVERRUN
   241			010000	ERRPAR==1B23	;PARITY ERROR
   242			040000	ERRINV==1B21	;INVALID TRACK FORMAT
   243			100000	ERRRCV==1B20	;RECOVERABLE DATA CHECK
   244			200000	ERRDTA==1B19	;UNRECOVERABLE DATA CHECK
   245			400000	ERRCNT==1B18	;COUNT ERROR (CHANNEL TERMINATION)
   246		000002	000000	ERRATN==1B16	;ATTENTION FLAG
   247		000010	000000	ERREQP==1B14	;PERMANENT EQUIPMENT CHECK
   248		000020	000000	ERREQC==1B13	;EQUIPMENT CHECK
   249		000040	000000	ERRLEN==1B12	;LENGTH ERROR
   250		000100	000000	ERRCON==1B11	;CONTROL ERROR
   251		000200	000000	ERRSEL==1B10	;SELECT ERROR
   252		000400	000000	ERRWPT==1B9	;WRITE PROTECT ERROR COMMAND REJECT ALSO ON
APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)	MACRO 12.5-46.0 14:59 13-JAN-88 PAGE 4
APXKON.MAC	17-SEP-87 16:39		ROUTINE TO START A FUNCTION UP ON CONTROL

   253				SUBTTL	ROUTINE TO START A FUNCTION UP ON CONTROL
   254
   255				DEFINE KONSTR(LOC)<
   256					LECC	[IC]		;INIT CONTROL
   257					LCMD	LOC		;DO THE COMMAND
   258					LECC	[SC]		;START CONTROLLER
   259				>;END KONSTR MACRO DEFINITION
   260
   261
   262
   263	000047'	740000	000000	CLRKON:	DCONO	0		;MAKE SURE NO INTERRUPT GENERATED FROM THIS
   264	000050'	724000	000641'		KONSTR(<[CF+FC]>)
   265	000051'	721000	000642'
   266	000052'	724000	000643'
   267					;COMMAND FUNCTION FAULT CLEAR
   268	000053'	201340	020000	WATKON:	MOVEI	T2,RTYCNT	;NUMBER OF TIMES TO WAIT
   269	000054'	715000	000006		RCMD	T1
   270	000055'	607300	001000		TLNN	T1,(CI)		;CONTLOL IDLE YET?
   271	000056'	367340	000054'		SOJG	T2,.-2		;NO
   272	000057'	327340	000137'		JUMPG	T2,CPOPJ1	;JUMP IF IT WENT IDLE
   273	000060'	263040	000000		POPJ	P,		;DIDN'T.
   274
   275				;ROUTINE TO START NEXT TRANSFER.
   276				;DON'T INDEX BY J HERE TO SAVE TIME (ONLY 60US, THIS ROUTINE TAKES 36 US
   277				; WITH (J)!). IF HAVE OTHER KONTROLLERS LATER, MUST FIGURE OUT WHAT TO DO -
   278				; PROBABLY WILL HAVE TO HAVE 1 ROUTINE FOR EACH KONTROLLER.
   279				;UNIT MUST ALREADY BE SELECTED.
   280
   281				DEFINE NXTXFR <
   282					LMA	@KONNLM+APACB	;LOAD MEM ADDRESS
   283					LDA	KONNLD+APACB
   284					LDA	KONNL1+APACB	;NOW WITH SU BIT SET
   285					KONSTR(<KONNCM+APACB>)		;START UP TRANSFER
   286					DCONO	DSKCHN		;
   287				>
APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)	MACRO 12.5-46.0 14:59 13-JAN-88 PAGE 5
APXKON.MAC	17-SEP-87 16:39		INTERFACE TO FILIO AND FRIENDS.

   288				SUBTTL	INTERFACE TO FILIO AND FRIENDS.
   289
   290				;INITIALIZE UNIT AND SET PARAMETERS IN UDB.
   291
   292	000061'	205400	404000	APXCPY::MOVSI	T3,(1B0+4B8)	;Set the sign bit, 4 blocks per record
   293	000062'	202405	000000*		MOVEM	T3,UNICHR(U)	;Formatted in pages
   294	000063'	201400	000002		MOVEI	T3,2
   295	000064'	137400	000000*		DPB	T3,UNYUTP	;2 for CDC disks formatted in pages
   296	000065'	201300	000120		MOVEI	T1,PPC
   297	000066'	137300	000000*		DPB	T1,UNYPPY	;Pages per cylinder
   298	000067'	201300	177020		MOVEI	T1,PPU
   299	000070'	202305	000000*		MOVEM	T1,UNIPPU(U)	;Pages per unit
   300	000071'	201300	000040		MOVEI	T1,BPT
   301	000072'	137300	000000*		DPB	T1,UNYBPT	;Blocks per track
   302	000073'	135300	000000*		LDB	T1,UNYPUN	;SELECT DRIVE
   303	000074'	241300	777771		ROT	T1,ROTUNI
   304	000075'	723000	000006		LDA	T1		;SELECT DRIVE
   305	000076'	661300	002000		TLO	T1,(<SU>)
   306	000077'	723000	000006		LDA	T1
   307	000100'	260040	000047'		PUSHJ	P,CLRKON	;CLEAR CONTROL
   308	000101'	255000	000000		  JFCL			;IGNORE IF COULDN'T DO IT SO WE CAN GET ERROR STATUS.
   309	000102'	715000	000006		RCMD	T1		;GET STATUS
   310	000103'	321300	000133'		JUMPL	T1,CPYOFL	;JUMP IF SELECT ERROR.
   311	000104'	205340	200000		MOVSI	T2,200000	;SET/CLEAR WRITE LOCK STATUS
   312	000105'	607300	200000		TLNN	T1,(<SUWP>)
   313	000106'	201340	000000		 MOVEI	T2,0
   314	000107'	202345	000000*		MOVEM	T2,UNIONC(U)	;Set 1B1 if write locked
   315	000110'	603300	010160		TLNE	T1,(SUF+ROE+WOE+SOE) ;ANY WEIRD ERROR BITS?
   316	000111'	254000	000131'		 JRST	CPYERR		;YES, LET ONCE TELL POOR GUY
   317	000112'	724000	000641'		KONSTR(<[CF+FC+RECAL]>)
   318	000113'	721000	000644'
   319	000114'	724000	000643'
   320	000115'	260040	000053'		PUSHJ	P,WATKON	;DO IT
   321	000116'	254000	000131'		  JRST	CPYERR		;COULD NOT, STORE ERROR STATUS IN ERRCPY
   322	000117'	205340	000001		MOVSI	T2,1		;WAIT A LONG TIME FOR RECAL TO FINISH
   323	000120'	715000	000006		RCMD	T1
   324	000121'	606300	000020		TRNN	T1,NA
   325	000122'	367340	000120'		 SOJG	T2,.-2
   326	000123'	322340	000131'		JUMPE	T2,CPYERR
   327	000124'	603300	030160		TLNE	T1,(SUSE+SUF+ROE+WOE+SOE)
   328	000125'	254000	000131'		 JRST	CPYERR
   329	000126'	135300	000073*		LDB	T1,UNYPUN
   330	000127'	200306	000000*		MOVE	T1,BITTBL(T1)
   331	000130'	254000	000000*		JRST	FILINT##
   332
   333	000131'	202300	000761'	CPYERR:	MOVEM	T1,ERRCPY#	;STORE FOR DIAGNOSTIC PURPOSES
   334	000132'	334300	000645'		SKIPA	T1,[%OFLER]	;Offline - error
   335	000133'	201300	000000*	CPYOFL:	 MOVEI	T1,%OFLRS	;Offline - no response
   336	000134'	202305	000107*		MOVEM	T1,UNIONC(U)
   337	000135'	205300	000000*		MOVSI	T1,KCMOFL
   338	000136'	254000	000130*		JRST	FILINT##
APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)	MACRO 12.5-46.0 14:59 13-JAN-88 PAGE 6
APXKON.MAC	17-SEP-87 16:39		INTERFACE TO FILIO AND FRIENDS.

   339				;SKIP IF CONTROLLER UP, SINGLE RETURN IF NOT.
   340	000137'			APXUPA::
   341	000137'	350001	000000	CPOPJ1:	AOS (P)
   342	000140'	263040	000000	CPOPJ:	RET
   343
   344				;STOP HUNG CONTROLLER.  SINGLE RETURN IF OPERATION WASN'T
   345				; BE RESTARTED, SKIP IF IT WAS.  CURRENTLY, ALWAYS SINGLE RETURNS.
   346	000141'	261040	000006	APXSTP::PUSH	P,T1		;MUST PRESERVE T1
   347	000142'	260040	000047'		PUSHJ	P,CLRKON
   348	000143'	255000	000000		  JFCL
   349	000144'	262040	000006		POP	P,T1
   350	000145'	402002	000000*		SETZM	KONCUA(J)	;INIDICATE THAT NO XFER GOING NOW.
   351	000146'	402002	000000*		SETZM	KONXFR(J)	;CLEAR OUT FLAG THAT WOULD START A TRANSFER
   352								; ON NEXT DISK INTERRUPT
   353	000147'	263040	000000		POPJ	P,
   354
   355				;ISSUE RECALIBRATE (SAME EFFECT AS SEEK TO
   356				; CYLINDER 0, BUT DOESN'T USE SEEK CIRCUITRY). NON-SKIP RETURN ALWAYS.
   357	000150'	740000	000000	APXRCL::DCONO	0		;MAKE SURE NO INTERRUPT COMES IN FOR THIS
   358								;COMMAND FINISH.
   359	000151'	724000	000641'		KONSTR(<[CF+FC+RECAL]>)
   360	000152'	721000	000644'
   361	000153'	724000	000643'
   362	000154'	260040	000053'		PUSHJ	P,WATKON	;DO COMMAND, WAIT FOR CONTROL TO RETURN
   363			;THEN DRIVE IS STARTING TO RECAL.
   364								;FUNCTIONS DONE TO CONTROL AFTER THIS WILL WAIT TILL RECAL IS F
   365				INISHED.
   366	000155'	255000	000000		  JFCL			;IGNORE
   367	000156'	135640	000126*		LDB	P2,UNYPUN	;GET UNIT NUMBER
   368	000157'	200655	000127*		MOVE	P2,BITTBL(P2)	;GET BIT
   369	000160'	437640	000536'		IORB	P2,SEKWRD	;RECAL SAME AS SEEK
   370	000161'	324740	000320'		PJRST	SEKXIT		;GO TAKE CARE OF SEEKS WHOSE INTERRUPTS
   371								; WERE LOST AS A RESULT OF STARTING CONTROL
   372
   373				;Perform latency calculation for disk page number specified in T1.
   374				; The latency is the time required for the disk to rotate until the requested
   375				; page is under the heads.  The number of microseconds is returned in T1.
   376
   377	000162'	717000	000007	APXLTM::RDA	T2		;Try to get a constant value
   378	000163'	717000	000010		RDA	T3		;Read disk address
   379	000164'	717000	000011		RDA	T4
   380	000165'	316340	000010		CAMN	T2,T3
   381	000166'	200440	000010		 MOVE	T4,T3
   382				IFE FTDPAG,<;T1 has block number to check for latency time
   383	000167'	242440	000002		LSH	T4,P2BLSH	;Convert RDA to block number
   384	000170'	231300	000500		IDIVI	T1,BPC		;BLOCK WITHIN CYLINDER
   385	000171'	231340	000040		IDIVI	T2,BPT		;BLOCK WITHIN TRACK.
   386	000172'	275411	000000		SUBI	T3,(T4)		;DELTA BLOCKS
   387	000173'	335000	000010		SKIPGE	T3
   388	000174'	271400	000040		 ADDI	T3,BPT		;HAVE TO GO AROUND AGAIN.
   389				>
   390				IFN FTDPAG,<;T1 has page number to check for latency time
   391					IDIVI	T1,PPC		;Page within cylinder
APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)	MACRO 12.5-46.0 14:59 13-JAN-88 PAGE 6-2
APXKON.MAC	17-SEP-87 16:39		INTERFACE TO FILIO AND FRIENDS.

   392					IDIVI	T2,PPT		;Page within track
   393					SUBI	T3,(T4)		;Delta pages
   394					SKIPGE	T3
   395					 ADD	T3,PPT		;Have to go around again
   396				>
   397	000175'	221400	041624		IMULI	T3,USPR		;Microseconds per revolution
   398	000176'	200300	000010		MOVE	T1,T3
   399	000177'	263040	000000		RET			;Return time in T1
   400
   401				;ENTER OFFSET MODE.  NOT YET IMPLEMENTED.
   402	000200'	400300	000000	APXOFS::SETZ T1,		;ALWAYS CLEAR OFFSET MODE FOR NOW.
   403	000201'	137300	000000*		DPB T1,UNYOS
   404	000202'	263040	000000		RET
   405
   406
APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)	MACRO 12.5-46.0 14:59 13-JAN-88 PAGE 7
APXKON.MAC	17-SEP-87 16:39		INTERFACE TO FILIO AND FRIENDS.

   407				;THE NEXT THREE ROUTINES FORM THE BODY OF THE TRANSFER CODE.
   408				;RED,WRT INITIALIZE; ADD ATTEMPTS TO CONSOLIDATE MULTIPLE
   409				; TRANSFERS IN THE SAME DIRECTION TO OR FROM THE DISK;
   410				; FIN COMPLETES THE WORK FOR THE GROUP OF TRANSFERS.
   411				;THE TRANSFER WILL NOT CROSS A CYLINDER BOUNDARY.
   412				;THE ACS P1-P4 ARE PRESERVED BY FILIO OVER THE PSEUDO CO-ROUTINE CALLS,
   413				; AND ARE USED AS FOLLOWS:
   414				;   P1/ NUMBER OF PAGES TO END OF CYLINDER
   415				;   P2/ AOBJN POINTER TO MEMORY TABLE
   416
   417				;APXRED/APXWRT. CALL WITH J/KDB, U/UDB, UNIBLK(U)/BLOCK NUMBER
   418
   419				EXTERNAL BLMSIZ,KONNLM,KONNCM,KONNLD,KONNL1,KONBLM,KONNRM
   420				EXTERNAL KONXFR,KONLRC,KONLRM,KONLRD
   421
   422	000203'	334300	000646'	APXWRT::SKIPA	T1,[WRITE]
   423	000204'	201300	000000	APXRED::MOVEI	T1,READ		;READ COMMAND
   424	000205'	202302	000000*		MOVEM	T1,KONNCM(J)	;SETUP NEXT COMMAND TO DO.
   425	000206'	400300	000000		SETZ	T1,		;GET READY TO CLEAR AND TEST KONCUA
   426	000207'	250302	000145*		EXCH	T1,KONCUA(J)	;MAKE SURE TRANSFER NOT ALREADY GOING
   427	000210'	332000	000006		SKIPE	T1		;IF WAS ALREADY SET,
   428	000211'	350000	000537'		 AOS	DBLXFR		;INCREMENT COUNT - SOMETIMES THIS IS OK
   429								; (WHEN WE TRY TO RESTART AN XFER) BUT
   430								; WANT TO KNOW FOR DEBUGGING TOO.
   431
   432	000212'	200300	000647'		MOVE	T1,[DCONSO DIDLE] ;INSTRUCTION TO PUT INTO APXINT FOR XFERS
   433	000213'	202300	000330'		MOVEM	T1,APXINT	;FOR SPEED.
   434	000214'	201642	000000*		MOVEI	P2,KONBLM(J)	;GET ADDRESS
   435	000215'	505640	000000*		HRLI	P2,-BLMSIZ	;MAKE AOBJN POINTER
   436	000216'	552642	000000*		HRRZM	P2,KONNLM(J)	;INIT THE POINTER TO LMA TABLE.
   437				IFE FTDPAG,<;SETNLD uses block #
   438	000217'	200305	000000*		MOVE	T1,UNIBLK(U)	;DISK ADR OF TRANSFER START.
   439				>
   440				IFN FTDPAG,<;SETNLD uses page #
   441					MOVE	T1,UNIPAG(U)	;Page number on disk where transfer starts
   442				>
   443	000220'	260040	000530'		PUSHJ	P,SETNLD	;SET KONNLD, KONNL1, RETURN CYL IN T1
   444	000221'	202305	000000*		MOVEM	T1,UNICYL(U)	;REMEMBER CYLINDER WE ARE WORKING ON. DON'T
   445								; LEAVE IT.
   446	000222'	350600	000006		AOS	P1,T1		;GET NEXT CYLINDER NUMBER
   447				IFE FTDPAG,<;FILIO gave us a block #
   448	000223'	221600	000500		IMULI	P1,BPC		;P1/BLOCK NUMBER OF FIRST BLOCK ON NEXT CYL
   449	000224'	274605	000217*		SUB	P1,UNIBLK(U)	;GET MAX NUMBER OF BLOCKS WE CAN DO
   450	000225'	242600	777776		LSH	P1,B2PLSH	;GET MAX NUMBER OF PAGES WE ARE ALLOWED
   451				>
   452				IFN FTDPAG,<;FILIO gave us a page #
   453					IMULI	P1,PPC		;P1/Page number of first page on next cyl
   454					SUB	P1,UNIPAG(U)	;Get max number of pages we can do
   455				>				;(NOT SUPPOSED TO GO PAST END OF CYLINDER)
   456	000226'	260040	000047'		PUSHJ	P,CLRKON	;MAKE SURE CONTROLLER IS RESET.
   457	000227'	255000	000000		  JFCL			;IGNORE
   458	000230'	263040	000000		RET			;P1/Pages to EOC, P2/AOBJN pointer to table
   459
APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)	MACRO 12.5-46.0 14:59 13-JAN-88 PAGE 7-2
APXKON.MAC	17-SEP-87 16:39		INTERFACE TO FILIO AND FRIENDS.

   460				;CALLER WANTS TO TRANSFER T1 WORDS TO ADDR IN T2.
   461				;CALLER MAY THINK HE'S DOING LESS, BUT APXKON WILL ALWAYS
   462				; XFER 1000 WORDS STARTING AT EVEN PAGE ADDRESS.
   463				;NON-SKIP RETURN IF CANNOT ADD ANY MORE TRANSFERS NOW BECAUSE OF EOC OR
   464				; OUT OF NLM TABLE. IF FIRST CALL TO APXADD NON-SKIPS, GUARANTEED TO
   465				; HAVE STARTED AT LEAST ONE PAGE TRANSFER.
   466
   467				;J points to Kontroller's KDB, U points to unit's UDB
   468
   469				IFE FTDPAG,<;T1 has block number, T2 has word address
   470	000231'	271300	000777	APXADD::ADDI	T1,777		;ROUND UP TO NEAREST PAGE, ALL XFERS = 1000 WORDS
   471	000232'	200740	000006		MOVE	P4,T1		;GET COUNT IN WORDS IN P4
   472	000233'	242740	777767		LSH	P4,W2PLSH	;CONVERT TO PAGES
   473				>
   474				IFN FTDPAG,<;T1 has # of pages to transfer, T2 has memory page # (P034/P05)
   475				APXADD::MOVE	P4,T1		;Pages to transfer
   476					LSH	T2,P2WLSH	;Word address where transfer starts
   477				>
   478	000234'	620340	000777	APXAD0:	TRZ	T2,777		;MAKE SURE ALWAYS START ON A PAGE BOUNARY
   479	000235'	202355	000000		MOVEM	T2,(P2)		;SET MEMORY ADDRESS FOR TRANSFER.
   480	000236'	332002	000207*		SKIPE	KONCUA(J)	;HAVE WE STARTED XFER YET?
   481	000237'	254000	000261'		 JRST	APXAD1		;YES.
   482	000240'	722020	000000*		NXTXFR	
   483	000241'	723000	000000*
   484	000242'	723000	000000*
   485	000243'	724000	000641'
   486	000244'	721000	000000*
   487	000245'	724000	000643'
   488	000246'	740000	000000*
   489						;START TRANSFER OF THE FIRST PAGE.
   490								; DSK PI OFF SO DON'T WORRY ABOUT IRPS
   491	000247'	402002	000146*		SETZM	KONXFR(J)	;INDICATE NO OTHER XFER TO START
   492	000250'	200322	000216*		MOVE	T1,@KONNLM(J)	;GET MEM ADDR AGAIN
   493	000251'	270300	000650'		ADD	T1,[777774,,1000] ;GET WHAT RMA SHOULD RETURN NEXT TIME
   494	000252'	202302	000000*		MOVEM	T1,KONNRM(J)	;NEXT RMA VALUE.
   495	000253'	350002	000250*		AOS	KONNLM(J)	;MUST POINT TO NEXT LMA TO DO AT INTERRUPT LEVEL.
   496
   497	000254'	552242	000236*		HRRZM	U,KONCUA(J)	;INDICATE XFER IS GOING NOW.
   498				IFE FTDPAG,<;SETNLD uses block #
   499	000255'	200305	000224*		MOVE	T1,UNIBLK(U)	;GET CURRENT BLOCK NUMBER
   500	000256'	271300	000004		ADDI	T1,4		;COMPUTE LDA FOR NEXT PAGE
   501				>
   502				IFN FTDPAG,<;SETNLD uses page #
   503					MOVE	T1,UNIPAG(U)	;Get current page number
   504					ADDI	T1,1		;Compute LDA for next page
   505				>
   506	000257'	260040	000530'		PUSHJ	P,SETNLD	;SET KONNLD, KONNL1
   507	000260'	254000	000262'		JRST	APXAD2
   508
   509
   510	000261'	476002	000247*	APXAD1:	SETOM	KONXFR(J)	;INDICATE MUST START ANOTHER XFER AFTER CURRENT
   511	000262'	252640	000140'	APXAD2:	AOBJP	P2,CPOPJ	;JUMP IF OUT OF NLM TABLE.
   512								; DO THIS FIRST SO ON NON-SKIP P2 ALWAYS
APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)	MACRO 12.5-46.0 14:59 13-JAN-88 PAGE 7-3
APXKON.MAC	17-SEP-87 16:39		INTERFACE TO FILIO AND FRIENDS.

   513								; POINTS TO LOCATION OF A ZERO WORD.
   514	000263'	363600	000140'		SOJLE	P1,CPOPJ	;IF PAST EOC, GIVE NON-SKIP RETURN.
   515	000264'	363740	000137'		SOJLE	P4,CPOPJ1	;JUMP IF DONE WITH COUNT THIS CALL
   516	000265'	201340	001000		MOVEI	T2,1000		;1000 + LAST MEM ADDRES IS
   517	000266'	270355	777777		ADD	T2,-1(P2)		;GET ADDRESS IN T2
   518	000267'	254000	000234'		JRST	APXAD0
   519	
   520
   521
   522
   523				;HERE TO FINISH UP TRANSFER STUFF. P2 POINTS TO NEXT FREE LMA TABLE ENTRY,
   524				; POSSIBLY THE EXTRA ONE THAT IS RESERVED TO BE ZERO IF REST OF LIST
   525				; IS FULL.
   526	000270'	402015	000000	APXFIN::SETZM	(P2)
   527	000271'	263040	000000		POPJ	P,		;XFER ALREADY STARTED.
   528
   529				;HERE TO START A POSITION. CALLED EITHER AT DISK INTERRUPT LEVEL
   530				; OR WITH DISK PI OFF.
   531	000272'	332002	000254*	APXPOS::SKIPE	KONCUA(J)	;MAKE SURE CONTROL IS IDLE
   532	000273'	256000	000000'		STOPCD			;BUT SOMEWHERE
   533	000274'	200300	000651'		MOVE	T1,[JRST APSINT] ;PLACE TO GO FOR SEEKS
   534	000275'	202300	000330'		MOVEM	T1,APXINT	;OVERWRITE PREVIOUS INSTRUCTION
   535	000276'	135400	000156*		LDB	T3,UNYPUN	;GET UNIT NUMBER
   536	000277'	200410	000157*		MOVE	T3,BITTBL(T3)	;GET BIT
   537	000300'	436400	000536'		IORM	T3,SEKWRD	;TURN ON FLAG SAYING SEEK IN PROGRESS.
   538								; (DISK PI OFF OR AT PI LEVEL SO NO
   539								; ONE CAN SNEAK IN AND FINISH.)
   540				IFE FTDPAG,<;SETNLD uses block #
   541	000301'	200305	000255*		MOVE	T1,UNIBLK(U)	;COMPUTE LDA
   542				>
   543				IFN FTDPAG,<;SETNLD uses page #
   544					MOVE	T1,UNIPAG(U)	;COMPUTE LDA
   545				>
   546	000302'	260040	000530'		PUSHJ	P,SETNLD	;AND SETUP KONNLD, KONNL1
   547	000303'	202305	000221*		MOVEM	T1,UNICYL(U)	;SET CYLINDER ALSO
   548	000304'	723002	000000*		LDA	KONNLD(J)
   549	000305'	723002	000000*		LDA	KONNL1(J)	;SELECT UNIT AND SET DISK ADDRESS.
   550	000306'	260040	000047'		PUSHJ	P,CLRKON	;CLEAR CONTROLLER
   551	000307'	255000	000000		  JFCL
   552	000310'	700600	000400		WRPI	LI.PIF		;TURN OFF PI SYSTEM
   553	000311'	724000	000641'		KONSTR	(<[READ]>)
   554	000312'	721000	000652'
   555	000313'	724000	000643'
   556					;START A READ
   557	000314'	201300	000074		MOVEI	T1,^D15*4	;WAIT AT LEAST 15 USECS
   558	000315'	367300	000315'		SOJG	T1,.
   559	000316'	724000	000641'		LECC	[IC]		;BLAST CONTROL, IT STOPS THE XFER
   560								;BIT LEAVES A SEEK GOING
   561	000317'	700600	000200		WRPI	LI.PIN
   562	000320'	200640	000536'	SEKXIT:	MOVE	P2,SEKWRD	;GET SEEK BIT TABLE
   563	000321'	260040	000462'		PUSHJ	P,SEKINT	;PROCESS ANY SEEKS WHICH HAVE COMPLETED,
   564								; SINCE BLASTING CONTROL WILL CAUSE US
   565								; TO LOSE ATTENTION INTERRUPT.
APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)	MACRO 12.5-46.0 14:59 13-JAN-88 PAGE 7-4
APXKON.MAC	17-SEP-87 16:39		INTERFACE TO FILIO AND FRIENDS.

   566	000322'	326300	000325'		JUMPN	T1,SEKXT1	;IF SEEKS HAVE COMPLETED, CAUSE INTERRUPT
   567	000323'	740000	000020*		DCONO	ATNENB+DSKCHN	;NONE COMPLETE, ENABLE FOR THE ONE WE STARTED
   568	000324'	263040	000000		POPJ	P,		;AND RETURN
   569	000325'	436300	000536'	SEKXT1:	IORM	T1,SEKWRD	;SEKINT TURNED THEM OFF, TURN BACK ON FOR INTERRUPT
   570								; LEVEL
   571	000326'	740000	000246*		DCONO	DSKCHN		;THIS SHOULD CAUSE INTERRUPT FROM STARTING
   572								; AND ABORTING THE  XFER (I HOPE)
   573	000327'	263040	000000		POPJ	P,		;AND RETURN. USED TO CALL FILINT, BUT
   574								;OVERFLOWED STACK BECAUSE FILINT CALLED US
   575								;BACK.
   576								;WILL PROCESS FINISHED SEEKS AT INTERRUPT LEVEL.
APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)	MACRO 12.5-46.0 14:59 13-JAN-88 PAGE 8
APXKON.MAC	17-SEP-87 16:39		INTERFACE TO FILIO AND FRIENDS.

   577				;INTERRUPT HANDLER.
   578				;ONLY HAVE 60US TO START UP NEXT TRANSFER - ONLY 60US OF TIME
   579				; BETWEEN LAST PAGE TRANSFERRED AND NEXT ONE COMING UP UNDER THE HEADS
   580				; SO START NEXT TRANSFER UP IN KONNLM LIST IMMEDIATELY - NEXT LDA DATA
   581				; COMPUTED BEFOREHAND.
   582				;IF UNIT WAS TRANSFERRING, IT IS SELECTED SO THAT RCMD WILL GET ITS STATUS.
   583
   584	000330'			AP0INT::
   585	000330'	254000	000000	APXINT::JRST	.-.		;FILLED IN WITH DCONSO OR JRST APSINT
   586	000331'	254000	000331'		JRST	.		;FOR LINKING INTERRUPTS IN
   587								;DON'T BOTHER WITH DCONO 0 YET, MIGHT START AN XFER.
   588
   589	000332'	715000	000000*		RCMD	KONLRC+APACB	;SAVE LAST RCMD
   590	000333'	716000	000000*		RMA	KONLRM+APACB	;AND RMA IN CASE SOMETHING WENT WRONG.
   591	000334'	717000	000000*		RDA	KONLRD+APACB	;IN CASE WE GET ERROR
   592	000335'	336000	000000*		SKIPN	KONXFR+APACB	;IF NON ZERO, MUST START ANOTHER XFER.
   593	000336'	254000	000346'		JRST	APXXFL		;THIS WAS THE LAST ONE.
   594	000337'	722020	000000*		NXTXFR	
   595	000340'	723000	000000*
   596	000341'	723000	000000*
   597	000342'	724000	000641'
   598	000343'	721000	000000*
   599	000344'	724000	000643'
   600	000345'	740000	000326*
   601						;MACRO CALL TO START NEXT TRANSFER.
   602
   603
   604				;HERE IF NO NEXT TRANSFER TO START.
   605
   606	000346'	264000	000000*	APXXFL:	JSR	APXSAV##	;SAVE ALL ACS NOW
   607	000347'	201100	000000*		MOVEI	J,APACB
   608	000350'	336242	000272*		SKIPN	U,KONCUA(J)	;BETTER BE SETUP
   609	000351'	256000	000000'		 STOPCD			;NOT
   610	000352'	200302	000000*		MOVE	T1,KONLRC(J)	;GET LAST RCMD VALUE
   611	000353'	606300	000020		TRNN	T1,NA		;WAS UNIT FINISHED?
   612	000354'	254000	000403'		 JRST	APXINE		;NO, SPURIOUS INTERRUPT. SINCE WE MAY HAVE
   613								;STARTED NEXT, BLAST KONTROL AND CALL IT AN ERROR.
   614	000355'	607300	040000		TLNN	T1,(SUOC)	;MAKE SURE ITS ON CYLINDER, IF NOT ERROR.
   615	000356'	254000	000403'		 JRST	APXINE		;GO BLAST POSSIBLE CURRENT XFER.
   616	000357'	606300	000200		TRNN	T1,AE		;IF ANY ERROR OR
   617	000360'	603300	000010		TLNE	T1,(IPE)	;IPE (ONLY VALID IF AE OFF)
   618	000361'	254000	000403'		 JRST	APXINE		;GO SHUT DOWN TRANSFERS.
   619	000362'	200302	000000*		MOVE	T1,KONLRM(J)	;GET RMA VALUE FOR LAST XFER
   620	000363'	312302	000252*		CAME	T1,KONNRM(J)	;IS IT WHAT IS SUPPOSED TO BE?
   621	000364'	254000	000403'		 JRST	APXINE		;NO, GO DO ERROR.
   622
   623
   624	000365'	336002	000261*		SKIPN	KONXFR(J)	;THIS THE LAST TRANSFER?
   625	000366'	254000	000405'		 JRST	APXIN0		;YES, GO PROCESS END OF XFER CHAIN.
   626	000367'	350302	000253*		AOS	T1,KONNLM(J)	;STEP TO NEXT THING TO DO IN LIST
   627	000370'	200346	777777		MOVE	T2,-1(T1)	;GET LMA DATA OF THE CURRENT XFER JUST STARTED
   628	000371'	270340	000650'		ADD	T2,[777774,,1000] ;WHAT NEXT RMA HAD BETTER LOOK LIKE
   629	000372'	202342	000363*		MOVEM	T2,KONNRM(J)	;SAVE FOR NEXT INTERRUPT
APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)	MACRO 12.5-46.0 14:59 13-JAN-88 PAGE 8-2
APXKON.MAC	17-SEP-87 16:39		INTERFACE TO FILIO AND FRIENDS.

   630	000373'	336006	000000		SKIPN	(T1)		;ANOTHER XFER AFTER THIS ONE?
   631	000374'	254000	000401'		 JRST	APXECN		;NO, END OF CHAIN, SWITCH INTERRUPT INSTRUCTION.
   632	000375'	275302	000214*		SUBI	T1,KONBLM(J)	;GET NUMBER OF PAGES PAST FIRST WE ARE
   633				IFE FTDPAG,<;SETNLD uses block #
   634	000376'	242300	000002		LSH	T1,P2BLSH	;CONVERT TO BLOCKS
   635	000377'	270305	000301*		ADD	T1,UNIBLK(U)
   636				>
   637				IFN FTDPAG,<;SETNLD uses page #
   638					ADD	T1,UNIPAG(U)
   639				>
   640	000400'	254000	000530'		JRST	SETNLD		;GO SET KONNLD AND KONNL1 FROM BLOCK IN T1
   641
   642	000401'	402002	000365*	APXECN:	SETZM	KONXFR(J)	;INDICATE NO XFER TO START AFTER NEXT ONE.
   643	000402'	263040	000000		POPJ	P,		;RETURN FROM THIS INTERRUPT.
   644
   645	000403'	260040	000047'	APXINE:	PUSHJ	P,CLRKON	;BLAST THE NEXT XFER WE STARTED IF ANY
   646	000404'	402022	000367*		SETZM	@KONNLM(J)	;ERROR, MAKE SURE WE DON'T CONTINUE THE LIST
   647	000405'	200300	000651'	APXIN0:	MOVE	T1,[JRST APSINT]
   648	000406'	202300	000330'		MOVEM	T1,APXINT	;MAKE SURE SPURIOUS/UNEXPECTED INTERRUPTS GO
   649	000407'	740000	000000		DCONO	0		;TURN OFF IDLE FLAG SO WE DON'T CATCH INTERRUPTS
   650								; BELONGING TO OTHERS ON THE PI CHANNEL.
   651	000410'	254000	000416'		JRST	APXIN2		;WHERE THEY CAN DO NO HARM.
   652
   653				;HERE IF NO TRANSFER GOING - PROBABLY SEEK INTERRUPT.
   654	000411'	742000	000010	APSINT:	DCONSO	DIDLE		;INTERRUPTING?
   655	000412'	254000	000331'		 JRST	APXINT+1	;NO, ANOTHER DEVICE
   656	000413'	740000	000000		DCONO	0		;TURN OFF INTERRUPT.
   657	000414'	264000	000346*		JSR	APXSAV##	;SET EVERYTHING UP
   658	000415'	201100	000347*		MOVEI	J,APACB
   659	000416'	403300	000007	APXIN2:	SETZB	T1,T2		;T1 HAS FILIO COMM WORD, T2/CONI WORD
   660	000417'	332640	000536'		SKIPE	P2,SEKWRD	;IF OUTSTANDING SEEKS GOING,
   661	000420'	260040	000462'		 PUSHJ	P,SEKINT	;CHECK FOR COMPLETION.
   662	000421'	336242	000350*		SKIPN	U,KONCUA(J)
   663	000422'	254000	000453'		 JRST	INTDIS		;IGNORE IT
   664	000423'	260040	000511'		PUSHJ	P,SDA		;SELECT THE UNIT
   665	000424'	200442	000352*		MOVE	T4,KONLRC(J)	;GET RCMD DATA OF LAST XFER TO INTERRUPT
   666	000425'	606440	000020		TRNN	T4,NA		;TRANSFER COMPLETE IF NOT ACTIVE IS ON.
   667	000426'	254000	000453'		 JRST	INTDIS		;STILL GOING, CALL FILIO IF HAVE TO.
   668				;HERE TO ACCOUNT FOR TRANSFER
   669				;UNIT WHICH TRANSFERRED IS NOW SELECTED.
   670				;PRINTX MUST DO SOMETHING FOR MPE - POOLE SAYS ITS DISCONNECTED
   671	000427'	647440	040000		TLCN	T4,(SUOC)	;IF NOT ON CYLINDER, SOMETHING IS WRONG.
   672	000430'	660440	000200		 TRO	T4,AE		;COMPLEMENT SO CONERR WILL SEE ITS AN ERROR, SET AE
   673
   674	000431'	606440	000200		TRNN	T4,AE		;ANY ERROR?
   675	000432'	603440	000010		TLNE	T4,(IPE)	;INTERNAL PARITY ERROR? (DATA PATH PROBLEM)
   676	000433'	260040	000540'		 CALL	CONERR		;SET KCMERR IN T1
   677	000434'	200402	000000*		MOVE	T3,KONLRD(J)	;GET LAST RDA FOR XFER JUST INTERRUPTED.
   678
   679				;NOW COMPUTE HOW MANY PAGES WERE TRANSFERRED. NEVER TELL FILIO THAT
   680				; LESS THAN A COMPLETE PAGE WAS TRANSFERRED. ALWAYS SAY THAT ALL 4 BLOCKS
   681				; WERE DONE, AND FILIO WILL TRY TO RETRY THE LAST BLOCK, BUT WE
   682				; WILL IGNORE LOW ORDER 2 BITS AND RETRANSFER THE WHOLE PAGE.
APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)	MACRO 12.5-46.0 14:59 13-JAN-88 PAGE 8-3
APXKON.MAC	17-SEP-87 16:39		INTERFACE TO FILIO AND FRIENDS.

   683				; KONNLM WILL POINT TO NEXT TRANSFER WE WERE TO DO, SO NUMBER
   684				; OF PAGES TRANSFERRED WILL BE C(KONNLM)-KONBLM.
   685
   686	000435'	200542	000404*		MOVE	M,KONNLM(J)	;GET POINTER TO 1 PAST LAST MEM ADDR WE JUST DID
   687	000436'	275542	000375*		SUBI	M,KONBLM(J)	;GET NUMBER OF PAGES WE DID
   688	000437'	313540	000535'		CAMLE	M,XFRMAX	;COLLECT MAX NUMBER OF PAGES WE DID AT ONCE.
   689	000440'	202540	000535'		 MOVEM	M,XFRMAX	;TO SEE IF WE'RE EXCERCISING THIS CODE.
   690				IFE FTDPAG,<;Tell FILINT the number of blocks transfered
   691	000441'	242540	000002		LSH	M,P2BLSH	;CONVERT TO BLOCKS. ALWAYS SAY DID ALL 4 BLOCKS
   692				>
   693	000442'	540300	000013		HRR	T1,M		;PUT NUMBER OF BLOCKS WE DID IN RH(T1)
   694	000443'	200442	000362*		MOVE	T4,KONLRM(J)	;GET RMA OF LAST XFER TO INTERRUPT
   695	000444'	621440	777774		TLZ	T4,777774	;CLEAR UNUSED BITS (THEY WILL BE ONES)
   696	000445'	200502	000435*		MOVE	W,KONNLM(J)	;GET ADDRESS+1 OF MEM ADDRESS OF LAST XFER.
   697	000446'	274452	777777		SUB	T4,-1(W)	;SUBTRACT OFF BEGINNING ADDRESS.
   698	000447'	302440	001000		CAIE	T4,1000		;BETTER HAVE XFERRED ONE AND ONLY ONE PAGE
   699	000450'	260040	000613'		 PUSHJ	P,CNTERR	;HANDLE IT (SET RETRY PATTERN ERROR BIT IN T1)
   700	000451'	661300	000000*		TLO	T1,KCMDTA	;FLAG THIS AS A DATA TRANSFER
   701	000452'	402002	000421*		SETZM	KONCUA(J)	;REMEMBER CONTROLLER NO LONGER BUSY
   702	000453'	332000	000006	INTDIS:	SKIPE	T1		;IF ANYTHING IN COMM WORD
   703	000454'	260040	000136*		 PUSHJ	P,FILINT##	;CALL FILIO
   704	000455'	336002	000452*		SKIPN	KONCUA(J)	;IF NO CURRENT TRANSFER GOING AND
   705	000456'	336000	000536'		SKIPN	SEKWRD		;HAVE SEEKS GOING,
   706	000457'	263040	000000		 POPJ	P,		;XFER GOING OR NO SEEKS
   707	000460'	740000	000020*		DCONO	ATNENB+DSKCHN	;THEN ENABLE FOR ATTENTION BITS.
   708	000461'	263040	000000		POPJ	P,		;RETURN FROM INTERRUPT.
APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)	MACRO 12.5-46.0 14:59 13-JAN-88 PAGE 9
APXKON.MAC	17-SEP-87 16:39		INTERFACE TO FILIO AND FRIENDS.

   709				;HERE IF ANY OUTSTANDING SEEKS. SEE IF ANY ARE DONE, IF SO, CALL FILIO.
   710				; CALLER BEWARE THAT UNIT SELECTED IS CHANGED.
   711				; SEKPTR WORD IN P2.
   712
   713	000462'	400300	000000	SEKINT:	SETZ	T1,		;START OUT WITH ZERO
   714	000463'	243640	000465'	SEKIN1:	JFFO	P2,.+2
   715	000464'	263040	000000		 POPJ	P,		;NO MORE TO CHECK.
   716	000465'	307700	000003		CAIG	P3,3		;FORGET BAD UNIT NUMBERS
   717	000466'	336262	000000*		SKIPN	U,@KONPTR(J)	;OR UNITS NOT CONFIGURED FOR
   718	000467'	254000	000504'		 JRST	SEKNXT
   719	000470'	260040	000511'		PUSHJ	P,SDA		;SELECT THIS UNIT
   720	000471'	715000	000011		RCMD	T4		;GET STATUS
   721	000472'	607440	060000		TLNN	T4,(SUOC!SUSE)	;ON CYLINDER OR SEEK ERROR? (SUOC NOT ON THEN)
   722	000473'	254000	000504'		 JRST	SEKNXT		;NOT YET, FORGET IT FOR NOW.
   723
   724	000474'	607440	000200		TLNN	T4,AE
   725	000475'	603440	000010		TLNE	T4,(IPE)	;ANY ERRORS?
   726					 JRST	SEKBAD		;YES, TURN OFF BIT IN SEKWRD BUT DON'T TELL FILIO, LET IT TIME 
   727	000476'	254000	000507'	OUT.
   728	000477'	200416	000277*	SEKDON:	MOVE	T3,BITTBL(P3)	;GET THE BIT REPRESENTING THE UNIT
   729	000500'	670300	000010		TDO	T1,T3		;TURN IT ON IN FILIO COMMUNICATION WORD
   730	000501'	412400	000536'	SEKDN1:	ANDCAM	T3,SEKWRD	;TURN IT OFF IN SEKWRD
   731	000502'	412400	000015		ANDCAM	T3,P2		;ALSO TURN OFF IN BITS TO CHECK
   732	000503'	254000	000463'		JRST	SEKIN1		;AND CONTINUE
   733
   734	000504'	200416	000477*	SEKNXT:	MOVE	T3,BITTBL(P3)
   735	000505'	412400	000015		ANDCAM	T3,P2		;JUST TURN OFF IN P2
   736	000506'	254000	000463'		JRST	SEKIN1		;AND CONTINUE.
   737
   738	000507'	200416	000504*	SEKBAD:	MOVE	T3,BITTBL(P3)
   739	000510'	254000	000501'		JRST	SEKDN1
   740
   741				;ROUTINE TO SELECT A DISK UNIT. SMASHES T3.
   742				; UDB IN U.
   743
   744	000511'	135400	000276*	SDA:	LDB	T3,UNYPUN
   745	000512'	241400	777771		ROT	T3,ROTUNI
   746	000513'	723000	000010		LDA	T3
   747	000514'	661400	002000		TLO	T3,(<SU>)
   748	000515'	723000	000010		LDA	T3
   749	000516'	263040	000000		POPJ	P,		;RETURN.
   750
   751				;ROUTINE TO COMPUTE LDA DATA FOR PAGE NUMBER IN T1.
   752				;USES T1-T4. EXPECTS UDB IN U, PAGE NUMBER IN T1.
   753				;RETURNS CYLINDER NUMBER IN T1. LDA DATA IN T3.
   754
   755	000517'			GETLDA:
   756				IFE FTDPAG,<;T1 has block number
   757	000517'	242300	777776		LSH	T1,B2PLSH	;CHANGE TO PAGE NUMBER
   758				>
   759	000520'	231300	000120		IDIVI	T1,PPC		;T1: CYL
   760	000521'	231340	000010		IDIVI	T2,PPT		;T2: TRACK, T3: PAGE
   761	000522'	137340	000653'		DPB	T2,[POINT AMSTRK,T3,AMPTRK]
APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)	MACRO 12.5-46.0 14:59 13-JAN-88 PAGE 9-2
APXKON.MAC	17-SEP-87 16:39		INTERFACE TO FILIO AND FRIENDS.

   762	000523'	137300	000654'		DPB	T1,[POINT AMSCYL,T3,AMPCYL]
   763	000524'	135440	000511*		LDB	T4,UNYPUN	;SELECT UNIT FOR TRANSFER.
   764	000525'	241440	777771		ROT	T4,ROTUNI
   765	000526'	670400	000011		TDO	T3,T4		;PUT EVERYTHING IN T3
   766	000527'	263040	000000		POPJ	P,		;AND RETURN.
   767
   768				;ROUTINE TO SET KONNLD AND KONNL1 FROM UNIPAG
   769				; CALL WITH U/UDB, J/KDB, T1/DISK ADDRESS
   770				;SETS KONNLD,KONNL1,UNICYL. RETURNS LDA DATA IN T3 IN CASE ANYONE IS INTERESTED.
   771				;RETURNS CYLINDER NUMBER IN T1
   772
   773	000530'	260040	000517'	SETNLD:	PUSHJ	P,GETLDA	;GET CYLINDER # IN T1, DATA IN T3
   774	000531'	202402	000304*		MOVEM	T3,KONNLD(J)	;SET KONNLD
   775	000532'	661400	002000		TLO	T3,(<SU>)	;COPY WITH SU SET TO MAKE NXTXFR FAST
   776	000533'	202402	000305*		MOVEM	T3,KONNL1(J)
   777	000534'	263040	000000		POPJ	P,		;AND RETURN.
   778
   779	000535'	000000	000000	XFRMAX:	0			;MAX NUMBER OF PAGES WE DID IN ONE CALL TO FILINT
   780	000536'	000000	000000	SEKWRD:	0			;BIT TABLE FOR UNITS THAT HAVE SEEKS IN PROGRESS.
   781	000537'	000000	000000	DBLXFR:	0			;NUMBER OF TIMES APXRED/WRT WAS CALLED WHEN
   782								; THERE WAS AN XFER IN PROGRESS.
APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)	MACRO 12.5-46.0 14:59 13-JAN-88 PAGE 10
APXKON.MAC	17-SEP-87 16:39		INTERFACE TO FILIO AND FRIENDS.

   783				;MACRO TO SET DEVICE INDEPENDENT ERROR BITS (FAKE CONI),
   784				; RETRY PATTERNS BASED ON ERROR BITS
   785				;ARGUMENTS TO X MACRO ARE RCMD BIT, FAKE CONI BIT, DEVICE ERROR,
   786				; RETRIES BEFORE RECAL, RECALS, RETRIES AFTER RECAL
   787				; ENTRIES LATER IN ERRGEN LIST TAKE PRECEDENCE FOR RETRY PATTERNS
   788				; AFTER ENTRIES EARLIER IN THE LIST.
   789
   790
   791
   792				DEFINE ERRGEN <
   793				X (SECC,ERRDTA,0,100,1,100)		;SOFT ECC ERROR, TREAT SAME AS HARD FOR NOW
   794				X (IPE,<ERRBIP!ERRBOP>,1,100,0,0)	;INTERNAL PARITY ERROR. ONLY LOOKED AT IF ALL OTHER BIT
   795				S ARE OFF.
   796				X (SOE,ERROVR,1,100,0,0)	;SECTOR OVERRUN
   797				X (WOE,ERROVR,1,100,0,0)	;WRITE OVERRUN
   798				X (ROE,ERROVR,1,100,0,0)	;READ OVERRUN
   799				X (HECC,ERRDTA,0,100,1,100)	;HARD ECC ERROR.
   800				X (HDECC,ERRINV,0,100,1,100)	;HEADER ECC ERROR, RETRY 100 TIMES, RECAL, RETRY ANOTHER 100
   801				
   802				X (SUOC,ERREQC,1,0,10,10)	;IF SUOC WASN'T ON, TREAT AS SEEK ERROR
   803				X (SUSE,ERREQC,1,0,10,10)	;SEEK ERROR, RECAL UP TO 8 TIMES, THEN RETRY 8 TIMES.
   804				X (SUNR,ERREQC,1,10,0,0)	;NOT READY, RETRY 8 TIMES
   805				X (SUNT,ERRSEL,1,0,0,0)		;NOT THERE.
   806				>;END ERRGEN MACRO DEFINITION
   807
   808				DEFINE ERRPAT(DEV,RTY,RCL,RRT)
   809				<XWD RRT+200000+UNPDEV*DEV,RCL_9+RTY>
   810
   811				DEFINE X(DEVB,CONIB,DEV,RTY,RCL,RRT) <
   812					TLNE	T4,('DEVB)
   813					 JRST	[TXO T2,'CONIB
   814						 MOVE T3,[ERRPAT(DEV,RTY,RCL,RRT)]
   815						 SKIPN UNIRCT(U)
   816						  MOVEM T3,UNIRCT(U)
   817						 JRST .+1]
   818				>;END X MACRO DEFINITION
   819
   820				DEFINE TXO(A,B)<
   821				IFE 'B&777777000000,<TRO A,'B>
   822				IFE 'B&777777,<TLO A,('B)>
   823				IFN 'B&777777000000,<IFN 'B&777777,<TDO A,['B]>>
   824				>;END TXO DEFINITION
   825
   826				;ERROR DURING TRANSFER.
   827	000540'	400340	000000	CONERR:	SETZ	T2,		;CLEAR OUT CONI WORD
   828	000541'	602440	000200		TRNE	T4,AE		;IF AE IS ON, IGNORE
   829	000542'	621440	000010		 TLZ	T4,(IPE)	;IPE, IT CAN BE ON AND DOESN'T MEAN ANYTHING.
   830	000543'	607440	500010		TLNN	T4,(IPE+SUNT+SUNR)	;BAD BITS ON?
   831	000544'	254000	000555'		 JRST	CONER0
   832	000545'	607440	000010		TLNN	T4,(IPE)	;THIS?
   833	000546'	254000	000552'		 JRST	CONOFL		;NO, JUST MARK OFFLINE
   834	000547'	661300	000000*		TLO	T1,KCMFUS	;YES, THIS IS SERIOUS - SAY FILE UNSAFE
   835	000550'	205400	000000*		MOVSI	T3,UNPFUS	;SET IN UDB
APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)	MACRO 12.5-46.0 14:59 13-JAN-88 PAGE 10-2
APXKON.MAC	17-SEP-87 16:39		INTERFACE TO FILIO AND FRIENDS.

   836	000551'	436405	000000*		IORM	T3,UNIDES(U)
   837	000552'	661300	000135*	CONOFL:	TLO	T1,KCMOFL	;SAY IT WENT OFF LINE
   838	000553'	205400	000000*		MOVSI	T3,UNPOFL
   839	000554'	436405	000551*		IORM	T3,UNIDES(U)	;MARK UDB SAYING ITS OFFLINE
   840
   841	000555'	603440	000400	CONER0:	ERRGEN
   842	000556'	254000	000656'
   843	000557'	603440	000010
   844	000560'	254000	000664'
   845	000561'	603440	000020
   846	000562'	254000	000672'
   847	000563'	603440	000040
   848	000564'	254000	000700'
   849	000565'	603440	000100
   850	000566'	254000	000706'
   851	000567'	603440	000200
   852	000570'	254000	000714'
   853	000571'	603440	002000
   854	000572'	254000	000722'
   855	000573'	603440	040000
   856	000574'	254000	000730'
   857	000575'	603440	020000
   858	000576'	254000	000736'
   859	000577'	603440	100000
   860	000600'	254000	000744'
   861	000601'	603440	400000
   862	000602'	254000	000752'
   863	000603'	260040	000622'		PUSHJ	P,SAVSTS	;SAVE RCMD,RMA,RDA OF LAST XFER IN UDB
   864	000604'	261040	000006		PUSH	P,T1		;SAVE T1
   865	000605'	724000	000641'		KONSTR	(<[CF+FC]>)
   866	000606'	721000	000642'
   867	000607'	724000	000643'
   868					;CLEAR FAULTS
   869	000610'	262040	000006		POP	P,T1
   870	000611'	661300	000000*		TLO	T1,KCMERR	;SAY THERE WAS A TRANSFER ERROR
   871	000612'	263040	000000		RET
   872
   873				;HERE IF THERE IS A COUNT ERROR.
   874
   875	000613'	200400	000757'	CNTERR:	MOVE	T3,[ERRPAT(1,100,0,0)]
   876	000614'	336005	000000*		SKIPN	UNIRCT(U)
   877	000615'	202405	000614*		 MOVEM	T3,UNIRCT(U)	;SET RETRY PATTERN IF NECESSARY
   878	000616'	660340	400000		TRO	T2,ERRCNT
   879	000617'	661300	000611*		TLO	T1,KCMERR
   880	000620'	717000	000010		RDA	T3		;GET DATAI IN T3 (WHERE IT HAPPENED)
   881	000621'	263040	000000		POPJ	P,		;AND RETURN.
   882
   883				;READ ALL REGISTERS INTO UDB.
   884
   885	000622'	200402	000424*	SAVSTS:	MOVE	T3,KONLRC(J)	;GET LAST RCMD
   886	000623'	202405	000000*		MOVEM	T3,UNISB(U)	;SAVE
   887	000624'	200402	000443*		MOVE	T3,KONLRM(J)	;LAST RMA
   888	000625'	202405	000001*		MOVEM	T3,UNISB+1(U)
APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)	MACRO 12.5-46.0 14:59 13-JAN-88 PAGE 10-3
APXKON.MAC	17-SEP-87 16:39		INTERFACE TO FILIO AND FRIENDS.

   889	000626'	200402	000434*		MOVE	T3,KONLRD(J)	;LAST RDA
   890	000627'	202405	000002*		MOVEM	T3,UNISB+2(U)	;STORE
   891	000630'	263040	000000		POPJ	P,		;SAVE. (NO LONGER SAVE ECC REG.)
   892
   893				;HERE FROM FILIO TO COPY REGISTERS INTO PERMANENT PLACE FOR HARD ERRORS
   894
   895	000631'	505305	000623*	APXHRD::HRLI	T1,UNISB(U)	;GET SOURCE ADDRESS
   896	000632'	541305	000000*		HRRI	T1,UNISBH(U)	;GET WHERE THE REG DATA GOES
   897	000633'	251305	000000*		BLT	T1,UNISBH+SBSIZ-1(U) ;XFER THE DATA.
   898	000634'	263040	000000		POPJ	P,		;DONE.
   899
   900				;HERE TO COPY REGISTERS TO UNISBS FOR SOFT DATA, CALL FROM FILIO
   901	000635'	205345	000631*	APXSFT::MOVSI	T2,UNISB(U)	;SOURCE
   902	000636'	541345	000000*		HRRI	T2,UNISBS(U)	;DEST
   903	000637'	251345	000000*		BLT	T2,UNISBS+SBSIZ-1(U) ;BLT THERE
   904	000640'	263040	000000		POPJ	P,		;AND RETURN.
   905
   906	000641'	000000	000002		$END	(APX)

   907	000642'	000000	404000

   908	000643'	000000	000001

   909	000644'	000001	404000

   910	000645'	000000	000000*

   911	000646'	000000	011000

   912	000647'	742000	000010

   913	000650'	777774	001000

   914	000651'	254000	000411'

   915	000652'	000000	000000

   916	000653'	101000	000010

   917	000654'	201400	000010

   918	000655'	000000*	001100

   919	000656'	660340	200000

   920	000657'	200400	000655'

   921	000660'	336005	000615*

   922	000661'	202405	000660*

   923	000662'	254000	000557'

APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)	MACRO 12.5-46.0 14:59 13-JAN-88 PAGE 10-4
APXKON.MAC	17-SEP-87 16:39		INTERFACE TO FILIO AND FRIENDS.

   924	000663'	000000*	000100

   925	000664'	660340	000300

   926	000665'	200400	000663'

   927	000666'	336005	000661*

   928	000667'	202405	000666*

   929	000670'	254000	000561'

   930	000671'	000000*	000100

   931	000672'	660340	002000

   932	000673'	200400	000671'

   933	000674'	336005	000667*

   934	000675'	202405	000674*

   935	000676'	254000	000563'

   936	000677'	000000*	000100

   937	000700'	660340	002000

   938	000701'	200400	000677'

   939	000702'	336005	000675*

   940	000703'	202405	000702*

   941	000704'	254000	000565'

   942	000705'	000000*	000100

   943	000706'	660340	002000

   944	000707'	200400	000705'

   945	000710'	336005	000703*

   946	000711'	202405	000710*

   947	000712'	254000	000567'

   948	000713'	000000*	001100

   949	000714'	660340	200000

   950	000715'	200400	000713'
APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)	MACRO 12.5-46.0 14:59 13-JAN-88 PAGE 10-5
APXKON.MAC	17-SEP-87 16:39		INTERFACE TO FILIO AND FRIENDS.


   951	000716'	336005	000711*

   952	000717'	202405	000716*

   953	000720'	254000	000571'

   954	000721'	000000*	001100

   955	000722'	660340	040000

   956	000723'	200400	000721'

   957	000724'	336005	000717*

   958	000725'	202405	000724*

   959	000726'	254000	000573'

   960	000727'	000000*	010000

   961	000730'	661340	000020

   962	000731'	200400	000727'

   963	000732'	336005	000725*

   964	000733'	202405	000732*

   965	000734'	254000	000575'

   966	000735'	000000*	010000

   967	000736'	661340	000020

   968	000737'	200400	000735'

   969	000740'	336005	000733*

   970	000741'	202405	000740*

   971	000742'	254000	000577'

   972	000743'	000000*	000010

   973	000744'	661340	000020

   974	000745'	200400	000743'

   975	000746'	336005	000741*

   976	000747'	202405	000746*

APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)	MACRO 12.5-46.0 14:59 13-JAN-88 PAGE 10-6
APXKON.MAC	17-SEP-87 16:39		INTERFACE TO FILIO AND FRIENDS.

   977	000750'	254000	000601'

   978	000751'	000000*	000000

   979	000752'	661340	000200

   980	000753'	200400	000751'

   981	000754'	336005	000747*

   982	000755'	202405	000754*

   983	000756'	254000	000603'

   984	000757'	000000*	000100

   985						;End of APXKON (APXLIT: APXEND:)
   986
NO ERRORS DETECTED
PROGRAM BREAK IS 000762
7K CORE USED
APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)	MACRO 12.5-46.0 14:59 13-JAN-88 PAGE 11
APXKON.MAC	17-SEP-87 16:39		SYMBOL TABLE

AA		000100	SPD	CI	001000	000000	SPD	J		000002	INT	S$NAME		000000'	SPD
AAIE		000040	SPD	CLRKON		000047'		KCMDTA		000451'	EXT	S$NONA		000000	SIN
AE		000200	SPD	CMD0		004000	SPD	KCMERR		000617'	EXT	S$TEMP		000000	SPD
AMPCYL		000023	SPD	CMD1		002000	SPD	KCMFUS		000547'	EXT	S$XCT	777777	777776	SIN
AMPEX		000000	SPD	CMD2		001000	SPD	KCMOFL		000552'	EXT	SAVSTS		000622'	
AMPSEC		000043	SPD	CMD32		000400	SPD	KCMPOS		000000	EXT	SBSIZ		000000	EXT
AMPTRK		000033	SPD	CNTERR		000613'		KCMRER		000000	EXT	SC		000001	SPD
AMPUNI		000006	SPD	CONER0		000555'		KONBLM		000436'	EXT	SDA		000511'	
AMSCYL		000014	SPD	CONERR		000540'		KONCUA		000455'	EXT	SECC	000400	000000	SPD
AMSSEC		000010	SPD	CONOFL		000552'		KONLRC		000622'	EXT	SEKBAD		000507'	
AMSTRK		000010	SPD	CPOPJ		000140'		KONLRD		000626'	EXT	SEKDN1		000501'	
AMSUNI		000003	SPD	CPOPJ1		000137'		KONLRM		000624'	EXT	SEKDON		000477'	
AP0INT		000330'	INT	CPU		001455	SPD	KONNCM		000205'	EXT	SEKIN1		000463'	
APACB		000415'	EXT	CPYERR		000131'		KONNL1		000533'	EXT	SEKINT		000462'	
APSINT		000411'		CPYOFL		000133'		KONNLD		000531'	EXT	SEKNXT		000504'	
APXAD0		000234'		DBLXFR		000537'		KONNLM		000445'	EXT	SEKWRD		000536'	
APXAD1		000261'		DCONI	741000	000000		KONNRM		000372'	EXT	SEKXIT		000320'	
APXAD2		000262'		DCONO	740000	000000		KONPTR		000466'	EXT	SEKXT1		000325'	
APXADD		000231'	INT	DCONSO	742000	000000		KONXFR		000401'	EXT	SETNLD		000530'	
APXCHN		000345'	EXT	DCONSZ	743000	000000		LCMD	721000	000000		SOE	000020	000000	SPD
APXCPY		000061'	INT	DIDLE		000010	SPD	LDA	723000	000000		SOM		040000	SPD
APXECN		000401'		DIE		000010	SPD	LDAMSK	034000	177400	SPD	SOP		020000	SPD
APXEND		000760'	INT	DPIA		000007	SPD	LECC	724000	000000		SU	002000	000000	SPD
APXFIN		000270'	INT	DRVTYP		000001	SPD	LI.PIF		000400	SPD	SUA	004000	000000	SPD
APXHRD		000631'	INT	DSKCHN		000000	SPD	LI.PIN		000200	SPD	SUF	010000	000000	SPD
APXIN0		000405'		EPT		000000	EXT	LMA	722000	000000		SUNR	100000	000000	SPD
APXIN2		000416'		ERRATN	000002	000000	SPD	M		000013	INT	SUNT	400000	000000	SPD
APXINE		000403'		ERRBIP		000200	SPD	MPE		000001	SPD	SUOC	040000	000000	SPD
APXINT		000330'	INT	ERRBOP		000100	SPD	NA		000020	SPD	SUSE	020000	000000	SPD
APXKON		000000'	ENT	ERRCMR		000040	SPD	NAMPEX		000002	SPD	SUWP	200000	000000	SPD
APXLIT		000641'	INT	ERRCNT		400000	SPD	P		000001	INT	T1		000006	INT
APXLTM		000162'	INT	ERRCON	000100	000000	SPD	P1		000014	INT	T2		000007	INT
APXOFS		000200'	INT	ERRCPY		000761'		P2		000015	INT	T3		000010	INT
APXPOS		000272'	INT	ERRDTA		200000	SPD	P2BLSH		000002	SPD	T4		000011	INT
APXRCL		000150'	INT	ERREQC	000020	000000	SPD	P3		000016	INT	TIBTBL		000003'	INT
APXRED		000204'	INT	ERREQP	000010	000000	SPD	P4		000017	INT	TPC		000012	SPD
APXSAV		000414'	EXT	ERRINV		040000	SPD	PJRST	324740	000000		U		000005	INT
APXSFT		000635'	INT	ERRLEN	000040	000000	SPD	PPC		000120	SPD	UNIBLK		000377'	EXT
APXSTP		000141'	INT	ERROVR		002000	SPD	PPT		000010	SPD	UNICHR		000062'	EXT
APXUPA		000137'	INT	ERRPAR		010000	SPD	PPU		177020	SPD	UNICYL		000303'	EXT
APXWRT		000203'	INT	ERRRCV		100000	SPD	RCMD	715000	000000		UNIDES		000554'	EXT
APXXFL		000346'		ERRSEL	000200	000000	SPD	RDA	717000	000000		UNIONC		000134'	EXT
ATNENB		000020	SPD	ERRUNK		001000	SPD	READ		000000	SPD	UNIPPU		000070'	EXT
B2PLSH	777777	777776	SPD	ERRWPT	000400	000000	SPD	RECAL	000001	000000	SPD	UNIRC1		000000	EXT
BITTBL		000507'	EXT	FC		400000	SPD	RECC	720000	000000		UNIRCT		000755'	EXT
BLMSIZ		000000	EXT	FILINT		000454'	EXT	REL	000002	000000	SPD	UNISB		000635'	EXT
BPC		000500	SPD	FTDPAG		000000	SIN	RET	263040	000000		UNISBH		000632'	EXT
BPT		000040	SPD	GETLDA		000517'		RMA	716000	000000		UNISBS		000636'	EXT
CALL	260040	000000		HDECC	002000	000000	SPD	ROE	000100	000000	SPD	UNITWC		000000	EXT
CDC		000001	SPD	HECC	000200	000000	SPD	ROTUNI	777777	777771	SPD	UNPDEV		000000	EXT
CF		004000	SPD	IC		000002	SPD	RTYCNT		020000	SPD	UNPFUS		000550'	EXT
CFM		010000	SPD	INTDIS		000453'		S$ENTR	777777	777775	SIN	UNPOFL		000553'	EXT
CI	001000	000000	SPD	IPE	000010	000000	SPD	S$HALT	777777	777777	SIN	UNYBPT		000072'	EXT
APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)	MACRO 12.5-46.0 14:59 13-JAN-88 PAGE 11-2
APXKON.MAC	17-SEP-87 16:39		SYMBOL TABLE

UNYOCV		000000	EXT	
UNYOS		000201'	EXT	
UNYPPY		000066'	EXT	
UNYPUN		000524'	EXT	
UNYRCO		000000	EXT	
UNYRTO		000000	EXT	
UNYUTP		000064'	EXT	
USC	000004	000000	SPD	
USPR		041624	SPD	
W		000012	INT	
W2PLSH	777777	777767	SPD	
WATKON		000053'		
WOE	000040	000000	SPD	
WRITE		011000	SPD	
WRITEA		003000	SPD	
WRPI	700600	000000		
XFRMAX		000535'		
ZOT		000000	SPD	
%OFLER		000645'	EXT	
%OFLRS		000133'	EXT	

APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)	MACRO 12.5-46.0 14:59 13-JAN-88
APXKON.MAC	17-SEP-87 16:39		Symbol cross reference

AA	   170#
AAIE	   174#	   216#
AE	   169#	   616	   672	   674	   724	   828
AMPCYL	   190#	   762
AMPEX	    82#	    94
AMPSEC	   194#
AMPTRK	   192#	   761
AMPUNI	   187#	   188
AMSCYL	   189#	   762
AMSSEC	   193#
AMSTRK	   191#	   761
AMSUNI	   186#
AP0INT	   584#
APACB	    20%	   482	   483	   484	   486	   589	   590	   591	   592	   594	   595	   596	   598	   607
	   658
APSINT	   533	   647	   654#
APXAD0	   478#	   518
APXAD1	   481	   510#
APXAD2	   507	   511#
APXADD	   470#
APXCHN	    33%	    33
APXCPY	   292#
APXECN	   631	   642#
APXEND	   985#
APXFIN	   526#
APXHRD	   895#
APXIN0	   625	   647#
APXIN2	   651	   659#
APXINE	   612	   615	   618	   621	   645#
APXINT	   433	   534	   585#	   648	   655
APXKON	    11	    12#	    15
APXLIT	   906#
APXLTM	   377#
APXOFS	   402#
APXPOS	   531#
APXRCL	   357#
APXRED	   423#
APXSAV	   606%	   606	   657%	   657
APXSFT	   901#
APXSTP	   346#
APXUPA	   340#
APXWRT	   422#
APXXFL	   593	   606#
ATNENB	   227#	   567	   707
B2PLSH	   450	   757
BITTBL	    20%	   330	   368	   536	   728	   734	   738
BLMSIZ	   419%	   435
BPC	   109#	   384	   448
BPT	   108#	   300	   385	   388
CDC	    83#	    86	    88
CF	   165#	   214#	   265	   318	   360	   866
CFM	   154#	   163	   205#	   212
CI	   127#	   270
APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)	MACRO 12.5-46.0 14:59 13-JAN-88
APXKON.MAC	17-SEP-87 16:39		Symbol cross reference

CLRKON	   263#	   307	   347	   456	   550	   645
CMD0	   157#	   207#
CMD1	   158#	   208#
CMD2	   159#	   209#
CMD32	   161#	   210#
CNTERR	   699	   875#
CONER0	   831	   841#
CONERR	   676	   827#
CONOFL	   833	   837#
CPOPJ	   342#	   511	   514
CPOPJ1	   272	   341#	   515
CPU	    91#	   107
CPYERR	   316	   321	   326	   328	   333#
CPYOFL	   310	   335#
DBLXFR	   428	   781#
DIDLE	   229#	   432	   654
DIE	    11	    12	   177#	   217#
DPIA	   230#
DRVTYP	    86#	    88	    94	   100
DSKCHN	    33#	   488	   567	   571	   600	   707
EPT	    25%
ERRATN	   246#
ERRBIP	   238#	   844
ERRBOP	   237#	   844
ERRCMR	   236#
ERRCNT	   245#	   878
ERRCON	   250#
ERRCPY	   333#	   333
ERRDTA	   244#	   842	   852
ERREQC	   248#	   856	   858	   860
ERREQP	   247#
ERRINV	   242#	   854
ERRLEN	   249#
ERROVR	   240#	   846	   848	   850
ERRPAR	   241#
ERRRCV	   243#
ERRSEL	   251#	   862
ERRUNK	   239#
ERRWPT	   252#
FC	   148#	   202#	   265	   318	   360	   866
FILINT	   331%	   331	   338%	   338	   703%	   703
FTDPAG	    19	    19#	    27	    28	   382	   390	   437	   440	   447	   452	   469	   474	   498	   502
	   540	   543	   633	   637	   690	   756
GETLDA	   755#	   773
HDECC	   126#	   853
HECC	   131#	   851
IC	   225#	   264	   317	   359	   485	   553	   559	   597	   865
INTDIS	   663	   667	   702#
IPE	   138#	   617	   675	   725	   829	   830	   832	   843
J	   350	   351	   424	   426	   434	   436	   480	   491	   492	   494	   495	   497	   510	   531
	   548	   549	   607	   608	   610	   619	   620	   624	   626	   629	   632	   642	   646	   658
	   662	   665	   677	   686	   687	   694	   696	   701	   704	   717	   774	   776	   885	   887
	   889
APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)	MACRO 12.5-46.0 14:59 13-JAN-88
APXKON.MAC	17-SEP-87 16:39		Symbol cross reference

KCMDTA	    23%	   700
KCMERR	    24%	   870	   879
KCMFUS	    24%	   834
KCMOFL	    22%	   337	   837
KCMPOS	    22%
KCMRER	    24%
KONBLM	   419%	   434	   632	   687
KONCUA	    22%	   350	   426	   480	   497	   531	   608	   662	   701	   704
KONLRC	   420%	   589	   610	   665	   885
KONLRD	   420%	   591	   677	   889
KONLRM	   420%	   590	   619	   694	   887
KONNCM	   419%	   424	   486	   598
KONNL1	   419%	   484	   549	   596	   776
KONNLD	   419%	   483	   548	   595	   774
KONNLM	   419%	   436	   482	   492	   495	   594	   626	   646	   686	   696
KONNRM	   419%	   494	   620	   629
KONPTR	    23%	   717
KONXFR	   351	   420%	   491	   510	   592	   624	   642
LDAMSK	   195#
LI.PIF	   552
LI.PIN	   561
LISTSN	     3	     6
M	   686	   687	   688	   689	   691	   693
MPE	   182#
NA	   176#	   324	   611	   666
NAMPEX	    84#	   100
P	    12	    77	    78	   273	   307	   320	   341	   346	   347	   349	   353	   362	   443	   456
	   506	   527	   546	   550	   563	   568	   573	   643	   645	   661	   664	   699	   703	   706
	   708	   715	   719	   749	   766	   773	   777	   863	   864	   869	   881	   891	   898	   904
P1	   446	   448	   449	   450	   514
P2	   367	   368	   369	   434	   435	   436	   479	   511	   517	   526	   562	   660	   714	   731
	   735
P2BLSH	   383	   634	   691
P3	   716	   728	   734	   738
P4	   471	   472	   515
PPC	   106#	   107	   109	   296	   759
PPT	    89#	   106	   108	   760
PPU	   107#	   298
READ	   162#	   211#	   423	   554
RECAL	   146#	   201#	   318	   360
REL	   145#	   200#
ROE	   134#	   315	   327	   849
ROTUNI	   188#	   303	   745	   764
RTYCNT	    80#	   268
S$ENTR	    11	    17	   532	   609
S$HALT	    11	   532	   609
S$NAME	    15#	   532	   609
S$NONA	    14	    17	   532	   609
S$TEMP	    11#	    11	   532#	   532	   609#	   609
S$XCT	    17	   532	   609
SAVSTS	   863	   885#
SBSIZ	    21%	   897	   903
SC	   224#	   266	   319	   361	   487	   555	   599	   867
APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)	MACRO 12.5-46.0 14:59 13-JAN-88
APXKON.MAC	17-SEP-87 16:39		Symbol cross reference

SDA	   664	   719	   744#
SECC	   130#	   841
SEKBAD	   726	   738#
SEKDN1	   730#	   739
SEKDON	   728#
SEKIN1	   714#	   732	   736
SEKINT	   563	   661	   713#
SEKNXT	   718	   722	   734#
SEKWRD	   369	   537	   562	   569	   660	   705	   730	   780#
SEKXIT	   370	   562#
SEKXT1	   566	   569#
SETNLD	   443	   506	   546	   640	   773#
SOE	   137#	   315	   327	   845
SOM	   152#	   203#
SOP	   153#	   204#
SU	   221#	   305	   747	   775
SUA	   124#
SUF	   122#	   315	   327
SUNR	   115#	   830	   859
SUNT	   113#	   830	   861
SUOC	   117#	   614	   671	   721	   855
SUSE	   119#	   327	   721	   857
SUWP	   114#	   312
T1	   269	   270	   296	   297	   298	   299	   300	   301	   302	   303	   304	   305	   306	   309
	   310	   312	   315	   323	   324	   327	   329	   330	   333	   334	   335	   336	   337	   346
	   349	   384	   398	   402	   403	   422	   423	   424	   425	   426	   427	   432	   433	   438
	   444	   446	   470	   471	   492	   493	   494	   499	   500	   533	   534	   541	   547	   557
	   558	   566	   569	   610	   611	   614	   616	   617	   619	   620	   626	   627	   630	   632
	   634	   635	   647	   648	   659	   693	   700	   702	   713	   729	   757	   759	   762	   834
	   837	   864	   869	   870	   879	   895	   896	   897
T2	   268	   271	   272	   311	   313	   314	   322	   325	   326	   377	   380	   385	   478	   479
	   516	   517	   627	   628	   629	   659	   760	   761	   827	   842	   844	   846	   848	   850
	   852	   854	   856	   858	   860	   862	   878	   901	   902	   903
T3	   292	   293	   294	   295	   378	   380	   381	   386	   387	   388	   397	   398	   535	   536
	   537	   677	   728	   729	   730	   731	   734	   735	   738	   744	   745	   746	   747	   748
	   761	   762	   765	   774	   775	   776	   835	   836	   838	   839	   842	   844	   846	   848
	   850	   852	   854	   856	   858	   860	   862	   875	   877	   880	   885	   886	   887	   888
	   889	   890
T4	   379	   381	   383	   386	   665	   666	   671	   672	   674	   675	   694	   695	   697	   698
	   720	   721	   724	   725	   763	   764	   765	   828	   829	   830	   832	   841	   843	   845
	   847	   849	   851	   853	   855	   857	   859	   861
TIBTBL	    37#
TPC	    90#	   106
U	   293	   299	   314	   336	   438	   444	   449	   497	   499	   541	   547	   608	   635	   662
	   717	   836	   839	   842	   844	   846	   848	   850	   852	   854	   856	   858	   860	   862
	   876	   877	   886	   888	   890	   895	   896	   897	   901	   902	   903
UNIBLK	    27%	   438	   449	   499	   541	   635
UNICHR	    26%	   293
UNICYL	    21%	   444	   547
UNIDES	    25%	   836	   839
UNIONC	    26%	   314	   336
UNIPPU	    21%	   299
UNIRC1	    26%
APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)	MACRO 12.5-46.0 14:59 13-JAN-88
APXKON.MAC	17-SEP-87 16:39		Symbol cross reference

UNIRCT	    25%	   842	   844	   846	   848	   850	   852	   854	   856	   858	   860	   862	   876	   877
UNISB	    26%	   886	   888	   890	   895	   901
UNISBH	    21%	   896	   897
UNISBS	    21%	   902	   903
UNITWC	    21%
UNPDEV	    25%	   842	   844	   846	   848	   850	   852	   854	   856	   858	   860	   862	   875
UNPFUS	    25%	   835
UNPOFL	    25%	   838
UNYBPT	    27%	   301
UNYOCV	    26%
UNYOS	    26%	   403
UNYPPY	    21%	   297
UNYPUN	    21%	   302	   329	   367	   535	   744	   763
UNYRCO	    26%
UNYRTO	    26%
UNYUTP	    25%	   295
USC	   143#	   198#
USPR	    92#	   397
W	   696	   697
W2PLSH	   472
WATKON	   268#	   320	   362
WOE	   136#	   315	   327	   847
WRITE	   163#	   212#	   422
WRITEA	   164#	   213#
XFRMAX	   688	   689	   779#
ZOT	    36#	    40	    41	    41#	    42	    42#	    43	    43#	    44	    44#	    45	    45#	    46	    46#
	    47	    47#	    48	    48#	    49	    49#	    50	    50#	    51	    51#	    52	    52#	    53	    53#
	    54	    54#	    55	    55#	    56	    56#	    57	    57#	    58	    58#	    59	    59#	    60	    60#
	    61	    61#	    62	    62#	    63	    63#	    64	    64#	    65	    65#	    66	    66#	    67	    67#
	    68	    68#	    69	    69#	    70	    70#	    71	    71#	    72	    72#	    73	    73#	    74	    74#
	    75	    75#	    76	    76#
%OFLER	    22%	   334
%OFLRS	    22%	   335
APXKON - DRIVER FOR F3 DISKS (AMPEX & CDC)	MACRO 12.5-46.0 14:59 13-JAN-88
APXKON.MAC	17-SEP-87 16:39		Macro/Opdef cross reference

CALL	    77#	   676
DCONI	   228#
DCONO	   226#	   263	   357	   488	   567	   571	   600	   649	   656	   707
DCONSO	   232#	   432	   654
DCONSZ	   233#
DSKOFF	    30#
DSKON	    31#
ERRGEN	   792#	   841
ERRPAT	   809#	   842	   844	   846	   848	   850	   852	   854	   856	   858	   860	   862	   875
KONSTR	   255#	   264	   317	   359	   485	   553	   597	   865
LCMD	   197#	   265	   318	   360	   486	   554	   598	   866
LDA	   220#	   304	   306	   483	   484	   548	   549	   595	   596	   746	   748
LECC	   223#	   264	   266	   317	   319	   359	   361	   485	   487	   553	   555	   559	   597	   599
	   865	   867
LMA	   219#	   482	   594
ND	    19
NXTXFR	   281#	   482	   594
PJRST	   370
RCMD	   112#	   269	   309	   323	   589	   720
RDA	   185#	   377	   378	   379	   591	   880
RECC	   196#
RET	    78#	   342	   399	   404	   458	   871
RMA	   184#	   590
STOPCD	    10	   532	   609
TXO	   820#	   842	   844	   846	   848	   850	   852	   854	   856	   858	   860	   862
WRPI	   552	   561
X	   811#	   841	   843	   845	   847	   849	   851	   853	   855	   857	   859	   861
$END	   906SMC
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 1
S.MAC	13-JAN-88 11:55		S.MAC - with system parameter file for P035/D, January 1988

     1				SUBTTL	S.MAC - with system parameter file for P035/D, January 1988
     2
     3				IF2,<IFNDEF LISTSN,<TAPE>>	;Skip to PASS2 in all but COMMON.LST
     4				;THIS MODULE ASSEMBLED WITH KL-10 PARAMETER FILE - KLSYM.MAC
     5
     6					IF2,<IFNDEF LISTSN,<		;LIST KLSYM.MAC IN COMMON ONLY
     7								TAPE>>
     8				TITLE	CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES
     9
    10					STOPCD(,ENTRY,CLOCK1)^
    11					ENTRY	CLOCK1		;For library searches
    12	000000'	260040	000000*	CLOCK1::PUSHJ	P,DIE		;**** Default stopcode for "CLOCK1" ****
    13	000001'	435457	435321		SIXBIT	/CLOCK1/  	;Title of module
    14	000002'	000000	000000		S$NONAME,,0		;?NONAME stopcode "CLOCK1+nnn(nnnnnn)"
    15			000000'	S$NAME==CLOCK1			;For STOPCDs with no arguments
    16					SALL>
    17				^
    18
    19				EXTERNAL UPSCLK,UPTSTS,UPTABK
    20				EXTERNAL UPTLDC,UPTJOB
    21				EXTERNAL RELEA9,JBTUPM,%UPT,JBYUWS
    22				EXTERNAL USRCLK,CURUPT,UPT,EPT
    23				EXTERNAL UPTPC,UPTPDL,UPTXAC,UPTACP
    24				EXTERNAL CIPWTM
    25				EXTERNAL JOBOPC,UPTUAC,%UPS
    26				EXTERNAL ERRTLE
    27
    28	000003'	000000	000000	CLKSAV:	0		;SAVE CLK CONI HERE
    29	000004'	000000	000000	NULSAV:	0		;NULL TIME LAST TICK
    30	000005'	004400	000000*	CLOCK::	POINT 36,CIPWTM,35	;BYTE POINTER TO CLOCK REQ QUEUE
    31	000006'	000000	000000	CLKNEW::0		;Nonzero when something was put into the queue
    32				DEFINE CALMAP,<>
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 2
CLOCK1.MAC	30-OCT-87 23:06		CLOCK - LOW PRIORITY CLOCK SERVICE(CLK)

    33				SUBTTL	CLOCK - LOW PRIORITY CLOCK SERVICE(CLK)
    34
    35				;THIS ROUTINE RUNS ON THE LOWEST PRIORITY PI CHANNEL AND AT UUO LEVEL.
    36
    37				;TO CAUSE AN INTERRUPT ON CLK CHANNEL:
    38				;	SETOM CLKFLG	;FLAG THAT INTERRUPT HAS BEEN REQUESTED
    39				;	WRPI CLKREQ	;REQUEST PI INTERUPT ON LOWEST PI CHANNEL
    40				;THE FOLLOWING OTHER FLAGS MUST ALSO BE SET
    41				;SCHEDF - RESCHEDULING MUST TAKE PLACE (EVEN THOUGH PC IN EXEC MODE)
    42				;TIMEF  - APR CLOCK HAS TICKED ON HIGH PRIORITY CHANNEL
    43				;SEE PICON AND ERRCON TO SEE HOW THIS ROUTINE IS CALLED
    44
    45				;CLK SERVICE PERFORMS THE FOLLOWING ON A REGULAR BASIS:
    46				;PROCESSES CLOCK QUEUE REQUESTS
    47				;CALLS CONSOLE MONITOR COMMAND DECODER
    48				;CALLS CORE SHUFFLER
    49				;THEN CALLS SCHEDULER
    50				;IF THE CURRENT JOB IS IN EXEC MODE THE ABOVE 4 TASKS ARE
    51				;DELAYED UNTIL THE CURRENT JOB ENTERS A STOPPABLE STATE: I.E., UNTIL
    52				;	1. JOB STARTS TO WAIT FOR A BUSY SHARABLE DEVICE
    53				;	2. JOB STARTS TO WAIT FOR IO TO COMPLETE
    54				;	3. CONTROL ABOUT TO RETURN TO USER MODE
    55				;THEN CLK SERVICE IS ENTERED AT UUO LEVEL
    56
    57				;THE CLOCK REQUEST QUEUE PROVIDES THE REST OF THE MONITOR
    58				;WITH THE ABILITY TO BE TRAPPED TO AFTER A NUMBER OF CLOCK TICKS
    59				;HAVE OCCURRED.
    60				;
    61				;TO MAKE A REQUEST:
    62				;	WRPI LI.PIF
    63				;	IDPB AC,CLOCK		;STORE CLOCK REQUEST IN QUEUE
    64				;	WRPI LI.PIN		;TURN PI BACK ON
    65				;Format of word in AC for TOPS-10 5.02 (precursor of TYMCOM-X):
    66				; BYTE (18)ADDRESS(6)DATA(12)TIME
    67				;Format of words in ACs for TOPS-10 7.02:
    68				; BYTE (18)ADDRESS(18)TIME(36)DATA ;note - requires 2 IDPBs
    69				;Format of word in AC for TYMCOM-X (see code at CIP2)
    70				; BYTE (1)NONJIFFY(6)ADDR.INDEX(5)TYPE(7)JOB(1)MINUTE(16)TIME
    71
    72	000007'	201300	000005*	CLKINI::MOVEI T1,CIPWTM		;SETUP CLOCK QUEUE BYTE POINTER
    73	000010'	542300	000005'		HRRM T1,CLOCK		;LH NEVER CHANGES(36 BIT BYTE)
    74	000011'	263040	000000		POPJ P,
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 3
CLOCK1.MAC	30-OCT-87 23:06		WSCHED/USCHED - call scheduler and let someone else run

    75				SUBTTL	WSCHED/USCHED - call scheduler and let someone else run
    76
    77				;Here at UUO level when current job is about to return to user mode from
    78				; a UUO and either:
    79				;	1. Current job typed Control-C while in Exec mode
    80				;	2. Clock flag (TIMEF) went off while current job was in Exec mode
    81
    82				;CALL:	MOVE T1,JBTSTS(J)
    83				;	PUSHJ P,USCHD1		;From UUOCON (MUUO handler return to user)
    84				;	  return here when runnabel
    85
    86	000012'	603300	000400	USCHD1::TLNE	T1,CNTRLC	;Did user type Control-C while in Exec mode?
    87					 PUSHJ	P,TRHALT##	;Yes, stop job and turn off RUN bit, store halt INFO IN CONTEXT
    88	000013'	260040	000000*	 PAGES
    89
    90				;Here at UUO level from MONRET MUUO
    91				;Same call as USCHD1, except no test for ^C.
    92
    93	000014'	262040	000000*	USCHED::POP	P,%UPT+UPTPC	;Save PC in user's UPT
    94	000015'	202040	000000*		MOVEM	P,%UPT+UPTXAC+P	;Save P in UPT dump AC area
    95	000016'	476000	000000*		SETOM	STPFLG##	;Set a flag to say OK to stop job in Exec mode
    96	000017'	254000	000024'		JRST	WSCHD2		;Go reschedule
    97
    98				;Here at UUO level when job goes into IO wait or sharable device wait.
    99				;Also get here when a UUO routine voluntarily gives up control of the CPU
   100				; to let other jobs run when it notices that TIMEF is nonzero.
   101				;CALL:	PUSHJ P,WSCHED
   102				;	  return here when runnable again
   103
   104	000020'	202740	000000*	WSCHED::MOVEM	17,%UPT+UPTXAC+17 ;SAVE AC17 IN DUMP ACS (P4 IN NEW ACS)
   105	000021'	262040	000000*	WSCHD1:	POP	P,%UPT+UPTPC	;SAVE PC IN USER'S UPT.
   106	000022'	201740	000000*		MOVEI	17,%UPT+UPTXAC	;SAVE ACS 0-16 IN DUMP ACS
   107	000023'	251740	000000*		BLT	17,%UPT+UPTXAC+16 ;IN CURRENT UPT JOB DATA AREA
   108				PRINTF(<[Need to locate calls to WSCHED and set LH of JBTPC there]>)
   109				;*;	MOVE	J,JOB		;Make sure J is right
   110				;*;	HRLM	F,JBTPC##(J)	;DDB of device job is waiting for
   111	000024'	200040	000000*	WSCHD2:	MOVE	P,NULPDL##	;NULL JOB PD LIST.  USED TO CALL SCHEDULER
   112								;AND COMMAND DECODER.
   113	000025'	702640	000003'		CHGSTS	CLKSAV		;THIS IS ZERO AT INTERRUPT LEVEL
   114								; ELSE CHARGING CLOCK STATUS.
   115	000026'	702600	400000*		NOCHARGE		;DON'T CHARGE FOR CONTEXT SWITCHING
   116	000027'	200100	000000*		MOVE	J,JOB		;/WRS
   117	000030'	260040	000000*		PUSHJ	P,WRSMAP##	;/WRS - ignore if no state change
   118	000031'	254120	001527'		JRSTF	@[PC.UIO,,RSCHED] ;GO RESCHEDULE
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 4
CLOCK1.MAC	30-OCT-87 23:06		CLKINT - Clock interrupt (channel 7)

   119				SUBTTL	CLKINT - Clock interrupt (channel 7)
   120				;CLKFLG        = Go to clock level if in User mode and reschedule
   121				;CLKFLG+STPFLG = Go to clock level even if in Exec mode and reschedule
   122				;CLKFLG+TIMEF  = Do time-of-day and accounting (because jiffy clock ticked)
   123
   124	000032'	334000	000000	CLKINT::SKIPA			;No CONSZO, always skip
   125	000033'	254000	000000		 JRST	.-.		;Check other devices on channel 7
   126	000034'	700600	020000*		WRPI	CLKBIT##+1B22	;Clear program request on this channel
   127	000035'	336000	000000*		SKIPN	CLKFLG##	;Time to go to clock level?
   128	000036'	254000	000033'		 JRST	CLKINT+1	;No, someone else caused channel 7 interrupt
   129	000037'	250740	000000*		EXCH	17,CLKCHL##	;Get PC at time interrupt was noticed
   130	000040'	607740	010000		TLNN	17,PC.USR	;In user mode?
   131	000041'	332000	000000*		SKIPE	SCHEDF##	;Or is this a forced rescheduling interrupt?
   132	000042'	254120	001530'		 JRSTF	@[XWD PC.UIO,SAVPC] ;Yes, it is OK to reschedule now
   133	000043'	250740	000037*		EXCH	17,CLKCHL##	;No, go back to UUO level routine
   134	000044'	254520	000043*		JEN	@CLKCHL##	; and wait for it to notice TIMEF is set
   135
   136				;Here if PC was in user node, or PC was in exec mode and SCHEDF nonzero
   137
   138	000045'	402000	000003'	SAVPC:	SETZM	CLKSAV		;Clear CONI save flags
   139	000046'	202740	000000*		MOVEM	17,%UPT+UPTPC	;Save PC for user (may be in Exec mode)
   140	000047'	603740	010000		TLNE	17,PC.USR	;Were we in User mode?
   141	000050'	254000	000056'		 JRST	CLKUSM		;Yes, EXECAC will preserve user's ACs
   142	000051'	250740	000044*		EXCH	17,CLKCHL##	;No, get Exec ACs in use by this UUO
   143	000052'	202740	000000*		MOVEM	17,%UPT+UPTXAC+17; and store them in the right place
   144	000053'	201740	000000*		MOVEI	17,%UPT+UPTXAC
   145	000054'	251740	000000*		BLT	17,%UPT+UPTXAC+16
   146	000055'	254000	000064'		JRST	CLKEXM		;Skip over the EXECAC instruction
   147
   148	000056'	250740	000051*	CLKUSM:	EXCH	17,CLKCHL##	;Put user PC back for CRSHID
   149	000057'	701140	001531'	IFNCPU(KI),<EXECAC>		;Switch to Exec AC block, with users as previous.
   150	000060'	476000	000016*		SETOM	STPFLG##	;OK to stop job
   151	000061'	200100	000027*		MOVE	J,JOB		;Get this user's job number
   152	000062'	504100	000056*		HRL	J,CLKCHL##	;Get user's PC
   153	000063'	556102	000000*		HLRZM	J,JBTPC##(J)	;Store for Control-T
   154
   155	000064'	200040	000024*	CLKEXM:	MOVE	P,NULPDL##	;Set up stack in null job's UPT
   156				IFCPU (KS),<NOCHARGE>		;Freeze time base for charging
   157	000065'	335000	000000*		SKIPGE	%UPT+UPTJOB	;Is job going way?
   158	000066'	476000	000061*		 SETOM	JOB##		;Yes, set special flag
   159					PFALL	RSCHED
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 5
CLOCK1.MAC	30-OCT-87 23:06		RSCHED - Reschedule job, run another

   160				SUBTTL	RSCHED - Reschedule job, run another
   161
   162	000067'	332000	000000*	RSCHED:	SKIPE	%UPT+UPTLDC	;Is job's UPT in an unstable state?
   163	000070'	256000	001532'		 STOPCD (.,JOB,PAGP3R,,<Pager - P3 and P4 in use at RSCHED>)
   164				 ;;RSCHED+1
   165	000071'	335100	000066*		SKIPGE	J,JOB##
   166	000072'	254000	000075'		 JRST	RSCH1		;Don't TIMADJ if job is going away
   167	000073'	332002	000000*		SKIPE	JBTLIM(J)
   168	000074'	260040	000766'		 PUSHJ	P,TIMADJ	;Check for TRU limit exceeded
   169	000075'	336000	000000*	RSCH1:	SKIPN	TIMEF##		;Had clock ticked since we were here last?
   170	000076'	254000	000232'		 JRST	CIP6		;No, just reschedule
   171
   172				;Account for null time
   173
   174	000077'	336100	000071*		SKIPN	J,JOB##		;Was last job the null job?
   175	000100'	336000	000000*		SKIPN	POTLST##	;Yes, was it a lost tick?
   176	000101'	254000	000104'		 JRST	INCTIM		;No, usefull work was accomplished
   177	000102'	350000	000000*		AOS	LSTWRD##	;Yes, increment lost time count
   178	000103'	402000	000100*		SETZM	POTLST##	;Clear flag for next time
   179	000104'	336000	000002	INCTIM:	SKIPN	J		;Did null job run?
   180	000105'	350000	000000*		 AOS	NULTIM##	;Yes
   181
   182				;Increment time of day stuff
   183
   184	000106'	336300	000000*		SKIPN	T1,DTMADJ##	;Need to adjust date/time?
   185	000107'	254000	000123'		 JRST	INCTM2		;No
   186	000110'	321300	000115'		JUMPL	T1,INCTM1	;Slow down if negative
   187	000111'	350000	000000*		AOS	TIME##		;Double tick as long as DTMADJ is positive
   188	000112'	377000	000106*		SOSG	DTMADJ##	;One less tick to adjust
   189	000113'	260040	000000*		 PUSHJ	P,OPRDTM##	;Tell OPR when adjustment is complete
   190	000114'	254000	000123'		JRST	INCTM2
   191
   192	000115'	200300	000000*	INCTM1:	MOVE	T1,UPTIME##	;Check if UPTIME is odd or even
   193	000116'	602300	000001		TRNE	T1,1		;Is it an even tick?
   194	000117'	254000	000123'		 JRST	INCTM2		;No, leave this one alone
   195	000120'	370000	000111*		SOS	TIME##		;Yes, clock runs half as fast
   196	000121'	351000	000112*		AOSL	DTMADJ##	; as long as DTMADJ remains negative
   197	000122'	260040	000113*		 PUSHJ	P,OPRDTM##	;Tell OPR when adjustment is complete
   198
   199				;Midnight check
   200
   201	000123'	200340	000120*	INCTM2:	MOVE	T2,TIME##	;Time of day is incremented in PICON
   202	000124'	202340	000000*		MOVEM	T2,SYSUPT##	;System uptime, CONFIG table item 136
   203	000125'	315340	000000*		CAMGE	T2,MIDNIT##	;Gone past midnite?
   204	000126'	254000	000132'		 JRST	CIP2		;No
   205	000127'	210340	000125*		MOVN	T2,MIDNIT##	;Reset time
   206	000130'	272340	000123*		ADDM	T2,TIME##
   207	000131'	350000	000000*		AOS	THSDAT##	;And increment date
   208					PFALL	CIP2
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 6
CLOCK1.MAC	30-OCT-87 23:06		Handle requests in the clock queue

   209				SUBTTL	Handle requests in the clock queue
   210
   211				;Format of word in clock request for TYMCOM-X
   212				; BYTE (1)NONJIFFY(6)ADDR.INDEX(5)TYPE(7)JOB(1)MINUTE(16)TIME
   213				;BITS 1-6 ARE A TABLE INDEX TO THE FUNCTION TO CALL
   214				;BITS 7-11 ARE A TYPE FIELD. ONLY 1 REQ/JOB/TYPE
   215				;BITS 12-18 ARE THE JOB NUMBER
   216				;IF BIT 0=0 THEN BITS 19-35 ARE THE TIME COUNT IN JIFFIES (max of 72 minutes)
   217				;IF BIT 0=1 & BIT 19=0 THEN BITS 20-35 ARE THE TIME COUNT IN SECONDS
   218				;IF BIT 0=1 & BIT 19=1 THEN BITS 20-35 ARE THE TIME COUNT IN MINUTES
   219
   220	000132'	335000	000000*	CIP2:	SKIPGE	DWNFLG##	;Go to TAKDWN when all job and all SATs gone
   221	000133'	333000	000000*		SKIPLE	HIGHJB##
   222	000134'	254000	000142'		 JRST	CIP2A
   223	000135'	336000	000000*		SKIPN	INTERM##	;DO NOT GO DOWN IF LAST TERMINAL NOT OFF
   224	000136'	260040	000000*		 PUSHJ	P,HANGRB##	;ALL THE RIBS OUT OF CORE?
   225	000137'	254000	000142'		  JRST	CIP2A
   226	000140'	335000	000000*		SKIPGE	SATWRT##	;DO NOT GO DOWN UNLESS ALL SATS OUT.
   227	000141'	264000	000000*		 JSR	TAKDWN##	;ORDERLY SHUTDOWN, ALL JOBS GONE
   228
   229	000142'	550240	000005'	CIP2A:	HRRZ	U,CLOCK		;GET ADDRESS OF NEXT CLOCK REQUEST
   230	000143'	306240	000007*	CIP4:	CAIN	U,CIPWTM	;FINISHED YET?
   231	000144'	254000	000200'		 JRST	CIP5		;YES
   232	000145'	375345	000000		SOSGE	T2,(U)		;DECREMENT TIME COUNT
   233	000146'	254000	000164'		 JRST	CIP4S		;BIT 0 ON, SEC. OR MIN.
   234	000147'	602340	377777	CIP4T:	TRNE	T2,377777	;IS TIME FIELD NOW ZERO JIFFIES?
   235	000150'	364240	000143'		 SOJA	U,CIP4		;NO, CHECK NEXT REQUEST
   236	000151'	700600	000400		WRPI	LI.PIF		;U POINTS TO EXPIRED ITEM
   237	000152'	200320	000005'		MOVE	T1,@CLOCK	;GET REQUEST PLACED IN QUEUE LAST
   238	000153'	370000	000005'		SOS	CLOCK		;BACK UP IDBP POINTER
   239	000154'	202305	000000		MOVEM	T1,(U)		;STORE LAST INPLACE OF EXPIRED REQUEST
   240	000155'	700600	000200		WRPI	LI.PIN
   241	000156'	135300	001535'		LDB	T1,[POINT 7,T2,18];GET JOB NUMBER
   242	000157'	135340	001536'		LDB	T2,[POINT 6,T2,6];AND DISPATCH NUMBER
   243	000160'	261040	000005		PUSH	P,U		;SAVE POINTER
   244	000161'	260067	000174'		PUSHJ	P,@CLKDSP(T2)	;DISPATCH
   245	000162'	262040	000005		POP	P,U
   246	000163'	364240	000143'		SOJA	U,CIP4		;FINISH UP
   247
   248				;HERE FOR A SECONDS OR A MINUTES REQUEST
   249
   250	000164'	336000	000000*	CIP4S:	SKIPN	HNGTIM##	;IS THIS AN EVEN SECOND?
   251	000165'	254000	000170'		 JRST	CIP4M		;YES, SEE IF WANT SECONDS OR MINUTES
   252	000166'	350005	000000	CIP4S1:	AOS	(U)		;NO, RESET REMAINING TIME
   253	000167'	364240	000143'		SOJA	U,CIP4		;AND GO ON
   254
   255	000170'	622340	200000	CIP4M:	TRZE	T2,1B19		;SECONDS?
   256	000171'	336000	000000*		 SKIPN	HNGMIN##	;NO MINUTES, EVEN MINUTE?
   257	000172'	254000	000147'		  JRST	CIP4T		;WANTED SECONDS OR EVEN MINUTE, TAKE TRAP
   258	000173'	254000	000166'		JRST	CIP4S1		;FORGET IT
   259
   260	000174'			CLKDSP:				;DISPATCH ROUTINES
   261	000000				PHASE 0
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 6-2
CLOCK1.MAC	30-OCT-87 23:06		Handle requests in the clock queue

   262	000174'	000000	001346'	.SLWAK::! EXP WAKE		;WAKE JOB
   263	000175'	000000	000000*	.SLDSC::! EXP DECSCC##		;Decrement stopcodes per minute
   264	000176'	000000	000000*	.SLTIM::! EXP TIMWAK		;WAKE UP THE TRU-LIMIT TIMER
   265	000177'	000000	000000*	.SLHNG::! EXP MONHNG##		;HANG ON DETACHED TIMOUT
   266	000200'				DEPHASE
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 7
CLOCK1.MAC	30-OCT-87 23:06		Finished all requests in the clock queue, update time of day

   267				SUBTTL	Finished all requests in the clock queue, update time of day
   268
   269	000200'	333100	000077*	CIP5:	SKIPLE	J,JOB##
   270	000201'	260040	000000*		 PUSHJ	P,USRCLK	;See if user wants a clock trap
   271
   272				;Once-a-tick time keeping
   273
   274	000202'	260040	000000*	CIP5A:	PUSHJ	P,ADJUDT##	;Adjust Universal Date/Time every tick
   275	000203'	375000	000164*		SOSGE	HNGTIM##	;This counts from 59 to 0 inclusive
   276	000204'	260040	000356'		 PUSHJ	P,SECOND	;Do once-a-second stuff when HNGTIM=-1
   277	000205'	332000	000000*		SKIPE	COMCNT##	;Any commands to process?
   278	000206'	260040	000000*		 PUSHJ	P,COMMAND##	;Yes, call command decoder in COMCON
   279	000207'	336000	000000*		SKIPN	PCDCNT##	;Anything to do with PCBs?
   280	000210'	260040	000000*		 PUSHJ	P,TIMPCD##	;Yes, go to it.
   281	000211'	260040	000000*		PUSHJ	P,SCNINT##	;Do SCNSER stuff at clock level
   282
   283				; ** maybe move to 1/sec or 1/minute ???
   284	000212'	331100	000200*		SKIPL	J,JOB
   285	000213'	336002	000073*		SKIPN	JBTLIM(J)
   286	000214'	254000	000232'		 JRST	CIP6		;NO LIMIT DESIRED
   287	000215'	260040	000000*		PUSHJ	P,CLKTRU##	;CALC CURRENT TRU FIGURE
   288	000216'	315302	000213*		CAMGE	T1,JBTLIM(J)	;IS IT OVER?
   289	000217'	254000	000232'		 JRST	CIP6		;NO
   290	000220'	200300	001537'		MOVE	T1,[XWD JACCT,KJP]	;(JACCT or KJob Pending?)
   291	000221'	616302	000000*		TDNN	T1,JBTSTS##(J)	;OR IS THIS ONE UNSTOPABLE
   292	000222'	336000	000060*		SKIPN	STPFLG##
   293	000223'	254000	000232'		 JRST	CIP6		;DO NOT STOP IN A DANGEROUS PLACE
   294
   295	000224300	000000*		LDB	T1,JBYLIM##	; See if we have the interrupt enabled?
   296	000225'	322300	000231'		JUMPE	T1,CIP5B	; If not, then go and stop the frame
   297	000226'	402002	000216*		SETZM	JBTLIM(J)	;  else clear the limit
   298	000227'	260040	000000*		PUSHJ	P,TAKTRP	;  and fire the interrupt.
   299	000230'	254000	000232'		JRST	CIP6		;  and go on.
   300
   301	000231'	260040	000000*	CIP5B:	PUSHJ	P,ERRTLE	;Go do proper thing, return after calling STOP1.
   302				INTERN	CIP6	;ERRTLE jumps back here to CIP6 when done.
   303				PRINTF(<[CIP5B: Check out ERRTLE, cause may want 1/sec or 1/minute]>)
   304
   305	000232'	260040	000000*	CIP6:	PUSHJ	P,NXTJOB##	;Call SCHEDULER
   306	000233'	402000	000035*		SETZM	CLKFLG##	;Clear clock-level request flag
   307	000234'	402000	000075*		SETZM	TIMEF##		;Clear "jiffy clock has ticked" flag
   308	000235'	402000	000041*		SETZM	SCHEDF##	;Clear forced scheduling flag
   309	000236'	402000	000222*		SETZM	STPFLG##	;Clear "Ok to stop in exec-mode" flag
   310	000237'	316100	000212*		CAMN	J,JOB		;Did NXTJOB select same job as previous?
   311	000240'	254000	000317'		 JRST	CIP8		;Yes, just restore ACs and dismiss
   312	000241'	261040	000002		PUSH	P,J
   313	000242'	331100	000237*		SKIPL	J,JOB		;No TIMADJ if old job is going away
   314	000243'	260040	000766'		 PUSHJ	P,TIMADJ	;Update time accounting before switching UPT
   315	000244'	262040	000002		POP	P,J
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 8
CLOCK1.MAC	30-OCT-87 23:06		Finished all requests in the clock queue, update time of day

   316				;DIFFERENT JOB, SAVE SOFTWARE STATE(HARDWARE ALREADY SAVED)
   317
   318	000245'	336340	000242*		SKIPN	T2,JOB		;IF NULL JOB,
   319	000246'	254000	000255'		 JRST	CIP6C		;DON'T SAVE ACS.
   320	000247'	321340	000263'		JUMPL	T2,CIP7		;IF LAST JOB LOGGED OUT,
   321								; DON'T TOUCH UPT AT ALL, ITS GONE.
   322				IFNCPU (KI),<
   323	000250'	200300	000000*		MOVE	T1,%UPT+UPTACP	;IS "REAL" PREVIOUS AC BLOCK USER?
   324	000251'	603300	000700		TLNE	T1,(LG.PAC)	;IF NOT, MUST SAVE PREVIOUS AC BLOCK IN STACK.
   325	000252'	254000	000343'		 JRST	CIP6D		;YES, HAVE TO SAVE PREVIOUS.
   326	000253'			CIP6E:
   327				>;END IFNCPU (KI)
   328	000253'	201300	000000*		MOVEI	T1,%UPT+UPTUAC	;READY TO STORE USERS ACS (FROM AC BLOCK)
   329	000254'	256040	001541'		XCTFU	<BLT T1,%UPT+UPTUAC+17>
   330	000255'	336300	000003'	CIP6C:	SKIPN	T1,CLKSAV	;EITHER FROM SAVE (WSCHED ETC)
   331	000256'	702640	000006		 CHGSTS	T1		;FOR FROM CLOCK
   332	000257'	205340	000000*		MOVSI	T2,UPSCLK
   333	000260'	412340	000000*		ANDCAM	T2,%UPT+UPTSTS	;RESET SAVED BIT
   334	000261'	602300	010000		TRNE	T1,CHGON
   335	000262'	436340	000000*		IORM	T2,%UPT+UPTSTS	;AND SET IF CLOCK IS ON
   336
   337				;RESTORE SOFTWARE STATE OF NEW JOB,THEN HARDWARE STATE
   338
   339	000263'			NULJOB::			;TRANSFER HERE FROM SYSINI WITH J=0
   340	000263'	550302	000000*	CIP7:	HRRZ	T1,JBTUPM(J)	;GET ITS UPT ADDRESS
   341	000264'	606300	017777		TRNN	T1,17777	; Make sure it's NON-ZERO (1-17777)
   342	000265'	256000	001542'		 STOPCD (.,STOP,PAGZER,PRTJOB##,<Pager - UPT is zero>)
   343				 ;;CIP7+3
   344	000266'	202100	000245*		MOVEM	J,JOB		;STORE NEW CURRENT JOB NUMBER
   345
   346				IFNCPU (KI),<
   347	000267'	202300	000000*		MOVEM	T1,CURUPT	;POINT TO THE UPT FOR THE NEW JOB
   348	000270'	322100	000332'		JUMPE	J,NULJB		;
   349	000271'	505300	501000		HRLI	T1,(LG.LUB!LG.LAB!<EX0ACB>B8+<USRACB>B11)
   350	000272'	701140	000006		WRUBR	T1		;MAKE USER ACS ACCESSABLE FOR RESTORE.
   351				>;END IFNCPU(KI)
   352				IFCPU (<KL,F3>),<
   353	000273'	700140	000000*	ABKSET::WRADB	%UPT+UPTABK	;Patch to JFCL for system-wide address break
   354				>;END IFCPU(KL,F3)
   355				IFCPU (KS),<
   356				ABKSET::JFCL			;KS does not have hardware for Address Break
   357				>;END IFCPU(KS)
   358
   359				IFCPU (KI),<
   360					HRLM	T1,CURUPT	;WRUBR with LH
   361					DATAO	PAG,CURUPT	;RESET THE PAGING HARDWARE TOO
   362					JUMPE	J,NULJB		;
   363				ABKSET::JFCL	%UPT+UPTABK	;Operations does not want addr break on KI
   364				>;END IFCPU (KI)
   365
   366	000274'	205740	000000*		MOVSI	17,%UPT+UPTUAC
   367	000275'	256200	001546'		XCTTU	<BLT 17,17>	;RESTORE USERS ACS
   368				IFNCPU (KI),<
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 8-2
CLOCK1.MAC	30-OCT-87 23:06		Finished all requests in the clock queue, update time of day

   369	000276'	200300	000000*		MOVE	T1,%UPT+UPTACP	;GET AC STATUS STUFF
   370	000277'	607300	000700		TLNN	T1,(LG.PAC)	;PREVIOUS ACS ALREADY USER?
   371	000300'	254000	000312'		 JRST	CIP7A		;YES, NOTHING MORE TO DO.
   372	000301'	701140	000006		WRUBR	T1		;NO, GET REAL AC STUFF.
   373	000302'	200300	000000*		MOVE	T1,%UPT+UPTACP	;IN CASE IT DISAPPEARED
   374	000303'	205346	777762		MOVSI	T2,-16(T1)	;POINTER TO RESTORE PREVIOUS ACS
   375	000304'	256200	001547'		XCTTU	<BLT T2,17>	;RESTORE THEM.
   376	000305'	200340	000000*		MOVE	T2,%UPT+UPTPC	;GET PC
   377	000306'	607340	004000		TLNN	T2,PC.UIO	;IF USER IOT IS OFF,
   378	000307'	254000	000312'		 JRST	CIP7A		;EVERYTHING IS NOW SET.
   379	000310'	621300	000700		TLZ	T1,(LG.PAC)	;NO, MUST ACCESS USER ACS IN XCTS
   380	000311'	701140	000006		WRUBR	T1		;SO SET IT UP.
   381				>;END IFNCPU (KI)
   382	000312'			CIP7A:
   383				IFCPU (KI),<
   384					HLRZ	T1,%UPT+UPTACP	;GET STACKED AC POINTER
   385					CONI	PAG,T2		;TO PRESERVE PAGE TABLE RELOAD COUNTER
   386					TRZ	T2,760000	;CLEAR THIS FIELD
   387					IOR	T2,T1		;SET EXECUTIVE AC STACK POINTER BITS
   388					CONO	PAG,(T2)	;SET IT
   389				>;END IFCPU (KI)
   390
   391				;RESTORE HARDWARE STATE OF CURRENT JOB
   392
   393	000312'	702600	400000*	IFNCPU(KS),<NOCHARGE>		;MAKE SURE CLOCK IS OFF (IN CASE IRP LEVEL)
   394				IFCPU (KS),<
   395					SKIPE	TBON		;TEST IF CLOCK OFF
   396					 JRST	[RDTIME TBVALUE	;ELSE TURN OFF
   397						 SETZM	TBON
   398						 JRST .+1]
   399				>;END IFCPU (KS)
   400	000313'	200300	000000*		MOVE	T1,%UPT+UPTSTS	;IS CLOCK SUPPOSED TO BE ON?
   401	000314'	603300	000257*		TLNE	T1,UPSCLK
   402	000315'	702600	432000*	IFNCPU(KS),<CHARGE>		;YES, TURN IT ON
   403				IFCPU (KS),<SKIPA>		;TEST KS CHARGING STATE
   404	000316'	254000	000324'		JRST	CIP9		;GO RETURN TO THE PROGRAM.
   405				IFCPU (KS),<
   406					SKIPN	TBON	;SKIP IF ALREADY ON
   407					 JRST	[WRTIME TBVALUE
   408						 SETOM TBON
   409						 JRST .+1]
   410					JRST	CIP9>
   411
   412	000317'	336300	000003'	CIP8:	SKIPN	T1,CLKSAV	;FROM INTERUPT LEVEL?
   413	000320'	254000	000324'		 JRST	CIP9		;YES
   414	000321'	602300	010000		TRNE	T1,CHGON	;WAS CLOCK ON WHEN USER CAME IN?
   415	000322'	702600	432000*	IFNCPU(KS),<CHARGE>		;YES, RESTORE STATE OF THE CLOCK.
   416				IFCPU (KS),<SKIPA>
   417	000323'	254000	000324'		JRST	CIP7B
   418				IFCPU (KS),<
   419					SKIPN	TBON		;SKIP IF CLOCK ALREADY ON
   420					 JRST	[WRTIME TBVALUE
   421						 SETOM  TBON
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 8-3
CLOCK1.MAC	30-OCT-87 23:06		Finished all requests in the clock queue, update time of day

   422						 JRST   .+1]>
   423
   424	000324'			CIP7B:	CALMAP
   425					PFALL	CIP9
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 9
CLOCK1.MAC	30-OCT-87 23:06		Finished all requests in the clock queue, update time of day

   426	000324'	205740	000000*	CIP9:	MOVSI	17,%UPT+UPTXAC	;RESTORE DUMP ACS
   427	000325'	200400	000000*		MOVE	T3,%UPT+UPTPC
   428	000326'	607400	010000		TLNN	T3,PC.USR
   429					 JRST	[BLT 17,17	;RESTORE ACS FOR EXEC MODE
   430	000327'	254000	001550'			 JEN @%UPT+UPTPC]
   431	000330'	200040	001552'		MOVE	P,[IOWD EPLLEN,%UPT+UPTPDL] ;Big stack in real UPT
   432	000331'	254000	000000*		JRST	USRXT7##	;AND GO THROUGH USRXIT FOR TRAPS
   433
   434				;THE NULL JOB
   435				;RUNS IN USER MODE WITH PC=1 AND COUNTS IN AC 0
   436
   437	000332'			NULJB:
   438	000332'	702600	432000*	IFNCPU(KS),<CHARGE>
   439				IFCPU (KS),<
   440					SKIPN	TBVALUE	;SKIP IF CLOCK ALREADY ON
   441					 JRST	[WRTIME TBVALUE
   442						 SETOM TBON
   443						 JRST .+1]
   444				>;END IFCPU (KS)
   445				IFCPU (<KL,F3>),<
   446	000333'	200340	000273'		MOVE	T2,ABKSET	;GET SETTING INSTRUCTION
   447	000334'	316340	001553'		CAMN	T2,[DATAO APR,%UPT+UPTABK] ;LEAVE ALONE IF NOT NORMAL MODE.
   448	000335'	700140	001554'		 DATAO	APR,[0]		;NO NULL JOB ADDRESS BREAK.
   449				>; END IFCPU (<KL,F3>)
   450				IFNCPU(KI),<
   451	000336'	505300	500000		HRLI	T1,(LG.LUB!LG.LAB!<USRACB>B8+<USRACB>B11)
   452	000337'	701140	000006		WRUBR	T1		;SET USER AC BLOCKS, UBR OF NULL JOB.
   453				IFNCPU(F3),<
   454	000340'	400000	000000		SETZ	0,
   455	000341'	200040	001555'		MOVE	1,[AOJA 1]	;THIS IS KL AND KS NULL JOB
   456				>;END IFNCPU (F3)
   457				IFCPU(F3),<
   458					MOVSI	17,F3NULJ
   459					BLT	17,17
   460				>;END IFCPU (F3)
   461	000342'	254520	001556'		JEN	@[PC.USR+PC.PUB+PC.UIO,,1] ;START IT.
   462				>; END IFNCPU (KI)
   463				IFCPU (F3),<;DO LIGHTS SHOW ON AN F3
   464				
   465				F3NULJ:	0		;0/
   466					MOVEI	0,100000;1/ Delay loop
   467					SOJG	0,2	;2/  ...
   468					ROT	16,-3	;3/ Shift 4 bits right 3 places
   469					ROT	17,2	;4/ Shift 4 bits left 2 places
   470					MOVE	15,17	;5/
   471					IOR	15,16	;6/ Combine them
   472					DATAO	PI,15	;7/ Display in lights
   473					JRST	1	;10/
   474					0		;11/
   475					0		;12/
   476					0		;13/
   477					0		;14/
   478					0		;15/ Combined bits
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 9-2
CLOCK1.MAC	30-OCT-87 23:06		Finished all requests in the clock queue, update time of day

   479					17		;16/ Right bits
   480					17		;17/ Left bits
   481				>;END IFCPU (F3)
   482
   483				IFCPU (KI),<
   484					JEN @%UPT+UPTPC ;ALSO DISMISS IF IN INT
   485				>;END IFCPU (KI)
   486
   487				IFNCPU(KI),<
   488				;HERE IF "REAL" PREVIOUS AC BLOCK IS NOT USER - MUST SAVE
   489				; IT IN AC STACK. T1 CONTAINS UPTACP WORD.
   490
   491	000343'	200340	000000*	CIP6D:	MOVE	T2,%UPT+UPTPC	;IF USER IOT IS CLEAR, ALREADY SET CORRECTLY
   492	000344'	603340	004000		TLNE	T2,PC.UIO
   493	000345'	701140	000006		 WRUBR	T1		;SETUP "REAL" PREVIOUS ACS.
   494	000346'	541306	777762		HRRI	T1,-16(T1)	;GET FIRST ADDRESS IN RH OF T1, AC DATAO IN LH T1
   495	000347'	550340	000006		HRRZ	T2,T1		;0,,FIRST ADDRESS IN T2.
   496	000350'	602300	000017		TRNE	T1,17		;HOPE THERE'S ROOM LEFT
   497	000351'	256000	001557'		 STOPCD (.,JOB,PAGSAC,,<Pager - Cannot Stack ACs>)
   498				 ;;CIP6D+6
   499	000352'	256040	001562'		XCTFU	<BLT T2,17(T1)> ;SAVE PREVIOUS AC BLOCK
   500	000353'	621300	000700		TLZ	T1,(LG.PAC)	;SET TO SAVE USER ACS
   501	000354'	701140	000006		WRUBR	T1		;DON'T TRUST USER IOT
   502	000355'	254000	000253'		JRST	CIP6E
   503				>;END IFNCPU (KI)
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 10
CLOCK1.MAC	30-OCT-87 23:06		SECOND - Called once per second at clock level

   504				SUBTTL	SECOND - Called once per second at clock level
   505
   506	000356'	200300	000115*	SECOND::MOVE	T1,UPTIME##	;If channel 7 was not delayed, then T2 gets 0
   507	000357'	230300	000000*		IDIV	T1,JFYSEC##	; otherwise it gets # of ticks of delay
   508	000360'	211307	000001		MOVNI	T1,1(T2)	;Set to -1 or -2
   509	000361'	270300	000357*		ADD	T1,JFYSEC##	;Set to 59 (or 58) ticks until next time
   510	000362'	202300	000203*		MOVEM	T1,HNGTIM##	;Number of jiffies until next second
   511
   512	000363'	261040	000000*		PUSH	P,LOCSEC##	;Save this for compare later
   513	000364'	260040	000520'		PUSHJ	P,UDTFIX	;Reset LOCMIN and LOCSEC from TIME
   514	000365'	260040	000710'		PUSHJ	P,UPELP		;Update elapsed time in JBT tables
   515	000366'	260040	000000*		PUSHJ	P,UNISEC##	;Check for hung disks
   516	000367'	260040	000000*		PUSHJ	P,SWPSEC##	;Write out dirty pages (swapper)
   517	000370'	260040	000000*		PUSHJ	P,DEVCHK##	;Check for hung devices (other than DSK)
   518	000371'	332000	000000*		SKIPE	CTYBLF##	;If RH is nonzero (meaning do once per second),
   519	000372'	563000	000371*		 HRROS	CTYBLF##	; set LH to go ding this time
   520				IFCPU (KS),<
   521					PUSHJ	P,KSSEC##	;Do Keep-Alive and KMC once-per-second stuff
   522				>; END IFCPU (KS)
   523	000373'	260040	000000*		PUSHJ	P,SCNSEC##	;Go handle teletype timing
   524	000374'	375000	000171*		SOSGE	HNGMIN##	;Count down once-a-minute hung timer
   525					 JRST	[MOVEI	T1,^D59		;Reset counter for hung devices
   526						MOVEM	T1,HNGMIN##	;This MUST occur every 3600 ticks
   527						MOVE	T1,NULTIM##	; (even when clock is being adjusted)
   528						EXCH	T1,NULSAV	;Save # of ticks the null job ran
   529						SUB	T1,NULSAV	;Calculate difference from last minute
   530						MOVNM	T1,NULMNT##	;Store it as a positive number
   531	000375'	254000	001563'			JRST	.+1]		;HNGMIN is not synchronized with LOCSEC
   532	000376'	262040	000006		POP	P,T1		;Get previous LOCSEC (in case it is 59)
   533	000377'	317300	000363*		CAMG	T1,LOCSEC##	;Did UDTFIX reset LOCSEC back to 0 (or 1)?
   534	000400'	263040	000000		 POPJ	P,		;End of SECOND routine
   535					PFALL	MINUTE
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 11
CLOCK1.MAC	30-OCT-87 23:06		ONCE A MINUTE CODE

   536				SUBTTL	ONCE A MINUTE CODE
   537
   538	000401'	332000	000000*	MINUTE::SKIPE	KSYS##		;Is the KSYS timer set?
   539					 JRST	[SOSN	KSYS##	  ;Yes, count down minutes until KSYS is over
   540						  SETOM	KSYS##	  ;Set to -1 when it hits zero
   541	000402'	254000	001572'			 JRST	.+1]	  ;Negative means "TIMESHARING IS OVER!"
   542	000403'	350300	000000*		AOS	T1,BGBENF	;# of minutes since last Big Ben message
   543	000404'	405300	777777		ANDI	T1,777777
   544	000405'	574340	000403*		HLRE	T2,BGBENF	;# of minutes between messages
   545	000406'	311300	000007		CAML	T1,T2		;Time to do the "Big Ben" message?
   546	000407'	260040	000556'		 PUSHJ	P,BIGBEN	;Yes, output message to CTY
   547	000410'	260040	000000*		PUSHJ	P,RPTSAT##	;REPORT ANY NEWLY BAD SATS.
   548
   549				;INACTIVITY TIMEOUT
   550
   551	000411'	550100	000133*		HRRZ	J,HIGHJB	;Loop from HIGHJB to zero
   552	000412'	135400	000000*	MINUT1:	LDB	T3,JBYINA##
   553	000413'	322400	000446'		JUMPE	T3,INACT1	;JUMP IF INACTIVITY HANG DISABLED
   554	000414'	200302	000000*		MOVE	T1,JBTINA##(J)
   555	000415'	303406	000000		CAILE	T3,(T1)		;Have we reached the limit?
   556	000416'	254000	000446'		 JRST	INACT1		;  No!
   557	000417'	663300	000000*		TLOE	T1,INAHIT##	;RECORD FACT THAT INACTIVITY HIT OCCURED
   558	000420'	254000	000446'		 JRST	INACT1		;ALREADY OCCURED
   559	000421'	202302	000414*		MOVEM	T1,JBTINA##(J)
   560	000422'	135300	000000*		LDB	T1,JBYNIC##	;Is parent watching NTQ for me?
   561	000423'	322300	000432'		JUMPE	T1,INTKI0	;  No, just check for NTQ below
   562	000424'	261040	000002		PUSH	P,J		;Yes, save current job
   563	000425'	135100	001575'		LDB	J,PRNTBP(J)	;Get parent
   564	000426'	332000	000002		SKIPE	J		;If we still have a parent,
   565	000427'	260040	000227*		 PUSHJ	P,TAKTRP	; notify it
   566	000430'	262040	000002		POP	P,J		;Restore job
   567	000431'	254000	000446'		JRST	INACT1		;Head for next job
   568
   569	000432'	331002	000221*	INTKI0:	SKIPL	JBTSTS##(J)	;Is job runable (not halted or ^C)?
   570	000433'	254000	000440'		 JRST	INTKIL		;  No, ignore NTQ and just kill it
   571	000434'	135300	000000*		LDB	T1,JBYNTQ##	;GET NTQ CHANNEL
   572	000435'	322300	000440'		JUMPE	T1,INTKIL	;NTQ NOT ENABLED, GO KILL JOB
   573	000436'	260040	000427*		PUSHJ	P,TAKTRP	;FIRE NTQ
   574	000437'	254000	000446'		JRST	INACT1
   575	000440'	261040	000002	INTKIL:	PUSH	P,J
   576	000441'	200300	000002		MOVE	T1,J		;HANG JOB J
   577	000442'	505300	000021		HRLI	T1,(1B13!1B17)	; EVEN IF DETACH
   578	000443'	260040	000000*		PUSHJ	P,HNGMON##	; OR TIMEOUT SET
   579	000444'	255000	000000		  JFCL			;ALREADY HUNG
   580	000445'	262040	000002		POP	P,J
   581	000446'	350002	000421*	INACT1:	AOS	JBTINA(J)	;INCREMENT INACTIVE COUNT
   582	000447'	200302	000432*		MOVE	T1,JBTSTS##(J)
   583	000450'	607300	020000		TLNN	T1,JERR		;CAN NOT CONTINUE
   584	000451'	606300	020000		TRNN	T1,JDCON
   585	000452'	254000	000456'		 JRST	MINUT2
   586	000453'	200300	000002		MOVE	T1,J
   587	000454'	260040	000000*		PUSHJ	P,FCONRQ	;TRY TO FORCE A CONTINUE
   588	000455'	255000	000000		  JFCL			;CAN NOT, IGNORE IT
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 11-2
CLOCK1.MAC	30-OCT-87 23:06		ONCE A MINUTE CODE

   589	000456'	367100	000412'	MINUT2:	SOJG	J,MINUT1
   590
   591	000457'	260040	000624'		PUSHJ	P,WDOG		;Call watch-dog routine
   592	000460'	332000	000121*		SKIPE	DTMADJ##	;Is date/time being adjusted?
   593	000461'	260040	000470'		 PUSHJ	P,FIXWEK	;Yes, recalculate GMTDIF and LOCWEK every minute
   594	000462'	332000	000000*		SKIPE	LOCMIN##	;Check if it is the top of the hour
   595	000463'	263040	000000		 POPJ	P,		;End of MINUTE routine
   596					PFALL	HOUR
   597
   598				SUBTTL	Once-an-hour code
   599
   600				;Check if daylight savings time is in effect, and adjust GMTDIF
   601
   602	000464'	260040	000470'	HOUR::	PUSHJ	P,FIXWEK	;Change GMTDIF if daylight savings boundry
   603	000465'	336000	000000*		SKIPN	LOCHOR##	;Check if 00:00 hours
   604	000466'	263040	000000		 POPJ	P,		;End of HOUR routine
   605					PFALL	DAY
   606
   607				SUBTTL	Once-a-day code
   608
   609	000467'			DAY::				;More code can be added here
   610	000467'	263040	000000		POPJ	P,		;End of DAY routine
   611
   612				;FIXWEK - Routine to update GMTDIF (difference between local and GMT) and
   613				;         to update LOCWEK (address of ASCIZ string for day of week)
   614				;	Called when time-of-day is changed and once an hour
   615				;Uses T1,T2,T3,T4
   616
   617	000470'	200300	000130*	FIXWEK::MOVE	T1,TIME##	;Time of day in ticks
   618	000471'	200340	000131*		MOVE	T2,THSDAT##	;Date
   619	000472'	261040	000002		PUSH	P,J		;Save J and P4 in case called from UUOCON
   620	000473'	261040	000017		PUSH	P,P4
   621	000474'	201100	000000		MOVEI	J,0		;Local to job 0's time zone
   622	000475'	200740	001576'		MOVE	P4,[400020,,100000]
   623	000476'	260040	000000*		PUSHJ	P,DATCOM##	;Convert to UDT local time, with daylight
   624	000477'	254000	000506'		  JRST	FIXWK0		;Date not set
   625	000500'	554300	000007		HLRZ	T1,T2		;Keep date portion of UDT
   626	000501'	274340	000000*		SUB	T2,DATE##	;Compare with UDT in GMT
   627	000502'	202340	000000*		MOVEM	T2,GMTDIF##	;This will be different if daylight started
   628	000503'	231300	000007		IDIVI	T1,7		;Get remainder when LH(UDT) is divided by 7
   629	000504'	200307	000511'		MOVE	T1,WEKDAY(T2)	;Get pointer to ASCIZ string
   630	000505'	202300	000000*		MOVEM	T1,LOCWEK##	; that has name of day of week
   631	000506'	262040	000017	FIXWK0:	POP	P,P4
   632	000507'	262040	000002		POP	P,J
   633	000510'	263040	000000		POPJ	P,
   634
   635				;By a remarkable coincidence, TYMSHARE's day 0 (1-Jan-1984) and Greenwich
   636				;day 0 (17-Nov-1858) were both on a Wednesday.  To determine day of week, take
   637				;the LH of either format, divide by it 7, and use the remainder.
   638
   639	000511'	000000	001577'	WEKDAY:	[ASCIZ	/Wednesday/]	;0
   640	000512'	000000	001601'		[ASCIZ	/Thursday/]	;1
   641	000513'	000000	001603'		[ASCIZ	/Friday/]	;2
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 11-3
CLOCK1.MAC	30-OCT-87 23:06		Once-a-day code

   642	000514'	000000	001605'		[ASCIZ	/Saturday/]	;3
   643	000515'	000000	001607'		[ASCIZ	/Sunday/]	;4
   644	000516'	000000	001611'		[ASCIZ	/Monday/]	;5
   645	000517'	000000	001613'		[ASCIZ	/Tuesday/]	;6
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 12
CLOCK1.MAC	30-OCT-87 23:06		Update the other time-of-day locations

   646				SUBTTL	Update the other time-of-day locations
   647
   648				;Reset LOCSEC,LOCMIN,LOCHOR,LOCDAY,LOCMON,LOCYER from THSDAT and TIME
   649				;Called once per second, or when the date/time is changed
   650				;Returns with T1/Hour, T2/Minute, T3/Second, T4/Ticks
   651
   652	000520'	563000	000000*	UDTFIX::HRROS	LOCDAY##	;LOCDAY is invalid until THSDAT gets set
   653	000521'	337000	000471*		SKIPG	THSDAT##	;Don't do this until date/time comes
   654	000522'	263040	000000		 POPJ	P,		; in from the supervisor
   655	000523'	261040	000002		PUSH	P,J		;Preserve J and P4 in case
   656	000524'	261040	000017		PUSH	P,P4		; called from SCNSER
   657	000525'	336000	000505*		SKIPN	LOCWEK##	;If first time after date received,
   658	000526'	260040	000470'		 PUSHJ	P,FIXWEK	; calculate day of week
   659	000527'	200300	000470*		MOVE	T1,TIME##	;Ticks since midnight
   660	000530'	200340	000521*		MOVE	T2,THSDAT##	;Days since 1-Jan-1964
   661	000531'	201100	000000		MOVEI	J,0		;Job 0 has time zone of CTY
   662	000532'	205740	400020		MOVSI	P4,400020	;Convert from TYMSHARE format to DEC local time
   663	000533'	260040	000476*		PUSHJ	P,DATCOM##	; ... ticks since midnight in T1, date in T2
   664	000534'	403300	000007		  SETZB	T1,T2		;Should never happen
   665	000535'	262040	000017		POP	P,P4
   666	000536'	262040	000002		POP	P,J
   667	000537'	231340	000037		IDIVI	T2,^D31		;Get days-1 (T1 has time)
   668	000540'	271400	000001		ADDI	T3,1
   669	000541'	202400	000520*		MOVEM	T3,LOCDAY##	;Set local day of month
   670	000542'	231340	000014		IDIVI	T2,^D12		;Get months-1
   671	000543'	271400	000001		ADDI	T3,1
   672	000544'	202400	000000*		MOVEM	T3,LOCMON##	;Set local month
   673	000545'	271340	003654		ADDI	T2,^D1964
   674	000546'	202340	000000*		MOVEM	T2,LOCYER##	;Set local year
   675	000547'	230300	000000*		IDIV	T1,JFYHR##
   676	000550'	202300	000465*		MOVEM	T1,LOCHOR##	;Set local hour
   677	000551'	230340	000000*		IDIV	T2,JFYMIN##
   678	000552'	202340	000462*		MOVEM	T2,LOCMIN##	;Set local minute
   679	000553'	230400	000361*		IDIV	T3,JFYSEC##
   680	000554'	202400	000377*		MOVEM	T3,LOCSEC##	;Set local seconds
   681	000555'	263040	000000		POPJ	P,		;T4 has ticks since last second
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 13
CLOCK1.MAC	30-OCT-87 23:06		BIGBEN - Output periodic message to the CTY

   682				SUBTTL	BIGBEN - Output periodic message to the CTY
   683				;Output disk space whenever RH of BGBENF is greater or equal to LH.
   684				;(LH is inteval between messages, 1B0 can be poked to output it now)
   685
   686	000556'	337000	000541*	BIGBEN::SKIPG	LOCDAY##	;Wait for date to be set
   687	000557'	263040	000000		 POPJ	P,
   688				;Reset the timer (OPR can change interval via SET BIGBEN 480 command)
   689	000560'	554300	000405*		HLRZ	T1,BGBENF##	;Number of minutes between messages
   690	000561'	620300	400000		TRZ	T1,400000	;Sign bit set if anyone wants to do it now
   691	000562'	307300	002640		CAIG	T1,^D<24*60>	;Max interval is every 24 hours
   692	000563'	305300	000012		CAIGE	T1,^D<10>	;Min interval is every 10 minutes
   693	000564'	201300	000360		 MOVEI	T1,^D<4*60>	;Default is every 4 hours
   694	000565'	516300	000560*		HRLZM	T1,BGBENF##	;Reset timer
   695	000566'	200340	000550*		MOVE	T2,LOCHOR##	;Current time of day
   696	000567'	221340	000074		IMULI	T2,^D60		;Minutes
   697	000570'	270340	000552*		ADD	T2,LOCMIN##	;Time of day in minutes
   698	000571'	230340	000006		IDIV	T2,T1		;If interval is every 60 minutes,
   699	000572'	542400	000565*		HRRM	T3,BGBENF##	; make it go off every hour on the hour
   700				;First part of message
   701	000573'	201300	000001		MOVEI	T1,1		;Tell OPROUT to output to the CTY only
   702	000574'	260040	000000*		PUSHJ	P,OPROUT##	;Set COMTOA for INLMES and such
   703	000575'	201300	000000*		MOVEI	T1,CONFIG##	;System name (ASCIZ)
   704	000576'	260040	000000*		PUSHJ	P,CONMES##	;Space over so LA36 printhead does not
   705	000577'	260040	000000*		PUSHJ	P,PRSPC##	; obscure message
   706	000600'	260040	000000*		PUSHJ	P,LOCTIM##	;Output time of day and a blank
   707	000601'	260040	000000*		PUSHJ	P,INLMES##
   708	000602'	265012	467750		 ASCIZ /- Total of /
	000603'	607304	067714
	000604'	200000	000000
   709				PRINTF(<[BIGBEN Check DRBSTR instead of STRDDB?]>)
   710	000605'	201440	000000*		MOVEI	T4,STRDDB##	; Check right structure
   711	000606'	200311	000000*		MOVE	T1,STRTAL##(T4)	;(see also the CORE command in COMCON)
   712	000607'	554340	000572*		HLRZ	T2,BGBENF##	;Interval
   713	000610'	275340	000012		SUBI	T2,^D10		; minus 10 minutes
   714	000611'	307300	001750		CAIG	T1,^D1000	;If less than 1000 pages
   715	000612'	542340	000607*		 HRRM	T2,BGBENF##	; go off again in 10 minutes
   716	000613'	260040	000000*		PUSHJ	P,PRTDEC##	;Number of pages free
   717	000614'	260040	000601*		PUSHJ	P,INLMES##
   718	000615'	203414	163712		 ASCIZ / pages free on /
	000616'	715014	671312
	000617'	625015	767100
	000620'	000000	000000
   719	000621'	200351	000000*		MOVE	T2,STRNAM##(T4)
   720	000622'	260040	000000*		PUSHJ	P,PRNAME##	;Output "DSKB"
   721				;Do the same for DSKA and any other STR
   722	000623'	324740	000000*		PJRST	CRLF##		;End of BIGBEN
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 14
CLOCK1.MAC	30-OCT-87 23:06		WDOG - Once-a-minute watch dog routines

   723				SUBTTL	WDOG - Once-a-minute watch dog routines
   724				COMMENT #	** THE CHKPNT WATCHDOG **
   725
   726				ONCE A MINUTE THIS CODE EXAMINES THE SITUATION WITH THE STREAM
   727				ACCOUNTING MECHANISM.
   728				1. IF THE SYSTEM IS UN-SHUT (NOT IN AUTORESTRART,SHUT OR
   729				   SUPERSHUT) AND NO ACT OWNER (PJOBN) EXISTS, A MESSAGE GOES TO
   730				   BOTH OPR & CTY (OR JUST CTY IF NO OPR) AND THE BELL IS SET
   731				   TO RING ONCE A SECOND.
   732				2. IF SYSTEM IS IN ANY SHUT STATE, IT'S OK FOR ACTOWNER = 0
   733				3. IF ACTOWNER HAS JERR ON (ILL INS,ILL MEM REF, EXIT..)
   734					THEN A REQUEST TO RESTART CHKPNT IS PUT OUT ON
   735					OPR & CTY AND THE CTY BELL IS SET TO RINGING.
   736
   737				4. A FAKE "SCHED 400000" IS DONE. THE ACTDED BIT IS SET,
   738				   ALLOWING OPERATORS TO GET ONTO SYS AND FIX THINGS UP WITHOUT
   739				   THEIR JOBS GOING INTO AC WAIT. SEE GETABS IN ACTSER.
   740
   741				CTY BELL FLAG CTYBLF WORKS AS FOLLOWS
   742				0,,0	QUIET. MINUTE,SECOND & OPRCTY CODE DO NOTHING
   743				0,,N	THE BELL SHOULD RING.  N has 18 bits for different causes
   744				-1,,N	BELL SHOULD RING NEXT TICK (SET BY SECOND CODE, RESET BY OPRCTY)
   745
   746				#
   747
   748	000624'	201300	000002	WDOG:	MOVEI	T1,2		;Output to both OPR and CTY
   749	000625'	260040	000574*		PUSHJ	P,OPROUT##
   750	000626'	400340	000000		SETZ	T2,		;Nothing to start with
   751	000627'	201300	000605*		MOVEI	T1,STRDDB##	; Begin at first structure
   752	000630'	270346	000606*	WDOG0:	ADD	T2,STRTAL##(T1)	;GET ADVERTISED DISK SPACE REMAINING
   753				PRINTF(<[Need to use STRNXT at WDOG]>)
   754				;*;	HLRZ	T1,STRNXT(T1)	; All STRs (ACTUALLY A LITTLE MORE)
   755				;*;	JUMPN	T1,WDOG0	; Check all structures
   756	000631'	303340	000144		CAILE	T2,^D100	;IF MORE THAN 100 PAGES LEFT, OK
   757	000632'	254000	000637'		 JRST	WDOG1
   758					MOVEI	T1,[ASCIZ/
   759				Disk space is less than 100 pages
   760	000633'	201300	001615'	/]
   761	000634'	337000	000007		SKIPG	T2		;PRINT THAT UNLESS ITS ACTUALLY EMPTY
   762					 MOVEI	T1,[ASCIZ/
   763				Disk full, please take corrective action
   764	000635'	201300	001625'	/]
   765	000636'	260040	000576*		PUSHJ	P,CONMES##	;PRINT ON CTY AND ON OPR TERM IF IT EXISTS
   766
   767	000637'			WDOG1:		;CLOBBER F,T1,T2,..,J
   768	000637'	201200	000000*		MOVEI	F,ACTDDB##
   769	000640'	135100	000000*		LDB	J,PJOBN##		;J:=ACT OWNER JOB IF INITTED
   770	000641'	201400	000001		MOVEI	T3,1			;PREPARE FOR SET CTYBLF BELL FLAG
   771	000642'	200340	001637'		MOVE	T2,[STAUTO!STSUPR!STSHUT];AUTO-RESTART,SHUT,SUPER-SHUT
   772	000643'	616340	000000*		TDNN	T2,STATES##		;IF ANY OF THESE ON, OK FOR ACT TO BE UN-INITTED
   773					 JUMPE	J,[HRRZM T3,CTYBLF##	;BELL FLAG GOES ON
   774						   MOVEI T1,[ASCIZ/
   775				System UNSHUT without accounting.
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 14-2
CLOCK1.MAC	30-OCT-87 23:06		WDOG - Once-a-minute watch dog routines

   776				Log in to 'OPER' and 'R CHKPNT'
   777				/]
   778						   PUSHJ P,CONMES##	;SEND TO 2 PLACES IF POSSIBLE
   779						   MOVEI T2,ALRACT
   780						   IORM  T2,ALR620##
   781	000644'	322100	001665'			   JRST  WDOG2]
   782	000645'	322100	000664'		JUMPE	J,WDOG2		;SOME KIND OF SHUT STATE WITH NO CHKPNT
   783	000646'	200302	000447*		MOVE	T1,JBTSTS##(J)
   784	000647'	607300	020000		TLNN	T1,JERR		;HAS ACT JOB DIED?
   785	000650'	254000	000664'		 JRST	WDOG2		;NO
   786				PRINTF(<[Need to define other bits for RH of CTYBLF, SET HAPPY]>)
   787	000651'	552400	000372*		HRRZM	T3,CTYBLF##	;BELL FLAG GOES ON
   788	000652'	201340	000040		MOVEI	T2,ALRACT
   789	000653'	436340	000000*		IORM	T2,ALR620##
   790	000654'	205340	000000*		MOVSI	T2,ACTDED##	;DECLARE THE STREAM DEAD. SEE MGETABS (ACTSER)
   791	000655'	436344	000012		IORM	T2,DEVSTS(F)	;THIS LETS SOME JOBS GO W/O STREAM RECORDS
   792	000656'	201300	000665'		MOVEI	T1,FATMSG	;FATAL CHKPNT ERROR MSG
   793	000657'	260040	000636*		PUSHJ	P,CONMES##	;PRINT 2 PLACES IF POSS.
   794	000660'	260040	000000*		PUSHJ	P,PJOBX##	;Output job number (in J)
   795	000661'	201340	400000		MOVEI	T2,STSHUT
   796	000662'	260040	000000*		PUSHJ	P,SKDCOM##	;FAKE "SCHED 440000" & EXIT. DECLARE STREAM DEAD & SHUT SYS
   797	000663'	254000	000664'		  JRST	.+1
   798	000664'	263040	000000	WDOG2:	POPJ	P,		;End of WDOG
   799
   800	000665'	004020	100416	FATMSG:	ASCII /CHKPNT program fatal error
	000666'	004020	100416
	000667'	416211	350234
	000670'	521016	071336
	000671'	637454	166500
	000672'	633036	460730
	000673'	203136	271336
   801	000674'	710321	223644	'R CHKPNT' after attaching to /		;PJOBX provides job number
	000675'	202071	045640
	000676'	472504	720302
	000677'	633514	571100
	000700'	607516	460706
	000701'	643235	663500
	000702'	723364	000000
   802
   803				; DBLMSG..TAKE MSG ADDR IN T1, TYPE IT OUT ON BOTH CTY AND OPR TTY IF
   804				;THERE IS AN OPR TTY, ELSE JUST TO CTY. CLOB F,U,T1-T4. ALL
   805				;OTHER ACS ARE NOT DESTROYED.   CALLED FROM SWAMP AND ACTSER
   806
   807	000703'	200440	000006	DBLMSG::MOVE	T4,T1		;Save addr of string
   808	000704'	201300	000002		MOVEI	T1,2		;Want to use 2 LDBs
   809	000705'	260040	000625*		PUSHJ	P,OPROUT##	;Set COMTOA appropriatly
   810	000706'	200300	000011		MOVE	T1,T4		;Get addr of message back
   811	000707'	324740	000657*		PJRST	CONMES##	;Output it then reset COMTOA
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 15
CLOCK1.MAC	30-OCT-87 23:06		Once-a-tick accounting

   812				SUBTTL	Once-a-tick accounting
   813				;UPDATE ELAPSED AND CONNECT TIME COUNTERS
   814
   815	000710'	200100	000411*	UPELP:	MOVE	J,HIGHJB
   816	000711'	200300	000356*		MOVE	T1,UPTIME##		;SEE HOW MANY SECONDS HAVE ELAPSED
   817	000712'	261040	000006		PUSH	P,T1			;SAVE UPTIME
   818	000713'	230300	000553*		IDIV	T1,JFYSEC##		;TO SECONDS
   819	000714'	250301	000000		EXCH	T1,(P)			;UPTIME BACK
   820	000715'	250300	000740'		EXCH	T1,SAVUPT		;GET UPTIME LAST TIME CALLED
   821	000716'	230300	000713*		IDIV	T1,JFYSEC##		;SECONDS FOR THAT
   822	000717'	262040	000007		POP	P,T2
   823	000720'	274340	000006		SUB	T2,T1			;NUMBER OF SECONDS SINCE LAST CALL
   824	000721'	200302	000646*	SECTIM:	MOVE	T1,JBTSTS##(J)
   825	000722'	607300	040000		TLNN	T1,JNA
   826	000723'	254000	000736'		 JRST	NXTSEC
   827	000724'	260040	000747'		PUSHJ	P,GTCGSZ		;GET JOB'S CHARGING SIZE TO T1.
   828	000725'	220300	000007		IMUL	T1,T2			;GET SIZE*ELAPSED SECONDS
   829	000726'	272302	000000*		ADDM	T1,JBTELP(J)
   830	000727'	272300	000726*		ADDM	T1,JBTELP
   831	000730'	550302	000000*		HRRZ	T1,TTYTAB(J)
   832	000731'	322300	000736'		JUMPE	T1,NXTSEC		;IGNORE IF NOT TTY
   833	000732'	550306	000000*		HRRZ	T1,DDBLDB(T1)		;SEE IF A U ATTACHED
   834	000733'	322300	000736'		JUMPE	T1,NXTSEC		;NO, IGNORE
   835	000734'	272342	000000*		ADDM	T2,JBTCNK(J)		;YES, N SEC. MORE OF CONNECT
   836	000735'	272340	000734*		ADDM	T2,JBTCNK
   837	000736'	367100	000721'	NXTSEC:	SOJG	J,SECTIM
   838	000737'	263040	000000		POPJ	P,
   839
   840	000740'	000000	000000	SAVUPT:	0			;SAVE UPTIME FOR CALULATING CONNECT AND ELAPSED TIMES
   841
   842				EXTERNAL JBTELP,JBTCNK,TTYTAB,DDBLDB
   843
   844				;GET THE SIZE OF A PARTICULAR JOB
   845
   846	000741'	250341	000000	GETSIZ::EXCH	T2,(P)			;SIZE WILL BE ON TOP OF PDL ON RETURN
   847	000742'	261040	000007		PUSH	P,T2
   848	000743'	135340	000000*		LDB	T2,JBYUWS		;GET USER WORKING SET SIZE
   849	000744'	242340	777777		LSH	T2,-1			;NEEDS TO BE IN K
   850	000745'	250341	777777		EXCH	T2,-1(P)
   851	000746'	263040	000000		POPJ	P,
   852
   853				COMMENT #
   854				@@SUBROUTINE GTCGSZ
   855				@@PURPOSE
   856				GET INTO T1 THE CHARGING SIZE OF THE JOB IN K.
   857				@@ENTRY
   858				EXPECTS J/ JOB NUMBER.
   859				@@ACCUM
   860				DESTROYS T1.
   861				@@EXIT
   862				RETURNS SIZE IN T1.
   863				@@#
   864
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 15-2
CLOCK1.MAC	30-OCT-87 23:06		Once-a-tick accounting

   865				EXTERN	JBYSC3,JBYSC4
   866
   867	000747'	135300	000000*	GTCGSZ::LDB	T1,JBYSC4	;See if there is a size-dependent scale
   868								; factor (XCHARG TRU-scale UUO)
   869					JUMPE	T1,[LDB	T1,JBYSC3
   870						   JUMPE T1,GTCGS1
   871	000750'	322300	001673'			   POPJ	P,]
   872	000751'	261040	000007		PUSH	P,T2		;Get a scratch register
   873	000752'	261040	000006		PUSH	P,T1		;Save denominator of fraction
   874	000753'	260040	000762'		PUSHJ	P,GTCGS1	;Get internal size to T1
   875	000754'	135340	000000*		LDB	T2,JBYSC3	;Get numerator
   876	000755'	221307	000000		IMULI	T1,(T2)		;T1 gets size*numerator
   877	000756'	262040	000007		POP	P,T2		;Get back denominator
   878	000757'	231307	000000		IDIVI	T1,(T2)		;T1 gets quotient
   879	000760'	262040	000007		POP	P,T2		;Restore work register
   880	000761'	263040	000000		POPJ	P,
   881
   882	000762'	135300	000743*	GTCGS1:	LDB	T1,JBYUWS	;
   883	000763'	271300	000001		ADDI	T1,1		;ROUND UP.
   884	000764'	242300	777777		LSH	T1,-1		;
   885	000765'	263040	000000		POPJ	P,
   886
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 16
CLOCK1.MAC	30-OCT-87 23:06		Once-a-tick accounting

   887				;INTERRUPT HANDLERS FOR THE DK10 REAL TIME CLOCK
   888
   889				IFCPU (KI),<
   890				;INITIALIZE
   891				
   892				TIMINI::SETZM TIMCNT		;COUNT OF OVERFLOWS
   893					DATAO CLK,[0]		;SET STOP COUNT TO 0
   894					CONO CLK,CLKCDN+CLKCOV+CLKON+CLKUSR+CLKCLR+TIMCHN##
   895					SETZM TM2CNT
   896					DATAO CLK2,[0]		;MAKE SURE SECOND CLOCK IS RESET
   897					POPJ P,
   898				
   899				TIMINT::CONSO CLK,CLKCDN+CLKCOV	;IS IT THE DK10?
   900					 JRST .-.		;NO
   901					DATAO CLK,[0]		;JUST TO MAKE SURE
   902					AOS TIMCNT
   903					CONO CLK,CLKCDN+CLKCOV+CLKON+CLKUSR+TIMCHN##
   904					JEN @TIMCHL##
   905				TIMCNT:	0
   906				
   907				TM2INT::CONSO CLK2,CLKCDN+CLKCOV ;2ND DK10 CLOCK ON KI-10
   908					 JRST .-.
   909					DATAO CLK2,[0]
   910					AOS TM2CNT
   911					CONO CLK2,CLKCDN+CLKCOV+CLKON+TM2CHN##
   912					JEN @TM2CHL##
   913				TM2CNT:	0
   914				
   915				STSTIM::CONO CLK2,CLKSTP
   916					DATAI CLK2,T1
   917					HRL T1,TM2CNT		;GET HIGH ORDER PART OF CLOCK
   918					DATAO CLK2,[0]
   919					CONO CLK2,CLKON+TM2CHN##
   920					POPJ P,
   921				>;END IFCPU (KI)
   922				;ROUTINES TO SIMULATE TURNING ON AND OFF THE CLOCK FOR THE KS
   923
   924				;  TO TURN ON THE CLOCK FOR THE USER THE TIME BASE IS SET
   925				;    TO THE VALUE IN TBVALUE, INITIALLY SET TO 0
   926				;  TO TURN OFF THE CLOCK THE CURRENT VALUE OF THE TIME BASE
   927				;    IS SAVED IN TBVALUE AND USED TO RESET THE TIME BASE
   928				;    WHEN THE CLOCK IS TURNED BACK ON
   929
   930				IFCPU (KS),<
   931				
   932				;TURN ON CHARGING
   933				KSCHRG::SKIPE	TBON		;TEST IF OFF
   934					 POPJ	P,		;RETURN IF ALREADY ON
   935					WRTIME	TBVALUE		;SET THE TIME BASE
   936					SETOM	TBON		;FLAG THE CHARGING ON
   937					POPJ	P,
   938				
   939				;TURN CHARGING OFF IF ON
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 16-2
CLOCK1.MAC	30-OCT-87 23:06		Once-a-tick accounting

   940				KSNOCH::SKIPN	TBON		;TEST IF CHARGING ON
   941					 POPJ	P,		;  IF NOT JUST RETURN
   942					RDTIME	TBVALUE		;ELSE SAVE CURRENT VALUE OF TIME BASE
   943					SETZM	TBON		;FLAG THE CHARGING OFF
   944					POPJ	P,
   945				
   946				TBVALUE::0			;CURRENT VALUE OF THE TIME BASE
   947					 0			;LOWER HALF OF TIME BASE
   948				TBON::	 0			;CHARGING FLAG, #0=ON, 0=OFF
   949				>;END IFCPU (KS)
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 17
CLOCK1.MAC	30-OCT-87 23:06		Once-a-tick accounting

   950				;TIMADJ ADJUSTS IN CORE COUNTS FOR A JOB.
   951				;DESTROYS NO ACS.
   952
   953				DEFINE	DADDMT	(AC,HM,LM) 	; DOUBLE ADD TO MEMORY TABLE
   954				<	ADDM AC,HM
   955					PUSH P,AC+1
   956					ADD AC+1,LM
   957					TLZE AC+1,400000
   958					 AOS HM
   959					MOVEM AC+1,LM
   960					POP P,AC+1>
   961
   962	000766'	312100	000266*	TIMADJ::CAME J,JOB
   963	000767'	263040	000000		 POPJ P,		;NOT THE ONE RUNNING
   964	000770'	261040	000006		PUSH P,T1
   965	000771'	261040	000007		PUSH P,T2
   966	000772'	702640	000007		CHGSTS	T2		;SO WE CAN REMEMBER IF IT WAS ON
   967	000773'	702600	400000*		NOCHARGE		;TURN CLOCK OFF.
   968				IFCPU (KI),<
   969					DATAI CLK,T1
   970					HRL T1,TIMCNT		;AND THE OVERFLOWS
   971					SETZM TIMCNT		;RESET OVERFLOW COUNT
   972					DATAO CLK,[0]		;JUST TO MAKE SURE INTEVAL IS 2^18
   973					CONO CLK,CLKCDN+CLKCOV+CLKCLR ;START FRESH.
   974				>;END IFCPU (KI)
   975				IFCPU (F3),<
   976				IF2, <PRINTX [What do we do on FOONLY for accounting?]>
   977					SETZ	T1,		;ZERO FOR NOW
   978				>;END IFCPU (F3)
   979				IFCPU (KL),<
   980	000774'	261040	000007		PUSH	P,T2		;SAVE CLOCK STATE
   981	000775'	702400	000006		RDMACT	T1		;MBOX (UPDATE %UPT+UPTHMC,LMC)
   982	000776'	702440	000006		RDEACT	T1		;EBOX (UPDATE %UPT+UPTHEC,LEC)
   983	000777'	244300	777775	MAGIC1:	ASHC	T1,-^D3		; EBOX DIVIDER (8)
   984	001000'	114300	000506*		DADD	T1,%UPT+UPTHMC	;GET EBOX COUNTS PLUS MBOX COUNTS
   985	001001'	244300	777761	MAGIC:	ASHC	T1,-^D15	; EBOX+MBOX DIVIDER (2^15)
   986						; MCY = EBOX/2^18 + MBOX/2^15
   987	001002'	402000	000504*		SETZM %UPT+UPTHEC
   988	001003'	402000	000505*		SETZM %UPT+UPTLEC
   989	001004'	402000	000506*		SETZM %UPT+UPTHMC
   990	001005'	402000	000507*		SETZM %UPT+UPTLMC
   991	001006'	200300	000007		MOVE T1,T2		;SAVE LOW ORDER FOR LATER
   992	001007'	262040	000007		POP	P,T2		;GET CLOCK STATE BACK FROM STACK.
   993				>;END IFCPU (KL)
   994				IFCPU (KS),<
   995					PUSH	P,T2		;SAVE T2
   996					DMOVE	T1,TBVALUE	;GET ELAPSED TIME
   997					SETZM	TBVALUE		;CLEAR UPPER HALF OF TIME BASE
   998					SETZM	TBVALUE+1	;CLEAR LOWER HALF OF TIME BASE
   999				MAGIC:	ASHC	T1,-^D12	;LEFT ADJUST TIME BASE
  1000					MOVE	T1,T2		;MOVE ELAPSED TIME TO T1
  1001					POP	P,T2		;RESTORE CHGSTS TO T2
  1002				>;END IFCPU (KS)
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 17-2
CLOCK1.MAC	30-OCT-87 23:06		Once-a-tick accounting

  1003	001010'	602340	010000		TRNE	T2,CHGON	;WAS CLOCK ON?
  1004	001011'	702600	432000*		 CHARGE			;YES, TURN IT BACK ON.
  1005	001012'	322100	001051'		JUMPE J,NULTAJ		;DO NOT ACCUMULATE FOR NULJOB
  1006	001013'	261040	000006		PUSH P,T1
  1007	001014'	270300	000000*		ADD T1,JBTCMP		;ACCUMULATE TOTAL
  1008	001015'	623300	400000		TLZE T1,400000
  1009	001016'	350000	000000*		AOS JBTCP2
  1010	001017'	202300	001014*		MOVEM T1,JBTCMP
  1011	001020'	200301	000000		MOVE T1,(P)
  1012	001021'	270302	001017*		ADD T1,JBTCMP(J)
  1013	001022'	623300	400000		TLZE T1,400000
  1014	001023'	350002	001016*		AOS JBTCP2(J)
  1015	001024'	202302	001021*		MOVEM T1,JBTCMP(J)
  1016	001025'	262040	000007		POP	P,T2		;
  1017	001026'	260040	001054'		PUSHJ	P,CHKMTM	;Adjust micro-cycle timer
  1018	001027'	260040	000747'		PUSHJ	P,GTCGSZ	;GET JOB CHARGING SIZE TO T1.
  1019	001030'	261040	000006		PUSH	P,T1		;
  1020	001031'	261040	000007		PUSH	P,T2		;
  1021	001032'	200300	000007		MOVE	T1,T2		;
  1022	001033'	224301	777777		MUL T1,-1(P)		;GET KILOCORE-MICROCYCLES
  1023	001034'	270340	000000*		ADD T2,JBTKCT
  1024	001035'	623340	400000		TLZE T2,400000
  1025	001036'	271300	000001		ADDI T1,1
  1026	001037'	202340	001034*		MOVEM T2,JBTKCT
  1027	001040'	272300	000000*		ADDM T1,JBTCPU
  1028	001041'	262040	000006		POP P,T1
  1029	001042'	262040	000007		POP P,T2		;GET SIZE OFF PDL
  1030	001043'	224300	000007		MUL T1,T2		;THIS IS LIKE JBTKCT ONLY MORE SO
  1031	001044'	270342	001037*		ADD T2,JBTKCT(J)	;LOW ORDER PART
  1032	001045'	623340	400000		TLZE T2,400000		;OVERFLOW?
  1033	001046'	271300	000001		ADDI T1,1		;YES, ADD 1 TO HIGH ORDR
  1034	001047'	202342	001044*		MOVEM T2,JBTKCT(J)
  1035	001050'	272302	001040*		ADDM T1,JBTCPU(J)
  1036	001051'	262040	000007	NULTAJ:	POP P,T2
  1037	001052'	262040	000006		POP P,T1
  1038	001053'	263040	000000		POPJ P,
  1039
  1040				EXTERNAL JBTKCT,JBTCPU,JBTCMP,JBTCP2
  1041
  1042
  1043				; Here with incremental micro-cycles in T2 to update micro-cycle
  1044				; timer if one is set up, and to take trap if requested and
  1045				; timer runs out.
  1046				; Clobbers T1, preserves all other AC's.
  1047
  1048					EXTERNAL UPTMTM
  1049	001054'	336000	000000*	CHKMTM:	SKIPN	%UPT+UPTMTM	;Is there a micro-cycle timer set up?
  1050	001055'	263040	000000		  POPJ	P,		;No, just return
  1051	001056'	272340	000000*		ADDM	T2,%UPT+UPTMTM	;Decrement timer by elapsed u-cycles
  1052	001057'	335000	000000*		SKIPGE	%UPT+UPTMTM	;See if timer ran out
  1053	001060'	263040	000000		  POPJ	P,		;No, return
  1054	001061'	402000	000000*		SETZM	%UPT+UPTMTM	;Yes, turn it off before trapping
  1055	001062'	135300	000000*		LDB	T1,JBYMCY##	;Get u-cycle interrupt channel, if any
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 17-3
CLOCK1.MAC	30-OCT-87 23:06		Once-a-tick accounting

  1056	001063'	260040	000436*		PUSHJ	P,TAKTRP##	;If channel set up, take trap
  1057	001064'	263040	000000		POPJ	P,		;Else just return
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 18
CLOCK1.MAC	30-OCT-87 23:06		RUNCSS - RUN CONTROL(STARTING AND STOPPING OF JOBS)

  1058				SUBTTL	RUNCSS - RUN CONTROL(STARTING AND STOPPING OF JOBS)
  1059
  1060				;RUN CONTROL IS A COLLECTION OF ROUTINES WHICH
  1061				;SET AND CLEAR BITS IN THE JOB STATUS WORDS OF
  1062				;ALL JOBS SO THAT THE SCHEDULER WILL START AND STOP
  1063				;THEM ACCORDINGLY
  1064
  1065				;COMMON ERROR STOPPING ROUTINES
  1066				;CALLED AT ANY LEVEL(M,CLK, OR INTERRUPT)
  1067				;CALL:	MOVE J,JOB CAUSING ERROR OR BEING STOPPED
  1068				;	MOVE F,ADRRESS OF THAT JOB TTY DEVICE DATA BLOCK
  1069				;	MOVE U,BYTE POINTER TO LAST CHAR. ALREADY MOVED
  1070				;			;TO TTY OUTPUT BUFFER
  1071				;	PUSHJ P,KSTOP,PHOLD,HOLD,OR ESTOP
  1072				;	NEVER RETURN IF CALLED AT UUO LEVEL
  1073
  1074				;ROUTINE TO STOP JOB AFTER KJOB COMMAND
  1075				;CALLED AT UUO LEVEL IF JOB HAD CORE, CLOCK LEVEL IF NOT
  1076
  1077	001065'	260040	000000*	KSTOP::	PUSHJ	P,FRMDSN##	;Do frame deassign stuff
  1078	001066'	476000	000000*		SETOM	%UPT+UPTJOB	;Special KJOB flag
  1079	001067'	260040	001102'		PUSHJ	P,CLRJBT	;Clear job tables
  1080	001070'	260040	001072'		PUSHJ	P,DECHJB	;Update HIGHJB
  1081	001071'	254000	001201'		JRST	ESTOP
  1082
  1083				; IF THIS IS THE LARGEST JOB IN USE,FIND NEXT HIGHEST AND SET HIGHJB
  1084
  1085	001072'	315100	000710*	DECHJB::CAMGE	J,HIGHJB##	;IS THIS THE BIGGEST JOB NUMBER ASSIGNED?
  1086	001073'	263040	000000		 POPJ	P,
  1087	001074'	205340	240002		MOVSI	T2,JNA+CMWB+JRQ	;YES, LOOK FOR LAST JOB WITH
  1088								;JOB NUMBER ASSIGNED BIT OR COMMAND WAIT BIT
  1089	001075'	550300	000002		HRRZ	T1,J		;SCAN DOWNWARD
  1090	001076'	616346	000721*		TDNN	T2,JBTSTS##(T1)	;ARE BITS SET FOR THIS JOB?
  1091	001077'	367300	001076'		 SOJG	T1,.-1		;NO,KEEP LOOKING,FINISHED(TRUE IF THIS THE ONLY JOB
  1092	001100'	202300	001072*		MOVEM	T1,HIGHJB##	;YES,STORE NEW HIGHEST JOB NUMBER ASSIGNED
  1093	001101'	263040	000000		POPJ P,
  1094
  1095
  1096	001102'			CLRJBT::			;First clear non GETTABable items
  1097	001102'	402002	000000*		SETZM	JBTINT##(J)	;CLEAR INTERRUPT CHANNELS
  1098	001103'	402002	000000*		SETZM	JBTFNT##(J)	;Frame interrupt assignments (but not JBTPNT)
  1099	001104'	402002	000000*		SETZM	RTIME##(J)	;CLEAR INCREMENTAL JOB RUNNING TIME
  1100	001105'	402002	000000*		SETZM	JBTPWH##(J)
  1101	001106'	402002	000000*		SETZM	JBTPWL##(J)
  1102	001107'	402002	000000*		SETZM	JBTAJF##(J)
  1103	001110'	476002	000000*		SETOM	JBTSPN##(J)	;SETUP SO NEVER MATCHES ANYTHING. (set to ones)
  1104	001111'	402002	000000*		SETZM	JBTS2P##(J)	;OUR RIGHTS OVER PARENT INITIALLY ZERO.
  1105	001112'	402002	000000*		SETZM	JBTSTA##(J)	;Clear .USESTAT command word
  1106	001113'	402002	000000*		SETZM	JBTSLC##(J)	;Clear saved license, (+SETLIC -SETE UUOs)
  1107					;----------------------- Now the GETTABable stuff
  1108	001114'	402002	000000*		SETZM	JBTSLM##(J)	;(-56)MAXIMUM TRU LIMIT
  1109	001115'	402002	000446*		SETZM	JBTINA##(J)	;(-55)INACTIVITY TIMEOUT
  1110	001116'	402002	000000*		SETZM	JBTFTR##(J)	;(-54)PARENT, BROTHER, CHILD
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 18-2
CLOCK1.MAC	30-OCT-87 23:06		RUNCSS - RUN CONTROL(STARTING AND STOPPING OF JOBS)

  1111	001117'	402002	000000*		SETZM	JBTUID##(J)	;(-53)UNIVERSAL ID NUMBER FOR FRAME
  1112	001120'	402002	000000*		SETZM	JBTPNO##(J)	;(-52)PROGRAM NUMBER FOR FRAME
  1113	001121'	402002	000000*		SETZM	JBTPWS##(J)	;(-50) NO. PAGES TO UWS.
  1114	001122'	402002	000000*		SETZM	JBTMPC##(J)	;(-47) NO. PAGES MAPPED.
  1115	001123'	402002	001023*		SETZM	JBTCP2##(J)	;(-42) HIGH PART OF MICRO-CYCLES
  1116	001124'	402002	000000*		SETZM	JBTBIO##(J)	;(-41) BIO CHAR CHARGE
  1117	001125'	402002	000000*		SETZM	JBTBET##(J)	;(-40) BIO TIME CHARGE
  1118	001126'	402002	000000*		SETZM	JBTSOK##(J)	;(-37) SOAKEM ARG
  1119	001127'	402002	000000*		SETZM	JBTERN##(J)	;(-33) ENTERS+RENAMES
  1120	001130'	402002	000226*		SETZM	JBTLIM##(J)	;(-30) TIME (TRU) LIMIT
  1121	001131'	402002	000000*		SETZM	JBTFPN##(J)	;(-25) FILE PPN (FOR HOME-FILES LICENSE)
  1122	001132'	402002	000000*		SETZM	JBTAUN##(J)	;(-23) ACCOUNT USER NUM
  1123	001133'	402002	000000*		SETZM	JBTUNM##(J)	;(-22) FIRST PART OF USER NAME
  1124	001134'	402002	000000*		SETZM	JBTUN1##(J)	;(-21) SECOND PART
  1125					SETZM	JBTLIC##(J)	;(-20) LICENSE (NEEDS READ PROCESS DATE TO PROTECT PROCESS LICE
  1126	001135'	402002	000000*	NSE)
  1127	001136'	402002	001024*		SETZM	JBTCMP##(J)	;(-15) CLOCK TIM
  1128	001137'	402002	001050*		SETZM	JBTCPU##(J)	;(-14) HIGH PART OF KCT
  1129	001140'	402002	000000*		SETZM	JBTBCS##(J)	;(-13) BREAK CHRS*SIZE
  1130	001141'	402002	000735*		SETZM	JBTCNK##(J)	;(-12) CONNECT TIME
  1131	001142'	402002	000727*		SETZM	JBTELP##(J)	;(-11) ELAPSED TIME*SIZE
  1132	001143'	402002	000000*		SETZM	JBTCOT##(J)	;(-10) CHRS OUT
  1133	001144'	402002	000000*		SETZM	JBTCIN##(J)	;(-7) CHRS IN
  1134	001145'	402002	000000*		SETZM	JBTSOT##(J)	;(-6) DISK BLOCKS OUT*SIZE
  1135	001146'	402002	000000*		SETZM	JBTSIN##(J)	;(-5) DISK BLOCKS IN*SIZE
  1136	001147'	402002	000000*		SETZM	JBTSER##(J)	;(-4) ENTER+RENAME*SIZE
  1137	001150'	402002	000000*		SETZM	JBTSLK##(J)	;(-3) LOOKUPS*SIZE
  1138	001151'	402002	000000*		SETZM	JBTDLK##(J)	;(-2) LOOKUPS
  1139				;*;	MOVES	JBTSTS##(J)	;(0) - JOB STATUS BITS (not cleared here)
  1140	001152'	402002	000000*		SETZM	JBTPPN##(J)	;(2) - PROJECT,PROGRAMMER NUMBER
  1141				;*;	MOVES	JBTNAM##(J)	;(3) - PROGRAM BEING RUN (not cleared ever)
  1142	001153'	402002	001047*		SETZM	JBTKCT##(J)	;(5) - KILO-CORE TICKS(JIFFIES*SIZE IN J)
  1143	001154'	402002	000000*		SETZM	JBTPRV##(J)	;(6) - PRIVILEGE BITS SET BY LOGIN
  1144	001155'	402002	000000*		SETZM	JBTRCT##(J)	;(17) - DISK BLOCKS READ BY JOB
  1145	001156'	402002	000000*		SETZM	JBTWCT##(J)	;(20) - DISK BLOCKS WRITTEN BY JOB
  1146	001157'	402002	000000*		SETZM	JBTNM1##(J)	;(31) - SIXBIT Username [1 for 6]
  1147	001160'	402002	000000*		SETZM	JBTNM2##(J)	;(32) - SIXBIT Username [7 for 6]
  1148	001161'	402002	001132*		SETZM	JBTAUN##(J)	;(33) - DEC: Job charge number [AUN]
  1149	001162'	402002	000000*		SETZM	JBTWCH##(J)	;(35) - FRAME WATCH BITS
  1150	001163'	402002	000263*		SETZM	JBTUPM##(J)	;(100)- User pages,Physical UPT page#
  1151	001164'	402002	000000*		SETZM	JBTST2##(J)	;(117)- Second job status word
  1152				;*;	JFCL	JBTFPN##(J)	;(136)- program run directory = (-25)
  1153				;*;	JFCL	JBTPRG##(J)	;(137)- program run filename  = (+03)
  1154	001165'	402002	000063*		SETZM	JBTPC##(J)	;(152)- I/O wait DDB/PC
  1155	001166'	263040	000000		POPJ P,
  1156
  1157				EXTERNAL JOBN,FCONRQ,TPOPJ,TIMWAK
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 19
CLOCK1.MAC	30-OCT-87 23:06		RUNCSS - RUN CONTROL(STARTING AND STOPPING OF JOBS)

  1158				;SUBROUTINE TO STOP JOB, BUT NOT SET ERROR BIT, PUT TTY IN COMMAND MODE
  1159				;AND START TTY
  1160
  1161	001167'	260040	000623*	HOLD0::	PUSHJ	P,CRLF		;PRINT EXTRA CRLF AFTER EXIT MESSAGE
  1162	001170'	260040	000000*	HOLD1::	PUSHJ P,PRRSP3		;PRINT CRLF, [XXX], CRLF, CRLF, DOT
  1163	001171'	260040	000000*		PUSHJ P,TTYSTC		;START TTY AND LEAVE IN MONITOR MODE
  1164	001172'	324740	001210'		PJRST STOP1		;STOP JOB BUT DO NOT SET ERROR BIT
  1165								;SO JOB CAN CONTINUE
  1166				;ROUTINE TO STOP JOB, SET ERROR BIT AND PRINT MESSAGE
  1167				;THEN ADD ^C<CRLF><CRLF><PERIOD>
  1168				;CALL:	MOVEI T1,ADR. OF MESSAGE
  1169				;	PUSHJ P,PHOLD
  1170
  1171	001173'	260040	000707*	PHOLD::	PUSHJ P,CONMES##	;MOVE MESSAGE TO TTY OUTPUT BUFFER
  1172					PFALL	HOLD
  1173				;ROUTINE TO STOP JOB, SET ERROR BIT,
  1174				;AND ADD "^C<CRLF><CRLF><PERIOD>
  1175
  1176				EXTERNAL TTYSTC,PRRSP3,TTKJOB,CRLF,PRRSP1
  1177
  1178	001174'	260040	000000*	HOLD::	PUSHJ P,PRRSP1		;PRINT CRLF, [XXX], CRLF, CRLF, DOT
  1179	001175'	260040	001171*		PUSHJ P,TTYSTC		;MAKE SURE TTY STAYS IN MONITOR MODE
  1180	001176'	205300	000004	KJSTOP::MOVSI T1,JLOG
  1181	001177'	616302	001076*		TDNN T1,JBTSTS##(J)	;IS JOB LOGGED IN
  1182	001200'	260040	000000*		PUSHJ P,TTKJOB		;NO, MUST KILL JOB
  1183								; AND START TTY TYPING OUT MESSAGE
  1184								; FALL INTO ESTOP
  1185
  1186
  1187				;ROUTINE TO STOP USER AND FLAG AS ERROR STOP
  1188
  1189	001201'	322100	000000*	ESTOP::	JUMPE J,CPOPJ##		;IS THIS ERROR IN JOB 0?
  1190	001202'	205300	000001		MOVSI T1,JACCT		;NO, CLEAR ACCOUNTING BIT(IN CASE LOGGING
  1191	001203'	541300	100000		HRRI T1,JACCT2		;ALSO USER SETABLE BIT
  1192	001204'	412302	001177*		ANDCAM T1,JBTSTS##(J)	;IN OR OUT) SO USER CAN USE CONTROL C
  1193								; TO RECOVER
  1194	001205'	205300	020000		MOVSI T1,JERR		;SET ERROR BIT IN JOB STATUS WORD
  1195	001206'	436302	001204*		IORM T1,JBTSTS(J)	;SO JOB CAN NOT CONTINUE(CONT COM.)
  1196	001207'	260040	000000*		PUSHJ	P,CBJERR##	;RELEASE INTERLOCK IF IN A CLUB.
  1197								;FALL INTO STOP1
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 20
CLOCK1.MAC	30-OCT-87 23:06		RUNCSS - RUN CONTROL(STARTING AND STOPPING OF JOBS)

  1198				;ROUTINE TO STOP ANY JOB FROM BEING SCHEDULED
  1199				;CALL:
  1200				;	MOVE J,<JOB NUMBER>
  1201				;	PUSHJ P,STOP1
  1202				;	EXIT	;RETURN HERE IMMEDIATELY, IF CALLED FROM HIGHER PRIORITY PI
  1203						;CHANNEL THAN CLK(LOWEST), OTHERWISE WHEN JOB IS RUNABLE
  1204				;CALLED FROM COMMAND DECODER ON CONTROL-C OR OTHER JOB STOPPING ERROR.
  1205
  1206				EXTERNAL PJBSTS,REQTAB,MAXQ,AVALTB,EPLLEN
  1207
  1208	001210'	205300	400000	STOP1::	MOVSI T1, RUN
  1209	001211'	700600	000400		WRPI  LI.PIF		;DONE AT INTERUPT LEVEL HIGHER THAN DT LEVEL
  1210	001212'	616302	001206*		TDNN T1,JBTSTS(J)	;NO, IS RUN BIT OFF IN JOB STATUS WORD
  1211	001213'	254000	001225'		 JRST STOP1A		;YES
  1212	001214'	661300	000400		TLO T1,CNTRLC		;TURN OFF. "USER HAS TYPED ^C WHILE STILL IN EXEC MODE."
  1213	001215'	412302	001212*		ANDCAM T1,JBTSTS(J)	;NO, SO CLEAR IT
  1214	001216'	700600	000200		WRPI  LI.PIN
  1215	001217'	135300	000000*		LDB T1,PJBSTS		;GET JOB WAIT QUEUE CODE(IF ANY)
  1216	001220'	307300	000000*		CAIG T1,MAXQ		;DOES STATE HAVE Q ?
  1217	001221'	371006	000000*		SOSL REQTAB(T1)		;YES. REDUCE IT.
  1218	001222'	254000	001225'		 JRST STOP1A		;NO
  1219	001223'	375006	000000*		SOSGE AVALTB(T1)	;YES REDUCE  COUNT
  1220	001224'	402006	001223*		 SETZM AVALTB(T1)	;CLEAR AVAL FLAG IF NO ONE WAITING
  1221	001225'	700600	000200	STOP1A:	WRPI  LI.PIN		;MAKE SURE PI ON
  1222	001226'	335002	001154*		SKIPGE	JBTPRV(J)	;check for LogoutOnStop (PV.LOS)
  1223	001227'	260040	001200*		 PUSHJ	P,TTKJOB	; if set, kill frame
  1224	001230'	312100	000766*		CAME J,JOB		;NO, IS THIS JOB CURRENT USER
  1225	001231'	254000	001336'		 JRST REQUE		;NO, SET REQUE JOB FLAG
  1226	001232'	331302	001215*		SKIPL T1,JBTSTS(J)	;YES, RUN FLAG OFF?
  1227	001233'	607300	020000		TLNN	T1,JERR		;YES. ERROR FLAG ON?
  1228	001234'	254000	001460'		 JRST	STOP2		;NO
  1229	001235'	476000	000235*		SETOM	SCHEDF##	;YES, FORCE RESCHEDULING EVEN IF JOB IN EXEC MODE
  1230	001236'	254000	001460'		JRST STOP2		;YES, MAKE CLK RESCHEDULE ANOTHER JOB
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 21
CLOCK1.MAC	30-OCT-87 23:06		RUNCSS - RUN CONTROL(STARTING AND STOPPING OF JOBS)

  1231				;ROUTINE TO REQUE JOB WHICH HAS HAD A COMMAND TYPED
  1232				;WHICH NEEDS CORE AND THE CORE IMAGE IS ON THE DISK.
  1233				;OR IS IN CORE AND HAS ACTIVE DEVICES.
  1234				;CALLED FROM COMMAND DECODER
  1235				;CALL:	MOVE J,JOB NO.
  1236				;	PUSHJ P,DLYCOM
  1237
  1238	001237'	205300	200000	DLYCOM::MOVSI	T1,CMWB		;SET COMMAND WAIT BIT
  1239	001240'	612302	001232*		TDNE	T1,JBTSTS(J)	;IS JOB ALREDY IN COMMAND WAIT?
  1240	001241'	263040	000000		 POPJ	P,		;YES,JUST EXIT
  1241	001242'	436302	001240*		IORM	T1,JBTSTS(J)	;IN JOB STATUS WORD
  1242	001243'	324740	001336'		PJRST	REQUE
  1243
  1244				;ROUTINE TO PUT JOB IN NO CORE QUEUE
  1245
  1246	001244'	201300	000000*	NOCORQ::MOVEI T1,NULQ##		;NO JOB NO. OR NO CORE QUEUE
  1247	001245'	137300	001217*		DPB T1,PJBSTS
  1248	001246'	254000	001336'		JRST REQUE
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 22
CLOCK1.MAC	30-OCT-87 23:06		RUNCSS - RUN CONTROL(STARTING AND STOPPING OF JOBS)

  1249				;ROUTINE TO SETUP MONITOR JOB TO RUN LATER AT UUO LEVEL
  1250				;CALLED BY COMMANDS WHICH MAY OR MAY NOT NEED TO
  1251				;RUN MONITOR JOB DEPENDING ON WHETHER JOB HAS CORE(KJOB,IJOB)
  1252				;TTY WILL REMAIN IN MONITOR MODE
  1253				;JOB MUST HAVE CORE ASSIGNED
  1254				;CALL:	MOVE J, JOB NUMBER
  1255				;	MOVEI T2,ADDR. OF MONITOR JOB TO BE RUN
  1256				;	PUSHJ P,MONJOB
  1257				;WHEN SCHEDULED TO RUN, MONITOR JOB MUST SET UP ITS OWN ACS
  1258
  1259	001247'	260040	001274'	MONJOB::PUSHJ P,MSTART		;START WITH PC IN MONITOR
  1260	001250'	254000	001321'		JRST SETRUN		;SET TTY TO START JOB WHEN COMMAND RESPONSE
  1261								; IS FINISHED AND KEEP TTY IN MONITOR MODE
  1262
  1263				;ROUTINE CALLED BY ONE FRAME TO SET UP A MONITOR JOB IN ANOTHER FRAME.
  1264				; CALL WITH T2 SET TO NEW PC, J CONTAINS FRAME NUMBER,
  1265				; %UPX CONTAINS C(J)'S CONTEXT PAGES.
  1266				; CALLER IS RESPONSIBLE FOR CHECKING
  1267				; THAT THE FRAME IS NOT ALREADY RUNNING.
  1268
  1269	001251'	260040	001310'	MONJBX::PUSHJ	P,MXSTRT	;START WITH PC IN MONITOR
  1270	001252'	324740	001321'		PJRST	SETRUN		;AND MAKE SCHEDULER RUN HIM.
  1271
  1272				;ROUTINE TO SETUP ACS FOR MONITOR JOB STARTING AT UUO LEVEL
  1273				;SETS UP J, WITH JOB NO. AND P
  1274				;WITH PUSH DOWN LIST ADR. IN JOB DATA AREA
  1275				;USED BY KJOB,CORE 0,SAVE,GET,RUN,R,REASSIGN AND FINISH COMMANDS
  1276				;CALL:	MOVEI T2,MONITOR JOB STOP ADDRESS
  1277				;	JSP T1,MONSTR
  1278				;	RETURN WITH ACS P AND J SETUP
  1279
  1280	001253'	200100	001230*	MONSTR::MOVE J,JOB		;CURRENT JOB NUMBER
  1281	001254'	205040	000000*		MOVSI P,-EPLLEN		;MINUS LENGTH OF SYSTEM PD LIST
  1282	001255'	541040	000000*		HRRI P,%UPT+UPTPDL-1	;FIRST LOC.-1 OF PD LIST
  1283	001256'	621340	012000		TLZ	T2,PC.USR+PC.PUB ;MAKE SURE THESE ARE OFF (ONLY FOR
  1284								; SAKE OF THE SIMULATOR, WHICH RUNS IN USER MODE)
  1285								; AND RUNJOB DOES JSP T2,
  1286	001257'	261040	000007		PUSH P,T2		;SAVE STOP ADRRESS
  1287	001260'	261040	000006		PUSH P,T1		;SAVE RETURN ADDRESS
  1288	001261'	254000	000000*		JRST CLRINT		;AND GO CLEAR INTERUPT SYSTEM
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 23
CLOCK1.MAC	30-OCT-87 23:06		RUNCSS - RUN CONTROL(STARTING AND STOPPING OF JOBS)

  1289				;ROUTINE TO SET JOB STATE TO BE SCHEDULED TO RUN
  1290				;WITH SPECIFIED STARTING ADDRESS INCLUDING PC FLAGS
  1291				;CALLED ONLY WHEN JOB IN CORE AND AFTER JOB HAS BEEN
  1292				;SAFELY STOPPED IN ONE OF 3 STATES:
  1293				;1) PC IN USER MODE
  1294				;2) JOB IN A WAIT FOR SHARABLE DEVICE, OR IO WAIT
  1295				;3) JOB JUST ABOUT TO RETURN TO USER MODE FROM A UUO CALL
  1296				;CALL:	MOVE T2,STARTING PC
  1297				;	MOVE T1,OLD PC
  1298				;	MOVE J, JOB NUMBER
  1299				;	MOVE R,ADR. OF JOB DATA AREA WHICH MUST BE IN CORE
  1300				;	PUSHJ P,USTART(PC TO USER MODE),MSTART(PC TO MONITOR MODE)
  1301				;	RETURN HERE IMMEDIATELY
  1302
  1303				EXTERNAL TTYSET,TYCIOS,UPTACP,USRXIT,MAPUPS
  1304				EXTERNAL CLRINT,%UPX
  1305
  1306	001262'	603300	010000	USTART::TLNE T1,PC.USR		;IS IT IN USER MODE TOO?
  1307	001263'	254000	001266'		 JRST USTRT1		;YES.
  1308	001264'	200300	000000*		MOVE T1,%UPT+UPTPDL	;MUUO PC HAS LAST PC
  1309	001265'	541306	777777		HRRI T1,-1(T1)		;SUBTRACT 1 FROM RIGHT HALF AND
  1310								; PRESERVE LH PC FLAGS.
  1311								; (RH=0 ON HALT 0 OR FIRST START)
  1312	001266'	256200	001676'	USTRT1:	UMOVEM T1,JOBOPC	;STORE OLD PC FOR USER TO LOOK AT
  1313	001267'	500340	000006		HLL T2,T1		;PRESERVE USER APR FLAGS
  1314	001270'	661340	012000		TLO T2,PC.USR!PC.PUB	;MAKE SURE NEW PC IN USER MODE
  1315	001271'	621340	004037		TLZ T2,37!PC.UIO	;MAKE SURE NO INDIRECT BITS OR INDEX FIELD
  1316	001272'	261040	000007		PUSH P,T2		;STARTING PC
  1317	001273'	254000	000000*		JRST USRXIT
  1318
  1319	001274'	260040	000000*	MSTART::PUSHJ	P,MAPUPS	;SET UP EXEC MAP.
  1320	001275'	505340	004000		HRLI	T2,PC.UIO	;MAKE SURE PC IS EXEC MODE, IOT USER.
  1321	001276'	202340	000000*		MOVEM	T2,%UPS+UPTPC	;SAVE NEW PC
  1322	001277'	200300	000000*		MOVE T1,UPT+UPTACP	;RESET AC POINTER ON START
  1323	001300'	202300	000000*		MOVEM T1,%UPS+UPTACP
  1324	001301'	205300	000314*		MOVSI T1,UPSCLK		;CLOCK MUST RUN DURING MONJOB
  1325	001302'	436300	000000*		IORM T1,%UPS+UPTSTS
  1326	001303'	201300	040000		MOVEI T1,UTRP		;CLEAR "TRAP" BIT FOR REE, DDT, ETC. AND
  1327	001304'	505300	020770		HRLI T1,JERR+WTMASK+CNTRLC;CLEAR JOB ERR,WAIT CODE, TYPED ^C FLAG
  1328	001305'	412302	001242*		ANDCAM T1,JBTSTS(J)	;CLEAR ERROR AND WAIT STATUS BITS
  1329	001306'	260040	000000*		PUSHJ P,TYCIOS		;CLEAR IOW ON ALL TTY AND RMT DEVICES
  1330	001307'	254000	000000*		JRST TTYSET		;SET TTY STATE TO INITIAL COND.
  1331								; TTYUSR OR TTYURC SHOULD BE CALLED
  1332								; TO INDICATE WHETHER TTY TO USER OR EXEC MODE
  1333								; AND THAT JOB IS TO RUN(RUN BIT =1) WHEN
  1334								; MONITOR COMMAND RESPONSE FINISHES.
  1335								; SEE SETRUN BELOW
  1336
  1337	001310'	505340	004000	MXSTRT:	HRLI	T2,PC.UIO	;MAKE SURE PC IS EXEC MODE, IOT USER.
  1338	001311'	202340	000000*		MOVEM	T2,%UPX+UPTPC	;SET THE PC
  1339	001312'	200300	000000*		MOVE	T1,UPT+UPTACP	;SETUP AC STACK POINTER AGAIN
  1340	001313'	202300	000000*		MOVEM	T1,%UPX+UPTACP
  1341	001314'	205300	001301*		MOVSI	T1,UPSCLK	;INITIAL STATE IS CLOCK RUNNING
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 23-2
CLOCK1.MAC	30-OCT-87 23:06		RUNCSS - RUN CONTROL(STARTING AND STOPPING OF JOBS)

  1342	001315'	436300	000000*		IORM	T1,%UPX+UPTSTS
  1343	001316'	200300	001677'		MOVE	T1,[JERR+WTMASK+CNTRLC,,UTRP]
  1344	001317'	412302	001305*		ANDCAM	T1,JBTSTS(J)
  1345	001320'	324740	001306*		PJRST	TYCIOS		;DON'T CALL TTYSET, MAY NOT BE A LINE
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 24
CLOCK1.MAC	30-OCT-87 23:06		RUNCSS - RUN CONTROL(STARTING AND STOPPING OF JOBS)

  1346
  1347
  1348				;ROUTINE TO SET JOB STATUS RUN BIT(RUN)
  1349				;CALLED BY SCANNER SERVICE WHEN TTY MONITOR COMMAND
  1350				;RESPONSE FINISHES.  THIS ACTION IS ENABLED BY CALLING
  1351				;TTYUSR, OR TTYURC IN SCNSER
  1352				;CALL:	MOVE J,JOB NUMBER
  1353				;	PUSHJ P,SETRUN
  1354
  1355				EXTERNAL RNQUNT,JBYQNT,CBCONT,ILWQ
  1356
  1357	001321'	135300	001245*	SETRUN::LDB T1,PJBSTS		;GET JOB STATUS WAIT QUEUE CODE
  1358	001322'	306300	000000*		CAIN	T1,ILWQ		;SPECIAL CHECK
  1359	001323'	260040	000000*		PUSHJ	P,CBCONT	;FOR CLUBS.
  1360	001324'	303300	001220*		CAILE T1,MAXQ		;DOES JOB STATUS CODE HAVE A QUEUE?
  1361	001325'	254000	001332'		JRST SETR1		;NO
  1362	001326'	353006	001221*		AOSLE REQTAB(T1)	;ADD TO REQUEST COUNT
  1363	001327'	254000	001332'		JRST SETR1		;OTHERS WAITING?
  1364	001330'	357006	001224*		AOSG AVALTB(T1)		;MAKE AVAILABLE
  1365	001331'	476006	001330*		SETOM AVALTB(T1)	;FLAG AS JUST AVAILABLE, BECAUSE
  1366								; NO JOB WAS USING DEVICE. SCHEDULER
  1367								; WILL SCAN THIS QUEUE
  1368	001332'	205300	400000	SETR1:	MOVSI T1,RUN		;SET RUN BIT IN JOB STATUS WORD
  1369	001333'	436302	001317*		IORM T1,JBTSTS(J)
  1370	001334'	200320	000000*	SETR2::	MOVE T1,@RNQUNT		;SET QUANTUM TIME TO RUN QUEUE QUANTUM
  1371	001335'	137300	000000*		DPB T1,JBYQNT		;RUN QUEUE QUANTUM
  1372
  1373				EXTERNAL QJOB
  1374				;PRESERVES ALL BUT T1
  1375
  1376	001336'	260040	000030*	REQUE::	PUSHJ	P,WRSMAP##	;/WRS
  1377	001337'	205300	000002		MOVSI	T1,JRQ		;MARK JOB TO BE REQUEUED WITH JRQ BIT
  1378	001340'	616302	001333*		TDNN	T1,JBTSTS(J)	;INCREMENT COUNT ONLY ONCE FOR EACH JOB
  1379	001341'	350000	000000*		 AOS	QJOB		;INCREMENT COUNT OF NO. OF JOBS WAITING TO BE REQUEUED
  1380	001342'	436302	001340*		IORM	T1,JBTSTS(J)	;SET REQUE BIT FOR SCHEDULER
  1381	001343'	263040	000000		POPJ	P,
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 25
CLOCK1.MAC	30-OCT-87 23:06		RUNCSS - RUN CONTROL(STARTING AND STOPPING OF JOBS)

  1382				;ROUTINE TO PUT A JOB TO SLEEP AND WAKE UP AGAIN LATER
  1383				;CALLED AFTER CLOCK QUEUE REQUEST PUT IN BY UUO ROUTINE
  1384
  1385	001344'	201700	000000*	SETSLP::MOVEI 16,SLPQ##		;SLEEP STATE CODE
  1386	001345'	254000	001421'		JRST SETSTT		;SET STATUS AND RESCHEDULE
  1387
  1388				;HERE AT CLOCK LEVEL WHEN CLOCK REQUEST TIMES OUT FOR SLEEP
  1389				;JOB NO. IN AC T1
  1390
  1391	001346'	200100	000006	WAKE::	MOVE J,T1		;JOB NO.
  1392	001347'	260040	000000*		PUSHJ P,TTSCLR##	;CLEAR TTY SLEEP CONDITIONS
  1393	001350'	135300	001321*		LDB T1,PJBSTS		;GET QUEUE CODE
  1394	001351'	302300	001344*		CAIE T1,SLPQ##		;IS JOB STILL SLEEPING?
  1395	001352'	263040	000000		POPJ P,			;NO. RETURN TO CLOCK ROUTINE
  1396	001353'	201340	000000*		MOVEI T2,RNQ##		;READY TO SET IN RUN Q
  1397	001354'	137340	001350*		DPB T2,PJBSTS		;YES, STORE RUN QUEUE CODE
  1398								; (CONTROL C, START CAN GET JOB OUT OF SLEEP)
  1399	001355'	254000	001334'		JRST SETR2
  1400
  1401				;ROUTINE TO CHANGE A CLOCK REQUEST. SEARCH FOR ONE WITH SAME
  1402				;JOB AND TYPE. IF FOUND CHANGE IT (IF TIME=0 DELETE). IF NOT FOUND
  1403				;INSERT ONE
  1404
  1405	001356'	135400	001700'	CHGCLK::LDB T3,[POINT 12,T1,18]	;GET JOB NUMBER AND TYPE
  1406	001357'	261040	000006		PUSH P,T1
  1407	001360'	550340	000005'		HRRZ T2,CLOCK
  1408	001361'	306340	000143*	CHGCK1:	CAIN T2,CIPWTM
  1409	001362'	254000	001401'		JRST CLKADD		;NOT THERE, INSERT
  1410	001363'	135300	001701'		LDB T1,[POINT 12,(T2),18]
  1411	001364'	312300	000010		CAME T1,T3
  1412	001365'	364340	001361'		SOJA T2,CHGCK1		;NOT CORRECT JOB OR TYPE
  1413	001366'	262040	000006		POP P,T1
  1414	001367'	606300	377777		TRNN T1,377777		;IS TIME 0?
  1415	001370'	254000	001373'		JRST CLKDEL		;YES, DELETE OLD REQ
  1416	001371'	202307	000000		MOVEM T1,(T2)		;JUST CHANGE REQUEST
  1417	001372'	263040	000000		POPJ P,
  1418
  1419	001373'	700600	000400	CLKDEL:	WRPI LI.PIF
  1420	001374'	200320	000005'		MOVE T1,@CLOCK
  1421	001375'	370000	000005'		SOS CLOCK
  1422	001376'	202307	000000		MOVEM T1,(T2)
  1423	001377'	700600	000200		WRPI LI.PIN
  1424	001400'	263040	000000		POPJ P,
  1425
  1426	001401'	262040	000006	CLKADD:	POP P,T1
  1427	001402'	606300	377777		TRNN T1,377777
  1428	001403'	263040	000000		POPJ P,			;TIME=0, DO NOT ADD
  1429	001404'	700600	000400		WRPI LI.PIF
  1430	001405'	136300	000005'		IDPB T1,CLOCK
  1431	001406'	700600	000200		WRPI LI.PIN
  1432	001407'	263040	000000		POPJ P,
  1433
  1434	001410'	210700	000006	CLKJOB::POINT	7,T1,18		;Byte pointer to set job/frame # into
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 25-2
CLOCK1.MAC	30-OCT-87 23:06		RUNCSS - RUN CONTROL(STARTING AND STOPPING OF JOBS)

  1435								; arg for CHGCLK call
  1436				;; Clock queue args for setting/resetting hung DDB timer (SCNSER/COMCON)
  1437	001411'	414300	001604	TIMSET::BYTE (1) 1 (6) .SLHNG (5) 3 (7) 0 (1) 0 (16) ^D900
  1438	001412'	000300	000000	TIMRST::BYTE (1) 0 (6) 0      (5) 3 (7) 0 (1) 0 (16) 0
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 26
CLOCK1.MAC	30-OCT-87 23:06		RUNCSS - RUN CONTROL(STARTING AND STOPPING OF JOBS)

  1439				;ROUTINE TO WAIT FOR A SHARABLE DEVICE
  1440				;CALLED AT UUO LEVEL ONLY BY DEVICE SERVICE ROUTINES
  1441				;CALL:	AOSLE XXREQ		;ADD 1 TO SHARABLE DEVICE REQUEST COUNT
  1442				;				;IS DEVICE AVAILABLE?
  1443				;	PUSHJ P,XXWAIT	;NO, PUT JOB IN WAIT QUEUE
  1444				;	RETURN WHEN DEVICE AVAILABLE
  1445
  1446				;INITIALLY THE REQUEST COUNT IS -N, WHERE N IS THE
  1447				;NUMBER OF JOBS WHICH CAN USE THE SHARABLE DEVICE AT THE SAME TIME
  1448				;A REQUEST COUNT OF 0 MEANS THE MAXIMUM NO. OF JOBS ARE
  1449				;USING THE DEVICE, A POSITIVE NUMBER IS THE
  1450				;NUMBER OF JOBS WAITING IN THE SHARABLE DEVICE WAIT QUEUE
  1451				;NUMERIC ACS  16 AND 17 ARE PRESERVED SINCE THE NEW AC CONVENTION DEPENDS
  1452				;ON THEM BEING SAVED. NUMERIC ACS ARE USED RATHER THAN SYMBOLIC SO THAT
  1453				;THE PROPER ACS WILL BE SAVED IN THE DUMP ACS EVEN IF THE SYMBOLIC AC
  1454				;VALUES ARE CHANGED
  1455
  1456				PRINTF (<[Should HRLM F,JBTPC(J) for wait states that set up F to DDB]>)
  1457
  1458	001413'			SIWAIT::RIWAIT::MTWAIT::DAWAIT::PRWAIT::PSWAIT::
  1459	001413'			M2WAIT::CBWAIT::CAWAIT::AXWAIT::BPWAIT::
  1460	001413'			FCWAIT::ACWAIT::
  1461	001413'	202700	000000*	DVWAIT:	MOVEM 16,%UPT+UPTXAC+16	;SAVE AC16 (SINCE IT IS A PRESERVED AC)
  1462	001414'	200701	000000		MOVE 16,(P)		;GET ADR. OF CALLER
  1463	001415'	200716	777776		MOVE 16,-2(16)		;GET AOSLE XXREQ INSTRUCTION
  1464	001416'	275700	001326*		SUBI 16,REQTAB		;COMPUTE WAIT-STATE QUEUE CODE
  1465	001417'	350016	000000*		AOS CNTTAB##(16)	;COUNT TIMES WAITED FOR QUE
  1466	001420'	202740	000000*		MOVEM 17,%UPT+UPTXAC+17	;SAVE AC17
  1467	001421'	200740	001253*	SETSTT:	MOVE 17,JOB		;CURRENT JOB NO.
  1468	001422'	137700	001426'		DPB 16,PJBS3		;STORE IN JOB STATUS WORD
  1469	001423'	200700	000000*		MOVE 16,%UPT+UPTXAC+16	;RESTORE AC16
  1470	001424'	254000	000021'		JRST WSCHD1		;GO SCHEDULE ANOTHER AND RETURN TO CALLER
  1471								; WHEN SHARABLE DEVICE BECOMES AVAILABLE
  1472								; SEE CLOCK AND CLKCSS
  1473
  1474	001425'	250516	001342*	PJBS1:	POINT JWSIZ,JBTSTS(P3),JWPOS ;BYTE POINTER TO JOB STATUS
  1475								; WORD WAIT QUEUE CODE
  1476	001426'	250517	001425*	PJBS3:	POINT JWSIZ,JBTSTS(17),JWPOS
  1477
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 27
CLOCK1.MAC	30-OCT-87 23:06		RUNCSS - RUN CONTROL(STARTING AND STOPPING OF JOBS)

  1478				;ROUTINE TO SET JOB TO RUN AFTER IT HAS BEEN STOPPED
  1479				;BECAUSE IT HAD TO WAIT FOR IO TO COMPLETE FOR SOME DEVICE
  1480				;EACH SERVICE ROUTINE AT INTERRUPT LEVEL
  1481				;CHECK EACH TIME IT FINISHED A TASK(BUFFERFUL)
  1482				;TO SEE IF THE JOB USING THE DEVICE HAS
  1483				;PREVIOUSLY CAUGHT UP WITH DEVICE AND HAS BEEN STOPPED
  1484				;CALL:	MOVE F,ADR. OF DEVICE DATA BLOCK
  1485				;	MOVE S,DEVIOS(F)	;GET DEVICE IO STATUS WORD FROM DDB
  1486				;	TLZE S,IOW	;IS JOB IN AN IO WAIT FOR THIS DEVICE?
  1487				;	PUSHJ P,SETIOD	;YES, GO FLAG JOB TO START UP AGAIN
  1488				;	RETURN
  1489				;SETS THE JOB QUEUE WAIT CODE TO WSQ IN JOB STATUS WORD.
  1490				;THE SCHEDULER THEN SEES THAT THIS JOB HAS ITS
  1491				;IO WAIT SATISFIED AND IS WAITING TO BE RUN AGAIN
  1492
  1493	001427'	250506	001426*	PJBS2:	POINT JWSIZ,JBTSTS(T1),JWPOS ;LIKE PJBSTS BUT USES T1,NOT J
  1494
  1495	001430'	135300	000640*	STTIOD::LDB T1,PJOBN##
  1496	001431'	135340	001427'		LDB T2,PJBS2
  1497	001432'	306340	000000*		CAIN T2,SWQ##
  1498	001433'	256000	001702'	CLKNSQ:: STOPCD (.,JOB,CLKNSQ,,<Job not in SW queue>)
  1499				 ;;STTIOD+4
  1500	001434'	201340	000000*		MOVEI T2,TSQ##	;PUT IN TTY IOWAIT SATISFIED QUEUE
  1501	001435'	350000	000000*		AOS TSAVAL##
  1502	001436'	254000	001445'		JRST SETID1
  1503
  1504	001437'	135300	001430*	SETIOD::LDB T1,PJOBN##
  1505	001440'	135340	001427'		LDB T2,PJBS2	;HIS CURRENT WAIT CODE
  1506	001441'	306340	001432*		CAIN T2,SWQ##
  1507	001442'	256000	001433'		 STOPCD (,XCT,CLKNSQ)
  1508					;Job not in SW queue  ;;SETIOD+4
  1509	001443'	201340	000000*		MOVEI T2,WSQ##	;PUT IN IO WAIT SATISFIED QUEUE
  1510	001444'	350000	000000*		AOS WSAVAL##		;INCR. NO. OF JOBS WITH IO WAIT!
  1511								; SATISFIED. NON-ZERO WSAVAL WILL
  1512								; CAUSE SCHED. TO SCAN FOR IO
  1513								; SATISFIED JOB.
  1514	001445'			SETID1:	
  1515	001445'	137340	001427'		DPB T2,PJBS2		;IN JOB STATUS WORD
  1516					EXTERN	WRSMP1		;/WRS
  1517	001446'	261040	000002		PUSH	P,J		;/WRS
  1518	001447'	200100	000006		MOVE	J,T1		;/WRS
  1519	001450'	260040	000000*		PUSHJ	P,WRSMP1	;/WRS - include even if no change
  1520	001451'	262040	000002		POP	P,J		;/WRS
  1521	001452'	205340	000002		MOVSI T2,JRQ		;SET JOB TO BE REQUEUED AT NEXT CLOCK TICK
  1522	001453'	616346	001427*		TDNN T2,JBTSTS(T1)	;IS REQUE BIT ALREADY ON?
  1523	001454'	350000	001341*		AOS QJOB		;NO, INCREMENT COUNT ONCE FOR EACH JOB
  1524	001455'	436346	001453*		IORM T2,JBTSTS(T1)	;SET REQUEUEING BIT FOR SCHEDULER
  1525	001456'	332000	001421*		SKIPE JOB		;IS NULL JOB RUNNING?
  1526	001457'	263040	000000		POPJ P,			;NO LET OTHER JOB RUN TILL SCHEDULER IS TRAPPPED TO
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 28
CLOCK1.MAC	30-OCT-87 23:06		RUNCSS - RUN CONTROL(STARTING AND STOPPING OF JOBS)

  1527				;ROUTINE TO CAUSE CLK ROUTINE TO RESCHEDULE
  1528				;CALLED AT ANY LEVEL
  1529				;CALL:	PUSHJ P,STOP2	
  1530				;	RETURN IMMEDIATELY EXCEPT IF AT UUO LEVEL
  1531				;	IF AT UUO LEVEL, RETURN WHEN JOB IS RUNABLE AGAIN
  1532
  1533	001460'	700600	000400	STOP2:	WRPI LI.PIF		;PREVENT CLOCK INTERRUPT DURING STOP2 CODE
  1534	001461'	476000	000233*		SETOM CLKFLG##		;SET FLAG TO INDICATE CLK INTERRUPT
  1535								; EVEN THOUGH CLK INTERRUPT IS NOT A TIME INTERRUPT
  1536	001462'	700600	000000*		WRPI PICLK##		;TURN PI BACK ON AND REQUEST INTERRUPT TO
  1537								; CLK PI CHANNEL(LOWEST PRIORITY CHANNEL)
  1538	001463'	700700	077400		CONSZ PI,177B27		;ANY INTERUPTS IN PROGRESS?
  1539	001464'	263040	000000		 POPJ P,		;YES, EXIT IMMEDIATELY
  1540	001465'	261040	000006		PUSH P,T1
  1541	001466'	700640	000006	STOP3:	RDPI T1			;READ STATUS OF PI
  1542	001467'	603300	000000*		TLNE T1,CLKBIT		;IS THERE A REQUEST WAITING ON CH7?
  1543	001470'	254000	001466'		 JRST STOP3		;YES, WAIT FOR IT TO HAPPEN
  1544	001471'	254000	000000*		JRST TPOPJ		;NO, EXIT
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 29
CLOCK1.MAC	30-OCT-87 23:06		RUNCSS - RUN CONTROL(STARTING AND STOPPING OF JOBS)

  1545				;ROUTINE TO WAIT TILL DEVICE CATCHES UP WITH USER AND BECOMES INACTIVE
  1546				;CALLING SEQUENCE
  1547				;     PUSHJ P, WAIT1
  1548				;     EXIT	  ALWAYS RETURNS HERE
  1549
  1550				;IF THE DEVICE IS INACTIVE (IOACT=0), RETURNS TO EXIT. OTHERWISE, SETS
  1551				;IOW:=1 AND ENTERS WAIT UNLESS IOACT BECOMES ZERO BEFORE THE
  1552				;JUMP IS MADE, IN WHICH CASE IT SETS IOW:=0 AND RETURNS TO EXIT.
  1553				;ON LEAVING THE WAIT STATE, RETURNS TO EXIT.
  1554				;WAIT1 DESTROYS S, P1, P2, AND P3.  ALL OTHER ACS ARE SAFE.
  1555				;THIS ROUTINE PREVENTS THE STATE IOACT=0 AND IOW=1 FROM OCCURING
  1556				;CALLING SEQUENCE
  1557				;     PUSHJ P, WSYNC
  1558				;     EXIT             ALWAYS RETURNS HERE
  1559				;SETS IOW:=1 AND ENTERS WAIT ROUTINE. RETURNS TO EXIT WHEN IOACT=0.
  1560
  1561	001472'	200004	000002	WAIT1::	MOVE S,DEVIOS(F)
  1562	001473'	606000	010000		TRNN S, IOACT		;IS DEVICE ACTIVE? (IOACT=1?)
  1563	001474'	263040	000000		POPJ P,			;RETURN
  1564	001475'	260040	001477'		PUSHJ P,WSYNC		;WAIT
  1565	001476'	254000	001472'		JRST WAIT1
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 30
CLOCK1.MAC	30-OCT-87 23:06		RUNCSS - RUN CONTROL(STARTING AND STOPPING OF JOBS)

  1566				;WSYNC IS CALLED TO WAIT UNTIL SETIOD IS CALLED BY INTERRUPT SERVICE ROUTINE
  1567				;IE  UNTIL CURRENT BUFFER ACTIVITY IS COMPLETED
  1568				;CALLED ONLY FROM UUO LEVEL
  1569				;CALL:	MOVE F,ADR. OF DEVICE DATA BLOCK
  1570				;	PUSHJ P,WSYNC
  1571				;	RETURN IMMEDIATELY IF DEVICE IS INACTIVE
  1572				;	RETURN WHEN DEVICE FINISHES NEXT BUFFER IF IT IS ACTIVE
  1573				;WSYNC DESTROYS S, P1, P2, AND P3.  ALL OTHER ACS ARE SAFE.
  1574
  1575				EXTERNAL IOWQ,TIOWQ,MBWQ,DEYCLS,ERRHDV
  1576
  1577	001477'	205000	000001	WSYNC::	MOVSI S,IOW		;SETUP DEVICE IO WAIT BIT
  1578	001500'	135700	000000*		LDB P3,DEYCLS		;DEVICE CLASS CODE
  1579	001501'	200616	001523'		MOVE P1,CLSQUE(P3)	;GET QUE FOR THIS CLASS
  1580
  1581	001502'	200700	001456*		MOVE P3,JOB		;CURRENT JOB NO.
  1582	001503'	201640	010000		MOVEI P2,IOACT		;DEVICE ACTIVE BIT
  1583	001504'	700600	000400		WRPI  LI.PIF		;TURN PI OFF
  1584	001505'	616644	000002		TDNN P2,DEVIOS(F)	;IS THE DEVICE ACTIVE?
  1585	001506'	254000	001515'		JRST WSYNC1		;NO
  1586	001507'	436004	000002		IORM S,DEVIOS(F)	;YES, SET DEVICE IO-WAIT BIT
  1587								; AND SETUP S FOR RETURN WHEN WAIT SATISFIED
  1588	001510'	205640	000100		MOVSI P2,IOHNG		;CLEAR HUNG BIT
  1589	001511'	412644	000002		ANDCAM	P2,DEVIOS(F)
  1590	001512'	137600	001425'		DPB P1,PJBS1		;SET JOB WAIT STATE CODE
  1591								; IN JOB STATUS WORD
  1592	001513'	700600	000200		WRPI  LI.PIN		;TURN PI ON
  1593	001514'	260040	000020'		PUSHJ P,WSCHED		;CALL SCHEDULER TO FIN ANOTHER JOB TO RUN
  1594								; RETURN WHEN NEXT BUFFERFUL IS FINISHED
  1595								; WITH ACS 0-14 OCTAL RESTORED
  1596								; RETURN WHEN IO-WAIT FINISHED
  1597	001515'	700600	000200	WSYNC1:	WRPI  LI.PIN
  1598	001516'	413004	000002		ANDCAB S, DEVIOS(F)	;CLEAR DEVICE IO-WAIT BIT
  1599	001517'	627000	000100		TLZN	S,IOHNG		;DID DEVICE TIME OUT?
  1600	001520'	263040	000000		POPJ P,
  1601	001521'	412644	000002		ANDCAM P2,DEVIOS(F)	;CLEAR HUNG BIT AND
  1602	001522'	254000	000000*		JRST	ERRHDV		;CALL ERRCON TO EXIT THE JOB.
  1603
  1604	001523'	000000	000000*	CLSQUE:	EXP 	MBWQ,TIOWQ,0,IOWQ
	001524'	000000	000000*
	001525'	000000	000000
	001526'	000000	000000*
  1605
  1606	001527'	004000	000067'		$END	(CLK)

  1607	001530'	004000	000045'

  1608	001531'	401000	000000

  1609	001532'	260040	000000*

  1610	001533'	604147	602362

CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 30-2
CLOCK1.MAC	30-OCT-87 23:06		RUNCSS - RUN CONTROL(STARTING AND STOPPING OF JOBS)

  1611	001534'	000002	000000

  1612	001535'	210700	000007

  1613	001536'	350600	000007

  1614	001537'	000001	000100

  1615	001540'	251300	000000*

  1616	001541'	251300	000000*

  1617	001542'	260040	001532*

  1618	001543'	604147	724562

  1619	001544'	400001	000000

  1620	001545'	000000	000000*

  1621	001546'	251740	000017

  1622	001547'	251340	000017

  1623	001550'	251740	000017

  1624	001551'	254520	000000*

  1625	001552'	000000*	000000*

  1626	001553'	700140	000000*

  1627	001554'	000000	000000

  1628	001555'	344000	000001

  1629	001556'	016000	000001

  1630	001557'	260040	001542*

  1631	001560'	604147	634143

  1632	001561'	000002	000000

  1633	001562'	251346	000017

  1634	001563'	201300	000073

  1635	001564'	202300	000374*

  1636	001565'	200300	000105*

  1637	001566'	250300	000004'
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 30-3
CLOCK1.MAC	30-OCT-87 23:06		RUNCSS - RUN CONTROL(STARTING AND STOPPING OF JOBS)


  1638	001567'	274300	000004'

  1639	001570'	212300	000000*

  1640	001571'	254000	000376'

  1641	001572'	376000	000401*

  1642	001573'	476000	001572*

  1643	001574'	254000	000403'

  1644	001575'	301402	001116*

  1645	001576'	400020	100000

  1646	001577'	537134	467312

  1647	001600'	717114	174400

  1648	001601'	523216	571346

  1649	001602'	623037	100000

  1650	001603'	433455	162302

  1651	001604'	744000	000000

  1652	001605'	517036	472744

  1653	001606'	623037	100000

  1654	001607'	517535	662302

  1655	001610'	744000	000000

  1656	001611'	467375	662302

  1657	001612'	744000	000000

  1658	001613'	523534	571710

  1659	001614'	607620	000000

  1660	001615'	064250	464746

  1661	001616'	655016	370302

  1662	001617'	617124	064746

  1663	001620'	203314	571746

CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 30-4
CLOCK1.MAC	30-OCT-87 23:06		RUNCSS - RUN CONTROL(STARTING AND STOPPING OF JOBS)

  1664	001621'	203515	060734

  1665	001622'	201426	030100

  1666	001623'	703034	762746

  1667	001624'	064240	000000

  1668	001625'	064240	703416

  1669	001626'	423236	365500

  1670	001627'	633535	466130

  1671	001630'	203415	462702

  1672	001631'	717124	072302

  1673	001632'	657124	061736

  1674	001633'	713454	561750

  1675	001634'	647554	520302

  1676	001635'	617515	167734

  1677	001636'	064240	000000

  1678	001637'	000001	600000

  1679	001640'	064240	100402

  1680	001641'	004020	700402

  1681	001642'	004020	103402

  1682	001643'	004020	100416

  1683	001644'	517636	372312

  1684	001645'	665012	547246

  1685	001646'	442532	420356

  1686	001647'	647515	067752

  1687	001650'	721014	161706

  1688	001651'	677535	672322

  1689	001652'	673165	606424

  1690	001653'	004020	100402
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 30-5
CLOCK1.MAC	30-OCT-87 23:06		RUNCSS - RUN CONTROL(STARTING AND STOPPING OF JOBS)


  1691	001654'	034020	100402

  1692	001655'	004171	467716

  1693	001656'	203235	620350

  1694	001657'	675004	747640

  1695	001660'	426444	720302

  1696	001661'	673104	023644

  1697	001662'	202071	045640

  1698	001663'	472504	706424

  1699	001664'	000000	000000

  1700	001665'	552400	000651*

  1701	001666'	201300	001640'

  1702	001667'	260040	001173*

  1703	001670'	201340	000040

  1704	001671'	436340	000653*

  1705	001672'	254000	000664'

  1706	001673'	135300	000754*

  1707	001674'	322300	000762'

  1708	001675'	263040	000000

  1709	001676'	202300	000000*

  1710	001677'	020770	040000

  1711	001700'	211400	000006

  1712	001701'	211407	000000

  1713	001702'	260040	001557*

  1714	001703'	435453	566361

  1715	001704'	000002	000000

  1716						;End of CLOCK1 (CLKLIT: CLKEND:)
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-8830-6
CLOCK1.MAC	30-OCT-87 23:06		RUNCSS - RUN CONTROL(STARTING AND STOPPING OF JOBS)

CLOCK1.MAC	30-OCT-87 23:06		C
NO ERRORS DETECTED
PROGRAM BREAK IS 001705
8K CORE USED
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 31
CLOCK1.MAC	30-OCT-87 23:06		SYMBOL TABLE

ABKSET		000273'	INT	CLKNEW		000006'	INT	FATMSG		000665'		JBTINA		001115'	EXT
ACTDDB		000637'	EXT	CLKNSQ		001433'	INT	FCONRQ		000454'	EXT	JBTINT		001102'	EXT
ACTDED		000654'	EXT	CLKSAV		000003'		FCWAIT		001413'	INT	JBTKCT		001153'	EXT
ACWAIT		001413'	INT	CLKTRU		000215'	EXT	FIXWEK		000470'	INT	JBTLIC		001135'	EXT
ADJUDT		000202'	EXT	CLKUSM		000056'		FIXWK0		000506'		JBTLIM		001130'	EXT
ALR620		001671'	EXT	CLOCK		000005'	INT	FRMDSN		001065'	EXT	JBTMPC		001122'	EXT
ALRACT		000040	SIN	CLOCK1		000000'	ENT	GETSIZ		000741'	INT	JBTNM1		001157'	EXT
APR		000000	SPD	CLRINT		001261'	EXT	GMTDIF		000502'	EXT	JBTNM2		001160'	EXT
AVALTB		001331'	EXT	CLRJBT		001102'	INT	GTCGS1		000762'		JBTPC		001165'	EXT
AXWAIT		001413'	INT	CLSQUE		001523'		GTCGSZ		000747'	INT	JBTPNO		001120'	EXT
BGBENF		000612'	EXT	CMWB		200000	SIN	HANGRB		000136'	EXT	JBTPPN		001152'	EXT
BIGBEN		000556'	INT	CNTRLC		000400	SIN	HIGHJB		001100'	EXT	JBTPRV		001226'	EXT
BPWAIT		001413'	INT	CNTTAB		001417'	EXT	HNGMIN		001564'	EXT	JBTPWH		001105'	EXT
CAWAIT		001413'	INT	COMCNT		000205'	EXT	HNGMON		000443'	EXT	JBTPWL		001106'	EXT
CBCONT		001323'	EXT	COMMAN		000206'	EXT	HNGTIM		000362'	EXT	JBTPWS		001121'	EXT
CBJERR		001207'	EXT	CONFIG		000575'	EXT	HOLD		001174'	INT	JBTRCT		001155'	EXT
CBWAIT		001413'	INT	CONMES		001667'	EXT	HOLD0		001167'	INT	JBTS2P		001111'	EXT
CHGCK1		001361'		CPOPJ		001201'	EXT	HOLD1		001170'	INT	JBTSER		001147'	EXT
CHGCLK		001356'	INT	CPUF3		000004	SPD	HOUR		000464'	INT	JBTSIN		001146'	EXT
CHGON		010000	SIN	CPUKI		000001	SPD	ILWQ		001322'	EXT	JBTSLC		001113'	EXT
CHKMTM		001054'		CPUKL		000002	SPD	INACT1		000446'		JBTSLK		001150'	EXT
CIP2		000132'		CPUKS		000003	SPD	INAHIT		000417'	EXT	JBTSLM		001114'	EXT
CIP2A		000142'		CPUTYP		000002	SPD	INCTIM		000104'		JBTSOK		001126'	EXT
CIP4		000143'		CPZZ		000000	SPD	INCTM1		000115'		JBTSOT		001145'	EXT
CIP4M		000170'		CRLF		001167'	EXT	INCTM2		000123'		JBTSPN		001110'	EXT
CIP4S		000164'		CTYBLF		001665'	EXT	INLMES		000614'	EXT	JBTST2		001164'	EXT
CIP4S1		000166'		CURUPT		000267'	EXT	INTERM		000135'	EXT	JBTSTA		001112'	EXT
CIP4T		000147'		DADD	114000	000000		INTKI0		000432'		JBTSTS		001455'	EXT
CIP5		000200'		DATCOM		000533'	EXT	INTKIL		000440'		JBTUID		001117'	EXT
CIP5A		000202'		DATE		000501'	EXT	IOACT		010000	SIN	JBTUN1		001134'	EXT
CIP5B		000231'		DAWAIT		001413'	INT	IOHNG		000100	SIN	JBTUNM		001133'	EXT
CIP6		000232'	INT	DAY		000467'	INT	IOW		000001	SIN	JBTUPM		001163'	EXT
CIP6C		000255'		DBLMSG		000703'	INT	IOWQ		001526'	EXT	JBTWCH		001162'	EXT
CIP6D		000343'		DDBLDB		000732'	EXT	ITMCHN		000000	EXT	JBTWCT		001156'	EXT
CIP6E		000253'		DECHJB		001072'	INT	J		000002	INT	JBYINA		000412'	EXT
CIP7		000263'		DECSCC		000175'	EXT	JACCT		000001	SIN	JBYLIM		000224'	EXT
CIP7A		000312'		DEVCHK		000370'	EXT	JACCT2		100000	SIN	JBYMCY		001062'	EXT
CIP7B		000324'		DEVIOS		000002	SIN	JBTAJF		001107'	EXT	JBYNIC		000422'	EXT
CIP8		000317'		DEVSTS		000012	SIN	JBTAUN		001161'	EXT	JBYNTQ		000434'	EXT
CIP9		000324'		DEYCLS		001500'	EXT	JBTBCS		001140'	EXT	JBYQNT		001335'	EXT
CIPWTM		001361'	EXT	DIE		001702'	EXT	JBTBET		001125'	EXT	JBYSC3		001673'	EXT
CLKADD		001401'		DLYCOM		001237'	INT	JBTBIO		001124'	EXT	JBYSC4		000747'	EXT
CLKBIT		001467'	EXT	DTMADJ		000460'	EXT	JBTCIN		001144'	EXT	JBYUWS		000762'	EXT
CLKCHL		000062'	EXT	DVWAIT		001413'		JBTCMP		001136'	EXT	JDCON		020000	SIN
CLKDEL		001373'		DWNFLG		000132'	EXT	JBTCNK		001141'	EXT	JERR		020000	SIN
CLKDSP		000174'		EPLLEN		000000	EXT	JBTCOT		001143'	EXT	JFYHR		000547'	EXT
CLKEND		001704'	INT	EPT		000000	EXT	JBTCP2		001123'	EXT	JFYMIN		000551'	EXT
CLKEXM		000064'		ERRHDV		001522'	EXT	JBTCPU		001137'	EXT	JFYSEC		000716'	EXT
CLKFLG		001461'	EXT	ERRTLE		000231'	EXT	JBTDLK		001151'	EXT	JLOG		000004	SIN
CLKINI		000007'	INT	ESTOP		001201'	INT	JBTELP		001142'	EXT	JNA		040000	SIN
CLKINT		000032'	INT	EX0ACB		000001	SIN	JBTERN		001127'	EXT	JOB		001502'	EXT
CLKJOB		001410'	INT	F		000004	INT	JBTFNT		001103'	EXT	JOBN		000000	EXT
CLKLIT		001527'	INT	FATMSG		000665'		JBTFPN		001131'	EXT	JOBOPC		001676'	EXT
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 31-2
CLOCK1.MAC	30-OCT-87 23:06		SYMBOL TABLE

JRQ		000002	SIN	NXTJOB		000232'	EXT	RUN		400000	SIN	THSDAT		000530'	EXT
JWPOS		000016	SIN	NXTSEC		000736'		S		000000	INT	TIMADJ		000766'	INT
JWSIZ		000005	SIN	OPRDTM		000122'	EXT	S$ENTR	777777	777775	SIN	TIME		000527'	EXT
KJP		000100	SIN	OPROUT		000705'	EXT	S$EVEN		000006	SIN	TIMEF		000234'	EXT
KJSTOP		001176'	INT	P		000001	INT	S$HALT	777777	777777	SIN	TIMPCD		000210'	EXT
KSTOP		001065'	INT	P1		000014	INT	S$INFO		000005	SIN	TIMRST		001412'	INT
KSYS		001573'	EXT	P2		000015	INT	S$JOB		000002	SIN	TIMSET		001411'	INT
LG.LAB	400000	000000	SPD	P3		000016	INT	S$NAME		000000'	SPD	TIMWAK		000176'	EXT
LG.LUB	100000	000000	SPD	P4		000017	INT	S$NONA		000000	SIN	TIOWQ		001524'	EXT
LG.PAC	000700	000000	SPD	PAG		000010	SPD	S$PATC		000007	SIN	TPOPJ		001471'	EXT
LI.PIF		000400	SPD	PAGP3R		000070'	INT	S$STOP		000001	SIN	TRHALT		000013'	EXT
LI.PIN		000200	SPD	PAGSAC		000351'	INT	S$TEMP	777776	000000	SPD	TSAVAL		001435'	EXT
LOCDAY		000556'	EXT	PAGZER		000265'	INT	S$XCT	777777	777776	SIN	TSQ		001434'	EXT
LOCHOR		000566'	EXT	PC.PUB		002000	SIN	SATWRT		000140'	EXT	TTKJOB		001227'	EXT
LOCMIN		000570'	EXT	PC.UIO		004000	SIN	SAVPC		000045'		TTSCLR		001347'	EXT
LOCMON		000544'	EXT	PC.USR		010000	SIN	SAVUPT		000740'		TTYSET		001307'	EXT
LOCSEC		000554'	EXT	PCDCNT		000207'	EXT	SCHEDF		001235'	EXT	TTYSTC		001175'	EXT
LOCTIM		000600'	EXT	PHOLD		001173'	INT	SCNINT		000211'	EXT	TTYTAB		000730'	EXT
LOCWEK		000525'	EXT	PI		000004	SPD	SCNSEC		000373'	EXT	TYCIOS		001320'	EXT
LOCYER		000546'	EXT	PICLK		001462'	EXT	SECOND		000356'	INT	U		000005	INT
LSTWRD		000102'	EXT	PJBS1		001425'		SECTIM		000721'		UDTFIX		000520'	INT
M2WAIT		001413'	INT	PJBS2		001427'		SETID1		001445'		UNISEC		000366'	EXT
MAGIC		001001'		PJBS3		001426'		SETIOD		001437'	INT	UPELP		000710'	
MAGIC1		000777'		PJBSTS		001354'	EXT	SETR1		001332'		UPSCLK		001314'	EXT
MAPUPS		001274'	EXT	PJOBN		001437'	EXT	SETR2		001334'	INT	UPT		000000	EXT
MAXQ		001324'	EXT	PJOBX		000660'	EXT	SETRUN		001321'	INT	UPTABK		000000	EXT
MBWQ		001523'	EXT	PJRST	324740	000000		SETSLP		001344'	INT	UPTACP		000000	EXT
MIDNIT		000127'	EXT	POTLST		000103'	EXT	SETSTT		001421'		UPTHEC		000504	SIN
MINUT1		000412'		PRNAME		000622'	EXT	SIWAIT		001413'	INT	UPTHMC		000506	SIN
MINUT2		000456'		PRRSP1		001174'	EXT	SKDCOM		000662'	EXT	UPTIME		000711'	EXT
MINUTE		000401'	INT	PRRSP3		001170'	EXT	SLPQ		001351'	EXT	UPTJOB		000000	EXT
MO.AEN		020000	SPD	PRSPC		000577'	EXT	STATES		000643'	EXT	UPTLDC		000000	EXT
MO.AO		010000	SPD	PRTDEC		000613'	EXT	STAUTO	000001	000000	SIN	UPTLEC		000505	SIN
MO.LAC		400000	SPD	PRTJOB		001545'	EXT	STOP1		001210'	INT	UPTLMC		000507	SIN
MO.TON		002000	SPD	PRWAIT		001413'	INT	STOP1A		001225'		UPTMTM		000000	EXT
MONHNG		000177'	EXT	PSWAIT		001413'	INT	STOP2		001460'		UPTPC		000000	EXT
MONJBX		001251'	INT	PX.MEM		000004	SPD	STOP3		001466'		UPTPDL		000000	EXT
MONJOB		001247'	INT	PX.SRC		000001	SPD	STPFLG		000236'	EXT	UPTSTS		000000	EXT
MONSTR		001253'	INT	PXCT	256000	000000		STRDDB		000627'	EXT	UPTUAC		000000	EXT
MSTART		001274'	INT	QJOB		001454'	EXT	STRNAM		000621'	EXT	UPTXAC		000000	EXT
MTR		000024	SPD	RDEACT	702440	000000		STRTAL		000630'	EXT	USCHD1		000012'	INT
MTWAIT		001413'	INT	RDMACT	702400	000000		STSHUT		400000	SIN	USCHED		000014'	INT
MXSTRT		001310'		RDPI	700640	000000		STSUPR		200000	SIN	USRACB		000000	SIN
NOCORQ		001244'	INT	RELEA9		000000	EXT	STTIOD		001430'	INT	USRCLK		000201'	EXT
NODIE		000000	EXT	REQTAB		001416'	EXT	SWPSEC		000367'	EXT	USRXIT		001273'	EXT
NULJB		000332'		REQUE		001336'	INT	SWQ		001441'	EXT	USRXT7		000331'	EXT
NULJOB		000263'	INT	RIWAIT		001413'	INT	SYSUPT		000124'	EXT	USTART		001262'	INT
NULMNT		001570'	EXT	RNQ		001353'	EXT	T1		000006	INT	USTRT1		001266'	
NULPDL		000064'	EXT	RNQUNT		001334'	EXT	T2		000007	INT	UTRP		040000	SIN
NULQ		001244'	EXT	RPTSAT		000410'	EXT	T3		000010	INT	WAIT1		001472'	INT
NULSAV		000004'		RSCH1		000075'		T4		000011	INT	WAKE		001346'	INT
NULTAJ		001051'		RSCHED		000067'		TAKDWN		000141'	EXT	WDOG		000624'	
NULTIM		001565'	EXT	RTIME		001104'	EXT	TAKTRP		001063'	EXT	WDOG0		000630'	
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88 PAGE 31-3
CLOCK1.MAC	30-OCT-87 23:06		SYMBOL TABLE

WDOG1		000637'		
WDOG2		000664'		
WEKDAY		000511'		
WRADB	700140	000000		
WRPI	700600	000000		
WRSMAP		001336'	EXT	
WRSMP1		001450'	EXT	
WRUBR	701140	000000		
WSAVAL		001444'	EXT	
WSCHD1		000021'		
WSCHD2		000024'		
WSCHED		000020'	INT	
WSQ		001443'	EXT	
WSYNC		001477'	INT	
WSYNC1		001515'		
WTMASK		000370	SIN	
ZZ	005557	664555	SPD	
%UPS		000000	EXT	
%UPT		000000	EXT	
%UPX		000000	EXT	
.SLDSC		000001	SIN	
.SLHNG		000003	SIN	

CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88
Symbol cross reference

ABKSET	   353#	   446
ACTDDB	   768%	   768
ACTDED	   790%	   790
ACWAIT	  1460#
ADJUDT	   274%	   274
ALR620	   780%	   780	   789%	   789
ALRACT	   779	   788
APR	   447	   448
AVALTB	  1206%	  1219	  1220	  1364	  1365
AXWAIT	  1459#
BGBENF	   542	   544	   689%	   689	   694%	   694	   699%	   699	   712%	   712	   715%	   715
BIGBEN	   546	   686#
BPWAIT	  1459#
CAWAIT	  1459#
CBCONT	  1355%	  1359
CBJERR	  1196%	  1196
CBWAIT	  1459#
CHGCK1	  1408#	  1412
CHGCLK	  1405#
CHGON	   334	   414	  1003
CHKMTM	  1017	  1049#
CIP2	   204	   208	   220#
CIP2A	   222	   225	   229#
CIP4	   230#	   235	   246	   253
CIP4M	   251	   255#
CIP4S	   233	   250#
CIP4S1	   252#	   258
CIP4T	   234#	   257
CIP5	   231	   269#
CIP5A	   274#
CIP5B	   296	   301#
CIP6	   170	   286	   289	   293	   299	   302	   305#
CIP6C	   319	   330#
CIP6D	   325	   491#
CIP6E	   326#	   502
CIP7	   320	   340#
CIP7A	   371	   378	   382#
CIP7B	   417	   424#
CIP8	   311	   412#
CIP9	   404	   413	   425	   426#
CIPWTM	    24%	    30	    72	   230	  1408
CLKADD	  1409	  1426#
CLKBIT	   126%	   126	  1542
CLKCHL	   129%	   129	   133%	   133	   134%	   134	   142%	   142	   148%	   148	   152%	   152
CLKDEL	  1415	  1419#
CLKDSP	   244	   260#
CLKEND	  1716#
CLKEXM	   146	   155#
CLKFLG	   127%	   127	   306%	   306	  1534%	  1534
CLKINI	    72#
CLKINT	   124#	   128
CLKJOB	  1434#
CLKLIT	  1606#
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88
Symbol cross reference

CLKNEW	    31#
CLKNSQ	  1498#	  1507
CLKSAV	    28#	   113	   138	   330	   412
CLKTRU	   287%	   287
CLKUSM	   141	   148#
CLOCK	    30#	    73	   229	   237	   238	  1407	  1420	  1421	  1430
CLOCK1	    11	    12#	    15
CLRINT	  1288	  1304%
CLRJBT	  1079	  1096#
CLSQUE	  1579	  1604#
CMWB	  1087	  1238
CNTRLC	    86	  1212	  1327	  1343
CNTTAB	  1465%	  1465
COMCNT	   277%	   277
COMMAN	   278%	   278
CONFIG	   703%	   703
CONMES	   704%	   704	   765%	   765	   778%	   778	   793%	   793	   811%	   811	  1171%	  1171
CPOPJ	  1189%	  1189
CPUF3	   352	   445	   453	   457	   463	   975
CPUKI	   149	   322	   346	   359	   368	   383	   450	   483	   487	   889	   968
CPUKL	   352	   445	   979
CPUKS	   156	   355	   393	   394	   402	   403	   405	   415	   416	   418	   438	   439	   520	   930
	   994
CPUTYP	   149	   156	   322	   346	   352	   355	   359	   368	   383	   393	   394	   402	   403	   405
	   415	   416	   418	   438	   439	   445	   450	   453	   457	   463	   483	   487	   520	   889
	   930	   968	   975	   979	   994
CPZZ	   149#	   149	   156#	   156	   322#	   322	   346#	   346	   352#	   352	   355#	   355	   359#	   359
	   368#	   368	   383#	   383	   393#	   393	   394#	   394	   402#	   402	   403#	   403	   405#	   405
	   415#	   415	   416#	   416	   418#	   418	   438#	   438	   439#	   439	   445#	   445	   450#	   450
	   453#	   453	   457#	   457	   463#	   463	   483#	   483	   487#	   487	   520#	   520	   889#	   889
	   930#	   930	   968#	   968	   975#	   975	   979#	   979	   994#	   994
CRLF	   722%	   722	  1161	  1176%
CTYBLF	   518%	   518	   519%	   519	   773%	   773	   787%	   787
CURUPT	    22%	   347
DATCOM	   623%	   623	   663%	   663
DATE	   626%	   626
DAWAIT	  1458#
DAY	   605	   609#
DBLMSG	   807#
DDBLDB	   833	   842%
DECHJB	  1080	  1085#
DECSCC	   263%	   263
DEVCHK	   517%	   517
DEVIOS	  1561	  1584	  1586	  1589	  1598	  1601
DEVSTS	   791
DEYCLS	  1575%	  1578
DIE	    11	    11%	    12	   163	   342	   497	  1498
DLYCOM	  1238#
DTMADJ	   184%	   184	   188%	   188	   196%	   196	   592%	   592
DVWAIT	  1461#
DWNFLG	   220%	   220
EPLLEN	   431	  1206%	  1281
EPT	    22%
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88
Symbol cross reference

ERRHDV	  1575%	  1602
ERRTLE	    26%	   301
ESTOP	  1081	  1189#
EX0ACB	   149	   349
F	   768	   791	  1561	  1584	  1586	  1589	  1598	  1601
FATMSG	   792	   800#
FCONRQ	   587	  1157%
FCWAIT	  1460#
FIXWEK	   593	   602	   617#	   658
FIXWK0	   624	   631#
FRMDSN	  1077%	  1077
GETSIZ	   846#
GINST	   329#	   329	   330	   367#	   367	   368	   375#	   375	   376	   499#	   499	   500	  1312#	  1312
	  1313
GMTDIF	   627%	   627
GTCGS1	   870	   874	   882#
GTCGSZ	   827	   867#	  1018
HANGRB	   224%	   224
HIGHJB	   221%	   221	   551	   815	  1085%	  1085	  1092%	  1092
HNGMIN	   256%	   256	   524%	   524	   526%	   526
HNGMON	   578%	   578
HNGTIM	   250%	   250	   275%	   275	   510%	   510
HOLD	  1172	  1178#
HOLD0	  1161#
HOLD1	  1162#
HOUR	   596	   602#
ILWQ	  1355%	  1358
INACT1	   553	   556	   558	   567	   574	   581#
INAHIT	   557%	   557
INCTIM	   176	   179#
INCTM1	   186	   192#
INCTM2	   185	   190	   194	   201#
INLMES	   707%	   707	   717%	   717
INTERM	   223%	   223
INTKI0	   561	   569#
INTKIL	   570	   572	   575#
IOACT	  1562	  1582
IOHNG	  1588	  1599
IOW	  1577
IOWQ	  1575%	  1604
ITMCHN	   115	   115%	   393	   402	   415	   438	   967	  1004
J	   116	   151	   152	   153	   165	   167	   174	   179	   269	   284	   285	   288	   291	   297
	   310	   312	   313	   315	   340	   344	   348	   551	   554	   559	   562	   563	   564	   566
	   569	   575	   576	   580	   581	   582	   586	   589	   619	   621	   632	   655	   661	   666
	   769	   773	   782	   783	   815	   824	   829	   831	   835	   837	   962	  1005	  1012	  1014
	  1015	  1031	  1034	  1035	  1085	  1089	  1097	  1098	  1099	  1100	  1101	  1102	  1103	  1104
	  1105	  1106	  1108	  1109	  1110	  1111	  1112	  1113	  1114	  1115	  1116	  1117	  1118	  1119
	  1120	  1121	  1122	  1123	  1124	  1125	  1127	  1128	  1129	  1130	  1131	  1132	  1133	  1134
	  1135	  1136	  1137	  1138	  1140	  1142	  1143	  1144	  1145	  1146	  1147	  1148	  1149	  1150
	  1151	  1154	  1181	  1189	  1192	  1195	  1210	  1213	  1222	  1224	  1226	  1239	  1241	  1280
	  1328	  1344	  1369	  1378	  1380	  1391	  1517	  1518	  1520
JACCT	   290	  1190
JACCT2	  1191
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88
Symbol cross reference

JBTAJF	  1102%	  1102
JBTAUN	  1122%	  1122	  1148%	  1148
JBTBCS	  1129%	  1129
JBTBET	  1117%	  1117
JBTBIO	  1116%	  1116
JBTCIN	  1133%	  1133
JBTCMP	  1007	  1010	  1012	  1015	  1040%	  1127%	  1127
JBTCNK	   835	   836	   842%	  1130%	  1130
JBTCOT	  1132%	  1132
JBTCP2	  1009	  1014	  1040%	  1115%	  1115
JBTCPU	  1027	  1035	  1040%	  1128%	  1128
JBTDLK	  1138%	  1138
JBTELP	   829	   830	   842%	  1131%	  1131
JBTERN	  1119%	  1119
JBTFNT	  1098%	  1098
JBTFPN	  1121%	  1121
JBTFTR	   563	  1110%	  1110
JBTINA	   554%	   554	   559%	   559	   581	  1109%	  1109
JBTINT	  1097%	  1097
JBTKCT	  1023	  1026	  1031	  1034	  1040%	  1142%	  1142
JBTLIC	  1125%	  1125
JBTLIM	   167	   285	   288	   297	  1120%	  1120
JBTMPC	  1114%	  1114
JBTNM1	  1146%	  1146
JBTNM2	  1147%	  1147
JBTPC	   153%	   153	  1154%	  1154
JBTPNO	  1112%	  1112
JBTPPN	  1140%	  1140
JBTPRV	  1143%	  1143	  1222
JBTPWH	  1100%	  1100
JBTPWL	  1101%	  1101
JBTPWS	  1113%	  1113
JBTRCT	  1144%	  1144
JBTS2P	  1104%	  1104
JBTSER	  1136%	  1136
JBTSIN	  1135%	  1135
JBTSLC	  1106%	  1106
JBTSLK	  1137%	  1137
JBTSLM	  1108%	  1108
JBTSOK	  1118%	  1118
JBTSOT	  1134%	  1134
JBTSPN	  1103%	  1103
JBTST2	  1151%	  1151
JBTSTA	  1105%	  1105
JBTSTS	   291%	   291	   569%	   569	   582%	   582	   783%	   783	   824%	   824	  1090%	  1090	  1181%	  1181
	  1192%	  1192	  1195	  1210	  1213	  1226	  1239	  1241	  1328	  1344	  1369	  1378	  1380	  1474
	  1476	  1493	  1522	  1524
JBTUID	  1111%	  1111
JBTUN1	  1124%	  1124
JBTUNM	  1123%	  1123
JBTUPM	    21%	   340	  1150%	  1150
JBTWCH	  1149%	  1149
JBTWCT	  1145%	  1145
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88
Symbol cross reference

JBYINA	   552%	   552
JBYLIM	   295%	   295
JBYMCY	  1055%	  1055
JBYNIC	   560%	   560
JBYNTQ	   571%	   571
JBYQNT	  1355%	  1371
JBYSC3	   865%	   869	   875
JBYSC4	   865%	   867
JBYUWS	    21%	   848	   882
JDCON	   584
JERR	   583	   784	  1194	  1227	  1327	  1343
JFYHR	   675%	   675
JFYMIN	   677%	   677
JFYSEC	   507%	   507	   509%	   509	   679%	   679	   818%	   818	   821%	   821
JLOG	  1180
JNA	   825	  1087
JOB	   116	   151	   158%	   158	   165%	   165	   174%	   174	   269%	   269	   284	   310	   313	   318
	   344	   962	  1224	  1280	  1467	  1525	  1581
JOBN	  1157%
JOBOPC	    25%	  1312
JRQ	  1087	  1377	  1521
JWPOS	  1474	  1476	  1493
JWSIZ	  1474	  1476	  1493
KJP	   290
KJSTOP	  1180#
KSTOP	  1077#
KSYS	   538%	   538	   539%	   539	   540%	   540
LG.LAB	   149	   349	   451
LG.LUB	   349	   451
LG.PAC	   324	   370	   379	   500
LI.PIF	   236	  1209	  1419	  1429	  1533	  1583
LI.PIN	   240	  1214	  1221	  1423	  1431	  1592	  1597
LISTSN	     3	     6
LOCDAY	   652%	   652	   669%	   669	   686%	   686
LOCHOR	   603%	   603	   676%	   676	   695%	   695
LOCMIN	   594%	   594	   678%	   678	   697%	   697
LOCMON	   672%	   672
LOCSEC	   512%	   512	   533%	   533	   680%	   680
LOCTIM	   706%	   706
LOCWEK	   630%	   630	   657%	   657
LOCYER	   674%	   674
LSTWRD	   177%	   177
M2WAIT	  1459#
MAGIC	   985#
MAGIC1	   983#
MAPUPS	  1303%	  1319
MAXQ	  1206%	  1216	  1360
MBWQ	  1575%	  1604
MIDNIT	   203%	   203	   205%	   205
MINUT1	   552#	   589
MINUT2	   585	   589#
MINUTE	   535	   538#
MO.AEN	   402	   415	   438	  1004
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88
Symbol cross reference

MO.AO	   402	   415	   438	  1004
MO.LAC	   115	   393	   402	   415	   438	   967	  1004
MO.TON	   402	   415	   438	  1004
MONHNG	   265%	   265
MONJBX	  1269#
MONJOB	  1259#
MONSTR	  1280#
MSTART	  1259	  1319#
MTR	   113	   115	   331	   393	   402	   415	   438	   966	   967	  1004
MTWAIT	  1458#
MXSTRT	  1269	  1337#
NOCORQ	  1246#
NODIE	    11%
NULJB	   348	   437#
NULJOB	   339#
NULMNT	   530%	   530
NULPDL	   111%	   111	   155%	   155
NULQ	  1246%	  1246
NULSAV	    29#	   528	   529
NULTAJ	  1005	  1036#
NULTIM	   180%	   180	   527%	   527
NXTJOB	   305%	   305
NXTSEC	   826	   832	   834	   837#
OPRDTM	   189%	   189	   197%	   197
OPROUT	   702%	   702	   749%	   749	   809%	   809
P	    12	    74	    87	    93	    94	   105	   111	   117	   155	   163	   168	   189	   197	   224
	   243	   244	   245	   270	   274	   276	   278	   280	   281	   287	   298	   301	   305	   312
	   314	   315	   342	   431	   497	   512	   513	   514	   515	   516	   517	   523	   532	   534
	   546	   547	   562	   565	   566	   573	   575	   578	   580	   587	   591	   593	   595	   602
	   604	   610	   619	   620	   623	   631	   632	   633	   654	   655	   656	   658	   663	   665
	   666	   681	   687	   702	   704	   705	   706	   707	   716	   717	   720	   749	   765	   778
	   793	   794	   796	   798	   809	   817	   819	   822	   827	   838	   846	   847	   850	   851
	   871	   872	   873	   874	   877	   879	   880	   885	   963	   964	   965	   980	   992	  1006
	  1011	  1016	  1017	  1018	  1019	  1020	  1022	  1028	  1029	  1036	  1037	  1038	  1050	  1053
	  1056	  1057	  1077	  1079	  1080	  1086	  1093	  1155	  1161	  1162	  1163	  1171	  1178	  1179
	  1182	  1196	  1223	  1240	  1259	  1269	  1281	  1282	  1286	  1287	  1316	  1319	  1329	  1359
	  1376	  1381	  1392	  1395	  1406	  1413	  1417	  1424	  1426	  1428	  1432	  1462	  1498	  1517
	  1519	  1520	  1526	  1539	  1540	  1563	  1564	  1593	  1600
P1	  1579	  1590
P2	  1582	  1584	  1588	  1589	  1601
P3	  1474	  1578	  1579	  1581
P4	   620	   622	   631	   656	   662	   665
PAG	   149
PAGP3R	   163#
PAGSAC	   497#
PAGZER	   342#
PC.PUB	   461	  1283	  1314
PC.UIO	   118	   132	   377	   461	   492	  1315	  1320	  1337
PC.USR	   130	   140	   428	   461	  1283	  1306	  1314
PCDCNT	   279%	   279
PHOLD	  1171#
PI	  1538
PICLK	  1536%	  1536
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88
Symbol cross reference

PJBS1	  1474#	  1590
PJBS2	  1493#	  1496	  1505	  1515
PJBS3	  1468	  1476#
PJBSTS	  1206%	  1215	  1247	  1357	  1393	  1397
PJOBN	   769%	   769	  1495%	  1495	  1504%	  1504
PJOBX	   794%	   794
POTLST	   175%	   175	   178%	   178
PRNAME	   720%	   720
PRRSP1	  1176%	  1178
PRRSP3	  1162	  1176%
PRSPC	   705%	   705
PRTDEC	   716%	   716
PRTJOB	   342%	   342
PRWAIT	  1458#
PSWAIT	  1458#
PX.MEM	   329	   367	   375	   499	  1312
PX.SRC	   329	   499
QJOB	  1373%	  1379	  1523
RELEA9	    21%
REQTAB	  1206%	  1217	  1362	  1464
REQUE	  1225	  1242	  1248	  1376#
RIWAIT	  1458#
RNQ	  1396%	  1396
RNQUNT	  1355%	  1370
RPTSAT	   547%	   547
RSCH1	   166	   169#
RSCHED	   118	   159	   162#
RTIME	  1099%	  1099
RUN	  1208	  1368
S	  1561	  1562	  1577	  1586	  1598	  1599
S$ENTR	    11	    17	   164	   343	   498	  1499	  1507
S$EVEN	   163	   342	   497	  1498
S$HALT	    11	   163	   342	   497	  1498	  1507
S$INFO	   163	   342	   497	  1498
S$JOB	   163	   164	   497	   498	  1498	  1499
S$NAME	    15#
S$NONA	    14	    17	   164	   343	   498	  1499	  1508
S$PATC	   163	   342	   497	  1498
S$STOP	   342	   343
S$TEMP	    11#	    11	   163#	   163	   342#	   342	   497#	   497	  1498#	  1498	  1507#	  1507
S$XCT	    17	   164	   343	   498	  1499	  1507	  1508
SATWRT	   226%	   226
SAVPC	   132	   138#
SAVUPT	   820	   840#
SCHEDF	   131%	   131	   308%	   308	  1229%	  1229
SCNINT	   281%	   281
SCNSEC	   523%	   523
SECOND	   276	   506#
SECTIM	   824#	   837
SETID1	  1502	  1514#
SETIOD	  1504#
SETR1	  1361	  1363	  1368#
SETR2	  1370#	  1399
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88
Symbol cross reference

SETRUN	  1260	  1270	  1357#
SETSLP	  1385#
SETSTT	  1386	  1467#
SIWAIT	  1458#
SKDCOM	   796%	   796
SLPQ	  1385%	  1385	  1394%	  1394
STATES	   772%	   772
STAUTO	   771
STOP1	  1164	  1208#
STOP1A	  1211	  1218	  1221#
STOP2	  1228	  1230	  1533#
STOP3	  1541#	  1543
STPFLG	    95%	    95	   150%	   150	   292%	   292	   309%	   309
STRDDB	   710%	   710	   751%	   751
STRNAM	   719%	   719
STRTAL	   711%	   711	   752%	   752
STSHUT	   771	   795
STSUPR	   771
STTIOD	  1495#
SWPSEC	   516%	   516
SWQ	  1497%	  1497	  1506%	  1506
SYSUPT	   202%	   202
T1	    72	    73	    86	   184	   186	   192	   193	   237	   239	   241	   288	   290	   291	   295
	   296	   323	   324	   328	   329	   330	   331	   334	   340	   341	   347	   349	   350	   369
	   370	   372	   373	   374	   379	   380	   400	   401	   412	   414	   451	   452	   493	   494
	   495	   496	   499	   500	   501	   506	   507	   508	   509	   510	   525	   526	   527	   528
	   529	   530	   532	   533	   542	   543	   545	   554	   555	   557	   559	   560	   561	   571
	   572	   576	   577	   582	   583	   584	   586	   617	   625	   628	   629	   630	   659	   664
	   675	   676	   689	   690	   691	   692	   693	   694	   698	   701	   703	   711	   714	   748
	   751	   752	   758	   762	   774	   783	   784	   792	   807	   808	   810	   816	   817	   818
	   819	   820	   821	   823	   824	   825	   828	   829	   830	   831	   832	   833	   834	   867
	   869	   870	   873	   876	   878	   882	   883	   884	   964	   981	   982	   983	   984	   985
	   991	  1006	  1007	  1008	  1010	  1011	  1012	  1013	  1015	  1019	  1021	  1022	  1025	  1027
	  1028	  1030	  1033	  1035	  1037	  1055	  1089	  1090	  1091	  1092	  1180	  1181	  1190	  1191
	  1192	  1194	  1195	  1208	  1210	  1212	  1213	  1215	  1216	  1217	  1219	  1220	  1226	  1227
	  1238	  1239	  1241	  1246	  1247	  1287	  1306	  1308	  1309	  1312	  1313	  1322	  1323	  1324
	  1325	  1326	  1327	  1328	  1339	  1340	  1341	  1342	  1343	  1344	  1357	  1358	  1360	  1362
	  1364	  1365	  1368	  1369	  1370	  1371	  1377	  1378	  1380	  1391	  1393	  1394	  1405	  1406
	  1410	  1411	  1413	  1414	  1416	  1420	  1422	  1426	  1427	  1430	  1434	  1493	  1495	  1504
	  1518	  1522	  1524	  1540	  1541	  1542
T2	   201	   202	   203	   205	   206	   232	   234	   241	   242	   244	   255	   318	   320	   332
	   333	   335	   374	   375	   376	   377	   446	   447	   491	   492	   495	   499	   508	   544
	   545	   618	   625	   626	   627	   629	   660	   664	   667	   670	   673	   674	   677	   678
	   695	   696	   697	   698	   712	   713	   715	   719	   750	   752	   756	   761	   771	   772
	   779	   780	   788	   789	   790	   791	   795	   822	   823	   828	   835	   836	   846	   847
	   848	   849	   850	   872	   875	   876	   877	   878	   879	   965	   966	   980	   991	   992
	  1003	  1016	  1020	  1021	  1023	  1024	  1026	  1029	  1030	  1031	  1032	  1034	  1036	  1051
	  1087	  1090	  1283	  1286	  1313	  1314	  1315	  1316	  1320	  1321	  1337	  1338	  1396	  1397
	  1407	  1408	  1410	  1412	  1416	  1422	  1496	  1497	  1500	  1505	  1506	  1509	  1515	  1521
	  1522	  1524
T3	   427	   428	   552	   553	   555	   668	   669	   671	   672	   679	   680	   699	   770	   773
	   787	  1405	  1411
T4	   710	   711	   719	   807	   810
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88
Symbol cross reference

TAKDWN	   227%	   227
TAKTRP	   298	   565	   573	  1056%	  1056
THSDAT	   207%	   207	   618%	   618	   653%	   653	   660%	   660
TIMADJ	   168	   314	   962#
TIME	   187%	   187	   195%	   195	   201%	   201	   206%	   206	   617%	   617	   659%	   659
TIMEF	   169%	   169	   307%	   307
TIMPCD	   280%	   280
TIMRST	  1438#
TIMSET	  1437#
TIMWAK	   264	  1157%
TIOWQ	  1575%	  1604
TPOPJ	  1157%	  1544
TRHALT	    87%	    87
TSAVAL	  1501%	  1501
TSQ	  1500%	  1500
TTKJOB	  1176%	  1182	  1223
TTSCLR	  1392%	  1392
TTYSET	  1303%	  1330
TTYSTC	  1163	  1176%	  1179
TTYTAB	   831	   842%
TYCIOS	  1303%	  1329	  1345
U	   229	   230	   232	   235	   239	   243	   245	   246	   252	   253
UDTFIX	   513	   652#
UNISEC	   515%	   515
UPELP	   514	   815#
UPSCLK	    19%	   332	   401	  1324	  1341
UPT	    22%	  1322	  1339
UPTABK	    19%	   353	   447
UPTACP	    23%	   323	   369	   373	  1303%	  1322	  1323	  1339	  1340
UPTHEC	   987
UPTHMC	   984	   989
UPTIME	   192%	   192	   506%	   506	   816%	   816
UPTJOB	    20%	   157	  1078
UPTLDC	    20%	   162
UPTLEC	   988
UPTLMC	   990
UPTMTM	  1048%	  1049	  1051	  1052	  1054
UPTPC	    23%	    93	   105	   139	   376	   427	   430	   491	  1321	  1338
UPTPDL	    23%	   431	  1282	  1308
UPTSTS	    19%	   333	   335	   400	  1325	  1342
UPTUAC	    25%	   328	   329	   366
UPTXAC	    23%	    94	   104	   106	   107	   143	   144	   145	   426	  1461	  1466	  1469
USCHD1	    86#
USCHED	    93#
USRACB	   149	   349	   451
USRCLK	    22%	   270
USRXIT	  1303%	  1317
USRXT7	   432%	   432
USTART	  1306#
USTRT1	  1307	  1312#
UTRP	  1326	  1343
WAIT1	  1561#	  1565
WAKE	   262	  1391#
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88
Symbol cross reference

WDOG	   591	   748#
WDOG0	   752#
WDOG1	   757	   767#
WDOG2	   781	   782	   785	   798#
WEKDAY	   629	   639#
WRSMAP	   117%	   117	  1376%	  1376
WRSMP1	  1516%	  1519
WSAVAL	  1510%	  1510
WSCHD1	   105#	  1470
WSCHD2	    96	   111#
WSCHED	   104#	  1593
WSQ	  1509%	  1509
WSYNC	  1564	  1577#
WSYNC1	  1585	  1597#
WTMASK	  1327	  1343
ZZ	   329#	   329	   367#	   367	   375#	   375	   499#	   499	  1312#	  1312
ZZ1	   329#	   329	   367#	   367	   375#	   375	   499#	   499	  1312#	  1312
%UPS	    25%	  1321	  1323	  1325
%UPT	    21%	    93	    94	   104	   105	   106	   107	   139	   143	   144	   145	   157	   162	   323
	   328	   329	   333	   335	   353	   366	   369	   373	   376	   400	   426	   427	   430	   431
	   447	   491	   984	   987	   988	   989	   990	  1049	  1051	  1052	  1054	  1078	  1282	  1308
	  1461	  1466	  1469
%UPX	  1304%	  1338	  1340	  1342
.SLDSC	   263#
.SLHNG	   265#	  1437
.SLTIM	   264#
.SLWAK	   262#
CLOCK1 - CLOCK, CONTEXT SWITCHING, AND JOB STARTUP AND STOP ROUTINES	MACRO 12.5-46.0 14:31 13-JAN-88
Macro/Opdef cross reference

CALMAP	    32#	   424
CHARGE	   402	   415	   438	  1004
CHGSTS	   113	   331	   966
DADD	   984
DADDMT	   954#
EXECAC	   149
IFCPU	   156	   352	   355	   359	   383	   394	   403	   405	   416	   418	   439	   445	   457	   463
	   483	   520	   889	   930	   968	   975	   979	   994
IFNCPU	   149	   322	   346	   368	   393	   402	   415	   438	   450	   453	   487
NOCHAR	   115	   393	   967
PFALL	   159	   208	   425	   535	   596	   605	  1172
PJRST	   722	   811	  1164	  1242	  1270	  1345
PRINTF	   108	   303	   709	   753	   786	  1456
PRNTBP	   563
PXCT	   329	   367	   375	   499	  1312
PXGEN	   329	   367	   375	   499	  1312
RDEACT	   982
RDMACT	   981
RDPI	  1541
STOPCD	    10	   163	   342	   497	  1498	  1507
UMOVEM	  1312
WRADB	   353
WRPI	   126	   236	   240	  1209	  1214	  1221	  1419	  1423	  1429	  1431	  1533	  1536	  1583	  1592
	  1597
WRUBR	   350	   372	   380	   452	   493	   501
XCTFU	   329	   499
XCTTU	   367	   375	  1312
$END	  1606   D@ x
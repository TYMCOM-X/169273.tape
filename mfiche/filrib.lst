FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 1
S.MAC	13-JAN-88 11:55		S.MAC - with system parameter file for P035/D, January 1988

     1				SUBTTL	S.MAC - with system parameter file for P035/D, January 1988
     2
     3				IF2,<IFNDEF LISTSN,<TAPE>>	;Skip to PASS2 in all but COMMON.LST
     4				;THIS MODULE ASSEMBLED WITH KL-10 PARAMETER FILE - KLSYM.MAC
     5
     6					IF2,<IFNDEF LISTSN,<		;LIST KLSYM.MAC IN COMMON ONLY
     7								TAPE>>
     8				TITLE	FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS
     9
    10					STOPCD(,ENTRY,FILRIB)^
    11					ENTRY	FILRIB		;For library searches
    12	000000'	260040	000000*	FILRIB::PUSHJ	P,DIE		;**** Default stopcode for "FILRIB" ****
    13	000001'	465154	625142		SIXBIT	/FILRIB/  	;Title of module
    14	000002'	000000	000000		S$NONAME,,0		;?NONAME stopcode "FILRIB+nnn(nnnnnn)"
    15			000000'	S$NAME==FILRIB			;For STOPCDs with no arguments
    16					SALL>
    17				^
    18
    19				EXTERN RBSPAR,RBREAL,RBINDX,RBDLTA,RBLVPR,RBLVSP,RBMASK
    20				EXTERN RIBRIB,RIBRPS,RIBSNM,RIBSZS,RIBPFS,RIBSFS,RIBLST,TWOLVL,ONELVL,RIBELB,RIBSIZ,RIBNAM
    21				EXTERN RIBSTS,RIPBDR
    22				EXTERN RIBCOD,RIBSLF,RIBEXT,RIBPPN,RIBALP
    23				EXTERN RBYPNO,RBYUNI,RBYUNA,RBYUNR,RBYUNV
    24				EXTERN CODRIB
    25
    26				EXTERN ATYBSZ,ATBALP,ATBRIB,ATBSIZ,ATYBLK
    27
    28				EXTERN DRBALC,DRBRIB
    29
    30				EXTERN DEVRIB,DEYRPS,DEYRPS,DEVATB,DEVFLO,DEVPOS,DEVFUF
    31				EXTERN DEVRET,DEVRBN,DEVRB1,DEVDRB
    32				EXTERN DEVELB,DEVSZS,PTRLEN,PTRCHG
    33
    34				EXTERN DEVREL,DEVBLK ;******************
    35				EXTERN UFDLNK,STRHSH,FLUSH
    36
    37				EXTERN UNLFIL,LOKMOD,KILFIL,FLUSHA
    38
    39				EXTERN UNIMCT,UNPRER
    40				EXTERN UNIKON,UNIPPU,UNISTR
    41
    42				EXTERN STRDDB,STRNAM
    43
    44				EXTERN PGYERR
    45
    46				EXTERN MAPRDL,MAPWTL,MAPCML,MAPWLN,MAPRLS,GETER1
    47				EXTERN %RIB.C,%RB2.C
    48
    49				EXTERN UPTRIB
    50
    51				EXTERN GIVPGK,RELSAT,GIVPAG
    52
    53				EXTERN CPOPJ1,CPOPJ,MFDPPN,GETAPG,UNTTBL,ERRFUL,IOSUPR
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 1
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

    54				EXTERN RELLOK,TPOPJ,IOSRBE,IOSRIB,MAPXCH,CHKQTA,IOBDRB,JOB
    55				EXTERN ALIASD,FALAQA,FALRBE,PAGWAT,%COW,%COW.N,FALBDS
    56				EXTERN LMPMXW,CLRCOW
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 2
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

    57				COMMENT #
    58				@@SUBROUTINE NXTPTR/NXTPT0
    59				@@PURPOSE
    60				THIS IS THE SUBR CALLED WHEN WE ARE OUT OF PNTRS IN THE DDB AND
    61				WE WANT TO GET THE NEXT PNTR (REAL, SPARE, NON-EXIST, EOF, ETC.)
    62				INTO THE DDB.
    63				IF WE REACH THE END OF THE RIB STRUCTURE (I.E., OUR PREVIOUS
    64				POINTER WAS AT THE END OF THE "LAST" RIB IN THE STR) (WE ARE
    65				DOING OUTPUT) ADDITIONAL RIBS WILL BE GENERATED.
    66				IT IS ASSUMED THAT THE CALLER HAS WRITTEN OUT THE DDB PNTRS
    67				IF IT WAS NECESSARY TO DO SO.
    68				@@ENTRY
    69				EXPECTS F/ DDB, U/ UNIT DB, AND S TO BE SET UP.
    70				ENTER AT NXTPTR IF CALLER DOES NOT HAVE THE RIB IN %RIB.
    71				@@ACCUM
    72				DESTROYS T1 THRU T4 AND PG.
    73				@@RESTRICTIONS
    74				CALLING ROUTINES CANNOT LEAVE THE DDB WITH ONLY SPARE RIB
    75				POINTERS IN IT, AS THAT IS AN ILLEGAL FORM.
    76				@@EXIT
    77				NON-SKIP RETURNS IF ERROR READING RIB OR CAN'T ALLOCATE ANOTHER
    78				RIB.  ERROR FLAGS RETURNED IN T1 ARE, RESPECTIVELY, FALRBE
    79				AND FALAQA.
    80				ELSE SKIP RETURNS WITH THE NEXT PNTR IN THE DDB AND WE HAVE THE RIB
    81				IN %RIB.  THE FORM OF THE NEXT PNTR (EOF, SPARE, ILLEGAL, ETC.)
    82				IS NOT CHECKED BY THIS ROUTINE.
    83				@@ #
    84
    85				INTERN NXTPT0
    86
    87	000003'	200304	000000*	NXTPTR:	MOVE	T1,DEVRIB(F)	;MAP
    88	000004'	201140	000000*		MOVEI	PG,%RIB.C	;IN THE
    89	000005'	260040	000000*		PUSHJ	P,MAPWTL	;RIB.
    90	000006'	260040	000146'		PUSHJ	P,RIBCON	;ERRORS?
    91					  JRST	[PUSHJ P,MAPRLS
    92						MOVEI T1,FALRBE
    93	000007'	254000	002041'			POPJ P,]
    94	000010'	200004	000002		MOVE	S,DEVIOS(F)	;DID THE FILE GO BAD WHILE WE
    95	000011'	603000	000000*		TLNE	S,IOBDRB	;WAITED?
    96					 JRST	[PUSHJ P,RELRIB ;
    97						MOVEI T1,FALRBE ;
    98	000012'	254000	002044'			POPJ P,]
    99	000013'	200444	000000*		MOVE	T4,DEVFLO(F)	;GET THE INVALIDATED DEVFLO
   100	000014'	621440	400000		TLZ	T4,(1B0)	;TURN OFF SIGN BIT, SO ARITHMETIC WORKS
   101	000015'	254000	000023'		JRST	NXTP05		;AND GO GET POINTERS.
   102
   103	000016'	337444	000013*	NXTPT0:	SKIPG	T4,DEVFLO(F)	;SEND ALONG THE NEXT DEVFLO
   104	000017'	256000	000000'		 STOPCD (SLO)
   105				           ;;NXTPT0+1
   106	000020'	661440	400000		TLO	T4,(1B0)	;INVALIDATE THE POINTERS
   107	000021'	202444	000016*		MOVEM	T4,DEVFLO(F)	;SO THAT NO ONE WILL GET THEM BETWEEN
   108								; THE TIME THAT WE CHANGE DEVRIB AND
   109								; THE TIME THE POINTERS FROM THE NEW RIB
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 2-2
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

   110								; ACTUALLY COME IN.
   111	000022'	621440	400000		TLZ	T4,(1B0)	;CLEAR THE BIT SO ARITHMETIC WILL WORK.
   112	000023'	275440	000001	NXTP05:	SUBI	T4,1		;IN UNITS
   113	000024'	242440	777776		LSH	T4,-2		;OF
   114	000025'	271440	000001*		ADDI	T4,PTRLEN+1	;PAGES.
   115	000026'	260040	000400'		PUSHJ	P,PTRINN	;WON, MAYBE GET PNTRS FROM RIB.
   116	000027'	254000	000031'		  JRST	NXTPT1		;OUT OF RIB PNTRS.
   117	000030'	254000	000000*		JRST	CPOPJ1		;NOT OUT OF RIB POINTERS.
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 3
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

   118				    ;HERE ON REACHED END OF POINTERS IN THIS RIB.
   119	000031'	200300	376000*	NXTPT1:	MOVE	T1,%RIB+RIBLST	;LAST PNTR IN THIS RIB IS A
   120	000032'	321300	000036'		JUMPL	T1,NXTP15	;SPARE RIB PNTR?
   121	000033'	200300	376000*		MOVE	T1,%RIB+RIBSZS	;NO.  AT LOWEST LEVEL
   122	000034'	302300	000001		CAIE	T1,1		;OF RIB TREE?
   123	000035'	254000	000046'		 JRST	NXTPT3		;NO--AT EOF.
   124	000036'	336300	376000*	NXTP15:	SKIPN	T1,%RIB+RIBRIB	;IS THIS RIB THE PRIME RIB?
   125					 JRST	[MOVE T1,%RIB+RIBSZS  ;YES. AT EOF.
   126						 CAIN T1,TWOLVL
   127					 STOPCD (SLO)           ;;NXTP15+2
   128	000037'	254000	002047'			JRST	NXTPT3]
   129	000040'	202304	000003*		MOVEM	T1,DEVRIB(F)	;NO . GO SET
   130	000041'	200300	376000*		MOVE	T1,%RIB+RIBRPS	;UP FOR
   131	000042'	137300	000000*		DPB	T1,DEYRPS	;THE HIGHER RIB.
   132	000043'	201140	000004*		MOVEI	PG,%RIB.C	;RELEASE
   133	000044'	260040	000000*		PUSHJ	P,MAPRLS	;%RIB.
   134	000045'	254000	000003'		JRST	NXTPTR		;
   135
   136
   137				    ;HERE ON EOF.
   138	000046'	302300	000000*	NXTPT3:	CAIE	T1,TWOLVL	;DO WE NEED TWO PAGES?
   139	000047'	254000	000062'		 JRST	NXTP34		;NO.
   140	000050'	260040	000000*		PUSHJ	P,CHKQTA	;YES.  MAKE SURE NOT OVER QUOTA
   141	000051'	254000	000076'		  JRST	NXTP35		;CAN'T GET ANOTHER PAGE.
   142	000052'	201300	000000*		MOVEI	T1,FBIT##	;TRY TO GET
   143	000053'	550404	000000*		HRRZ	T3,DEVATB(F)	;ANOTHER
   144	000054'	260040	000000*		PUSHJ	P,GETAPG	;PAGE.
   145	000055'	254000	000076'		  JRST	NXTP35		;CAN'T DO IT.
   146	000056'	200004	000002		MOVE	S,DEVIOS(F)	;
   147	000057'	603000	000011*		TLNE	S,IOBDRB	;
   148	000060'	254000	000076'		 JRST	NXTP35		;
   149	000061'	261040	000007		PUSH	P,T2		;GOT IT, SAVE RET PNTR.
   150	000062'	201140	000000*	NXTP34:	MOVEI	PG,%RB2.C	;MAP IN AND ZERO A NEW RIB.
   151	000063'	260040	000315'		PUSHJ	P,GETRIB	;ALSO SET RIBSLF.
   152	000064'	254000	000070'		  JRST	NXT344		;COULDN'T GET A DISK PAGE.
   153	000065'	200004	000002		MOVE	S,DEVIOS(F)	;FILE WENT BAD WHILE WE
   154	000066'	607000	000057*		TLNN	S,IOBDRB	;WAITED?
   155	000067'	254000	000104'		 JRST	NXTP36		;NO.  SUCCESS.
   156	000070'	201300	000046*	NXT344:	MOVEI	T1,TWOLVL	;DO WE HAVE A SECOND
   157	000071'	312300	376000*		CAME	T1,%RIB+RIBSZS	;PAGE ON THE PDL?
   158	000072'	254000	000076'		JRST	NXTP35		;NO.
   159	000073'	262040	000007		POP	P,T2		;YES.  GIVE
   160	000074'	621340	000000*		TLZ	T2,RBMASK-RBREAL ;IT
   161	000075'	260040	000000*		PUSHJ	P,GIVPAG	;BACK.
   162	000076'	260040	000000*	NXTP35:	PUSHJ	P,RELRIB	;RELEASE THE RIB.
   163	000077'	201300	000000*		MOVEI	T1,FALAQA	;SET THE
   164	000100'	200004	000002		MOVE	S,DEVIOS(F)	;ERROR FLAG
   165	000101'	603000	000066*		TLNE	S,IOBDRB	;AND
   166	000102'	201300	000000*		MOVEI	T1,FALRBE	;THEN
   167	000103'	263040	000000		POPJ	P,		;IT.
   168
   169
   170	000104'	200340	375000*	NXTP36:	MOVE	T2,%RB2+RIBSLF	;SET
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 3-2
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

   171	000105'	202344	000040*		MOVEM	T2,DEVRIB(F)	;DEVRIB.
   172	000106'	261040	000014		PUSH	P,P1		;SAVE P1 AND
   173	000107'	261040	000015		PUSH	P,P2		;P2.
   174	000110'	201600	376000		MOVEI	P1,%RIB		;SET THEM UP AS ARGS FOR THE
   175	000111'	201640	375000		MOVEI	P2,%RB2		;RIBEX? SUBRS.
   176	000112'	200300	376000*		MOVE	T1,%RIB+RIBLST	;LAST PNTR IN OUR ORIGINAL RIB
   177	000113'	325300	000120'		JUMPGE	T1,NXTPT4	;IS A SPARE RIB PNTR?
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 4
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

   178				    ;HERE ON INCREASING OUR RIB STRUCTURE FROM TWO LEVELS
   179				    ;TO THREE LEVELS.
   180	000114'	260040	000153'		PUSHJ	P,RIBEX1	;SET UP INFO IN BOTH RIBS.
   181	000115'	201300	000000*		MOVEI	T1,RIBSFS+RBLVPR-1 ;SET
   182	000116'	137300	000042*		DPB	T1,DEYRPS	;DEYRPS.
   183	000117'	254000	000137'		JRST	NXTPT5
   184
   185
   186				    ;HERE ON ALL NEW RIB GENERATION EXCEPT GOING FROM TWO
   187				    ;LEVELS TO THREE.
   188	000120'	260040	000203'	NXTPT4:	PUSHJ	P,RIBEX2	;SET UP INFO IN BOTH RIBS.
   189					JRST	[DPB T4,DEYRPS	;RETURN HERE ON NO INTER-
   190	000121'	254000	002053'			JRST NXTPT5]	;MEDIATE RIB NEEDED.
   191	000122'	137440	000116*		DPB	T4,DEYRPS	;HERE ON NEED AN INTERMEDIATE RIB.
   192	000123'	262040	000006		POP	P,T1		;RESTORE
   193	000124'	262040	000007		POP	P,T2		;GOTTEN
   194	000125'	250341	000000		EXCH	T2,(P)		;RETRIEVAL
   195	000126'	261040	000006		PUSH	P,T1		;PNTR.
   196	000127'	260040	000261'		PUSHJ	P,RIBEX3	;LINK.
   197	000130'	201140	000043*		MOVEI	PG,%RIB.C	;RELEASE
   198	000131'	260040	000044*		PUSHJ	P,MAPRLS	;%RIB.
   199	000132'	200301	000000		MOVE	T1,(P)		;GET THE INTERMEDIATE PAGE
   200	000133'	260040	000000*		PUSHJ	P,MAPWLN	;INTO %RIB.
   201	000134'	201300	376000		MOVEI	T1,%RIB		;ZERO
   202	000135'	260040	000340'		PUSHJ	P,CORZER	;IT.
   203	000136'	265440	000300'		JSP	T4,RIBEX4	;SET UP SOME MORE STUFF.
   204
   205
   206	000137'	201140	000062*	NXTPT5:	MOVEI	PG,%RB2.C	;RELEASE
   207	000140'	260040	000131*		PUSHJ	P,MAPRLS	;BOTH
   208	000141'	201140	000130*		MOVEI	PG,%RIB.C	;THE
   209	000142'	260040	000140*		PUSHJ	P,MAPRLS	;RIBS.
   210	000143'	262040	000015		POP	P,P2		;RESTORE P2 AND
   211	000144'	262040	000014		POP	P,P1		;P1.
   212	000145'	254000	000003'		JRST	NXTPTR		;TRY AGAIN.
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 5
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

   213				COMMENT #
   214				@@SUBROUTINE RIBCON
   215				@@PURPOSE
   216				SUBR TO CHECK A RIB.
   217				@@ENTRY
   218				EXPECTS THE RIB IN %RIB.
   219				@@ACCUM
   220				DESTROYS
   221				@@CALLS
   222				RIBCK1.
   223				@@EXIT
   224				SKIP RETURNS IF OKAY, ELSE NON-SKIP RETURNS WITH
   225				ERROR BITS ALREADY SET.
   226				@@ #
   227
   228	000146'	260040	001137'	RIBCON::PUSHJ	P,RIBCK1	;CHECK THE RIB.
   229	000147'	254000	000151'		  JRST	.+2		;BAD RIB.
   230	000150'	254000	000030*		JRST	CPOPJ1		;PROBABLY OKAY.
   231	000151'	476004	000021*		SETOM	DEVFLO(F)	;
   232	000152'	263040	000000		POPJ	P,
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 6
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

   233				COMMENT #
   234				@@SUBROUTINE RIBEX1
   235				@@PURPOSE
   236				SUBR TO HELP EXTEND THE RIB STRUCTURE.  USED WHEN EXPANDING
   237				FROM TWO LEVELS TO THREE.  TRANSFERS INFORMATION BETWEEN
   238				THE OLD 2ND LEVEL PRIME RIB AND THE NEW 2ND LEVEL RIB.
   239				@@ENTRY
   240				EXPECTS P1/ ADDRESS OF SOURCE RIB, P2/ ADDRESS OF NEW RIB, AND
   241				THE NEW RIB TO HAVE BEEN ZEROED AND ITS RIBSLF AND RIBCOD SET.
   242				@@ACCUM
   243				DESTROYS T1 AND T2.
   244				@@ #
   245
   246	000153'	205314	000000*	RIBEX1::MOVSI	T1,RIBPFS(P1)	;COPY ALL THE
   247	000154'	541315	000000*		HRRI	T1,RIBSFS(P2)	;PNTRS TO THE NEW
   248	000155'	251315	000000*		BLT	T1,RIBLST-<RIBPFS-RIBSFS>(P2) ;RIB.
   249	000156'	402014	000001*		SETZM	RIBPFS+1(P1)	;CLEAR OUT ALL OF THE
   250	000157'	201314	000002*		MOVEI	T1,RIBPFS+2(P1)	;PNTR AREA IN THE OLD
   251	000160'	505306	777777		HRLI	T1,-1(T1)	;RIB EXCEPT WHERE THE SPARE
   252	000161'	251314	000000*		BLT	T1,RIBLST(P1)	;RIB PNTR WILL GO.
   253	000162'	200314	000000*		MOVE	T1,RIBSNM(P1)	;SET RIBSNM AND RIBSZS
   254	000163'	202315	000162*		MOVEM	T1,RIBSNM(P2)	;IN THE NEW
   255	000164'	200314	000000*		MOVE	T1,RIBSZS(P1)	;SPARE RIB TO THE OLD VALUES
   256	000165'	202315	000164*		MOVEM	T1,RIBSZS(P2)	;IN THE PRIME RIB.
   257	000166'	200314	000000*		MOVE	T1,RIBSLF(P1)	;POINT THE SPARE RIB BACK
   258	000167'	202315	000000*		MOVEM	T1,RIBRIB(P2)	;TO THE PRIME RIB.
   259	000170'	201300	000153*		MOVEI	T1,RIBPFS	;MARK THE PRIME RIB'S SPARE
   260	000171'	202315	000000*		MOVEM	T1,RIBRPS(P2)	;RIB PNTR TO THIS SPARE RIB.
   261	000172'	200355	000166*		MOVE	T2,RIBSLF(P2)	;PUT THE SPARE
   262	000173'	661340	000000*		TLO	T2,RBSPAR	;RIB PNTR IN
   263	000174'	202354	000170*		MOVEM	T2,RIBPFS(P1)	;THE PRIME RIB.
   264	000175'	201300	000001		MOVEI	T1,1		;PRIME RIB NOW
   265	000176'	202314	000163*		MOVEM	T1,RIBSNM(P1)	;HAS ONE
   266	000177'	200314	000165*		MOVE	T1,RIBSZS(P1)	;SPARE RIB POINTER.
   267	000200'	221300	000000*		IMULI	T1,RBLVSP	;SET RIBSZS IN
   268	000201'	202314	000177*		MOVEM	T1,RIBSZS(P1)	;THE PRIME RIB.
   269	000202'	263040	000000		POPJ	P,
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 7
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

   270				COMMENT #
   271				@@SUBROUTINE RIBEX2
   272				@@PURPOSE
   273				SUBR TO HELP EXPAND THE RIB STRUCTURE.  USED IN ALL NEW RIB
   274				GENERATION EXCEPT GOING FROM TWO LEVELS TO THREE.  TRANSFERS
   275				INFORMATION BETWEEN THE SOURCE RIB AND THE LOWEST LEVEL RIB.
   276				@@ENTRY
   277				EXPECTS P1/ ADDR OF SOURCE RIB   AND P2/ ADDR OF NEW LOWEST
   278				LEVEL RIB.
   279				@@ACCUM
   280				DESTROYS T1 THRU T4.
   281				@@EXIT
   282				RETURNS "DEYRPS" IN T4.
   283				SKIP RETURNS IF NEED TO GENERATE AN INTERMEDIATE RIB, ELSE
   284				NON-SKIP RETURNS.
   285				@@ #
   286
   287				INTERN RIBEX2
   288	000203'	201400	000174*	RIBEX2:	MOVEI	T3,RIBPFS	;OUR ORIGINAL RIB MAY BE
   289	000204'	332014	000167*		SKIPE	RIBRIB(P1)	;A PRIME RIB OR
   290	000205'	201400	000154*		MOVEI	T3,RIBSFS	;A SPARE RIB.
   291	000206'	200314	000176*		MOVE	T1,RIBSNM(P1)	;CALC
   292	000207'	201340	000000*		MOVEI	T2,RBLVPR	;T2/
   293	000210'	302400	000203*		CAIE	T3,RIBPFS	;NO. NON-SPARE
   294	000211'	201340	000200*		MOVEI	T2,RBLVSP	;RIB
   295	000212'	275346	000000		SUBI	T2,(T1)		;PNTRS TO TRANSFER.
   296	000213'	271310	000000		ADDI	T1,(T3)		;T1/ STARTING LOC.
   297	000214'	271314	000000		ADDI	T1,(P1)		;
   298	000215'	200440	000006		MOVE	T4,T1		;SAVE FOR LATER.
   299	000216'	515306	000000		HRLZI	T1,(T1)		;TRANSFER THE
   300	000217'	541315	000205*		HRRI	T1,RIBSFS(P2)	;NON-SPARE
   301	000220'	271355	777777*		ADDI	T2,RIBSFS-1(P2)	;RIB
   302	000221'	251307	000000		BLT	T1,(T2)		;PNTRS.
   303	000222'	275355	000000		SUBI	T2,(P2)		;SAVE
   304	000223'	261040	000007		PUSH	P,T2		;"DEYRPS".
   305	000224'	402011	000000		SETZM	(T4)		;CLEAR THE
   306	000225'	306454	000161*		CAIN	T4,RIBLST(P1)	;
   307	000226'	254000	000232'		JRST	RIBX22		;
   308	000227'	271440	000001		ADDI	T4,1		;TRANSFERRED
   309	000230'	505451	777777		HRLI	T4,-1(T4)	;AREA IN THE
   310	000231'	251454	000225*		BLT	T4,RIBLST(P1)	;ORIGINAL RIB.
   311	000232'	402015	000206*	RIBX22:	SETZM	RIBSNM(P2)	;SET RIBSNM
   312	000233'	201300	000001		MOVEI	T1,1		;AND RIBSZS IN
   313	000234'	202315	000201*		MOVEM	T1,RIBSZS(P2)	;THE NEW RIB.
   314	000235'	200314	000234*		MOVE	T1,RIBSZS(P1)	;
   315	000236'	350354	000232*		AOS	T2,RIBSNM(P1)	;ONE MORE SPARE RIB
   316	000237'	302340	000001		CAIE	T2,1		;PNTR
   317	000240'	254000	000244'		JRST	RIBE25		;WILL BE IN
   318	000241'	200354	000235*		MOVE	T2,RIBSZS(P1)	;ORIGINAL RIB.
   319	000242'	221340	000211*		IMULI	T2,RBLVSP	;(POSSIBLY WE ARE
   320	000243'	202354	000241*		MOVEM	T2,RIBSZS(P1)	;CREATING A NEW LEVEL.).
   321	000244'	262040	000011	RIBE25:	POP	P,T4		;RESTORE "DEYRPS".
   322	000245'	306300	000070*		CAIN	T1,TWOLVL	;NEED AN INTERMED RIB?
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 7-2
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

   323	000246'	254000	000150*		JRST	CPOPJ1		;YES, SAY SO BY SKIP RETURNING.
   324	000247'	200315	000172*		MOVE	T1,RIBSLF(P2)	;NO, JUST FINISH UP HERE.
   325	000250'	661300	000173*		TLO	T1,RBSPAR	;POINT THE ORIGINAL
   326	000251'	200354	000236*		MOVE	T2,RIBSNM(P1)	;RIB
   327	000252'	271350	777777		ADDI	T2,-1(T3)	;TO
   328	000253'	202355	000171*		MOVEM	TRPS(P2)	;THE
   329	000254'	271354	000000		ADDI	T2,(P1)		;NEW.
   330	000255'	202307	000000		MOVEM	T1,(T2)		;RIB.
   331	000256'	200314	000247*		MOVE	T1,RIBSLF(P1)	;POINT THE NEW RIB BACK TO
   332	000257'	202315	000204*		MOVEM	T1,RIBRIB(P2)	;THE ORIGINAL RIB.
   333	000260'	263040	000000		POPJ	P,
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 8
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

   334				COMMENT #
   335				@@SUBROUTINE RIBEX3/RIBEX4
   336				@@PURPOSE
   337				SUBRS TO HELP EXPAND THE RIB STRUCTURE.  RIBEX3 IS CALLED WHEN
   338				WE HAVE JUST GOTTEN A DISK PAGE FOR AN INTERMEDIATE RIB AND
   339				THE HIGHER AND LOWER RIBS ARE IN (P1) AND (P2) RESPECTIVELY.
   340				RIBEX4 IS CALLED AFTER ITS CALLER HAS "WRITTEN OUT" THE
   341				HIGHEST RIB AND ZEROED THE SPACE FOR THE INTERMEDIATE RIB.
   342				@@ENTRY
   343				EXPECTS P1/ ADDR OF SOURCE RIB, P2/ ADDR OF NEW LOWEST LEVEL
   344				RIB, AND RIBEX3 EXPECTS T2/ DISK POINTER TO NEW INTERMEDIATE
   345				RIB.
   346				@@ACCUM
   347				DESTROYS
   348				@@EXIT
   349				RIBEX3 EXITS WITH THE FOLLOWING THREE THINGS FOR THE INTER-
   350				MEDIATE RIB ON THE TOP OF ITS PDL: RIBRPS, RIBRIB, AND RIBSLF.
   351				THESE ARE FOR THE USE OF RIBEX4 (WHICH IS CALLED WITH A
   352				JSP T4,).
   353				@@ #
   354
   355				INTERN RIBEX3
   356	000261'	202355	000257*	RIBEX3:	MOVEM	T2,RIBRIB(P2)	;LOWEST RIB PNTS TO INTRMD PAGE.
   357	000262'	201300	000217*		MOVEI	T1,RIBSFS	;LOWEST RIB POINTS
   358	000263'	202315	000253*		MOVEM	T1,RIBRPS(P2)	;TO A SPARE RIB.
   359	000264'	661340	000250*		TLO	T2,RBSPAR	;T2/ PNTR TO INTERMED PAGE.
   360	000265'	200314	000251*		MOVE	T1,RIBSNM(P1)	;T1/ LOC IN HIGHEST RIB
   361	000266'	271300	777777*		ADDI	T1,RIBPFS-1	;OF PNTR TO INTERMED RIB.
   362	000267'	200440	000006		MOVE	T4,T1		;
   363	000270'	271454	000000		ADDI	T4,(P1)		;
   364	000271'	202351	000000		MOVEM	T2,(T4)		;STORE PNTR IN HIGHEST RIB.
   365	000272'	621340	000264*		TLZ	T2,RBSPAR	;RESTORE T2.
   366	000273'	262040	000011		POP	P,T4		;T4/ RETURN ADDRESS.
   367	000274'	261040	000006		PUSH	P,T1		;SAVE THESE THREE
   368	000275'	261054	000256*		PUSH	P,RIBSLF(P1)	;THINGS FOR THE USE
   369	000276'	261040	000007		PUSH	P,T2		;OF RIBEX4.
   370	000277'	254011	000000		JRST	(T4)		;RETURN.
   371
   372				INTERN RIBEX4
   373	000300'	262054	000275*	RIBEX4:	POP	P,RIBSLF(P1)	;SET UP
   374	000301'	262054	000261*		POP	P,RIBRIB(P1)	;STUFF IN THE
   375	000302'	262054	000263*		POP	P,RIBRPS(P1)	;INTERMEDATE RIB.
   376	000303'	201400	000000*		MOVEI	T3,CODRIB	;COPY SPARE
   377	000304'	202414	000000*		MOVEM	T3,RIBCOD(P1)	;RIB REDUNDANT INFO.
   378	000305'	201340	000001		MOVEI	T2,1		;ONE SPARE
   379	000306'	202354	000265*		MOVEM	T2,RIBSNM(P1)	;RIB POINTER.
   380	000307'	200355	000300*		MOVE	T2,RIBSLF(P2)	;
   381	000310'	661340	000272*		TLO	T2,RBSPAR	;
   382	000311'	202354	000262*		MOVEM	T2,RIBSFS(P1)	;
   383	000312'	201340	000242*		MOVEI	T2,RBLVSP	;SET
   384	000313'	202354	000243*		MOVEM	T2,RIBSZS(P1)	;RIBSZS.
   385	000314'	254011	000000		JRST	(T4)		;RETURN.
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 9
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

   386				COMMENT #
   387				@@SUBROUTINE GETRIB
   388				@@PURPOSE
   389				SUBROUTINE TO GET A NEW PAGE ON THE DISK, MAP IT IN AS
   390				(PG), ZERO IT, AND SET RIBSLF AND RIBCOD.
   391				@@ENTRY
   392				EXPECTS PG/ %RIB.C OR %RB2.C.
   393				@@ACCUM
   394				DESTROYS
   395				@@CALLS
   396				CKQOTA, GETAPG, MAPWLN, AND ZERPAG.
   397				@@EXIT
   398				SKIP RETURNS UNLESS ERROR, IN WHICH CASE NON-SKIP RETURNS.
   399				@@ #
   400
   401	000315'	260040	000050*	GETRIB:	PUSHJ	P,CHKQTA	;CHECK USER'S DISK QUOTA
   402	000316'	263040	000000		  POPJ	P,		;COULDN'T GET A PAGE.
   403	000317'	201300	000052*		MOVEI	T1,FBIT##	;
   404	000320'	550404	000053*		HRRZ	T3,DEVATB(F)	;T3/ ATB ADDR OR ZERO.
   405	000321'	260040	000054*		PUSHJ	P,GETAPG	;GET A DISK PAGE ANYWHERE.
   406	000322'	263040	000000		  POPJ	P,		;NO SPACE ON DISK OR UNIT.
   407	000323'	200300	000007		MOVE	T1,T2		;MAP IT
   408	000324'	261040	000006		PUSH	P,T1		;IN
   409	000325'	260040	000133*		PUSHJ	P,MAPWLN	;AS (PG).
   410	000326'	201300	376000		MOVEI	T1,%RIB		;ZERO
   411	000327'	302140	000141*		CAIE	PG,%RIB.C	;THE
   412	000330'	201300	375000		 MOVEI	T1,%RB2		;PAGE
   413	000331'	261040	000006		PUSH	P,T1		;
   414	000332'	260040	000340'		PUSHJ	P,CORZER	;AND
   415	000333'	262040	000006		POP	P,T1		;
   416	000334'	262046	000307*		POP	P,RIBSLF(T1) 	;THEN
   417	000335'	201340	000303*		MOVEI	T2,CODRIB	;SET
   418	000336'	202346	000304*		MOVEM	T2,RIBCOD(T1)	;RIBCOD AND RIBSLF.
   419	000337'	254000	000246*		JRST	CPOPJ1
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 10
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

   420				COMMENT #
   421				@@SUBROUTINE CORZER/CORONZ
   422				@@PURPOSE
   423				SUBR TO SET VALUES IN A PAGE IN CORE.
   424				@@ENTRY
   425				EXPECTS T1/ ADDR OF START OF PAGE IN CORE.
   426				ENTRY POINT CORZER CLEARS THE PAGE, ENTRY POINT CORONZ SETS
   427				ALL THE WORDS IN THE PAGE TO THE CONTENTS OF THE 1ST WORD
   428				IN THE PAGE.
   429				@@ACCUM
   430				DESTROYS T1 AND T2.
   431				@@EXIT
   432				RETURNS T2/ ADDR OF LAST WORD IN THE PAGE.
   433				@@ #
   434
   435				INTERN CORZER,CORONZ
   436
   437	000340'	402006	000000	CORZER:	SETZM	(T1)		;CLEAR 1ST WORD OF PAGE.
   438	000341'	505306	000000	CORONZ:	HRLI	T1,(T1)		;SET UP THE
   439	000342'	271300	000001		ADDI	T1,1		;BLT PNTR.
   440	000343'	201346	000776		MOVEI	T2,776(T1)	;ADDR OF LAST WORD IN PAGE.
   441	000344'	251307	000000		BLT	T1,(T2)		;DO THE WHOLE PAGE.
   442	000345'	263040	000000		POPJ	P,
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 11
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

   443				COMMENT #
   444				@@SUBROUTINE PTROUT/PTROU0
   445				@@PURPOSE
   446				IF ANY POINTER IN THE DDB HAS CHANGED, TRANSFER THE PNTRS
   447				INTO THE RIB, AND KEEP THE RIB ON RETURN.
   448				ENTRY POINT PTROUT DOES NOT HAVE THE RIB ON ENTRY, ENTRY
   449				POINT PTROU0 DOES.
   450				@@ENTRY
   451				EXPECTS F/DDB.
   452				@@ACCUM
   453				PTROUT DESTROYS T1, T2, T3, T4, AND PG.
   454				PTROU0 DESTROYS T2 AND T3. (IT MUST NOT DESTROY OTHER ACS.).
   455				@@EXIT
   456				PTROUT NON-SKIP RETURNS IF ERROR, ELSE 2 SKIP RETURNS IF
   457				THE DDB PNTRS HAVE CHANGED (IT HAS GOTTEN THE RIB), ELSE 1 SKIP
   458				RETURNS IF THE DDB PNTRS HAVE NOT CHANGED (IT HAS NOT GOTTEN
   459				THE RIB).
   460				PTROU0 ALWAYS NON-SKIP RETURNS.
   461				@@ #
   462
   463
   464	000346'	200304	000007	PTROUT::MOVE	T1,DEVIAD(F)	;HAVE THE
   465	000347'	627300	000000*		TLZN	T1,PTRCHG	;POINTERS CHANGED?
   466	000350'	254000	000337*		JRST	CPOPJ1		;NO.
   467	000351'	202304	000007		MOVEM	T1,DEVIAD(F)	;
   468	000352'	200304	000105*		MOVE	T1,DEVRIB(F)	;GET THE
   469	000353'	201140	000327*		MOVEI	PG,%RIB.C	;RIB INTO
   470	000354'	260040	000005*		PUSHJ	P,MAPWTL	;%RIB.
   471	000355'	260040	000146'		PUSHJ	P,RIBCON	;ERROR ON READING?
   472	000356'	324740	000142*		  PJRST	MAPRLS		;YES.
   473	000357'	260040	000367'		PUSHJ	P,PTROU2	;NO.  TRANSFER THE PNTRS
   474	000360'	350001	000000		AOS	(P)		;AND
   475	000361'	350001	000000		AOS	(P)		;RETURN.
   476	000362'	263040	000000		POPJ	P,
   477
   478
   479	000363'	200404	000007	PTROU0::MOVE	T3,DEVIAD(F)	;HAVE THE
   480	000364'	627400	000347*		TLZN	T3,PTRCHG	;POINTERS CHANGED?
   481	000365'	263040	000000		 POPJ	P,		;NO.
   482	000366'	202404	000007		MOVEM	T3,DEVIAD(F)	;
   483
   484	000367'	135340	000122*	PTROU2::LDB	T2,DEYRPS	;ADDR OF BEGINNING OF PNTR
   485	000370'	271340	376000		ADDI	T2,%RIB		;AREA IN RIB
   486	000371'	200400	000007		MOVE	T3,T2		;TO
   487	000372'	275400	777777*		SUBI	T3,PTRLEN-1	;RH OF T3.  ADDR OF
   488	000373'	305400	376000*		CAIGE	T3,%RIB+RIBSFS	;(DEBUGGING CHECK.).
   489	000374'	256000	000000'		 STOPCD (SLO)
   490				           ;;PTROU2+5
   491	000375'	505404	000000*		HRLI	T3,DEVRB1(F)	;BEGIN OF DDB AREA TO LH T3.
   492	000376'	251407	000000		BLT	T3,(T2)		;TRANSFER THE POINTERS.
   493	000377'	263040	000000		POPJ	P,
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 12
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

   494				COMMENT #
   495				@@SUBROUTINE PTRINN
   496				@@PURPOSE
   497				SUBROUTINE TO COPY POINTERS FROM THE RIB IN %RIB TO THE DDB.
   498				TRANSFERS ESSENTIALLY ACCORDING TO DEYRPS.
   499				@@ENTRY
   500				EXPECTS F/DDB AND T4/ NEW DEVFLO IN UNITS OF PAGES (1,2, ETC.)..
   501				@@ACCUM
   502				DESTROYS T1 THRU T4.
   503				@@EXIT
   504				RETURNS POPJ IF NO POINTERS LEFT IN RIB.
   505				ELSE CPOPJ1 WITH DEVSZS AND DEVFLO ALSO SET.
   506				@@ #
   507
   508				INTERN PTRINN
   509
   510	000400'	135300	000367*	PTRINN:	LDB	T1,DEYRPS	;OUT OF POINTERS
   511	000401'	275300	000231*		SUBI	T1,RIBLST	;IN THIS
   512	000402'	322300	000000*		JUMPE	T1,CPOPJ	;RIB?
   513	000403'	313300	002055'		CAMLE	T1,[XWD -PTRLEN] ;ENOUGH TO FILL A DDB?
   514	000404'	254000	000413'		JRST	PTRIN4		;NO.
   515
   516				    ;ENOUGH TO FILL DDB.
   517	000405'	201304	000375*		MOVEI	T1,DEVRB1(F)	;SET
   518	000406'	202304	000000*		MOVEM	T1,DEVRET(F)	;UP
   519	000407'	135300	000400*		LDB	T1,DEYRPS	;DEVRET
   520	000410'	271300	000000*		ADDI	T1,PTRLEN	;AND
   521	000411'	137300	000407*		DPB	T1,DEYRPS	;DEYRPS.
   522	000412'	254000	000417'		JRST	PTRIN6		;
   523
   524				    ;NOT ENOUGH TO FILL DDB.
   525	000413'	271304	000001*	PTRIN4:	ADDI	T1,DEVRBN+1(F)	;SET UP
   526	000414'	202304	000406*		MOVEM	T1,DEVRET(F)	;DEVRET
   527	000415'	201300	000401*		MOVEI	T1,RIBLST	;AND
   528	000416'	137300	000411*		DPB	T1,DEYRPS	;DEYRPS.
   529
   530				    ;TRANSFER THE POINTERS.
   531	000417'	275300	777777*	PTRIN6:	SUBI	T1,PTRLEN-1	;COPY THE
   532	000420'	515306	376000		HRLZI	T1,%RIB(T1)	;POINTERS FROM
   533	000421'	541304	000405*		HRRI	T1,DEVRB1(F)	;THE RIB TO
   534	000422'	251304	000000*		BLT	T1,DEVRBN(F)	;THE DDB.
   535
   536				    ;SET UP DEVSZS AND DEVFLO.
   537	000423'	200300	376000*		MOVE	T1,%RIB+RIBSZS	;SET
   538	000424'	202304	000000*		MOVEM	T1,DEVSZS(F)	;DEVSZS.
   539
   540	000425'	370300	000011		SOS	T1,T4		;GET NEW DEVFLO AS 0,1, ETC.
   541	000426'	200344	000414*		MOVE	T2,DEVRET(F)	;T2/ NO. OF PNTRS AHEAD OF US
   542	000427'	275344	000421*		SUBI	T2,DEVRB1(F)	;IN THE DDB.
   543	000430'	322340	000442'		JUMPE	T2,PTRIN9	;JUMP IF NONE.
   544	000431'	201404	000427*		MOVEI	T3,DEVRB1(F)	;ELSE, COUNT FROM BEGINNING.
   545	000432'	200450	000000	PTRIN7:	MOVE	T4,(T3)		;GET A PREVIOUS PNTR.
   546	000433'	607440	000310*		TLNN	T4,RBSPAR	;ADJUST FLOOR BY
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 12-2
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

   547	000434'	364300	000440'		SOJA	T1,PTRIN8	;ONE OR BY
   548	000435'	274300	376000*		SUB	T1,%RIB+RIBSZS	;A SPARE RIB SIZE.
   549	000436'	363340	000442'		SOJLE	T2,PTRIN9	;MORE PNTRS TO LOOK AT?
   550	000437'	344400	000432'		AOJA	T3,PTRIN7	;YES, ADJUST ADDR TO LOOK AT.
   551	000440'	363340	000442'	PTRIN8:	SOJLE	T2,PTRIN9	;ONCE WE'VE SEEN A DATA PNTR,
   552	000441'	275307	000000		SUBI	T1,(T2)		;REST ARE ALL DATA POINTERS.
   553	000442'	221300	000004	PTRIN9:	IMULI	T1,4		;CONVERT TO BLOCK 1,5,
   554	000443'	271300	000001		ADDI	T1,1		;ETC.
   555	000444'	202304	000151*		MOVEM	T1,DEVFLO(F)	;HERE WHEN DONE.  STORE FLOOR.
   556	000445'	350001	000000		AOS	(P)		;SKIP RETURN.
   557	000446'	263040	000000		POPJ	P,
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 13
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

   558				COMMENT #
   559				@@SUBROUTINE USETST
   560				@@PURPOSE
   561				TO SET UP DDB PNTR AREA SO THAT @DEVRET POINTS TO THE RETRIEVAL
   562				POINTER FOR PAGE N OF THE FILE.  IT IS THE CALLER'S
   563				RESPONSIBILITY TO BE SURE THAT PAGE N IS NOT BEYOND
   564				THE EOF.  THE CALLER MUST ALSO LOCK THE FILE.
   565				THE CALLER MUST NOT ASK USETST FOR PAGE 0 UNLESS THE
   566				FILE IS A NULL FILE.
   567				@@ENTRY
   568				EXPECTS M/ DESIRED LOGICAL PAGE NUMBER, F/ DDB, AND S/ DEVIOS.
   569				MAY HAVE A RIB IN %RIB ON ENTRY.
   570				@@ACCUM
   571				DESTROYS T1-T4, U, PG,
   572				@@EXIT
   573				SEE PURPOSE.
   574				SKIP RETURNS UNLESS ERROR READING A RIB OR BAD PNTRS IN RIB, IN
   575				WHICH CASES IT NON-SKIP RETURNS (HAVING FIRST KILLED THE FILE)
   576				WITH T1/FALRBE.
   577				MAY HAVE A RIB IN %RIB ON EXIT.
   578				ON SUCCESS EXIT, THERE MAY BE A RIB IN %RIB AND THE FILE MAY
   579				BE LOCKED.
   580				@@ #
   581
   582				EXTERN FINDM,FNDADB,MWLRIB,RELRIB,RELRB2
   583
   584	000447'	200004	000002	USETST::MOVE	S,DEVIOS(F)	;IS THE FILE
   585	000450'	603000	000101*		TLNE	S,IOBDRB	;BAD?
   586	000451'	254000	000647'		 JRST	USERFL		;YES.
   587	000452'	322540	000653'		JUMPE	M,USENUL	;SPECIAL STUFF FOR A NULL FILE.
   588	000453'	261040	000014		PUSH	P,P1		;
   589	000454'	261040	000015		PUSH	P,P2		;
   590	000455'	403600	000015		SETZB	P1,P2		;
   591	000456'	337404	000444*		SKIPG	T3,DEVFLO(F)	;IS OUR DDB PNTR AREA VALID?
   592	000457'	254000	000504'		 JRST	USESS2		;NO.
   593
   594				    ;HERE WHEN OUR DDB PNTR AREA IS VALID.
   595				    ;SEE IF WE CAN FIND PAGE N IN OUR DDB.
   596	000460'	200300	000004		MOVE	T1,F		;IS RET PNTR TO PAGE M
   597	000461'	260040	000000*		PUSHJ	P,FINDM		;IN OUR DDB?
   598	000462'	254000	000475'		  JRST	USESS1		;NO.
   599	000463'	326340	000472'		JUMPN	T2,USES04	;MAYBE.  SAW ONLY SPARE RIB?
   600	000464'	262040	000015	USEOUT:	POP	P,P2		;
   601	000465'	262040	000014		POP	P,P1		;
   602	000466'	337450	000000		SKIPG	T4,(T3)		;HERE, UNLESS BAD RET PNTR.
   603	000467'	256000	002056'	RIBBRP:: STOPCD (.,DISK,RIBBRP,RIBERX,<RIB error - Bad Retreival Pointer>);;USEOUT+3
   604	000470'	202404	000426*		MOVEM	T3,DEVRET(F)	;STORE ADDR OF PAG N RET PNTR.
   605	000471'	254000	000350*		JRST	CPOPJ1		;
   606
   607	000472'	200600	000007	USES04:	MOVE	P1,T2		;SAVE SPARE RIB INFO
   608	000473'	201650	000000		MOVEI	P2,(T3)		;FOR BELOW.
   609	000474'	505644	000000		HRLI	P2,(F)		;
   610				    ;PAGE N NOT FOUND IN OUR DDB, OUTPUT OUR DDB IF NECESSARY.
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 13-2
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

   611	000475'	200304	000007	USESS1:	MOVE	T1,DEVIAD(F)	;DO WE NEED TO
   612	000476'	607300	000364*		TLNN	T1,PTRCHG	;OUTPUT OUR DDB PNTRS?
   613	000477'	254000	000504'		 JRST	USESS2		;NO.
   614	000500'	200304	000352*		MOVE	T1,DEVRIB(F)	;YES.  BE SURE WE
   615	000501'	260040	000000*		PUSHJ	P,MWLRIB	;HAVE THE CORRECT RIB IN CORE.
   616	000502'	324740	000644'		  PJRST	USERER		;BAD RIB, KILL THE FILE.
   617	000503'	260040	000363'		PUSHJ	P,PTROU0	;OUTPUT THE PNTRS.
   618
   619				    ;HERE TO LOOK FOR PAGE N IN THE OTHER DDB PNTR AREAS.
   620
   621	000504'	400300	000000	USESS2:	SETZ	T1,		;GET NEXT DDB ON OUR ATB THAT
   622	000505'	260040	000000*	USES22:	PUSHJ	P,FNDADB	;IS VALID.
   623	000506'	254000	000540'		  JRST	USESS3		;NONE LEFT.
   624	000507'	260040	000461*		PUSHJ	P,FINDM		;FOUND ONE. HAS PAGE M?
   625	000510'	254000	000505'		  JRST	USES22		;NO.
   626	000511'	322340	000520'		JUMPE	T2,USES24	;JUMP ON RET PNTR TO PAGE M.
   627	000512'	317600	000007		CAMG	P1,T2		;ELSE, SAVE AWAY
   628	000513'	254000	000505'		 JRST	USES22		;THE BEST
   629	000514'	200600	000007		MOVE	P1,T2		;SPARE RIB
   630	000515'	201650	000000		MOVEI	P2,(T3)		;PNTR WE HAVE FOUND.
   631	000516'	505646	000000		HRLI	P2,(T1)		;
   632	000517'	254000	000505'		JRST	USES22		;TRY ANOTHER DDB.
   633
   634	000520'	515446	000431*	USES24:	HRLZI	T4,DEVRB1(T1)	;COPY ALL THE PNTRS FROM THE
   635	000521'	541444	000520*		HRRI	T4,DEVRB1(F)	;DDB WITH PAGE M'S PNTR
   636	000522'	251444	000422*		BLT	T4,DEVRBN(F)	;TO OUR DDB.
   637	000523'	200446	000424*		MOVE	T4,DEVSZS(T1)	;SET UP THE OTHER DDB LOCS TOO.
   638	000524'	202444	000523*		MOVEM	T4,DEVSZS(F)	;
   639	000525'	200446	000500*		MOVE	T4,DEVRIB(T1)	;
   640	000526'	202444	000525*		MOVEM	T4,DEVRIB(F)	;
   641	000527'	200446	000456*		MOVE	T4,DEVFLO(T1)	;
   642	000530'	202444	000527*		MOVEM	T4,DEVFLO(F)	;
   643	000531'	250300	000004		EXCH	T1,F		;
   644	000532'	135440	000416*		LDB	T4,DEYRPS	;
   645	000533'	250300	000004		EXCH	T1,F		;
   646	000534'	137440	000532*		DPB	T4,DEYRPS	;
   647	000535'	275406	000000		SUBI	T3,(T1)		;SET UP T3 FOR
   648	000536'	271404	000000		ADDI	T3,(F)		;DEVRET.
   649	000537'	254000	000464'		JRST	USEOUT		;
   650
   651				    ;HERE WHEN PAGE N RET PNTR NOT FOUND IN CORE.
   652	000540'	322600	000561'	USESS3:	JUMPE	P1,USESS5	;JUMP IF START AT PRIME RIB.
   653				    ;HERE WHEN WE HAVE IDENTIFIED A SPARE RIB PNTR.
   654	000541'	200455	000000		MOVE	T4,(P2)		;GET T4/SPARE RIB FOR PDL BELOW.
   655	000542'	554300	000015		HLRZ	T1,P2		;T1/ DDB ADDRESS.
   656	000543'	553000	000015		HRRZS	P2		;P2/ ADDR OF SPARE RIB.
   657	000544'	275646	000521*		SUBI	P2,DEVRB1(T1)	;CALC THE
   658	000545'	220640	000014		IMUL	P2,P1		;"DEVFLO" OF THE
   659	000546'	200406	000530*		MOVE	T3,DEVFLO(T1)	;
   660	000547'	275400	000001		SUBI	T3,1		;
   661	000550'	242400	777776		LSH	T3,B2PLSH	;
   662	000551'	270640	000010		ADD	P2,T3		;SPARE RIB, SO WE CAN FIND
   663	000552'	271640	000001		ADDI	P2,1		;
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 13-3
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

   664	000553'	200400	000013		MOVE	T3,M		;OUT HOW MANY PAGES IN WE ARE
   665	000554'	274400	000015		SUB	T3,P2		;WHEN WE JRST INTO THE ROUTINE
   666	000555'	261040	000010		PUSH	P,T3		;BELOW.
   667	000556'	261040	000011		PUSH	P,T4		;SAVE SPARE RIB.
   668	000557'	260040	000076*		PUSHJ	P,RELRIB	;RELEASE ANY RIB WE HAVE.
   669	000560'	254000	000577'		JRST	USES52		;
   670
   671				    ;HERE WHEN WE HAVE TO SEARCH FROM THE PRIME RIB.
   672	000561'	200340	000013	USESS5:	MOVE	T2,M		;
   673	000562'	275340	000001		SUBI	T2,1		;
   674	000563'	261040	000007		PUSH	P,T2		;
   675	000564'	550304	000320*		HRRZ	T1,DEVATB(F)	;T1/ ADDR OF
   676	000565'	200306	000000*		MOVE	T1,ATBRIB(T1)	;PRIME RIB.
   677	000566'	476004	000546*		SETOM	DEVFLO(F)	;INVALIDATE POINTERS, ELSE THERE IS WINDOW
   678								; WHERE DDB POINTER SCANNERS WILL THINK
   679								; THE PTRS ARE FROM THE WRONG RIB.
   680	000567'	202304	000526*		MOVEM	T1,DEVRIB(F)	;
   681	000570'	336360	000000*		SKIPN	T2,@%RIB.C+%CTUPT ;DO WE ALREADY
   682	000571'	254000	000600'		 JRST	USES53		;HAVE THE
   683	000572'	316307	000000*		CAMN	T1,PCBPTR(T2)	;PRIME RIB?
   684	000573'	254000	000611'		 JRST	USES55		;YES.
   685	000574'	261040	000006		PUSH	P,T1		;NO.  SAVE T1 FROM MAPRLS.
   686	000575'	201140	000353*		MOVEI	PG,%RIB.C	;
   687	000576'	260040	000356*		PUSHJ	P,MAPRLS	;RELEASE CURRENT RIB.
   688				      ;LOOK AT THE NEW RIB.
   689	000577'	262040	000006	USES52:	POP	P,T1		;RESTORE T1 FOR MAPWTL.
   690	000600'	201140	000575*	USES53:	MOVEI	PG,%RIB.C	;
   691	000601'	476004	000566*		SETOM	DEVFLO(F)	;INVALIDATE POINTERS NOW, IN CASE SOMEONE
   692								; IS SCANNING DDB PTRS - HE WOULD THINK
   693								; THEY ARE FROM THE WRONG RIB.
   694	000602'	202304	000567*		MOVEM	T1,DEVRIB(F)	;
   695	000603'	260040	000354*		PUSHJ	P,MAPWTL	;GET THE NEW RIB.
   696	000604'	260040	000146'		PUSHJ	P,RIBCON	;CHECK IT.
   697					  JRST	[POP P,T2	;
   698	000605'	254000	002062'			PJRST USERER]	;
   699	000606'	200004	000002		MOVE	S,DEVIOS(F)	;FILE WENT BAD WHILE WE
   700	000607'	603000	000450*		TLNE	S,IOBDRB	;WAITED?
   701					 JRST	[POP P,T2	;YES.
   702	000610'	254000	002064'			JRST USERER]	;
   703	000611'	262040	000007	USES55:	POP	P,T2		;RESTORE T2/ NO. PAGES INTO IT.
   704	000612'	230340	376000*		IDIV	T2,%RIB+RIBSZS	;T2/# SPARE RIB PNTRS, T3/PAGES.
   705	000613'	201447	376000*		MOVEI	T4,%RIB+RIBPFS(T2) ;PRIME RIB PNTRS START AT
   706	000614'	332000	376000*		SKIPE	%RIB+RIBRIB	;RIBPFS, SPARE RIB PNTRS START
   707	000615'	201447	376000*		 MOVEI	T4,%RIB+RIBSFS(T2) ;AT RIBSFS.
   708	000616'	336311	000000		SKIPN	T1,(T4)		;EOF?
   709	000617'	324740	000644'		 PJRST	USERER		;
   710	000620'	607300	000433*		TLNN	T1,RBSPAR	;ARE WE LOOKING AT A SPARE RIB?
   711	000621'	254000	000632'		 JRST	USES58		;NO.
   712	000622'	200340	376000*		MOVE	T2,%RIB+RIBSZS	;YES.
   713	000623'	306340	000001		CAIN	T2,1		;
   714	000624'	256000	000467'		 STOPCD (,XCT,RIBBRP)
   715					;Bad Retrieval Pointer  ;;USES55+13
   716				      ;HERE WHEN WE HAVE TO GO LOOK AT A SPARE RIB.
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 13-4
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

   717	000625'	261040	000010		PUSH	P,T3		;YES, SAVE # PAGES INTO IT
   718	000626'	261040	000006		PUSH	P,T1		;AND SPARE RIB LOC.
   719	000627'	201140	000600*		MOVEI	PG,%RIB.C	;
   720	000630'	260040	000576*		PUSHJ	P,MAPRLS	;RELEASE CURRENT RIB.
   721	000631'	254000	000577'		JRST	USES52		;GO GET NEXT RIB.
   722
   723				      ;HERE WHEN WE EXPECT TO FIND A DATA PNTR IN THIS RIB.
   724	000632'	271450	000000	USES58:	ADDI	T4,(T3)		;GET T3/ REL ADDR-1 OF PNTR
   725	000633'	275440	376001		SUBI	T4,%RIB+1	;IN RIB AND STORE IT
   726	000634'	137440	000534*		DPB	T4,DEYRPS	;IN DEYRPS FOR PTRIN.
   727	000635'	400300	000000		SETZ	T1,		;FLUSH ALL THE DDBS FOR THIS
   728	000636'	260040	000000*		PUSHJ	P,FLUSH		;RIB IN CASE MORE UP TO DATE.
   729	000637'	200440	000013		MOVE	T4,M		;T4/ NEW DEVFLO.
   730	000640'	260040	000400'		PUSHJ	P,PTRINN	;GET THE PNTRS.
   731	000641'	256000	000467'		 STOPCD (,XCT,RIBBRP)
   732					;Bad Retreival Pointer  ;;USES58+7
   733	000642'	200404	000470*		MOVE	T3,DEVRET(F)	;
   734	000643'	254000	000464'		JRST	USEOUT		;
   735
   736				    ;ERROR EXITS.
   737	000644'	262040	000015	USERER:	POP	P,P2		;
   738	000645'	262040	000014		POP	P,P1		;
   739	000646'	324740	000000*		PJRST	KILFIL		;
   740
   741				    ;HERE WHEN SOMEONE ELSE HAS FOUND THE FILE BAD.
   742	000647'	260040	000557*	USERFL:	PUSHJ	P,RELRIB	;
   743	000650'	260040	000000*		PUSHJ	P,RELRB2	;
   744	000651'	201300	000102*		MOVEI	T1,FALRBE	;
   745	000652'	324740	000000*		PJRST	UNLFIL		;
   746
   747				    ;HERE ON ASKED FOR PAGE 0.
   748	000653'	550344	000564*	USENUL:	HRRZ	T2,DEVATB(F)	;BETTER BE A
   749	000654'	135300	000000*		LDB	T1,ATYBSZ	;NULL
   750	000655'	322300	000657'		JUMPE	T1,.+2		;FILE.
   751	000656'	256000	000467'		 STOPCD (,XCT,RIBBRP)
   752					;Bad Retreival Pointer  ;;USENUL+3
   753	000657'	200307	000565*		MOVE	T1,ATBRIB(T2)	;GET THE RIB SO
   754	000660'	202304	000602*		MOVEM	T1,DEVRIB(F)	;WE CAN
   755	000661'	260040	000501*		PUSHJ	P,MWLRIB	;GET RIBSZS.
   756	000662'	324740	000646*		  PJRST	KILFIL		;ERROR RETURN.
   757	000663'	200300	376000*		MOVE	T1,%RIB+RIBSZS	;
   758	000664'	202304	000524*		MOVEM	T1,DEVSZS(F)	;
   759	000665'	205300	000476*		MOVSI	T1,PTRCHG	;
   760	000666'	412304	000007		ANDCAM	T1,DEVIAD(F)	;
   761	000667'	201304	777777*		MOVEI	T1,DEVRB1-1(F)	;
   762	000670'	202304	000642*		MOVEM	T1,DEVRET(F)	;
   763	000671'	201300	000001		MOVEI	T1,1		;
   764	000672'	202304	000601*		MOVEM	T1,DEVFLO(F)	;
   765	000673'	201300	000000*		MOVEI	T1,RIBPFS+PTRLEN-1 ;
   766	000674'	137300	000634*		DPB	T1,DEYRPS	;
   767	000675'	402004	000544*		SETZM	DEVRB1(F)	;
   768	000676'	201304	000001*		MOVEI	T1,DEVRB1+1(F)	;
   769	000677'	505306	777777		HRLI	T1,-1(T1)	;
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 13-5
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

   770	000700'	251304	000522*		BLT	T1,DEVRBN(F)	;
   771	000701'	254000	000471*		JRST	CPOPJ1
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 14
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

   772				;ROUTINES FOR READING AND UPDATING DIRECTORIES
   773
   774				COMMENT ;
   775				@@SUBROUTINE DIRFST
   776				@@PURPOSE
   777				GETS FIRST PAGE OF DIRECTORY INTO CORE FOR THE NAME FOUND IN
   778				DEVNAM(F). DOES APPROPRIATE HASHING
   779				@@ENTRY
   780				FLAGS IN S: IO BLOCKS SHOULD BE WRITE LOCKED (UPDATING)
   781					IOSRIB DIRECTORY RIB IS IN %RB2 (FOR UPDATING)
   782				T1: RIB POINTER TO DIRECTORY RIB
   783				@@ACCUM DESTROYS T1,T2,T3,PG
   784				@@CALLS MAPRDL,RIBCKD,RELLOK,DIRBLK(GETBLK)
   785				@@TABLES SETS RIB POINTER IN DEVFLO(F), CHANGES DEVREL,DEVRIB
   786				USES DEVNAM FOR NAME TO HASH ON
   787				@@RET SKIP RETURN WITH BLOCK LOCKED IN %RIB. NON SKIP RETURN IF
   788				AN ERROR (IOSRBE SET) OR IF NO FIRST BLOCK (NON-REAL POINTER)
   789				ON NON-SKIP RETURN, NO BLOCK LOCKED.
   790				@@;
   791
   792	000702'	476004	000672*	DIRFST::SETOM	DEVFLO(F)	;PROTECT REAL FILE'S USERS.
   793	000703'	603000	000000*		TLNE	S,IOSRIB
   794	000704'	254000	000707'		 JRST	DIRUP2		;WE HAVE THE RIB IN %RB2, NO NEED TO GET IT
   795	000705'	260040	001104'		PUSHJ	P,RIBDR1	;READ RIB, CHECK IT
   796	000706'	254000	000000*		  JRST	RELLOK		;IF SOMETHING WRONG NON-SKIP IOSRBE SET
   797				  ;At this point, the RIB for the directory is in %RIB and has been verified
   798				REPEAT 0,<;Added in /A04, removed in /B01
   799					MOVEI	T1,SPUFDS##	;Check if in special UFDs list
   800				DIRUP0:	SKIPL	T2,(T1)		;Get -size,,addr
   801					 JRST	DIRUP2		;End of list, file in question is not special
   802					MOVE	T3,DEVRIB(F)	;Does current retreival pointer
   803					CAME	T3,(T2)		; match one of the special ones?
   804					 AOJA	T1,DIRUP0	;No
   805					ADDI	T2,1		;Yes, dest is 1 past prime RIB
   806					HLRE	T3,T2		;Get size of block
   807					MOVMS	T3		;Positive length (including 1st word)
   808					ADDI	T3,-2(T2)	;Calculate end of BLT
   809					HRLI	T2,%RIB+RIBPFS	;Source
   810					BLT	T2,(T3)		;Copy the RIB pointers to MFDRIB+1 or SYSRIB+1
   811				>  ;End REPEAT 0
   812				   ;DEVFIL+DEVEXT have the name of the file being looked for.
   813	000707'	200304	000015	DIRUP2:	MOVE	T1,DEVFIL(F)
   814	000710'	621300	400000		TLZ	T1,(1B0)	;CLEAR SIGN BIT BEFORE HASHING
   815	000711'	550340	000000*		HRRZ	T2,STRDDB+STRHSH
   816	000712'	231307	000000		IDIVI	T1,(T2)
   817	000713'	550300	000007		HRRZ	T1,T2		;THE BLOCK TO GET
   818	000714'	476004	000000*		SETOM	DEVFUF(F)	;NO RIB POINTERS
   819	000715'	324740	000727'		PJRST	DIRBLK		;GO GET IT
   820
   821	000716'			SAVSYS:	
   822
   823
   824
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 14-2
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

   825
   826
   827				COMMENT ;
   828				@@SUBROUTINE DIRNXT
   829				@@PURPOSE
   830				GETS NEXT PAGE OF DIRECTORY IF THERE IS ONE. FOLLOWES HASH LINK
   831				@@ENTRY FLAGS IN S IO FOR WRITE LOCK REQUIRED (UPDATING)
   832					IOSRIB IF RIB IN %RB2 (ALSO UPDATING)
   833					PG SET TO %RIB.C
   834				@@ACCUM DESTROYS T1,T2,T3
   835				@@CALLS RELLOK,MAPRDL,RIBCKD,GETBLK
   836				@@TABLES USES RIB PNTR FROM DEVFLO, SETS DEVREL
   837				@@RET SKIP RETURN WITH NEXT BLOCK. NON-SKIP RETURN ON ERROR
   838				(IOSRBE SET) OR NO NEXT BLOCK. NO BLOCK LOCKED ON NON-SKIP
   839				EXCEPT IF UPDATE AND NO NEXT BLOCK, CURRENT STILL LOCKED
   840				@@;
   841
   842	000716'	336300	376000*	DIRNXT::SKIPN	T1,%RIB+UFDLNK	;LINK TO NEXT OVERFLOW PAGE
   843	000717'	254000	001060'		 JRST	UPDRLK		;END OF THIS HASH CHAIN
   844	000720'	202304	000000*		MOVEM	T1,DEVREL(F)	;A GOOD PLACE TO SAVE IT
   845	000721'	260040	000706*		PUSHJ	P,RELLOK
   846	000722'	603000	000703*		TLNE	S,IOSRIB
   847	000723'	254000	000726'		 JRST	DIRUP1		;ALREADY HAVE THE RIB
   848	000724'	260040	001103'		PUSHJ	P,RIBDR2	;READ IT AND CHECK IT
   849	000725'	254000	000721*		  JRST	RELLOK		;ERROR
   850	000726'	200304	000720*	DIRUP1:	MOVE	T1,DEVREL(F)	;RELATIVE PAGE NUMBER
   851					PFALL	DIRBLK
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 15
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

   852				COMMENT ;
   853				@@SUBROUTINE DIRBLK
   854				@@PURPOSE GET BLOCK N OF A FILE
   855				@@ENTRY
   856				EXPECTS DEVATB POINTS TO ATB.
   857				AT ENTRY AT DIRBLK, RIB ALREADY IN %RIB OR %RB2 AND T1/ PAGE
   858				NUMBER (STARTS AT 0).
   859				FLAGS IN S: IO BLOCKS NEED WRITE LOCK FOR UPDATE IOSRBE RIB IN
   860				%RB2 FOR UPDATE. PG SET TO %RIB.C
   861				@@ACCUM DESTROYS T1,T2,T3
   862				@@TABLES
   863				MAY CHANGE DEVREL AND DEVRIB
   864				@@RET SKIP RETURN IF ALL OK. NON-SKIP IF ERROR (IOSRBE SET)
   865				OR BLOCK IS NON-EXISTANT (POSSIBLY NON-REAL PNTR)
   866				@@ ;
   867
   868	000727'	476004	000702*	DIRBLK::SETOM	DEVFLO(F)	;JUST IN CASE.
   869	000730'	331004	000714*		SKIPL	DEVFUF(F)	;IF NO PNTRS IN DDB OR THIS IS
   870	000731'	311304	000730*		CAML	T1,DEVFUF(F)	;EARLIER, DO NOT WORRY
   871	000732'	254000	000750'		 JRST	GETBK1		;ABOUT DDB PNTRS.
   872	000733'	274304	000731*		SUB	T1,DEVFUF(F)
   873	000734'	301300	000410*		CAIL	T1,PTRLEN	;IS DESIRED PNTR IN CORE?
   874					 JRST	[ADD T1,DEVFUF(F)
   875	000735'	254000	002066'			JRST GETBK1]	;NO, READ NEW ONE.
   876	000736'	200340	000006		MOVE	T2,T1
   877	000737'	270304	000733*		ADD	T1,DEVFUF(F)
   878	000740'	271344	000675*		ADDI	T2,DEVRB1(F)
   879	000741'	200347	000000		MOVE	T2,(T2)		;THIS IS THE PNTR
   880	000742'	603340	000620*		TLNE	T2,RBSPAR
   881	000743'	254000	000750'		 JRST	GETBK1		;IN CASE ITS A SPARE RIB PNTR, READ
   882	000744'	607340	000000*		TLNN	T2,RBREAL
   883	000745'	263040	000000		 POPJ	P,
   884	000746'	200300	000007		MOVE	T1,T2
   885	000747'	254000	001020'		JRST	GETBK6		;NOW READ IT
   886
   887	000750'	202304	000737*	GETBK1:	MOVEM	T1,DEVFUF(F)	;THIS IS WHERE PNTRS WILL START NOW
   888	000751'	202304	000726*		MOVEM	T1,DEVREL(F)
   889	000752'	202304	000000*		MOVEM	T1,DEVBLK(F)	;SAVE IT HERRE FOR A WHILE
   890	000753'	603000	000722*	GETBK2:	TLNE	S,IOSRIB
   891	000754'	260040	000000*		 PUSHJ	P,MAPXCH	;INTERCHANGE RB2 AND RIB
   892	000755'	200304	000752*		MOVE	T1,DEVBLK(F)	;GET POSITION BACK
   893	000756'	230300	376000*		IDIV	T1,%RIB+RIBSZS	;DIVIDE BY 1 OR 772
   894	000757'	332000	376000*		SKIPE	%RIB+RIBRIB	;MAY BE SPARE RIB SECOND TIME AROUND
   895	000760'	334406	376000*		 SKIPA	T3,%RIB+RIBSFS(T1);GET PROPER SPARE
   896	000761'	200406	376000*		MOVE	T3,%RIB+RIBPFS(T1);OR PRIME RIB PNTR
   897	000762'	607400	000742*		TLNN	T3,RBSPAR	;IS IT A SPARE RIB PNTR
   898	000763'	254000	000772'		 JRST	GETBK3		;
   899	000764'	202344	000755*		MOVEM	T2,DEVBLK(F)	;SAVE DISTANCE INTO SPARE RIB
   900	000765'	202404	000660*		MOVEM	T3,DEVRIB(F)
   901	000766'	260040	001067'		PUSHJ	P,MAPRXC
   902	000767'	260040	001075'		PUSHJ	P,CRBRWL
   903	000770'	254000	001060'		  JRST	UPDRLK
   904	000771'	254000	000753'		JRST	GETBK2		;NOW CONTINUE IN THE NEW RIB
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 15-2
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

   905
   906	000772'	270300	000007	GETBK3:	ADD	T1,T2		;NO, MOVE A LITTLE MORE
   907	000773'	271300	000311*		ADDI	T1,RIBSFS
   908	000774'	336000	376000*		SKIPN	%RIB+RIBRIB
   909	000775'	271300	000000*		 ADDI	T1,RIBPFS-RIBSFS;ADJUST BACK IF PRIME
   910	000776'	505346	376000		HRLI	T2,%RIB(T1)	;GET SET TO MOVE PNTRS
   911	000777'	541344	000740*		HRRI	T2,DEVRB1(F)
   912	001000'	307300	000000*		CAIG	T1,RIBLST+1-PTRLEN;ARE WE TOO FAR?
   913	001001'	254000	001007'		 JRST	GETBK4		;NO
   914	001002'	201400	000000*		MOVEI	T3,RIBLST+1-PTRLEN
   915	001003'	274400	000006		SUB	T3,T1
   916	001004'	272404	000750*		ADDM	T3,DEVFUF(F)	;DECREASE THIS
   917	001005'	517000	000010		HRLZS	T3
   918	001006'	270340	000010		ADD	T2,T3		;AND ADJUST BLT PNTR
   919	001007'	251344	000700*	GETBK4:	BLT	T2,DEVRBN(F)
   920	001010'	200304	000777*		MOVE	T1,DEVRB1(F)	;
   921	001011'	603300	000744*		TLNE	T1,RBREAL	;NOW CHECK FOR REAL
   922	001012'	254000	001016'		 JRST	GETBK5		;RELEASE RIB AND RETURN IF NOT
   923	001013'	627000	000753*		TLZN	S,IOSRIB	;RESET SO WE KNOW ERROR TYPE
   924	001014'	324740	000725*		 PJRST	RELLOK		;LET GO OF THE RIB
   925	001015'	324740	000754*		PJRST	MAPXCH		;REVERSE MAP
   926
   927	001016'	260040	001067'	GETBK5:	PUSHJ	P,MAPRXC	;EXCHANGE OR RELEASE
   928	001017'	200304	001010*		MOVE	T1,DEVRB1(F)	;GET IT AGAIN
   929	001020'	260040	001063'	GETBK6:	PUSHJ	P,MAPRWL	;EITHER READ OR WRITE LOCK
   930	001021'	260040	000000*		PUSHJ	P,GETER1
   931	001022'	322300	000701*		JUMPE	T1,CPOPJ1
   932	001023'	661000	000000*		TLO	S,IOSRBE	;SET ERROR FLAG
   933	001024'	254000	001014*		JRST	RELLOK		;AND RELEASE
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 16
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

   934				COMMENT ;@@SUBROUTINE DRRBLK
   935				@@PURPOSE GET UFD BLOCK (START IS 0) IN C(T1) IN %RIB.
   936				@@ENTRY UFD RIB IN %RIB, PAGE NUMBER IN C(T1) (START = 0)
   937				@@ACCUM USES T1-T4
   938				@@EXIT NON-SKIP IF GOT AN ERROR TRYING TO GET RETRIEVAL
   939				POINTER TO UFD PAGE OR IF GOT I/O ERROR ON UFD PAGE.
   940				ELSE SKIP RETURN.
   941				@@RESTRICTIONS
   942				@@FUNCTION SCAN RIB STRUCTURE FOR DESIRED PAGE.
   943				@@;
   944
   945				EXTERN SAVE2
   946
   947	001025'	265440	000000*	DRRBLK::JSP	T4,SAVE2
   948	001026'	661000	000020		TLO	S,IO		;GET RIBS WRITE LOCKED
   949	001027'	200600	000006		MOVE	P1,T1		;GET PAGE IN SAVE PLACE
   950
   951	001030'	230600	376000*	DRRBL1:	IDIV	P1,%RIB+RIBSZS	;GET POINTER INDEX IN P1, REM IN P2
   952	001031'	336000	376000*		SKIPN	%RIB+RIBRIB	;SKIP IF SPARE RIB
   953	001032'	334314	376000*		SKIPA	T1,%RIB+RIBPFS(P1) ;PRIME
   954	001033'	200314	376000*		MOVE	T1,%RIB+RIBSFS(P1) ;SPARE
   955	001034'	250600	000015		EXCH	P1,P2		;GET INDEX INTO NEXT RIB IN P1
   956								; AND THIS OFFSET IN P2
   957	001035'	607300	000762*		TLNN	T1,RBSPAR	;THIS A SPARE POINTER?
   958	001036'	254000	001046'		JRST	DRRBL2		;NO, ALMOST HAVE THE POINTER WE WANT.
   959	001037'	200640	000006		MOVE	P2,T1		;SAVE POINTER FROM RELLOK
   960	001040'	260040	001024*		PUSHJ	P,RELLOK	;YES, NEED TO GET THAT RIB.
   961	001041'	200300	000015		MOVE	T1,P2		;GET BACK INTO T1 FOR MAPWTL
   962	001042'	260040	001063'		PUSHJ	P,MAPRWL	;GET NEXT RIB
   963	001043'	260040	001326'		PUSHJ	P,RBRCK1	;CHECK IT QUICK
   964	001044'	324740	001040*		  PJRST	RELLOK		;NO GOOD, GET RID OF IT AND ERROR RETURN.
   965	001045'	254000	001030'		JRST	DRRBL1		;AND TRY NEXT LEVEL.
   966
   967	001046'	270600	000015	DRRBL2:	ADD	P1,P2		;GET LOCATION OF POINTER IN P1
   968	001047'	332000	376000*		SKIPE	%RIB+RIBRIB
   969	001050'	334614	376000*		SKIPA	P1,%RIB+RIBSFS(P1) ;SPARE RIB PTR
   970	001051'	200614	376000*		MOVE	P1,%RIB+RIBPFS(P1) ;PRIME RIB PTR
   971	001052'	260040	001044*		PUSHJ	P,RELLOK
   972	001053'	200300	000014		MOVE	T1,P1		;GET INTO T1
   973	001054'	260040	001063'		PUSHJ	P,MAPRWL	;GET UFD PGE WRITE LOCKED
   974	001055'	260040	001021*		PUSHJ	P,GETER1	;I/O ERRORS?
   975	001056'	322300	001022*		JUMPE	T1,CPOPJ1	;IF NOT, HAVE IT!
   976	001057'	324740	001052*		PJRST	RELLOK		;SORRY, ITS BAD.
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 17
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

   977	001060'	607000	001013*	UPDRLK:	TLNN S,IOSRIB
   978	001061'	324740	001057*		PJRST RELLOK	;DO NOT RELEASE IF WRITE LOCK, ONLY READ
   979	001062'	263040	000000		POPJ P,
   980
   981	001063'	201140	000627*	MAPRWL::MOVEI	PG,%RIB.C	;MAKE SURE
   982	001064'	607000	000020		TLNN S,IO
   983	001065'	254000	000000*		 JRST MAPRDL	;READ LOCK
   984	001066'	254000	000603*		JRST MAPWTL	;OR WRITE LOCK
   985
   986
   987	001067'	603000	001060*	MAPRXC:	TLNE S,IOSRIB
   988	001070'	324740	001015*		PJRST MAPXCH
   989	001071'	261040	000006		PUSH P,T1
   990	001072'	260040	000630*		PUSHJ P,MAPRLS
   991	001073'	254000	000000*		JRST TPOPJ
   992
   993				;READ OR WRITE LOCK CURRENT RIB
   994
   995	001074'	260040	001061*	CRBRWR:	PUSHJ P,RELLOK
   996	001075'	200304	000765*	CRBRWL::MOVE T1,DEVRIB(F)
   997	001076'	260040	001063'		PUSHJ P,MAPRWL		;READ RIB
   998	001077'	324740	001137'		PJRST RIBCK1		;CHECK IT FOR CONSISTANCY
   999
  1000
  1001
  1002
  1003				;SUBRS TO GET A RIB INTO %RIB AND CHECK IT.  RIBDIR ALSO
  1004				;INVALIDATES THE DDB.
  1005
  1006	001100'	476004	000727*	RIBDIR::SETOM	DEVFLO(F)
  1007	001101'	476004	001004*		SETOM	DEVFUF(F)
  1008	001102'	334317	000000*		SKIPA	T1,DRBRIB(P4)
  1009	001103'	334304	001075*	RIBDR2:	 SKIPA	T1,DEVRIB(F)	;Entry from DIRBLK, DEVRIB set
  1010	001104'	202304	001103*	RIBDR1:	MOVEM	T1,DEVRIB(F)	;From DIRFST, set DEVRIB
  1011	001105'	260040	001063'		PUSHJ	P,MAPRWL	;READ OR WRITE LOCK
  1012	001106'	324740	001122'		PJRST	RIBCKD		;AND CHECK CONSISTANCY
  1013
  1014	001107'	625000	000020	RIBRDL::TLZA	S,IO
  1015	001110'	661000	000020	RIBWTL:: TLO	S,IO
  1016	001111'	550304	000653*		HRRZ	T1,DEVATB(F)
  1017	001112'	200306	000657*		MOVE	T1,ATBRIB(T1)
  1018	001113'	261044	001104*	RBBRWL:	PUSH	P,DEVRIB(F)
  1019	001114'	202304	001113*		MOVEM	T1,DEVRIB(F)	;FOR PRMCHK
  1020	001115'	260040	001063'		PUSHJ	P,MAPRWL
  1021	001116'	260040	001230'		PUSHJ	P,PRMCHK
  1022					 JRST	[POP P,DEVRIB(F)
  1023	001117'	254000	002070'			JRST RELLOK]
  1024	001120'	262044	001114*		POP	P,DEVRIB(F)
  1025	001121'	254000	001056*		JRST	CPOPJ1
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 18
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

  1026				;THESE ROUTINES CHECK FOR RIB CONSISTANCY
  1027
  1028				;RIBCKD - CHECK FOR A RIB FOR VALID DIRECTORY (A UFD OR THE MFD)
  1029				; NON-SKIP RETURN IF ERROR
  1030				; SKIP RETURN IF ALL OK
  1031
  1032	001122'	260040	001055*	RIBCKD::PUSHJ	P,GETER1	;Get I/O status of this PCB page
  1033	001123'	326300	001200'		JUMPN	T1,RIBHRE	;Hardware read error while reading RIB
  1034	001124'	200300	376000*		MOVE	T1,%RIB+RIBSTS	;
  1035	001125'	602300	000000*		TRNE	T1,RIPBDR	;Check if known bad RIB
  1036	001126'	254000	001205'		 JRST	RIBER1		;FLAG S, ALREADY LOGGED.
  1037	001127'	120300	376000*		DMOVE	T1,%RIB+RIBPPN	;T1 GETS PPN, T2 NAME
  1038	001130'	316300	000000*		CAMN	T1,MFDPPN
  1039	001131'	312344	000017		CAME	T2,DEVPPN(F)	;FILE NAME SHOULD MATCH DEVPPN
  1040	001132'	254000	001167'		 JRST	RIBERS		;INCONSISTANT
  1041	001133'	554300	376000*		HLRZ	T1,%RIB+RIBEXT
  1042	001134'	302300	654644		CAIE	T1,'UFD'	;ALL DIRECTORIES ARE 'UFD'
  1043	001135'	254000	001167'		 JRST	RIBERS
  1044	001136'	254000	001146'		JRST	RIBCK2		;CHECK FILE STUFF
  1045
  1046
  1047				;RIBCK1 WILL CHECK ANY RIB, PRIME OR SPARE. BETTER CHECKS CAN
  1048				;BE APPLIED IF SOMETHING MORE IS KNOWN ABOUT THE RIB
  1049
  1050	001137'	260040	001122*	RIBCK1:	PUSHJ	P,GETER1	;Get I/O status for this PCB page
  1051	001140'	326300	001200'		JUMPN	T1,RIBHRE	;Hardware read error while reading RIB
  1052	001141'	332000	376000*		SKIPE	%RIB+RIBRIB	;PRIME RIB?
  1053	001142'	254000	001146'		 JRST	RIBCK2		;NO
  1054	001143'	200300	376000*		MOVE	T1,%RIB+RIBSTS
  1055	001144'	602300	001125*		TRNE	T1,RIPBDR	;Check if known bad RIB
  1056	001145'	254000	001205'		 JRST	RIBER1		;FLAG S, ALREADY LOGGED.
  1057
  1058				;Now check RIBCOD, RIBSLF, RIBSZS, RIBSNM
  1059
  1060	001146'	205300	001035*	RIBCK2:	MOVSI	T1,RBSPAR	;
  1061	001147'	412304	001120*		ANDCAM	T1,DEVRIB(F)	;
  1062	001150'	120300	376000*		DMOVE	T1,%RIB+RIBCOD	;T1 GETS COD, T2 SELF
  1063	001151'	316344	001147*		CAMN	T2,DEVRIB(F)
  1064	001152'	302300	000335*		CAIE	T1,CODRIB
  1065	001153'	254000	001167'		 JRST	RIBERS		;Bad COD or bad SELF pointer
  1066	001154'	200300	376000*		MOVE	T1,%RIB+RIBSZS
  1067	001155'	302300	000001		CAIE	T1,1		;Primary RIB only?
  1068	001156'	254000	001162'		 JRST	RIBCK3		;No, check multi-RIB's
  1069	001157'	332000	376000*		SKIPE	%RIB+RIBSNM	;If RIBSZS=1, should be no spare RIBs
  1070	001160'	254000	001167'		 JRST	RIBERS		;There are, give error
  1071	001161'	254000	001121*		JRST	CPOPJ1		;No spares, give good return
  1072
  1073	001162'	336000	376000*	RIBCK3:	SKIPN	%RIB+RIBSNM	;If RIBSZS .gt. 1, RIBSNM better be .gt. 0
  1074	001163'	254000	001167'		 JRST	RIBERS		;Inconsistent, give error
  1075	001164'	302300	000000*		CAIE	T1,ONELVL	;Must be either 772
  1076	001165'	306300	000245*		CAIN	T1,TWOLVL	; or 764044
  1077	001166'	254000	001161*		 JRST	CPOPJ1
  1078
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 18-2
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

  1079				    ;HERE ON SOFTWARE RIB ERROR (OR UNDETECTED HARDWARE WRITE ERROR).
  1080
  1081	001167'	200304	001151*	RIBERS:	MOVE	T1,DEVRIB(F)	;GET WHAT RIB IS SUPPOSED TO BE
  1082	001170'	316300	001247'		CAMN	T1,LBDRIB	;SAME AS LAST ONE?
  1083	001171'	254000	001205'		 JRST	RIBER1		;YES, DON'T COUNT AGAINST THE SYSTEM
  1084	001172'	202300	001247'		MOVEM	T1,LBDRIB	;NO, REMEMBER NEW RIB AND
  1085	001173'	256000	002072'	RIBERR:: STOPCD (.,EVENT,RIBERR,RIBERX,<RIB error - software detected>)
  1086	001174'	350300	001246'		AOS	T1,LBDCNT	;ONE MORE RIB ERROR WITHOUT I/O ERROR
  1087	001175'	311300	001250'		CAML	T1,LBDMAX	;IS IT TIME TO CRASH?
  1088	001176'	256000	002076'		 STOPCD (.,DISK,RIBTME,DSKDIE##,<Too Many RIB errors - disk is unsafe>);;RIBERR+6
  1089
  1090				    ;HERE ON MAYBE FIRST DISCOVERY OF A BAD RIB.  LOG IT.
  1091				    ;Jump to RIBHRE if got Hard Read Error trying to read RIB from disk.
  1092
  1093	001177'	334000	000000		SKIPA			;RIBERS outputs stopcode RIBERR
  1094	001200'	256000	002102'	RIBHRE:: STOPCD (.,EVENT,RIBHRE,RIBERX,<RIB error - Hard Read Error>)
  1095	001201'	201300	000000*		MOVEI	T1,UNPRER
  1096	001202'	135240	000000*		LDB	U,RBYUNV	;GET UNIT FIELD
  1097	001203'	200245	000000*		MOVE	U,UNTTBL(U)	;AND GET A POINTER TO UNIT DATA BLOCK
  1098	001204'	272305	000000*		ADDM	T1,UNIMCT(U)	;COUNT RIB ERRORS ON THIS UNIT
  1099
  1100				    ;HERE TO ERROR RETURN.
  1101
  1102	001205'	670000	002106'	RIBER1:	TDO	S,[IOSRBE,,IOIMPM] ;SET ERROR BITS.
  1103	001206'	202004	000002		MOVEM	S,DEVIOS(F)	;AND MAKE SURE STORED
  1104	001207'	263040	000000		POPJ	P,
  1105
  1106				    ;Routine to output more info on RIBERR stopcodes
  1107
  1108	001210'	260040	000000*	RIBERX:	PUSHJ	P,INLMES##	;F points to DDB
  1109	001211'	512230	220312		 ASCIZ /RIB error in /
	001212'	713455	771100
	001213'	647344	000000
  1110	001214'	260040	000000*		PUSHJ	P,PRTDDB##	;DEV:(USERNAME)FILE.EXT[P,PN]
  1111	001215'	260040	001210*		PUSHJ	P,INLMES##
  1112	001216'	203375	620000		 ASCIZ / on /
  1113	001217'	135300	001202*		LDB	T1,RBYUNV##	;Get disk unit part of DEVRIB(F)
  1114	001220'	200246	001203*		MOVE	U,UNTTBL(T1)	;Point to the CB
  1115	001221'	200345	000000*		MOVE	T2,UNILOG##(U)	;Get DSKB logical name
  1116	001222'	260040	000000*		PUSHJ	P,PRNAME##	;Print unit
  1117	001223'	260040	001215*		PUSHJ	P,INLMES##
  1118	001224'	351016	060716		 ASCIZ	/: page /
	001225'	625000	000000
  1119	001226'	135300	000000*		LDB	T1,RBYPNV##	;Get disk page number part of DEVRIB(F)
  1120	001227'	324740	000000*		PJRST	PRT22A##	;Print page address (6 or 7 octal digits)
  1121
  1122				;PRMCHK CHECKS A PRIME RIB FOR A FILE
  1123				; NON-SKIP RETURN IF ERROR
  1124				; SKIP RETURN IF OK
  1125
  1126	001230'	260040	001137*	PRMCHK::PUSHJ	P,GETER1	;Get I/O status for this PCB
  1127	001231'	326300	001200'		JUMPN	T1,RIBHRE	;Hardware read error on spare RIB
  1128	001232'	200300	376000*		MOVE	T1,%RIB+RIBSTS	;
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 18-3
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

  1129	001233'	602300	001144*		TRNE	T1,RIPBDR	;Check if known bad RIB
  1130	001234'	254000	001205'		 JRST	RIBER1		;FLAG S, ALREADY LOGGED.
  1131	001235'	120300	376000*		DMOVE T1,%RIB+RIBPPN	;PPN TO T1, NAME TO T2
  1132	001236'	316304	000017		CAMN T1,DEVPPN(F)
  1133	001237'	312344	000015		CAME T2,DEVFIL(F)
  1134	001240'	254000	001167'		 JRST RIBERS		;PPN or name does not match
  1135	001241'	510304	000016		HLLZ T1,DEVEXT(F)
  1136	001242'	510340	376000*		HLLZ T2,%RIB+RIBEXT
  1137	001243'	312300	000007		CAME T1,T2
  1138	001244'	254000	001167'		 JRST RIBERS		;Extension does not match
  1139	001245'	254000	001146'		JRST RIBCK2
  1140
  1141	001246'	000000	000000	LBDCNT::	0		;COUNT OF BAD RIBS
  1142	001247'	000000	000000	LBDRIB::	0		;LAST BAD RIB SEEN - IF CHANGES, INCREMENT LBDCNT
  1143	001250'	000000	000062	LBDMAX::	^D50		;AFTER FIFTY DIFFERENT RIB ERRORS, CRASH
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 19
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

  1144				COMMENT ;@@SUBROUTINE UFRCHK
  1145				@@PURPOSE CHECK A UFD RIB AGAINS FILSER CORE BLOCKS
  1146				@@ENTRY UFD RIB IN %RIB
  1147				ATB ADDRESS IN P2
  1148				@@ACCUM USES T1-T4.
  1149				@@RESTRICTIONS DRB COUNT MUST STILL BE UP FOR UFD SO UFD RIB
  1150				 DOESN'T GO AWAY
  1151				@@FUNCTION CHECK FOR READ/WRITE ERRORS ON PCB PAGE, ERROR
  1152				IF SO. MAKE SURE NO RIB ERROR ON RIB ALREADY, ERROR IF SO.
  1153				CHECK RIBPPN AGAINST MFDPPN RIBNAM AGAINST DRBNAM, ERROR
  1154				IF NO MATCH ON EITHER. MAKE SURE RIBEXT IS UFD. IF ALL IS OK,
  1155				PJRST TO RBRCK2 TO DO CHECKING THAT IS COMMON TO ALL RIBS.
  1156				@@;
  1157
  1158				EXTERNAL ATBFNB,DRBNAM,FNBDRB,FNBEXT,FNBNAM
  1159				EXTERNAL SAVE1
  1160
  1161	001251'	265440	000000*	UFRCHK::JSP	T4,SAVE1	;PUT DRB ADDR IN P1
  1162	001252'	550615	000000*		HRRZ	P1,ATBFNB(P2)	;FNB
  1163	001253'	550614	000000*		HRRZ	P1,FNBDRB(P1)	;DRB
  1164	001254'	260040	001230*		PUSHJ	P,GETER1	;GET ERRORS AFTER REFERENCING THE RIB
  1165	001255'	326300	001301'		JUMPN	T1,UFRER0	;Read error - can't read RIB for this UFD
  1166	001256'	201300	001233*		MOVEI	T1,RIPBDR	;THIS RIB ANY GOOD?
  1167	001257'	612300	376000*		TDNE	T1,%RIB+RIBSTS	;Check if known bad RIB
  1168	001260'	263040	000000		 POPJ	P,		;KNOWN BAD, DON'T COUNT ANOTHER RIB ERROR.
  1169	001261'	120340	000000*		DMOVE	T2,%RIB+RIBPPN+<RIBNAM*0> ;GET PPN AND NAM
  1170	001262'	316340	001130*		CAMN	T2,MFDPPN	;PPN MUST BE ONE FOR MFD.
  1171	001263'	312414	000000*		CAME	T3,DRBNAM(P1)	;IF SOMETHING DOESNT MATCH
  1172	001264'	254000	001301'		 JRST	UFRER0		;COUNT A RIB ERROR
  1173	001265'	554300	376000*		HLRZ	T1,%RIB+RIBEXT	;UFD MUST BE EXTENSION
  1174	001266'	302300	654644		CAIE	T1,'UFD'
  1175	001267'	254000	001301'		 JRST	UFRER0		;NO GOOD, BOMB.
  1176	001270'	120300	000000*		DMOVE	T1,%RIB+RIBCOD!<RIBSLF*0>
  1177	001271'	306300	001152*		CAIN	T1,CODRIB	;MAGIC NUMBER
  1178	001272'	312354	001102*		CAME	T2,DRBRIB(P1)	;AND POINTER TO SELF MUST BE OK
  1179	001273'	254000	001301'		 JRST	UFRER0		;NOT.
  1180	001274'	200300	376000*		MOVE	T1,%RIB+RIBSZS	;GET LEVEL
  1181	001275'	362300	001166*		SOJE	T1,CPOPJ1	;IF 1, OK.
  1182	001276'	302300	777777*		CAIE	T1,ONELVL-1
  1183	001277'	306300	777777*		CAIN	T1,TWOLVL-1
  1184	001300'	254000	001275*		 JRST	CPOPJ1		;ONLY THESE 3 VALUES ARE OK.
  1185
  1186	001301'	135240	000000*	UFRER0:	LDB	U,RBYUNR	;
  1187	001302'	324740	001347'		PJRST	RBRER1		;
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 20
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

  1188				COMMENT ;@@SUBROUTINE PRRCHK
  1189				@@PURPOSE CHECK A PRIME RIB (FILE OR DIRECTORY)
  1190				AGAINST FILSER CORE BLOCKS.
  1191				@@ENTRY RIB IN %RIB
  1192				ATB ADDRESS IN P2
  1193				@@ACCUM USES T1-T4
  1194				@@EXIT NON-SKIP IF RIB IS NOT GOOD, WITH RIB RELEASED.
  1195				ELSE SKIP IF RIB IS GOOD, RIB STILL IN %RIB.
  1196				@@RESTRICTIONS
  1197				@@FUNCTION CHECK RIB FOR I/O ERRORS, COUNT A RIB ERROR IN
  1198				UNIT DATA BLOCK IF FIND SOME. IF BAD RIB BIT IS ON,
  1199				OR ATBRIB IS NOW ZERO (SOMEONE DELETED FILE'S RIB
  1200				WHILE WE WERE WAITING FOR RIB PCB) JUST RETURN AND RELEASE
  1201				THE RIB, SINCE IF ITS MARKED, DON'T COUNT IT AGAIN, AND
  1202				IF ATBRIB GOES AWAY, ITS NOT A REAL RIB ERROR.
  1203				IF OK SO FAR, CHECK RIB AGAINST FNBNAM, FNBEXT, DRBNAM.
  1204				IF OK, GO CHECK RIBCOD, RIBSLF, ETC.
  1205				@@;
  1206
  1207	001303'	260040	001254*	PRRCHK::PUSHJ	P,GETER1	;I/O ERRORS FIRST
  1208	001304'	326300	001346'		JUMPN	T1,RBRER0	;THERE ARE SOME, LOG AND RETURN
  1209	001305'	201300	001256*		MOVEI	T1,RIPBDR
  1210	001306'	616300	376000*		TDNN	T1,%RIB+RIBSTS	;IF RIB ALREADY MARKED BAD OR
  1211	001307'	336015	001112*		SKIPN	ATBRIB(P2)	;HAS DISAPPEARED
  1212	001310'	324740	001074*		 PJRST	RELLOK		;GIVE IT UP AND RETURN.
  1213	001311'	550315	001252*		HRRZ	T1,ATBFNB(P2)	;GET FNB ADDRESS
  1214	001312'	200340	376000*		MOVE	T2,%RIB+RIBNAM	;DOES FILE NAME MATCH
  1215	001313'	312346	000000*		CAME	T2,FNBNAM(T1)	;IF NOT,
  1216	001314'	324740	001346'		 PJRST	RBRER0		;LOG AND RETURN.
  1217	001315'	514406	000000*		HRLZ	T3,FNBEXT(T1)	;GET EXTENSION
  1218	001316'	510340	376000*		HLLZ	T2,%RIB+RIBEXT
  1219	001317'	312340	000010		CAME	T2,T3		;THIS MATCHES?
  1220	001320'	324740	001346'		 PJRST	RBRER0		;NO, LOG BAD RIB AND RETURN.
  1221	001321'	550306	001253*		HRRZ	T1,FNBDRB(T1)	;GET DRB ADDRESS NOW
  1222	001322'	200306	001263*		MOVE	T1,DRBNAM(T1)	;GET PPN OF FILE
  1223	001323'	312300	376000*		CAME	T1,%RIB+RIBPPN	;IF MATCH,
  1224	001324'	324740	001346'		 PJRST	RBRER0		;LOG AND RETURN
  1225	001325'	254000	001335'		JRST	RBRCK2		;GO DO COMMON CHECKS.
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 21
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

  1226				;CHECK RIB
  1227	001326'	260040	001303*	RBRCK1:	PUSHJ	P,GETER1	;GET ERROR BITS
  1228	001327'	326300	001346'		JUMPN	T1,RBRER0	;GO COUNT IF I/O ERRORS
  1229	001330'	332000	376000*		SKIPE	%RIB+RIBRIB
  1230	001331'	254000	001335'		 JRST	RBRCK2		;NOT PRIME, NO RIBSTS
  1231	001332'	201300	001305*		MOVEI	T1,RIPBDR
  1232	001333'	612300	376000*		TDNE	T1,%RIB+RIBSTS	;BAD ALREADY?
  1233	001334'	324740	001310*		 PJRST	RELLOK		;YES, GET RID OF IT AND ERROR RETURN.
  1234
  1235	001335'	120300	000000*	RBRCK2:	DMOVE	T1,%RIB+RIBCOD!<RIBSLF*0>
  1236	001336'	316355	001307*		CAMN	T2,ATBRIB(P2)	;RIBSLF MATCH POINTER?
  1237	001337'	302300	001271*		CAIE	T1,CODRIB	;AND RIBCOD IS MAGIC NUMBER?
  1238	001340'	324740	001334*		 PJRST	RELLOK		;NO, GIVE THING UP AND ERROR RETURN.
  1239	001341'	200300	376000*		MOVE	T1,%RIB+RIBSZS	;GET SIZE THAT POINTER REPRESENTS
  1240	001342'	362300	001300*		SOJE	T1,CPOPJ1	;MADE IT!
  1241	001343'	302300	777777*		CAIE	T1,ONELVL-1
  1242	001344'	306300	777777*		CAIN	T1,TWOLVL-1	;MUST BE THESE 3 VALUES
  1243	001345'	254000	001342*		 JRST	CPOPJ1		;OK.
  1244
  1245				;HERE TO LOG RIB ERROR IN A UNIT DATA BLOCK. ATB ADDRESS IN P2.
  1246				; ENTER AT RBRER1 WITH UNIT NUMBER WITHIN STR IN U.
  1247
  1248	001346'	135240	000000*	RBRER0:	LDB	U,RBYUNA	;
  1249	001347'	200245	001220*	RBRER1:	MOVE	U,UNTTBL(U)	;GET UDB ADDRESS.
  1250	001350'	201300	001201*		MOVEI	T1,UNPRER	;RIB ERROR BIT
  1251	001351'	272305	001204*		ADDM	T1,UNIMCT(U)
  1252	001352'	256000	001173'		 STOPCD (,XCT,RIBERR);;RIBER1+3 ;Let OPR know about it
  1253	001353'	324740	001340*		PJRST	RELLOK		;GIVE UP BAD RIB AND RETURN.
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 22
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

  1254				;SUBR TO SET UP THE DDB FOR THE START OF A NULL FILE.
  1255				;(AVOIDS UNNECESSARY READ OF RIB.).
  1256
  1257				INTERN ZERDDB
  1258
  1259	001354'	402004	001017*	ZERDDB:	SETZM	DEVRB1(F)	;CLEAR
  1260	001355'	201304	000001*		MOVEI	T1,DEVRB1+1(F)	;THE
  1261	001356'	505306	777777		HRLI	T1,-1(T1)	;DDB PNTR
  1262	001357'	251304	001007*		BLT	T1,DEVRBN(F)	;AREA.
  1263	001360'	200315	001336*		MOVE	T1,ATBRIB(P2)
  1264	001361'	202304	001167*		MOVEM	T1,DEVRIB(F)	;SET RIB POINTER
  1265	001362'	201340	000000*		MOVEI	T2,RIBPFS+PTRLEN-1 ;SET RIBRPS
  1266	001363'	137340	000674*		DPB	T2,DEYRPS	;HERE.
  1267	001364'	551344	777777*		HRRZI	T2,DEVRB1-1(F)	;SET DEVRET
  1268	001365'	552344	000670*		HRRZM	T2,DEVRET(F)	;HERE.
  1269	001366'	201300	000001		MOVEI	T1,1
  1270	001367'	202304	001100*		MOVEM	T1,DEVFLO(F)
  1271	001370'	202304	000664*		MOVEM	T1,DEVSZS(F)
  1272	001371'	254000	001376'		JRST	INVDD2		;
  1273
  1274				    ;SUBR TO INVALIDATE THE DDB AND SET FILE LOC TO START.
  1275
  1276				INTERN INVDDB
  1277
  1278	001372'	476004	001367*	INVDDB:	SETOM	DEVFLO(F)
  1279	001373'	550304	001111*		HRRZ	T1,DEVATB(F)	;
  1280	001374'	200306	001360*		MOVE	T1,ATBRIB(T1)	;
  1281	001375'	202304	001361*		MOVEM	T1,DEVRIB(F)	;
  1282	001376'	200300	002107'	INVDD2:	MOVE	T1,[XWD 400000,1]
  1283	001377'	202304	000000*		MOVEM	T1,DEVPOS(F)
  1284	001400'	205300	000665*		MOVSI	T1,PTRCHG
  1285	001401'	412304	000007		ANDCAM	T1,DEVIAD(F)	;CLEAR CHANGED FLAG
  1286	001402'	263040	000000		POPJ	P,
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 23
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

  1287				;ROUTINE TO DELETE ALL THE PAGES IN A FILE, AND ALL THE RIBS.
  1288				;ENTERED WITH PRIME RIB IN %RIB.
  1289				;ASSUMES CALLER IS ONLY USER OF FILE.
  1290				;SKIP RETURNS IF DELETE WAS SUCCESSFUL, ELSE NON-SKIP RETURNS.
  1291				;IN EITHER CASE, HAS NO RIB IN %RIB ON EXIT.
  1292
  1293				INTERNAL DLTALL
  1294
  1295	001403'	200004	000002	DLTALL:	MOVE	S,DEVIOS(F)	;IF THE FILE IS BAD,
  1296	001404'	603000	000607*		TLNE	S,IOBDRB	;DON'T DARE
  1297	001405'	324740	000647*		 PJRST	RELRIB		;BELIEVE RET PNTRS.
  1298	001406'	661000	000020		TLO	S,IO		;JUST IN CASE.
  1299	001407'	332340	376000*		SKIPE	T2,%RIB+RIBELB
  1300	001410'	202344	000000*		MOVEM	T2,DEVELB(F)	;SO IT IS NOT RETURNED
  1301	001411'	261040	000014		PUSH	P,P1		;
  1302	001412'	400600	000000		SETZ	P1,		;
  1303	001413'	260040	001423'		PUSHJ	P,DELRIB
  1304					  JRST	[POP P,P1	;ERROR, RIB IS ALREADY
  1305	001414'	254000	002110'			POPJ P,]	;RELEASED.
  1306	001415'	262040	000014		POP	P,P1		;SUCCESS RETURN.
  1307	001416'	350001	000000		AOS	(P)
  1308	001417'	260040	001574'		PUSHJ	P,FREUP
  1309	001420'	200340	376000*		MOVE	T2,%RIB+RIBSLF
  1310	001421'	260040	000075*		PUSHJ	P,GIVPAG
  1311	001422'	324740	001353*		PJRST	RELLOK
  1312
  1313				;ROUTINE THAT DELETES EVERYTHING IN A FILE AFTER A GIVEN POINT.
  1314				; DECREMENTS P1 FOR EVERY PAGE OF THE FILE AND EVERY RIB GIVEN
  1315				; AWAY, NOT INCLUDING HOLES.
  1316	001423'	332000	376000*	DELRIB:	SKIPE %RIB+RIBRIB
  1317	001424'	334440	002112'		 SKIPA T4,[-RBLVSP,,RIBSFS]	;AOBJN PTR TO SPARE
  1318	001425'	200440	002113'		MOVE T4,[-RBLVPR,,RIBPFS]	;OR PRIME
  1319	001426'	335311	376000	DLTRBC:	SKIPGE T1,%RIB(T4)	;GET NEXT. IS IT SPARE?
  1320	001427'	254000	001530'		 JRST DLTSRB		;YES, SPECIAL
  1321	001430'	322300	001502'		JUMPE T1,DLTRBD		;REALLY NONE THERE
  1322	001431'	261040	000011		PUSH P,T4		;SAVE AOBJN PNTR
  1323	001432'	261040	000011	DLTRB3:	PUSH P,T4	;SAVE AGAIN FOR SORT
  1324	001433'	201400	000000		MOVEI T3,0		;LARGEST SO FAR
  1325	001434'	336311	376000	DLTRB0:	SKIPN T1,%RIB(T4)	;POSSIBLY AT END
  1326	001435'	254000	001446'		 JRST DLTRB1		;YES, END OF THIS PASS OF SEARCH
  1327	001436'	607300	001011*		TLNN T1,RBREAL
  1328	001437'	254000	001445'		 JRST DLTRB2		;NOT REAL, IGNORE
  1329	001440'	621300	000000*		TLZ T1,RBMASK		;GET RID OF EXTRA BITS
  1330	001441'	317300	000010		CAMG T1,T3
  1331	001442'	254000	001445'		 JRST DLTRB2		;NOT BIGGER
  1332	001443'	200400	000006		MOVE T3,T1
  1333	001444'	200340	000011		MOVE T2,T4
  1334	001445'	253440	001434'	DLTRB2:	AOBJN T4,DLTRB0	;CONTINUE SEARCH
  1335	001446'	262040	000011	DLTRB1:	POP P,T4		;THIS IS WHERE BIGGEST GOES
  1336	001447'	322400	001545'		JUMPE T3,DLTRSZ		;NONE FOUND, SEARCH DONE
  1337	001450'	200407	376000		MOVE T3,%RIB(T2)
  1338	001451'	250411	376000		EXCH T3,%RIB(T4)	;INTERCHANGE
  1339	001452'	202407	376000		MOVEM T3,%RIB(T2)
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 23-2
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

  1340	001453'	253440	001432'		AOBJN T4,DLTRB3		;CONTINUE SORTING
  1341	001454'	200441	000000	DLTRSD:	MOVE T4,(P)		;SEARCH ALL DONE
  1342	001455'	336351	376000		SKIPN	T2,%RIB(T4)	;GET FIRST POINTER TO DELETE
  1343	001456'	254000	001465'		 JRST	DLTRG1		;
  1344	001457'	402011	376000		SETZM	%RIB(T4)	;
  1345	001460'	360600	001461'		SOJ	P1,.+1		;COUNT ONE PAGE LESS.
  1346	001461'	621340	000000*		TLZ T2,RBMASK-RBREAL
  1347	001462'	316344	001410*		CAMN T2,DEVELB(F)	;IS THIS THE BAD PAGE?
  1348	001463'	260040	001555'		 PUSHJ	P,DLTBAD	;YES, CLEAN UP & SKIP OVER GIVPGK.
  1349	001464'	260040	000000*		PUSHJ P,GIVPGK		;GIVE UP BUT KEEP SAT
  1350	001465'	262040	000011	DLTRG1:	POP P,T4
  1351	001466'	252440	001501'		AOBJP T4,DLTRBG		;DONE, ALL GIVEN BACK
  1352	001467'	336351	376000		SKIPN T2,%RIB(T4)	;IF EOF
  1353	001470'	254000	001501'		 JRST DLTRBG		;ALL DONE
  1354	001471'	402011	376000		SETZM	%RIB(T4)	;
  1355	001472'	360600	001473'		SOJ	P1,.+1		;COUNT ONE PAGE LESS.
  1356	001473'	621340	000000*		TLZ T2,RBMASK-RBREAL
  1357	001474'	261040	000011		PUSH P,T4
  1358	001475'	316344	001462*		CAMN	T2,DEVELB(F)	;
  1359	001476'	260040	001555'		 PUSHJ	P,DLTBAD	;
  1360	001477'	260040	001464*		PUSHJ P,GIVPGK	;RETURN NEXT PAGE
  1361	001500'	254000	001465'		JRST DLTRG1	;AND CONTINUE
  1362
  1363	001501'	260040	000000*	DLTRBG:	PUSHJ P,RELSAT		;ALL DONE. LAST PAGE RETURNED
  1364	001502'	336000	376000*	DLTRBD:	SKIPN	%RIB+RIBRIB
  1365	001503'	254000	001565'		 JRST	DLTTOP		;
  1366	001504'	332000	376000*		SKIPE	%RIB+RIBSFS	;GET FIRST PNTR
  1367	001505'	254000	001512'		 JRST	DLTRND		;PNTR THERE, DO NOT DELETE RIB
  1368	001506'	260040	001574'		PUSHJ	P,FREUP
  1369	001507'	200340	376000*		MOVE	T2,%RIB+RIBSLF
  1370	001510'	260040	001421*		PUSHJ	P,GIVPAG	;RETURN IT
  1371	001511'	360600	001512'		SOJ	P1,.+1		;COUNT ONE RIB PAGE LESS.
  1372	001512'	200300	376000*	DLTRND:	MOVE	T1,%RIB+RIBRIB	;
  1373	001513'	261040	376000*		PUSH P,%RIB+RIBRPS
  1374	001514'	202304	001375*		MOVEM T1,DEVRIB(F)
  1375	001515'	260040	001074'		PUSHJ P,CRBRWR		;GET RIB
  1376	001516'	254000	001422*		  JRST RELLOK
  1377	001517'	332000	376000*		SKIPE %RIB+RIBRIB
  1378	001520'	334440	002114'		 SKIPA T4,[-RBLVSP,,RIBSFS]
  1379	001521'	200440	002115'		MOVE T4,[-RBLVPR,,RIBPFS]
  1380	001522'	262040	000006		POP P,T1		;POSITION IN RIB OF SPARE PNTR
  1381	001523'	275311	000000		SUBI	T1,(T4)		;
  1382	001524'	507000	000006		HRLS T1			;ADJUST AOBJN
  1383	001525'	270440	000006		ADD T4,T1
  1384	001526'	253440	001426'		AOBJN T4,DLTRBC		;CONTINUE IF MORE
  1385	001527'	254000	001502'		JRST DLTRBD		;NOW SEE IF TOP LEVEL
  1386
  1387	001530'	402011	376000	DLTSRB:	SETZM %RIB(T4)		;CLEAR THIS PNTR
  1388	001531'	375000	376000*		SOSGE	%RIB+RIBSNM
  1389	001532'	256000	000467'		 STOPCD (,XCT,RIBBRP)
  1390					;Bad Retreival Pointer  ;;DLTSRB+2
  1391	001533'	202304	001514*		MOVEM T1,DEVRIB(F)
  1392	001534'	200300	376000*		MOVE	T1,%RIB+RIBSZS	;Make sure this agrees with RIBSNM
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 23-3
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

  1393	001535'	306300	000001		CAIN	T1,1		;Should not be 1 if RIBSNM was >0
  1394	001536'	256000	000467'		 STOPCD (,XCT,RIBBRP)
  1395				   ;Bad Retreival Pointer  ;;DLTSRB+6
  1396	001537'	336000	376000*		SKIPN	%RIB+RIBSNM	;Just throw away last spare?
  1397	001540'	231300	000312*		IDIVI	T1,RBLVSP	;If so, reduce RIBSZS by one level
  1398	001541'	202300	376000*		MOVEM	T1,%RIB+RIBSZS	;NOTE: this could be done by just
  1399								;checking the prime RIB at DLTTOP,
  1400								;but this probably has a better chance
  1401								;of working for multi-level RIB's.
  1402	001542'	260040	001074'		PUSHJ P,CRBRWR		;AND GET SUPRIB
  1403	001543'	254000	001516*		  JRST RELLOK
  1404	001544'	254000	001423'		JRST DELRIB		;CONTINUE
  1405
  1406	001545'	553000	000011	DLTRSZ:	HRRZS T4		;NEED TO ZERO REMAINING PNTRS (NON-REAL)
  1407	001546'	402011	376000		SETZM %RIB(T4)
  1408	001547'	306440	000415*		CAIN T4,RIBLST		;IF ONLY THE LAST ONE
  1409	001550'	254000	001454'		 JRST DLTRSD		;THEN DONE
  1410	001551'	505451	376000		HRLI T4,%RIB(T4)	;GET SET FOR BLT
  1411	001552'	271440	376001		ADDI T4,%RIB+1
  1412	001553'	251440	376000*		BLT T4,%RIB+RIBLST
  1413	001554'	254000	001454'		JRST DLTRSD
  1414
  1415	001555'	550304	001373*	DLTBAD:	HRRZ T1,DEVATB(F)
  1416	001556'	370006	000000*		SOS ATBALP(T1)		;ADJUST ALLOC (NORMALLY IN GIVPAG)
  1417	001557'	554304	000000*		HLRZ T1,DEVDRB(F)
  1418	001560'	357346	000000*		AOSG T2,DRBALC(T1)	;IF INCREMENT MAKE POS ALL OK
  1419					 SOJG	T2,[MOVEM T2,DRBALC(T1)	;IF NOW<=0 WAS>0 DEC AGAIN
  1420	001561'	367340	002116'			JRST .+1]
  1421	001562'	205300	400000		MOVSI T1,(1B0)
  1422	001563'	436304	001475*		IORM T1,DEVELB(F)	;FLAG AS BAD BLOCK SEEN
  1423	001564'	254000	001345*		JRST	CPOPJ1
  1424
  1425	001565'	350001	000000	DLTTOP:	AOS (P)
  1426	001566'	331004	001563*		SKIPL	DEVELB(F)	;IF BAD BLOCK WAS IN DELETED PART
  1427	001567'	263040	000000		 POPJ	P,
  1428	001570'	402000	376000*		SETZM	%RIB+RIBELB	;CLEAR RIB FLAG
  1429	001571'	205300	400000		MOVSI	T1,(1B0)	;
  1430	001572'	412304	001566*		ANDCAM	T1,DEVELB(F)	;
  1431	001573'	263040	000000		POPJ	P,
  1432
  1433
  1434
  1435
  1436				EXTERN PCBPTR,PCBLKQ,PCBUSC,PCBPAG,PCISTS,PGYDRT,PGYADR
  1437				EXTERN PTNPNO,PTSPNO,STDPRE,%CTUPT
  1438
  1439				EXTERN DSKPIF,DSKPIN
  1440				DEFINE DSKON <WRPI DSKPIN>
  1441				DEFINE DSKOFF <WRPI DSKPIF>
  1442
  1443				EXTERN STDWRT,STDWAG,PWAIT1
  1444	001574'	550360	000000*	FREUP:	HRRZ	T2,@%RIB.C+%CTUPT ;GET T2/ PCB ADDRESS.
  1445	001575'	550307	000000*		HRRZ	T1,PCBUSC(T2)	;WE BETTER
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 23-4
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

  1446	001576'	366300	001601'		SOJN	T1,.+3		;BE THE
  1447	001577'	550307	000000*		HRRZ	T1,PCBLKQ(T2)	;ONLY
  1448	001600'	322300	001602'		JUMPE	T1,.+2		;USER.
  1449	001601'	256000	000000'		 STOPCD (SLO)
  1450				           ;;FREUP+6
  1451	001602'	261040	000003		PUSH	P,PG		;GET PG/ CORE PAGE
  1452	001603'	554147	000000*		HLRZ	PG,PCBPAG(T2)	;NUMBER.
  1453	001604'	261040	000002		PUSH	P,J		;
  1454	001605'	200100	000000*		MOVE	J,JOB		;
  1455	001606'	260040	000000*		PUSHJ	P,PAGWAT	;
  1456	001607'	262040	000002		POP	P,J		;
  1457	001610'	400400	000000		SETZ	T3,
  1458	001611'	137400	000000*		DPB	T3,PGYDRT	;CLEAR DATA MODIFIED.
  1459	001612'	262040	000003		POP	P,PG		;
  1460	001613'	263040	000000		POPJ	P,
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 24
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

  1461				;ROUTINE TO FIND A SPOT IN RIB STR AND DELETE EVERYTHING AFTER
  1462				;IT.  ALSO ZEROES OUT THE STUFF AFTER THE EOF AND IN THE LAST
  1463				;PAGE.
  1464				;EXPECTS T2/ UUXALC IN UNITS OF WORDS, WHICH IS
  1465				;< ACTUAL FILE SIZE, AND ALSO P2/ ATB ADDRESS.
  1466				;SKIP RETURNS ON SUCCESS, ELSE NON-SKIP RETURNS.
  1467				;SUCCESS RETURN HAS THE PRIME RIB IN %RIB.
  1468				;FAIL RETURN HAS RELEASED THE RIB.
  1469
  1470				EXTERNAL SETACH
  1471
  1472				INTERNAL DLTTRC
  1473
  1474	001614'	261040	000007	DLTTRC:	PUSH	P,T2		;CAN'T LOCK WHEN
  1475	001615'	260040	001405*		PUSHJ	P,RELRIB	;HAVE A
  1476	001616'	262040	000007		POP	P,T2		;RIB.
  1477	001617'	260040	000000*		PUSHJ	P,LOKMOD	;LOCK SO NOT SEEN IN THE MIDDLE.
  1478
  1479				;HERE WITH FILE LOCK FROM TRUNCATE CHANIO.
  1480
  1481	001620'	200300	000007	DLTTCI::MOVE	T1,T2		;CALC T1/
  1482	001621'	271300	000777		ADDI	T1,777		;NEW
  1483	001622'	242300	777767		LSH	T1,W2PLSH	;HPW.
  1484	001623'	135400	000000*		LDB	T3,ATYBLK	;CALC T3/
  1485	001624'	271400	000003		ADDI	T3,3		;CURRENT
  1486	001625'	242400	777776		LSH	T3,B2PLSH	;HPW.
  1487	001626'	602340	000177		TRNE	T2,177		;SET UP T2 AS
  1488	001627'	271340	000200		ADDI	T2,200		;NEW ATBSIZ.
  1489	001630'	200004	000002		MOVE	S,DEVIOS(F)	;FILE
  1490	001631'	603000	001404*		TLNE	S,IOBDRB	;ALREADY BAD?
  1491	001632'	254000	002015'		JRST	DLTFAL		;YES, JUST FAIL.
  1492	001633'	261040	000007		PUSH	P,T2		;NO, SAVE NEW ATBSIZ.
  1493	001634'	312300	000010		CAME	T1,T3		;NEED ACTUAL PAGE TRUNCATION?
  1494	001635'	254000	001643'		JRST	DLTTR0		;YES.
  1495	001636'	260040	002017'		PUSHJ	P,GETPRM	;GEE PRIME RIB FOR THE CALLER.
  1496	001637'	254000	002013'		JRST	DELTK0		;
  1497	001640'	262040	000007		POP	P,T2		;RESTORE T2/ NEW ATBSIZ.
  1498	001641'	250355	000000*		EXCH	T2,ATBSIZ(P2)	;SET NEW ATBSIZ, OLD TO T2.
  1499	001642'	254000	001724'		JRST	DELTR7		;
  1500
  1501
  1502				    ;HERE FOR ACTUAL RETRIEVAL PNTR TRUNCATION.
  1503				    ;FLUSH AND INVALIDATE ALL DDBS ON THIS VERSION OF THE FILE.
  1504	001643'	260040	000346'	DLTTR0:	PUSHJ	P,PTROUT	;FLUSH OUR DDB IF CALLED FROM KFTRN
  1505	001644'	324740	002013'		  PJRST	DELTK0		;BAD RIB, FORGET IT
  1506	001645'	255000	000000		 JFCL			;THEY MAY HAVE CHANGED, MAYBE NOT. WHO CARES.
  1507	001646'	260040	000000*		PUSHJ	P,FLUSHA	;FLUSH AND INVALIDATE ALL DDBS.
  1508	001647'	324740	002013'		PJRST	DELTK0		;SAW A BAD RIB.
  1509	001650'	260040	001615*		PUSHJ	P,RELRIB	;RELEASE RIB IF HELD
  1510	001651'	260040	000000*		PUSHJ	P,SETACH	;SET ATPALC AND UFPALC, WAIT FOR UFD ENTRY TO GO OUT.
  1511
  1512				    ;GET THE PRIME RIB INTO %RIB.
  1513	001652'	260040	002017'		PUSHJ	P,GETPRM	;GET THE PRIME RIB.
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 24-2
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

  1514	001653'	254000	002013'		JRST	DELTK0		;BAD.
  1515	001654'	332000	376000*		SKIPE	%RIB+RIBRIB	;DEBUGGING CHECK
  1516	001655'	256000	000000'		 STOPCD (SLO)
  1517						;;DLTTR0+13
  1518	001656'	332340	376000*		SKIPE	T2,%RIB+RIBELB	;IN CASE IT SHOULD
  1519	001657'	202344	001572*		MOVEM	T2,DEVELB(F)	;NOT BE RETURNED.
  1520
  1521				    ;SET UP FOR DLTRBC.
  1522	001660'	661000	000020		TLO	S,IO		;
  1523	001661'	202004	000002		MOVEM	S,DEVIOS(F)	;
  1524	001662'	200301	000000		MOVE	T1,(P)		;GET
  1525	001663'	602300	000177		TRNE	T1,177		;
  1526	001664'	275300	000200		SUBI	T1,200		;
  1527	001665'	271300	000777		ADDI	T1,777		;T1/ NEW
  1528	001666'	242300	777767		LSH	T1,W2PLSH	;HPW.
  1529	001667'	230300	376000*	DELTR2:	IDIV	T1,%RIB+RIBSZS	;
  1530	001670'	322340	001705'		JUMPE	T2,DELTR5	;ON A SPARE RIB BOUNDARY, GO
  1531	001671'	332000	376000*		SKIPE	%RIB+RIBRIB	;LOAD THE
  1532	001672'	334406	376000*		SKIPA	T3,%RIB+RIBSFS(T1) ;PROPER
  1533	001673'	200406	376000*		MOVE	T3,%RIB+RIBPFS(T1) ;PNTR.
  1534	001674'	607400	001146*		TLNN	T3,RBSPAR	;
  1535	001675'	254000	001704'		JRST	DELTR4		;
  1536	001676'	261040	000007		PUSH	P,T2		;SPARE RIB.
  1537	001677'	202404	001533*		MOVEM	T3,DEVRIB(F)
  1538	001700'	260040	001074'		PUSHJ	P,CRBRWR
  1539					JRST	[PUSHJ P,RELRIB	;
  1540						POP P,T2
  1541	001701'	254000	002120'			JRST DELTK0]
  1542	001702'	262040	000006		POP	P,T1		;GET POSITION
  1543	001703'	254000	001667'		JRST	DELTR2		;AND CONTINUE
  1544	001704'	270300	000007	DELTR4:	ADD	T1,T2		;LAST DATA PNTRS, GET IT.
  1545	001705'	507000	000006	DELTR5:	HRLS	T1
  1546	001706'	332000	376000*		SKIPE	%RIB+RIBRIB
  1547	001707'	334440	002123'		SKIPA	T4,[-RBLVSP,,RIBSFS]
  1548	001710'	200440	002124'		MOVE	T4,[-RBLVPR,,RIBPFS]
  1549	001711'	270440	000006		ADD	T4,T1		;ADJUST.
  1550	001712'	200301	000000		MOVE	T1,(P)		;NOW, SET NEW ATBSIZ
  1551	001713'	250315	001641*		EXCH	T1,ATBSIZ(P2)	;AND REMEMBER
  1552	001714'	202301	000000		MOVEM	T1,(P)		;ITS OLD VALUE.
  1553	001715'	261040	000014		PUSH	P,P1		;P1 KEEPS TRACK OF
  1554	001716'	400600	000000		SETZ	P1,		;STUFF FOR RIBALP.
  1555
  1556				    ;DO THE PARTIAL DELETE AND ADJUST RIBSIZ/ALP.
  1557	001717'	260040	001426'		PUSHJ	P,DLTRBC	;
  1558					JRST	[POP P,P1	;
  1559	001720'	254000	002125'			JRST DELTK0]	;
  1560	001721'	272600	376000*		ADDM	P1,%RIB+RIBALP	;
  1561	001722'	262040	000014		POP	P,P1		;
  1562	001723'	262040	000007		POP	P,T2		;GET T2/ OLD ATBSIZ.
  1563	001724'	200315	001713*	DELTR7:	MOVE	T1,ATBSIZ(P2)	;GET T1/ NEW
  1564	001725'	602300	000177		TRNE	T1,177		;ATBSIZ UNROUNDED, AND
  1565	001726'	275300	000200		SUBI	T1,200		;SET
  1566	001727'	202300	376000*		MOVEM	T1,%RIB+RIBSIZ	;RIBSIZ.
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 24-3
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

  1567
  1568				    ;NOW CLEAR OUT THE LAST PAGE, IF NECESSARY.
  1569				      ;ENTER HERE WITH T2/ OLD ATBSIZ AND T1/ NEW REAL SIZE.
  1570				      ;ALSO ENTER WITH THE PRIME RIB IN %RIB.
  1571	001730'	606300	000777		TRNN	T1,777		;NEW EOF AT PAGE BOUNDARY?
  1572	001731'	254000	002011'		JRST	DELTR9		;YES, NO CLEARING NEEDED.
  1573				      ;FIND RELATIVE NO. OF LAST WORD TO CLEAR.
  1574	001732'	602340	000177		TRNE	T2,177		;CONVERT OLD ATBSIZ EOF TO A
  1575	001733'	275340	000200		SUBI	T2,200		;REAL SIZE.
  1576	001734'	200400	000006		MOVE	T3,T1		;CALC NO. OF LAST WORD
  1577	001735'	435400	000777		IORI	T3,777		;IN
  1578	001736'	271400	000001		ADDI	T3,1		;PAGE.
  1579	001737'	313340	000010		CAMLE	T2,T3		;WE WILL CLEAR TO
  1580	001740'	200340	000010		MOVE	T2,T3		;%COW-1(T2).
  1581	001741'	275340	000001		SUBI	T2,1		;
  1582	001742'	630340	002127'		TDZ	T2,[XWD-1,777000] ;T2/ RELATIVE TO START
  1583	001743'	261040	000007		PUSH	P,T2		;OF PAGE.  SAVE IT.
  1584				      ;FIND T2/ RETRIEVAL PNTR TO LAST PAGE (FOR MAPKRN).
  1585	001744'	242400	777767		LSH	T3,W2PLSH	;SET M/ NO. OF
  1586	001745'	261040	000013		PUSH	P,M		;THE
  1587	001746'	200540	000010		MOVE	M,T3		;LAST PAGE.
  1588	001747'	476004	001372*		SETOM	DEVFLO(F)	;JUST IN CASE.
  1589	001750'	550304	001555*		HRRZ	T1,DEVATB(F)	;DEBUGGING
  1590	001751'	302315	000000		CAIE	T1,(P2)		;CHECK.
  1591	001752'	256000	000000'		 STOPCD (SLO)
  1592				           ;;DELTR7+26
  1593	001753'	260040	000447'		PUSHJ	P,USETST	;SET UP @DEVRET.
  1594					JRST	[POP P,M		;
  1595	001754'	254000	002130'			JRST DELTK0]	;
  1596	001755'	476004	001747*		SETOM	DEVFLO(F)	;ZAP DDB.
  1597	001756'	262040	000013		POP	P,M		;RESTORE M.
  1598	001757'	260040	002017'		PUSHJ	P,GETPRM	;GET THE PRIME RIB AGAIN.
  1599	001760'	254000	002013'		JRST	DELTK0		;RIB WENT BAD.
  1600	001761'	200364	001365*		MOVE	T2,@DEVRET(F)	;DON'T BOTHER
  1601	001762'	607340	001436*		TLNN	T2,RBREAL	;WITH
  1602					JRST	[POP P,T3	;HOLES.
  1603	001763'	254000	002132'			JRST DELTR9]	;
  1604				      ;MAP THE LAST PAGE INTO %COW.  (T2 HAS RETRIEVAL PNTR.).
  1605	001764'	200315	001724*		MOVE	T1,ATBSIZ(P2)	;FIND T1/ RELATIVE
  1606	001765'	602300	000177		TRNE	T1,177		;
  1607	001766'	275300	000200		SUBI	T1,200		;
  1608	001767'	630300	002127'		TDZ	T1,[XWD -1,777000] ;NO. OF 1ST WORD TO CLEAR.
  1609	001770'	261040	000006		PUSH	P,T1		;NEW CODE TO
  1610	001771'	261040	000007		PUSH	P,T2		;RELEASE THE RIB
  1611	001772'	260040	001650*		PUSHJ	P,RELRIB	;FOR ERNIE'S
  1612	001773'	262040	000007		POP	P,T2		;CODE
  1613	001774'	262040	000006		POP	P,T1		;IN REMOVE.
  1614	001775'	262040	000010		POP	P,T3		;T3/ REL LAST TO CLEAR.
  1615	001776'	400440	000000		SETZ	T4,		;ARG FOR CLRCOW.
  1616	001777'	260040	000000*		PUSHJ	P,CLRCOW	;CLEAR PART OF PAGE.
  1617	002000'	254000	002002'		JRST	.+2		;BLEW IT.
  1618	002001'	254000	002007'		JRST	DELTR8		;SUCCESS.
  1619	002002'	551306	000000		HRRZI	T1,(T1)		;WHAT WAS
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 24-4
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

  1620	002003'	306300	000000*		CAIN	T1,FALBDS	;WRONG?
  1621	002004'	664000	200000		TROA	S,IODERR	;BAD SAT, MAYBE DATA OKAY.
  1622	002005'	660000	100000		TRO	S,IODTER	;IO ERROR.
  1623	002006'	202004	000002		MOVEM	S,DEVIOS(F)	;BEST WE CAN DO FOR NOW.
  1624	002007'	260040	002017'	DELTR8:	PUSHJ	P,GETPRM	;GET THE RIB BACK.
  1625	002010'	324740	000662*		PJRST	KILFIL		;
  1626	002011'	260040	000652*	DELTR9:	PUSHJ	P,UNLFIL	;
  1627	002012'	254000	001564*		JRST	CPOPJ1
  1628
  1629				    ;SOME ERROR RETURNS.
  1630	002013'	262040	000007	DELTK0:	POP	P,T2		;
  1631	002014'	324740	002010*		PJRST	KILFIL		;
  1632
  1633	002015'	260040	001772*	DLTFAL:	PUSHJ	P,RELRIB
  1634	002016'	324740	002011*		PJRST	UNLFIL		;
  1635
  1636				;THIS IS A LITTLE DEBUGGING ROUTINE TO GET THE PRIME
  1637				;RIB FOR DLTTRC. EXPECTS T1/ RETRIEVAL PNTR TO PRIME RIB.
  1638				;SKIP RETURNS IF RIB OKAY, NON-SKIP RETURNS IF IT IS BAD.
  1639	002017'	200315	001374*	GETPRM:	MOVE	T1,ATBRIB(P2)	;
  1640	002020'	202304	001677*		MOVEM	T1,DEVRIB(F)	;BEWARE OF THE RIB
  1641	002021'	476004	001755*		SETOM	DEVFLO(F)	;CHECKING ROUTINE.
  1642	002022'	260040	000661*		PUSHJ	P,MWLRIB	;
  1643	002023'	263040	000000		POPJ	P,		;
  1644	002024'	332000	376000*		SKIPE	%RIB+RIBRIB	;
  1645	002025'	256000	000000'		 STOPCD (SLO)
  1646				           ;;GETPRM+6
  1647	002026'	200304	000017		MOVE	T1,DEVPPN(F)	;
  1648	002027'	312300	376000*		CAME	T1,%RIB+RIBPPN	;
  1649	002030'	256000	000000'		 STOPCD (SLO)
  1650				           ;;GETPRM+11
  1651	002031'	200304	000015		MOVE	T1,DEVFIL(F)	;
  1652	002032'	312300	376000*		CAME	T1,%RIB+RIBNAM	;
  1653	002033'	256000	000000'		 STOPCD (SLO)
  1654				           ;;GETPRM+14
  1655	002034'	510304	000016		HLLZ	T1,DEVEXT(F)	;
  1656	002035'	510340	376000*		HLLZ	T2,%RIB+RIBEXT	;
  1657	002036'	312300	000007		CAME	T1,T2		;
  1658	002037'	256000	000000'		 STOPCD (SLO)
  1659				           ;;GETPRM+17
  1660	002040'	254000	002012*		JRST	CPOPJ1
  1661
  1662	002041'	260040	001072*		$END	(RIB)

  1663	002042'	201300	000651*

  1664	002043'	263040	000000

  1665	002044'	260040	002015*

  1666	002045'	201300	002042*

  1667	002046'	263040	000000
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 24-5
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988


  1668	002047'	200300	376000*

  1669	002050'	306300	001165*

  1670	002051'	256000	000000'

  1671	002052'	254000	000046'

  1672	002053'	137440	001363*

  1673	002054'	254000	000137'

  1674	002055'	000000	000000*

  1675	002056'	260040	000000*

  1676	002057'	625142	426260

  1677	002060'	400010	000000

  1678	002061'	000000	001210'

  1679	002062'	262040	000007

  1680	002063'	324740	000644'

  1681	002064'	262040	000007

  1682	002065'	254000	000644'

  1683	002066'	270304	001101*

  1684	002067'	254000	000750'

  1685	002070'	262044	002020*

  1686	002071'	254000	001543*

  1687	002072'	260040	000000*

  1688	002073'	625142	456262

  1689	002074'	400006	000000

  1690	002075'	000000	001210'

  1691	002076'	260040	002056*

  1692	002077'	625142	645545

  1693	002100'	400010	000000

FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 24-6
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988

  1694	002101'	000000	000000*

  1695	002102'	260040	002072*

  1696	002103'	625142	506245

  1697	002104'	400006	000000

  1698	002105'	000000	001210'

  1699	002106'	000000*	400000

  1700	002107'	400000	000001

  1701	002110'	262040	000014

  1702	002111'	263040	000000

  1703	002112'	000000*	000773*

  1704	002113'	000000*	000210*

  1705	002114'	000000*	002112*

  1706	002115'	000000*	002113*

  1707	002116'	202346	001560*

  1708	002117'	254000	001562'

  1709	002120'	260040	002044*

  1710	002121'	262040	000007

  1711	002122'	254000	002013'

  1712	002123'	000000*	002114*

  1713	002124'	000000*	002115*

  1714	002125'	262040	000014

  1715	002126'	254000	002013'

  1716	002127'	777777	777000

  1717	002130'	262040	000013

  1718	002131'	254000	002013'

  1719	002132'	262040	000010

  1720	002133'	254000	002011'
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 24-7
FILRIB.MAC	19-NOV-87 14:19		S.MAC - with system parameter file for P035/D, January 1988


  1721						;End of FILRIB (RIBLIT: RIBEND:)
  1722
NO ERRORS DETECTED
PROGRAM BREAK IS 002134
7K CORE USED
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 25
FILRIB.MAC	19-NOV-87 14:19		SYMBOL TABLE

ALIASD		000000	EXT	DLTRB0		001434'		INLMES		001223'	EXT	PG		000003	INT
ATBALP		001556'	EXT	DLTRB1		001446'		INVDD2		001376'		PGYADR		000000	EXT
ATBFNB		001311'	EXT	DLTRB2		001445'		INVDDB		001372'	INT	PGYDRT		001611'	EXT
ATBRIB		002017'	EXT	DLTRB3		001432'		IO		000020	SIN	PGYERR		000000	EXT
ATBSIZ		001764'	EXT	DLTRBC		001426'		IOBDRB		001631'	EXT	PJRST	324740	000000	
ATYBLK		001623'	EXT	DLTRBD		001502'		IODERR		200000	SIN	PRMCHK		001230'	INT
ATYBSZ		000654'	EXT	DLTRBG		001501'		IODTER		100000	SIN	PRNAME		001222'	EXT
B2PLSH	777777	777776	SPD	DLTRG1		001465'		IOIMPM		400000	SIN	PRRCHK		001303'	INT
CHKQTA		000315'	EXT	DLTRND		001512'		IOSRBE		001023'	EXT	PRT22A		001227'	EXT
CLRCOW		001777'	EXT	DLTRSD		001454'		IOSRIB		001067'	EXT	PRTDDB		001214'	EXT
CODRIB		001337'	EXT	DLTRSZ		001545'		IOSUPR		000000	EXT	PTNPNO		000000	EXT
CORONZ		000341'	INT	DLTSRB		001530'		J		000002	INT	PTRCHG		001400'	EXT
CORZER		000340'	INT	DLTTCI		001620'	INT	JOB		001605'	EXT	PTRIN4		000413'	
CPOPJ		000402'	EXT	DLTTOP		001565'		KILFIL		002014'	EXT	PTRIN6		000417'	
CPOPJ1		002040'	EXT	DLTTR0		001643'		LBDCNT		001246'	INT	PTRIN7		000432'	
CRBRWL		001075'	INT	DLTTRC		001614'	INT	LBDMAX		001250'	INT	PTRIN8		000440'	
CRBRWR		001074'		DRBALC		002116'	EXT	LBDRIB		001247'	INT	PTRIN9		000442'	
DELRIB		001423'		DRBNAM		001322'	EXT	LMPMXW		000000	EXT	PTRINN		000400'	INT
DELTK0		002013'		DRBRIB		001272'	EXT	LOKMOD		001617'	EXT	PTRLEN		000734'	EXT
DELTR2		001667'		DRRBL1		001030'		M		000013	INT	PTROU0		000363'	INT
DELTR4		001704'		DRRBL2		001046'		MAPCML		000000	EXT	PTROU2		000367'	INT
DELTR5		001705'		DRRBLK		001025'	INT	MAPRDL		001065'	EXT	PTROUT		000346'	INT
DELTR7		001724'		DSKDIE		002101'	EXT	MAPRLS		002041'	EXT	PTSPNO		000000	EXT
DELTR8		002007'		DSKPIF		000000	EXT	MAPRWL		001063'	INT	PWAIT1		000000	EXT
DELTR9		002011'		DSKPIN		000000	EXT	MAPRXC		001067'		RBBRWL		001113'	
DEVATB		001750'	EXT	ERRFUL		000000	EXT	MAPWLN		000325'	EXT	RBDLTA		000000	EXT
DEVBLK		000764'	EXT	F		000004	INT	MAPWTL		001066'	EXT	RBINDX		000000	EXT
DEVDRB		001557'	EXT	FALAQA		000077'	EXT	MAPXCH		001070'	EXT	RBLVPR		000207'	EXT
DEVELB		001657'	EXT	FALBDS		002003'	EXT	MFDPPN		001262'	EXT	RBLVSP		001540'	EXT
DEVEXT		000016	SIN	FALRBE		002045'	EXT	MWLRIB		002022'	EXT	RBMASK		001440'	EXT
DEVFIL		000015	SIN	FBIT		000317'	EXT	NODIE		002102'	EXT	RBRCK1		001326'	
DEVFLO		002021'	EXT	FILRIB		000000'	ENT	NXT344		000070'		RBRCK2		001335'	
DEVFUF		002066'	EXT	FINDM		000507'	EXT	NXTP05		000023'		RBREAL		001762'	EXT
DEVIAD		000007	SIN	FLUSH		000636'	EXT	NXTP15		000036'		RBRER0		001346'	
DEVIOS		000002	SIN	FLUSHA		001646'	EXT	NXTP34		000062'		RBRER1		001347'	
DEVPOS		001377'	EXT	FNBDRB		001321'	EXT	NXTP35		000076'		RBSPAR		001674'	EXT
DEVPPN		000017	SIN	FNBEXT		001315'	EXT	NXTP36		000104'		RBYPNO		000000	EXT
DEVRB1		001354'	EXT	FNBNAM		001313'	EXT	NXTPT0		000016'	INT	RBYPNV		001226'	EXT
DEVRBN		001357'	EXT	FNDADB		000505'	EXT	NXTPT1		000031'		RBYUNA		001346'	EXT
DEVREL		000751'	EXT	FREUP		001574'		NXTPT3		000046'		RBYUNI		000000	EXT
DEVRET		001761'	EXT	GETAPG		000321'	EXT	NXTPT4		000120'		RBYUNR		001301'	EXT
DEVRIB		002070'	EXT	GETBK1		000750'		NXTPT5		000137'		RBYUNV		001217'	EXT
DEVSZS		001370'	EXT	GETBK2		000753'		NXTPTR		000003'		RELLOK		002071'	EXT
DEYRPS		002053'	EXT	GETBK3		000772'		ONELVL		001164'	EXT	RELRB2		000650'	EXT
DIE		002076'	EXT	GETBK4		001007'		P		000001	INT	RELRIB		002120'	EXT
DIRBLK		000727'	INT	GETBK5		001016'		P1		000014	INT	RELSAT		001501'	EXT
DIRFST		000702'	INT	GETBK6		001020'		P2		000015	INT	RIBALP		000000	EXT
DIRNXT		000716'	INT	GETER1		001326'	EXT	P4		000017	INT	RIBBRP		000467'	INT
DIRUP1		000726'		GETPRM		002017'		PAGWAT		001606'	EXT	RIBCK1		001137'	
DIRUP2		000707'		GETRIB		000315'		PCBLKQ		001577'	EXT	RIBCK2		001146'	
DLTALL		001403'	INT	GIVPAG		001510'	EXT	PCBPAG		001603'	EXT	RIBCK3		001162'	
DLTBAD		001555'		GIVPGK		001477'	EXT	PCBPTR		000572'	EXT	RIBCKD		001122'	INT
DLTFAL		002015'		INLMES		001223'	EXT	PCBUSC		001575'	EXT	RIBCOD		000336'	EXT
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88 PAGE 25-2
FILRIB.MAC	19-NOV-87 14:19		SYMBOL TABLE

RIBCON		000146'	INT	STRDDB		000000	EXT	
RIBDIR		001100'	INT	STRHSH		000000	EXT	
RIBDR1		001104'		STRNAM		000000	EXT	
RIBDR2		001103'		T1		000006	INT	
RIBE25		000244'		T2		000007	INT	
RIBELB		000000	EXT	T3		000010	INT	
RIBEND		002133'	INT	T4		000011	INT	
RIBER1		001205'		TPOPJ		001073'	EXT	
RIBERR		001173'	INT	TWOLVL		002050'	EXT	
RIBERS		001167'		U		000005	INT	
RIBERX		001210'		UFDLNK		000000	EXT	
RIBEX1		000153'	INT	UFRCHK		001251'	INT	
RIBEX2		000203'	INT	UFRER0		001301'		
RIBEX3		000261'	INT	UNIKON		000000	EXT	
RIBEX4		000300'	INT	UNILOG		001221'	EXT	
RIBEXT		000000	EXT	UNIMCT		001351'	EXT	
RIBHRE		001200'	INT	UNIPPU		000000	EXT	
RIBLIT		002041'	INT	UNISTR		000000	EXT	
RIBLST		001547'	EXT	UNLFIL		002016'	EXT	
RIBNAM		000000	EXT	UNPRER		001350'	EXT	
RIBPFS		002124'	EXT	UNTTBL		001347'	EXT	
RIBPPN		000000	EXT	UPDRLK		001060'		
RIBRDL		001107'	INT	UPTRIB		000000	EXT	
RIBRIB		000301'	EXT	USENUL		000653'		
RIBRPS		000302'	EXT	USEOUT		000464'		
RIBSFS		002123'	EXT	USERER		000644'		
RIBSIZ		000000	EXT	USERFL		000647'		
RIBSLF		000334'	EXT	USES04		000472'		
RIBSNM		000306'	EXT	USES22		000505'		
RIBSTS		000000	EXT	USES24		000520'		
RIBSZS		000313'	EXT	USES52		000577'		
RIBTME		001176'	INT	USES53		000600'		
RIBWTL		001110'	INT	USES55		000611'		
RIBX22		000232'		USES58		000632'		
RIPBDR		001332'	EXT	USESS1		000475'		
S		000000	INT	USESS2		000504'		
S$DISK		000010	SIN	USESS3		000540'		
S$ENTR	777777	777775	SIN	USESS5		000561'		
S$EVEN		000006	SIN	USETST		000447'	INT	
S$HALT	777777	777777	SIN	W2PLSH	777777	777767	SPD	
S$INFO		000005	SIN	ZERDDB		001354'	INT	
S$NAME		000000'	SPD	%COW		000000	EXT	
S$NONA		000000	SIN	%COW.N		000000	EXT	
S$PATC		000007	SIN	%CTUPT		000000	EXT	
S$TEMP	000010	000000	SPD	%RB2		375000	SIN	
S$XCT	777777	777776	SIN	%RB2.C		000137'	EXT	
SAVE1		001251'	EXT	%RIB		376000	SIN	
SAVE2		001025'	EXT	%RIB.C		001063'	EXT	
SAVSYS		000716'		
SETACH		001651'	EXT	

FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88
FILRIB.MAC	19-NOV-87 14:19		Symbol cross reference

ALIASD	    55%
ATBALP	    26%	  1416
ATBFNB	  1158%	  1162	  1213
ATBRIB	    26%	   676	   753	  1017	  1211	  1236	  1263	  1280	  1639
ATBSIZ	    26%	  1498	  1551	  1563	  1605
ATYBLK	    26%	  1484
ATYBSZ	    26%	   749
B2PLSH	   661	  1486
CHKQTA	    54%	   140	   401
CLRCOW	    56%	  1616
CODRIB	    24%	   376	   417	  1064	  1177	  1237
CORONZ	   435	   438#
CORZER	   202	   414	   435	   437#
CPOPJ	    53%	   512
CPOPJ1	    53%	   117	   230	   323	   419	   466	   605	   771	   931	   975	  1025	  1071	  1077	  1181
	  1184	  1240	  1243	  1423	  1627	  1660
CRBRWL	   902	   996#
CRBRWR	   995#	  1375	  1402	  1538
DELRIB	  1303	  1316#	  1404
DELTK0	  1496	  1505	  1508	  1514	  1541	  1559	  1595	  1599	  1630#
DELTR2	  1529#	  1543
DELTR4	  1535	  1544#
DELTR5	  1530	  1545#
DELTR7	  1499	  1563#
DELTR8	  1618	  1624#
DELTR9	  1572	  1603	  1626#
DEVATB	    30%	   143	   404	   675	   748	  1016	  1279	  1415	  1589
DEVBLK	    34%	   889	   892	   899
DEVDRB	    31%	  1417
DEVELB	    32%	  1300	  1347	  1358	  1422	  1426	  1430	  1519
DEVEXT	  1135	  1655
DEVFIL	   813	  1133	  1651
DEVFLO	    30%	    99	   103	   107	   231	   555	   591	   641	   642	   659	   677	   691	   764	   792
	   868	  1006	  1270	  1278	  1588	  1596	  1641
DEVFUF	    30%	   818	   869	   870	   872	   874	   877	   887	   916	  1007
DEVIAD	   464	   467	   479	   482	   611	   760	  1285
DEVIOS	    94	   146	   153	   164	   584	   699	  1103	  1295	  1489	  1523	  1623
DEVPOS	    30%	  1283
DEVPPN	  1039	  1132	  1647
DEVRB1	    31%	   491	   517	   533	   542	   544	   634	   635	   657	   761	   767	   768	   878	   911
	   920	   928	  1259	  1260	  1267
DEVRBN	    31%	   525	   534	   636	   770	   919	  1262
DEVREL	    34%	   844	   850	   888
DEVRET	    31%	   518	   526	   541	   604	   733	   762	  1268	  1600
DEVRIB	    30%	    87	   129	   171	   468	   614	   639	   640	   680	   694	   754	   900	   996	  1009
	  1010	  1018	  1019	  1022	  1024	  1061	  1063	  1081	  1264	  1281	  1374	  1391	  1537	  1640
DEVSZS	    32%	   538	   637	   638	   758	  1271
DEYRPS	    30%	   131	   182	   189	   191	   484	   510	   519	   521	   528	   644	   646	   726	   766
	  1266
DIE	    11	    11%	    12	   603	  1085	  1088	  1094
DIRBLK	   819	   851	   868#
DIRFST	   792#
DIRNXT	   842#
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88
FILRIB.MAC	19-NOV-87 14:19		Symbol cross reference

DIRUP1	   847	   850#
DIRUP2	   794	   813#
DLTALL	  1293	  1295#
DLTBAD	  1348	  1359	  1415#
DLTFAL	  1491	  1633#
DLTRB0	  1325#	  1334
DLTRB1	  1326	  1335#
DLTRB2	  1328	  1331	  1334#
DLTRB3	  1323#	  1340
DLTRBC	  1319#	  1384	  1557
DLTRBD	  1321	  1364#	  1385
DLTRBG	  1351	  1353	  1363#
DLTRG1	  1343	  1350#	  1361
DLTRND	  1367	  1372#
DLTRSD	  1341#	  1409	  1413
DLTRSZ	  1336	  1406#
DLTSRB	  1320	  1387#
DLTTCI	  1481#
DLTTOP	  1365	  1425#
DLTTR0	  1494	  1504#
DLTTRC	  1472	  1474#
DRBALC	    28%	  1418	  1419
DRBNAM	  1158%	  1171	  1222
DRBRIB	    28%	  1008	  1178
DRRBL1	   951#	   965
DRRBL2	   958	   967#
DRRBLK	   947#
DSKDIE	  1088%	  1088
DSKPIF	  1439%
DSKPIN	  1439%
ERRFUL	    53%
F	    87	    94	    99	   103	   107	   129	   143	   146	   153	   164	   171	   231	   404	   464
	   467	   468	   479	   482	   491	   517	   518	   525	   526	   533	   534	   538	   541	   542
	   544	   555	   584	   591	   596	   604	   609	   611	   614	   635	   636	   638	   640	   642
	   643	   645	   648	   675	   677	   680	   691	   694	   699	   733	   748	   754	   758	   760
	   761	   762	   764	   767	   768	   770	   792	   813	   818	   844	   850	   868	   869	   870
	   872	   874	   877	   878	   887	   888	   889	   892	   899	   900	   911	   916	   919	   920
	   928	   996	  1006	  1007	  1009	  1010	  1016	  1018	  1019	  1022	  1024	  1039	  1061	  1063
	  1081	  1103	  1132	  1133	  1135	  1259	  1260	  1262	  1264	  1267	  1268	  1270	  1271	  1278
	  1279	  1281	  1283	  1285	  1295	  1300	  1347	  1358	  1374	  1391	  1415	  1417	  1422	  1426
	  1430	  1489	  1519	  1523	  1537	  1588	  1589	  1596	  1600	  1623	  1640	  1641	  1647	  1651
	  1655
FALAQA	    55%	   163
FALBDS	    55%	  1620
FALRBE	    55%	    92	    97	   166	   744
FBIT	   142%	   142	   403%	   403
FILRIB	    11	    12#	    15
FINDM	   582%	   597	   624
FLUSH	    35%	   728
FLUSHA	    37%	  1507
FNBDRB	  1158%	  1163	  1221
FNBEXT	  1158%	  1217
FNBNAM	  1158%	  1215
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88
FILRIB.MAC	19-NOV-87 14:19		Symbol cross reference

FNDADB	   582%	   622
FREUP	  1308	  1368	  1444#
GETAPG	    53%	   144	   405
GETBK1	   871	   875	   881	   887#
GETBK2	   890#	   904
GETBK3	   898	   906#
GETBK4	   913	   919#
GETBK5	   922	   927#
GETBK6	   885	   929#
GETER1	    46%	   930	   974	  1032	  1050	  1126	  1164	  1207	  1227
GETPRM	  1495	  1513	  1598	  1624	  1639#
GETRIB	   151	   401#
GIVPAG	    51%	   161	  1310	  1370
GIVPGK	    51%	  1349	  1360
INLMES	  1108%	  1108	  1111%	  1111	  1117%	  1117
INVDD2	  1272	  1282#
INVDDB	  1276	  1278#
IO	   948	   982	  1014	  1015	  1298	  1522
IOBDRB	    54%	    95	   147	   154	   165	   585	   700	  1296	  1490
IODERR	  1621
IODTER	  1622
IOIMPM	  1102
IOSRBE	    54%	   932	  1102
IOSRIB	    54%	   793	   846	   890	   923	   977	   987
IOSUPR	    53%
J	  1453	  1454	  1456
JOB	    54%	  1454
KILFIL	    37%	   739	   756	  1625	  1631
LBDCNT	  1086	  1141#
LBDMAX	  1087	  1143#
LBDRIB	  1082	  1084	  1142#
LISTSN	     3	     6
LMPMXW	    56%
LOKMOD	    37%	  1477
M	   587	   664	   672	   729	  1586	  1587	  1594	  1597
MAPCML	    46%
MAPRDL	    46%	   983
MAPRLS	    46%	    91	   133	   198	   207	   209	   472	   687	   720	   990
MAPRWL	   929	   962	   973	   981#	   997	  1011	  1020
MAPRXC	   901	   927	   987#
MAPWLN	    46%	   200	   409
MAPWTL	    46%	    89	   470	   695	   984
MAPXCH	    54%	   891	   925	   988
MFDPPN	    53%	  1038	  1170
MWLRIB	   582%	   615	   755	  1642
NODIE	    11%	  1085	  1094
NXT344	   152	   156#
NXTP05	   101	   112#
NXTP15	   120	   124#
NXTP34	   139	   150#
NXTP35	   141	   145	   148	   158	   162#
NXTP36	   155	   170#
NXTPT0	    85	   103#
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88
FILRIB.MAC	19-NOV-87 14:19		Symbol cross reference

NXTPT1	   116	   119#
NXTPT3	   123	   128	   138#
NXTPT4	   177	   188#
NXTPT5	   183	   190	   206#
NXTPTR	    87#	   134	   212
ONELVL	    20%	  1075	  1182	  1241
P	    12	    89	    90	    91	    93	    96	    98	   115	   133	   140	   144	   149	   151	   159
	   161	   162	   167	   172	   173	   180	   188	   192	   193	   194	   195	   196	   198	   199
	   200	   202	   207	   209	   210	   211	   228	   232	   269	   304	   321	   333	   366	   367
	   368	   369	   373	   374	   375	   401	   402	   405	   406	   408	   409	   413	   414	   415
	   416	   442	   470	   471	   473	   474	   475	   476	   481	   493	   556	   557	   588	   589
	   597	   600	   601	   603	   615	   617	   622	   624	   666	   667	   668	   674	   685	   687
	   689	   695	   696	   697	   701	   703	   717	   718	   720	   728	   730	   737	   738	   742
	   743	   755	   795	   845	   848	   883	   891	   901	   902	   927	   929	   930	   960	   962
	   963	   971	   973	   974	   979	   989	   990	   995	   997	  1011	  1018	  1020	  1021	  1022
	  1024	  1032	  1050	  1085	  1088	  1094	  1104	  1108	  1110	  1111	  1116	  1117	  1126	  1164
	  1168	  1207	  1227	  1286	  1301	  1303	  1304	  1305	  1306	  1307	  1308	  1310	  1322	  1323
	  1335	  1341	  1348	  1349	  1350	  1357	  1359	  1360	  1363	  1368	  1370	  1373	  1375	  1380
	  1402	  1425	  1427	  1431	  1451	  1453	  1455	  1456	  1459	  1460	  1474	  1475	  1476	  1477
	  1492	  1495	  1497	  1504	  1507	  1509	  1510	  1513	  1524	  1536	  1538	  1539	  1540	  1542
	  1550	  1552	  1553	  1557	  1558	  1561	  1562	  1583	  1586	  1593	  1594	  1597	  1598	  1602
	  1609	  1610	  1611	  1612	  1613	  1614	  1616	  1624	  1626	  1630	  1633	  1642	  1643
P1	   172	   174	   211	   246	   249	   250	   252	   253	   255	   257	   263	   265	   266	   268
	   289	   291	   297	   306	   310	   314	   315	   318	   320	   326	   329	   331	   360	   363
	   368	   373	   374	   375	   377	   379	   382	   384	   588	   590	   601	   607	   627	   629
	   652	   658	   738	   949	   951	   953	   954	   955	   967	   969	   970	   972	  1162	  1163
	  1171	  1178	  1301	  1302	  1304	  1306	  1345	  1355	  1371	  1553	  1554	  1558	  1560	  1561
P2	   173	   175	   210	   247	   248	   254	   256	   258	   260	   261	   300	   301	   303	   311
	   313	   324	   328	   332	   356	   358	   380	   589	   590	   600	   608	   609	   630	   631
	   654	   655	   656	   657	   658	   662	   663	   665	   737	   955	   959	   961	   967	  1162
	  1211	  1213	  1236	  1263	  1498	  1551	  1563	  1590	  1605	  1639
P4	  1008
PAGWAT	    55%	  1455
PCBLKQ	  1436%	  1447
PCBPAG	  1436%	  1452
PCBPTR	   683	  1436%
PCBUSC	  1436%	  1445
PCISTS	  1436%
PG	    88	   132	   150	   197	   206	   208	   411	   469	   686	   690	   719	   981	  1451	  1452
	  1459
PGYADR	  1436%
PGYDRT	  1436%	  1458
PGYERR	    44%
PRMCHK	  1021	  1126#
PRNAME	  1116%	  1116
PRRCHK	  1207#
PRT22A	  1120%	  1120
PRTDDB	  1110%	  1110
PTNPNO	  1437%
PTRCHG	    32%	   465	   480	   612	   759	  1284
PTRIN4	   514	   525#
PTRIN6	   522	   531#
PTRIN7	   545#	   550
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88
FILRIB.MAC	19-NOV-87 14:19		Symbol cross reference

PTRIN8	   547	   551#
PTRIN9	   543	   549	   551	   553#
PTRINN	   115	   508	   510#	   730
PTRLEN	    32%	   114	   487	   513	   520	   531	   765	   873	   912	   914	  1265
PTROU0	   479#	   617
PTROU2	   473	   484#
PTROUT	   464#	  1504
PTSPNO	  1437%
PWAIT1	  1443%
RBBRWL	  1018#
RBDLTA	    19%
RBINDX	    19%
RBLVPR	    19%	   181	   292	  1318	  1379	  1548
RBLVSP	    19%	   267	   294	   319	   383	  1317	  1378	  1397	  1547
RBMASK	    19%	   160	  1329	  1346	  1356
RBRCK1	   963	  1227#
RBRCK2	  1225	  1230	  1235#
RBREAL	    19%	   160	   882	   921	  1327	  1346	  1356	  1601
RBRER0	  1208	  1216	  1220	  1224	  1228	  1248#
RBRER1	  1187	  1249#
RBSPAR	    19%	   262	   325	   359	   365	   381	   546	   710	   880	   897	   957	  1060	  1534
RBYPNO	    23%
RBYPNV	  1119%	  1119
RBYUNA	    23%	  1248
RBYUNI	    23%
RBYUNR	    23%	  1186
RBYUNV	    23%	  1096	  1113%	  1113
RELLOK	    54%	   796	   845	   849	   924	   933	   960	   964	   971	   976	   978	   995	  1023	  1212
	  1233	  1238	  1253	  1311	  1376	  1403
RELRB2	   582%	   743
RELRIB	    96	   162	   582%	   668	   742	  1297	  1475	  1509	  1539	  1611	  1633
RELSAT	    51%	  1363
RIBALP	    22%	  1560
RIBBRP	   603#	   714	   731	   751	  1389	  1394
RIBCK1	   228	   998	  1050#
RIBCK2	  1044	  1053	  1060#	  1139
RIBCK3	  1068	  1073#
RIBCKD	  1012	  1032#
RIBCOD	    22%	   377	   418	  1062	  1176	  1235
RIBCON	    90	   228#	   471	   696
RIBDIR	  1006#
RIBDR1	   795	  1010#
RIBDR2	   848	  1009#
RIBE25	   317	   321#
RIBELB	    20%	  1299	  1428	  1518
RIBEND	  1721#
RIBER1	  1036	  1056	  1083	  1102#	  1130
RIBERR	  1085#	  1252
RIBERS	  1040	  1043	  1065	  1070	  1074	  1081#	  1134	  1138
RIBERX	   603	  1085	  1094	  1108#
RIBEX1	   180	   246#
RIBEX2	   188	   287	   288#
RIBEX3	   196	   355	   356#
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88
FILRIB.MAC	19-NOV-87 14:19		Symbol cross reference

RIBEX4	   203	   372	   373#
RIBEXT	    22%	  1041	  1136	  1173	  1218	  1656
RIBHRE	  1033	  1051	  1094#	  1127
RIBLIT	  1662#
RIBLST	    20%	   119	   176	   248	   252	   306	   310	   511	   527	   912	   914	  1408	  1412
RIBNAM	    20%	  1169	  1214	  1652
RIBPFS	    20%	   246	   248	   249	   250	   259	   263	   288	   293	   361	   705	   765	   896	   909
	   953	   970	  1265	  1318	  1379	  1533	  1548
RIBPPN	    22%	  1037	  1131	  1169	  1223	  1648
RIBRDL	  1014#
RIBRIB	    20%	   124	   258	   289	   332	   356	   374	   706	   894	   908	   952	   968	  1052	  1229
	  1316	  1364	  1372	  1377	  1515	  1531	  1546	  1644
RIBRPS	    20%	   130	   260	   328	   358	   375	  1373
RIBSFS	    20%	   181	   247	   248	   290	   300	   301	   357	   382	   488	   707	   895	   907	   909
	   954	   969	  1317	  1366	  1378	  1532	  1547
RIBSIZ	    20%	  1566
RIBSLF	    22%	   170	   257	   261	   324	   331	   368	   373	   380	   416	  1176	  1235	  1309	  1369
RIBSNM	    20%	   253	   254	   265	   291	   311	   315	   326	   360	   379	  1069	  1073	  1388	  1396
RIBSTS	    21%	  1034	  1054	  1128	  1167	  1210	  1232
RIBSZS	    20%	   121	   125	   157	   255	   256	   266	   268	   313	   314	   318	   320	   384	   537
	   548	   704	   712	   757	   893	   951	  1066	  1180	  1239	  1392	  1398	  1529
RIBTME	  1088#
RIBWTL	  1015#
RIBX22	   307	   311#
RIPBDR	    21%	  1035	  1055	  1129	  1166	  1209	  1231
S	    94	    95	   146	   147	   153	   154	   164	   165	   584	   585	   699	   700	   793	   846
	   890	   923	   932	   948	   977	   982	   987	  1014	  1015	  1102	  1103	  1295	  1296	  1298
	  1489	  1490	  1522	  1523	  1621	  1622	  1623
S$DISK	   104	   127	   489	   603	   604	  1088	  1089	  1449	  1516	  1591	  1645	  1649	  1653	  1658
S$ENTR	    11	    17	   104	   127	   489	   604	   714	   731	   751	  1086	  1089	  1095	  1252	  1389
	  1394	  1449	  1516	  1591	  1645	  1649	  1653	  1658
S$EVEN	   603	  1085	  1086	  1088	  1094	  1095
S$HALT	    11	   104	   127	   489	   603	   714	   731	   751	  1085	  1088	  1094	  1252	  1389	  1394
	  1449	  1516	  1591	  1645	  1649	  1653	  1658
S$INFO	   603	  1085	  1088	  1094
S$NAME	    15#	   104	   127	   489	  1449	  1516	  1591	  1645	  1649	  1653	  1658
S$NONA	    14	    17	   104	   127	   489	   604	   715	   732	   752	  1086	  1089	  1095	  1253	  1390
	  1395	  1449	  1516	  1591	  1645	  1649	  1653	  1658
S$PATC	   603	  1085	  1088	  1094
S$TEMP	    11#	    11	   104#	   104	   127#	   127	   489#	   489	   603#	   603	   714#	   714	   731#	   731
	   751#	   751	  1085#	  1085	  1088#	  1088	  1094#	  1094	  1252#	  1252	  1389#	  1389	  1394#	  1394
	  1449#	  1449	  1516#	  1516	  1591#	  1591	  1645#	  1645	  1649#	  1649	  1653#	  1653	  1658#	  1658
S$XCT	    17	   104	   127	   489	   604	   714	   715	   731	   732	   751	   752	  1086	  1089	  1095
	  1252	  1253	  1389	  1390	  1394	  1395	  1449	  1516	  1591	  1645	  1649	  1653	  1658
SAVE1	  1159%	  1161
SAVE2	   945%	   947
SAVSYS	   821#
SETACH	  1470%	  1510
STDPRE	  1437%
STDWAG	  1443%
STDWRT	  1443%
STRDDB	    42%	   815
STRHSH	    35%	   815
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88
FILRIB.MAC	19-NOV-87 14:19		Symbol cross reference

STRNAM	    42%
T1	    87	    92	    97	   119	   120	   121	   122	   124	   125	   126	   129	   130	   131	   138
	   142	   156	   157	   163	   166	   176	   177	   181	   182	   192	   195	   199	   201	   246
	   247	   248	   250	   251	   252	   253	   254	   255	   256	   257	   258	   259	   260	   264
	   265	   266	   267	   268	   291	   295	   296	   297	   298	   299	   300	   302	   312	   313
	   314	   322	   324	   325	   330	   331	   332	   357	   358	   360	   361	   362	   367	   403
	   407	   408	   410	   412	   413	   415	   416	   418	   437	   438	   439	   440	   441	   464
	   465	   467	   468	   510	   511	   512	   513	   517	   518	   519	   520	   521	   525	   526
	   527	   528	   531	   532	   533	   534	   537	   538	   540	   547	   548	   552	   553	   554
	   555	   596	   611	   612	   614	   621	   631	   634	   637	   639	   641	   643	   645	   647
	   655	   657	   659	   675	   676	   680	   683	   685	   689	   694	   708	   710	   718	   727
	   744	   749	   750	   753	   754	   757	   758	   759	   760	   761	   762	   763	   764	   765
	   766	   768	   769	   770	   813	   814	   816	   817	   842	   844	   850	   870	   872	   873
	   874	   876	   877	   884	   887	   888	   889	   892	   893	   895	   896	   906	   907	   909
	   910	   912	   915	   920	   921	   928	   931	   949	   953	   954	   957	   959	   961	   972
	   975	   989	   996	  1008	  1009	  1010	  1016	  1017	  1019	  1033	  1034	  1035	  1037	  1038
	  1041	  1042	  1051	  1054	  1055	  1060	  1061	  1062	  1064	  1066	  1067	  1075	  1076	  1081
	  1082	  1084	  1086	  1087	  1095	  1098	  1113	  1114	  1119	  1127	  1128	  1129	  1131	  1132
	  1135	  1137	  1165	  1166	  1167	  1173	  1174	  1176	  1177	  1180	  1181	  1182	  1183	  1208
	  1209	  1210	  1213	  1215	  1217	  1221	  1222	  1223	  1228	  1231	  1232	  1235	  1237	  1239
	  1240	  1241	  1242	  1250	  1251	  1260	  1261	  1262	  1263	  1264	  1269	  1270	  1271	  1279
	  1280	  1281	  1282	  1283	  1284	  1285	  1319	  1321	  1325	  1327	  1329	  1330	  1332	  1372
	  1374	  1380	  1381	  1382	  1383	  1391	  1392	  1393	  1397	  1398	  1415	  1416	  1417	  1418
	  1419	  1421	  1422	  1429	  1430	  1445	  1446	  1447	  1448	  1481	  1482	  1483	  1493	  1524
	  1525	  1526	  1527	  1528	  1529	  1532	  1533	  1542	  1544	  1545	  1549	  1550	  1551	  1552
	  1563	  1564	  1565	  1566	  1571	  1576	  1589	  1590	  1605	  1606	  1607	  1608	  1609	  1613
	  1619	  1620	  1639	  1640	  1647	  1648	  1651	  1652	  1655	  1657
T2	   149	   159	   160	   170	   171	   193	   194	   261	   262	   263	   292	   294	   295	   301
	   302	   303	   304	   315	   316	   318	   319	   320	   326	   327	   328	   329	   330	   356
	   359	   364	   365	   369	   378	   379	   380	   381	   382	   383	   384	   407	   417	   418
	   440	   441	   484	   485	   486	   492	   541	   542	   543	   549	   551	   552	   599	   607
	   626	   627	   629	   672	   673	   674	   681	   683	   697	   701	   703	   704	   705	   707
	   712	   713	   748	   753	   815	   816	   817	   876	   878	   879	   880	   882	   884	   899
	   906	   910	   911	   918	   919	  1039	  1063	  1115	  1133	  1136	  1137	  1169	  1170	  1178
	  1214	  1215	  1218	  1219	  1236	  1265	  1266	  1267	  1268	  1299	  1300	  1309	  1333	  1337
	  1339	  1342	  1346	  1347	  1352	  1356	  1358	  1369	  1418	  1419	  1444	  1445	  1447	  1452
	  1474	  1476	  1481	  1487	  1488	  1492	  1497	  1498	  1518	  1519	  1530	  1536	  1540	  1544
	  1562	  1574	  1575	  1579	  1580	  1581	  1582	  1583	  1600	  1601	  1610	  1612	  1630	  1656
	  1657
T3	   143	   288	   290	   293	   296	   327	   376	   377	   404	   479	   480	   482	   486	   487
	   488	   491	   492	   544	   545	   550	   591	   602	   604	   608	   630	   647	   648	   659
	   660	   661	   662	   664	   665	   666	   717	   724	   733	   895	   896	   897	   900	   914
	   915	   916	   917	   918	  1171	  1217	  1219	  1324	  1330	  1332	  1336	  1337	  1338	  1339
	  1457	  1458	  1484	  1485	  1486	  1493	  1532	  1533	  1534	  1537	  1576	  1577	  1578	  1579
	  1580	  1585	  1587	  1602	  1614
T4	    99	   100	   103	   106	   107	   111	   112	   113	   114	   189	   191	   203	   298	   305
	   306	   308	   309	   310	   321	   362	   363	   364	   366	   370	   385	   540	   545	   546
	   602	   634	   635	   636	   637	   638	   639	   640	   641	   642	   644	   646	   654	   667
	   705	   707	   708	   724	   725	   726	   729	   947	  1161	  1317	  1318	  1319	  1322	  1323
	  1325	  1333	  1334	  1335	  1338	  1340	  1341	  1342	  1344	  1350	  1351	  1352	  1354	  1357
	  1378	  1379	  1381	  1383	  1384	  1387	  1406	  1407	  1408	  1410	  1411	  1412	  1547	  1548
	  1549	  1615
TPOPJ	    54%	   991
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88
FILRIB.MAC	19-NOV-87 14:19		Symbol cross reference

TWOLVL	    20%	   126	   138	   156	   322	  1076	  1183	  1242
U	  1096	  1097	  1098	  1114	  1115	  1186	  1248	  1249	  1251
UFDLNK	    35%	   842
UFRCHK	  1161#
UFRER0	  1165	  1172	  1175	  1179	  1186#
UNIKON	    40%
UNILOG	  1115%	  1115
UNIMCT	    39%	  1098	  1251
UNIPPU	    40%
UNISTR	    40%
UNLFIL	    37%	   745	  1626	  1634
UNPRER	    39%	  1095	  1250
UNTTBL	    53%	  1097	  1114	  1249
UPDRLK	   843	   903	   977#
UPTRIB	    49%
USENUL	   587	   748#
USEOUT	   600#	   649	   734
USERER	   616	   698	   702	   709	   737#
USERFL	   586	   742#
USES04	   599	   607#
USES22	   622#	   625	   628	   632
USES24	   626	   634#
USES52	   669	   689#	   721
USES53	   682	   690#
USES55	   684	   703#
USES58	   711	   724#
USESS1	   598	   611#
USESS2	   592	   613	   621#
USESS3	   623	   652#
USESS5	   652	   672#
USETST	   584#	  1593
W2PLSH	  1483	  1528	  1585
ZERDDB	  1257	  1259#
%COW	    55%
%COW.N	    55%
%CTUPT	   681	  1437%	  1444
%RB2	   170	   175	   412
%RB2.C	    47%	   150	   206
%RIB	   119	   121	   124	   125	   130	   157	   174	   176	   201	   410	   485	   488	   532	   537
	   548	   704	   705	   706	   707	   712	   725	   757	   842	   893	   894	   895	   896	   908
	   910	   951	   952	   953	   954	   968	   969	   970	  1034	  1037	  1041	  1052	  1054	  1062
	  1066	  1069	  1073	  1128	  1131	  1136	  1167	  1169	  1173	  1176	  1180	  1210	  1214	  1218
	  1223	  1229	  1232	  1235	  1239	  1299	  1309	  1316	  1319	  1325	  1337	  1338	  1339	  1342
	  1344	  1352	  1354	  1364	  1366	  1369	  1372	  1373	  1377	  1387	  1388	  1392	  1396	  1398
	  1407	  1410	  1411	  1412	  1428	  1515	  1518	  1529	  1531	  1532	  1533	  1546	  1560	  1566
	  1644	  1648	  1652	  1656
%RIB.C	    47%	    88	   132	   197	   208	   411	   469	   681	   686	   690	   719	   981	  1444
FILRIB	ROUTINE TO HANDLE RIB MANIPULATIONS	MACRO 12.5-46.0 14:30 13-JAN-88
FILRIB.MAC	19-NOV-87 14:19		Macro/Opdef cross reference

DSKOFF	  1441#
DSKON	  1440#
PFALL	   851
PJRST	   472	   616	   698	   709	   739	   745	   756	   819	   924	   925	   964	   976	   978	   988
	   998	  1012	  1120	  1187	  1212	  1216	  1220	  1224	  1233	  1238	  1253	  1297	  1311	  1505
	  1508	  1625	  1631	  1634
STOPCD	    10	   104	   127	   489	   603	   714	   731	   751	  1085	  1088	  1094	  1252	  1389	  1394
	  1449	  1516	  1591	  1645	  1649	  1653	  1658
$END	  1662 7@n
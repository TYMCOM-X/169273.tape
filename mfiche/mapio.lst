MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 1
S.MAC	13-JAN-88 11:55		S.MAC - with system parameter file for P035/D, January 1988

     1				SUBTTL	S.MAC - with system parameter file for P035/D, January 1988
     2
     3				IF2,<IFNDEF LISTSN,<TAPE>>	;Skip to PASS2 in all but COMMON.LST
     4				;THIS MODULE ASSEMBLED WITH KL-10 PARAMETER FILE - KLSYM.MAC
     5
     6					IF2,<IFNDEF LISTSN,<		;LIST KLSYM.MAC IN COMMON ONLY
     7								TAPE>>
     8				TITLE	MAPIO	MAPPED IO ROUTINES
     9
    10					STOPCD(,ENTRY,MAPIO)^
    11					ENTRY	MAPIO		;For library searches
    12	000000'	260040	000000*	MAPIO::PUSHJ	P,DIE		;**** Default stopcode for "MAPIO" ****
    13	000001'	554160	515700		SIXBIT	/MAPIO/  	;Title of module
    14	000002'	000000	000000		S$NONAME,,0		;?NONAME stopcode "MAPIO+nnn(nnnnnn)"
    15			000000'	S$NAME==MAPIO			;For STOPCDs with no arguments
    16					SALL>
    17				^
    18
    19				;EXTERNALS
    20
    21				EXTERN DEVRET,DEVATB,DEVRBN,DEVRIB,DEYRPS,DEVLOK,DEVBTS,DEPFLK
    22				EXTERN DEVFLO,DEVRB1,DEVDBL,DEVSZS,DEVSUP,DEVDRB
    23
    24				EXTERN UNIPPU,UNTTBL,UNISTR,UNYLUN,UNTLEN
    25
    26				EXTERN STRDDB,STRPPU,STRUNI,STRNAM,STRUNM
    27
    28				EXTERN DRBRIB,DRBALC
    29
    30				EXTERN RBREAL,RBMASK,RIBLST,RBYPNO,RBYUNI,RIBSTS,RBLVSP,RIBSLF
    31				EXTERN RIBPFS,RIBSFS,RIBRIB,RIBLCW,RIPBDR,RIPUFE,RBYUN1,RIBSIZ
    32				EXTERN RIBALP
    33
    34				EXTERN ATYBSZ,ATBMWC,ATMMWC,ATBLOK,ATYWSZ,ATBDUM,ATBSIZ,ATSWRD
    35				EXTERN ATSBLK,ATBFNB,ATBRIB,ATBSTS,ATPMXU,INCUMC,CNVATB,ATBLCW
    36				EXTERN ATPUFE,ATPCRE,ATPDEL,ATPSUP,ATYALP,ATBALP
    37
    38				EXTERN PGYDIO,PGYSIO,PGYUSE,PGYDRT,DECUSE,INCUSE
    39
    40				EXTERN FNBDBL,FNYUFP
    41
    42				EXTERN SPTVIR,SPMUSC,SPTUSC,SPPVIR
    43
    44				EXTERN UUYCPR,UUYSVM,UUYCTG
    45
    46				EXTERN MAPRLS,%SAT.C,MAPWTU,GETSAT,RELRIB,RELSAT,RELRB2,UPDADS
    47				EXTERN IOSUPR,CHKQTA,FBIT,KEPPAG,SMMPXC,MAPRDU,%CTSTS
    48				EXTERN GIVPAG,MAPWTL,PCBPTR,%RIB.C,%CTUPT,MAPXCH,IOBDRB
    49				EXTERN %RB2.C,MAPCML,GETM2,RELM2,WATPCB,STAWTU,STAWTL,STACML
    50				EXTERN STAWLN
    51
    52				EXTERN USETST,PTROU0,PTRCHG,PTRINN,PTRLEN,RIBCON,PTROU2,NXTPT0
    53
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 1
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

    54				EXTERN RIBCKD
    55
    56				EXTERN SRCCHT,INSCHT,SRCSPT,INSSPT,DECRMV
    57
    58				EXTERN LMPSHR,LM3CUR,LMMEXS,LMPMXW,LMPREF,LMPVIR,LMPSUP,LMPNER
    59				EXTERN LM3SPT,LM3ATB,LM3HDA,MAXCPR
    60				EXTERN LMYSPT,LMPACT,LMMERR,LMMCUR,LMMMXW,LMMSUP,LMNCUR,LMMRDW
    61
    62				EXTERN STOLMA,GETDPA,GETATB,SETSHR,DEALMA,KREMOV
    63
    64				EXTERN UFDNAM,UFDEXT,UFDSIZ,UFPERR,UFDERR,UFDALP
    65
    66				EXTERN VPUMAX,CPOPJ1,NORED,NOWRT,STOP1,WSCHED,PUUOAC
    67				EXTERN PJBSTS,PJOBN,RNQ,SETRUN,JOB,CPOPJ,JBTSTS,CURUPT,JBTWCT
    68				EXTERN ALIASD,JBYRPT,JBYWPT,REMCHT,REMSPT,REMWAT,SRUNI,REMUWS
    69				EXTERN REMMWS,%UPT,%UPLMA,JBTSOT,JBTUPM,%UPT.N,PVYCOR,JBTMPC
    70				EXTERN VLNVP%,VL.WAT,UPTLDC,%COW.N,VLIOE%,%COW,UPDAC2,GTCGSZ
    71				EXTERN TIMADJ,FLWQ,JBTNAM,JBTUNM
    72				EXTERN GETLMA,UPTJOB,LMASRP,REDLMA,SETLMA
    73
    74				EXTERN PS.DER,PS.DTE,PE.NER
    75
    76				EXTERN SETACH
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 2
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

    77				;ERROR FLAGS:
    78
    79
    80			000000	FALCTG==:0	;CONTIG FIELD IN ARG BLOCK IS 0.
    81						;(MAP,SMAP,REMOVE,CLEAR,REPLIC)
    82
    83			000001	FALDVR==:1	;DESTINATION VM PAGE NO. IN ARG BLOCK IS OR WILL
    84						;BE OUT OF ALLOWABLE RANGE.
    85						;(MAP,SMAP,REMOVE,CLEAR,REPLIC,VFSTAT)
    86
    87			000002	FALCPU==:2	;CURRENT PROTECTION IN ARG BLOCK IS AN
    88						;UNDEFINED VALUE.
    89						;(MAP,SMAP,REPLIC)
    90
    91			000003	FALVEX==:3	;A VM PAGE WHICH MUST BE NON-EXISTENT EXISTS.
    92						;(MAP,SMAP,REPLIC)
    93
    94			000004	FALNEX==:4	;A VM PAGE WHICH MUST EXIST IS NON-EXISTENT.
    95						;(REMOVE,REPLIC,VFSTAT)
    96
    97			000005	FALSVR==:5	;SOURCE VM PAGE NO. IN THE ARG BLOCK IS OR WILL
    98						;BE OUT OF ALLOWABLE RANGE.
    99						;(REPLIC)
   100
   101			000006	FALPHP==:6	;A SPECIFIED FILE PAGE IS PAST THE EOF,
   102						;OR SUPER MAP AND PAST BOUNDS OF UNIT OR STR,
   103						;OR FTRNC AND REQ SIZE IS > CURRENT.
   104						;(MAP,SMAP,FDELETE,FEXCH,FTRNC)
   105
   106			000007	FALFPZ==:7	;A SPECIFIED FILE PAGE IS <=0.
   107						;(MAP,SMAP(<0 ONLY),FCREATE,FDELETE,FEXCH,FTRNC)
   108
   109			000010	FALCOR==:10	;USER'S ALLOWABLE AMOUNT OF CORE WILL BE
   110						;EXCEEDED.
   111						;(MAP,SMAP,REPLIC)
   112
   113			000011	FALRBE==:11	;RIB ERROR.
   114						;(MAP,FCREATE,FDELETE,FEXCH,FTRNC)
   115
   116			000012	FALBDS==:12	;BAD SAT.
   117						;(MAP,REPLIC,VFSAT)
   118
   119			000013	FALCPL==:13	;THE CURRENT PROTECTION IN THE ARG BLOCK IS NOT
   120						;LEGAL, AS OPPOSED TO BEING UNDEFINED (FALCPU).
   121						;(MAP,SMAP,REPLIC)
   122
   123			000014	FALLKO==:14	;TRYING TO MAP A LOOKUP ONLY FILE.
   124						;(MAP)
   125
   126			000015	FALHOL==:15	;A FILE PAGE IS A HOLE.
   127						;(MAP,FDELETE)
   128
   129			000016	FALNHL==:16	;A FILE PAGE WHICH MUST BE NON-EXISTENT(=A HOLE
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 2-2
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

   130						;OR PAST EOF) EXISTS.
   131						;(FCREATE)
   132
   133			000017	FALSNM==:17	;SUPER MAP AND THE NAME INITED IS NEITHER STR
   134						;NOR UNIT.
   135						;(SMAP)
   136
   137			000020	FALOPE==:20	;IO ERROR ON VALIDATION WRITE OF PAGE.
   138						;(REMOVE,CLEAR)
   139
   140			000021	FALSAM==:21	;THE TWO PAGE NUMBER ARGS (FILE OR VM) ARE
   141						;IDENTICAL.
   142						;(FEXCH,REPLIC)
   143
   144			000022	FALNML==:22	;SUPER MAP AND A FILE HAS BEEN LOOKED UP OR
   145						;ENTERED ON THIS CHANNEL.
   146						;(SMAP)
   147
   148			000023	FALNOF==:23	;NO FILE HAS BEEN LOOKED UP/ ENTERED ON THIS
   149						;CHANNEL.
   150						;(MAP,FCREATE,FTRNC,
   151						;FDELETE,FEXCH,FVLRIB)
   152
   153			000024	FALNWT==:24	;FILE NOT ENTERED, OR ENTERED BUT APPEND ONLY.
   154						;(FCREATE,FDELETE,FEXCH,FTRNC)
   155
   156			000025	FALAQA==:25	;DISK FULL OR USER'S DISK QUOTA IS EXCEEDED.
   157						;(FCREATE)
   158
   159			000026	FALCTL==:26	;CONTROL C HAPPENED AND WE WERE WATCHING FOR IT.
   160						;(USED ONLY INTERNALLY HERE.).
   161
   162			000027	FALIPE==:27	;IO ERROR ON READ OF A PAGE.
   163						;(NOT RETURNED BY A UUO/KERNEL ROUTINE.)
   164
   165			000030	FALNTF==:30	;A RET PNTR OF THE DESIRED TYPE IS NOT IN THE
   166						;FILE IN THE AREA WE WERE ASKED TO SEARCH.
   167						;(FFIFP AND FRIENDS).
   168
   169			000031	FALNIM==:31	;A FUNCTION ASKED FOR IS NOT IMPLEMENTED.
   170						;(FFIFP AND FRIENDS).
   171
   172			000032	FALLGE==:32	;ASKED TO NOT LOG IO ERRORS IN BAT PAGES, BUT
   173						;NOT PRIVILEDGED TO ASK THIS.
   174						;(REMOVE,CLEAR).
   175
   176			000033	FALNSP==:33	;ASKED TO TRUNCATE FILE, BUT REQUESTED SIZE IS
   177						;NOT IN THE LAST PAGE.
   178						;(FTRNC).
   179			000034	FALOFF==:34	;"OTHER FRAME" FAILURE. GIVEN IF GET ACCESS
   180						; RIGHTS FAILURE, BAD SAT, ETC.
   181			000035	FALALF==:35	;VP ALREADY MAPPABLE FROM A FILE
   182			000036	FALNSE==:36	;TRYING TO INSERT SUPER MAPPED VP INTO FILE
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 2-3
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

   183
   184				DEFINE FALERR(ERR,GO)<JRST	[MOVEI T1,FAL'ERR
   185				IFNB <GO>,<		  JRST 'GO]>
   186				IFB <GO>,<		 JRST VUOOUT]>
   187				>;END FALERR MACRO DEFINITION
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 3
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

   188				COMMENT #
   189				@@SUBROUTINE KMAPP
   190				@@PURPOSE
   191				KERNEL SUBROUTINE TO MAP FILE PAGES TO VIRTUAL PAGES.
   192				@@ENTRY
   193				EXPECTS USER ARGS IN T1 AND T2 AND F/ DDB AND S/ DEVIOS.
   194				JOB NUMBER IN J, CORRECT CONTEXT PAGES SETUP IN %UPX.
   195				SIGN BIT OF T1 IS ON IFF USER MODE CALLER.
   196				@@ACCUM
   197				DESTROYS P1-P4, T1-T4, U, AND PG.
   198				@@EXIT
   199				SKIP RETURNS UNLESS ERROR, IN WHICH CASE IT NON-SKIP RETURNS.
   200				ON NON-SKIP RETURN, THE LH OF T1 HAS THE NO. OF THE VM PAGE ON
   201				WHICH THE FAILURE OCCURRED, AND THE RH OF T1 HAS THE ERROR
   202				CODE AS FOLLOWS:  FALCTG,FALDVR,FALCPU,FALVEX,FALPHP,FALCOR,
   203				FALRBE,FALBDS,FALCPL,FALLKO,FALHOL,FALNOF,FALFPZ.
   204				@@#
   205
   206				;FLAGS THAT WIND UP IN P2 FOR CHGMAP AND END OF MAP
   207
   208			400000		MF.USR==(1B0)		;MUST BE SIGN BIT, SAYS USER CALLED MAP
   209			200000		MF.GHP==(1B1)		;SAYS CALLER TRIED TO MAP OFF EOF, MAP
   210								; WILL MAP EVERYTHING UP TO EOF AND THEN GIVE ERROR RETURN.
   211
   212				EXTERNAL SETLMX,%UPLMX
   213
   214
   215				INTERN KMAPP
   216
   217				    ;CONTIG, AND W/ 1ST DESTINATION VM PAGE NUMBER.
   218	000003'	702600	400000*	KMAPP:	NOCHARGE	;STOP THE CLOCK.
   219	000004'	260040	001007'		PUSHJ	P,SETARG	;THE ARGS.
   220	000005'	263040	000000		  POPJ	P,		;ERROR CODE IS IN T1.
   221	000006'	260040	001026'		PUSHJ	P,CHKPVY	;MAKE SURE NOT GOING OVER EXISTENCE LIMIT
   222	000007'	263040	000000		  POPJ	P,		;YES, ERROR CODE IN T1.
   223					JUMPLE	M,[MOVEI T1,FALFPZ ;BAD FILE PAGE ARG
   224	000010'	323540	003731'			   JRST VUOOUT]	;IF LESS OR EQUAL TO ZERO.
   225	000011'	607200	060000		TLNN	F,LOOKB!ENTRB	;IS THERE A FILE OPEN ON THIS
   226	000012'	254000	003733'		FALERR	(NOF)
   227					;NO CHANNEL.
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 4
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

   228				    ;HERE TO ACCESS A REAL FILE.
   229
   230				      ;CHECK FOR LOOKUP ONLY AND SOME OF REQUESTED CURRENT
   231				      ;PROTECTION > ALLOWED.
   232	000013'	603000	000000*	MAPFIL:	TLNE	S,IOBDRB	;IS THIS A DEAD FILE?
   233	000014'	254000	003735'		FALERR	(RBE)
   234					;YES.
   235	000015'	510304	000007		HLLZ	T1,DEVIAD(F)	;CATCH
   236	000016'	603200	020000		TLNE	F,ENTRB		;LOOKUP ONLY FILES HERE.
   237	000017'	254000	000024'		JRST	MAPFI2		;CAN'T BE LOOK ONLY IF ENTRB ON.
   238	000020'	603300	000000*		TLNE	T1,NORED	;JUST LOKUP DONE, LOK ONLY FLG?
   239	000021'	254000	003737'		FALERR	(LKO)
   240					;YES, CAN'T MAP.
   241	000022'	623700	000000*		TLZE	P3,LMPMXW	;SKIP IF PROTECTION NOT READ/WRITE
   242	000023'	254000	003741'		FALERR	(CPL)
   243						;IS ASKING FOR READ WRITE, BUT DOESN'T HAVE WRITE ACCESS TO FILE
   244
   245				      ;LOCK FILE, DETERMINE SIZE, AND CHECK REST OF CUR PROT.
   246	000024'	202004	000002	MAPFI2:	MOVEM	S,DEVIOS(F)	;
   247	000025'	260040	003650'		PUSHJ	P,LOKUNM	;LOCK FILE FOR READING.
   248	000026'	200004	000002		MOVE	S,DEVIOS(F)	;DID THE FILE DIE WHILE WE
   249	000027'	603000	000013*		TLNE	S,IOBDRB	;WERE WAITING FOR THE LOCK?
   250	000030'	254000	003743'		FALERR	(RBE,MPROU1)
   251					;YES.
   252	000031'	550344	000000*		HRRZ	T2,DEVATB(F)	;
   253	000032'	326340	000034'		JUMPN	T2,.+2		;
   254	000033'	256000	000000'		 STOPCD                         ;;MAPFI2+7
   255	000034'	135440	000000*		LDB	T4,ATYBSZ	;CALC
   256	000035'	271440	000003		ADDI	T4,3		;T4/
   257	000036'	242440	777776		LSH	T4,B2PLSH	;HPW.
   258	000037'	603200	020000		TLNE	F,ENTRB		;IS THIS APPEND ONLY
   259	000040'	607300	000000*		TLNN	T1,NOWRT	; (IF NOT OK TO HAVE LMPMXW ON FROM SETARG)
   260	000041'	254000	000054'		 JRST	MAPF21		;NOT APPEND ONLY STATE.
   261	000042'	135400	000000*		LDB	T3,LM3CUR	;GET DESIRED PROTECTION
   262	000043'	302400	000003		CAIE	T3,CPRRDW	;IS HE TRYING TO WRITE
   263	000044'	254000	000054'		 JRST	MAPF21		;NOT TRYING TO WRITE, LMPMXW IS OFF, LEAVE IT THAT WAY.
   264	000045'	331000	000014		SKIPL	P1		;SPECIAL LAST PAGE OF
   265	000046'	607200	000010		TLNN	F,GETB		;APP
   266	000047'	254000	003745'		 FALERR	(CPL,MPROU1)
   267					;ONLY
   268	000050'	306640	000001		CAIN	P2,1		;FILE FOR
   269	000051'	312540	000011		CAME	M,T4		;SIM OF OLD STYLE IO?
   270	000052'	254000	003745'		 FALERR	(CPL,MPROU1)
   271	000053'	661700	000022*		TLO	P3,LMPMXW	;SET THIS SINCE IT WON'T BE SET BELOW.
   272
   273				;NOW SET P1 TO THE COUNT OF PAGES WE HAVE TO MAP
   274				; AND SET FLAGS MF.GHP (MAPPING MORE THAN IS IN FILE) AND
   275				; MF.USR (USER CALLED MAP, SET FOR CHGMAP) IN P2.
   276
   277	000054'	200740	000014	MAPF21:	MOVE	P4,P1		;SAVE USER FLAG IN P4
   278	000055'	313540	000011		CAMLE	M,T4		;1ST REQ PAGE > HPW
   279	000056'	254000	003747'		FALERR	(PHP,MPROU1)
   280					;YES.
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 4-2
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

   281	000057'	350600	000011		AOS	P1,T4		;HPW+1
   282	000060'	274600	000013		SUB	P1,M		;HPW+1-FIRST FP = NUMBER OF PAGES IN FILE PAST FIRST FP
   283	000061'	313640	000014		CAMLE	P2,P1		;IS USER'S COUNT LESS OR EQUAL COUNT HE CAN HAVE?
   284					JRST	[MOVSI P2,MF.GHP	;NO, GIVE ERROR WHEN THRU MAPPING
   285	000062'	254000	003751'			 JRST MAPF22]	;AND LEAVE MAX COUNT IN P1
   286	000063'	200600	000015		MOVE	P1,P2		;YES, GET USER'S COUNT INTO P1
   287	000064'	400640	000000		SETZ	P2,		;AND CLEAR FLAGS IN P2.
   288	000065'	335000	000017	MAPF22:	SKIPGE	P4		;USER BIT MOVED TO P4, MOVE IT AGAIN TO P2
   289	000066'	661640	400000		TLO	P2,MF.USR	;SO CHGMAP CAN CHECK IT.
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 5
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

   290				      ;HERE TO DO THE ACTUAL MAPPING.
   291
   292	000067'	607200	020000	MAPFI3:	TLNN	F,ENTRB		;SET LMPMXW ACORDING TO ENTRB SETTING.
   293	000070'	254000	000073'		JRST	.+3		;(APPEND ONLY SIMIO CASE HANDLED ABOVE.)
   294	000071'	607300	000040*		TLNN	T1,NOWRT	;
   295	000072'	661700	000053*		TLO	P3,LMPMXW	;
   296	000073'	261040	000014		PUSH	P,P1		;SAVE ORIGINAL COUNT FOR CHGING.
   297	000074'	260040	000000*		PUSHJ	P,USETST	;SET @DEVRET TO 1ST PAGE WANTED.
   298	000075'	254000	000151'		  JRST	MPROU2		;ERROR RETURN, BAD RIB.
   299
   300	000076'	200004	000002	MAPF34:	MOVE	S,DEVIOS(F)	;DID THE FILE GO BAD WHILE WE
   301	000077'	603000	000027*		TLNE	S,IOBDRB	;WAITED IN MAPKRN?
   302	000100'	254000	000151'		JRST	MPROU2		;YES.
   303	000101'	337364	000000*		SKIPG	T2,@DEVRET(F)	;GET RET PNTR.
   304	000102'	256000	003753'		 STOPCD (.,JOB,MPFBRP,,<MAPF error - Bad Retreival Pointer>);;MAPF34+4
   305	000103'	607340	000000*		TLNN	T2,RBREAL	;A REAL PNTR?
   306	000104'	254000	003756'		FALERR	(HOL,MPROU2)
   307					;FELL INTO A HOLE.
   308	000105'	200312	000000*		MOVE	T1,%UPLMX(W)	;GET OLD LMAP SLOT
   309	000106'	603300	000000*		TLNE	T1,LMMEXS	;EXIST ALREADY?
   310	000107'	254000	003760'		FALERR	(VEX,MPROU2)
   311					;YES.
   312	000110'	603300	000000*		TLNE	T1,LMPREF	;GET REF BIT FROM OLD SLOT
   313	000111'	661700	000110*		TLO	P3,LMPREF
   314	000112'	550304	000031*		HRRZ	T1,DEVATB(F)	;SET UP ARGS FOR MAPKRN, T1/
   315	000113'	260040	003417'		PUSHJ	P,MAPKRN	;P3 HAS PROTOTYPE LMAP SLOT.
   316	000114'	254000	003762'		  FALERR (BDS,MPROU2)
   317					;ERROR RETURN, BAD SAT.
   318	000115'	661700	000000*		TLO	P3,LMPVIR	;SET VIRGIN BIT, MEANS TRY TO GET FREE
   319								; CORE PAGE AND START WITHOUT SWAPPER.
   320	000116'	260040	000000*		PUSHJ	P,SETLMX	;NEW SLOT, LEAVE LDC ZERO.
   321	000117'	271500	000001		ADDI	W,1		;DO THIS HERE FOR EXITS.
   322	000120'	363600	000134'		SOJLE	P1,MAPFI5	;ANY MORE <= HPW?
   323	000121'	404700	003764'		AND	P3,[(<LMMMXW>)]	;JUST THESE BITS
   324	000122'	260040	003126'		PUSHJ	P,GETRET	;YES, GET NEXT DEVRET.
   325	000123'	254000	000145'		JRST	MPORBR		;RIB ERROR.
   326	000124'	271540	000001		ADDI	M,1		;FOR USETSTING.
   327	000125'	331364	000101*		SKIPL	T2,@DEVRET(F)	;POINTING TO A SPARE?
   328	000126'	254000	000131'		JRST	MAPF36		;NO.
   329	000127'	260040	000074*		PUSHJ	P,USETST	;YES, GET A REAL.
   330	000130'	254000	000143'		JRST	MPORB0		;
   331	000131'	332020	000000*	MAPF36:	SKIPE	@%RIB.C+%CTUPT	;FAST CHECK INSTEAD OF
   332	000132'	260040	000000*		PUSHJ	P,RELRIB	;WHOLE ROUTINE.
   333	000133'	254000	000076'		JRST	MAPF34		;
   334
   335				      ;HERE ON END OF MAPPING.
   336	000134'	603640	200000	MAPFI5:	TLNE	P2,MF.GHP	;NEED TO TELL USER HE TRIED TO MAP TOO MUCH?
   337	000135'	254000	003765'		FALERR	(PHP,MPROU2)
   338					;YES, RETURN WITH EVERYTHING UP TO EOF MAPPED.
   339	000136'	260040	000166'		PUSHJ	P,CHGMAP	;CHARGE, ALSO ADJUST JBTUPM.
   340	000137'	260040	000000*		PUSHJ	P,RELSAT	;
   341	000140'	260040	000132*		PUSHJ	P,RELRIB	;
   342	000141'	260040	003541'		PUSHJ	P,UNLFIL	;
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 5-2
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

   343	000142'	254000	000000*		JRST	CPOPJ1		;
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 6
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

   344				      ;ERROR EXITS.
   345
   346	000143'	260040	000137*	MPORB0:	PUSHJ	P,RELSAT	;
   347	000144'	254000	003767'		FALERR	(RBE,MPORB1)
   348
   349	000145'	260040	000143*	MPORBR:	PUSHJ	P,RELSAT	;HERE ON RIB ERROR.
   350	000146'	260040	003175'		PUSHJ	P,KILFIL	;
   351	000147'	260040	000166'	MPORB1:	PUSHJ	P,CHGMAP	;
   352	000150'	254000	000164'		JRST	VUOOUT		;
   353
   354	000151'	260040	000166'	MPROU2:	PUSHJ	P,CHGMAP	;CHG AND ADJUST JBTUPM.
   355	000152'	202004	000002		MOVEM	S,DEVIOS(F)
   356	000153'	261040	000006		PUSH	P,T1		;SAVE ERROR CODE.
   357	000154'	260040	000145*		PUSHJ	P,RELSAT	;
   358	000155'	260040	000140*		PUSHJLRIB	;
   359	000156'	262040	000006		POP	P,T1		;RESTORE ERROR CODE.
   360	000157'	260040	003541'	MPROU1:	PUSHJ	P,UNLFIL	;
   361	000160'	254000	000164'		JRST	VUOOUT
   362
   363
   364
   365				    ;SOME GENERAL ERROR EXITS.
   366	000161'	261040	000006	VUOFL0:	PUSH	P,T1		;
   367	000162'	260040	000154*		PUSHJ	P,RELSAT	;
   368	000163'	262040	000006		POP	P,T1		;
   369	000164'	505312	000000	VUOOUT::HRLI	T1,(W)		;
   370	000165'	263040	000000		POPJ	P,
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 7
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

   371				COMMENT #
   372				@@SUBROUTINE CHGMAP
   373				@@PURPOSE
   374				SUBR TO CHARGE FOR MAPPING PAGES AND ALSO ADJUST JBTUPM.
   375				@@ENTRY
   376				EXPECTS ON THE PDL JUST AFTER THE CALLER, THE ORIGINAL COUNT
   377				OF PAGES TO BE MAPPED.  ALSO EXPECTS P1/ CURRENT COUNT, J/ JOB
   378				NO., W/ NO. OF VM PAGE AFTER THE LAST ONE SUCCESSFULLY MAPPED,
   379				AND MF.USR = 1B0 SET TO 1 IN P2 IFF USER CALLED MAP.
   380				@@ACCUM
   381				DESTROYS T2, T3, AND T4.
   382				#
   383
   384	000166'	262040	000010	CHGMAP:	POP	P,T3		;T3/ CALLER.
   385	000167'	250401	000000		EXCH	T3,(P)		;T3/ ORIGINAL CNT AND PDL OK.
   386	000170'	275414	000000		SUBI	T3,(P1)		;T3/ NO. OF PAGES MAPPED.
   387	000171'	325640	000176'		JUMPGE	P2,CHGMP2	;NO CHARGE IF CALLED FROM EXEC.
   388	000172'	201350	000000		MOVEI	T2,(T3)		;CHARGE IN UNITS OF 4 SINCE VCRE
   389	000173'	242340	000002		LSH	T2,2		;IS 1/4 A MAP CHARGE.
   390	000174'	272342	000000*		ADDM	T2,JBTMPC(J)	;CHARGE FOR
   391	000175'	272340	000174*		ADDM	T2,JBTMPC	;THEM.
   392	000176'	201352	000000	CHGMP2:	MOVEI	T2,(W)		;DON'T ADJUST UPM FOR >777.
   393	000177'	275340	001000		SUBI	T2,1000		;GET T2/ THE NO. OF PAGES
   394	000200'	323340	000204'		JUMPLE	T2,CHGMP4	;MAPPED ABOVE 777.
   395	000201'	301350	000000		CAIL	T2,(T3)		;ANY PAGES BELOW OR AT 777?
   396	000202'	634400	000010		TDZA	T3,T3		;NO.
   397	000203'	275407	000000		SUBI	T3,(T2)		;YES.
   398	000204'	515410	000000	CHGMP4:	HRLZI	T3,(T3)		;
   399	000205'	272402	000000*		ADDM	T3,JBTUPM(J)	;
   400	000206'	263040	000000		POPJ	P,
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 8
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

   401				COMMENT #
   402				@@SUBROUTINE KSMAPP
   403				@@PURPOSE
   404				KERNEL SUBROUTINE TO SUPER MAP DISK PAGES TO VIRTUAL PAGES.
   405				@@ENTRY
   406				EXPECTS USER ARGS IN T1 AND T2 AND F/ DDB AND S/ DEVIOS.
   407				JOB NUMBER IN J, CORRECT CONTEXT PAGES SETUP IN %UPX.
   408				SIGN BIT OF T1 IS ON IFF USER MODE CALLER.
   409				@@ACCUM
   410				DESTROYS P1-P4, T1-T4, U, AND PG.
   411				@@EXIT
   412				SKIP RETURNS UNLESS ERROR, IN WHICH CASE IT NON-SKIP RETURNS.
   413				ON NON-SKIP RETURN, THE LH OF T1 HAS THE NO. OF THE VM PAGE ON
   414				WHICH THE FAILURE OCCURRED, AND THE RH OF T1 HAS THE ERROR
   415				CODE AS FOLLOWS:  FALCTG,FALDVR,FALCPU,FALVEX,FALPHP,FALCOR,
   416				FALCPL,FALNML,FALFPZ.
   417				@@#
   418
   419
   420
   421	000207'	260040	001007'	KSMAPP::PUSHJ	P,SETARG	;THE ARGS.
   422	000210'	263040	000000		  POPJ	P,		;GIVE ERROR RETURN, CODE IN T1
   423					JUMPL	M,[MOVEI T1,FALFPZ
   424	000211'	321540	003731'			   JRST VUOOUT]	;NEGATIVE ARG NO GOOD.
   425	000212'	603200	060000		TLNE	F,LOOKB!ENTRB	;IS THERE A FILE OPEN ON THIS
   426	000213'	254000	003771'		FALERR	(NML)
   427						;CHANNEL
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 9
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

   428				    ;HERE TO ACCESS VIA SUPER USETI/O.
   429
   430				      ;CHECK PRIVILEDGES, FIND UNIT VS. STR, AND CHECK FIRST
   431				      ;PAGE IN BOUNDS.
   432	000214'	603000	000000*	MAPUST:	TLNE	S,IOSUPR	;ALREADY SET UP?
   433					JRST	[HRRZ U,DEVSUP(F) ;YES.
   434	000215'	254000	003773'			JRST MAPUS1]	;
   435	000216'	260040	000315'		PUSHJ	P,SUPBEG	;CHK PRIV, FIND UNIT VS. STR.
   436	000217'	254000	000164'		JRST	VUOOUT		;FAIL.
   437	000220'	260040	000303'	MAPUS1:	PUSHJ	P,SUPBND	;REQUESTED PAGE IN BOUNDS?
   438	000221'	254000	000164'		  JRST	VUOOUT		;NO.
   439	000222'	326240	000234'		JUMPN	U,MAPUS2	;YES.  HAVE TO PAW THRU STR?
   440	000223'	200300	000013		MOVE	T1,M		;YES,
   441	000224'	201240	000000*		MOVEI	U,STRDDB	; Get structure data block
   442				PRINTF(<[MAPUS1+5 Can't have different size units in structure?]>)
   443	000225'	230305	000000*		IDIV	T1,STRPPU(U)	;FIND
   444	000226'	200540	000007		MOVE	M,T2		;U/ UNIT
   445	000227'	554245	000000*		HLRZ	U,STRUNI(U)	;AND
   446	000230'	361300	000234'		SOJL	T1,MAPUS2	;M/ PAGE
   447	000231'	554245	000000*		HLRZ	U,UNISTR(U)	;NUMBER WRS
   448	000232'	326240	000230'		JUMPN	U,.-2		;UNIT.
   449	000233'	256000	000000'		 STOPCD                         ;;MAPUS1+12
   450
   451				      ;HERE TO BUILD PROTOTYPE NEW SLOTS IN P3.
   452	000234'	510304	000007	MAPUS2:	HLLZ	T1,DEVIAD(F)	;LEGAL TO
   453	000235'	607300	000071*		TLNN	T1,NOWRT	;WRITE?
   454	000236'	665700	000072*		TLOA	P3,LMPMXW	;NOWRT NOT SET, LET CALLER WRITE, SKIP PRTECTION CHECK
   455	000237'	627700	000236*		TLZN	P3,LMPMXW	;CALLER CAN'T WRITE, MAKE SURE HE'S NOT TRYING TO
   456	000240'	254000	000242'		JRST	.+2		;ALLOWED TO WRITE OR NOT TRYING TO
   457	000241'	254000	003741'		FALERR	(CPL)
   458						;ILLEGAL CUR PROT.
   459	000242'	661700	000000*		TLO	P3,LMPSUP	;SET SUPER PAGE.
   460
   461				      ;HERE WITH PROTOTYPE SLOT IN P3, U/ UNIT DB, AND T2/
   462				      ;PAGE NO. WRS UNIT.
   463	000243'	554312	000105*	MAPUS4:	HLRZ	T1,%UPLMX(W)	;VM
   464	000244'	602300	000106*		TRNE	T1,LMMEXS	;PAGE
   465	000245'	254000	003775'		FALERR	(VEX)
   466						;CAN'T ALREADY EXIST.
   467	000246'	602300	000111*		TRNE	T1,LMPREF	;COPY REF BIT TO P3
   468	000247'	665700	000000*		TLOA	P3,LMPREF+LMPVIR	 ;AND SET VIRGIN
   469	000250'	661700	000115*		TLO	P3,LMPVIR	;NO REF BIT, JUST SET VIRGIN.
   470	000251'	200340	000013		MOVE	T2,M		;GET DESIRED PAGE INTO T2
   471	000252'	135300	000000*		LDB	T1,UNYLUN	;TURN INTO RETRIEVAL POINTER
   472	000253'	137300	000000*		DPB	T1,RBYUNI	;
   473	000254'	550740	000007		HRRZ	P4,T2		;GET LOW DISK ADDRESS
   474	000255'	620740	400000		TRZ	P4,PGE.A	;ONLY ACCESS BIT IS NOT USED.
   475	000256'	242340	000000*		LSH	T2,-LMASRP	;GET HIGH DISK ADDRESS ADJUSTED
   476	000257'	137340	000000*		DPB	T2,LM3HDA	;PUT IT INTO THE SLOT
   477	000260'	260040	000116*		PUSHJ	P,SETLMX	;REAL SLOT NOW, STORE AND LEAVE LDC ZERO.
   478	000261'	260040	000275'		PUSHJ	P,INCUPM	;INC LH OF JBTUPM.
   479	000262'	363640	000142*		SOJLE	P2,CPOPJ1	;ANOTHER PAGE TO DO?
   480	000263'	404700	003777'		AND	P3,[(<LMMSUP>)]	; YES, CLEAR ALL BUT RELEVANT BITS
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 9-2
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

   481	000264'	344540	000265'		AOJA	M,.+1		;SEE IF WE WILL
   482	000265'	315545	000000*		CAMGE	M,UNIPPU(U)	;GO OVER EO UNIT.
   483	000266'	344500	000243'		AOJA	W,MAPUS4	;NO, OKAY.
   484	000267'	550304	000000*		HRRZ	T1,DEVSUP(F)	;YES, ARE WE ON ONE
   485					JUMPN	T1,[MOVEI T1,FALPHP ;UNIT ONLY?
   486	000270'	326300	004000'			JRST VUOOUT]	;
   487	000271'	554245	000231*		HLRZ	U,UNISTR(U)	;NO, OKAY SO FAR, GO TO
   488					JUMPE	U,[MOVEI T1,FALPHP ;NEXT UNIT.
   489	000272'	322240	004000'			JRST VUOOUT]	;
   490	000273'	400540	000000		SETZ	M,		;OKAY, CONTINUE.
   491	000274'	344500	000243'		AOJA	W,MAPUS4	;
   492
   493
   494
   495
   496
   497
   498				;TINY SUBR TO INC/DEC THE LH OF JBTUPM.
   499
   500				INTERN DECUPM
   501
   502	000275'	205300	000001	INCUPM:	MOVSI	T1,1		;
   503	000276'	254000	000300'		JRST	.+2		;
   504	000277'	205300	777777	DECUPM:	MOVSI	T1,-1		;
   505	000300'	606500	777000		TRNN	W,777000	;SKIP IF NOT FROM 0-777.
   506	000301'	272302	000205*		ADDM	T1,JBTUPM(J)	;
   507	000302'	263040	000000		POPJ	P,
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 10
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

   508				COMMENT #
   509				@@SUBROUTINE SUPBND
   510				@@PURPOSE
   511				TINY SUBR TO CHECK BOUNDS OF REQ PAGE NUMBER FOR SUPER IO.
   512				@@ENTRY
   513				EXPECTS M/ REQ PAGE NO. AND U/ DEVSUP.
   514				@@ACCUM
   515				DESTROYS T1.
   516				@@EXIT
   517				SKIP UNLESS OUT OF BOUNDS, IN WHICH CASE IT NON-SKIP
   518				RETURNS WITH FALPHP IN T1.
   519				@@ #
   520
   521	000303'	322240	000310'	SUPBND::JUMPE	U,SPRBNS	;JUMP ON STR INITED.
   522
   523				    ;HERE ON UNIT INITED.
   524	000304'	200305	000265*	SPRBNU:	MOVE	T1,UNIPPU(U)	;GET T1/ NO. OF PAGES
   525	000305'	315540	000006	SPRBN2:	CAMGE	M,T1		;REQ PAGE WITHIN UNIT? or STR?
   526	000306'	254000	000262*		  JRST	CPOPJ1		;YES.
   527	000307'	254000	004002'		FALERR	(PHP,CPOPJ)
   528
   529				    ;HERE ON STR INITED.
   530				PRINTF(<[SPRBNS STR inited? Does U already have a STR pointer?]>)
   531	000310'	201240	000224*	SPRBNS:	MOVEI	U,STRDDB	; Does U already contain pointer?
   532	000311'	550305	000000*		HRRZ	T1,STRUNM(U)	;GET T1/ NO. OF
   533	000312'	220305	000225*		IMUL	T1,STRPPU(U)	;PAGES ON THE STR.
   534	000313'	201240	000000		MOVEI	U,0		;*HACK*; Reset U back to 0 for STR inited
   535	000314'	254000	000305'		JRST	SPRBN2		;
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 11
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

   536				COMMENT #
   537				@@SUBROUTINE SUPBEG
   538				@@PURPOSE
   539				SUBR TO INITIALIZE SUPER IO.  CHECKS PRIVILEDGES AND DETERMINES
   540				IF STR OR UNIT IS INITED.
   541				@@ENTRY
   542				EXPECTS F/DDB, S/ DEVIOS.
   543				@@ACCUM
   544				DESTROYS T1-T4 AND U.
   545				@@EXIT
   546				1-SKIP RETURNS ON OKAY WITH IOSUPR TURNED ON AND DEVSUP AND
   547				U SET AS FOLLOWS: FOR STR INITED, DEVSUP AND U BOTH =0;
   548				FOR UNIT INITED, DEVSUP AND U BOTH =UNIT DB ADDR.
   549				NON-SKIP RETURNS ON ERROR:  LACK OF PRIVILEDGE RETURNS
   550				T1/ FALNOF,  NEITHER UNIT NOR STR RETURNS T1/ FALSNM.
   551				@@ #
   552
   553				      ;SEE IF THE USER HAS THE PRIVILEDGE TO DO THIS.
   554	000315'	205340	000000*	SUPBEG::MOVSI	T2,NORED+NOWRT
   555	000316'	412344	000007		ANDCAM	T2,DEVIAD(F)	;RESET FLAGS.
   556	000317'	261040	000002		PUSH	P,J
   557	000320'	135100	000000*		LDB	J,PJOBN
   558	000321'	135400	000000*		LDB	T3,JBYRPT
   559	000322'	306400	000003		CAIN	T3,3
   560	000323'	621340	000020*		  TLZ	T2,NORED	;HE CAN READ.
   561	000324'	135400	000000*		LDB	T3,JBYWPT
   562	000325'	306400	000003		CAIN	T3,3
   563	000326'	201340	000000		  MOVEI	T2,0		;HE CAN DO BOTH.
   564	000327'	262040	000002		POP	P,J
   565	000330'	641340	000000*		TLC	T2,NORED!NOWRT
   566	000331'	201300	000023		MOVEI	T1,FALNOF	;
   567	000332'	647340	000000*		TLCN	T2,NORED!NOWRT	;BOTH STILL ON??
   568	000333'	263040	000000		  POPJ	P,		;YES, ERROR.
   569	000334'	436344	000007		IORM	T2,DEVIAD(F)	;SAVE IT.
   570
   571				      ;HERE TO DETERMINE THE UNIT TO USE.
   572	000335'	513004	000267*		HLLZS	DEVSUP(F)	;ASSUME STR.
   573	000336'	200304	000000		MOVE	T1,DEVNAM(F)	;NAME USER INITED.
   574	000337'	400240	000000		SETZ	U,		;FLAG FOR STR INITED.
   575				PRINTF(<[SUPBEG++ Check STRNAM - Why bother if DSKB is only STR]>)
   576	000340'	312300	000000*		CAME	T1,STRNAM+STRDDB ;STR NAME?
   577	000341'	260040	000000*		  PUSHJ	P,ALIASD	;NO, IS NAME ALIAS FOR "DSK"?
   578	000342'	254000	000347'		 JRST	SUPOUT		;YES.  "DSK" OR STR.
   579	000343'	260040	000000*		PUSHJ	P,SRUNI		;A UNIT NAME?
   580	000344'	254000	004004'		 FALERR	(SNM,CPOPJ)
   581					;NO, ERROR.
   582	000345'	255000	000000		 JFCL
   583	000346'	542244	000335*		HRRM	U,DEVSUP(F)	;SAVE UNIT & SAY UNIT, NOT STR.
   584	000347'	661000	000214*	SUPOUT:	TLO	S,IOSUPR	;
   585	000350'	202004	000002		MOVEM	S,DEVIOS(F)	;
   586	000351'	254000	000306*		JRST	CPOPJ1		;
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 12
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

   587				COMMENT #
   588				@@SUBROUTINE KREPLC
   589				@@PURPOSE
   590				KERNEL SUBROUTINE TO REPLICATE VM PAGES.
   591				@@ENTRY
   592				EXPECTS T1/ USER'S ARG, PLUS BIT 0 IS SET IFF CAME FROM
   593				USER MODE.
   594				CONTEXT PAGES FOR SOURCE AND DESTINATION MUST BE LOCKED.
   595				OTFFLG SET IN T1 AND/OR T2 IFF THAT ARG REFERS TO A MAP OTHER THAN CALLER'S.
   596				(CALLER MUST TURN OFF OTFFLG IF "OTHER" SPACE IS CALLER'S).
   597				J NOT SETUP ON CALL TO KREPLC.
   598				@@ACCUM
   599				DESTROYS P1-P4, T1-T4, U, M, J, AND PG.
   600				@@EXIT
   601				ALWAYS GUARANTEED TO RETURN EXCEPT IF THERE IS A SWAP ERROR.
   602				(SO CALLER CAN GIVE BACK CONTEXT PAGE LOCKS.)
   603				SKIP RETURNS UNLESS ERROR, IN WHICH CASE IT NON-SKIP RETURNS.
   604				ON NON-SKIP RETURN, LH(T1) CONTAINS THE NO. OF THE DESTINATION
   605				VM PAGE ON WHICH THE FAILURE OCCURED, AND RH(T1) CONTAINS THE
   606				ERROR CODE AS FOLLOWS:  FALCTG,FALDVR,FALCPU,FALVEX,FALNEX,
   607				FALSVR,FALCOR,FALBDS,FALCPL,FALSAM.
   608
   609				@@ #
   610
   611				EXTERNAL OTFFLG,%UPX,FD2FNO,%UPLMX,UPTOFD
   612
   613				    ;GET THE ARGS.
   614	000352'	260040	001007'	KREPLC::PUSHJ	P,SETARG	;SET THINGS UP.
   615	000353'	263040	000000		  POPJ	P,		;RETURN, T1 HAS ERROR CODE DATA
   616	000354'	200100	000000*		MOVE	J,%UPT+UPTJOB	;ASSUME DESTINATION IS THIS FRAME
   617	000355'	607600	000000*		TLNN	P1,OTFFLG	;IS IT?
   618	000356'	254000	000362'		  JRST	KREPNO		;NOT OTHER.
   619	000357'	200740	000000*		MOVE	P4,%UPT+UPTOFD	;GET "OTHER FRAME DESCRIPTOR"
   620	000360'	260040	000000*		PUSHJ	P,FD2FNO	;DESCRIPTOR HAS ALREADY BEEN CHECKED,
   621	000361'	256000	000000'		 STOPCD				;;KREPLC+7
   622								;J GETS DESTINATION FRAME NUMBER.
   623	000362'	260040	001026'	KREPNO:	PUSHJ	P,CHKPVY	;MAKE SURE NOT GOING OVER EXISTENCE LIMIT
   624	000363'	263040	000000		  POPJ	P,		;IS, ERROR CODE IS IN T1
   625
   626				;CHECK SOURCE RANGE FOR LEGALITY
   627
   628	000364'	550300	000013		HRRZ	T1,M		;GET SOURCE VP START PAGE
   629	000365'	271315	777777		ADDI	T1,-1(P2)	;GET LAST PAGE TO REPLICATE FROM
   630	000366'	335000	000014		SKIPGE	P1		;SKIP IF EXEC
   631	000367'	307300	000777		  CAIG	T1,777		;USER, BOMB IF OVER 777.
   632	000370'	303300	001034		CAILE	T1,VPMAX	;MONITOR, ALLOWED TO TOUCH PER PROCESS PAGES
   633	000371'	254000	004006'		 FALERR	(SVR)
   634					;NO GOOD.
   635	000372'	607540	000355*		TLNN	M,OTFFLG	;SEE IF SOURCE AND DEST ARE IN SAME ADDRESS SPACE
   636	000373'	603600	000372*		TLNE	P1,OTFFLG
   637	000374'	254000	000376'		  JRST	.+2		;NOT BOTH IN CALLER'S SPACE, CHECK FOR BOTH IN OTHER SPACE.
   638	000375'	254000	000401'		 JRST	KREPL0		;BOTH IN CALLERS SPACE, MUST CHECK.
   639	000376'	603600	000373*		TLNE	P1,OTFFLG
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 12-2
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

   640	000377'	607540	000376*		TLNN	M,OTFFLG
   641	000400'	254000	000404'		  JRST	KREPL1		;NOT BOTH IN OTHER SPACE
   642	000401'	550300	000012	KREPL0:	HRRZ	T1,W		;BOTH IN SME SPACE, GET JUST VP
   643	000402'	306313	000000		CAIN	T1,(M)		;HAD BETTER BE DIFFERENT
   644	000403'	254000	004010'		 FALERR	(SAM)
   645						;NOT, ERROR.
   646
   647	000404'	621700	000237*	KREPL1:	TLZ	P3,LMPMXW	;MUST CHECK LM3CUR DIRECTLY, LOOP BELOW
   648								; COPIES MAX WRITE FROM SLOT.
   649	000405'	607600	000377*		TLNN	P1,OTFFLG	;SET J UP FOR DESTINATION
   650	000406'	334100	000000*		  SKIPA	J,%UPT+UPTJOB
   651	000407'	200100	000000*		 MOVE	J,%UPX+UPTJOB
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 13
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

   652	000410'	607600	000405*	REPLC1:	TLNN	P1,OTFFLG	;GET DESTINATION SLOT FROM PROPER MAP
   653	000411'	334312	000000*		  SKIPA	T1,%UPLMA(W)
   654	000412'	200312	000243*		 MOVE	T1,%UPLMX(W)
   655	000413'	603300	000244*		TLNE	T1,LMMEXS	;DOES IT EXIST?
   656	000414'	254000	004012'		 FALERR	(VEX,REPFAL)
   657					;YES, CAN'T REPLICATE ON TOP OF IT
   658	000415'	607300	000246*		TLNN	T1,LMPREF	;COPY OLD REF BIT TO P3
   659	000416'	625700	000415*		  TLZA	P3,LMPREF
   660	000417'	661700	000416*		 TLO	P3,LMPREF
   661	000420'	607540	000410*		TLNN	M,OTFFLG	;NOW MAKE SURE SOURCE EXISTS
   662	000421'	334453	000411*		  SKIPA	T4,%UPLMA(M)	;GET SOURCE SLOT FROM PROPER MAP
   663	000422'	200453	000412*		 MOVE	T4,%UPLMX(M)
   664	000423'	607440	000413*		TLNN	T4,LMMEXS
   665	000424'	254000	004014'		 FALERR	(NEX,REPFAL)
   666					;CAN'T REPLICATE FROM NON-EXISTENT
   667	000425'	404440	004016'		AND	T4,[LMPMXW+LMPVIR+LMPNER+LMPSUP,,0] ;BITS NEEDED FROM SOURCE SLOT
   668	000426'	434700	000011		IOR	P3,T4		;PUT INTO PROTOTYPE DESTINATION SLOT.
   669	000427'	135300	000042*		LDB	T1,LM3CUR	;GET DESIRED PROTECTION
   670	000430'	306300	000003		CAIN	T1,CPRRDW	;IF CALLER REQUESTING READ/WRITE
   671	000431'	603440	000404*		  TLNE	T4,LMPMXW	;(IS) AND SOURCE SLOT NOT MAX WRITE,
   672	000432'	254000	000434'		 JRST	REPLC2		;(SOURCE IS MAX WRITE OR CALLER NOT REQUESTING MAX WRITE)
   673	000433'	254000	004017'		FALERR	(CPL,REPFAL)
   674					;CALLER CAN'T HAVE THAT MUCH ACCESS
   675
   676				    ;FIND DISK ADDR FROM THE SOURCE PAGE.
   677	000434'	261040	000016	REPLC2:	PUSH	P,P3		;SAVE LMAP ARG SETUP BY SETARG.
   678	000435'	260040	000502'		PUSHJ	P,REDSRC	;GET SOURCE SLOT INTO P3 AND P4
   679	000436'	260040	000000*		PUSHJ	P,GETDPA	;GET T2/ RETRIEVAL PNTR.
   680	000437'	621340	000000*		TLZ	T2,RBMASK
   681	000440'	661340	000103*		TLO	T2,RBREAL	;MAKE MAPKRN HAPPY.
   682	
   683	
   684
   685				    ;SPLIT HERE ON SUPER VS. NON-SUPER.
   686	000441'	603700	000242*		TLNE	P3,LMPSUP	;IS SOURCE PAGE A NORMAL PAGE?
   687	000442'	254000	000467'		  JRST	REPSUP		;NO, REPLICATE A SUPER PAGE.
   688
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 14
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

   689				    ;HERE ON NORMAL PAGE.  GET ATB ADDR FROM SOURCE PAGE.
   690
   691	000443'	260040	000000*		PUSHJ	P,GETATB	;GET ATB ADDRESS IN T1
   692								;DP ALREADY IN T2.
   693	000444'	262040	000016		POP	P,P3		;RESTORE PROTOTYPE LMAP SLOT FOR DESTINATION
   694	000445'	260040	003417'		PUSHJ	P,MAPKRN	;TRY TO MAP THE SLOT.
   695	000446'	254000	004021'		 FALERR	(BDS,REPFAL)
   696					;BAD SAT ON MAP ATTEMPT.
   697	000447'	135440	000000*		LDB	T4,LM3SPT	;IN CASE WE HAVE TO MAKE SOURCE SLOT SHARED.
   698	000450'	260040	000524'		PUSHJ	P,SETDST	;STORE COMPLETED SLOT BACK.
   699
   700				    ;HERE TO UPDATE THE OTHER SLOT.
   701	000451'	260040	000510'		PUSHJ	P,GETSRC	;GET SOURCE SLOT
   702	000452'	603700	000000*		TLNE	P3,LMPSHR	;
   703					  JRST	[EXCH W,M	;EXCHANGE W AND M BACK, GETSRC SWITCHED THEM
   704						 SOS  %UPT+UPTLDC
   705	000453'	254000	004023'			 JRST REPNXT]	;THROW DATA AWAY.
   706	000454'	260040	000000*		PUSHJ	P,SETSHR	;MAKE THE SOURCE SLOT SHARED.
   707	000455'	260040	000514'		PUSHJ	P,STOSRC	;BACK INTO CONTEXT PAGES.
   708	000456'	260040	000275'	REPNXT:	PUSHJ	P,INCUPM	;
   709	000457'	363640	000465'		SOJLE	P2,REPOUT	;
   710	000460'	510700	000014		  HLLZ	P3,P1		;GET PROTECTION AND OTHER STUFF INTO P3
   711	000461'	242700	000000*		LSH	P3,^D7-LMNCUR	;GET PROTECTION IN PLACE.
   712	000462'	621700	000000*		TLZ	P3,-LMMCUR-1	;GET JUST PROTECTION.
   713								; REST WILL BE COPIED FROM SOURCE SLOT.
   714	000463'	350000	000013		AOS	M
   715	000464'	344500	000410'		AOJA	W,REPLC1	;
   716	000465'	350001	000000	REPOUT:	AOS	(P)
   717	000466'	324740	000162*		PJRST	RELSAT
   718
   719				    ;HERE ON SUPER PAGE.
   720	000467'	262040	000016	REPSUP:	POP	P,P3		;GET PROTO SLOT OFF STACK.
   721	000470'	550740	000007		HRRZ	P4,T2		;SET LOW DISK ADDRESS
   722	000471'	620740	400000		TRZ	P4,PGE.A	;ACCESS BIT CAN'T BE ON
   723	000472'	242340	000000*		LSH	T2,-LMASRP
   724	000473'	137340	000257*		DPB	T2,LM3HDA	;SET HI DISK ADDRESS
   725	000474'	260040	000524'		PUSHJ	P,SETDST	;STORE DESTINATION SLOT IN P3 AND P4 BACK.
   726	000475'	254000	000456'		JRST	REPNXT
   727
   728	000476'	261040	000006	REPFAL:	PUSH	P,T1
   729	000477'	260040	000466*		PUSHJ	P,RELSAT	;SAVE ERROR CODE, RELEASE SAT IF HAVE IT,
   730	000500'	262040	000006		POP	P,T1		;RESTORE ERROR CODE
   731	000501'	254000	000164'		JRST	VUOOUT		;PUT RH(W) IN LH(T1) AND RETURN.
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 15
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

   732				;SUBROUTINES TO GET SOURCE AND DESTINATION SLOT IN P3 AND P4
   733
   734				EXTERNAL GETLMA,GETLMX,REDLMA,REDLMX,STOLMA,STOLMX,SETLMA,SETLMX
   735				;REDSRC, GET SOURCE SLOT AND LEAVE W AND M ALONE.
   736
   737	000502'	250500	000013	REDSRC:	EXCH	W,M		;GET SOURCE IN W
   738	000503'	607500	000420*		TLNN	W,OTFFLG	;IS SOURCE IN %UPX?
   739					  JRST	[PUSHJ P,REDLMA	;NO, GET FROM %UPT
   740						 EXCH  W,M
   741	000504'	254000	004026'			 POPJ  P,]	;GET W AND M BACK AND RETURN.
   742	000505'	260040	000000*		PUSHJ	P,REDLMX	;YES, GET FROM %UPX
   743	000506'	250500	000013		EXCH	W,M
   744	000507'	263040	000000		POPJ	P,
   745
   746				;GETSRC, GET SOURCE SLOT AND LEAVE W AND M EXCHANGED.
   747
   748	000510'	250500	000013	GETSRC:	EXCH	W,M
   749	000511'	607500	000503*		TLNN	W,OTFFLG
   750	000512'	324740	000000*		  PJRST	GETLMA
   751	000513'	324740	000000*		PJRST	GETLMX
   752
   753				;STOSRC, STORE SOURCE SLOT AND EXCHANGE W AND M BACK.
   754
   755	000514'	607500	000511*	STOSRC:	TLNN	W,OTFFLG
   756					  JRST	[PUSHJ P,STOLMA
   757						 EXCH  W,M
   758	000515'	254000	004031'			 POPJ  P,]
   759	000516'	260040	000000*		PUSHJ	P,STOLMX
   760	000517'	250500	000013		EXCH	W,M
   761	000520'	263040	000000		POPJ	P,
   762
   763
   764				;ROUTINES TO STORE DESTINATION SLOT.
   765
   766	000521'	607600	000514*	STODST:	TLNN	P1,OTFFLG
   767	000522'	324740	000000*		  PJRST	STOLMA
   768	000523'	324740	000516*		PJRST	STOLMX
   769
   770	000524'	607600	000521*	SETDST:	TLNN	P1,OTFFLG
   771	000525'	324740	000000*		  PJRST	SETLMA
   772	000526'	324740	000260*		PJRST	SETLMX
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 16
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

   773				COMMENT #
   774				@@SUBROUTINE KFFIFP
   775				@@PURPOSE
   776				KERNEL ROUTINE FOR CHANIO TO FIND FIRST INTERESTING RET PNTR
   777				IN A FILE.
   778				@@ENTRY
   779				EXPECTS USER ARGS IN T1 AND T2, F/ DDB, S/ DEVIOS, AND M/ ADDR
   780				IN USER SPACE TO RETURN VALUE.
   781				@@ACCUM
   782				DESTROYS T1-T4, P1-P4, U, AND PG.
   783				@@EXIT
   784				SKIP RETURNS UNLESS ERROR, IN WHICH CASE IT NON-SKIP RETURNS.
   785				ON SKIP RETURN THE NUMBER OF THE FIRST RET PNTR OF THE DESIRED
   786				TYPE HAS BEEN STORED THRU M.
   787				ON NON-SKIP RETURN THE RH OF T1 HAS THE ERROR CODE AS FOLLOWS:
   788				FALNOF, FALRBE, FALLKO, FALFPZ, FALNIM, FALPHP, FALNTF.
   789				@@#
   790
   791	000527'	607200	060000	KFFIFP::TLNN	F,LOOKB!ENTRB	;BETTER BE A FILE ON THIS
   792	000530'	254000	004034'		 FALERR	(NOF,CPOPJ)
   793					;CHANNEL.
   794	000531'	603000	000077*		TLNE	S,IOBDRB	;IS THIS A DEAD FILE?
   795					  JRST	[MOVEI T1,FALRBE ;YES.
   796	000532'	254000	004036'			 POPJ  P,]
   797	000533'	603200	020000		TLNE	F,ENTRB		;CATCH LOOKUP ONLY FILES HERE.
   798	000534'	254000	000540'		  JRST	KFFIF2		;CAN'T BE LOOK ONLY IF ENTRB ON.
   799	000535'	510404	000007		HLLZ	T3,DEVIAD(F)	;JUST LOOKUP DONE,
   800	000536'	603400	000323*		TLNE	T3,NORED	;LOOK ONLY FLAG?
   801	000537'	254000	004040'		 FALERR	(LKO,CPOPJ)
   802					;YES.
   803				KFFIF2:	JUMPLE	T1,[MOVEI T1,FALFPZ ;FILE PAGE ARG >0?
   804	000540'	323300	004042'			POPJ P,]
   805	000541'	331600	000007		SKIPL	P1,T2		;SET UP P1/
   806	000542'	303600	000001		  CAILE	P1,MATLEN	;TYPE OF MATCH.
   807	000543'	254000	004044'		 FALERR	(NIM,CPOPJ)
   808
   809				      ;LOCK FILE, DETERMINE SIZE, AND SET UP SOME ACS.
   810	000544'	202004	000002		MOVEM	S,DEVIOS(F)	;
   811	000545'	260040	003650'		PUSHJ	P,LOKUNM	;LOCK FILE FOR READING.
   812	000546'	200004	000002		MOVE	S,DEVIOS(F)	;DID THE FILE DIE WHILE WE
   813	000547'	603000	000531*		TLNE	S,IOBDRB	;WERE WAITING FOR THE LOCK?
   814	000550'	254000	004046'		 FALERR	(RBE,UNLFIL)
   815					;YES, RIB ERROR.
   816	000551'	550344	000112*		HRRZ	T2,DEVATB(F)	;NO.
   817	000552'	326340	000554'		JUMPN	T2,.+2		;CALC
   818	000553'	256000	000000'		 STOPCD                         ;;KFFIF2+11
   819	000554'	135640	000034*		LDB	P2,ATYBSZ	;
   820	000555'	271640	000003		ADDI	P2,3		;P2/
   821	000556'	242640	777776		LSH	P2,B2PLSH	;HPW.
   822	000557'	313300	000015		CAMLE	T1,P2		;REQUESTED STARTING PAGE
   823	000560'	254000	004050'		 FALERR	(PHP,UNLFIL)
   824					;PAST EOF.
   825	000561'	261040	000013		PUSH	P,M		;SAVE M.
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 16-2
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

   826	000562'	200540	000006		MOVE	M,T1		;
   827
   828				    ;HERE WITH M/ NO. OF FIRST RET PNTR TO LOOK AT, P1/ TYPE OF
   829				    ;MATCH, AND P2/ HPW.
   830	000563'	260040	000127*	KFFIF4:	PUSHJ	P,USETST	;POINT @DEVRET TO REQ PAGE.
   831					  JRST	[POP  P,M	;RIB ERROR.  USETST HAS
   832	000564'	254000	004052'			 POPJ P,]	;ALREADY KILLED THE FILE.
   833				    ;SEARCH FOR A MATCH IN THIS DDB PNTR AREA.
   834	000565'	200344	000125*		MOVE	T2,DEVRET(F)	;
   835	000566'	337307	000000	KFFI42:	SKIPG	T1,(T2)		;GET RET PNTR.
   836	000567'	254000	000575'		  JRST	KFFI44		;BETTER BE EXPECTING EOF.
   837	000570'	256014	000675'		XCT	MATCH(P1)	;DOES C(T1) MATCH CONDITION?
   838	000571'	254000	000651'		  JRST	KFFMTD		;YES.
   839	000572'	305344	000000*		CAIGE	T2,DEVRBN(F)	;NO. ANOTHER PNTR IN THIS DDB?
   840	000573'	344340	000566'		  AOJA	T2,KFFI42	;YES, GO LOOK AT IT.
   841	000574'	254000	000603'		 JRST	KFFIF5
   842	000575'	274344	000565*	KFFI44:	SUB	T2,DEVRET(F)	;
   843	000576'	271547	000000		ADDI	M,(T2)		;
   844	000577'	275540	000001		SUBI	M,1		;
   845	000600'	312540	000015		CAME	M,P2		;
   846	000601'	256000	000000'		 STOPCD                         ;;KFFI44+4
   847	000602'	254000	000646'		JRST	KFFNTF		;
   848
   849				    ;NO MATCH IN OUR DDB.
   850	000603'	200544	000000*	KFFIF5:	MOVE	M,DEVFLO(F)	;SET
   851	000604'	271540	000003		ADDI	M,3		;M/
   852	000605'	242540	777776		LSH	M,-2		;NO. OF PAGE
   853	000606'	271540	000000*		ADDI	M,PTRLEN	;JUST AFTER OUR DDB AREA.
   854	000607'	313540	000015		CAMLE	M,P2		;IS IT PAST EOF?
   855	000610'	254000	000646'		  JRST	KFFNTF		;YES.
   856	000611'	336020	000000*		SKIPN	@%RIB.C+%CTUPT	;NO.  IF WE DON'T HAVE A RIB,
   857	000612'	254000	000563'		  JRST	KFFIF4		;MAYBE PAGE IS IN A DDB ALREADY.
   858
   859				    ;LOOK IN THE RIB WE HAVE.  (USETST HAS FLUSHED DDBS INTO
   860				    ;IT, SO WE DON'T HAVE TO.).
   861	000613'	135340	000000*		LDB	T2,DEYRPS	;OUT OF PNTRS IN
   862	000614'	301340	000000*		CAIL	T2,RIBLST	;THIS RIB?
   863	000615'	254000	000644'		  JRST	KFFI64		;YES.
   864	000616'	200300	000015		MOVE	T1,P2		;NO.  T1/ NO. OF PAGES BETWEEN
   865	000617'	274300	000013		SUB	T1,M		;NEXT AND
   866	000620'	271300	000001		ADDI	T1,1		;EOF INCLUSIVE.
   867	000621'	201400	000614*		MOVEI	T3,RIBLST	;T3/ NO. OF PAGES BETWEEN NEXT
   868	000622'	275407	000000		SUBI	T3,(T2)		;AND EO RIB.
   869	000623'	313400	000006		CAMLE	T3,T1		;T3/ NO. OF RET PNTRS TO
   870	000624'	200400	000006		  MOVE	T3,T1		;LOOK AT.
   871	000625'	271340	000001		ADDI	T2,1		;
   872	000626'	337307	376000	KFFIF6:	SKIPG	T1,%RIB(T2)	;
   873	000627'	256000	000000'		 STOPCD                         ;;KFFIF6+1
   874	000630'	256014	000675'		XCT	MATCH(P1)	;MATCH?
   875	000631'	254000	000660'		  JRST	KFFMTR		;YES.
   876	000632'	271340	000001		ADDI	T2,1		;NO.
   877	000633'	367400	000626'		SOJG	T3,KFFIF6	;
   878				    ;HERE ON NO MATCH IN THIS RIB, OR PERHAPS EOF.
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 16-3
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

   879	000634'	305340	000621*		CAIGE	T2,RIBLST	;STOPPED BEFORE EO RIB?
   880	000635'	254000	000646'		  JRST	KFFNTF		;YES, MUST BE EO FILE.
   881	000636'	135340	000613*		LDB	T2,DEYRPS	;NO.  MAYBE EOF, MAYBE
   882	000637'	201400	000634*		MOVEI	T3,RIBLST	;NOT.  CHECK
   883	000640'	275407	000000		SUBI	T3,(T2)		;TO
   884	000641'	271550	000000		ADDI	M,(T3)		;SEE
   885	000642'	313540	000015		CAMLE	M,P2		;WHICH.
   886	000643'	254000	000646'		  JRST	KFFNTF		;EOF.
   887	000644'	260040	000155*	KFFI64:	PUSHJ	P,RELRIB	;STILL RET PNTRS LEFT TO
   888	000645'	254000	000563'		JRST	KFFIF4		;LOOK AT.
   889	
   890	000646'	262040	000013	KFFNTF:	POP	P,M		;YES, FAIL
   891	000647'	260040	000644*		PUSHJ	P,RELRIB	;RETURN
   892	000650'	254000	004054'		 FALERR	(NTF,UNLFIL)
   893					;WITH NOT FOUND FLAG.
   894
   895				    ;HERE ON A MATCH IN OUR DDB.
   896	000651'	274344	000575*	KFFMTD:	SUB	T2,DEVRET(F)	;GET T2/ NO. OF
   897	000652'	270340	000013		ADD	T2,M		;FOUND PAGE.
   898	000653'	262040	000013	KFFMOT:	POP	P,M		;RESTORE M/ PLACE TO STORE.
   899	000654'	256200	004056'		UMOVEM	T2,(M)		;STORE FOUND RET PNTR NO.
   900	000655'	260040	000647*		PUSHJ	P,RELRIB	;MAYBE RELEASE THE RIB.
   901	000656'	260040	003541'		PUSHJ	P,UNLFIL	;UNLOCK THE FILE.
   902	000657'	254000	000351*		JRST	CPOPJ1		;SUCCESS RETURN.
   903
   904				    ;HERE ON A MATCH IN OUR RIB.
   905	000660'	135300	000636*	KFFMTR:	LDB	T1,DEYRPS	;SET DEYRPS JUST BEFORE
   906	000661'	370400	000007		SOS	T3,T2		;OUR FOUND
   907	000662'	137340	000660*		DPB	T2,DEYRPS	;PLACE, AND SET T4/ NEW
   908	000663'	275406	777777		SUBI	T3,-1(T1)	;DEVFLO IN PAGES, BOTH FOR
   909	000664'	271550	777777		ADDI	M,-1(T3)	;PTRINN, WHICH WILL SET UP
   910	000665'	200444	000603*		MOVE	T4,DEVFLO(F)	;THE DDB AREA STARTING
   911	000666'	271440	000003		ADDI	T4,3		;WITH OUR
   912	000667'	242440	777776		LSH	T4,-2		;FOUND
   913	000670'	271450	777777*		ADDI	T4,PTRLEN-1(T3)	;PLACE.  ALSO CALC M/
   914	000671'	260040	000000*		PUSHJ	P,PTRINN	;NO. OF FOUND RET PNTR.
   915	000672'	256000	000000'		 STOPCD                         ;;KFFMTR+12
   916	000673'	200340	000013		MOVE	T2,M		;
   917	000674'	254000	000653'		JRST	KFFMOT		;
   918
   919
   920	000675'	607300	000440*	MATCH:	TLNN	T1,RBREAL	;0 FFFFP.
   921	000676'	603300	000675*		TLNE	T1,RBREAL	;1 FFUFP.
   922			000001	MATLEN==.-MATCH-1
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 17
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

   923				COMMENT #
   924				@@SUBROUTINE KFILCK
   925				@@PURPOSE
   926				KERNEL SUBROUTINE TO SEE IF A VM PAGE HAS ITS F BIT SET.
   927				@@ENTRY
   928				EXPECTS USER ARG IN T1 AND M/ ADDR IN USER SPACE TO RETURN
   929				VALUE.
   930				SIGN BIT OF T1 IS ON IFF USER MODE CALLER.
   931				@@ACCUM
   932				DESTROYS T1-T4, P1-P4, U, W, AND PG.
   933				@@EXIT
   934				SKIP RETURNS UNLESS ERROR, IN WHICH CASE IT NON-SKIP RETURNS.
   935				ON SKIP RETURN, M HAS BEEN USED TO RETURN 0 TO USER IF PAGE IS
   936				NOT IN A FILE, ELSE 1.
   937				ON NON-SKIP RETURN, THE RH OF T1 HAS THE ERROR CODE AS FOLLOWS:
   938				FALDVR,FALNEX,FALBDS.
   939				@@#
   940
   941	000677'	627300	400000	KFILCK::TLZN	T1,400000	;USER?
   942	000700'	256000	000000'		 STOPCD                         ;;KFILCK+2
   943	000701'	303300	000777		CAILE	T1,^D511	;YES, VP NUMBER IN RANGE?
   944					  JRST	[MOVEI T1,FALDVR ;NO.
   945	000702'	254000	004057'			 POPJ  P,]	;
   946	000703'	550500	000006		HRRZ	W,T1		;GET PAGE NUMBER IN W
   947	000704'	260040	000000*		PUSHJ	P,REDLMA	;GET LMAP SLOT.
   948	000705'	607700	000423*		TLNN	P3,LMMEXS	;EXISTS?
   949	000706'	254000	004061'		 FALERR	(NEX,CPOPJ)
   950	000707'	400600	000000		SETZ	P1,		;P1/ 0 MEANS NOT IN A FILE.
   951	000710'	261040	000002		PUSH	P,J		;SET J/
   952	000711'	200100	000000*		MOVE	J,JOB		;JOB NUMBER.
   953	000712'	603700	000441*		TLNE	P3,LMPSUP	;IS SUPER?
   954	000713'	254000	000717'		  JRST	KFILC4		;YES.
   955	000714'	260040	000443*		PUSHJ	P,GETATB	;GET T1/ ATB ADDR.
   956	000715'	335006	000000*		SKIPGE	ATBDUM(T1)	;FILE PAGE?
   957	000716'	254000	000727'		  JRST	KFILC6		;NO.
   958	000717'	260040	000436*	KFILC4:	PUSHJ	P,GETDPA	;MAYBE.  GET T2/ RET PNTR.
   959	000720'	661340	000676*		TLO	T2,RBREAL	;GET THE SAT FOR THIS
   960	000721'	201300	000000*		MOVEI	T1,MAPRDU	;PAGE IN AND UNLOCKED
   961	000722'	260040	000000*		PUSHJ	P,GETSAT	;GET T1/MASK,T3/OFFSET IN SAT
   962					  JRST	[PUSHJ P,RELSAT	;BAD SAT. RELEASE IN CASE READ
   963						 MOVEI T1,FALBDS ;TELL USER BAD SAT
   964						 POP   P,J	;
   965	000723'	254000	004063'			 POPJ  P,]	;
   966	000724'	616310	377000		TDNN	T1,%SAT+FBITS(T3);IN A FILE?
   967	000725'	201600	000001		 MOVEI	P1,1		;YES.
   968	000726'	260040	000477*		PUSHJ	P,RELSAT	;RELEASE THE SAT.
   969	000727'	256200	004067'	KFILC6:	UMOVEM	P1,(M)		;RETURN VALUE TO USER.
   970	000730'	262040	000002		POP	P,J		;
   971	000731'	254000	000657*		JRST	CPOPJ1		;SUCCESS RETURN.
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 18
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

   972				COMMENT #
   973				@@SUBROUTINE KVLRIB
   974				@@PURPOSE
   975				KERNEL SUBROUTINE TO VALIDATE THE RIBS OF A FILE.
   976				FIRST FLUSHES OUT OUR DDB AREA, AND ALSO UPDATES THE FILE SIZE
   977				FIELD IN THE PRIME RIB.
   978				@@ENTRY
   979				EXPECTS F/ DDB AND S/ DEVIOS.
   980				@@ACCUM
   981				DESTROYS
   982				@@EXIT
   983				SKIP RETURNS UNLESS ERROR, IN WHICH CASE IT NON-SKIP RETURNS.
   984				ON NON-SKIP RETURN, THE RH OF T1 HAS THE ERROR CODE AS FOLLOWS:
   985				FALNOF, FALRBE, FALNWT.
   986				@@#
   987
   988
   989	000732'	607200	060000	KVLRIB::TLNN	F,LOOKB!ENTRB	;A FILE ON THIS CHANNEL?
   990	000733'	254000	004034'		 FALERR	(NOF,CPOPJ)
   991	000734'	607200	020000		TLNN	F,ENTRB		;IF WE AREN'T WRITING, WE
   992	000735'	254000	004070'		 FALERR	(NWT,CPOPJ)
   993					;HAVE NOTHING TO UPDATE.
   994	000736'	260040	003650'		PUSHJ	P,LOKUNM	;LOCK THE FILE.
   995	000737'	200004	000002		MOVE	S,DEVIOS(F)	;IS THE
   996	000740'	603000	000547*		TLNE	S,IOBDRB	;FILE BAD?
   997	000741'	254000	004046'		 FALERR	(RBE,UNLFIL)
   998					;YES, RIB ERROR.
   999
  1000				     ;FIRST, HANDLE WRITING OUT OUR DDB AREA.
  1001	000742'	337004	000665*		SKIPG	DEVFLO(F)	;IS OUR DDB AREA VALID?
  1002	000743'	254000	000754'		  JRST	KVLRB4		;NO, FORGET IT.
  1003	000744'	510304	000007		HLLZ	T1,DEVIAD(F)	;YES, IS IT
  1004	000745'	607300	000000*		TLNN	T1,PTRCHG	;DIRTY?
  1005	000746'	254000	000754'		  JRST	KVLRB4		;NO, FORGET IT.
  1006	000747'	200304	000000*		MOVE	T1,DEVRIB(F)	;YES.  GET THE RIB FOR THIS
  1007	000750'	260040	003150'		PUSHJ	P,MWLRIB	;DDB, AND CHECK IT.
  1008	000751'	324740	003175'		PJRST	KILFIL		;BAD RIB.
  1009	000752'	260040	000000*		PUSHJ	P,PTROU0	;DUMP OUT THE PNTRS.
  1010	000753'	476004	000742*		SETOM	DEVFLO(F)	;INVALIDATE THE POINTERS SO WE
  1011								; CAN CHANGE DEVRIB WITHOUT WORRYING
  1012								; ABOUT OTHER JOB SCANNING THEM AND
  1013								; THINKING THEY ARE FROM WRONG RIB.
  1014
  1015				      ;GET THE PRIME RIB, TO UPDATE THE FILE SIZE.
  1016	000754'	550304	000551*	KVLRB4:	HRRZ	T1,DEVATB(F)	;GET T1/ RET PNTR
  1017	000755'	336306	000000*		SKIPN	T1,ATBRIB(T1)	;TO PRIME RIB.
  1018	000756'	256000	000000'		 STOPCD                         ;;KVLRB4+2
  1019	000757'	260040	003150'		PUSHJ	P,MWLRIB	;GET THE PRIME RIB.
  1020	000760'	324740	003175'		PJRST	KILFIL		;BAD RIB.
  1021	000761'	550344	000754*		HRRZ	T2,DEVATB(F)	;FIX UP RIBSIZ AND
  1022	000762'	200307	000000*		MOVE	T1,ATBSIZ(T2)	;RIBALP, AND DON'T
  1023	000763'	602300	000177		TRNE	T1,177		;WORRY ABOUT
  1024	000764'	275300	000200		  SUBI	T1,200		;THE UFD, BECAUSE DSKCLN WILL
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 18-2
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

  1025	000765'	202300	376000*		MOVEM	T1,%RIB+RIBSIZ	;FIX THAT AND IT IS TOO MUCH
  1026	000766'	200307	000000*		MOVE	T1,ATBALP(T2)	;OVERHEAD FOR US
  1027	000767'	202300	376000*		MOVEM	T1,%RIB+RIBALP	;TO DO IT.
  1028	000770'	260040	000655*		PUSHJ	P,RELRIB	;RELEASE THE RIB.
  1029	000771'	260040	003541'		PUSHJ	P,UNLFIL	;UNLOCK THE FILE.
  1030
  1031				    ;WAIT FOR ALL THE RIBS IN CORE TO GO TO DISK.
  1032	000772'	260040	000000*		PUSHJ	P,WATPCB	;WAIT FOR ALL RIBS
  1033	000773'	254000	000731*		JRST	CPOPJ1		;TO GO OUT.
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 19
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

  1034				COMMENT ;@@SUBROUTINE SETARG/SETARR
  1035				@@PURPOSE GET AND CHECK ARGUMENTS FOR MAP, REPLICATE, AND REMOVE.
  1036				@@ENTRY ENTER AT SETARR FOR REMOVE, SKIPS PROTECTION CHECKS.
  1037					ENTER AT SETARG FOR MAP AND REPLICATE.
  1038					T1/VUUO POINTER
  1039					  AND IF ENTER AT SETARG,
  1040					T2/ FILE PAGE FOR MAP, SOURCE VP DESCRIPTOR FOR REPLICATE.
  1041				@@ACCUM T1-T4, P1-P4,W
  1042				@@EXIT	P1/VUUO DESTINATION DESCRIPTOR BITS,,0
  1043					P2/COUNT
  1044					W/FIRST DESTINATION PAGE
  1045					AND IF CALLED AT SETARG,
  1046					M/SOURCE DESCRIPTOR
  1047					P3/LMYCUR SET TO CURRENT PROTECTION, LMPMXW IF PROTECTION IS READ/WRITE
  1048					P4/0
  1049	
  1050				ON SKIP/SUCCESS RETURN. ON FAIL/NON-SKIP RETURN, T1 CONTAINS
  1051				ONE OF THE FOLLOWING ERROR CODES:
  1052				  FALCTG	COUNT IS ZERO
  1053				  FALDVR	DESTINATION VP IS OR WILL BE OUT OF RANGE
  1054				  FALCPU	UNDEFINED CURRENT PROTECTION ARG
  1055
  1056				@@;
  1057
  1058	000774'	510600	000006	SETARR::HLLZ	P1,T1		;GET DESTINATION DESCRIPTOR
  1059	000775'	135500	000000*		LDB	W,UUYSVM	;GET FIRST DVP
  1060	000776'	135640	000000*		LDB	P2,UUYCTG	;GET COUNT
  1061					JUMPE	P2,[MOVEI T1,FALCTG
  1062	000777'	322640	004072'			    JRST SETAFL] ;BAD COUNT OF 0
  1063
  1064				;CHECK DESTINATION VP RANGE TO SEE IF LEGAL. (CALLER RESPONSIBLE
  1065				; FOR CHECKING SOURCE.)
  1066
  1067	001000'	200400	000012		MOVE	T3,W
  1068	001001'	271415	777777		ADDI	T3,-1(P2)	;GET LAST DEST VP
  1069	001002'	335000	000014		SKIPGE	P1		;ALLOW PER PROCESS VPS IF EXEC
  1070	001003'	307400	000777		  CAIG	T3,777		;USER, BOMB IF OVER 777
  1071	001004'	303400	001034		CAILE	T3,VPMAX	;EXEC, BOMB IF OVER VPMAX
  1072	001005'	254000	004074'		 FALERR	(DVR,SETAFL)
  1073					;BAD DESTINATION VP
  1074	001006'	254000	000773*		JRST	CPOPJ1
  1075
  1076	001007'	260040	000774'	SETARG::PUSHJ	P,SETARR	;DO COMMON STUFF.
  1077	001010'	263040	000000		  POPJ	P,		;ERROR.
  1078	001011'	200540	000007		MOVE	M,T2		;GET SOURCE DESCRIPTOR
  1079	001012'	403700	000017		SETZB	P3,P4		;CLEAR OUT EMBRYONIC LMAP SLOT
  1080	001013'	510300	000014		HLLZ	T1,P1		;GET FLAGS INTO T1 FOR UUYCPR
  1081	001014'	135340	000000*		LDB	T2,UUYCPR	;GET SPECIFIED PROTECTION
  1082					JUMPE	T2,[MOVEI T1,FALCPU
  1083	001015'	322340	004076'			    JRST SETAFL] ;ZERO IS BAD
  1084	001016'	303340	000000*		CAILE	T2,MAXCPR	;MAKE SURE NOT TOO BIG
  1085	001017'	254000	004076'		 FALERR	(CPU,SETAFL)
  1086	001020'	137340	000427*		DPB	T2,LM3CUR	;PUT IT IN WHERE IT GOES IN AN LMAP SLOT
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 19-2
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

  1087	001021'	306340	000003		CAIN	T2,CPRRDW	;READ/WRITE?
  1088	001022'	661700	000431*		  TLO	P3,LMPMXW	;YES, MAX WRITE WANTS TO BE ON (MAYBE
  1089								; CALLER WON'T ALLOW IT TO STAY ON.)
  1090	001023'	254000	001006*		JRST	CPOPJ1		;FINISHED.
  1091
  1092				;HERE ON FAILURE.
  1093
  1094	001024'	505312	000000	SETAFL:	HRLI	T1,(W)		;GET DEST VP,,ERROR CODE
  1095	001025'	263040	000000		POPJ	P,		;RETURN.
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 20
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

  1096				COMMENT ;@@SUBROUTINE CHKPVY
  1097				@@PURPOSE SEE IF ADDING C(P2) PAGES WILL EXCEED PVYCOR LIMIT
  1098				@@ENTRY P2/NUMBER OF PAGES TO ADD
  1099					W/FIRST VP NUMBER TO BE ADDED.
  1100					J/JOB NUMBER TO ADD PAGES TO.
  1101				@@ACCUM T1,T2
  1102				@@EXIT NON-SKIP IF NOT OK, FALCOR ERROR CODE IN T1.
  1103				SKIP IF OK
  1104				@@;
  1105
  1106	001026'	200340	000015	CHKPVY:	MOVE	T2,P2		;T2 WILL HAVE NUMBER OF USER PAGES BY CHKPV1 TIME.
  1107	001027'	550300	000012		HRRZ	T1,W		;GET START DP
  1108	001030'	271315	777777		ADDI	T1,-1(P2)	;GET END DP
  1109	001031'	307300	000777		CAIG	T1,777		;IF NO PAGES ABOVE 777,
  1110	001032'	254000	001036'		  JRST	CHKPV1		;GO
  1111	001033'	210340	000006		MOVN	T2,T1		;GET NEGATIVE NUMBER OF PAGES OVER 777
  1112	001034'	271355	000777		ADDI	T2,777(P2)	;GET NUMBER OF USER PAGES
  1113	001035'	323340	001023*		JUMPLE	T2,CPOPJ1	;NO USER PAGES AT ALL, RETURN.
  1114	001036'	554302	000301*	CHKPV1:	HLRZ	T1,JBTUPM(J)	;GET CURRENT SIZE
  1115	001037'	270340	000006		ADD	T2,T1		;T2 NOW HAS SIZE HE WILL BE IF WE DO THIS
  1116	001040'	135300	000000*		LDB	T1,PVYCOR	;GET MAGIC LIMIT
  1117	001041'	271300	000001		ADDI	T1,1
  1118	001042'	242300	000002		LSH	T1,2		;CONVERT TO PAGES.
  1119	001043'	317340	000006		CAMG	T2,T1		;SKIP IF NO GOOD
  1120	001044'	350001	000000		  AOS	(P)		;OK.
  1121	001045'	201300	000010		MOVEI	T1,FALCOR	;IN CASE ITS ERROR.
  1122	001046'	263040	000000		POPJ	P,
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 21
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

  1123				COMMENT #
  1124				@@SUBROUTINE SIMCRE
  1125				@@PURPOSE
  1126				SHELL SUBR TO SET UP FLAGS FOR KFCRE, SO IT KNOWS IT HAS BEEN
  1127				CALLED BY SIMIO, AND WILL DO SPECIAL FILE SIZE STUFF, AND
  1128				WON'T LET ARG OF -1 THRU.
  1129				@@ENTRY
  1130				EXPECTS T1/ USER ARG, F/ DDB, AND S/ DEVIOS.
  1131				@@ACCUM
  1132				DESTROYS T1-T4, U, AND PG.
  1133				@@EXIT
  1134				JUST LIKE KFCRE EXITS.
  1135				@@ #
  1136
  1137				INTERN SIMCRE
  1138
  1139	001047'	261040	000016	SIMCRE:	PUSH	P,P3		;SAVE P3 AND P4
  1140	001050'	261040	000017		PUSH	P,P4		;FOR SIMIO.
  1141	001051'	261040	000014		PUSH	P,P1		;
  1142	001052'	400700	000000		SETZ	P3,		;FLAG EXEC MODE.
  1143	001053'	474740	000000		SETO	P4,		;FLAG "FROM SIMIO".
  1144	001054'	260040	001067'		PUSHJ	P,KFCREE	;
  1145	001055'	254000	001057'		  JRST	.+2		;CREATE FAILED.
  1146	001056'	350001	777775		AOS	-3(P)		;SET FOR SKIP RETURN.
  1147	001057'	262040	000014		POP	P,P1		;
  1148	001060'	262040	000017		POP	P,P4		;RESTORE
  1149	001061'	262040	000016		POP	P,P3		;P3 AND P4.
  1150	001062'	263040	000000		POPJ	P,
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 22
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

  1151				COMMENT #
  1152				@@SUBROUTINE KFCRE
  1153				@@PURPOSE
  1154				KERNEL SUBROUTINE TO CREATE A FILE PAGE.
  1155				@@ENTRY
  1156				EXPECTS T1/ USER ARG, T3/ BIT 0 SET IFF CALLED FROM USER MODE.
  1157				ALSO EXPECTS F/ DDB AND S/ DEVIOS.
  1158				EXPECTS M TO BE SET UP SO IT CAN STORE PAGE NUMBER FOR -1 CASE.
  1159				@@ACCUM
  1160				DESTROYS T1-T4, P1, P3-P4, U, AND PG.
  1161				@@EXIT
  1162				SKIP RETURNS FOR SUCCESS.
  1163				ON NON-SKIP RETURN, T1 CONTAINS THE ERROR FLAG AS FOLLOWS:
  1164				FALFPZ,FALRBE,FALNHL,FALNWT,FALAQA.
  1165				@@#
  1166
  1167	001063'	607400	400000	KFCRE::	TLNN	T3,400000	;SET P3 <>0 IF
  1168	001064'	634700	000016		 TDZA	P3,P3		; USER
  1169	001065'	474700	000000		  SETO	P3,		; MODE.
  1170	001066'	400740	000000		SETZ	P4,		;FLAG NOT FROM SIMIO.
  1171								;SIMIO enters here with P3=0, P4=-1
  1172	001067'	201400	001067'	KFCREE:	MOVEI	T3,KFCREE	;CHK FILE FOR WRITING, AND GET
  1173	001070'	260040	001750'		PUSHJ	P,DELXCH	; T1/ FILE NO. ARG AND T4/ HPW.
  1174	001071'	263040	000000		  POPJ	P,		;
  1175	001072'	327300	001100'		JUMPG	T1,KFCRE2	;JUMP IF OKAY ARG.
  1176	001073'	322300	001077'		JUMPE	T1,KFCRE1	;ARG OF ZERO ALWAYS ILLEGAL.
  1177	001074'	200340	000006		MOVE	T2,T1		;
  1178	001075'	346340	001077'		AOJN	T2,KFCRE1	;DON'T ALLOW LESS THAN -1
  1179	001076'	322740	001100'		JUMPE	P4,KFCRE2	;-1 OKAY IF NOT FROM SIMIO.
  1180	001077'	254000	004100'	KFCRE1:	FALERR	(FPZ,UNLFIL)
  1181	001100'	261040	000013	KFCRE2:	PUSH	P,M		;SAVE M.
  1182	001101'	200540	000006		MOVE	M,T1		;SET UP M FOR USETST AND OTHERS.
  1183	001102'	260040	000000*		PUSHJ	P,SETACH	;SET UFPALC, ASSUMING WE ARE GOING TO
  1184								; CHANGE SOMETHING (MAY NOT, BUT TOO
  1185								; MUCH TROUBLE TO UNRAVEL STUFF AFTER
  1186								; WE HAVE RIB - SETACH NEEDS CB AND %RIB)
  1187	001103'	317540	000011		CAMG	M,T4		;USER WANTS PAGE PAST HPW?
  1188	001104'	325540	001142'		 JUMPGE	M,CREAT4	;JUMP IF WITHIN EXISTING FILE.
  1189
  1190				    ;HERE ON ASKING FOR A PAGE PAST HPW.
  1191	001105'	550344	000761*	CREAT2:	HRRZ	T2,DEVATB(F)	;SAVE FILE SIZE
  1192	001106'	135300	000554*		LDB	T1,ATYBSZ	;FOR CHECK.
  1193	001107'	260040	003541'		PUSHJ	P,UNLFIL	;UNLOCK BEFORE LOCK MODIFY.
  1194	001110'	202004	000002		MOVEM	S,DEVIOS(F)	;
  1195	001111'	260040	003653'		PUSHJ	P,LOKMOD	;GET LOCKED MODIFY.
  1196	001112'	200004	000002		MOVE	S,DEVIOS(F)	;FILE DIED WHILE
  1197	001113'	603000	000740*		TLNE	S,IOBDRB	; WAITING?
  1198	001114'	254000	001717'		 JRST	DLXDR1		;YES.
  1199	001115'	135400	001106*		LDB	T3,ATYBSZ	;GET CURRENT FILE SIZE.
  1200	001116'	325540	001126'		JUMPGE	M,CREA24	;JUMP UNLESS LAST+1.
  1201	001117'	550541	000000		HRRZ	M,(P)		;
  1202	001120'	271400	000003		ADDI	T3,3		;CALC THE
  1203	001121'	242400	777776		LSH	T3,B2PLSH	; LAST PAGE
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 22-2
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

  1204	001122'	271400	000001		ADDI	T3,1		; +1.
  1205	001123'	256200	004102'		UMOVEM	T3,(M)		;TELL USER WHAT IT IS.
  1206	001124'	200540	000010		MOVE	M,T3		;SET UP M FOR THIS.
  1207	001125'	254000	001130'		JRST	CREA28		;GO DO IT.
  1208
  1209	001126'	312300	000010	CREA24:	CAME	T1,T3		;CHANGED WHILE WE WAITED?
  1210					 JRST	[ADDI T3,3	;YES.
  1211						 LSH T3,B2PLSH	;
  1212						 CAMLE	M,T3	;
  1213						  JRST CREA28	;
  1214						 PUSHJ P,LOKLES	;
  1215	001127'	254000	004103'			 JRST CREAT4]	;
  1216	001130'	201440	000001	CREA28:	MOVEI	T4,1		;CREATE 1 PAGE.
  1217	001131'	474300	000000		SETO	T1,		;OKAY.  SWEEP DOES ALL
  1218	001132'	260040	002215'		PUSHJ	P,SWEPPG	; THE WORK.
  1219					  JRST	[CAIE T1,FALAQA	;
  1220						 CAIN T1,FALRBE	;
  1221						  JRST DELDHO	;
  1222	001133'	254000	004111'			 STOPCD()]              ;;CREA28+3
  1223	001134'	322740	001206'		JUMPE	P4,CREOUT	;FINISH UP IF NOT FROM SIMIO.
  1224	001135'	550344	001105*		HRRZ	T2,DEVATB(F)	;FROM SIMIO.  ADJUST THE
  1225	001136'	200307	000762*		MOVE	T1,ATBSIZ(T2)	; FILE SIZE TO THE
  1226	001137'	275300	000577		SUBI	T1,577		; FIRST WORD IN
  1227	001140'	202307	001136*		MOVEM	T1,ATBSIZ(T2)	; THIS PAGE.
  1228	001141'	254000	001206'		JRST	CREOUT		;FINISH UP.
  1229
  1230				    ;HERE ON ASKING FOR A PAGE .LE. HPW.
  1231	001142'	510404	000007	CREAT4:	HLLZ	T3,DEVIAD(F)	;IS THE FILE
  1232	001143'	607400	000235*		TLNN	T3,NOWRT	;APPEND ONLY?
  1233	001144'	254000	001153'		 JRST	CREA44		;NO.
  1234	001145'	322740	001152'		JUMPE	P4,CREA42	;YES, FAIL IF NOT SIMIO
  1235	001146'	607200	000010		TLNN	F,GETB		;IF NOT SPECIAL CASE
  1236	001147'	254000	001152'		 JRST	CREA42		; FAIL.
  1237	001150'	316540	000011		CAMN	M,T4		;MAYBE.
  1238	001151'	254000	001153'		 JRST	CREA44		;WIN.
  1239	001152'	254000	004115'	CREA42:	FALERR	(NWT,DELDHO)
  1240	001153'	260040	001734'	CREA44:	PUSHJ	P,DELCRE	;GET DDB AND RIB SET UP.
  1241	001154'	254000	001720'		  JRST	DLXDR0		;
  1242	001155'	603340	000720*		TLNE	T2,RBREAL	;SLOT IS A HOLE?
  1243	001156'	254000	004117'		 FALERR	(NHL,DELDHO)
  1244	001157'	135400	000662*		LDB	T3,DEYRPS	;GET POSITION
  1245	001160'	270404	000651*		ADD	T3,DEVRET(F)	; OF SLOT IN
  1246	001161'	275404	000572*		SUBI	T3,DEVRBN(F)	; RIB, AND
  1247	001162'	261040	000010		PUSH	P,T3		; SAVE IT.
  1248	001163'	400340	000000		SETZ	T2,		;
  1249	001164'	201440	000000*		MOVEI	T4,RIBPFS	;CHECK TO SEE IF WE
  1250	001165'	332000	376000*		SKIPE	%RIB+RIBRIB	; CAN GET
  1251	001166'	201440	000000*		 MOVEI	T4,RIBSFS	; THE PREVIOUS
  1252	001167'	313400	000011		CAMLE	T3,T4		; PNTR, SO
  1253	001170'	200350	375777		 MOVE	T2,%RIB-1(T3)	; WE CAN BE CONTIGUOUS.
  1254	001171'	621340	000000*		TLZ	T2,RBMASK-RBREAL;T2 has retrieval pointer or zero
  1255	001172'	201600	000010		MOVEI	P1,FLG.CC	;OK to stop on Control-C
  1256	001173'	260040	002730'		PUSHJ	P,CREPAG	;Create the page
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 22-3
MAPIO.MAC	28-OCT-87 17:02		S.MAC - with system parameter file for P035/D, January 1988

  1257					  JRST	[POP P,T3	;ERROR RETURN, CLR PDL.
  1258						MOVEI T1,FALAQA	;FLAG CAN'T GET A PAGE.
  1259	001174'	254000	004121'			JRST DELDHO]	;ERROR EXIT.
  1260	001175'	262040	000010		POP	P,T3		;RESTORE PLACE IN RIB.
  1261	001176'	200004	000002		MOVE	S,DEVIOS(F)	;DID THE FILE GO BAD WHILE WE
  1262	001177'	603000	001113*		TLNE	S,IOBDRB	;WAITED IN CREPAG?
  1263					 JRST	[MOVEI T1,FALRBE ;YES.
  1264	001200'	254000	004124'			 JRST  DELDHO]	;
  1265	001201'	202350	376000		MOVEM	T2,%RIB(T3)	;NO.  STORE NEW PAGE IN RIB,
  1266	001202'	202364	001160*		MOVEM	T2,@DEVRET(F)	; OUR DDB, AND
  1267	001203'	260040	002554'		PUSHJ	P,ONESLT	; OTHER DDBS.
  1268	001204'	326740	001206'		JUMPN	P4,CREOUT	;IF THIS IS NOT SIMIO, THEN
  1269	001205'	260040	001213'		PUSHJ	P,RONDUP	;MAYBE ROUND UP THE FILE SIZE.
  1270	001206'	260040	000726*	CREOUT:	PUSHJ	P,RELSAT	;RELEASE THE SAT.
  1271	001207'	260040	003541'		PUSHJ	P,UNLFIL	;RELEASE THE FILE.
  1272	001210'	260040	000770*		PUSHJ	P,RELRIB	;RELEASE THE RIB.
  1273	001211'	262040	000013		POP	P,M		;RESTORE M.
  1274	001212'	254000	001035*		JRST	CPOPJ1		;SUCCESS RETURN.
  1275
  1276
  1277
  1278				COMMENT #
  1279				@@SUBROUTINE RONDUP
  1280				@@PURPOSE
  1281				TINY SUBR TO ROUND UP FILE SIZE TO A PAGE BOUNDARY, IF
  1282				WE JUST CREATED, EXCHANGED, OR DELETED THE LAST PAGE OF THE
  1283				FILE.
  1284				CALLED BY FCREATE, FEXCH, AND FDELETE.
  1285				@@ENTRY
  1286				EXPECTS M/ PAGE NO. JUST TOUCHED, AND F/ DDB.
  1287				@@ACCUM
  1288				DESTROYS T1 AND T2.
  1289				@@EXIT
  1290				ALWAYS POPJS.
  1291				@@ #
  1292
  1293	001213'	550344	001135*	RONDUP:	HRRZ	T2,DEVATB(F)	;CALC T1/
  1294	001214'	135300	001115*		LDB	T1,ATYBSZ	;THE NUMBER OF
  1295	001215'	271300	000003		ADDI	T1,3		;THE LAST
  1296	001216'	242300	777776		LSH	T1,B2PLSH	;PAGE IN THE FILE.
  1297	001217'	313300	000013		CAMLE	T1,M		;M LESS THAN LAST PAGE?
  1298	001220'	263040	000000		 POPJ	P,		;YES.
  1299	001221'	200300	000013		MOVE	T1,M		;NO, ROUND
  1300	001222'	242300	000000*		LSH	T1,ATSWRD+ATSBLK ;UP THE
  1301	001223'	202307	001140*		MOVEM	T1,ATBSIZ(T2)	;FILE SIZE TO THE EO THIS
  1302	001224'	263040	000000		POPJ	P,		;PAGE.
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 23
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  1303				SUBTTL KMOVPG
  1304
  1305				COMMENT #
  1306				@@SUBROUTINE KMOVPG
  1307				@@PURPOSE
  1308				KERNEL ROUTINE USED TO TAKE A PAGE WHICH IS MAPPED AND NOT CURRENTLY
  1309				PART OF A FILE AND CAUSE IT TO BE MAPPABLE FROM THE SPECIFIED POSITION
  1310				IN THE FILE OPEN ON THE CHANNEL.  USEFUL FOR MOVING PAGES FROM ONE FILE
  1311				TO ANOTHER, OR FOR MOVING A PRIVATE PAGE INTO A FILE.
  1312				@@ENTRY
  1313				T1/ USER'S VP SPECIFICATION, T2/FILE PAGE LOCATION TO BEGIN INSERTING
  1314				SIGN BIT OF T1 ON IFF USER MODE CALLER.
  1315				J/ TARGET FRAME NUMBER, CONTEXT PAGES IN %UPX
  1316				F/ DDB
  1317				@@ACCUM
  1318				DESTROYS P1-P4, T1-T4, U, AND PG.
  1319				@@EXIT
  1320				SKIP RETURNS IF SUCCESSFUL.
  1321				NON-SKIP RETURN IF ERROR, WITH LH(T1) CONTAINING THE VP NUMBER ON WHICH
  1322				THE FAILURE OCCURRED, AND RH(T1) CONTAINS THE ERROR CODE.
  1323				@@FUNCTION
  1324				FOR EACH VP
  1325				  IF VP IS NON-EXISTENT OR SUPER, GIVE ERROR RETURN.
  1326				  IF DP HAS OTHER USERS, CONVERT VP TO PRIVATE USING COPY-ON-WRITE AND
  1327				    GO UP TO TOP
  1328				  IF VP IS A PRIVATE VIRGIN PAGE, VIOLATE IT.
  1329				  IF VP IS PRIVATE (WAS NEVER IN A FILE) DO VALIDATE START.
  1330				    (HAVE TO MAKE SURE DISK DATA IS NOT LEFTOVER FROM LAST USER OF DP)
  1331				  GET ATOMIC FILE LOCK FOR WRITE (WILL BE CHANGING ALLOCATION OF FILE)
  1332				  IF FILE IS APPEND ONLY AND FIRST PAGE TO INSERT IS BELOW END OF FILE, GIVE
  1333				    ERROR RETURN.
  1334				  EXTEND FILE OUT TO LAST PAGE USER REQUESTED TO INSERT WITH HOLES.
  1335				FOR EACH VP
  1336				  IF PAGE IS PRIVATE, DO VALIDATE/WAIT.
  1337				  IF CALLER IS USER MODE AND DIRECTORY IS OVER QUOTA, GIVE ERROR RETURN.
  1338				  GET SAT COMPLETELY LOCKED FOR VP'S DP. IF F BIT ALREADY ON, GIVE ERROR RETURN.
  1339				  GET RIB CONTAINING SPECIFIED FP MAPPED WRITE LOCKED.
  1340				  IF SPECIFIED FP ALREADY EXISTS, GIVE ERROR RETURN.
  1341				  SET F BIT FOR DP.
  1342				  PUT RETRIEVAL POINTER IN RIB AND DDB.
  1343				  CHARGE DP AGAINST FILE'S DIRECTORY'S QUOTA.
  1344				  CALL DECUNS TO DISCONNECT VP FROM ITS OLD ATB IF ITS UNSHARED.
  1345				  INCREMENT UMC, MXW FOR NEW ATB.
  1346				  IF SLOT IS ACTIVE, SET PGYATB TO NEW ATB, CLEAR PGYSPT
  1347				  IF SLOT IS INACTIVE, SET DP AND ATB IN THE SLOT.
  1348				@@#
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 24
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  1349				EXTERNAL ATBSTS,ATBMWC,ATPMXU,ATMMWC,ATYBSZ,CNVATB,DABBIT
  1350				EXTERNAL DECUMC,DEVATB,DEVRBN,DEVRET,DEYRPS,DECUNS
  1351				EXTERNAL GETATB,GETCPA,GETDPA,GETLMA,GETSAT,GETSPT
  1352				EXTERNAL INCUMC,IOBDRB
  1353				EXTERNAL LM3ATB,LM3CUR,LMMEXS,LMPACT,LMPMXW,LMPSHR,LMPSUP
  1354				EXTERNAL MAPCML,NOWRT,PGYATB,PGYSPT,RBREAL,SETACH
  1355				EXTERNAL REDLMA,REMSPT,SPMUSC,SPTUSC,STOLMA,TSTVIR
  1356				EXTERNAL UPDAC0,VALID,VL.VPP,VL.WAT,VLIOE%,%UPT,UPTJOB
  1357
  1358	001225'	260040	000774'	KMOVPG::PUSHJ	P,SETARR	;W/PGE, P2/COUNT, P1/BITS
  1359	001226'	263040	000000		  POPJ	P,		;BAD ARG FROM USER, GIVE ERROR RETURN
  1360	001227'	200540	000007		MOVE	M,T2		;GET FP NUMBER IN T2
  1361	001230'	322540	001564'		JUMPE	M,KMOVBF	;IF ARG EQ 0, ITS BAD, GIVE ERROR.
  1362	001231'	315540	004126'		CAMGE	M,[-1]		;-1 MEANS AT END OF FILE
  1363	001232'	254000	001564'		  JRST	KMOVBF		;NO GOOD.
  1364	001233'	261040	000012		PUSH	P,W		;SAVE ARGS FOR LOOP LATER
  1365	001234'	261040	000013		PUSH	P,M
  1366	001235'	261040	000014		PUSH	P,P1
  1367	001236'	261040	000015		PUSH	P,P2
  1368	001237'	261040	000004		PUSH	P,F		;SAVE DDB ADDRESS
  1369	001240'	261040	000012		PUSH	P,W
  1370	001241'	261040	000015		PUSH	P,P2		;FIRST LOOP DEALS ONLY WITH VPS
  1371	001242'	260040	000704*	KMOVP1:	PUSHJ	P,REDLMA	;GET LMAP SLOT
  1372	001243'	607700	000705*		TLNN	P3,LMMEXS	;DOES PAGE EXIST?
  1373	001244'	254000	001553'		 JRST	KMOVEE		;NO, GO GIVE NON-EXIST ERROR.
  1374	001245'	603700	000712*		TLNE	P3,LMPSUP	;IF SUPER PAGE, GIVE ERROR RETURN.
  1375	001246'	254000	001552'		 JRST	KMOVSE
  1376	001247'	260040	000714*		PUSHJ	P,GETATB	;GET ATB ADDRESS
  1377	001250'	331006	000000*		SKIPL	ATBSTS(T1)	;SKIP IF ITS PRIVATE
  1378	001251'	254000	001262'		 JRST	KMOVP2		;NOT PRIVATE, DONT'T HAVE TO VIOLATE IT
  1379	001252'	260040	000000*		PUSHJ	P,TSTVIR	;IS SLOT VIRGIN?
  1380	001253'	254000	001256'		  JRST	KMOVNV		;NO.
  1381	001254'	260040	001527'		PUSHJ	P,VPADR		;TAKE PAGE IN W AND MAKE ADDR OUT OF IT IN T1,
  1382								; AND WET PC.UIO PROPERLY FOR A REFERENCE.
  1383	001255'	256200	004127'		UMOVE	T1,(T1)		;AND CAUSE VIRGIN PAGE TO BE VIOLATED.
  1384							;NOTE CANNOT ASSUME PAGE NOT DIRTY WHEN WE COME BACK.
  1385
  1386				;STILL HAVE CONTEXT PAGE LOCK AND DOING UMOVE
  1387
  1388	001256'	550300	000012	KMOVNV:	HRRZ	T1,W		;GET PAGE
  1389	001257'	505300	000001*		HRLI	T1,VL.VPP+1	;SETUP ARG
  1390	001260'	260040	000000*		PUSHJ	P,VALID		;MAKE SURE PAGE NO LONGER DIRTY
  1391	001261'	254000	001535'		  JRST	KMOVVE		;VALIDATE ERROR.
  1392	001262'	350501	777777	KMOVP2:	AOS	W,-1(P)		;STEP TO NEXT VP NUMBER
  1393	001263'	373001	000000		SOSLE	(P)		;DECREMENT COUNT, AND JUMP IF
  1394	001264'	254000	001242'		 JRST	KMOVP1		;MORE TO GO
  1395	001265'	262040	000006		POP	P,T1
  1396	001266'	262040	000006		POP	P,T1		;GET USED JUNK OFF THE STACK.
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 25
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  1397				;NOW ALL PRIVATE PAGES THAT WERE DIRTY HAVE BEEN STARTED OUT, NO SUPER
  1398				; PAGES FOUND IN RANGE, THEY ALL EXIST, NO VIRGIN PRIVATE PAGES ANYMORE.
  1399
  1400	001267'	200201	000000		MOVE	F,(P)		;GET F BACK
  1401	001270'	200501	777774		MOVE	W,-4(P)		;IN CASE OF ERROR RETURN.
  1402	001271'	201400	001225'		MOVEI	T3,KMOVPG	;STUPID CODE FOR DELXCH.
  1403	001272'	260040	001750'		PUSHJ	P,DELXCH	;RETURN T4 HPW, FILE LOCKED UNMODIFIED
  1404	001273'	254000	001542'		  JRST	KMOVXE		;ERROR CODE ALREADY IN T1.
  1405	001274'	260040	001102*		PUSHJ	P,SETACH	;ASSUME FILE'S ALLOCATION WILL CHANGE.
  1406	001275'	335541	777775		SKIPGE	M,-3(P)		;Get back first FP to do (may be -1)
  1407	001276'	201551	000001		 MOVEI	M,1(T4)		;If -1, set up HPW+1
  1408	001277'	202541	777775		MOVEM	M,-3(P)		;In case -1, save correct first FP
  1409	001300'	270541	777777		ADD	M,-1(P)		;GET LAST FP + 1
  1410	001301'	275540	000001		SUBI	M,1		;CONVERT TO LAST FP WANT TO CREATE.
  1411	001302'	313540	000011		CAMLE	M,T4		;SKIP IF LAST PAGE WE WANT TO INSERT
  1412								; TO FILE IS NOT BEYOND HPW
  1413	001303'	254000	001310'		  JRST	KMOVPH		;IS BEYOND, MUST CREATE HOLES FOR NEW PAGES
  1414	001304'	510304	000007		HLLZ	T1,DEVIAD(F)	;IS TOTALLY WITHIN FILE, CHECK FOR APPEND ONLY
  1415	001305'	603300	001143*		TLNE	T1,NOWRT	;SKIP IF NOT APPEND ONLY
  1416	001306'	254000	001606'		 JRST	KMOVNA		;SORRY, CANT TOUCH BELOW HPW
  1417	001307'	254000	001335'		JRST	KMOVNH		;OK, LET IT THROUGH.
  1418
  1419	001310'	260040	001610'	KMOVPH:	PUSHJ	P,LOKHPW	;GET FILE LOCKED PROPERLY.
  1420	001311'	254000	001555'		  JRST	KMOVBR		;BAD RIB, TAKE CARE OF IT
  1421				;IF T1 IS NEGATIVE, MEANS FILE SIZE CHANGED SUCH THAT REQUESTED FP NO LONGER
  1422				; ABOVE HIGHEST EXISTING FILE PAGE.
  1423	001312'	321300	001335'		JUMPL	T1,KMOVNH	
  1424				; Upon return from LOKHPW, T4 still has HPW, and M contains highest FP
  1425				; to be inserted.
  1426	001313'	250440	000013		EXCH	T4,M		;T4 gets highest FP to insert
  1427	001314'	271540	000001		ADDI	M,1		;M gets first FP to insert
  1428
  1429	001315'	550344	001213*		HRRZ	T2,DEVATB(F)	;GET ATB ADDRESS IN T2
  1430	001316'	135400	001214*		LDB	T3,ATYBSZ
  1431	001317'	271400	000003		ADDI	T3,3
  1432	001320'	242400	777776		LSH	T3,B2PLSH	;T3/HPW AGAIN.
  1433	001321'	510304	000007		HLLZ	T1,DEVIAD(F)	;GET NOWRT BIT
  1434	001322'	603300	001305*		TLNE	T1,NOWRT	;IF FILE IS APPEND ONLY AND
  1435	001323'	313540	000010		CAMLE	M,T3		;FIRST PAGE TO INSERT IS BELOW HPW,
  1436	001324'	254000	001326'		 JRST	.+2		;(OK, INSERTING ABOVE CURRENT EOF)
  1437	001325'	254000	001606'		  JRST	KMOVNA		;APPEND ONLY AND THIS IS NOT APPEND
  1438	001326'	350540	000010		AOS	M,T3		;FIRST PAGE TO CREATE IS HPW+1
  1439	001327'	274440	000013		SUB	T4,M		;NUMBER OF HOLES TO DO IS LAST FP TO INSERT
  1440	001330'	271440	000001		ADDI	T4,1		;-(HPW+1)+1. (CREATE HOLES FROM HPW+1 TO LAST FP)
  1441	001331'	474300	000000		SETO	T1,		;DON'T STOP ON CONTROL C (TOO BAD)
  1442	001332'	260040	002214'		PUSHJ	P,SWEPRH	;CREATE HOLES SO WE CAN INSERT DPS LATER.
  1443					  JRST	[CAIE T1,FALAQA	;DISK FULL OR QUOTA EXCEEDED OR
  1444						 CAIN T1,FALRBE	;RIB ERROR?
  1445						   JRST KMOVXE	;YES, GO GIVE PROPER ERROR RETURN.
  1446	001333'	254000	004130'			 STOPCD (SLO)]	;;KMOVPH+23
  1447	001334'	260040	001210*		PUSHJ	P,RELRIB	;GET RID OF RIB IN CASE USETST HAS TO GET IT BELOW.
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 26
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  1448				;NOW WE ARE GUARANTEED THAT THERE ARE RIB SLOTS FOR ALL PAGES WE WISH TO INSERT.
  1449
  1450	001335'	200501	777774	KMOVNH:	MOVE	W,-4(P)		;RESTORE ORIGINAL W AND
  1451	001336'	200541	777775		MOVE	M,-3(P)		;M
  1452	001337'	260040	001242*	KMOVP3:	PUSHJ	P,REDLMA	;GET LMAP SLOT
  1453	001340'	260040	001247*		PUSHJ	P,GETATB
  1454	001341'	331006	001250*		SKIPL	ATBSTS(T1)	;SKIP IF ITS PRIVATE
  1455	001342'	254000	001354'		 JRST	KMOV2N		;NOT PRIVATE.
  1456	001343'	261040	000012		PUSH	P,W
  1457	001344'	261040	000013		PUSH	P,M
  1458	001345'	550300	000012		HRRZ	T1,W
  1459	001346'	505300	000000*		HRLI	T1,VL.WAT+VL.VPP+1 ;WAIT, DO IT FOR PRIVATE PAGE, COUNT OF 1.
  1460	001347'	260040	001260*		PUSHJ	P,VALID		;DO IT
  1461	001350'	254000	001535'		  JRST	KMOVVE		;VALIDATE ERROR
  1462	001351'	262040	000013		POP	P,M
  1463	001352'	262040	000012		POP	P,W
  1464	001353'	200201	000000		MOVE	F,(P)		;RESTORE F
  1465	001354'	603200	000010	KMOV2N:	TLNE	F,GETB		;IF GETB ON, DON'T CHECK FOR QUOTA
  1466	001355'	254000	001402'		 JRST	KMOV3N
  1467	001356'	260040	000000*		PUSHJ	P,CHKQTA	;SEE IF CAN ALLOCATE IN C(F)'S DIRECTORY
  1468	001357'	254000	001557'		  JRST	KMOVOQ		;OVER QUOTA IN THIS DIRECTORY.
  1469	001360'	260040	000563*		PUSHJ	P,USETST	;GET DDB SETUP TO SLOT POINTED TO BY M
  1470	001361'	254000	001555'		  JRST	KMOVBR		;BAD RIB.
  1471	001362'	200364	001202*		MOVE	T2,@DEVRET(F)	;GET CONTENTS OF THAT SLOT
  1472	001363'	603340	001155*		TLNE	T2,RBREAL	;IS SLOT A HOLE?
  1473	001364'	254000	001561'		 JRST	KMVNHO		;NO
  1474	001365'	260040	001337*		PUSHJ	P,REDLMA	;GET LMAP SLOT IN P3 AND P4 AGAIN, DELCRE RESCHEDULES
  1475
  1476	001366'	260040	000717*		PUSHJ	P,GETDPA	;GET DISK ADDRESS IN T2
  1477	001367'	661340	001363*		TLO	T2,RBREAL	;MAKE ACCEPTABLE TO GETSAT
  1478	001370'	261040	000007		PUSH	P,T2		;SAVE RETRIEVAL POINTER FOR LATER.
  1479	001371'	201300	000000*		MOVEI	T1,MAPCML	;MAP COMPLETELY LOCKED - THE SAT PCB LOCK IS WHAT
  1480								; KEEPS DP FROM CHANGING STATUS (KEEPS MAPPERS
  1481								; FROM SNEAKING IN AND CHANGING STATUS TO SHARED, ETC)
  1482	001372'	260040	000722*		PUSHJ	P,GETSAT	;GET SAT, SETUP T1 AND T3
  1483	001373'	254000	001574'		  JRST	KMOVBS		;GIVE SAT ERROR RETURN.
  1484	001374'	612310	377400		TDNE	T1,%SAT+MBITS(T3);M BIT SHOULD BE ON (ZERO)
  1485	001375'	256000	000000'		 STOPCD (SLO)
  1486				           ;;KMOV2N+21
  1487	001376'	616310	377000		TDNN	T1,%SAT+FBITS(T3);HAS USER SPECIFIED PAGE STILL PART OF A FILE?
  1488	001377'	254000	001567'		 JRST	KMOVPF		;YES, GIVE HIM THE ERROR RETURN.
  1489	001400'	261040	000006		PUSH	P,T1		;REMEMBER WHERE IN SAT TO DIDLE
  1490	001401'	261040	000010		PUSH	P,T3		;BECAUSE WE CAN'T SET IT IN CASE PAGE IS SHARED.
  1491
  1492				;NOW WE KNOW PAGE IS NOT IN A FILE. MAKE SURE ITS NOT SHARED. IF IT IS,
  1493				;MUST GET RID OF SAT, TURN PAGE INTO PRIVATE PAGE WITH COPY-ON-WRITE,
  1494				;AND TRY AGAIN.  SAT LOCK IS ENOUGH TO MAKE SURE SPT COUNT DOESN'T CHANGE,
  1495				;ONLY NEED CB TO MESS WITH ENTIRE SPT STRUCTURE.
  1496
  1497	001402'	260040	001365*	KMOV3N:	PUSHJ	P,REDLMA	;GET LMAP SLOT AGAIN
  1498	001403'	200341	000000		MOVE	T2,(P)
  1499	001404'	621340	001367*		TLZ	T2,RBREAL	;GET RID OF IT SO SRCSPT WONT BARF.
  1500	001405'	321700	001412'		JUMPL	P3,KMOV3A	;IF SLOT IS SHARED, JUST GET SPT ADDRESS FROM SLOT.
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 26-2
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  1501	001406'	260040	001340*		PUSHJ	P,GETATB	;UNSHARED, GET ATB ADDR FROM SLOT
  1502	001407'	260040	000000*		PUSHJ	P,SRCSPT	;GET SPT ENTRY POINTER IN T1
  1503	001410'	254000	001416'		  JRST	KMOV3C		;NOT SHARED, NO SPT ENTRY.
  1504	001411'	254000	001413'		JRST	KMOV3B		;AND CHECK TO SEE IF STILL SHARED.
  1505
  1506	001412'	260040	000000*	KMOV3A:	PUSHJ	P,GETSPT	;GET SPT ENTRY ADDRESS IN T1
  1507	001413'	550406	000000*	KMOV3B:	HRRZ	T3,SPTUSC(T1)	;GET USE COUNT IN T3
  1508	001414'	303400	000001		CAILE	T3,1		;ITS REALLY UNSHARED IF COUNT IS 1.
  1509	001415'	254000	001502'		 JRST	KMVMKP		;SHARED, GO MAKE IT PRIVATE.
  1510
  1511	001416'	262040	000010	KMOV3C:	POP	P,T3		;GET SAT BIT AND POS BACK
  1512	001417'	262040	000006		POP	P,T1
  1513	001420'	412310	377000		ANDCAM	T1,%SAT+FBITS(T3);SET (MAKE 0) F BIT, ITS GOING TO BE IN A FILE NOW.
  1514	001421'	262040	000007		POP	P,T2		;(M BIT STILL SET)
  1515	001422'	205300	000745*		MOVSI	T1,PTRCHG
  1516	001423'	436304	000007		IORM	T1,DEVIAD(F)	;MARK OUR DDB AS HAVING CHANGED
  1517	001424'	202364	001362*		MOVEM	T2,@DEVRET(F)	;SET IN DDB
  1518	001425'	260040	002554'		PUSHJ	P,ONESLT	;UPDATE OTHER DDBS THAT HAVE THIS FILE POSITION
  1519								;FILE SIZE ALREADY SETUP CORRECTLY FROM SWEPRH.
  1520	001426'	260040	001334*		PUSHJ	P,RELRIB	;DON'T GIVE UP SAT TILL EVERYTHING IS FIXED.
  1521	001427'	550344	001315*		HRRZ	T2,DEVATB(F)	;GET ATB ADDRESS IN T2 FOR UPDAC0
  1522	001430'	201300	000001		MOVEI	T1,1		;ALLOCATE 1 MORE PAGE TO THIS DIRECTORY
  1523	001431'	210400	000006		MOVN	T3,T1		;UPDAC0 NEEDS THIS
  1524	001432'	260040	000000*		PUSHJ	P,UPDAC0	;ADJUST ATPALP, DRBALC, DRBMXA
  1525	001433'	260040	000512*		PUSHJ	P,GETLMA	;NOW GET LMAP SLOT FOR C(W)
  1526	001434'	260040	001406*		PUSHJ	P,GETATB	;GET ATB ADDRESS FOR OLD SLOT
  1527	001435'	200640	000006		MOVE	P2,T1		;GET INTO P2 FOR DECUNS
  1528	001436'	200364	001424*		MOVE	T2,@DEVRET(F)	;GET POINTER BACK, UPDAC0 SMASHED IT
  1529	001437'	621340	001404*		TLZ	T2,RBREAL	;T2 HAD PTR, CLEAR RBREAL TO GET JUST DP
  1530	001440'	260040	000000*		PUSHJ	P,DECUNS	;DISCONNECT THAT DP FROM OLD ATB
  1531	001441'	256000	000000'		 STOPCD			;NOT SUPPOSED TO BE SHARED ANYMORE. ;;KMOV3C+23
  1532	001442'	550304	001427*		HRRZ	T1,DEVATB(F)	;GET ATB FOR FILE
  1533	001443'	260040	000000*		PUSHJ	P,INCUMC	;INCREMENT ATBUMC, DRBCNT, ETC. FOR FILE
  1534	001444'	550304	001442*		HRRZ	T1,DEVATB(F)	;GET NEW ATB ADDRESS AGAIN.
  1535	001445'	607700	001022*		TLNN	P3,LMPMXW	;MAX WRITE ON?
  1536	001446'	254000	001454'		 JRST	KMOVP4		;NO
  1537	001447'	350446	000000*		AOS	T4,ATBMWC(T1)
  1538	001450'	606440	000000*		TRNN	T4,ATMMWC	;MAKE SURE IT DIDN'T OVERFLOW
  1539	001451'	256000	000000'		 STOPCD                         ;;KMOV3C+33
  1540	001452'	201440	000000*		MOVEI	T4,ATPMXU	;SET BIT THAT COVERS ATBMWC NON-ZERO
  1541	001453'	436446	001341*		IORM	T4,ATBSTS(T1)
  1542	001454'	260040	000000*	KMOVP4:	PUSHJ	P,CNVATB	;CONVERT ATB ADDR IN T1 TO ATB POINTER.
  1543	001455'	607700	000000*		TLNN	P3,LMPACT	;IS THIS AN ACTIVE SLOT?
  1544	001456'	254000	001464'		 JRST	KMOVP5		;NO
  1545	001457'	260040	000000*		PUSHJ	P,GETCPA	;GET CP IN PG
  1546	001460'	137300	000000*		DPB	T1,PGYATB	;SET IT IN PGY TABLE
  1547	001461'	400300	000000		SETZ	T1,		;MAKE SURE PGYSPT IS ZERO, THIS PAGE ISN'T SHARED
  1548	001462'	137300	000000*		DPB	T1,PGYSPT
  1549	001463'	254000	001465'		JRST	KMOVP6		;AND GO RELEASE SAT, LOOP
  1550
  1551	001464'	137300	000000*	KMOVP5:	DPB	T1,LM3ATB	;SET ATB POINTER IN SLOT
  1552	001465'	260040	000522*	KMOVP6:	PUSHJ	P,STOLMA	;STORE NEW SLOT BACK.
  1553	001466'	260040	001206*		PUSHJ	P,RELSAT	;NOW GIVE UP SAT SO OTHERS CAN MAP IT AGAIN.
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 26-3
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  1554								; (HAD TO WAIT UNTIL PGY STUFF, ETC, FIXED UP SO
  1555								; IT IS SAFE TO MAP IT AGAIN)
  1556								;KEEP ATOMIC FILE LOCK SO FILE SIZE DOESNT CHANGE
  1557
  1558	001467'	350541	777775		AOS	M,-3(P)		;STEP TO NEXT M AND
  1559	001470'	350501	777774		AOS	W,-4(P)		;W
  1560	001471'	373001	777777		SOSLE	-1(P)		;DECREMENT REPEAT COUNT AND
  1561	001472'	254000	001337'		 JRST	KMOVP3		;JUMP IF ANOTHER TO DO.
  1562	001473'	260040	003541'	KMOVEX:	PUSHJ	P,UNLFIL	;UNLOCK FILE NOW.
  1563	001474'	262040	000004		POP	P,F
  1564	001475'	262040	000015		POP	P,P2
  1565	001476'	262040	000014		POP	P,P1
  1566	001477'	262040	000013		POP	P,M
  1567	001500'	262040	000012		POP	P,W		;GET RID OF ALL JUNK ON STACK
  1568	001501'	254000	001212*		JRST	CPOPJ1		;AND GIVE SKIP RETURN.
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 27
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  1569				;HERE IF DISCOVERED THAT PAGE WAS SHARED AFTER GETTING SAT. USE TRICK
  1570				; OF MAKING PAGE COPY-ON-WRITE AND WRITING INTO IT TO MAKE IT
  1571				; UNSHARED AGAIN, AND START AT TOP OF THE SECOND FOR EACH VP LOOP.
  1572				;VP NUMBERT IN W.
  1573
  1574	001502'	262040	000010	KMVMKP:	POP	P,T3		;GET SAT BIT AND POS BACK OFF
  1575	001503'	262040	000006		POP	P,T1		;WE WONT USE THEM ANYMORE.
  1576	001504'	262040	000007		POP	P,T2		;GET DP OFF STACK, THROW IT AWAY.
  1577	001505'	260040	001466*		PUSHJ	P,RELSAT
  1578	001506'	260040	001426*		PUSHJ	P,RELRIB	;GET RID OF EVERYTHING.
  1579	001507'	260040	003541'		PUSHJ	P,UNLFIL	;GET RID OF FILE LOCK (NOW WE HAVE TO GO THRU
  1580								; STUFF ABOUT HPW, SINCE ALLOCATION/DEALLOCATION
  1581								; CAN HAPPEN NOW.
  1582	001510'	260040	001433*		PUSHJ	P,GETLMA	;GET SLOT OFFICIALLY.
  1583	001511'	135600	001020*		LDB	P1,LM3CUR	;GET PROTECTION IT HAS NOW
  1584	001512'	201340	000002		MOVEI	T2,CPRCOW	;SET CURRENT PROTECTION TO COPY ON WRITE
  1585	001513'	137340	001511*		DPB	T2,LM3CUR
  1586	001514'	603700	001455*		TLNE	P3,LMPACT	;IF ACTIVE,
  1587	001515'	620740	100000		 TRZ	P4,PGE.W	;RESET WRITE BIT SO IT WILL FAULT.
  1588	001516'	260040	001465*		PUSHJ	P,STOLMA	;SET IT BACK IN SLOT.
  1589	001517'	260040	001527'		PUSHJ	P,VPADR		;GET ADDR TO REF VP IN T1
  1590	001520'	256200	004134'		XCTBU	<SETMM (T1)>	;WRITE INTO THE PAGE, MAKING IT PRIVATE.
  1591	001521'	260040	001510*		PUSHJ	P,GETLMA	;GET SLOT AGAIN
  1592	001522'	137600	001513*		DPB	P1,LM3CUR	;RESTORE OLD PROTECTION
  1593	001523'	603700	001514*		TLNE	P3,LMPACT	;AND IF ACTIVE,
  1594	001524'	620740	100000		 TRZ	P4,PGE.W	;CLEAR WRITE BIT IN CASE OLD PROT WASN'T R/W
  1595	001525'	260040	001516*		PUSHJ	P,STOLMA	;SET SLOT BACK.
  1596	001526'	254000	001337'		JRST	KMOVP3		;NOW TO TOP OF FOR EACH VP LOOP TO DO CHECKS ON
  1597								; FILE AGAIN, VALIDATE.
  1598
  1599				;LITTLE ROUTINE TO TAKE PAGE NUMBER IN W, CONVERT TO REFERENCE ADDRESS AND SET USER IOT
  1600				; BIT PROPERLY.
  1601
  1602	001527'	550300	000012	VPADR:	HRRZ	T1,W		;GET PAGE NUMBER
  1603	001530'	305300	001000		CAIGE	T1,1000		;IF USER PAGE
  1604	001531'	254120	004135'		 JRSTF	@[PC.UIO,,.+2]	;SET USER IOT AND SKIP
  1605	001532'	275300	000440		SUBI	T1,CNVVPN	;ELSE CONVERT TO HARDWARE PAGE NUMBER
  1606								; (USER IOT SET BECAUSE CALLER WAS EXEC MODE)
  1607	001533'	242300	000011		LSH	T1,^D9		;TURN INTO ADDRESS.
  1608	001534'	263040	000000		POPJ	P,		;AND RETURN.
  1609
  1610				;VARIOUS ERROR RETURNS, NEED TO GET STUFF OFF STACK AND UNLOCK.
  1611				; ERROR CODE ALWAYS IN RH(T1), VP IN W.
  1612
  1613				;HERE ON ERROR RETURN FROM VALIDATE.
  1614
  1615	001535'	201306	000000	KMOVVE:	MOVEI	T1,(T1)		;GET ERROR CODE
  1616	001536'	302300	000000*		CAIE	T1,VLIOE%	;IS IT I/O ERROR?
  1617	001537'	256000	000000'		 STOPCD			;NO, SOMETHING ELSE WENT WRONG. ;;KMOVVE+2
  1618	001540'	262040	000007	KMOVPE:	POP	P,T2
  1619	001541'	262040	000007		POP	P,T2		;ALWAYS 2 EXTRA THINGS ON THE STACK.
  1620	001542'	260040	003541'	KMOVXE:	PUSHJ	P,UNLFIL	;IN CASE WE HAVE FILE LOCK. (F BETTER BE SETUP)
  1621	001543'	262040	000004		POP	P,F
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 27-2
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  1622	001544'	262040	000015		POP	P,P2
  1623	001545'	262040	000014		POP	P,P1
  1624	001546'	262040	000013		POP	P,M
  1625	001547'	505312	000000		HRLI	T1,(W)		;GET FAILING VP IN LH T1
  1626	001550'	262040	000012		POP	P,W
  1627	001551'	263040	000000		POPJ	P,		;AND GIVE ERROR RETURN.
  1628
  1629				;NON-EXISTENT PAGE
  1630	001552'	334300	004136'	KMOVSE:	SKIPA	T1,[FALNSE]	;TRYING TO STICK SUPERMAPPED PAGE INTO FILE.
  1631								;(MAYBE SOMEDAY ALLOW THIS UNDER PROPER CONDITIONS)
  1632	001553'	201300	000004	KMOVEE:	MOVEI	T1,FALNEX
  1633	001554'	254000	001540'		JRST	KMOVPE		;POP 2 THINGS OFF STACK AND GIVE ERROR.
  1634				;BAD RIB
  1635	001555'	201300	000011	KMOVBR:	MOVEI	T1,FALRBE
  1636	001556'	254000	001542'		JRST	KMOVXE
  1637
  1638	001557'	201300	000025	KMOVOQ:	MOVEI	T1,FALAQA
  1639	001560'	254000	001542'		JRST	KMOVXE
  1640
  1641	001561'	260040	001506*	KMVNHO:	PUSHJ	P,RELRIB	;GET RID OF RIB
  1642	001562'	201300	000016		MOVEI	T1,FALNHL
  1643	001563'	254000	001542'		JRST	KMOVXE		;GET T1 AND T3 OFF STACK TOO.
  1644
  1645	001564'	201300	000007	KMOVBF:	MOVEI	T1,FALFPZ
  1646	001565'	505312	000000		HRLI	T1,(W)
  1647	001566'	263040	000000		POPJ	P,
  1648
  1649	001567'	262040	000007	KMOVPF:	POP	P,T2		;GET RID OF DP ON STACK
  1650	001570'	260040	001561*		PUSHJ	P,RELRIB
  1651	001571'	260040	001505*		PUSHJ	P,RELSAT	;GET RID OF RIB AND SAT
  1652	001572'	201300	000035		MOVEI	T1,FALALF	;ALREADY IN A FILE
  1653	001573'	254000	001542'		JRST	KMOVXE
  1654
  1655	001574'	262040	000007	KMOVBS:	POP	P,T2
  1656	001575'	260040	001570*		PUSHJ	P,RELRIB
  1657	001576'	201300	000012		MOVEI	T1,FALBDS
  1658	001577'	254000	001542'		JRST	KMOVXE
  1659
  1660	001600'	261040	000006	KMVELK:	PUSH	P,T1
  1661	001601'	260040	001575*		PUSHJ	P,RELRIB	;GET RID OF RIB AND SAT IF HAVE THEM
  1662	001602'	260040	001571*		PUSHJ	P,RELSAT
  1663	001603'	262040	000006		POP	P,T1		;RESTORE ERROR CODE
  1664	001604'	262040	000007		POP	P,T2		;GET T2 OFF STACK
  1665	001605'	254000	001540'		JRST	KMOVPE		;POP T1 AND T3 OFF STACK AND RETURN.
  1666
  1667	001606'	201300	000024	KMOVNA:	MOVEI	T1,FALNWT
  1668	001607'	254000	001542'		JRST	KMOVXE
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 28
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  1669				COMMENT #
  1670				@@SUBROUTINE LOKHPW
  1671				@@PURPOSE
  1672				COMMON ROUTINE USED BY KFCRE AND KMOVPG. WHEN THESE KERNEL ROUTINES DISCOVER
  1673				 THAT A SLOT PAST HIGHEST PAGE WRITTEN (HPW) IS NEEDED, THEY ONLY HAVE THE
  1674				 ATOMIC FILE LOCK IN READ MODE. SINCE MIGHT BE CHANGING RIB STRUCTURE,
  1675				 HAVE TO GET FILE WRITE LOCKED, MAKING SURE SIZE DIDN'T CHANGE OR FILE
  1676				 DIDN'T GO BAD WHILE WAITING.
  1677				@@ENTRY
  1678				M/-1 TO INDICATE HPW+1 OR HIGHEST FP THAT WILL BE CREATED/INSERTED INTO FILE.
  1679				@@ACCUM T1-T3
  1680				@@EXIT NON-SKIP IF FILE GOT RIB ERROR WHILE WAITING FOR ATOMIC LOCK
  1681				SKIP RETURN WITH T1<0 IFF HIGHEST FP IS NOW BELOW HIGHEST PAGE THAT EXISTS
  1682				IN THE FILE. IF M/-1 ON ENTRY, CHANGE TO CURRENT HPW+1 OF FILE, ELSE
  1683				RETURN VALUE OF M UNCHANGED (HIGHEST FP TO BE INSERTED INTO FILE)
  1684				@@FUNCTION
  1685				SAVE OLD FILE SIZE (IN BLOCKS). RELEASE FILE READ LOCK, GET FILE WRITE LOCKED.
  1686				GIVE NON-SKIP IF RIB IS BAD NOW. ELSE IF M/-1, SET M TO BE THE HIGHEST PAGE
  1687				EXISTING IN THE FILE NOW + 1, T1/>=0, AND SKIP RETURN.
  1688				IF M/>=0, IF SIZE HASNT CHANGED JUST GIVE SKIP RETURN AND
  1689				FILE WRITE LOCKED. IF SIZE HAS CHANGED AND FP IN M IS NO LONGER ABOVE HIGHEST
  1690				EXISTING PAGE IN FILE, CHANGE LOCK BACK TO READ, SET T1/-1, AND SKIP RETURN.
  1691				IF FP IN M IS STILL ABOVE HIGHEST EXISTING PAGE, SKIP RETURN WITH
  1692				T1/NOT -1.
  1693				@@#
  1694
  1695				PRINTF([Need to convert KCREAT code at CREAT2 to use LOKHPW routine.])
  1696
  1697	001610'	550344	001444*	LOKHPW:	HRRZ	T2,DEVATB(F)	;SAVE FILE SIZE
  1698	001611'	135300	001316*		LDB	T1,ATYBSZ	;FOR CHECK.
  1699	001612'	260040	003541'		PUSHJ	P,UNLFIL	;UNLOCK BEFORE LOCK MODIFY.
  1700	001613'	202004	000002		MOVEM	S,DEVIOS(F)	;
  1701	001614'	260040	003653'		PUSHJ	P,LOKMOD	;GET LOCKED MODIFY.
  1702	001615'	200004	000002		MOVE	S,DEVIOS(F)	;FILE DIED WHILE
  1703	001616'	603000	001177*		TLNE	S,IOBDRB	; WAITING?
  1704	001617'	263040	000000		 POPJ	P,		;YES, GIVE ERROR RETURN.
  1705	001620'	135400	001611*		LDB	T3,ATYBSZ	;GET CURRENT FILE SIZE.
  1706	001621'	325540	001627'		JUMPGE	M,LOKHP1	;JUMP UNLESS LAST+1.
  1707	001622'	271400	000003		ADDI	T3,3		;CALC THE
  1708	001623'	242400	777776		LSH	T3,B2PLSH	; LAST PAGE
  1709	001624'	271400	000001		ADDI	T3,1		; +1.
  1710	001625'	200540	000010		MOVE	M,T3		;AND PUT INTO M.
  1711	001626'	254000	001501*		JRST	CPOPJ1		;GIVE SKIP RETURN
  1712
  1713	001627'	316300	000010	LOKHP1:	CAMN	T1,T3		;CHANGED WHILE WE WAITED?
  1714	001630'	254000	001626*		JRST	CPOPJ1		;NO, JUST GIVE SKIP, T1 NOT -1.
  1715	001631'	271400	000003		ADDI	T3,3		;YES.
  1716	001632'	242400	777776		LSH	T3,B2PLSH	;
  1717	001633'	313540	000010		CAMLE	M,T3		;REQUESTED FP NOW BELOW HIGHEST EXISTING PAGE?
  1718	001634'	254000	001630*		 JRST	CPOPJ1		;NO, JUST GIVE SKIP WITH T1/NOT -1
  1719	001635'	260040	003613'		PUSHJ	P,LOKLES	;
  1720	001636'	474300	000000		SETO	T1,		;MAKE T1 NEGATIVE AS SIGN FOR CALLER TO NOT EXTEND
  1721	001637'	254000	001634*		JRST	CPOPJ1		;FILE AND RETURN.
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 29
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  1722				COMMENT #
  1723				@@SUBROUTINE KFTRN
  1724				@@PURPOSE
  1725				KERNEL SUBROUTINE TO TRUNCATE A FILE'S SIZE.
  1726				DOES NOT CLEAR OUT THE END OF THE LAST PAGE.
  1727				CALLS DLTTCI TO DELETE PAGES AFTER PAGE CONTAINING NEW EOF (IF ANY).
  1728				(USED TO ONLY ALLOW WITHIN THE LAST PAGE, NOW ALLOWS WITHIN ANY
  1729				EXISTING PAGE OR HOLE)
  1730				@@ENTRY
  1731				EXPECTS T1/ USER ARG (THE NEW FILE SIZE IN WORDS.).
  1732				ALSO EXPECTS F/ DDB AND S/ DEVIOS.
  1733				@@ACCUM
  1734				DESTROYS T1-T4, P1-P4, U, AND PG.
  1735				@@EXIT
  1736				SKIP RETURNS UNLESS ERROR, IN WHICH CASE IT NON-SKIP RETURNS.
  1737				ON NON-SKIP RETURN, T1 CONTAINS THE ERROR FLAG AS FOLLOWS:
  1738				FALNOF, FALRBE, FALNWT, FALFPZ, FALPHP, FALNSP.
  1739				@@#
  1740
  1741				EXTERN	RELLOK,DLTTCI
  1742
  1743	001640'	200340	000006	KFTRN::	MOVE	T2,T1		;GET T1/
  1744	001641'	242300	777767		LSH	T1,W2PLSH	; THE
  1745	001642'	602340	000777		TRNE	T2,777		; REQUESTED
  1746	001643'	271300	000001		 ADDI	T1,1		; HPW.
  1747	001644'	201400	001640'		MOVEI	T3,KFTRN	;CHECK FILE FOR WRITING
  1748	001645'	260040	001750'		PUSHJ	P,DELXCH	;MODIFY IT, GET T1/ USER ARG
  1749	001646'	263040	000000		  POPJ	P,		;IN WORDS, T4/ HPW.
  1750	001647'	550644	001610*		HRRZ	P2,DEVATB(F)	;GET ATB POINTER
  1751	001650'	316300	000011		CAMN	T1,T4		;MUST BE IN THE SAME PAGE.
  1752	001651'	254000	001661'		 JRST	KFTRN1		;SAME PAGE - DON'T CALL DLTTCI
  1753	001652'	261040	000007		PUSH	P,T2		;SAVE T2 FROM DLTTCI
  1754	001653'	200340	000006		MOVE	T2,T1		;POSITION ARG
  1755	001654'	242340	000011		LSH	T2,11		;SETUP # WORDS TO KEEP
  1756	001655'	260040	000000*		PUSHJ	P,DLTTCI	;TRUNCATE!
  1757					  JRST	[POP P,T1	;FIXUP STACK
  1758						MOVEI T1,FALRBE	;ERROR CODE
  1759	001656'	254000	004137'			POPJ P,]
  1760	001657'	260040	000000*		PUSHJ	P,RELLOK	;GET RID OF THE RIB (IN %RIB)
  1761	001660'	262040	000007		POP	P,T2
  1762	001661'	602340	000177	KFTRN1:	TRNE	T2,177		;OKAY, STORE
  1763	001662'	271340	000200		 ADDI	T2,200		;THE NEW
  1764	001663'	202355	001223*		MOVEM	T2,ATBSIZ(P2)	;SIZE, AND
  1765	001664'	260040	003541'		PUSHJ	P,UNLFIL	;UNLOCK THE FILE.
  1766	001665'	254000	001637*		JRST	CPOPJ1		;SUCCESS RETURN.
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 30
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  1767				COMMENT #
  1768				@@SUBROUTINE KFDEL
  1769				@@PURPOSE
  1770				KERNEL SUBR TO TURN A FILE PAGE INTO A HOLE.
  1771				@@ENTRY
  1772				EXPECTS T1/ USER ARG, T3/ BIT 0 SET IFF CALLED FROM USER MODE,
  1773				AND ALSO F/ DDB AND S/ DEVIOS.
  1774				@@ACCUM
  1775				DESTROYS T1 THRU T4, U, AND PG.
  1776				@@EXIT
  1777				SKIP RETURNS UNLESS ERROR, IN WHICH CASE IT NON-SKIP RETURNS.
  1778				ON NON-SKIP RETURN, T1 CONTAINS THE ERROR FLAG AS FOLLOWS:
  1779				FALFPZ,FALPHP,FALRBE,FALHOL,FALNOF,FALNWT.
  1780				@@ #
  1781
  1782
  1783	001666'	201400	001666'	KFDEL::	MOVEI	T3,KFDEL	;
  1784	001667'	260040	001750'		PUSHJ	P,DELXCH	;CHK & LOCK FILE, GET
  1785	001670'	263040	000000		  POPJ	P,		;T1/ 1ST ARG.
  1786	001671'	261040	000013		PUSH	P,M		;SAVE M.
  1787	001672'	200540	000006		MOVE	M,T1		;GET DDB AND RIB
  1788	001673'	260040	001274*		PUSHJ	P,SETACH	;MARK FILE AS ALLOCATION CHANGED
  1789	001674'	260040	001734'		PUSHJ	P,DELCRE	;SET UP AND UPDATED.
  1790	001675'	254000	001720'		  JRST	DLXDR0		;
  1791	001676'	607340	001437*		TLNN	T2,RBREAL	;ALREADY A HOLE?
  1792					 JRST	[MOVEI T1,FALHOL ;YES.
  1793	001677'	254000	004142'			JRST DELDHO]	;
  1794	001700'	261064	001436*		PUSH	P,@DEVRET(F)	;SAVE PAGE WE ARE THROWING AWAY.
  1795	001701'	201340	434164		MOVEI	T2,'CAT'	;PUT
  1796	001702'	135300	001157*		LDB	T1,DEYRPS	; HOLE
  1797	001703'	270304	001700*		ADD	T1,DEVRET(F)	; IN
  1798	001704'	275304	001161*		SUBI	T1,DEVRBN(F)	; THE
  1799	001705'	202346	376000		MOVEM	T2,%RIB(T1)	; RIB,
  1800	001706'	202364	001703*		MOVEM	T2,@DEVRET(F)	; OUR DDB, AND
  1801	001707'	260040	002554'		PUSHJ	P,ONESLT 	; OTHER DDBS.
  1802	001710'	260040	001213'		PUSHJ	P,RONDUP	;MAYBE ROUND UP THE FILE SIZE.
  1803	001711'	260040	003541'		PUSHJ	P,UNLFIL	;UNLOCK THE FILE.
  1804	001712'	260040	001601*		PUSHJ	P,RELRIB	;RELEASE THE RIB.
  1805	001713'	262040	000007		POP	P,T2		;RESTORE THE GIVEN AWAY PAGE.
  1806	001714'	260040	000000*		PUSHJ	P,GIVPAG	;DEALLOCATE IT.
  1807	001715'	262040	000013		POP	P,M		;
  1808	001716'	254000	001665*		JRST	CPOPJ1		;SUCCESS RETURN.
  1809
  1810
  1811				    ;HERE ON SOME ERROR EXITS.
  1812	001717'	260040	003541'	DLXDR1:	PUSHJ	P,UNLFIL	;
  1813	001720'	262040	000013	DLXDR0:	POP	P,M		;
  1814	001721'	260040	001602*		PUSHJ	P,RELSAT	;
  1815	001722'	201300	000011		MOVEI	T1,FALRBE	;
  1816	001723'	263040	000000		POPJ	P,
  1817
  1818	001724'	262040	000013	DELDHO:	POP	P,M		;
  1819	001725'	261040	000006		PUSH	P,T1		;
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 30-2
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  1820	001726'	260040	003541'		PUSHJ	P,UNLFIL	;
  1821	001727'	260040	001712*		PUSHJ	P,RELRIB	;
  1822	001730'	260040	000000*		PUSHJ	P,RELRB2	;
  1823	001731'	260040	001721*		PUSHJ	P,RELSAT	;
  1824	001732'	262040	000006		POP	P,T1		;
  1825	001733'	263040	000000		POPJ	P,
  1826
  1827
  1828
  1829
  1830				COMMENT #
  1831				@@SUBROUTINE DELCRE
  1832				@@PURPOSE
  1833				LITTLE COMMON SUBR FOR HANDLING ONE SLOT IN AN ISOLATED RIB.
  1834				@@ENTRY
  1835				EXPECTS F/ DDB AND M/ FILE PAGE NUMBER OF INTEREST (<=HPW).
  1836				@@ACCUM
  1837				DESTROYS T1-T4, U, AND PG.
  1838				@@EXIT
  1839				ON SUCCESS, SKIP RETURNS WITH DDB
  1840				SET UP, RIB LOCKED IN CORE, ALL DDBS FLUSHED INTO RIB, AND
  1841				T2/ RETRIEVAL PNTR.
  1842				NON-SKIP RETURNS ON RIB ERROR AND HAS KILLED THE FILE.
  1843				@@ #
  1844
  1845	001734'	260040	001360*	DELCRE:	PUSHJ	P,USETST	;POINT TO PAGE M IN THE DDB.
  1846	001735'	263040	000000		  POPJ	P,		;
  1847	001736'	200304	000747*		MOVE	T1,DEVRIB(F)	;GET THE RIB FOR PAGE M
  1848	001737'	260040	003150'		PUSHJ	P,MWLRIB	;WRITE LOCKED.
  1849	001740'	324740	003175'		  PJRST	KILFIL		;
  1850	001741'	337364	001706*		SKIPG	T2,@DEVRET(F)	;LEGAL POINTER?
  1851	001742'	256000	000000'		 STOPCD                         ;;DELCRE+6
  1852	001743'	400300	000000		SETZ	T1,		;WRITE OUT THE OTHER DDBS WITH
  1853	001744'	260040	002657'		PUSHJ	P,FLUSH		;PTRCHG ON, AND THEN
  1854	001745'	260040	000752*		PUSHJ	P,PTROU0	;WRITE US OUT, TOO.
  1855	001746'	200364	001741*		MOVE	T2,@DEVRET(F)	;
  1856	001747'	254000	001716*		JRST	CPOPJ1		;
  1857
  1858
  1859				COMMENT #
  1860				@@SUBROUTINE DELXCH
  1861				@@PURPOSE
  1862				SMALL SUBR CALLED AT START OF FDEL, FEXCH, FTRNC, AND FCREATE
  1863				TO BE SURE THE FILE IS WRITEABLE AND TO SET SOME STUFF UP.
  1864				@@ENTRY
  1865				EXPECTS F/ DDB AND T3/ KFDEL, KFCREE, KFEXC, OR KFTRN.
  1866				@@ACCUM
  1867				SUCCESS RETURN DESTROYS ONLY T3 AND T4.
  1868				FAIL RETURN DESTROYS ALSO T1.
  1869				@@EXIT
  1870				NON-SKIP RETURNS ON ERROR, WITH ERROR FLAG IN T1.
  1871				SKIP RETURNS IF OKAY, WITH T4/ NUMBER OF HPW.
  1872				@@ #
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 30-3
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  1873
  1874
  1875	001750'	607200	060000	DELXCH:	TLNN	F,ENTRB!LOOKB	;IS THERE A FILE ON THIS CHANNEL?
  1876					 JRST	[MOVEI T1,FALNOF ;NO.
  1877	001751'	254000	004144'			POPJ P,]	;
  1878	001752'	603000	001616*		TLNE	S,IOBDRB	;DEAD RIB?
  1879					 JRST	[MOVEI T1,FALRBE ;
  1880	001753'	254000	004036'			POPJ P,]	;
  1881	001754'	510444	000007		HLLZ	T4,DEVIAD(F)
  1882	001755'	607200	020000		TLNN	F,ENTRB		;HAS IT BEEN ENTERED?
  1883					 JRST	[MOVEI T1,FALNWT ;NO.
  1884	001756'	254000	004146'			POPJ P,]
  1885	001757'	607440	001322*		TLNN	T4,NOWRT	;YES.  IS IT APPEND ONLY?
  1886	001760'	254000	001766'		 JRST	DELXC4		;NO.
  1887	001761'	306400	001640'		CAIN	T3,KFTRN	;YES, NOT CORRECTLY
  1888	001762'	254000	001765'		 JRST	DELXC2		; WRITEABLE IF
  1889	001763'	302400	001666'		CAIE	T3,KFDEL	; DELETE,
  1890	001764'	306400	002014'		CAIN	T3,KFEXC	; EXCH, OR TRUNCATE.
  1891								;KMOVPG CHECKS FOR ITSELF.
  1892				DELXC2:	JRST	[MOVEI T1,FALNWT ;
  1893	001765'	254000	004146'			POPJ P,]	;
  1894	001766'	306400	001640'	DELXC4:	CAIN	T3,KFTRN	;DON'T LOCK IF TRUNCATE
  1895					 JRST	[PUSHJ P,LOKMOD ;KFTRN NEEDS THE MODIFY LOCK
  1896	001767'	254000	004150'			 JRST DELXC5]
  1897	001770'	260040	003650'		PUSHJ	P,LOKUNM	;LOCK FOR UNMODIFYING.
  1898	001771'	200004	000002	DELXC5:	MOVE	S,DEVIOS(F)	;
  1899	001772'	603000	001752*		TLNE	S,IOBDRB	;CHECK IF FILE DIED WHILE WAITING
  1900					 JRST	[PUSHJ P,UNLFIL	;
  1901						MOVEI T1,FALRBE ;
  1902	001773'	254000	004152'			POPJ P,]	;
  1903	001774'	261040	000007		PUSH	P,T2		;SAVE T2.
  1904	001775'	550344	001647*		HRRZ	T2,DEVATB(F)	;GET
  1905	001776'	326340	002000'		JUMPN	T2,.+2		;T4/
  1906	001777'	256000	000000'		 STOPCD                         ;;DELXC4+11
  1907	002000'	135440	001620*		LDB	T4,ATYBSZ	; THE
  1908	002001'	271440	000003		ADDI	T4,3		; NUMBER OF THE
  1909	002002'	242440	777776		LSH	T4,B2PLSH	; HPW.
  1910	002003'	262040	000007		POP	P,T2		;RESTORE T2.
  1911	002004'	302400	001225'		CAIE	T3,KMOVPG	;DON'T CHECK THIS IF ITS KMOVPG.
  1912	002005'	306400	001067'		CAIN	T3,KFCREE	;CHECK FILE NO. ARG?
  1913	002006'	254000	001747*		 JRST	CPOPJ1		;NO.
  1914					JUMPLE	T1,[MOVEI T1,FALFPZ ;YES.  BETTER NOT BE <= 0
  1915	002007'	323300	004100'			JRST UNLFIL]	;
  1916	002010'	317300	000011		CAMG	T1,T4		;OR > HPW
  1917	002011'	254000	002006*		 JRST	CPOPJ1		;SUCCESS RETURN.
  1918	002012'	201300	000006		MOVEI	T1,FALPHP	;
  1919	002013'	254000	003541'		JRST	UNLFIL		;
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 31
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  1920				COMMENT #
  1921				@@SUBROUTINE KFEXC
  1922				@@PURPOSE
  1923				KERNEL SUBR TO EXCH TWO FILE PAGES.
  1924				@@ENTRY
  1925				EXPECTS USER'S ARGS IN T1 AND T2, AND T3/ BIT 0 ON IFF CALLED
  1926				FROM USER MODE,
  1927				AND ALSO F/ DDB AND S/ DEVIOS.
  1928				@@ACCUM
  1929				DESTROYS T1-T4, P1-P4, U, M, AND PG.
  1930				@@EXIT
  1931				SKIP RETURNS UNLESS ERROR, IN WHICH CASE IT NON-SKIP RETURNS.
  1932				ON NON-SKIP RETURN, T1 CONTAINS THE ERROR FLAG AS FOLLOWS:
  1933				FALFPZ,FALPHP,FALRBE,FALSAM,FALNOF,FALNWT.
  1934				@@ #
  1935
  1936	002014'	201400	002014'	KFEXC::	MOVEI	T3,KFEXC	;
  1937	002015'	260040	001750'		PUSHJ	P,DELXCH	;CHK & LOCK FILE, GET T4/ HPW
  1938	002016'	263040	000000		  POPJ	P,		;AND CHK T1/ 1ST ARG.
  1939					JUMPLE	T2,[MOVEI T1,FALFPZ ;2ND ARG MUST ALSO BE >0
  1940	002017'	323340	004100'			JRST UNLFIL]	;AND
  1941	002020'	313340	000011		CAMLE	T2,T4		;<= HPW.
  1942					 JRST	[MOVEI T1,FALPHP ;
  1943	002021'	254000	004050'			JRST UNLFIL]	;
  1944	002022'	316300	000007		CAMN	T1,T2		;REQ PAGES THE SAME PAGE?
  1945					 JRST	[MOVEI T1,FALSAM ;YES.
  1946	002023'	254000	004155'			JRST UNLFIL]	;
  1947
  1948				    ;DO WE NEED ONE RIB, OR TWO?
  1949	002024'	261040	000013		PUSH	P,M		;SAVE M.
  1950	002025'	200540	000006		MOVE	M,T1		;CARRY FILE PAGE NOS. IN
  1951	002026'	200600	000007		MOVE	P1,T2		;SAFE ACS.
  1952	002027'	275300	000001		SUBI	T1,1		;ARE THE PAGES
  1953	002030'	275340	000001		SUBI	T2,1		;IN
  1954	002031'	231340	000000*		IDIVI	T2,RBLVSP	;THE
  1955	002032'	200400	000007		MOVE	T3,T2		;
  1956	002033'	231300	002031*		IDIVI	T1,RBLVSP	;SAME
  1957	002034'	316300	000010		CAMN	T1,T3		;RIB?
  1958	002035'	634640	000015		 TDZA	P2,P2		;YES, P2=0 IS FLAG FOR ONLY
  1959	002036'	474640	000000		  SETO	P2,		;NEED 1 RIB, ELSE NEED 2 RIBS.
  1960
  1961				    ;ORDER FILE PAGE NUMBRS TO AVOID DEADLOCK.
  1962	002037'	313540	000014		CAMLE	M,P1		;
  1963	002040'	250540	000014		 EXCH	M,P1		;
  1964
  1965				    ;HERE TO GET MIN RIB.  FILE PAGE NOS. ARE IN M AND P1.
  1966	002041'	322640	002047'	EXCHH3:	JUMPE	P2,EXCH35	;IF NEED TWO RIBS IN CORE
  1967	002042'	260040	001673*		PUSHJ	P,SETACH	;AND SET UFPALC, WAIT FOR UFD TO GO OUT
  1968	002043'	261040	000002		PUSH	P,J		;SIMULTANEOUSLY,
  1969	002044'	200100	000711*		MOVE	J,JOB		;THEN
  1970	002045'	260040	000000*		PUSHJ	P,GETM2		;FIRST GET
  1971	002046'	262040	000002		POP	P,J		;M2 RESOURCE.
  1972	002047'	260040	001734*	EXCH35:	PUSHJ	P,USETST	;SET OUR DDB AND %RIB
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 31-2
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  1973	002050'	254000	002211'		  JRST	EXCDR4		;TO MIN PAGE.
  1974	002051'	326640	002070'		JUMPN	P2,EXCHH6	;JUMP IF NEED TWO RIBS.
  1975
  1976				    ;HERE ON NEED ONLY ONE RIB.  MIN RIB WILL BE IN %RIB.
  1977				      ;MAKE THE ONE RIB CURRENT AND GET THE "DEYRPSES" INTO
  1978				      ;M AND P1.
  1979	002052'	200304	001736*		MOVE	T1,DEVRIB(F)	;BE SURE THE
  1980	002053'	260040	003150'		PUSHJ	P,MWLRIB	;RIB IS IN
  1981	002054'	254000	002202'		  JRST	EXCDRB		;%RIB.
  1982	002055'	400300	000000		SETZ	T1,		;UPDATE THE RIB
  1983	002056'	260040	002657'		PUSHJ	P,FLUSH		;FROM THE DDB AREAS,
  1984	002057'	260040	001745*		PUSHJ	P,PTROU0	;INCLUDING MAYBE OUR OWN.
  1985	002060'	261040	000014		PUSH	P,P1		;SAVE FILE PAGE NOS. FOR
  1986	002061'	261040	000013		PUSH	P,M		;ONESLTS BELOW.
  1987	002062'	274600	000013		SUB	P1,M		;GET
  1988	002063'	135540	001702*		LDB	M,DEYRPS	;M/
  1989	002064'	275544	402000*		SUBI	M,DEVRBN-%RIB(F) ;"DEYRPS" OF
  1990	002065'	270544	001746*		ADD	M,DEVRET(F)	;MIN OF THE PAGES AND
  1991	002066'	270600	000013		ADD	P1,M		;P1/ "DEYRPS" OF MAX PAGE.
  1992	002067'	254000	002137'		JRST	EXCHH7		;
  1993
  1994				    ;HERE ON NEED TWO RIBS.  GET THEM BOTH LOCKED INTO CORE
  1995				      ;SO WE CAN MAKE THEM CURRENT AND THEN CHANGE THE SLOTS.
  1996	002070'	135300	002063*	EXCHH6:	LDB	T1,DEYRPS	;SAVE
  1997	002071'	275304	402000*		SUBI	T1,DEVRBN-%RIB(F) ;"DEYRPS"
  1998	002072'	270304	002065*		ADD	T1,DEVRET(F)	;OF
  1999	002073'	261040	000006		PUSH	P,T1		;MIN.
  2000	002074'	261044	002052*		PUSH	P,DEVRIB(F)	;SAVE DEVRIB OF MIN.
  2001	002075'	260040	001727*		PUSHJ	P,RELRIB	;DON'T BLOCK USETST.
  2002	002076'	250540	000014		EXCH	M,P1		;GET
  2003	002077'	260040	002047*		PUSHJ	P,USETST	; THE
  2004	002100'	254000	002207'		  JRST	EXCDR3		; MAX FILE
  2005	002101'	476004	000753*		SETOM	DEVFLO(F)	; PAGE
  2006	002102'	200304	002074*		MOVE	T1,DEVRIB(F)	; NO.
  2007	002103'	260040	003150'		PUSHJ	P,MWLRIB	; RIB
  2008	002104'	254000	002200'		  JRST	EXCDR1		; INTO
  2009	002105'	260040	000000*		PUSHJ	P,SMMPXC	; %RB2.
  2010	002106'	135300	002070*		LDB	T1,DEYRPS	;SAVE AWAY "DEYRPS" OF MAX
  2011	002107'	275304	403000*		SUBI	T1,DEVRBN-%RB2(F) ;WHILE WE HAVE
  2012	002110'	270304	002072*		ADD	T1,DEVRET(F)	;THE
  2013	002111'	250301	000000		EXCH	T1,(P)		;INFO.
  2014	002112'	202304	002102*		MOVEM	T1,DEVRIB(F)	;GET THE MIN RIB INTO
  2015	002113'	260040	003150'		PUSHJ	P,MWLRIB	;%RIB.
  2016	002114'	254000	002207'		  JRST	EXCDR3		;
  2017	002115'	400300	000000		SETZ	T1,		;NOW THAT WE
  2018	002116'	260040	002657'		PUSHJ	P,FLUSH		;HAVE BOTH
  2019	002117'	260040	002105*		PUSHJ	P,SMMPXC	;THE RIBS LOCKED
  2020	002120'	200300	376000*		MOVE	T1,%RIB+RIBSLF	;INTO CORE, WE
  2021	002121'	202304	002112*		MOVEM	T1,DEVRIB(F)	;CAN
  2022	002122'	400300	000000		SETZ	T1,		;UPDATE THEM
  2023	002123'	260040	002657'		PUSHJ	P,FLUSH		;BOTH.
  2024	002124'	250541	777777		EXCH	M,-1(P)		;SAVE FILE PAGE NOS. FOR
  2025	002125'	250601	000000		EXCH	P1,(P)		;ONESLTS AND GET DEYRPSES.
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 31-3
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  2026	002126'	260040	002117*		PUSHJ	P,SMMPXC	;GET THE
  2027	002127'	551453	000000		HRRZI	T4,(M)		;MIN SLOT
  2028	002130'	275440	376001		SUBI	T4,%RIB+1	;PNTR BACK
  2029	002131'	137440	002106*		DPB	T4,DEYRPS	;INTO
  2030	002132'	200441	000000		MOVE	T4,(P)		;%RIB.
  2031	002133'	200300	376000*		MOVE	T1,%RIB+RIBSLF	;
  2032	002134'	202304	002121*		MOVEM	T1,DEVRIB(F)	;
  2033	002135'	260040	000671*		PUSHJ	P,PTRINN	;
  2034	002136'	256000	000000'		 STOPCD                         ;;EXCHH6+many
  2035
  2036
  2037				    ;HERE WITH 1 OR 2 RIBS, TO EXCHANGE THE PNTRS EVERYWHERE,
  2038				      ;AND THEN FINISH UP.  PDL HAS MIN FPN ON TOP, MAX
  2039				      ;FPN JUST BELOW.  %RIB AND DDB PNTR AREA HOLD MIN FPN.
  2040				      ;M/ "DEYRPS" OF MIN, P1/ "DEYRPS" OF MAX.
  2041	002137'	333713	000000	EXCHH7:	SKIPLE	P3,(M)		;BOTH RET PNTRS
  2042	002140'	337754	000000		SKIPG	P4,(P1)		;LEGAL?
  2043	002141'	256000	000000'		 STOPCD                         ;;EXCCH7+2
  2044	002142'	515340	001422*		HRLZI	T2,PTRCHG	;
  2045	002143'	436344	000007		IORM	T2,DEVIAD(F)	;
  2046	002144'	202753	000000		MOVEM	P4,(M)		;2ND PNTR TO 1ST SLOT IN RIB.
  2047	002145'	200340	000017		MOVE	T2,P4		;UPDATE
  2048	002146'	262040	000013		POP	P,M		; THE
  2049	002147'	260040	002554'		PUSHJ	P,ONESLT	; OTHER DDBS.
  2050	002150'	202714	000000		MOVEM	P3,(P1)		;STORE 1ST PNTR INTO 2ND
  2051	002151'	262040	000013		POP	P,M		;SLOT IN %RIB AND
  2052	002152'	260040	001213'		PUSHJ	P,RONDUP	;UPDATE THE
  2053	002153'	200340	000016		MOVE	T2,P3		;
  2054	002154'	322640	002160'		JUMPE	P2,EXCH73	;
  2055	002155'	200300	375000*		MOVE	T1,%RB2+RIBSLF	;
  2056	002156'	261044	002134*		PUSH	P,DEVRIB(F)	;
  2057	002157'	202304	002156*		MOVEM	T1,DEVRIB(F)	;
  2058	002160'	260040	002554'	EXCH73:	PUSHJ	P,ONESLT	;OTHER DDBS.
  2059	002161'	202764	002110*		MOVEM	P4,@DEVRET(F)	;OLD MAX TO MIN DDB SLOT.
  2060	002162'	322640	002165'		JUMPE	P2,EXCH7A	;
  2061	002163'	262044	002157*		POP	P,DEVRIB(F)	;
  2062	002164'	254000	002173'		JRST	EXCHOT		;
  2063
  2064	002165'	200300	000004	EXCH7A:	MOVE	T1,F		;IF ONLY ONE RIB,
  2065	002166'	200404	002101*		MOVE	T3,DEVFLO(F)	; POSSIBLY WE HAVE
  2066	002167'	260040	002566'		PUSHJ	P,FINDM		; TO
  2067	002170'	254000	002173'		JRST	EXCHOT		; UPDATE THE OTHER
  2068	002171'	326340	002173'		JUMPN	T2,EXCHOT	; SLOT IN
  2069	002172'	202710	000000		MOVEM	P3,(T3)		; OUR DDB.
  2070	002173'	260040	002075*	EXCHOT:	PUSHJ	P,RELRIB	;JUST ABOUT DONE. REL THE RIB,
  2071	002174'	260040	001730*		PUSHJ	P,RELRB2	;MAYBE ALSO RELEASE %RB2,
  2072	002175'	260040	003541'		PUSHJ	P,UNLFIL	;RELEASE THE FILE,
  2073	002176'	262040	000013		POP	P,M		;CLR PDL, AND THEN
  2074	002177'	254000	002011*		JRST	CPOPJ1		;TAKE THE SUCCESS RETURN.
  2075
  2076
  2077
  2078	002200'	262040	000006	EXCDR1:	POP	P,T1
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 31-4
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  2079	002201'	262040	000006		POP	P,T1
  2080	002202'	322640	000002	EXCDRB:	JUMPE	P2,+2		;
  2081	002203'	260040	000000*		PUSHJ	P,RELM2		;
  2082	002204'	262040	000013		POP	P,M		;
  2083	002205'	260040	001731*		PUSHJ	P,RELSAT	;
  2084	002206'	324740	003175'		PJRST	KILFIL
  2085
  2086	002207'	262040	000006	EXCDR3:	POP	P,T1
  2087	002210'	262040	000006		POP	P,T1
  2088	002211'	322640	001720'	EXCDR4:	JUMPE	P2,DLXDR0	;
  2089	002212'	260040	002203*		PUSHJ	P,RELM2		;
  2090	002213'	324740	001720'		PJRST	DLXDR0
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 32
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  2091				COMMENT #
  2092				@@SUBROUTINE SWEEP/SWEPHO/SWEPPG
  2093				@@PURPOSE
  2094				SUBR TO SWEEP A FILE PAST ITS CURRENT EOF.
  2095				@@ENTRY
  2096				EXPECTS F/ DDB, S/ DEVIOS, M/ NO. OF FIRST PAGE TO CREATE,
  2097				T4/ TOTAL NUMBER OF PAGES TO CREATE (INCLUDING M).
  2098				SWEEP WILL EXTEND THE FILE OUT TO M-1, IF NECESSARY, WITH
  2099				HOLES.  THEN FROM M TO M+T4-1 IT WILL CREATE (A) HOLES OR
  2100				(B) ZERO DISK PAGES, DEPENDING ON WHETHER IT WAS CALLED AT
  2101				SWEPHO OR SWEPPG RESPECTIVELY.
  2102				SWEEP EXPECTS THE FILE TO BE MODIFIED LOCKED ON ENTRY.
  2103				THERE MAY BE A RIB IN %RIB AND A SAT IN %SAT ON ENTRY.
  2104				THE FILE SIZE IS ALWAYS SET TO THE NEW EOF ON EITHER SUCCESS
  2105				OR ERROR RETURN.
  2106				THIS ROUTINE DOES NOT SET DEVPOS AND FRIENDS AS IT IS CALLED BY
  2107				BOTH OLD AND NEW STYLE IO ROUTINES.
  2108				IF T1/0 (-1) SWEEP WILL STOP (NOT STOP) ON CONTROL C.
  2109				@@ACCUM
  2110				DESTROYS T1-T4, PG, U,
  2111				@@EXIT
  2112				ON A SUCCESS RETURN OR A FAIL RETURN OTHER THAN FOR A BAD RIB,
  2113				THERE MAY BE A RIB IN %RIB AND A SAT IN %SAT, AND THE FILE IS
  2114				NOT UNLOCKED.  ON A FAIL RETURN DUE TO A BAD RIB, THE FILE IS
  2115				MARKED BAD, UNLOCKED, AND THE RIBS ARE GIVEN AWAY.
  2116				SUCCESS RETURN IS A SKIP RETURN.  ERROR RETURN IS A NON-SKIP
  2117				RETURN.  ERROR CODE RETURNED IN T1 IS:
  2118					FALCTL    CONTROL C IS WAITING
  2119					FALAQA    QUOTA EXCEEDED (NOTE THAT IT IS THE CALLER'S
  2120						    RESPONSIBILITY TO TYPE OUT THE EXCEEDING
  2121						    QUOTA MSG.).
  2122					FALRBE    RIB ERROR
  2123				ON AN ERROR RETURN, T4 HAS BEEN DECREMENTED BY THE NO. OF PAGES
  2124				AT AND FOLLOWING M THAT HAVE BEEN SUCCESSFULLY CREATED;
  2125				EVEN IF T4 IS UNCHANGED, PAGES MAY
  2126				STILL HAVE ALLOCATED IF M WAS ORIGINALLY >HPW+1;  (IN THIS
  2127				CASE THE FILE SIZE REFLECTS THESE PAGES.).
  2128				@@ #
  2129
  2130			000001	FLG.PG==1
  2131			000004	FLG.ER==4
  2132			000010	FLG.CC==10
  2133				;ENTER AT SWEPRH TO DO HOLES IN SPITE OF TITO CROCK.
  2134			000001		TITO==1	;WHEN =1, TITO CROCK IS IN EFFECT.
  2135				IFE TITO,<SWEPHO::>
  2136	002214'	634340	000007	SWEPRH::TDZA	T2,T2		;
  2137	002215'			IFN TITO,<SWEPHO::>
  2138	002215'	201340	000001	SWEPPG::MOVEI	T2,FLG.PG	;
  2139
  2140	002216'	261040	000014	SWEEP:	PUSH	P,P1		;SAVE SOME
  2141	002217'	261040	000015		PUSH	P,P2		;ACS WE
  2142	002220'	261040	000016		PUSH	P,P3		;WILL BE USING.
  2143	002221'	200600	000007		MOVE	P1,T2		;THIS WILL BE OUR FLAG WORD.
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 32-2
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  2144	002222'	322300	002226'		JUMPE	T1,SWEEP0	;WANT TO STOP ON CONTROL C?
  2145	002223'	660600	000010		TRO	P1,FLG.CC	;NO.
  2146	002224'	342300	002226'		AOJE	T1,SWEEP0	;T1 HAD TO BE 0 OR -1.
  2147	002225'	256000	000000'		 STOPCD                         ;;SWEEP+7
  2148	002226'	200640	000011	SWEEP0:	MOVE	P2,T4		;COUNTER OF PAGES.
  2149
  2150				    ;MUST WE EXTEND THE FILE BEFORE WE SWEEP?
  2151	002227'	550344	001775*		HRRZ	T2,DEVATB(F)	;
  2152	002230'	326340	002232'		JUMPN	T2,.+2		;
  2153	002231'	256000	000000'		 STOPCD                         ;;SWEEP0+3
  2154	002232'	135440	002000*		LDB	T4,ATYBSZ	;
  2155	002233'	271440	000003		ADDI	T4,3		;
  2156	002234'	242440	777776		LSH	T4,-2		;
  2157	002235'	271440	000001		ADDI	T4,1		;T4/ OLD HPW+1.
  2158	002236'	317540	000011		CAMG	M,T4		;MUST EXTEND FILE BEFORE SWEEP?
  2159	002237'	254000	002251'		 JRST	SWEEP2		;NO.
  2160				      ;HERE TO EXTEND THE FILE OUT TO REQUESTED STARTING PAGE.
  2161	002240'	261040	000013		PUSH	P,M		;YES.
  2162	002241'	250540	000011		EXCH	M,T4		;
  2163	002242'	274440	000013		SUB	T4,M		;
  2164	002243'	400300	000000		SETZ	T1,		;
  2165	002244'	602600	000010		TRNE	P1,FLG.CC	;
  2166	002245'	474300	000000		 SETO	T1,		;
  2167	002246'	260040	002215'		PUSHJ	P,SWEPHO
  2168					  JRST	[POP P,M	;ERROR.  RESTORE M.
  2169						TRO P1,FLG.ER	;TAKE THE SWEPD4 ERROR
  2170	002247'	254000	004157'			JRST SWEPD4]	;RETURN.
  2171	002250'	262040	000013		POP	P,M		;SUCCESS RETURN.
  2172	002251'	602600	000001	SWEEP2:	TRNE	P1,FLG.PG	;IF DOING HOLES OR
  2173	002252'	302640	000001		CAIE	P2,1		;MORE THAN 1 PAGE,
  2174	002253'	254000	002315'		 JRST	SWEP2A		;GO DO IT THE NORMAL WAY.
  2175				;Using VMOVPG causes the COW page to be allocated at random, which means
  2176				; the file pages will be scattered all over the place, and FILIO will
  2177				; have to do a SEEK for every single page read in.  Setting CONTIG
  2178				; nonzero in COMMON will make new file pages be contiguous as possible
  2179				; with the previous pages.
  2180	002254'	332000	000000*		SKIPE	CONTIG##	;If CONTIG= 0, use VMOVPG
  2181	002255'	254000	002315'		 JRST	SWEP2A		;If CONTIG=-1, use CREPAG
  2182
  2183				;WE ARE DOING 1 REAL PAGE. USE VMOVPG TO SAVE ON I/O
  2184	002256'	260040	002173*		PUSHJ	P,RELRIB
  2185	002257'	260040	002205*		PUSHJ	P,RELSAT
  2186	002260'	260040	003541'		PUSHJ	P,UNLFIL	;GET RID OF ALL THE LOCKS
  2187	002261'	261040	000017		PUSH	P,P4
  2188	002262'	261040	000013		PUSH	P,M
  2189	002263'	261040	000012		PUSH	P,W
  2190	002264'	200300	004162'		MOVE	T1,[6001,,%COW.N+CNVVPN]
  2191	002265'	047300	777711		VCREAT	T1,		;CREATE PRIVATE PAGE (at random position)
  2192	002266'	254000	002277'		  JRST	SWEP3E
  2193	002267'	200300	004163'		MOVE	T1,[1,,%COW.N+CNVVPN]
  2194	002270'	200340	000013		MOVE	T2,M		;MAKE PRIVATE PAGE PART OF THE FILE
  2195	002271'	260040	002307'		PUSHJ	P,DOMVPG	;DO VMOVPG AND FIX PC.UIO
  2196	002272'	504600	000006		  HRL	P1,T1		;SORRY, IT FAILED.
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 32-3
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  2197	002273'	200300	004164'		MOVE	T1,[2001,,%COW.N+CNVVPN]
  2198	002274'	047300	777712		VCLEAR	T1,		;NOW GET RID OF THE PAGE
  2199	002275'	256000	000000'		  STOPCD                         ;;SWEEP2+22
  2200	002276'	254000	002300'		JRST	.+2
  2201
  2202	002277'	550300	000006	SWEP3E:	HRRZ	T1,T1
  2203	002300'	334000	000000		SKIPA
  2204	002301'	554300	000014		HLRZ	T1,P1		;GET ERROR CODE (IF ANY) INTO T1
  2205	002302'	201640	000001		MOVEI	P2,1		;HAD TO BE 1 OR ELSE WE WOULDNT BE HERE
  2206	002303'	262040	000012		POP	P,W
  2207	002304'	262040	000013		POP	P,M
  2208	002305'	262040	000017		POP	P,P4		;RESTORE ESSENTIAL ACS
  2209	002306'	254000	002526'		JRST	SWEPD4
  2210
  2211	002307'	254120	004165'	DOMVPG:	JRSTF	@[.+1]		;CLEAR PC.UIO
  2212	002310'	260040	001225'		PUSHJ	P,KMOVPG
  2213	002311'	334000	000000		  SKIPA
  2214	002312'	350001	000000		AOS	(P)		;SKIP RETURN
  2215	002313'	262040	000007		POP	P,T2		;GET PC OFF STACK
  2216	002314'	254107	000000		JRSTF	(T2)		;AND RETURN, RESTORING STATE OF PC,UIO.
  2217				;End of VMOVPG kludge
  2218
  2219				;Here to add a new page to the file, contiguous to previous page
  2220
  2221	002315'	275540	000001	SWEP2A:	SUBI	M,1		;POINT @DEVRET TO
  2222	002316'	260040	002077*		PUSHJ	P,USETST	; M-1 PAGE.
  2223					  JRST	[TRO P1,FLG.ER
  2224	002317'	254000	004166'			AOJA M,SWEPD4]	;
  2225	002320'	271540	000001		ADDI	M,1		;Back to requested page
  2226
  2227				    ;HERE WITH EOF JUST BEFORE M, AND DEVRET POINTING TO
  2228				    ;M-1 PAGE.  P2/ NO. OF PAGES TO DO, P1/ VARIOUS FLAGS.
  2229
  2230	002321'	261040	000015	SWEEP3:	PUSH	P,P2		;SAVE FOR FILE SIZE CALC.
  2231	002322'	201304	001704*		MOVEI	T1,DEVRBN(F)	;T1/ NO. OF PAGES LEFT IN
  2232	002323'	274304	002161*		SUB	T1,DEVRET(F)	;THIS DDB.
  2233	002324'	307646	000000		CAIG	P2,(T1)		;ROOM ENOUGH IN THIS DDB?
  2234	002325'	254000	002342'		 JRST	SWEEP4		;YES.
  2235	002326'	261040	000006		PUSH	P,T1		;NO, WILL NEED AT LEAST OUR RIB.
  2236	002327'	200304	002163*		MOVE	T1,DEVRIB(F)	;
  2237	002330'	260040	003150'		PUSHJ	P,MWLRIB	;
  2238					  JRST	[TRO P1,FLG.ER	;RIB ERROR.
  2239						HRLI P1,FALRBE
  2240						POP P,T1
  2241	002331'	254000	004170'			JRST SWEPDN]
  2242	002332'	262040	000006		POP	P,T1		;
  2243	002333'	135400	002131*		LDB	T3,DEYRPS	;FIND OUT IF NEED >THIS
  2244	002334'	213000	000010		MOVNS	T3		;RIB.  CALC T1/ TOTAL
  2245	002335'	271400	000637*		ADDI	T3,RIBLST	;NO. OF
  2246	002336'	271310	000000		ADDI	T1,(T3)		;PAGES LEFT IN THIS DDB + RIB.
  2247	002337'	307646	000000		CAIG	P2,(T1)		;ENOUGH?
  2248	002340'	254000	002401'		 JRST	SWEEP5		;YES, IN THIS RIB.
  2249	002341'	254000	002465'		JRST	SWEEP6		;IN >1 RIB.
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 32-4
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  2250
  2251				    ;HERE WHEN NO NEED TO GET RIB, ALL NEW PNTRS WILL FIT IN
  2252				    ;OUR DDB.
  2253	002342'	261044	002323*	SWEEP4:	PUSH	P,DEVRET(F)	;SAVE M-1 LOC ADDR FOR BELOW.
  2254	002343'	205300	002142*		MOVSI	T1,PTRCHG	;
  2255	002344'	436304	000007		IORM	T1,DEVIAD(F)	;Pointers have changed
  2256	002345'	201340	434164		MOVEI	T2,'CAT'
  2257	002346'	606600	000001		TRNN	P1,FLG.PG	;
  2258	002347'	254000	002360'		 JRST	SWEP44		;<0,,'CAT'> marks a hole (RBREAL is off)
  2259	002350'	400340	000000		SETZ	T2,		;Zero means get page anywhere
  2260	002351'	200404	002342*		MOVE	T3,DEVRET(F)	;
  2261	002352'	301404	000000*		CAIL	T3,DEVRB1(F)	;
  2262	002353'	200350	000000		 MOVE	T2,(T3)		;If previous page known, contig with it
  2263				      ;SET UP INFO IN OUR DDB.
  2264	002354'	606600	000001	SWEP42:	TRNN	P1,FLG.PG	;DOING HOLES?
  2265	002355'	254000	002360'		 JRST	SWEP44		;YES.
  2266	002356'	260040	002730'		PUSHJ	P,CREPAG	;NO. ALLOC, 0, CHRG, IN T2.
  2267	002357'	254000	002363'		  JRST	SWEP46		;ERR, DIDN'T ALLOC.
  2268	002360'	350004	002351*	SWEP44:	AOS	DEVRET(F)	;
  2269	002361'	202364	002360*		MOVEM	T2,@DEVRET(F)	;Store new pointer (or hole)
  2270	002362'	367640	002354'		SOJG	P2,SWEP42	;
  2271
  2272				      ;NOW UPDATE OTHER DDBS.
  2273	002363'	200004	000002	SWEP46:	MOVE	S,DEVIOS(F)	;DID THE FILE GO BAD WHILE
  2274	002364'	607000	001772*		TLNN	S,IOBDRB	; WE WERE IN CREPAG?
  2275	002365'	254000	002370'		 JRST	SWEP47		;NO, OKAY.
  2276	002366'	505600	000011		HRLI	P1,FALRBE	;YES, OVERRIDE OTHER
  2277	002367'	660600	000004		TRO	P1,FLG.ER	; ERRORS.
  2278	002370'	262040	000016	SWEP47:	POP	P,P3		;SET UP ARGS FOR UPDDDB.
  2279	002371'	271700	000001		ADDI	P3,1		;P3/ DEVRET TO
  2280	002372'	274641	000000		SUB	P2,(P)		;PAGE M.
  2281	002373'	217000	000015		MOVMS	P2		;P2/ NO. OF
  2282	002374'	322640	002376'		JUMPE	P2,.+2		;PAGES WE DID.
  2283	002375'	260040	002535'		PUSHJ	P,UPDDDB	;UPDATE OTHER DDBS.
  2284	002376'	274641	000000		SUB	P2,(P)		;SET UP P2/ NO. PAGES NOT DONE
  2285	002377'	217000	000015		MOVMS	P2		;FOR SWEPDN.
  2286	002400'	254000	002510'		JRST	SWEPDN		;
  2287
  2288				    ;HERE WHEN NEED OUR RIB, AND ALL POINTERS WILL BE WITHIN IT.
  2289				      ;OUTPUT ALL INTERESTING DDBS WITH PTRCHG ON.
  2290	002401'	400300	000000	SWEEP5:	SETZ	T1,		;T1= DON'T INVALIDATE DDBS WHEN
  2291	002402'	260040	002657'		PUSHJ	P,FLUSH		;WRITE THEM INTO %RIB.
  2292	002403'	260040	002057*		PUSHJ	P,PTROU0	;MAYBE OUTPUT US TOO.
  2293				      ;GET PNTR TO PLACE IN RIB.
  2294	002404'	201304	002322*		MOVEI	T1,DEVRBN(F)	;GET P3/
  2295	002405'	274304	002361*		SUB	T1,DEVRET(F)	;PNTR TO
  2296	002406'	135700	002333*		LDB	P3,DEYRPS	;FIRST NEW LOC IN THE
  2297	002407'	275706	777777		SUBI	P3,-1(T1)	;RIB.
  2298	002410'	606600	000001		TRNN	P1,FLG.PG	;DOING HOLES?
  2299	002411'	254000	002431'		 JRST	SWEP55		;YES, GO TO EASY BLT.
  2300	002412'	400340	000000		SETZ	T2,		;Zero means get page anywhere
  2301	002413'	200404	002405*		MOVE	T3,DEVRET(F)	;
  2302	002414'	301404	002352*		CAIL	T3,DEVRB1(F)	;
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 32-5
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  2303	002415'	200350	000000		 MOVE	T2,(T3)		;If previous page known, contig with it
  2304	002416'	260040	002730'	SWEP54:	PUSHJ	P,CREPAG	;NO, GO ONE BY ONE.
  2305	002417'	254000	002441'		  JRST	SWEP56		;ERROR, DIDN'T ALLOCATE.
  2306	002420'	202356	376000		MOVEM	T2,%RIB(P3)	;
  2307	002421'	271700	000001		ADDI	P3,1		;
  2308	002422'	367640	002416'		SOJG	P2,SWEP54	;
  2309	002423'	200004	000002		MOVE	S,DEVIOS(F)	;DID THE FILE GO BAD WHILE WE
  2310	002424'	607000	002364*		TLNN	S,IOBDRB	; WERE IN CREPAG?
  2311	002425'	254000	002441'		 JRST	SWEP56		;NO.
  2312	002426'	505600	000011		HRLI	P1,FALRBE	;YES.
  2313	002427'	660600	000004		TRO	P1,FLG.ER	;
  2314	002430'	254000	002441'		JRST	SWEP56		;
  2315
  2316				      ;HERE TO BLT HOLES INTO RIB.
  2317	002431'	201340	434164	SWEP55:	MOVEI	T2,'CAT'	;SETUP T2, WE'RE DOING HOLES
  2318	002432'	202356	376000		MOVEM	T2,%RIB(P3)	;STORE FIRST HOLE.
  2319	002433'	201456	376001		MOVEI	T4,%RIB+1(P3)	;T4 IS THE
  2320	002434'	505451	777777		HRLI	T4,-1(T4)	;BLT AC.
  2321	002435'	271715	000000		ADDI	P3,(P2)		;POINT P3 TO
  2322	002436'	302640	000001		CAIE	P2,1		;If just one, we've done it
  2323	002437'	251456	375777		 BLT	T4,%RIB-1(P3)	;More than 1 hole
  2324	002440'	201640	000000		MOVEI	P2,0		;No hole pages left undone
  2325				      ;HERE TO FIX UP THE DDBS FOR THIS RIB.
  2326	002441'	261040	000004	SWEP56:	PUSH	P,F		;SAVE F.
  2327	002442'	400300	000000		SETZ	T1,		;GET THE NEXT DDB ADDR
  2328	002443'	260040	002617'	SWEP57:	PUSHJ	P,FNDDDB	;INTO T1.
  2329	002444'	254000	002453'		 JRST	SWEP58		;NO MORE DDBS.
  2330	002445'	200200	000006		MOVE	F,T1		;GET
  2331	002446'	135340	002406*		LDB	T2,DEYRPS	;DEYRPS.
  2332	002447'	515347	000000*		HRLZI	T2,%RIB-PTRLEN+1(T2) ;COPY THE (NEW?) PNTRS
  2333	002450'	541346	002414*		HRRI	T2,DEVRB1(T1)	;FROM THE AREA IN THE RIB TO THE
  2334	002451'	251346	002404*		BLT	T2,DEVRBN(T1)	;DDB AREA.
  2335	002452'	254000	002443'		JRST	SWEP57		;GO TO NEXT DDB.
  2336
  2337	002453'	262040	000004	SWEP58:	POP	P,F		;RESTORE F.
  2338	002454'	275700	000002		SUBI	P3,2		;NOW, UPDATE
  2339	002455'	137700	002446*		DPB	P3,DEYRPS	;OUR DDB AREA TOO:
  2340	002456'	200441	000000		MOVE	T4,(P)		;(CALC
  2341	002457'	274440	000015		SUB	T4,P2		; T4/
  2342	002460'	270440	000013		ADD	T4,M		; DEVFLO
  2343	002461'	275440	000001		SUBI	T4,1		; FOR PTRINN)
  2344	002462'	260040	002135*		PUSHJ	P,PTRINN	;
  2345	002463'	256000	000000'		  STOPCD                         ;;SWEP58+10
  2346	002464'	254000	002510'		JRST	SWEPDN		;
  2347
  2348				    ;HERE WHEN WE NEED MORE THAN 1 RIB.
  2349				      ;OUTPUT ALL INTERESTING DDBS WITH PTRCHG ON.
  2350	002465'	474300	000000	SWEEP6:	SETO	T1,		;INVALIDATE DDBS AND WRITE THEM
  2351	002466'	260040	002657'		PUSHJ	P,FLUSH		;INTO %RIB.
  2352	002467'	201340	434164	SWEP63:	MOVEI	T2,'CAT'
  2353	002470'	205700	002343*		MOVSI	P3,PTRCHG	;
  2354	002471'	606600	000001		TRNN	P1,FLG.PG	;DOING HOLES?
  2355	002472'	254000	002477'		 JRST	SWEP64		;
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 32-6
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  2356	002473'	400340	000000		SETZ	T2,		;Zero means get page anywhere
  2357	002474'	200404	002413*		MOVE	T3,DEVRET(F)	;
  2358	002475'	301404	002450*		CAIL	T3,DEVRB1(F)	;
  2359	002476'	200350	000000		 MOVE	T2,(T3)		;If previous page known, contig with it
  2360	002477'	260040	003126'	SWEP64:	PUSHJ	P,GETRET	;Get right RIB for storing pointer
  2361					  JRST	[TRO P1,FLG.ER	;
  2362						HRLI P1,(T1)	;
  2363	002500'	254000	004174'			JRST SWEPDN]	;
  2364	002501'	606600	000001		TRNN	P1,FLG.PG	;DOING HOLES?
  2365	002502'	254000	002505'		 JRST	SWEP65		;YES.
  2366	002503'	260040	002730'		PUSHJ	P,CREPAG	;
  2367	002504'	254000	002510'		  JRST	SWEPDN		;ERROR, DIDN'T ALLOCATE.
  2368	002505'	202364	002474*	SWEP65:	MOVEM	T2,@DEVRET(F)	;
  2369	002506'	436704	000007		IORM	P3,DEVIAD(F)	;
  2370	002507'	367640	002477'		SOJG	P2,SWEP64	;
  2371					PFALL	SWEPDN		;Sweep done
  2372
  2373				    ;HERE TO FINISH UP.  (ENTER WITH P2/NO. OF PAGES NOT DONE.).
  2374	002510'	262040	000006	SWEPDN:	POP	P,T1		;T1/ NO. PAGES REQUESTED TO DO.
  2375	002511'	274300	000015		SUB	T1,P2		;SUBTRACT NUMBER NOT DONE.
  2376	002512'	270300	000013		ADD	T1,M		;ADD NO. DONE TO FIRST-1
  2377	002513'	275300	000001		SUBI	T1,1		;TO GET NEW HPW.
  2378	002514'	242300	000002		LSH	T1,2		;CONVERT TO HBW.
  2379	002515'	550344	002227*		HRRZ	T2,DEVATB(F)	;SET
  2380	002516'	137300	002232*		DPB	T1,ATYBSZ	; THE
  2381	002517'	400300	000000		SETZ	T1,		; ATBSIZ
  2382	002520'	137300	000000*		DPB	T1,ATYWSZ	; FIELDS.
  2383	002521'	554300	000014		HLRZ	T1,P1		;DITTO T1.  (MAY BE ERROR FLAG.).
  2384	002522'	306300	000011		CAIN	T1,FALRBE	;WAS THERE A RIB
  2385	002523'	606600	000004		TRNN	P1,FLG.ER	; ERROR?
  2386	002524'	254000	002526'		 JRST	SWEPD4		;NO.
  2387	002525'	260040	003175'		PUSHJ	P,KILFIL	;YES, KILL THE FILE.
  2388	002526'	200440	000015	SWEPD4:	MOVE	T4,P2		;SET T4 UP FOR CALLER.
  2389	002527'	262040	000016		POP	P,P3		;
  2390	002530'	262040	000015		POP	P,P2		;
  2391	002531'	606600	000004		TRNN	P1,FLG.ER	;
  2392	002532'	350001	777777		 AOS	-1(P)		;
  2393	002533'	262040	000014		POP	P,P1		;
  2394	002534'	263040	000000		POPJ	P,		;
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 33
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  2395				COMMENT #
  2396				@@SUBROUTINE UPDDDB
  2397				@@PURPOSE
  2398				SUBR TO UPDATE DDBS OTHER THAN OUR OWN, FROM THE NEW POINTERS
  2399				ADDED TO THE EOF IN OUR DDB.
  2400				@@ENTRY
  2401				EXPECTS F/ DDB, M/ LOGICAL NO. IN FILE OF 1ST NEW PAGE, P3/ OUR
  2402				DEVRET TO PAGE M, AND P2/ NO. OF NEW PAGES.
  2403				@@ACCUM
  2404				DESTROYS T1-T4 AND P3.
  2405				@@ #
  2406
  2407	002535'	515716	000000	UPDDDB:	HRLZI	P3,(P3)		;P3 WILL BE BLT AC.
  2408	002536'	400300	000000		SETZ	T1,		;GET A DDB OF
  2409	002537'	260040	002617'	UPDDLP:	PUSHJ	P,FNDDDB	;INTEREST.
  2410	002540'	263040	000000		  POPJ	P,		;NONE LEFT.
  2411				    ;SEE IF ANY OF OUR NEW PNTRS BELONG ALSO IN THIS DDB.
  2412	002541'	260040	002566'		PUSHJ	P,FINDM		;IS M IN THIS DDB?
  2413	002542'	254000	002537'		  JRST	UPDDLP		;NO.
  2414	002543'	326340	002537'		JUMPN	T2,UPDDLP	;NOR IF IN SPARE RIB PNTR.
  2415				    ;COPY SOME OF OUR NEW PNTRS TO THIS DDB.
  2416	002544'	201446	002451*		MOVEI	T4,DEVRBN(T1)	;T3/ ADDR OF PAGE M RET PNTR.
  2417	002545'	275450	777777		SUBI	T4,-1(T3)	;GET T4/ ROOM LEFT IN THIS DDB.
  2418	002546'	313440	000015		CAMLE	T4,P2		;CALC T4/ MAX NO.
  2419	002547'	201455	000000		MOVEI	T4,(P2)		;OF PNTRS TO TRANSFER.
  2420	002550'	271450	777777		ADDI	T4,-1(T3)	;T4/ BLT DESTINATION AC.
  2421	002551'	500400	000016		HLL	T3,P3		;T3/ BLT AC.
  2422	002552'	251411	000000		BLT	T3,(T4)		;COPY SOME PNTRS.
  2423	002553'	254000	002537'		JRST	UPDDLP		;
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 34
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  2424				COMMENT #
  2425				@@SUBROUTINE ONESLT
  2426				@@PURPOSE
  2427				SUBR TO UPDATE OTHER DDBS WHEN WE HAVE FILLED OR MADE A HOLE
  2428				<= HPW.
  2429				@@ENTRY
  2430				EXPECTS T2/ NEW RETRIEVAL PNTR, M/ PAGE NUMBER OF INTEREST,
  2431				AND F/ DDB.
  2432				EXPECTS RIB WRITE LOCKED IN %RIB.
  2433				@@ACCUM
  2434				DESTROYS T1, T3, AND T4.  DOES NOT DESTROY T2.
  2435				@@ #
  2436
  2437
  2438	002554'	261040	000014	ONESLT:	PUSH	P,P1		;SAVE P1.
  2439	002555'	200600	000007		MOVE	P1,T2		;P1 CARRIES NEW RETRIEVAL PNTR.
  2440	002556'	400300	000000		SETZ	T1,		;T1 CARRIES DDB BEING UPDATED.
  2441	002557'	260040	002617'	ONESL2:	PUSHJ	P,FNDDDB	;GET ANOTHER DDB TO T1.
  2442					  JRST	[MOVE T2,P1	;NONE LEFT.  RESTORE T2 FOR
  2443						POP P,P1	;CALLER. RESTORE P1.
  2444	002560'	254000	004177'			POPJ P,]	;RETURN.
  2445	002561'	260040	002566'		PUSHJ	P,FINDM		;IS OUR SLOT IN THIS DDB?
  2446	002562'	254000	002557'		  JRST	ONESL2		;NO, GO TO NEXT.
  2447	002563'	326340	002557'		JUMPN	T2,ONESL2	;NOT IF ONLY SPARE, EITHER.
  2448	002564'	202610	000000		MOVEM	P1,(T3)		;FOUND ONE.
  2449	002565'	254000	002557'		JRST	ONESL2		;GO TO NEXT.
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 35
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  2450				COMMENT #
  2451				@@SUBROUTINE FINDM
  2452				@@PURPOSE
  2453				SUBR TO FIND OUT IF PAGE M IS IN THE DDB WHOSE ADDR IS IN T1,
  2454				AND, IF SO, TO RETURN SOME INFO ABOUT WHERE IT IS.  (DOES NOT
  2455				CHECK ANYTHING ABOUT THE LEGALITY OF M'S RETRIEVAL PNTR.).
  2456				@@ENTRY
  2457				EXPECTS M/ NO. OF FILE PAGE OF INTEREST,  T1/ DDB ADDR, AND
  2458				T3/ DEVFLO(T1).  EXPECTS THE DDB TO BE VALID.
  2459				@@ACCUM
  2460				DESTROYS T2 THRU T4. MUST NOT DESTROY T1.
  2461				@@EXIT
  2462				NON-SKIP RETURNS IF M IS NOT IN THE DDB.  ELSE, SKIP RETURNS
  2463				WITH EITHER (A) T2/ 0 AND T3/ ADDR OF REAL RET PNTR, OR (B)
  2464				T2/ DEVSZS(T1) AND T3/ ADDR OF SPARE RIB PNTR.
  2465				@@ #
  2466
  2467	002566'	271400	000003	FINDM::	ADDI	T3,3		;CONVERT DEVFLO
  2468	002567'	242400	777776		LSH	T3,B2PLSH	;TO PAGES.
  2469	002570'	315540	000010		CAMGE	M,T3		;M BELOW 1ST PAGE IN THIS DDB?
  2470	002571'	263040	000000		 POPJ	P,		;YES.
  2471	002572'	201440	000606*		MOVEI	T4,PTRLEN	;NO.  T3 HAS DEVFLO.  LOOK
  2472	002573'	201346	777777*		MOVEI	T2,DEVRB1-1(T1)	;FIRST AT THE LEADING SPARE
  2473	002574'	271340	000001	FINDM1:	ADDI	T2,1		;
  2474	002575'	331007	000000		SKIPL	(T2)		;RIB PNTRS, IF ANY.
  2475	002576'	254000	002607'		 JRST	FINDM4		;FOUND FIRST NON-SPARE PNTR.
  2476	002577'	270406	000000*		ADD	T3,DEVSZS(T1)	;INC T3 BY ONE SPARE RIB SIZE.
  2477	002600'	311540	000010		CAML	M,T3		;M DOWN WITHIN THIS SPARE RIB?
  2478	002601'	254000	002605'		 JRST	FINDM2		;NO, GO TO NEXT.
  2479	002602'	201407	000000		MOVEI	T3,(T2)		;YES, RETURN T2/ DEVSZS(T1) AND
  2480	002603'	200346	002577*		MOVE	T2,DEVSZS(T1)	;T3/ ADDR OF SPARE RIB PNTR.
  2481	002604'	254000	002177*		JRST	CPOPJ1		;SUCCESS RETURN.
  2482
  2483	002605'	367440	002574'	FINDM2:	SOJG	T4,FINDM1	;CONTINUE LOOKING AT PNTRS?
  2484	002606'	256000	000000'		 STOPCD                         ;;FINDM2+1
  2485	002607'	271411	777777	FINDM4:	ADDI	T3,-1(T4)	;HERE ON 1ST NON-SPARE RIB PNTR.
  2486	002610'	313540	000010		CAMLE	M,T3		;M WITHIN THIS DDB?
  2487	002611'	263040	000000		 POPJ	P,		;NO.
  2488	002612'	400340	000000		SETZ	T2,		;YES, RETURN T2/ 0 AND
  2489	002613'	274400	000013		SUB	T3,M		;T3/ ADDR OF RET PNTR FOR
  2490	002614'	213000	000010		MOVNS	T3		;PAGE
  2491	002615'	271406	002544*		ADDI	T3,DEVRBN(T1)	;M.
  2492	002616'	254000	002604*		JRST	CPOPJ1		;SUCCESS RETURN.
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 36
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  2493				COMMENT #
  2494				@@SUBROUTINE FNDDDB
  2495				@@PURPOSE
  2496				SUBR TO GET THE NEXT VALID DDB ON THIS FNB WITH OUR DEVRIB.
  2497				(DOES NOT RETURN OUR DDB.).
  2498				@@ENTRY
  2499				EXPECTS F/ DDB AND T1/ ADDR OF PREVIOUS DDB (0 IF NO PREVIOUS).
  2500				@@ACCUM
  2501				DESTROYS T1, T2, AND T3.  MUST NOT DESTROY T4.
  2502				@@EXIT
  2503				ON SUCCESS, SKIP RETURNS WITH T1/ ADDR OF REQUESTED DDB AND
  2504				T3/ THAT DDB'S DEVFLO.  ON NO NEXT DDB, NON-SKIP RETURNS.
  2505				@@ #
  2506
  2507	002617'	200344	002327*	FNDDDB::MOVE	T2,DEVRIB(F)	;(FOR COMPARE BELOW.).
  2508	002620'	326300	002633'		JUMPN	T1,FNDDD4	;WANT FIRST DDB?
  2509	002621'	550304	002515*		HRRZ	T1,DEVATB(F)	;YES.
  2510	002622'	326300	002624'		JUMPN	T1,.+2		;
  2511	002623'	256000	000000'		 STOPCD                         ;;FNDDDB+4
  2512	002624'	550306	000000*		HRRZ	T1,ATBFNB(T1)	;
  2513	002625'	550306	000000*		HRRZ	T1,FNBDBL(T1)	;T1/ FIRST DDB ON THIS FNB.
  2514	002626'	333406	002166*	FNDDD2:	SKIPLE	T3,DEVFLO(T1)	;VALID?
  2515	002627'	312346	002617*		CAME	T2,DEVRIB(T1)	;YES.  HAS OUR DEVRIB?
  2516	002630'	254000	002633'		 JRST	FNDDD4		;NOT INTERESTING DDB.
  2517	002631'	302304	000000		CAIE	T1,(F)		;DON'T WANT OUR PRIME DDB.
  2518	002632'	254000	002616*		 JRST	CPOPJ1		;FOUND ONE.
  2519	002633'	550306	000000*	FNDDD4:	HRRZ	T1,DEVDBL(T1)	;TRY NEXT DDB.
  2520	002634'	326300	002626'		JUMPN	T1,FNDDD2	;
  2521	002635'	263040	000000		POPJ	P,
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 37
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  2522				COMMENT #
  2523				@@SUBROUTINE FNDADB
  2524				@@PURPOSE
  2525				SUBR TO GET THE NEXT VALID DDB ON THIS FNB WITH OUR ATB.
  2526				(DOES NOT RETURN OUR DDB.).
  2527				@@ENTRY
  2528				EXPECTS F/ DDB AND T1/ ADDR OF PREVIOUS DDB (0 IF NO PREVIOUS).
  2529				@@ACCUM
  2530				DESTROYS T1, T2, AND T3.  MUST NOT DESTROY T4.
  2531				@@EXIT
  2532				ON SUCCESS, SKIP RETURNS WITH T1/ ADDR OF REQUESTED DDB AND
  2533				T3/ THAT DDB'S DEVFLO.  ON NO NEXT DDB, NON-SKIP RETURNS.
  2534				@@ #
  2535
  2536	002636'	550344	002621*	FNDADB::HRRZ	T2,DEVATB(F)	;(FOR COMPARE BELOW.).
  2537	002637'	326300	002654'		JUMPN	T1,FNDAD4	;WANT FIRST DDB?
  2538	002640'	550304	002636*		HRRZ	T1,DEVATB(F)	;YES.
  2539	002641'	326300	002643'		JUMPN	T1,.+2		;
  2540	002642'	256000	000000'		 STOPCD                         ;;FNDADB+4
  2541	002643'	550306	002624*		HRRZ	T1,ATBFNB(T1)	;
  2542	002644'	550306	002625*		HRRZ	T1,FNBDBL(T1)	;T1/ FIRST DDB ON THIS FNB.
  2543	002645'	306304	000000	FNDAD2:	CAIN	T1,(F)		;DON'T WANT OUR PRIME DDB.
  2544	002646'	254000	002654'		 JRST	FNDAD4		;NOT INTERESTING DDB.
  2545	002647'	550406	002640*		HRRZ	T3,DEVATB(T1)	;HAS OUR ATB?
  2546	002650'	302407	000000		CAIE	T3,(T2)		;
  2547	002651'	254000	002654'		 JRST	FNDAD4		;
  2548	002652'	333406	002626*		SKIPLE	T3,DEVFLO(T1)	;
  2549	002653'	254000	002632*		 JRST	CPOPJ1		;FOUND ONE.
  2550	002654'	550306	002633*	FNDAD4:	HRRZ	T1,DEVDBL(T1)	;TRY NEXT DDB.
  2551	002655'	326300	002645'		JUMPN	T1,FNDAD2	;
  2552	002656'	263040	000000		POPJ	P,
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 38
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  2553				COMMENT #
  2554				@@SUBROUTINE FLUSH
  2555				@@PURPOSE
  2556				SUBR TO WRITE OUT ANY DDB PNTR AREAS THAT NEED WRITING OUT
  2557				FOR THE RIB THAT WE PRESENTLY HAVE IN %RIB.  ASSUMES DEVRIB(F)
  2558				IS THE ADDRESS OF THIS RIB.  OPTIONALLY INVALIDATES ALL THE
  2559				DDBS FOR THIS RIB.  DOES NOT FLUSH OR TOUCH OUR OWN DDB.
  2560				@@ENTRY
  2561				EXPECTS F/ OUR DDB AND DEVRIB(F) TO BE THE RIB IN %RIB.
  2562				INVALIDATES ALL THE DDBS FOR THIS RIB IFF T1/-1; ELSE T1 MUST
  2563				BE 0.
  2564				@@ACCUM
  2565				DESTROYS T1-T4.
  2566				@@ #
  2567
  2568	002657'	337440	000006	FLUSH::	SKIPG	T4,T1		;CHECK THAT T1 IS -1 OR 0 AND
  2569	002660'	345300	002662'		AOJGE	T1,.+2		;GET IT INTO SEMI-SAFE T4.
  2570	002661'	256000	000000'		 STOPCD                         ;;FLUSH+2
  2571	002662'	400300	000000		SETZ	T1,		;GET T1/ ADDR OF NEXT
  2572	002663'	260040	002617'	FLUSH2:	PUSHJ	P,FNDDDB	;INTERESTING DDB.
  2573	002664'	263040	000000		  POPJ	P,		;NONE LEFT.
  2574	002665'	250200	000006		EXCH	F,T1		;WRITE THE DDB PNTRS INTO
  2575	002666'	260040	002403*		PUSHJ	P,PTROU0	;%RIB, IFF PTRCHG IS ON (TURN
  2576	002667'	250200	000006		EXCH	F,T1		;PTRCHG OFF.).
  2577	002670'	436446	002652*		IORM	T4,DEVFLO(T1)	;POSSIBLY INVALIDATE THIS DDB.
  2578	002671'	254000	002663'		JRST	FLUSH2		;GO TO NEXT DDB.
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 39
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  2579				COMMENT #
  2580				@@SUBROUTINE FLUSHA
  2581				@@PURPOSE
  2582				SUBR TO WRITE OUT ALL DDB PNTR AREAS THAT NEED WRITING OUT
  2583				FOR THIS VERSION OF A FILE.  INVALIDATES ALL THE DDBS FOR
  2584				THIS RIB.  OUR OWN DDB DOES NOT NEED TO BE FLUSHED, SO IT IS
  2585				JUST MARKED INVALID.
  2586				@@ENTRY
  2587				EXPECTS F/ OUR DDB.
  2588				@@ACCUM
  2589				DESTROYS T1-T4, U, AND PG.
  2590				@@EXIT
  2591				SKIP RETURNS ON SUCCESS.
  2592				NON-SKIP RETURNS ON BAD RIB.
  2593				@@ #
  2594
  2595	002672'	476004	002670*	FLUSHA::SETOM	DEVFLO(F)	;INVALIDATE US.
  2596	002673'	261040	000014		PUSH	P,P1		;SAVE P1.
  2597	002674'	261040	000004		PUSH	P,F		;SAVE F.
  2598
  2599				    ;FIND THE NEXT VALID DDB FOR THIS FILE, WITH PTRCHG ON.
  2600	002675'	550604	002647*		HRRZ	P1,DEVATB(F)	;GET P1/ OUR
  2601	002676'	326600	002700'		JUMPN	P1,.+2		;ATB.
  2602	002677'	256000	000000'		 STOPCD                         ;;FLUSHA+5
  2603	002700'	550214	002643*		HRRZ	F,ATBFNB(P1)	;
  2604	002701'	550204	002644*		HRRZ	F,FNBDBL(F)	;
  2605	002702'	337004	002672*	FLSHA2:	SKIPG	DEVFLO(F)	;VALID?
  2606	002703'	254000	002713'		 JRST	FLSHA4		;NO, DON'T BOTHER WITH IT.
  2607	002704'	550304	002675*		HRRZ	T1,DEVATB(F)	;YES, ON OUR
  2608	002705'	302314	000000		CAIE	T1,(P1)		;VERSION OF THE FILE?
  2609	002706'	254000	002713'		 JRST	FLSHA4		;NO, IGNORE IT.
  2610	002707'	510304	000007		HLLZ	T1,DEVIAD(F)	;YES, NEED TO
  2611	002710'	603300	002470*		TLNE	T1,PTRCHG	;WRITE IT OUT?
  2612	002711'	254000	002720'		 JRST	FLSHA5		;YES.
  2613	002712'	476004	002702*	FLSHA3:	SETOM	DEVFLO(F)	;NO.  JUST INVALIDATE.
  2614	002713'	550204	002654*	FLSHA4:	HRRZ	F,DEVDBL(F)	;GET THE NEXT DDB
  2615	002714'	326200	002702'		JUMPN	F,FLSHA2	;ON THE FILE.
  2616	002715'	262040	000004		POP	P,F		;
  2617	002716'	262040	000014		POP	P,P1		;
  2618	002717'	254000	002653*		JRST	CPOPJ1		;
  2619
  2620				    ;HERE WITH A DDB THAT NEEDS WRITING.  WRITE IT AND ANY
  2621				    ;OTHER DDBS FOR THE SAME RIB.
  2622	002720'	200304	002627*	FLSHA5:	MOVE	T1,DEVRIB(F)	;
  2623	002721'	260040	003150'		PUSHJ	P,MWLRIB	;
  2624					  JRST	[POP P,F	;ERROR IN RIB.
  2625						POP P,P1	;
  2626	002722'	254000	004202'			POPJ P,]	;
  2627	002723'	260040	002666*		PUSHJ	P,PTROU0	;FLUSH THIS DDB.
  2628	002724'	474300	000000		SETO	T1,		;THEN DO ANY
  2629	002725'	260040	002657'		PUSHJ	P,FLUSH		;OTHER DDBS FOR THIS RIB.
  2630	002726'	260040	002256*		PUSHJ	P,RELRIB	;RELEASE THE RIB.
  2631	002727'	254000	002712'		JRST	FLSHA3		;GO TO NEXT DDB.
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 40
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  2632				COMMENT #
  2633				@@SUBROUTINE CREPAG
  2634				@@PURPOSE
  2635				SUBR TO ALLOCATE A DISK PAGE AND ZERO IT.
  2636				@@ENTRY
  2637				EXPECTS T2/ RETRIEVAL PNTR WITH WHICH TO TRY TO BE CONTIGUOUS,
  2638				F/ DDB, AND S/ DEVIOS.  T2 MAY BE A HOLE, REAL, OR 0.
  2639				CHECKS FOR CONTROL C WAITING UNLESS P1 HAS FLG.CC ON.
  2640				@@ACCUM
  2641				DESTROYS T1-T4 AND PG.
  2642				@@EXIT
  2643				ON SUCCESS, SKIP RETURNS WITH T2/ THE RETRIEVAL PNTR OBTAINED.
  2644				NON-SKIP RETURNS IF CNTRL C WAITING OR ON ALLOCATION ERROR.
  2645				NON SKIP RETURN TURNS ON FLG.ER IN THE RH OF P1 AND STORES
  2646				THE ERROR CODE IN LH OF P1.  (ERROR CODES ARE FALCTL (CONTROL
  2647				C WAITING) AND FALAQA(CAN'T ALLOCATE DISK PAGE).
  2648				@@ #
  2649
  2650
  2651	002730'	602600	000010	CREPAG:	TRNE	P1,FLG.CC	;USER WANTS CNTRL C CHECK?
  2652	002731'	254000	002736'		 JRST	CREPG1		;NO.
  2653	002732'	200300	002044*		MOVE	T1,JOB		;FIRST CHECK
  2654	002733'	200306	000000*		MOVE	T1,JBTSTS(T1)	;FOR CONTROL
  2655	002734'	603300	000400		TLNE	T1,CNTRLC	;C WAITING.
  2656					 JRST	[HRLI P1,FALCTL	;YES, WAITING.
  2657	002735'	254000	004205'			JRST CREFL4]	;
  2658
  2659	002736'	261040	000015	CREPG1:	PUSH	P,P2		;COUNT OF TIMES TO TRY
  2660	002737'	201640	000012		MOVEI	P2,^D10		;DESPITE BAD DISK PAGES.
  2661	002740'	261040	000007		PUSH	P,T2		;SAVE OLD RET PNTR.
  2662	002741'	260040	001356*	CREPG2:	PUSHJ	P,CHKQTA	;OKAY TO ALLOC A DISK PAGE?
  2663	002742'	254000	003003'		  JRST	CREFAL		;NO.
  2664	002743'	262040	000007		POP	P,T2		;YES, RESTORE OLD RET PNTR.
  2665	002744'	260040	000000*		PUSHJ	P,ISCYLB##	;If cyl boundry, skip (to change units)
  2666	002745'	607340	001676*		 TLNN	T2,RBREAL	;A REAL PAGE?
  2667	002746'	400340	000000		  SETZ	T2,		;NO, TAKE CARE OF HOLES.
  2668	002747'	621340	000000*		TLZ	T2,RBMASK-RBREAL
  2669	002750'	201300	000000*		MOVEI	T1,FBIT		;SET ARG IN T1 FOR KEPPAG.
  2670	002751'	550404	002704*		HRRZ	T3,DEVATB(F)	;T3/ ATB ADDR OR ZERO.
  2671	002752'	260040	000000*		PUSHJ	P,KEPPAG	;TRY TO GET A PAGE AND ITS SAT.
  2672					  JRST	[TRO S,IOBKTL	;ERROR RETURN, DON'T HAVE SAT.
  2673						MOVEM S,DEVIOS(F)	;
  2674	002753'	254000	004207'			JRST CREFL1]	;
  2675	002754'	261040	000007		PUSH	P,T2		;SAVE GOTTEN RETRIEVAL PNTR.
  2676	002755'	400300	000000		SETZ	T1,		;Do the entire page
  2677	002756'	201400	000777		MOVEI	T3,777		; "        "
  2678	002757'	260040	003010'		PUSHJ	P,CLRCOW	;CLEAR A PAGE.
  2679	002760'	334000	000000		  SKIPA			;FAIL.
  2680	002761'	254000	002776'		 JRST	CREPDN		;SUCCESS.
  2681	002762'	551306	000000		HRRZI	T1,(T1)		;ANYTHING BUT IN OR OUT
  2682	002763'	302300	000027		CAIE	T1,FALIPE	; I/O ERROR
  2683	002764'	306300	000020		CAIN	T1,FALOPE	; IS
  2684	002765'	334000	000000		 SKIPA			; A BUG.
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 40-2
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  2685	002766'	256000	000000'		  STOPCD		;;CREPG2+25
  2686	002767'	474300	000000		SETO	T1,		;ADJUST THE USER'S
  2687	002770'	201400	000001		MOVEI	T3,1		;COUNTS TO REFLECT THAT HE
  2688	002771'	550344	002751*		HRRZ	T2,DEVATB(F)	;DOESN'T OWN THIS PAGE
  2689	002772'	260040	000000*		PUSHJ	P,UPDAC2	;ANYMORE.  LEAVE DSK CNTS ALONE.
  2690	002773'	402001	000000		SETZM	(P)		;ZERO PNTR FOR NEXT CONTIG TRY.
  2691	002774'	367640	002741'		SOJG	P2,CREPG2	;TRY AGAIN.
  2692	002775'	254000	003003'		JRST	CREFAL		;
  2693
  2694	002776'	201300	000004	CREPDN:	MOVEI	T1,4		;CHARGE FOR THE
  2695	002777'	260040	003102'		PUSHJ	P,WRTCHG	;FOUR BLOCKS WRITTEN.
  2696	003000'	262040	000007		POP	P,T2		;RETURN T2/ RETRIEVAL PNTR.
  2697	003001'	262040	000015		POP	P,P2		;
  2698	003002'	254000	002717*		JRST	CPOPJ1		;
  2699
  2700
  2701				    ;SOME ERROR EXITS.
  2702	003003'	262040	000007	CREFAL:	POP	P,T2
  2703	003004'	262040	000015	CREFL1:	POP	P,P2		;
  2704	003005'	505600	000025		HRLI	P1,FALAQA 	;
  2705	003006'	660600	000004	CREFL4:	TRO	P1,FLG.ER
  2706	003007'	263040	000000		POPJ	P,
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 41
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  2707				COMMENT #
  2708				@@SUBROUTINE CLRCOW
  2709				@@PURPOSE
  2710				SUBR TO MAP A DISK PAGE INTO %COW, CLEAR PART OF IT, AND THEN
  2711				REMOVE IT.
  2712				@@ENTRY
  2713				EXPECTS T1/ REL NO. OF 1ST WORD TO CLEAR, T3/ REL NO. OF LAST
  2714				WORD TO CLEAR, T2/ RET PNTR, F/ DDB, AND S/ DEVIOS.
  2715				@@ACCUM
  2716				DESTROYS T1-T4 AND PG.
  2717				@@EXIT
  2718				SKIP RETURNS IF ALL SUCCESSFUL, ELSE NON-SKIP RETURNS WITH
  2719				RH OF T1 THE ERROR CODE AS FOLLOWS: FALBDS, FALIPE, OR FALOPE.
  2720				@@ #
  2721
  2722
  2723	003010'	265440	000000*	CLRCOW::JSP	T4,SAVE4##	;SAVE P3 AND P4 (P1&P2 go along for the ride)
  2724	003011'	261040	000006		PUSH	P,T1		;SAVE START OF CLEARING.
  2725	003012'	261040	000010		PUSH	P,T3		;SAVE LAST TO CLEAR.
  2726	003013'	301300	000000		CAIL	T1,0		;Range check T1 and T3
  2727	003014'	303300	000777		CAILE	T1,777
  2728	003015'	256000	000000'		 STOPCD				;;CLRCOW+5
  2729	003016'	301400	000000		CAIL	T3,0
  2730	003017'	303400	000777		CAILE	T3,777
  2731	003020'	256000	000000'		 STOPCD				;;CLRCOW+10
  2732	003021'	313300	000010		CAMLE	T1,T3		;T1=first, T3=last word to clear
  2733	003022'	256000	000000'		 STOPCD				;;CLRCOW+12
  2734	003023'	205700	000000*		MOVSI	P3,LMMRDW!LMPVIR;Set virgin bit if clearing entire page
  2735	003024'	306300	000000		CAIN	T1,0		;If not start of page
  2736	003025'	302400	000777		CAIE	T3,777		; and not end of page
  2737	003026'	621700	000250*		 TLZ	P3,LMPVIR	;Then must read from disk first
  2738	003027'	550304	002771*		HRRZ	T1,DEVATB(F)	;SET UP
  2739	003030'	261040	000012		PUSH	P,W		;SAVE W.
  2740	003031'	201500	000440*		MOVEI	W,%COW.N+CNVVPN	;FOR MAPKRN.
  2741	003032'	260040	003417'		PUSHJ	P,MAPKRN	;MAP THE PAGE INTO %COW (use bits in P3)
  2742					  JRST	[POP P,W	;RESTORE W.
  2743						PUSHJ P,RELSAT	;WE DON'T WANT THE SAT.
  2744						POP P,T3	;CLEAR JUNK
  2745						POP P,T1	; FROM PDL.
  2746						MOVEI T1,FALBDS	;SAY SAW A
  2747	003033'	254000	004212'			POPJ P,]	; BAD SAT.
  2748	003034'	260040	000525*		PUSHJ	P,SETLMA	;STORE BACK INTO THE SLOT.
  2749	003035'	262040	000012		POP	P,W		;RESTORE W.
  2750	003036'	260040	002257*		PUSHJ	P,RELSAT	;DON'T WANT THE SAT.
  2751	003037'	200300	004220'		MOVE	T1,[PE.NER+1,,%COW.N+CNVVPN] ;SET IGNORE
  2752	003040'	047300	777706		PERSET	T1,		;ERROR BIT.
  2753	003041'	256000	000000'		 STOPCD                         ;;CLRCOW+many
  2754	003042'	414300	000000*		SWAPIN	T1,%COW		;Reference %COW, get a page fault
  2755	003043'	201300	000440*		MOVEI	T1,%COW.N+CNVVPN
  2756	003044'	047300	777707		PAGSTS	T1,		;GET PAGE STATUS
  2757	003045'	256000	000000'		 STOPCD                         ;;CLRCOW + many
  2758	003046'	607300	000000*		TLNN	T1,PS.DER!PS.DTE ;DEVICE OR DATA ERROR?
  2759	003047'	254000	003062'		 JRST	CLRCW4		;NO.
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 41-2
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  2760	003050'	262040	000010		POP	P,T3		;YES, CLEAR FROM
  2761	003051'	262040	000006		POP	P,T1		;PDL.
  2762	003052'	322300	003054'		JUMPE	T1,.+2		;IF WE WERE CLEARING THE WHOLE
  2763	003053'	634300	000006		 TDZA	T1,T1		; PAGE, FORGET ABOUT LOGGING
  2764	003054'	515300	004000		HRLZI	T1,004000	; ERRORS.
  2765	003055'	434300	004163'		IOR	T1,[XWD 1,%COW.N+CNVVPN] ;REMOVE
  2766	003056'	047300	777713		VREMOV	T1,		;THE COW PAGE, NOT SUPPOSED TO FAIL
  2767	003057'	256000	000000'		 STOPCD				;;CLRCFL-1
  2768	003060'	551300	000027	CLRCFL:	HRRZI	T1,FALIPE	;
  2769	003061'	263040	000000		POPJ	P,
  2770
  2771	003062'	262040	000010	CLRCW4:	POP	P,T3		;RESTORE REL LAST TO CLEAR.
  2772	003063'	200301	000000		MOVE	T1,(P)		;GET 1ST TO CLEAR.
  2773	003064'	402006	003042*		SETZM	%COW(T1)	;CLEAR 1ST.
  2774	003065'	306300	000777		CAIN	T1,777		;DON'T BLT IF ONLY
  2775	003066'	254000	003072'		 JRST	CLRCW6		;ONE WORD TO CLEAR.
  2776	003067'	271300	000001*		ADDI	T1,%COW+1	;MAKE A BLT
  2777	003070'	505306	777777		HRLI	T1,-1(T1)	;AC.
  2778	003071'	251310	003064*		BLT	T1,%COW(T3)	;CLEAR.
  2779	003072'	262040	000006	CLRCW6:	POP	P,T1		;IF WE WANTED A WHOLE 0 PAGE,
  2780	003073'	322300	003075'		JUMPE	T1,.+2		;DON'T LOG ERRORS IN THE BATS
  2781	003074'	634300	000006		 TDZA	T1,T1		;SINCE WE STILL HAVE THE RIB AND
  2782	003075'	515300	004000		HRLZI	T1,004000	;NO ONE WILL GET THIS PAGE AGAIN.
  2783	003076'	434300	004163'		IOR	T1,[XWD  1,%COW.N+CNVVPN] ;REMOVE THE PAGE.
  2784	003077'	047300	777713		VREMOV	T1,		;(REALLY OUGHT TO DETECT IO ERRORS)
  2785	003100'	256000	000000'		 STOPCD				;;CLRCW6+6
  2786	003101'	254000	003002*		JRST	CPOPJ1		;SUCCESS.
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 42
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  2787				COMMENT #
  2788				@@SUBROUTINE WRTCHG
  2789				@@PURPOSE
  2790				SUBR TO CHARGE FOR WRITING BLOCKS.
  2791				@@ENTRY
  2792				EXPECTS T1/ NO. OF BLOCKS TO CHARGE FOR.
  2793				@@ACCUM
  2794				DESTROYS T1 AND T2.
  2795				@@ #
  2796
  2797				INTERN WRTCHG
  2798
  2799	003102'	261040	000002	WRTCHG:	PUSH	P,J		;
  2800	003103'	135100	000320*		LDB	J,PJOBN		;
  2801	003104'	272302	000000*		ADDM	T1,JBTWCT(J)	;INCREMENT COUNT OF
  2802	003105'	272300	003104*		ADDM	T1,JBTWCT	;BLOCKS WRITTEN.
  2803	003106'	261040	000006		PUSH	P,T1		;
  2804	003107'	260040	000000*		PUSHJ	P,GTCGSZ	;GET T1/ CHARGING SIZE OF JOB IN K.
  2805	003110'	262040	000007		POP	P,T2		;
  2806	003111'	220340	000006		IMUL	T2,T1		;INCREMENT NO. OF
  2807	003112'	272342	000000*		ADDM	T2,JBTSOT(J)	;BLOCKS TIMES
  2808	003113'	272340	003112*		ADDM	T2,JBTSOT	;SIZE IN K.
  2809	003114'	262040	000002		POP	P,J		;
  2810	003115'	263040	000000		POPJ	P,
  2811
  2812
  2813
  2814
  2815				COMMENT #
  2816				@@SUBROUTINE WRTCHP
  2817				@@PURPOSE
  2818				SUBR TO CHARGE FOR WRITING ONE PAGE.
  2819				@@ENTRY
  2820				EXPECTS J/ JOB NUMBER.
  2821				@@ACCUM
  2822				DESTROYS T1.
  2823				@@ #
  2824
  2825				INTERN WRTCHP
  2826
  2827	003116'	201300	000004	WRTCHP:	MOVEI	T1,4		;
  2828	003117'	272302	003105*		ADDM	T1,JBTWCT(J)	;INCREMENT COUNT OF
  2829	003120'	272300	003117*		ADDM	T1,JBTWCT	;BLOCKS WRITTEN.
  2830	003121'	260040	003107*		PUSHJ	P,GTCGSZ	;GET CHARGING SIZE IN
  2831	003122'	242300	000002		LSH	T1,2		;K TIMES 4 BLOCKS.
  2832	003123'	272302	003113*		ADDM	T1,JBTSOT(J)	;
  2833	003124'	272300	003123*		ADDM	T1,JBTSOT	;
  2834	003125'	263040	000000		POPJ	P,
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 43
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  2835				COMMENT #
  2836				@@SUBROUTINE GETRET
  2837				@@PURPOSE
  2838				SUBR TO GET A PLACE FOR THE NEXT RETRIEVAL PNTR.
  2839				@@ENTRY
  2840				EXPECTS DEVRET(F) TO POINT TO THE PREVIOUS RETRIEVAL PNTR,
  2841				(POSSIBLY "IN" DEVRB1-1).
  2842				@@ACCUM
  2843				DESTROYS T1, T4, AND PG.  MUST NOT DESTROY T2 OR T3.
  2844				@@EXIT
  2845				NON-SKIP RETURNS ON RIB ERROR OR ALLOCATION (OF RIB) ERROR,
  2846				WITH FLAG SET IN T1 ACCORDINGLY (FALRBE OR FALAQA).  DOES NOT
  2847				OUTPUT THE EXCEEDING QUOTA MSG.  SUCCESS RETURN IS A SKIP
  2848				RETURN WITH DEVRET(F) POINTING TO THE NEW PLACE.
  2849				@@ #
  2850
  2851
  2852	003126'	350304	002505*	GETRET:	AOS	T1,DEVRET(F)	;ROOM LEFT IN THE
  2853	003127'	307304	002615*		CAIG	T1,DEVRBN(F)	;CURRENT DDB?
  2854	003130'	254000	003101*		JRST	CPOPJ1		;YES.  SUCCESS RETURN.
  2855	003131'	261040	000007		PUSH	P,T2		;NO.  SAVE T2 AND
  2856	003132'	261040	000010		PUSH	P,T3		;T3 FOR CALLERS.
  2857	003133'	261040	000005		PUSH	P,U		;SAVE U.
  2858	003134'	200304	002720*		MOVE	T1,DEVRIB(F)	;MAKE SURE WE HAVE THE
  2859	003135'	260040	003150'		PUSHJ	P,MWLRIB	;CORRECT RIB.
  2860					JRST	[POP P,U	;RIB ERROR.
  2861						POP P,T3	;
  2862						POP P,T2	;
  2863						MOVEI T1,FALRBE	;
  2864	003136'	254000	004221'			POPJ P,]	;
  2865	003137'	262040	000005		POP	P,U		;RESTORE U.
  2866	003140'	200304	000007		MOVE	T1,DEVIAD(F)	;SEE IF WE HAVE TO
  2867	003141'	603300	002710*		TLNE	T1,PTRCHG	;OUTPUT THE CURRENT PNTRS.
  2868	003142'	260040	000000*		PUSHJ	P,PTROU2	;OUTPUT THE PNTRS.
  2869	003143'	260040	000000*		PUSHJ	P,NXTPT0	;TRY TO GET MORE PNTRS.
  2870	003144'	370001	777776		SOS	-2(P)		;FAIL RETURN.
  2871	003145'	262040	000010		POP	P,T3		;SUCCESS, RESTORE T2
  2872	003146'	262040	000007		POP	P,T2		;AND T3 FOR CALLERS.
  2873	003147'	254000	003130*		JRST	CPOPJ1		;
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 44
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  2874				COMMENT #
  2875				@@SUBROUTINE MWLRIB
  2876				@@PURPOSE
  2877				SUBR TO GET THE DISK PAGE WHOSE RETRIEVAL PNTR IS IN T1 INTO
  2878				%RIB, WRITE LOCKED.  (TAKES CARE OF ALREADY HAVING A RIB.).
  2879				CHECKS THE NEW RIB FOR CONSISTENCY, ALSO.
  2880				@@ENTRY
  2881				EXPECTS T1/ RET PNTR TO DESIRED PAGE.
  2882				@@ACCUM
  2883				DESTROYS T1-T4, PG, AND U.
  2884				@@EXIT
  2885				NON-SKIP RETURNS ON CONSISTENCY CHECK(HAS RELEASED RIB); ELSE,
  2886				SKIP RETURNS WITH RIB IN %RIB.
  2887				@@ #
  2888
  2889				INTERN MWLRIB
  2890
  2891	003150'	201140	000000*	MWLRIB:	MOVEI	PG,%RIB.C	;
  2892	003151'	336360	000000*		SKIPN	T2,@%RIB.C+%CTUPT ;ALREADY HAVE A RIB?
  2893	003152'	254000	003160'		JRST	MWLRB3		;NO.
  2894	003153'	316307	000000*		CAMN	T1,PCBPTR(T2)	;YES, IS IT THE ONE WE WANT?
  2895	003154'	254000	003147*		JRST	CPOPJ1		;YES, SUCCESS RETURN.
  2896	003155'	261040	000006		PUSH	P,T1		;NO, SO
  2897	003156'	260040	000000*		PUSHJ	P,MAPRLS	;RELEASE IT
  2898	003157'	334301	000000		SKIPA	T1,(P)		;KEEP POINTER ON STACK, RESTORE IT TO T1.
  2899	003160'	261040	000006	MWLRB3:	PUSH	P,T1		;SAVE POINTER TO PRIME RIB FOR RIBCON
  2900	003161'	260040	000000*		PUSHJ	P,MAPWTL	;GET THE NEW RIB.
  2901	003162'	414300	376000		SWAPIN	T1,%RIB		;PREREFERENCE RIB SO NO RESCHEDULING
  2902								; (OTHERWISE SOMEONE COULD GET FILE LOKMOD
  2903								; AND BELIEVE DEVFLO AND DEVRIB TOGETHER)
  2904	003163'	200304	003134*		MOVE	T1,DEVRIB(F)	;GET CURRENT POINTER
  2905	003164'	250301	000000		EXCH	T1,(P)		;SAVE IT ON STACK, GET ONE WE NEED TO CHECK
  2906	003165'	202304	003163*		MOVEM	T1,DEVRIB(F)	;SAVE IN DEVRIB SO CAN CHECK AGAINST RIBSLF
  2907	003166'	260040	000000*		PUSHJ	P,RIBCON	;RIB OKAY?
  2908					  PJRST	[POP P,DEVRIB(F) ;NO, BAD. RESTORE DEVRIB
  2909	003167'	324740	004226'			 PJRST RELRIB]	;RELEASE RIB AND RETURN.
  2910	003170'	262044	003165*		POP	P,DEVRIB(F)	;RESTORE GOOD DEVRIB.
  2911	003171'	200004	000002		MOVE	S,DEVIOS(F)	;FILE WENT BAD WHILE
  2912	003172'	607000	002424*		TLNN	S,IOBDRB	;WE WAITED FOR THIS RIB?
  2913	003173'	254000	003154*		JRST	CPOPJ1		;NO, RETURN WITH RIB.
  2914	003174'	324740	002726*		PJRST	RELRIB		;YES, REL RIB AND FAIL RETURN.
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 45
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  2915				COMMENT #
  2916				@@SUBROUTINE KILFIL
  2917				@@PURPOSE
  2918				SUBR TO FLAG A FILE WITH A BAD RIB AND INVALIDATE THE FILE
  2919				FOR EVERYBODY.
  2920				@@ENTRY
  2921				EXPECTS F/ DDB AND S/ DEVIOS.
  2922				EXPECTS THE FILE TO BE LOCKED.
  2923				EXPECTS A LOOKUP OR ENTER TO BE IN FORCE.
  2924				@@ACCUM
  2925				DESTROYS T1-T4, AND PG.
  2926				@@EXIT
  2927				RETURNS T1/FALRBE.
  2928				RELEASES BOTH RIBS BEFORE RETURN.
  2929				ALSO UNLOCKS THE FILE.
  2930				@@ #
  2931
  2932
  2933				INTERN KILFIL
  2934
  2935				    ;GET THE FILE LOCKED DOWN.
  2936	003175'	607200	060000	KILFIL:	TLNN	F,LOOKB!ENTRB	;DEBUGGING CHECK.
  2937	003176'	256000	000000'		 STOPCD                         ;;KILFIL+1
  2938	003177'	260040	002174*		PUSHJ	P,RELRB2	;DUMP M2, SINCE WON'T NEED IT.
  2939	003200'	603000	003172*		TLNE	S,IOBDRB	;FILE ALREADY MARKED BAD?
  2940	003201'	254000	003372'		JRST	KILOUT		;YES, LITTLE FOR US TO DO.
  2941	003202'	336004	000000*		SKIPN	DEVLOK(F)	;ARE WE LOCKED ON THE FILE?
  2942	003203'	256000	000000'		 STOPCD                         ;;KILFIL+5
  2943	003204'	510304	000000*		HLLZ	T1,DEVBTS(F)	;IS THIS FILE ALREADY
  2944	003205'	603300	000000*		TLNE	T1,DEPFLK	;LOCKED MODIFY BY US?
  2945	003206'	254000	003216'		JRST	KILFL2		;YES.
  2946	003207'	260040	003174*		PUSHJ	P,RELRIB	;NO, CAN'T
  2947	003210'	260040	003541'		PUSHJ	P,UNLFIL	;LOCK WHEN HAVE RIB.
  2948	003211'	202004	000002		MOVEM	S,DEVIOS(F)	;
  2949	003212'	260040	003653'		PUSHJ	P,LOKMOD	;
  2950	003213'	200004	000002		MOVE	S,DEVIOS(F)	;HAS SOMEBODY ELSE SET THE
  2951	003214'	603000	003200*		TLNE	S,IOBDRB	;ERROR BIT WHILE WE WAITED?
  2952	003215'	254000	003373'		JRST	KILOT4		;YES, CLEAN UP AND EXIT.
  2953
  2954				    ;TRY TO LOG THIS FILE.
  2955	003216'	201300	003376'	KILFL2:	MOVEI	T1,KILBUF	;MAYBE LOG IT.
  2956	003217'	336006	000000		SKIPN	(T1)		;
  2957	003220'	254000	003224'		JRST	KILF24		;ROOM TO LOG FIRST.
  2958	003221'	271300	000007		ADDI	T1,LOGLEN	;
  2959	003222'	332006	000000		SKIPE	(T1)		;ROOM TO LOG 2ND?
  2960	003223'	254000	003244'		JRST	KILFL4		;NO.
  2961	003224'	200344	000017	KILF24:	MOVE	T2,DEVPPN(F)	;
  2962	003225'	202346	000000		MOVEM	T2,(T1)		;
  2963	003226'	200344	000015		MOVE	T2,DEVFIL(F)	;
  2964	003227'	202346	000001		MOVEM	T2,1(T1)	;
  2965	003230'	510344	000016		HLLZ	T2,DEVEXT(F)	;
  2966	003231'	512346	000002		HLLZM	T2,2(T1)	;
  2967	003232'	200344	003170*		MOVE	T2,DEVRIB(F)	;
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 45-2
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  2968	003233'	202346	000003		MOVEM	T2,3(T1)	;
  2969	003234'	550344	003027*		HRRZ	T2,DEVATB(F)	;
  2970	003235'	200347	000755*		MOVE	T2,ATBRIB(T2)	;
  2971	003236'	202346	000004		MOVEM	T2,4(T1)	;
  2972	003237'	200400	002732*		MOVE	T3,JOB		;
  2973	003240'	200350	000000*		MOVE	T2,JBTNAM(T3)	;
  2974	003241'	202346	000005		MOVEM	T2,5(T1)	;
  2975	003242'	200350	000000*		MOVE	T2,JBTUNM(T3)	;
  2976	003243'	202346	000006		MOVEM	T2,6(T1)	;
  2977
  2978				    ;HERE TO MARK THE FILE AS BAD.
  2979				      ;SET RIPUFE IN RIBLCW AND RIPBDR IN RIBSTS.
  2980	003244'	550304	003234*	KILFL4:	HRRZ	T1,DEVATB(F)	;GET THE PRIME RIB
  2981	003245'	200306	003235*		MOVE	T1,ATBRIB(T1)	;(WITHOUT CHECKING
  2982	003246'	201140	003150*		MOVEI	PG,%RIB.C	;CONSISTENCY.).
  2983	003247'	336360	000000*		SKIPN	T2,@%RIB.C+%CTUPT ;ALREADY HAVE A RIB?
  2984	003250'	254000	003266'		JRST	KILF42		;NO.
  2985	003251'	312307	003153*		CAME	T1,PCBPTR(T2)	;YES.  IS IT THE ONE WE WANT?
  2986	003252'	254000	003263'		JRST	KILF41		;NO.
  2987	003253'	200300	003237*		MOVE	T1,JOB		;YES.  IS IT
  2988	003254'	135303	000000*		LDB	T1,%CTSTS(PG)	;WRITEABLE?
  2989	003255'	302300	000000*		CAIE	T1,STAWTU	;
  2990	003256'	306300	000000*		CAIN	T1,STAWTL	;
  2991	003257'	254000	003267'		JRST	KILF43		;YES.
  2992	003260'	302300	000000*		CAIE	T1,STACML	;
  2993	003261'	306300	000000*		CAIN	T1,STAWLN	;
  2994	003262'	254000	003267'		JRST	KILF43		;YES.
  2995	003263'	260040	003156*	KILF41:	PUSHJ	P,MAPRLS	;HERE TO RELEASE CURRENT RIB,
  2996	003264'	550304	003244*		HRRZ	T1,DEVATB(F)	;AND GET
  2997	003265'	200306	003245*		MOVE	T1,ATBRIB(T1)	;THE
  2998	003266'	260040	003161*	KILF42:	PUSHJ	P,MAPWTL	;PRIME RIB WRITEABLE.
  2999	003267'	551300	000000*	KILF43:	HRRZI	T1,RIPBDR	;SET RIPBDR
  3000	003270'	436300	376000*		IORM	T1,%RIB+RIBSTS	;AND
  3001	003271'	205300	000000*		MOVSI	T1,RIPUFE	;RIPUFE.
  3002	003272'	436300	376000*		IORM	T1,%RIB+RIBLCW	;
  3003	003273'	260040	003207*		PUSHJ	P,RELRIB	;
  3004				      ;SET ATPUFE IN ATBLCW.
  3005	003274'	550344	003264*		HRRZ	T2,DEVATB(F)	;
  3006	003275'	205300	000000*		MOVSI	T1,ATPUFE	;
  3007	003276'	436307	000000*		IORM	T1,ATBLCW(T2)	;
  3008				      ;ZERO ATBSIZ AND ATBALP, ADJUST DRBALC.
  3009	003277'	135300	000000*		LDB	T1,ATYALP	;
  3010	003300'	554444	000000*		HLRZ	T4,DEVDRB(F)	;
  3011	003301'	272311	000000*		ADDM	T1,DRBALC(T4)	;
  3012	003302'	400300	000000		SETZ	T1,		;
  3013	003303'	137300	003277*		DPB	T1,ATYALP	;
  3014	003304'	402007	001663*		SETZM	ATBSIZ(T2)	;
  3015				      ;MARK ALL OF THE DDBS ON THIS VERSION OF THE FILE BAD.
  3016	003305'	515300	003214*		HRLZI	T1,IOBDRB	;T1/ BAD BIT.
  3017	003306'	550447	002700*		HRRZ	T4,ATBFNB(T2)	;T4/
  3018	003307'	550451	002701*		HRRZ	T4,FNBDBL(T4)	;DDB.
  3019	003310'	550411	003274*	KILF44:	HRRZ	T3,DEVATB(T4)	;IS THIS DDB ON THE SAME
  3020	003311'	302407	000000		CAIE	T3,(T2)		;VERSION OF THE FILE?
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 45-3
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  3021	003312'	254000	003315'		JRST	KILF45		;NO, FORGET IT.
  3022	003313'	476011	002712*		SETOM	DEVFLO(T4)	;YES, MARK IT INVALID AND
  3023	003314'	436311	000002		IORM	T1,DEVIOS(T4)	;BAD.
  3024	003315'	550451	002713*	KILF45:	HRRZ	T4,DEVDBL(T4)	;GET T4/ NEXT DDB.
  3025	003316'	326440	003310'		JUMPN	T4,KILF44	;JUMP IF ONE THERE.
  3026				      ;SET RIPBDR IN LH OF UFD'S RIBSTS, AND UFPERR IN UFDERR.
  3027	003317'	550347	001453*		HRRZ	T2,ATBSTS(T2)	;MAKE SURE THIS
  3028	003320'	606340	000000*		TRNN	T2,ATPSUP!ATPCRE ;HAS
  3029	003321'	602340	000000*		TRNE	T2,ATPDEL	;A UFD ENTRY.
  3030	003322'	254000	003371'		JRST	KILF49		;IT DOESN'T.
  3031	003323'	554304	003300*		HLRZ	T1,DEVDRB(F)	;GET THE RETRIEVAL
  3032	003324'	200306	000000*		MOVE	T1,DRBRIB(T1)	;PNTR TO THE UFD.
  3033	003325'	201140	003246*		MOVEI	PG,%RIB.C	;GET THE PRIME
  3034	003326'	260040	003266*		PUSHJ	P,MAPWTL	;RIB OF THE UFD.
  3035	003327'	205300	003267*		MOVSI	T1,RIPBDR	;MARK "A FILE IN THIS
  3036	003330'	436300	376000*		IORM	T1,%RIB+RIBSTS	;UFD IS BAD.
  3037	003331'	550344	003310*		HRRZ	T2,DEVATB(F)	;GET T1/
  3038	003332'	550347	003306*		HRRZ	T2,ATBFNB(T2)	;THE
  3039	003333'	250340	000016		EXCH	T2,P3		;NUMBER OF
  3040	003334'	135300	000000*		LDB	T1,FNYUFP	;THE PAGE THIS
  3041	003335'	200700	000007		MOVE	P3,T2		;ENTRY IS IN.
  3042	003336'	333306	376000*		SKIPLE	T1,%RIB+RIBPFS(T1) ;GET RET PNTR
  3043	003337'	607300	002745*		TLNN	T1,RBREAL	;TO THAT PAGE.
  3044	003340'	254000	003371'		JRST	KILF49		;THIS RIB BAD, TOO.
  3045	003341'	135340	000000*		LDB	T2,RBYUN1	;PROTECT FILIO
  3046	003342'	305340	000000*		CAIGE	T2,UNTLEN	;A LITTLE.
  3047	003343'	336007	000000*		SKIPN	UNTTBL(T2)	;
  3048	003344'	254000	003371'		JRST	KILF49		;
  3049	003345'	261040	000006		PUSH	P,T1		;
  3050	003346'	260040	003273*		PUSHJ	P,RELRIB	;DUMP UFD RIB.
  3051	003347'	262040	000006		POP	P,T1		;RESTORE T1/ RET PNTR.
  3052	003350'	201140	003325*		MOVEI	PG,%RIB.C	;GET THAT
  3053	003351'	260040	003326*		PUSHJ	P,MAPWTL	;PAGE INTO %RIB.
  3054	003352'	201340	000000*		MOVEI	T2,<^D512/UFDSIZ> ;T2/ NO. OF ENTRIES.
  3055	003353'	200304	000015		MOVE	T1,DEVFIL(F)	;T1/ FILENAME.
  3056	003354'	500404	000016		HLL	T3,DEVEXT(F)	;T3/ EXTENSION.
  3057	003355'	400440	000000		SETZ	T4,		;INDEX INTO PAGE.
  3058	003356'	316311	376000*	KILF46:	CAMN	T1,%RIB+UFDNAM(T4) ;MATCH ON FILENAME?
  3059	003357'	254000	003363'		JRST	KILF48		;YES.
  3060	003360'	271440	000000*	KILF47:	ADDI	T4,UFDSIZ	;NO, NO MATCH, TRY
  3061	003361'	367340	003356'		SOJG	T2,KILF46	;NEXT.
  3062	003362'	254000	003371'		JRST	KILF49		;NONE LEFT, ERROR OF SOME TYPE.
  3063	003363'	540411	376000*	KILF48:	HRR	T3,%RIB+UFDEXT(T4) ;EXT MATCHES
  3064	003364'	312411	376000*		CAME	T3,%RIB+UFDEXT(T4) ;ALSO?
  3065	003365'	254000	003360'		JRST	KILF47		;NO, TRY NEXT.
  3066	003366'	201300	000000*		MOVEI	T1,UFPERR	;YES.  SET
  3067	003367'	436311	376000*		IORM	T1,%RIB+UFDERR(T4) ;UFPERR IN OUR ENTRY.
  3068	003370'	553011	376000*		HRRZS	%RIB+UFDALP(T4)	;ZERO UFDALP.
  3069
  3070	003371'	200004	000002	KILF49:	MOVE	S,DEVIOS(F)	;RESTORE S FOR US.
  3071	003372'	260040	003346*	KILOUT:	PUSHJ	P,RELRIB	;
  3072	003373'	260040	003541'	KILOT4:	PUSHJ	P,UNLFIL	;
  3073	003374'	201300	000011		MOVEI	T1,FALRBE	;
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 45-4
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  3074	003375'	263040	000000		POPJ	P,		;
  3075
  3076
  3077				;LOGGING AREA.
  3078				; ROOM FOR TWO ENTRIES.
  3079			000007	LOGLEN==7
  3080	003376'			KILBUF: REPEAT LOGLEN*2,<Z>
  3081	003376'	000000	000000
  3082	003377'	000000	000000
  3083	003400'	000000	000000
  3084	003401'	000000	000000
  3085	003402'	000000	000000
  3086	003403'	000000	000000
  3087	003404'	000000	000000
  3088	003405'	000000	000000
  3089	003406'	000000	000000
  3090	003407'	000000	000000
  3091	003410'	000000	000000
  3092	003411'	000000	000000
  3093	003412'	000000	000000
  3094	003413'	000000	000000
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 46
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  3095				COMMENT #
  3096				@@SUBROUTINE MAPKRN
  3097				@@PURPOSE
  3098				KERNEL SUBROUTINE TO MAP ANY DISK FILE PAGE TO A VM PAGE, GIVEN
  3099				THE RETRIEVAL PNTR TO THE DISK PAGE.  DOES NOT ALLOCATE.
  3100				ASSUMES CALLER HAS INSURED THAT VP IS NON-EXISTENT.
  3101				@@ENTRY
  3102				MAPKRN EXPECTS T1/ ATB ADDRESS, T2/ RETRIEVAL PNTR
  3103					P3 CONTAINS PROTOTYPE LMAP SLOT (PROTECTION, LMPMXW)
  3104				W/ VP NO.
  3105				THERE MAY OR MAY NOT BE A SAT IN %SAT ON ENTRY.
  3106				@@ACCUM
  3107				DESTROYS T1 THRU T4 AND PG.
  3108				@@EXIT
  3109				SKIP RETURNS WHEN SUCCESSFUL
  3110				NON-SKIP RETURNS WHEN SAT FOR REQUESTED PAGE IS BAD AND IT IS
  3111				NOT THE ONE BAD SAT WE CAN USE.
  3112				IN EITHER TYPE OF RETURN, MAY OR MAY NOT HAVE A SAT IN
  3113				%SAT-- CALL RELSAT TO CLEAN UP.
  3114				ON SUCCESS RETURN, LMAP SLOT IS IN P3 AND P4, READY TO STORE INTO DESTINATION
  3115				@@#
  3116
  3117
  3118				INTERN SATBAD,SATBRD
  3119	003414'	000000	000000	SATBAD: Z	;RETRIEVAL PNTR TO 1ST BAD SAT FOUND ON SYSTEM.
  3120	003415'	000000	000000	SATBRD:	Z	;NUMBER OF BAD SATS DUE TO READ ERRORS.
  3121	003416'	777777	777777	SATBCT:	-1	;Abort when count of bad SATs goes positive.
  3122
  3123
  3124				  ;BUILD SOME OF THE LMAP SLOT.
  3125	003417'	607700	001445*	MAPKRN::TLNN	P3,LMPMXW	;MAX WRITE SET?
  3126	003420'	254000	003426'		 JRST	MAPKN2		;NO, DON'T INCREMENT UMC.
  3127	003421'	350446	001447*		AOS	T4,ATBMWC(T1)	;YES, INC THE ATB WRITE COUNT.
  3128	003422'	606440	001450*		TRNN	T4,ATMMWC	;IF WE OVRFLWD, FIELD GOES TO 0.
  3129	003423'	256000	000000'		 STOPCD                         ;;MAPKRN+4
  3130	003424'	551440	001452*		HRRZI	T4,ATPMXU	;MAKE SURE OTHERS KNOW THAT THE
  3131	003425'	436446	003317*		IORM	T4,ATBSTS(T1)	;COUNT IS >=1.
  3132
  3133				  ;FIND OUT IF THIS DP IS SHARED OR UNSHARED.
  3134	003426'	261040	000006	MAPKN2:	PUSH	P,T1		;SAVE ATB ADDR FROM GETSAT.
  3135	003427'	201300	001371*	MAPK21:	MOVEI	T1,MAPCML	;GET THE SAT FOR T2 COMPLETELY
  3136	003430'	621340	000000*		TLZ	T2,RBMASK-RBREAL ;
  3137	003431'	260040	001372*		PUSHJ	P,GETSAT	;LOCKED.
  3138	003432'	254000	003434'		  JRST	MAPK24		;BAD SAT.
  3139	003433'	254000	003444'		JRST	MAPK26		;OKAY.
  3140
  3141	003434'	312440	003414'	MAPK24:	CAME	T4,SATBAD	;IS THIS THE BAD SAT WE CAN USE?
  3142	003435'	254000	003462'		 JRST	MAPFAL		;NO, MAP FAILURE.
  3143	003436'	621340	003337*		TLZ	T2,RBREAL	;CLEAR FLGS FOR SRCSPT AND OTHERS.
  3144	003437'	200301	000000		MOVE	T1,(P)		;T1/ ATB ADDRESS.
  3145	003440'	260040	001407*		PUSHJ	P,SRCSPT	;ALREADY IN SPT?
  3146					  JRST	[MOVE T1,(P)	;NO, TREAT LIKE MAPPED.
  3147						PUSHJ P,INCUMC	;
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 46-2
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  3148	003441'	254000	004230'			JRST MAPKN7]	;
  3149	003442'	262040	000010		POP	P,T3		;YES, CLEAR PDL.
  3150	003443'	254000	003453'		JRST	MAPKN3		;
  3151
  3152				;HERE IF SAT IS GOOD.
  3153
  3154	003444'	261040	000006	MAPK26:	PUSH	P,T1		;SAVE MASK FOR AND POSITION
  3155	003445'	261040	000010		PUSH	P,T3		;OF F BIT IN SAT.
  3156	003446'	200301	777776		MOVE	T1,-2(P)	;GET ATB FOR & SAVE FROM SRCSPT.
  3157	003447'	621340	000437*		TLZ	T2,RBMASK	;CLEAR FLGS FOR SRCSPT AND OTHERS.
  3158	003450'	260040	003440*		PUSHJ	P,SRCSPT	;T2 IN THE SPT ALREADY?
  3159	003451'	254000	003500'		JRST	MAPKN6		;NO.
  3160	003452'	274040	004233'		SUB	P,[XWD 3,3]	;YES, CLEAR JUNK FROM PDL.
  3161
  3162				  ;HERE WHEN ALREADY IN THE SPT.
  3163	003453'	137440	000447*	MAPKN3:	DPB	T4,LM3SPT	;SET SPT ENTRY PNTR IN LMAP.
  3164	003454'	350406	001413*		AOS	T3,SPTUSC(T1)	;INC THE SPT USE
  3165	003455'	606400	000000*		TRNN	T3,SPMUSC	;COUNT.
  3166	003456'	256000	000000'		 STOPCD                         ;;MAPKN3+3
  3167
  3168	003457'	661700	000452*	MAPKN4:	TLO	P3,LMPSHR	;SET LMAP SLOT STATUS TO SHRD.
  3169	003460'	400740	000000		SETZ	P4,
  3170	003461'	254000	003173*		JRST	CPOPJ1
  3171
  3172				  ;Here when GETSAT gave error return and more than 1 SAT is bad
  3173	003462'	352000	003416'	MAPFAL:	AOSE	SATBCT		;Increment bad SAT count
  3174	003463'	256000	004234'		 STOPCD (.+1,DEBUG,SAT2ND,,<2nd bad SAT detected>);;MAPFAL+1
  3175	003464'	262040	000006		POP	P,T1		;
  3176	003465'	607700	003417*		TLNN	P3,LMPMXW	;DID WE INC THE ATB WRITE COUNT?
  3177	003466'	263040	000000		 POPJ	P,		;NO.
  3178	003467'	201440	003422*		MOVEI	T4,ATMMWC	;YES.  FIRST CHECK THAT DECING
  3179	003470'	616446	003421*		TDNN	T4,ATBMWC(T1)	;IT WONT MAKE IT LESS THAN ZERO.
  3180	003471'	256000	000000'		 STOPCD                         ;;MAPFAL+5
  3181	003472'	370006	003470*		SOS	ATBMWC(T1)	;OKAY, DEC IT, AND IF IT WENT TO
  3182	003473'	612446	003472*		TDNE	T4,ATBMWC(T1)	;ZERO, CLEAR
  3183	003474'	263040	000000		 POPJ	P,		;HASN'T GONE TO ZERO.
  3184	003475'	551440	003424*		HRRZI	T4,ATPMXU	;ATPMXU.
  3185	003476'	412446	003425*		ANDCAM	T4,ATBSTS(T1)	;
  3186	003477'	263040	000000		POPJ	P,
  3187
  3188				  ;HERE WHEN NOT IN SPT.  (MAY BE BECOMING SHARED.).
  3189	003500'	262040	000010	MAPKN6:	POP	P,T3		;RESTORE MASK FOR AND POSITION
  3190	003501'	262040	000006		POP	P,T1		;OF F BIT IN SAT.
  3191	003502'	616310	377400		TDNN	T1,%SAT+MBITS(T3);IS THE MAPPED BIT ON?
  3192	003503'	254000	003520'		 JRST	MAPKN7		;YES.
  3193
  3194				  ;HERE WHEN UNSHARED.
  3195	003504'	412310	377400		ANDCAM	T1,%SAT+MBITS(T3);SET THE MAPPED BIT IN THE SAT.
  3196				;*; Need to verify if OK to call DNDADS here.  P034/B02
  3197				;*;	TDNE	T1,%SAT+FBITS(T3);F bit should already be in use.  Is it?
  3198				;*;	 PUSHJ	P,DNDADS##	;No, one less page
  3199	003505'	262040	000006		POP	P,T1		;GET T1/ ATB ADDRESS.
  3200	003506'	261040	000007		PUSH	P,T2		;SAVE RET PNTR.
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 46-3
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  3201	003507'	260040	001443*		PUSHJ	P,INCUMC	;INC THE ATB USC COUNT, ETC.
  3202	003510'	260040	001454*		PUSHJ	P,CNVATB	;SET
  3203	003511'	137300	001464*		DPB	T1,LM3ATB	;LM3ATB.
  3204	003512'	262040	000007		POP	P,T2		;RESTORE RET PNTR.
  3205	003513'	200740	000007		MOVE	P4,T2		;GET LOW ORDER DISK ADDRESS
  3206	003514'	620740	400000		TRZ	P4,PGE.A	;USES ALL BITS BUT PGE.A
  3207	003515'	242340	000000*		LSH	T2,-LMASRP	;GET HI ORDER RIGHT JUSTIFIED
  3208	003516'	137340	000473*		DPB	T2,LM3HDA
  3209	003517'	254000	003461*		JRST	CPOPJ1		;GIVE GOOD RETURN.
  3210
  3211				  ;HERE WHEN BECOMING SHARED.
  3212	003520'	200301	000000	MAPKN7:	MOVE	T1,(P)		;GET T1/ ATB ADDRESS.
  3213	003521'	260040	000000*		PUSHJ	P,INSSPT	;MAKE AN SPT ENTRY.
  3214	003522'	254000	003531'		 JRST	MAPKN8		;LOSE, GO WAIT FOR FREECORE.
  3215	003523'	137440	003453*		DPB	T4,LM3SPT	;SET LM3SPT.
  3216	003524'	205400	000000*		MOVSI	T3,SPPVIR	;VIRGIN
  3217	003525'	603700	003026*		TLNE	P3,LMPVIR	;BIT?
  3218	003526'	436406	000000*		IORM	T3,SPTVIR(T1)	;YES.
  3219	003527'	262040	000007		POP	P,T2		;GET T2/ATB ADDR.
  3220	003530'	254000	003457'		JRST	MAPKN4
  3221
  3222	003531'	261040	000007	MAPKN8:	PUSH	P,T2
  3223	003532'	260040	003036*		PUSHJ	P,RELSAT
  3224	003533'	262040	000007		POP	P,T2
  3225	003534'	350000	000000*		AOS	FCREQ##
  3226	003535'	260040	000000*		PUSHJ	P,FCWAIT##
  3227	003536'	370000	003534*		SOS	FCREQ##
  3228	003537'	661340	003436*		TLO	T2,RBREAL
  3229	003540'	254000	003427'		JRST	MAPK21
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 47
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  3230				COMMENT #
  3231				@@SUBROUTINE UNLFIL
  3232				@@PURPOSE
  3233				SUBR TO UNLINK A FILE FROM THE ATOMIC FILE LOCKING QUEUE.
  3234				MUST BE CALLED FOR THE RUNNING JOB.  DOES NOT CARE IF THE
  3235				FILE IS NOT IN THE QUEUE.
  3236				@@ENTRY
  3237				EXPECTS F/ DDB.
  3238				@@ACCUM
  3239				DESTROYS NO ACS.
  3240				@@ #
  3241				INTERN UNLFIL
  3242
  3243	003541'	336004	003202*	UNLFIL:	SKIPN	DEVLOK(F)	;NOTHING TO DO IF WE ARE
  3244	003542'	263040	000000		POPJ	P,		;NOT IN THE QUEUE AT ALL.
  3245	003543'	261040	000006		PUSH	P,T1		;
  3246	003544'	261040	000010		PUSH	P,T3		;
  3247	003545'	574304	003541*		HLRE	T1,DEVLOK(F)	;T1/ PREVIOUS.
  3248	003546'	550404	003545*		HRRZ	T3,DEVLOK(F)	;T3/ NEXT.
  3249	003547'	402004	003546*		SETZM	DEVLOK(F)	;
  3250	003550'	316300	004126'		CAMN	T1,[-1]		;JUMP IF WE ARE
  3251	003551'	254000	003556'		JRST	UNLFL4		;FIRST IN THE QUEUE.
  3252
  3253				    ;HERE WHEN WE ARE NOT 1ST IN THE QUEUE.
  3254	003552'	542406	003547*		HRRM	T3,DEVLOK(T1)	;JUST
  3255	003553'	322400	003610'		JUMPE	T3,UNLOT6	;HAVE
  3256	003554'	506310	003552*		HRLM	T1,DEVLOK(T3)	;TO
  3257	003555'	254000	003610'		JRST	UNLOT6		;RELINK.
  3258
  3259				    ;HERE WHEN WE ARE FIRST IN QUEUE.
  3260	003556'	550304	003331*	UNLFL4:	HRRZ	T1,DEVATB(F)	;
  3261	003557'	542406	000000*		HRRM	T3,ATBLOK(T1)	;POINT ATB TO NEXT.
  3262	003560'	322400	003610'		JUMPE	T3,UNLOT6	;DONE IF NO ONE IN QUEUE.
  3263	003561'	551300	777777		HRRZI	T1,-1		;
  3264	003562'	506310	003554*		HRLM	T1,DEVLOK(T3)	;POINT NEXT TO ATB.
  3265	003563'	510304	003204*		HLLZ	T1,DEVBTS(F)	;UNLESS BOTH WE
  3266	003564'	603300	003205*		TLNE	T1,DEPFLK	;AND THE NEXT
  3267	003565'	254000	003571'		JRST	UNLFL6		;ARE READERS, WE
  3268	003566'	510310	003563*		HLLZ	T1,DEVBTS(T3)	;HAVE TO START SOME
  3269	003567'	607300	003564*		TLNN	T1,DEPFLK	;JOBS.
  3270	003570'	254000	003610'		JRST	UNLOT6		;NO NEED TO START ANY.
  3271	003571'	261040	000002	UNLFL6:	PUSH	P,J		;
  3272	003572'	261040	000004		PUSH	P,F		;
  3273	003573'	200200	000010		MOVE	F,T3		;START
  3274	003574'	135100	003103*		LDB	J,PJOBN		;THIS
  3275	003575'	201300	000000*		MOVEI	T1,RNQ		;NEXT
  3276	003576'	137300	000000*		DPB	T1,PJBSTS	;JOB.
  3277	003577'	260040	000000*		PUSHJ	P,SETRUN	;
  3278	003600'	510310	003566*		HLLZ	T1,DEVBTS(T3)	;
  3279	003601'	603300	003567*		TLNE	T1,DEPFLK	;IS IT A READER?
  3280	003602'	254000	003606'		JRST	UNLOUT		;NO, DONE.
  3281	003603'	550410	003562*		HRRZ	T3,DEVLOK(T3)	;YES, GET NEXT IN QUEUE.
  3282	003604'	322400	003606'		JUMPE	T3,UNLOUT	;JUMP ON NO MORE IN QUEUE.
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 47-2
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  3283	003605'	260040	003635'		PUSHJ	P,STRSOM	;
  3284
  3285	003606'	262040	000004	UNLOUT:	POP	P,F		;
  3286	003607'	262040	000002		POP	P,J		;
  3287	003610'	262040	000010	UNLOT6:	POP	P,T3		;
  3288	003611'	262040	000006		POP	P,T1		;
  3289	003612'	263040	000000		POPJ	P,
  3290
  3291
  3292				COMMENT #
  3293				@@SUBROUTINE LOKLES
  3294				@@PURPOSE
  3295				SUBR TO CHANGE A FILE WHICH IS QUEUED LOCK MODIFIED TO LOCK
  3296				UNMODIFIED, AND TO START UP ANYBODY AFTER IT IN THE QUEUE THAT
  3297				WE CAN.
  3298				MUST BE CALLED FOR THE RUNNING JOB.
  3299				@@ENTRY
  3300				EXPECTS F/ DDB.
  3301				@@ACCUM
  3302				DESTROYS NO ACS.
  3303				@@ #
  3304
  3305
  3306	003613'	336004	003603*	LOKLES:	SKIPN	DEVLOK(F)	;WE BETTER BE
  3307	003614'	256000	000000'		 STOPCD                         ;;LOKLES+1
  3308	003615'	261040	000010		PUSH	P,T3		;LOCK
  3309	003616'	205400	003601*		MOVSI	T3,DEPFLK	;MODIFIED WHEN WE
  3310	003617'	616404	003600*		TDNN	T3,DEVBTS(F)	;ENTER HERE.
  3311	003620'	256000	000000'		 STOPCD                         ;;LOKLES+5
  3312	003621'	412404	003617*		ANDCAM	T3,DEVBTS(F)	;NOW WE ARE LOCK UNMODIFIED.
  3313	003622'	550404	003613*		HRRZ	T3,DEVLOK(F)	;IS THERE A JOB BEHIND US
  3314					JUMPE	T3,[POP P,T3	;TO START, MAYBE?
  3315	003623'	322400	004237'			POPJ P,]	;
  3316	003624'	261040	000006		PUSH	P,T1		;
  3317	003625'	261040	000002		PUSH	P,J		;
  3318	003626'	261040	000004		PUSH	P,F		;
  3319	003627'	260040	003635'		PUSHJ	P,STRSOM	;
  3320	003630'	262040	000004		POP	P,F		;
  3321	003631'	262040	000002		POP	P,J		;
  3322	003632'	262040	000006		POP	P,T1		;
  3323	003633'	262040	000010		POP	P,T3		;
  3324	003634'	263040	000000		POPJ	P,
  3325
  3326
  3327				;TINY SUBR FOR USE BY BOTH UNLFIL AND LOKLES, USED TO START UP
  3328				;JOBS AFTER US IN THE QUEUE.  DESTROYS T1, F, J, AND USES T3.
  3329	003635'	510310	003621*	STRSOM:	HLLZ	T1,DEVBTS(T3)	;IS THIS A
  3330	003636'	603300	003616*		TLNE	T1,DEPFLK	;READER, TOO?
  3331	003637'	263040	000000		POPJ	P,		;NO, DONE.
  3332	003640'	200200	000010		MOVE	F,T3		;START
  3333	003641'	135100	003574*		LDB	J,PJOBN		;THIS
  3334	003642'	201300	003575*		MOVEI	T1,RNQ		;NEXT
  3335	003643'	137300	003576*		DPB	T1,PJBSTS	;JOB.
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 47-3
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  3336	003644'	260040	003577*		PUSHJ	P,SETRUN	;
  3337	003645'	550410	003622*		HRRZ	T3,DEVLOK(T3)	;
  3338	003646'	326400	003635'		JUMPN	T3,STRSOM	;
  3339	003647'	263040	000000		POPJ	P,
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 48
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  3340				COMMENT #
  3341				@@SUBROUTINE LOKUNM/LOKMOD
  3342				@@PURPOSE
  3343				LOKUNM(LOKMOD) ARE SUBRS TO GET OUR DDB LOCK UNMODIFIED
  3344				(MODIFIED) ONTO THE ATOMIC FILE LOCKING QUEUE.  MUST BE CALLED
  3345				FROM THE RUNNING JOB.
  3346				THE ATOMIC FILE LOCKING QUEUE PREVENTS DDB POINTERS FROM CHANGING
  3347				OR BEING BELIEVED ERRONEOUSLY WHEN THE RIB STRUCTURE IS CHANGING,
  3348				SINCE PCB LOCKING IS NOT SUFFICIENT WHEN THE ALLOCATION CODE
  3349				IS JUGGLING MORE THAN TWO RIBS. ALL ROUTINES THAT ACCESS
  3350				THE DDB POINTER AREA ARE REQUIRED TO GET THE FILE LOCK
  3351				UNMODIFIED. ALL ROUTINES THAT CHANGE THINGS IN SUCH A WAY
  3352				THAT PCB LOCKING IS NOT SUFFICIENT GET THE FILE LOCK MODIFIED.
  3353				IT IS NOT PERMISSIBLE TO JUST GET A RIB LOCKED DOWN AND THEN READ OR MESS
  3354				WITH THE DDB POINTERS - IT IS ABSOLUTELY REQUIRED THAT THE FILE
  3355				BE LOCKED.
  3356				@@ENTRY
  3357				EXPECTS F/ DDB.
  3358				@@ACCUM
  3359				DESTROYS NO ACS.
  3360				@@ #
  3361
  3362				INTERN LOKMOD,LOKUNM
  3363
  3364	003650'	261040	000014	LOKUNM:	PUSH	P,P1
  3365	003651'	400600	000000		SETZ	P1,
  3366	003652'	254000	003655'		JRST	LOKUM2
  3367
  3368	003653'	261040	000014	LOKMOD:	PUSH	P,P1
  3369	003654'	205600	003636*		MOVSI	P1,DEPFLK
  3370
  3371	003655'	332004	003645*	LOKUM2:	SKIPE	DEVLOK(F)	;BETTER NOT BE LOCKED ALREADY.
  3372	003656'	256000	000000'		 STOPCD                         ;;LOKUM2+1
  3373	003657'	261040	000010		PUSH	P,T3		;
  3374	003660'	261040	000007		PUSH	P,T2		;
  3375	003661'	205400	003654*		MOVSI	T3,DEPFLK	;SET THE
  3376	003662'	412404	003635*		ANDCAM	T3,DEVBTS(F)	;STATUS
  3377	003663'	322600	003665'		JUMPE	P1,.+2		;FLAG
  3378	003664'	436404	003662*		IORM	T3,DEVBTS(F)	;APPROPRIATELY.
  3379	003665'	550344	003556*		HRRZ	T2,DEVATB(F)	;T2/ ATB ADDRESS.
  3380	003666'	550407	003557*		HRRZ	T3,ATBLOK(T2)	;T3/ 1ST IN QUEUE.
  3381	003667'	326400	003674'		JUMPN	T3,LOKUM4	;JUMP IF SOMEBODY IS IN QUEUE.
  3382
  3383				    ;HERE ON NO ONE IN QUEUE.
  3384	003670'	542207	003666*	LOKUM3:	HRRM	F,ATBLOK(T2)	;POINT ATB TO US.
  3385	003671'	551400	777777		HRRZI	T3,-1		;POINT US TO ATB
  3386	003672'	516404	003655*		HRLZM	T3,DEVLOK(F)	;AND AHEAD TO EOQ.
  3387	003673'	254000	003725'		JRST	LOKUT4		;DONE.
  3388
  3389				    ;HERE ON OTHERS IN THE QUEUE ALREADY.
  3390	003674'	326600	003703'	LOKUM4:	JUMPN	P1,LOKUM6	;JUMP IF MODIFYING.
  3391	003675'	261040	000006		PUSH	P,T1		;(UNMOD CAN START IF NO MODI-
  3392	003676'	261040	000011		PUSH	P,T4		;FIERS AHEAD OF IT IN Q.).
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 48-2
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  3393	003677'	400300	000000		SETZ	T1,		;T1/ FLG IF SOMEBODY IN
  3394	003700'	510450	003664*	LOKUM5:	HLLZ	T4,DEVBTS(T3)	;QUEUE
  3395	003701'	603440	003661*		TLNE	T4,DEPFLK	;IS A
  3396	003702'	474300	000000		SETO	T1,		;MODIFIER.
  3397	003703'	550350	003672*	LOKUM6:	HRRZ	T2,DEVLOK(T3)	;T2/ NEXT IN QUEUE.
  3398	003704'	322340	003710'		JUMPE	T2,LOKUM7	;ANYONE THERE?
  3399	003705'	551407	000000		HRRZI	T3,(T2)		;YES.
  3400	003706'	326600	003703'		JUMPN	P1,LOKUM6	;
  3401	003707'	254000	003700'		JRST	LOKUM5		;
  3402	003710'	542210	003703*	LOKUM7:	HRRM	F,DEVLOK(T3)	;FOUND EOQ. POINT PREV LAST
  3403	003711'	516404	003710*		HRLZM	T3,DEVLOK(F)	;TO US, AND WE TO IT AND EOQ.
  3404	003712'	326600	003714'		JUMPN	P1,.+2		;CAN'T START IF MODIFIER, OR IF
  3405	003713'	322300	003723'		JUMPE	T1,LOKUOT	;UNMOD & A PRECEEDING MODIFIER.
  3406	003714'	261040	000002		PUSH	P,J		;PUT THIS JOB INTO
  3407	003715'	200100	003253*		MOVE	J,JOB		;THE ATOMIC
  3408	003716'	201340	000000*		MOVEI	T2,FLWQ		;FILE
  3409	003717'	137340	003643*		DPB	T2,PJBSTS	;WAITING
  3410	003720'	262040	000002		POP	P,J		;QUEUE.
  3411	003721'	260040	000000*		PUSHJ	P,WSCHED	;
  3412	003722'	326600	003725'		JUMPN	P1,LOKUT4	;
  3413	003723'	262040	000011	LOKUOT:	POP	P,T4		;
  3414	003724'	262040	000006		POP	P,T1		;
  3415	003725'	262040	000007	LOKUT4:	POP	P,T2		;
  3416	003726'	262040	000010		POP	P,T3		;
  3417	003727'	262040	000014		POP	P,P1
  3418	003730'	263040	000000		POPJ	P,
  3419
  3420	003731'	201300	000007		$END	(MAP)

  3421	003732'	254000	000164'

  3422	003733'	201300	000023

  3423	003734'	254000	000164'

  3424	003735'	201300	000011

  3425	003736'	254000	000164'

  3426	003737'	201300	000014

  3427	003740'	254000	000164'

  3428	003741'	201300	000013

  3429	003742'	254000	000164'

  3430	003743'	201300	000011

  3431	003744'	254000	000157'

  3432	003745'	201300	000013

MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 48-3
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  3433	003746'	254000	000157'

  3434	003747'	201300	000006

  3435	003750'	254000	000157'

  3436	003751'	205640	200000

  3437	003752'	254000	000065'

  3438	003753'	260040	000000*

  3439	003754'	556046	426260

  3440	003755'	000002	000000

  3441	003756'	201300	000015

  3442	003757'	254000	000151'

  3443	003760'	201300	000003

  3444	003761'	254000	000151'

  3445	003762'	201300	000012

  3446	003763'	254000	000151'

  3447	003764'	000000*	000000

  3448	003765'	201300	000006

  3449	003766'	254000	000151'

  3450	003767'	201300	000011

  3451	003770'	254000	000147'

  3452	003771'	201300	000022

  3453	003772'	254000	000164'

  3454	003773'	550244	000346*

  3455	003774'	254000	000220'

  3456	003775'	201300	000003

  3457	003776'	254000	000164'

  3458	003777'	000000*	000000

  3459	004000'	201300	000006
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 48-4
MAPIO.MAC	28-OCT-87 17:02		KMOVPG


  3460	004001'	254000	000164'

  3461	004002'	201300	000006

  3462	004003'	254000	000000*

  3463	004004'	201300	000017

  3464	004005'	254000	004003*

  3465	004006'	201300	000005

  3466	004007'	254000	000164'

  3467	004010'	201300	000021

  3468	004011'	254000	000164'

  3469	004012'	201300	000003

  3470	004013'	254000	000476'

  3471	004014'	201300	000004

  3472	004015'	254000	000476'

  3473	004016'	000000*	000000

  3474	004017'	201300	000013

  3475	004020'	254000	000476'

  3476	004021'	201300	000012

  3477	004022'	254000	000476'

  3478	004023'	250500	000013

  3479	004024'	370000	000000*

  3480	004025'	254000	000456'

  3481	004026'	260040	001402*

  3482	004027'	250500	000013

  3483	004030'	263040	000000

  3484	004031'	260040	001525*

  3485	004032'	250500	000013

MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 48-5
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  3486	004033'	263040	000000

  3487	004034'	201300	000023

  3488	004035'	254000	004005*

  3489	004036'	201300	000011

  3490	004037'	263040	000000

  3491	004040'	201300	000014

  3492	004041'	254000	004035*

  3493	004042'	201300	000007

  3494	004043'	263040	000000

  3495	004044'	201300	000031

  3496	004045'	254000	004041*

  3497	004046'	201300	000011

  3498	004047'	254000	003541'

  3499	004050'	201300	000006

  3500	004051'	254000	003541'

  3501	004052'	262040	000013

  3502	004053'	263040	000000

  3503	004054'	201300	000030

  3504	004055'	254000	003541'

  3505	004056'	202353	000000

  3506	004057'	201300	000001

  3507	004060'	263040	000000

  3508	004061'	201300	000004

  3509	004062'	254000	004045*

  3510	004063'	260040	003532*

  3511	004064'	201300	000012

  3512	004065'	262040	000002
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 48-6
MAPIO.MAC	28-OCT-87 17:02		KMOVPG


  3513	004066'	263040	000000

  3514	004067'	202613	000000

  3515	004070'	201300	000024

  3516	004071'	254000	004062*

  3517	004072'	201300	000000

  3518	004073'	254000	001024'

  3519	004074'	201300	000001

  3520	004075'	254000	001024'

  3521	004076'	201300	000002

  3522	004077'	254000	001024'

  3523	004100'	201300	000007

  3524	004101'	254000	003541'

  3525	004102'	202413	000000

  3526	004103'	271400	000003

  3527	004104'	242400	777776

  3528	004105'	313540	000010

  3529	004106'	254000	001130'

  3530	004107'	260040	003613'

  3531	004110'	254000	001142'

  3532	004111'	302300	000025

  3533	004112'	306300	000011

  3534	004113'	254000	001724'

  3535	004114'	256000	000000'

  3536	004115'	201300	000024

  3537	004116'	254000	001724'

  3538	004117'	201300	000016

MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 48-7
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  3539	004120'	254000	001724'

  3540	004121'	262040	000010

  3541	004122'	201300	000025

  3542	004123'	254000	001724'

  3543	004124'	201300	000011

  3544	004125'	254000	001724'

  3545	004126'	777777	777777

  3546	004127'	200306	000000

  3547	004130'	302300	000025

  3548	004131'	306300	000011

  3549	004132'	254000	001542'

  3550	004133'	256000	000000'

  3551	004134'	416006	000000

  3552	004135'	004000	001533'

  3553	004136'	000000	000036

  3554	004137'	262040	000006

  3555	004140'	201300	000011

  3556	004141'	263040	000000

  3557	004142'	201300	000015

  3558	004143'	254000	001724'

  3559	004144'	201300	000023

  3560	004145'	263040	000000

  3561	004146'	201300	000024

  3562	004147'	263040	000000

  3563	004150'	260040	003653'

  3564	004151'	254000	001771'

  3565	004152'	260040	003541'
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 48-8
MAPIO.MAC	28-OCT-87 17:02		KMOVPG


  3566	004153'	201300	000011

  3567	004154'	263040	000000

  3568	004155'	201300	000021

  3569	004156'	254000	003541'

  3570	004157'	262040	000013

  3571	004160'	660600	000004

  3572	004161'	254000	002526'

  3573	004162'	006001	000440*

  3574	004163'	000001	000440*

  3575	004164'	002001	000440*

  3576	004165'	000000	002310'

  3577	004166'	660600	000004

  3578	004167'	344540	002526'

  3579	004170'	660600	000004

  3580	004171'	505600	000011

  3581	004172'	262040	000006

  3582	004173'	254000	002510'

  3583	004174'	660600	000004

  3584	004175'	505606	000000

  3585	004176'	254000	002510'

  3586	004177'	200340	000014

  3587	004200'	262040	000014

  3588	004201'	263040	000000

  3589	004202'	262040	000004

  3590	004203'	262040	000014

  3591	004204'	263040	000000

MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 48-9
MAPIO.MAC	28-OCT-87 17:02		KMOVPG

  3592	004205'	505600	000026

  3593	004206'	254000	003006'

  3594	004207'	660000	040000

  3595	004210'	202004	000002

  3596	004211'	254000	003004'

  3597	004212'	262040	000012

  3598	004213'	260040	004063*

  3599	004214'	262040	000010

  3600	004215'	262040	000006

  3601	004216'	201300	000012

  3602	004217'	263040	000000

  3603	004220'	000001*	000440*

  3604	004221'	262040	000005

  3605	004222'	262040	000010

  3606	004223'	262040	000007

  3607	004224'	201300	000011

  3608	004225'	263040	000000

  3609	004226'	262044	003232*

  3610	004227'	324740	003372*

  3611	004230'	200301	000000

  3612	004231'	260040	003507*

  3613	004232'	254000	003520'

  3614	004233'	000003	000003

  3615	004234'	260040	003753*

  3616	004235'	634164	225644

  3617	004236'	000003	000000

  3618	004237'	262040	000010
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 48-10
MAPIO.MAC	28-OCT-87 17:02		KMOVPG


  3619	004240'	263040	000000

  3620						;End of MAPIO  (MAPLIT: MAPEND:)
  3621
NO ERRORS DETECTED
PROGRAM BREAK IS 004255
9K CORE USED
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 49
MAPIO.MAC	28-OCT-87 17:02		SYMBOL TABLE

ALIASD		000341'	EXT	CREPG2		002741'		EXCHOT		002173'		FNBDBL		003307'	EXT
ATBALP		000766'	EXT	CURUPT		000000	EXT	F		000004	INT	FNDAD2		002645'	
ATBDUM		000715'	EXT	DABBIT		000000	EXT	FALALF		000035	SIN	FNDAD4		002654'	
ATBFNB		003332'	EXT	DEALMA		000000	EXT	FALAQA		000025	SIN	FNDADB		002636'	INT
ATBLCW		003276'	EXT	DECRMV		000000	EXT	FALBDS		000012	SIN	FNDDD2		002626'	
ATBLOK		003670'	EXT	DECUMC		000000	EXT	FALCOR		000010	SIN	FNDDD4		002633'	
ATBMWC		003473'	EXT	DECUNS		001440'	EXT	FALCPL		000013	SIN	FNDDDB		002617'	INT
ATBRIB		003265'	EXT	DECUPM		000277'	INT	FALCPU		000002	SIN	FNYUFP		003334'	EXT
ATBSIZ		003304'	EXT	DECUSE		000000	EXT	FALCTG		000000	SIN	GETATB		001434'	EXT
ATBSTS		003476'	EXT	DELCRE		001734'		FALCTL		000026	SIN	GETB		000010	SIN
ATMMWC		003467'	EXT	DELDHO		001724'		FALDVR		000001	SIN	GETCPA		001457'	EXT
ATPCRE		000000	EXT	DELXC2		001765'		FALFPZ		000007	SIN	GETDPA		001366'	EXT
ATPDEL		003321'	EXT	DELXC4		001766'		FALHOL		000015	SIN	GETLMA		001521'	EXT
ATPMXU		003475'	EXT	DELXC5		001771'		FALIPE		000027	SIN	GETLMX		000513'	EXT
ATPSUP		000000	EXT	DELXCH		001750'		FALLGE		000032	SIN	GETM2		002045'	EXT
ATPUFE		003275'	EXT	DEPFLK		003701'	EXT	FALLKO		000014	SIN	GETRET		003126'	
ATSBLK		000000	EXT	DEVATB		003665'	EXT	FALNEX		000004	SIN	GETSAT		003431'	EXT
ATSWRD		000000	EXT	DEVBTS		003700'	EXT	FALNHL		000016	SIN	GETSPT		001412'	EXT
ATYALP		003303'	EXT	DEVDBL		003315'	EXT	FALNIM		000031	SIN	GETSRC		000510'	
ATYBSZ		002516'	EXT	DEVDRB		003323'	EXT	FALNML		000022	SIN	GIVPAG		001714'	EXT
ATYWSZ		002520'	EXT	DEVEXT		000016	SIN	FALNOF		000023	SIN	GTCGSZ		003121'	EXT
B2PLSH	777777	777776	SPD	DEVFIL		000015	SIN	FALNSE		000036	SIN	INCUMC		004231'	EXT
CHGMAP		000166'		DEVFLO		003313'	EXT	FALNSP		000033	SIN	INCUPM		000275'	
CHGMP2		000176'		DEVIAD		000007	SIN	FALNTF		000030	SIN	INCUSE		000000	EXT
CHGMP4		000204'		DEVIOS		000002	SIN	FALNWT		000024	SIN	INSCHT		000000	EXT
CHKPV1		001036'		DEVLOK		003711'	EXT	FALOFF		000034	SIN	INSSPT		003521'	EXT
CHKPVY		001026'		DEVNAM		000000	SIN	FALOPE		000020	SIN	IOBDRB		003305'	EXT
CHKQTA		002741'	EXT	DEVPPN		000017	SIN	FALPHP		000006	SIN	IOBKTL		040000	SIN
CLRCFL		003060'		DEVRB1		002475'	EXT	FALRBE		000011	SIN	IOSUPR		000347'	EXT
CLRCOW		003010'	INT	DEVRBN		003127'	EXT	FALSAM		000021	SIN	ISCYLB		002744'	EXT
CLRCW4		003062'		DEVRET		003126'	EXT	FALSNM		000017	SIN	ITMCHN		000000	EXT
CLRCW6		003072'		DEVRIB		004226'	EXT	FALSVR		000005	SIN	J		000002	INT
CNTRLC		000400	SIN	DEVSUP		003773'	EXT	FALVEX		000003	SIN	JBTMPC		000175'	EXT
CNVATB		003510'	EXT	DEVSZS		002603'	EXT	FBIT		002750'	EXT	JBTNAM		003240'	EXT
CNVVPN		000440	SIN	DEYRPS		002455'	EXT	FBITS		000000	SPD	JBTSOT		003124'	EXT
CONTIG		002254'	EXT	DIE		004234'	EXT	FCREQ		003536'	EXT	JBTSTS		002733'	EXT
CPOPJ		004071'	EXT	DLTTCI		001655'	EXT	FCWAIT		003535'	EXT	JBTUNM		003242'	EXT
CPOPJ1		003517'	EXT	DLXDR0		001720'		FD2FNO		000360'	EXT	JBTUPM		001036'	EXT
CPRCOW		000002	SIN	DLXDR1		001717'		FINDM		002566'	INT	JBTWCT		003120'	EXT
CPRRDW		000003	SIN	DOMVPG		002307'		FINDM1		002574'		JBYRPT		000321'	EXT
CREA24		001126'		DRBALC		003301'	EXT	FINDM2		002605'		JBYWPT		000324'	EXT
CREA28		001130'		DRBRIB		003324'	EXT	FINDM4		002607'		JOB		003715'	EXT
CREA42		001152'		ENTRB		020000	SIN	FLG.CC		000010	SPD	KEPPAG		002752'	EXT
CREA44		001153'		EXCDR1		002200'		FLG.ER		000004	SPD	KFCRE		001063'	INT
CREAT2		001105'		EXCDR3		002207'		FLG.PG		000001	SPD	KFCRE1		001077'	
CREAT4		001142'		EXCDR4		002211'		FLSHA2		002702'		KFCRE2		001100'	
CREFAL		003003'		EXCDRB		002202'		FLSHA3		002712'		KFCREE		001067'	
CREFL1		003004'		EXCH35		002047'		FLSHA4		002713'		KFDEL		001666'	INT
CREFL4		003006'		EXCH73		002160'		FLSHA5		002720'		KFEXC		002014'	INT
CREOUT		001206'		EXCH7A		002165'		FLUSH		002657'	INT	KFFI42		000566'	
CREPAG		002730'		EXCHH3		002041'		FLUSH2		002663'		KFFI44		000575'	
CREPDN		002776'		EXCHH6		002070'		FLUSHA		002672'	INT	KFFI64		000644'	
CREPG1		002736'		EXCHH7		002137'		FLWQ		003716'	EXT	KFFIF2		000540'	
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 49-2
MAPIO.MAC	28-OCT-87 17:02		SYMBOL TABLE

KFFIF4		000563'		KMOVPH		001310'		MAPF21		000054'		OTFFLG		000524'	EXT
KFFIF5		000603'		KMOVSE		001552'		MAPF22		000065'		P		000001	INT
KFFIF6		000626'		KMOVVE		001535'		MAPF34		000076'		P1		000014	INT
KFFIFP		000527'	INT	KMOVXE		001542'		MAPF36		000131'		P2		000015	INT
KFFMOT		000653'		KMVELK		001600'		MAPFAL		003462'		P3		000016	INT
KFFMTD		000651'		KMVMKP		001502'		MAPFI2		000024'		P4		000017	INT
KFFMTR		000660'		KMVNHO		001561'		MAPFI3		000067'		PAGSTS	047000	777707	
KFFNTF		000646'		KREMOV		000000	EXT	MAPFI5		000134'		PC.UIO		004000	SIN
KFILC4		000717'		KREPL0		000401'		MAPFIL		000013'		PCBPTR		003251'	EXT
KFILC6		000727'		KREPL1		000404'		MAPIO		000000'	ENT	PE.NER		000000	EXT
KFILCK		000677'	INT	KREPLC		000352'	INT	MAPK21		003427'		PERSET	047000	777706	
KFTRN		001640'	INT	KREPNO		000362'		MAPK24		003434'		PG		000003	INT
KFTRN1		001661'		KSMAPP		000207'	INT	MAPK26		003444'		PGE.A		400000	SIN
KILBUF		003376'		KVLRB4		000754'		MAPKN2		003426'		PGE.W		100000	SIN
KILF24		003224'		KVLRIB		000732'	INT	MAPKN3		003453'		PGYATB		001460'	EXT
KILF41		003263'		LM3ATB		003511'	EXT	MAPKN4		003457'		PGYDIO		000000	EXT
KILF42		003266'		LM3CUR		001522'	EXT	MAPKN6		003500'		PGYDRT		000000	EXT
KILF43		003267'		LM3HDA		003516'	EXT	MAPKN7		003520'		PGYSIO		000000	EXT
KILF44		003310'		LM3SPT		003523'	EXT	MAPKN8		003531'		PGYSPT		001462'	EXT
KILF45		003315'		LMASRP		000000	EXT	MAPKRN		003417'	INT	PGYUSE		000000	EXT
KILF46		003356'		LMMCUR		000000	EXT	MAPLIT		003731'	INT	PJBSTS		003717'	EXT
KILF47		003360'		LMMERR		000000	EXT	MAPRDU		000721'	EXT	PJOBN		003641'	EXT
KILF48		003363'		LMMEXS		001243'	EXT	MAPRLS		003263'	EXT	PJRST	324740	000000	
KILF49		003371'		LMMMXW		000000	EXT	MAPUS1		000220'		PS.DER		000000	EXT
KILFIL		003175'	INT	LMMRDW		000000	EXT	MAPUS2		000234'		PS.DTE		000000	EXT
KILFL2		003216'		LMMSUP		000000	EXT	MAPUS4		000243'		PTRCHG		003141'	EXT
KILFL4		003244'		LMNCUR		000000	EXT	MAPUST		000214'		PTRINN		002462'	EXT
KILOT4		003373'		LMPACT		001523'	EXT	MAPWTL		003351'	EXT	PTRLEN		002572'	EXT
KILOUT		003372'		LMPMXW		003465'	EXT	MAPWTU		000000	EXT	PTROU0		002723'	EXT
KMAPP		000003'	INT	LMPNER		000000	EXT	MAPXCH		000000	EXT	PTROU2		003142'	EXT
KMOV2N		001354'		LMPREF		000417'	EXT	MATCH		000675'		PUUOAC		000000	EXT
KMOV3A		001412'		LMPSHR		003457'	EXT	MATLEN		000001	SPD	PVYCOR		001040'	EXT
KMOV3B		001413'		LMPSUP		001245'	EXT	MAXCPR		001016'	EXT	PX.MEM		000004	SPD
KMOV3C		001416'		LMPVIR		003525'	EXT	MBITS		000400	SPD	PXCT	256000	000000	
KMOV3N		001402'		LMYSPT		000000	EXT	MF.GHP		200000	SPD	RBLVSP		002033'	EXT
KMOVBF		001564'		LOGLEN		000007	SPD	MF.USR		400000	SPD	RBMASK		003447'	EXT
KMOVBR		001555'		LOKHP1		001627'		MO.LAC		400000	SPD	RBREAL		003537'	EXT
KMOVBS		001574'		LOKHPW		001610'		MPFBRP		000102'	INT	RBYPNO		000000	EXT
KMOVEE		001553'		LOKLES		003613'		MPORB0		000143'		RBYUN1		003341'	EXT
KMOVEX		001473'		LOKMOD		003653'	INT	MPORB1		000147'		RBYUNI		000253'	EXT
KMOVNA		001606'		LOKUM2		003655'		MPORBR		000145'		REDLMA		004026'	EXT
KMOVNH		001335'		LOKUM3		003670'		MPROU1		000157'		REDLMX		000505'	EXT
KMOVNV		001256'		LOKUM4		003674'		MPROU2		000151'		REDSRC		000502'	
KMOVOQ		001557'		LOKUM5		003700'		MTR		000024	SPD	RELLOK		001657'	EXT
KMOVP1		001242'		LOKUM6		003703'		MWLRB3		003160'		RELM2		002212'	EXT
KMOVP2		001262'		LOKUM7		003710'		MWLRIB		003150'	INT	RELRB2		003177'	EXT
KMOVP3		001337'		LOKUNM		003650'	INT	NODIE		000000	EXT	RELRIB		004227'	EXT
KMOVP4		001454'		LOKUOT		003723'		NORED		000536'	EXT	RELSAT		004213'	EXT
KMOVP5		001464'		LOKUT4		003725'		NOWRT		001757'	EXT	REMCHT		000000	EXT
KMOVP6		001465'		LOOKB		040000	SIN	NXTPT0		003143'	EXT	REMMWS		000000	EXT
KMOVPE		001540'		M		000013	INT	ONESL2		002557'		REMSPT		000000	EXT
KMOVPF		001567'		MAPCML		003427'	EXT	ONESLT		002554'		REMUWS		000000	EXT
KMOVPG		001225'	INT	MAPEND		004254'	INT	OTFFLG		000524'	EXT	REMWAT		000000	EXT
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88 PAGE 49-3
MAPIO.MAC	28-OCT-87 17:02		SYMBOL TABLE

REPFAL		000476'		SPRBNS		000310'		T1		000006	INT	WSCHED		003721'	EXT
REPLC1		000410'		SPRBNU		000304'		T2		000007	INT	ZZ	006345	645555	SPD
REPLC2		000434'		SPTUSC		003454'	EXT	T3		000010	INT	%COW		003071'	EXT
REPNXT		000456'		SPTVIR		003526'	EXT	T4		000011	INT	%COW.N		000000	EXT
REPOUT		000465'		SRCCHT		000000	EXT	TIMADJ		000000	EXT	%CTSTS		003254'	EXT
REPSUP		000467'		SRCSPT		003450'	EXT	TITO		000001	SPD	%CTUPT		000000	EXT
RIBALP		000000	EXT	SRUNI		000343'	EXT	TSTVIR		001252'	EXT	%RB2		375000	SIN
RIBCKD		000000	EXT	STACML		003260'	EXT	U		000005	INT	%RB2.C		000000	EXT
RIBCON		003166'	EXT	STAWLN		003261'	EXT	UFDALP		000000	EXT	%RIB		376000	SIN
RIBLCW		000000	EXT	STAWTL		003256'	EXT	UFDERR		000000	EXT	%RIB.C		003350'	EXT
RIBLST		002335'	EXT	STAWTU		003255'	EXT	UFDEXT		000000	EXT	%SAT		377000	SIN
RIBPFS		001164'	EXT	STODST		000521'		UFDNAM		000000	EXT	%SAT.C		000000	EXT
RIBRIB		000000	EXT	STOLMA		004031'	EXT	UFDSIZ		003360'	EXT	%UPLMA		000421'	EXT
RIBSFS		001166'	EXT	STOLMX		000523'	EXT	UFPERR		003366'	EXT	%UPLMX		000422'	EXT
RIBSIZ		000000	EXT	STOP1		000000	EXT	UNIPPU		000304'	EXT	%UPT		000000	EXT
RIBSLF		000000	EXT	STOSRC		000514'		UNISTR		000271'	EXT	%UPT.N		000000	EXT
RIBSTS		000000	EXT	STRDDB		000310'	EXT	UNLFIL		003541'	INT	%UPX		000000	EXT
RIPBDR		003327'	EXT	STRNAM		000000	EXT	UNLFL4		003556'		
RIPUFE		003271'	EXT	STRPPU		000312'	EXT	UNLFL6		003571'		
RNQ		003642'	EXT	STRSOM		003635'		UNLOT6		003610'		
RONDUP		001213'		STRUNI		000227'	EXT	UNLOUT		003606'		
S		000000	INT	STRUNM		000311'	EXT	UNTLEN		003342'	EXT	
S$DEBU		000003	SIN	SUPBEG		000315'	INT	UNTTBL		003343'	EXT	
S$DISK		000010	SIN	SUPBND		000303'	INT	UNYLUN		000252'	EXT	
S$ENTR	777777	777775	SIN	SUPOUT		000347'		UPDAC0		001432'	EXT	
S$EVEN		000006	SIN	SWAPIN	414000	000000		UPDAC2		002772'	EXT	
S$HALT	777777	777777	SIN	SWEEP		002216'		UPDADS		000000	EXT	
S$INFO		000005	SIN	SWEEP0		002226'		UPDDDB		002535'		
S$JOB		000002	SIN	SWEEP2		002251'		UPDDLP		002537'		
S$NAME		000000'	SPD	SWEEP3		002321'		UPTJOB		000000	EXT	
S$NONA		000000	SIN	SWEEP4		002342'		UPTLDC		000000	EXT	
S$PATC		000007	SIN	SWEEP5		002401'		UPTOFD		000000	EXT	
S$TEMP		000000	SPD	SWEEP6		002465'		USETST		002316'	EXT	
S$XCT	777777	777776	SIN	SWEP2A		002315'		UUYCPR		001014'	EXT	
SAT2ND		003463'	INT	SWEP3E		002277'		UUYCTG		000776'	EXT	
SATBAD		003414'	INT	SWEP42		002354'		UUYSVM		000775'	EXT	
SATBCT		003416'		SWEP44		002360'		VALID		001347'	EXT	
SATBRD		003415'	INT	SWEP46		002363'		VCLEAR	047000	777712		
SAVE4		003010'	EXT	SWEP47		002370'		VCREAT	047000	777711		
SETACH		002042'	EXT	SWEP54		002416'		VL.VPP		000000	EXT	
SETAFL		001024'		SWEP55		002431'		VL.WAT		000000	EXT	
SETARG		001007'	INT	SWEP56		002441'		VLIOE%		001536'	EXT	
SETARR		000774'	INT	SWEP57		002443'		VLNVP%		000000	EXT	
SETDST		000524'		SWEP58		002453'		VPADR		001527'		
SETLMA		003034'	EXT	SWEP63		002467'		VPMAX		001034	SIN	
SETLMX		000526'	EXT	SWEP64		002477'		VPUMAX		000000	EXT	
SETRUN		003644'	EXT	SWEP65		002505'		VREMOV	047000	777713		
SETSHR		000454'	EXT	SWEPD4		002526'		VUOFL0		000161'		
SIMCRE		001047'	INT	SWEPDN		002510'		VUOOUT		000164'	INT	
SMMPXC		002126'	EXT	SWEPHO		002215'	INT	W		000012	INT	
SPMUSC		003455'	EXT	SWEPPG		002215'	INT	W2PLSH	777777	777767	SPD	
SPPVIR		003524'	EXT	SWEPRH		002214'	INT	WATPCB		000772'	EXT	
SPRBN2		000305'		

MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88
MAPIO.MAC	28-OCT-87 17:02		Symbol cross reference

ALIASD	    68%	   577
ATBALP	    36%	  1026
ATBDUM	    34%	   956
ATBFNB	    35%	  2512	  2541	  2603	  3017	  3038
ATBLCW	    35%	  3007
ATBLOK	    34%	  3261	  3380	  3384
ATBMWC	    34%	  1349%	  1537	  3127	  3179	  3181	  3182
ATBRIB	    35%	  1017	  2970	  2981	  2997
ATBSIZ	    34%	  1022	  1225	  1227	  1301	  1764	  3014
ATBSTS	    35%	  1349%	  1377	  1454	  1541	  3027	  3131	  3185
ATMMWC	    34%	  1349%	  1538	  3128	  3178
ATPCRE	    36%	  3028
ATPDEL	    36%	  3029
ATPMXU	    35%	  1349%	  1540	  3130	  3184
ATPSUP	    36%	  3028
ATPUFE	    36%	  3006
ATSBLK	    35%	  1300
ATSWRD	    34%	  1300
ATYALP	    36%	  3009	  3013
ATYBSZ	    34%	   255	   819	  1192	  1199	  1294	  1349%	  1430	  1698	  1705	  1907	  2154	  2380
ATYWSZ	    34%	  2382
B2PLSH	   257	   821	  1203	  1211	  1296	  1432	  1708	  1716	  1909	  2468
CHGMAP	   339	   351	   354	   384#
CHGMP2	   387	   392#
CHGMP4	   394	   398#
CHKPV1	  1110	  1114#
CHKPVY	   221	   623	  1106#
CHKQTA	    47%	  1467	  2662
CLRCFL	  2768#
CLRCOW	  2678	  2723#
CLRCW4	  2759	  2771#
CLRCW6	  2775	  2779#
CNTRLC	  2655
CNVATB	    35%	  1349%	  1542	  3202
CNVVPN	  1605	  2190	  2193	  2197	  2740	  2751	  2755	  2765	  2783
CONTIG	  2180%	  2180
CPOPJ	    67%	   527	   580	   792	   801	   807	   949	   990	   992
CPOPJ1	    66%	   343	   479	   526	   586	   902	   971	  1033	  1074	  1090	  1113	  1274	  1568	  1711
	  1714	  1718	  1721	  1766	  1808	  1856	  1913	  1917	  2074	  2481	  2492	  2518	  2549	  2618
	  2698	  2786	  2854	  2873	  2895	  2913	  3170	  3209
CPRCOW	  1584
CPRRDW	   262	   670	  1087
CREA24	  1200	  1209#
CREA28	  1207	  1213	  1216#
CREA42	  1234	  1236	  1239#
CREA44	  1233	  1238	  1240#
CREAT2	  1191#
CREAT4	  1188	  1215	  1231#
CREFAL	  2663	  2692	  2702#
CREFL1	  2674	  2703#
CREFL4	  2657	  2705#
CREOUT	  1223	  1228	  1268	  1270#
CREPAG	  1256	  2266	  2304	  2366	  2651#
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88
MAPIO.MAC	28-OCT-87 17:02		Symbol cross reference

CREPDN	  2680	  2694#
CREPG1	  2652	  2659#
CREPG2	  2662#	  2691
CURUPT	    67%
DABBIT	  1349%
DEALMA	    62%
DECRMV	    56%
DECUMC	  1350%
DECUNS	  1350%	  1530
DECUPM	   500	   504#
DECUSE	    38%
DELCRE	  1240	  1789	  1845#
DELDHO	  1221	  1239	  1243	  1259	  1264	  1793	  1818#
DELXC2	  1888	  1892#
DELXC4	  1886	  1894#
DELXC5	  1896	  1898#
DELXCH	  1173	  1403	  1748	  1784	  1875#	  1937
DEPFLK	    21%	  2944	  3266	  3269	  3279	  3309	  3330	  3369	  3375	  3395
DEVATB	    21%	   252	   314	   816	  1016	  1021	  1191	  1224	  1293	  1350%	  1429	  1521	  1532	  1534
	  1697	  1750	  1904	  2151	  2379	  2509	  2536	  2538	  2545	  2600	  2607	  2670	  2688	  2738
	  2969	  2980	  2996	  3005	  3019	  3037	  3260	  3379
DEVBTS	    21%	  2943	  3265	  3268	  3278	  3310	  3312	  3329	  3376	  3378	  3394
DEVDBL	    22%	  2519	  2550	  2614	  3024
DEVDRB	    22%	  3010	  3031
DEVEXT	  2965	  3056
DEVFIL	  2963	  3055
DEVFLO	    22%	   850	   910	  1001	  1010	  2005	  2065	  2514	  2548	  2577	  2595	  2605	  2613	  3022
DEVIAD	   235	   452	   555	   569	   799	  1003	  1231	  1414	  1433	  1516	  1881	  2045	  2255	  2369
	  2610	  2866
DEVIOS	   246	   248	   300	   355	   585	   810	   812	   995	  1194	  1196	  1261	  1700	  1702	  1898
	  2273	  2309	  2673	  2911	  2948	  2950	  3023	  3070
DEVLOK	    21%	  2941	  3243	  3247	  3248	  3249	  3254	  3256	  3264	  3281	  3306	  3313	  3337	  3371
	  3386	  3397	  3402	  3403
DEVNAM	   573
DEVPPN	  2961
DEVRB1	    22%	  2261	  2302	  2333	  2358	  2472
DEVRBN	    21%	   839	  1246	  1350%	  1798	  1989	  1997	  2011	  2231	  2294	  2334	  2416	  2491	  2853
DEVRET	    21%	   303	   327	   834	   842	   896	  1245	  1266	  1350%	  1471	  1517	  1528	  1794	  1797
	  1800	  1850	  1855	  1990	  1998	  2012	  2059	  2232	  2253	  2260	  2268	  2269	  2295	  2301
	  2357	  2368	  2852
DEVRIB	    21%	  1006	  1847	  1979	  2000	  2006	  2014	  2021	  2032	  2056	  2057	  2061	  2236	  2507
	  2515	  2622	  2858	  2904	  2906	  2908	  2910	  2967
DEVSUP	    22%	   433	   484	   572	   583
DEVSZS	    22%	  2476	  2480
DEYRPS	    21%	   861	   881	   905	   907	  1244	  1350%	  1796	  1988	  1996	  2010	  2029	  2243	  2296
	  2331	  2339
DIE	    11	    11%	    12	   304	  3174
DLTTCI	  1741%	  1756
DLXDR0	  1241	  1790	  1813#	  2088	  2090
DLXDR1	  1198	  1812#
DOMVPG	  2195	  2211#
DRBALC	    28%	  3011
DRBRIB	    28%	  3032
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88
MAPIO.MAC	28-OCT-87 17:02		Symbol cross reference

ENTRB	   225	   236	   258	   292	   425	   791	   797	   989	   991	  1875	  1882	  2936
EXCDR1	  2008	  2078#
EXCDR3	  2004	  2016	  2086#
EXCDR4	  1973	  2088#
EXCDRB	  1981	  2080#
EXCH35	  1966	  1972#
EXCH73	  2054	  2058#
EXCH7A	  2060	  2064#
EXCHH3	  1966#
EXCHH6	  1974	  1996#
EXCHH7	  1992	  2041#
EXCHOT	  2062	  2067	  2068	  2070#
F	   225	   235	   236	   246	   248	   252	   258	   265	   292	   300	   303	   314	   327	   355
	   425	   433	   452	   484	   555	   569	   572	   573	   583	   585	   791	   797	   799	   810
	   812	   816	   834	   839	   842	   850	   896	   910	   989	   991	   995	  1001	  1003	  1006
	  1010	  1016	  1021	  1191	  1194	  1196	  1224	  1231	  1235	  1245	  1246	  1261	  1266	  1293
	  1368	  1400	  1414	  1429	  1433	  1464	  1465	  1471	  1516	  1517	  1521	  1528	  1532	  1534
	  1563	  1621	  1697	  1700	  1702	  1750	  1794	  1797	  1798	  1800	  1847	  1850	  1855	  1875
	  1881	  1882	  1898	  1904	  1979	  1989	  1990	  1997	  1998	  2000	  2005	  2006	  2011	  2012
	  2014	  2021	  2032	  2045	  2056	  2057	  2059	  2061	  2064	  2065	  2151	  2231	  2232	  2236
	  2253	  2255	  2260	  2261	  2268	  2269	  2273	  2294	  2295	  2301	  2302	  2309	  2326	  2330
	  2337	  2357	  2358	  2368	  2369	  2379	  2507	  2509	  2517	  2536	  2538	  2543	  2574	  2576
	  2595	  2597	  2600	  2603	  2604	  2605	  2607	  2610	  2613	  2614	  2615	  2616	  2622	  2624
	  2670	  2673	  2688	  2738	  2852	  2853	  2858	  2866	  2904	  2906	  2908	  2910	  2911	  2936
	  2941	  2943	  2948	  2950	  2961	  2963	  2965	  2967	  2969	  2980	  2996	  3005	  3010	  3031
	  3037	  3055	  3056	  3070	  3243	  3247	  3248	  3249	  3260	  3265	  3272	  3273	  3285	  3306
	  3310	  3312	  3313	  3318	  3320	  3332	  3371	  3376	  3378	  3379	  3384	  3386	  3402	  3403
FALALF	   181#	  1652
FALAQA	   156#	  1219	  1258	  1443	  1638	  2704
FALBDS	   116#	   316	   695	   963	  1657	  2746
FALCOR	   109#	  1121
FALCPL	   119#	   242	   266	   270	   457	   673
FALCPU	    87#	  1082	  1085
FALCTG	    80#	  1061
FALCTL	   159#	  2656
FALDVR	    83#	   944	  1072
FALFPZ	   106#	   223	   423	   803	  1180	  1645	  1914	  1939
FALHOL	   126#	   306	  1792
FALIPE	   162#	  2682	  2768
FALLGE	   172#
FALLKO	   123#	   239	   801
FALNEX	    94#	   665	   949	  1632
FALNHL	   129#	  1243	  1642
FALNIM	   169#	   807
FALNML	   144#	   426
FALNOF	   148#	   226	   566	   792	   990	  1876
FALNSE	   182#	  1630
FALNSP	   176#
FALNTF	   165#	   892
FALNWT	   153#	   992	  1239	  1667	  1883	  1892
FALOFF	   179#
FALOPE	   137#	  2683
FALPHP	   101#	   279	   337	   485	   488	   527	   823	  1918	  1942
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88
MAPIO.MAC	28-OCT-87 17:02		Symbol cross reference

FALRBE	   113#	   233	   250	   347	   795	   814	   997	  1220	  1263	  1444	  1635	  1758	  1815	  1879
	  1901	  2239	  2276	  2312	  2384	  2863	  3073
FALSAM	   140#	   644	  1945
FALSNM	   133#	   580
FALSVR	    97#	   633
FALVEX	    91#	   310	   465	   656
FBIT	    47%	  2669
FBITS	   966	  1487	  1513
FCREQ	  3225%	  3225	  3227%	  3227
FCWAIT	  3226%	  3226
FD2FNO	   611%	   620
FINDM	  2066	  2412	  2445	  2467#
FINDM1	  2473#	  2483
FINDM2	  2478	  2483#
FINDM4	  2475	  2485#
FLG.CC	  1255	  2132#	  2145	  2165	  2651
FLG.ER	  2131#	  2169	  2223	  2238	  2277	  2313	  2361	  2385	  2391	  2705
FLG.PG	  2130#	  2138	  2172	  2257	  2264	  2298	  2354	  2364
FLSHA2	  2605#	  2615
FLSHA3	  2613#	  2631
FLSHA4	  2606	  2609	  2614#
FLSHA5	  2612	  2622#
FLUSH	  1853	  1983	  2018	  2023	  2291	  2351	  2568#	  2629
FLUSH2	  2572#	  2578
FLUSHA	  2595#
FLWQ	    71%	  3408
FNBDBL	    40%	  2513	  2542	  2604	  3018
FNDAD2	  2543#	  2551
FNDAD4	  2537	  2544	  2547	  2550#
FNDADB	  2536#
FNDDD2	  2514#	  2520
FNDDD4	  2508	  2516	  2519#
FNDDDB	  2328	  2409	  2441	  2507#	  2572
FNYUFP	    40%	  3040
GETATB	    62%	   691	   955	  1351%	  1376	  1453	  1501	  1526
GETB	   265	  1235	  1465
GETCPA	  1351%	  1545
GETDPA	    62%	   679	   958	  1351%	  1476
GETLMA	    72%	   734%	   750	  1351%	  1525	  1582	  1591
GETLMX	   734%	   751
GETM2	    49%	  1970
GETRET	   324	  2360	  2852#
GETSAT	    46%	   961	  1351%	  1482	  3137
GETSPT	  1351%	  1506
GETSRC	   701	   748#
GINST	   899#	   899	   900	   969#	   969	   970	  1205#	  1205	  1206	  1383#	  1383	  1384	  1590#	  1590
	  1591
GIVPAG	    48%	  1806
GTCGSZ	    70%	  2804	  2830
INCUMC	    35%	  1352%	  1533	  3147	  3201
INCUPM	   478	   502#	   708
INCUSE	    38%
INSCHT	    56%
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88
MAPIO.MAC	28-OCT-87 17:02		Symbol cross reference

INSSPT	    56%	  3213
IOBDRB	    48%	   232	   249	   301	   794	   813	   996	  1197	  1262	  1352%	  1703	  1878	  1899	  2274
	  2310	  2912	  2939	  2951	  3016
IOBKTL	  2672
IOSUPR	    47%	   432	   584
ISCYLB	  2665%	  2665
ITMCHN	   218	   218%
J	   390	   399	   506	   556	   557	   564	   616	   650	   651	   951	   952	   964	   970	  1114
	  1968	  1969	  1971	  2799	  2800	  2801	  2807	  2809	  2828	  2832	  3271	  3274	  3286	  3317
	  3321	  3333	  3406	  3407	  3410
JBTMPC	    69%	   390	   391
JBTNAM	    71%	  2973
JBTSOT	    69%	  2807	  2808	  2832	  2833
JBTSTS	    67%	  2654
JBTUNM	    71%	  2975
JBTUPM	    69%	   399	   506	  1114
JBTWCT	    67%	  2801	  2802	  2828	  2829
JBYRPT	    68%	   558
JBYWPT	    68%	   561
JOB	    67%	   952	  1969	  2653	  2972	  2987	  3407
KEPPAG	    47%	  2671
KFCRE	  1167#
KFCRE1	  1176	  1178	  1180#
KFCRE2	  1175	  1179	  1181#
KFCREE	  1144	  1172#	  1172	  1912
KFDEL	  1783#	  1783	  1889
KFEXC	  1890	  1936#	  1936
KFFI42	   835#	   840
KFFI44	   836	   842#
KFFI64	   863	   887#
KFFIF2	   798	   803#
KFFIF4	   830#	   857	   888
KFFIF5	   841	   850#
KFFIF6	   872#	   877
KFFIFP	   791#
KFFMOT	   898#	   917
KFFMTD	   838	   896#
KFFMTR	   875	   905#
KFFNTF	   847	   855	   880	   886	   890#
KFILC4	   954	   958#
KFILC6	   957	   969#
KFILCK	   941#
KFTRN	  1743#	  1747	  1887	  1894
KFTRN1	  1752	  1762#
KILBUF	  2955	  3080#
KILF24	  2957	  2961#
KILF41	  2986	  2995#
KILF42	  2984	  2998#
KILF43	  2991	  2994	  2999#
KILF44	  3019#	  3025
KILF45	  3021	  3024#
KILF46	  3058#	  3061
KILF47	  3060#	  3065
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88
MAPIO.MAC	28-OCT-87 17:02		Symbol cross reference

KILF48	  3059	  3063#
KILF49	  3030	  3044	  3048	  3062	  3070#
KILFIL	   350	  1008	  1020	  1849	  2084	  2387	  2933	  2936#
KILFL2	  2945	  2955#
KILFL4	  2960	  2980#
KILOT4	  2952	  3072#
KILOUT	  2940	  3071#
KMAPP	   215	   218#
KMOV2N	  1455	  1465#
KMOV3A	  1500	  1506#
KMOV3B	  1504	  1507#
KMOV3C	  1503	  1511#
KMOV3N	  1466	  1497#
KMOVBF	  1361	  1363	  1645#
KMOVBR	  1420	  1470	  1635#
KMOVBS	  1483	  1655#
KMOVEE	  1373	  1632#
KMOVEX	  1562#
KMOVNA	  1416	  1437	  1667#
KMOVNH	  1417	  1423	  1450#
KMOVNV	  1380	  1388#
KMOVOQ	  1468	  1638#
KMOVP1	  1371#	  1394
KMOVP2	  1378	  1392#
KMOVP3	  1452#	  1561	  1596
KMOVP4	  1536	  1542#
KMOVP5	  1544	  1551#
KMOVP6	  1549	  1552#
KMOVPE	  1618#	  1633	  1665
KMOVPF	  1488	  1649#
KMOVPG	  1358#	  1402	  1911	  2212
KMOVPH	  1413	  1419#
KMOVSE	  1375	  1630#
KMOVVE	  1391	  1461	  1615#
KMOVXE	  1404	  1445	  1620#	  1636	  1639	  1643	  1653	  1658	  1668
KMVELK	  1660#
KMVMKP	  1509	  1574#
KMVNHO	  1473	  1641#
KREMOV	    62%
KREPL0	   638	   642#
KREPL1	   641	   647#
KREPLC	   614#
KREPNO	   618	   623#
KSMAPP	   421#
KVLRB4	  1002	  1005	  1016#
KVLRIB	   989#
LISTSN	     3	     6
LM3ATB	    59%	  1353%	  1551	  3203
LM3CUR	    58%	   261	   669	  1086	  1353%	  1583	  1585	  1592
LM3HDA	    59%	   476	   724	  3208
LM3SPT	    59%	   697	  3163	  3215
LMASRP	    72%	   475	   723	  3207
LMMCUR	    60%	   712
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88
MAPIO.MAC	28-OCT-87 17:02		Symbol cross reference

LMMERR	    60%
LMMEXS	    58%	   309	   464	   655	   664	   948	  1353%	  1372
LMMMXW	    60%	   323
LMMRDW	    60%	  2734
LMMSUP	    60%	   480
LMNCUR	    60%	   711
LMPACT	    60%	  1353%	  1543	  1586	  1593
LMPMXW	    58%	   241	   271	   295	   454	   455	   647	   667	   671	  1088	  1353%	  1535	  3125	  3176
LMPNER	    58%	   667
LMPREF	    58%	   312	   313	   467	   468	   658	   659	   660
LMPSHR	    58%	   702	  1353%	  3168
LMPSUP	    58%	   459	   667	   686	   953	  1353%	  1374
LMPVIR	    58%	   318	   468	   469	   667	  2734	  2737	  3217
LMYSPT	    60%
LOGLEN	  2958	  3079#	  3080
LOKHP1	  1706	  1713#
LOKHPW	  1419	  1697#
LOKLES	  1214	  1719	  3306#
LOKMOD	  1195	  1701	  1895	  2949	  3362	  3368#
LOKUM2	  3366	  3371#
LOKUM3	  3384#
LOKUM4	  3381	  3390#
LOKUM5	  3394#	  3401
LOKUM6	  3390	  3397#	  3400
LOKUM7	  3398	  3402#
LOKUNM	   247	   811	   994	  1897	  3362	  3364#
LOKUOT	  3405	  3413#
LOKUT4	  3387	  3412	  3415#
LOOKB	   225	   425	   791	   989	  1875	  2936
M	   223	   269	   278	   282	   326	   423	   440	   444	   470	   481	   482	   490	   525	   628
	   635	   640	   643	   661	   662	   663	   703	   714	   737	   740	   743	   748	   757	   760
	   825	   826	   831	   843	   844	   845	   850	   851	   852	   853	   854	   865	   884	   885
	   890	   897	   898	   899	   909	   916	   969	  1078	  1181	  1182	  1187	  1188	  1200	  1201
	  1205	  1206	  1212	  1237	  1273	  1297	  1299	  1360	  1361	  1362	  1365	  1406	  1407	  1408
	  1409	  1410	  1411	  1426	  1427	  1435	  1438	  1439	  1451	  1457	  1462	  1558	  1566	  1624
	  1706	  1710	  1717	  1786	  1787	  1807	  1813	  1818	  1949	  1950	  1962	  1963	  1986	  1987
	  1988	  1989	  1990	  1991	  2002	  2024	  2027	  2041	  2046	  2048	  2051	  2073	  2082	  2158
	  2161	  2162	  2163	  2168	  2171	  2188	  2194	  2207	  2221	  2224	  2225	  2342	  2376	  2469
	  2477	  2486	  2489
MAPCML	    49%	  1354%	  1479	  3135
MAPEND	  3620#
MAPF21	   260	   263	   277#
MAPF22	   285	   288#
MAPF34	   300#	   333
MAPF36	   328	   331#
MAPFAL	  3142	  3173#
MAPFI2	   237	   246#
MAPFI3	   292#
MAPFI5	   322	   336#
MAPFIL	   232#
MAPIO	    11	    12#	    15
MAPK21	  3135#	  3229
MAPK24	  3138	  3141#
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88
MAPIO.MAC	28-OCT-87 17:02		Symbol cross reference

MAPK26	  3139	  3154#
MAPKN2	  3126	  3134#
MAPKN3	  3150	  3163#
MAPKN4	  3168#	  3220
MAPKN6	  3159	  3189#
MAPKN7	  3148	  3192	  3212#
MAPKN8	  3214	  3222#
MAPKRN	   315	   694	  2741	  3125#
MAPLIT	  3420#
MAPRDU	    47%	   960
MAPRLS	    46%	  2897	  2995
MAPUS1	   434	   437#
MAPUS2	   439	   446	   452#
MAPUS4	   463#	   483	   491
MAPUST	   432#
MAPWTL	    48%	  2900	  2998	  3034	  3053
MAPWTU	    46%
MAPXCH	    48%
MATCH	   837	   874	   920#	   922
MATLEN	   806	   922#
MAXCPR	    59%	  1084
MBITS	  1484	  3191	  3195
MF.GHP	   209#	   284	   336
MF.USR	   208#	   289
MO.LAC	   218
MPFBRP	   304#
MPORB0	   330	   346#
MPORB1	   347	   351#
MPORBR	   325	   349#
MPROU1	   250	   266	   270	   279	   360#
MPROU2	   298	   302	   306	   310	   316	   337	   354#
MTR	   218
MWLRB3	  2893	  2899#
MWLRIB	  1007	  1019	  1848	  1980	  2007	  2015	  2237	  2623	  2859	  2889	  2891#
NODIE	    11%
NORED	    66%	   238	   554	   560	   565	   567	   800
NOWRT	    66%	   259	   294	   453	   554	   565	   567	  1232	  1354%	  1415	  1434	  1885
NXTPT0	    52%	  2869
ONESL2	  2441#	  2446	  2447	  2449
ONESLT	  1267	  1518	  1801	  2049	  2058	  2438#
OTFFLG	   611%	   617	   635	   636	   639	   640	   649	   652	   661	   738	   749	   755	   766	   770
P	    12	   219	   220	   221	   222	   247	   296	   297	   304	   315	   320	   324	   329	   332
	   339	   340	   341	   342	   346	   349	   350	   351	   354	   356	   357	   358	   359	   360
	   366	   367	   368	   370	   384	   385	   400	   421	   422	   435	   437	   477	   478	   507
	   556	   564	   568	   577	   579	   614	   615	   620	   623	   624	   677	   678	   679	   691
	   693	   694	   698	   701	   706	   707	   708	   716	   720	   725	   728	   729	   730	   739
	   741	   742	   744	   756	   758	   759	   761	   796	   804	   811	   825	   830	   831	   832
	   887	   890	   891	   898	   900	   901	   914	   945	   947	   951	   955	   958	   961	   962
	   964	   965	   968	   970	   994	  1007	  1009	  1019	  1028	  1029	  1032	  1076	  1077	  1095
	  1120	  1122	  1139	  1140	  1141	  1144	  1146	  1147	  1148	  1149	  1150	  1173	  1174	  1181
	  1183	  1193	  1195	  1201	  1214	  1218	  1240	  1247	  1256	  1257	  1260	  1267	  1269	  1270
	  1271	  1272	  1273	  1298	  1302	  1358	  1359	  1364	  1365	  1366	  1367	  1368	  1369	  1370
	  1371	  1376	  1379	  1381	  1390	  1392	  1393	  1395	  1396	  1400	  1401	  1403	  1405	  1406
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88
MAPIO.MAC	28-OCT-87 17:02		Symbol cross reference

	  1408	  1409	  1419	  1442	  1447	  1450	  1451	  1452	  1453	  1456	  1457	  1460	  1462	  1463	  1464
	  1467	  1469	  1474	  1476	  1478	  1482	  1489	  1490	  1497	  1498	  1501	  1502	  1506	  1511
	  1512	  1514	  1518	  1520	  1524	  1525	  1526	  1530	  1533	  1542	  1545	  1552	  1553	  1558
	  1559	  1560	  1562	  1563	  1564	  1565	  1566	  1567	  1574	  1575	  1576	  1577	  1578	  1579
	  1582	  1588	  1589	  1591	  1595	  1608	  1618	  1619	  1620	  1621	  1622	  1623	  1624	  1626
	  1627	  1641	  1647	  1649	  1650	  1651	  1655	  1656	  1660	  1661	  1662	  1663	  1664	  1699
	  1701	  1704	  1719	  1748	  1749	  1753	  1756	  1757	  1759	  1760	  1761	  1765	  1784	  1785
	  1786	  1788	  1789	  1794	  1801	  1802	  1803	  1804	  1805	  1806	  1807	  1812	  1813	  1814
	  1816	  1818	  1819	  1820	  1821	  1822	  1823	  1824	  1825	  1845	  1846	  1848	  1853	  1854
	  1877	  1880	  1884	  1893	  1895	  1897	  1900	  1902	  1903	  1910	  1937	  1938	  1949	  1967
	  1968	  1970	  1971	  1972	  1980	  1983	  1984	  1985	  1986	  1999	  2000	  2001	  2003	  2007
	  2009	  2013	  2015	  2018	  2019	  2023	  2024	  2025	  2026	  2030	  2033	  2048	  2049	  2051
	  2052	  2056	  2058	  2061	  2066	  2070	  2071	  2072	  2073	  2078	  2079	  2081	  2082	  2083
	  2086	  2087	  2089	  2140	  2141	  2142	  2161	  2167	  2168	  2171	  2184	  2185	  2186	  2187
	  2188	  2189	  2195	  2206	  2207	  2208	  2212	  2214	  2215	  2222	  2230	  2235	  2237	  2240
	  2242	  2253	  2266	  2278	  2280	  2283	  2284	  2291	  2292	  2304	  2326	  2328	  2337	  2340
	  2344	  2351	  2360	  2366	  2374	  2387	  2389	  2390	  2392	  2393	  2394	  2409	  2410	  2412
	  2438	  2441	  2443	  2444	  2445	  2470	  2487	  2521	  2552	  2572	  2573	  2575	  2596	  2597
	  2616	  2617	  2623	  2624	  2625	  2626	  2627	  2629	  2630	  2659	  2661	  2662	  2664	  2665
	  2671	  2675	  2678	  2689	  2690	  2695	  2696	  2697	  2702	  2703	  2706	  2724	  2725	  2739
	  2741	  2742	  2743	  2744	  2745	  2747	  2748	  2749	  2750	  2760	  2761	  2769	  2771	  2772
	  2779	  2799	  2803	  2804	  2805	  2809	  2810	  2830	  2834	  2855	  2856	  2857	  2859	  2860
	  2861	  2862	  2864	  2865	  2868	  2869	  2870	  2871	  2872	  2896	  2897	  2898	  2899	  2900
	  2905	  2907	  2908	  2910	  2938	  2946	  2947	  2949	  2995	  2998	  3003	  3034	  3049	  3050
	  3051	  3053	  3071	  3072	  3074	  3134	  3137	  3144	  3145	  3146	  3147	  3149	  3154	  3155
	  3156	  3158	  3160	  3174	  3175	  3177	  3183	  3186	  3189	  3190	  3199	  3200	  3201	  3202
	  3204	  3212	  3213	  3219	  3222	  3223	  3224	  3226	  3244	  3245	  3246	  3271	  3272	  3277
	  3283	  3285	  3286	  3287	  3288	  3289	  3308	  3314	  3315	  3316	  3317	  3318	  3319	  3320
	  3321	  3322	  3323	  3324	  3331	  3336	  3339	  3364	  3368	  3373	  3374	  3391	  3392	  3406
	  3410	  3411	  3413	  3414	  3415	  3416	  3417	  3418
P1	   264	   277	   281	   282	   283	   286	   296	   322	   386	   617	   630	   636	   639	   649
	   652	   710	   766	   770	   805	   806	   837	   874	   950	   967	   969	  1058	  1069	  1080
	  1141	  1147	  1255	  1366	  1565	  1583	  1592	  1623	  1951	  1962	  1963	  1985	  1987	  1991
	  2002	  2025	  2042	  2050	  2140	  2143	  2145	  2165	  2169	  2172	  2196	  2204	  2223	  2238
	  2239	  2257	  2264	  2276	  2277	  2298	  2312	  2313	  2354	  2361	  2362	  2364	  2383	  2385
	  2391	  2393	  2438	  2439	  2442	  2443	  2448	  2596	  2600	  2601	  2603	  2608	  2617	  2625
	  2651	  2656	  2704	  2705	  3364	  3365	  3368	  3369	  3377	  3390	  3400	  3404	  3412	  3417
P2	   268	   283	   284	   286	   287	   289	   336	   387	   479	   629	   709	   819	   820	   821
	   822	   845	   854	   864	   885	  1060	  1061	  1068	  1106	  1108	  1112	  1367	  1370	  1527
	  1564	  1622	  1750	  1764	  1958	  1959	  1966	  1974	  2054	  2060	  2080	  2088	  2141	  2148
	  2173	  2205	  2230	  2233	  2247	  2270	  2280	  2281	  2282	  2284	  2285	  2308	  2321	  2322
	  2324	  2341	  2370	  2375	  2388	  2390	  2418	  2419	  2659	  2660	  2691	  2697	  2703
P3	   241	   271	   295	   313	   318	   323	   454	   455	   459	   468	   469	   480	   647	   659
	   660	   668	   677	   686	   693	   702	   710	   711	   712	   720	   948	   953	  1079	  1088
	  1139	  1142	  1149	  1168	  1169	  1372	  1374	  1500	  1535	  1543	  1586	  1593	  2041	  2050
	  2053	  2069	  2142	  2278	  2279	  2296	  2297	  2306	  2307	  2318	  2319	  2321	  2323	  2338
	  2339	  2353	  2369	  2389	  2407	  2421	  2734	  2737	  3039	  3041	  3125	  3168	  3176	  3217
P4	   277	   288	   473	   474	   619	   721	   722	  1079	  1140	  1143	  1148	  1170	  1179	  1223
	  1234	  1268	  1587	  1594	  2042	  2046	  2047	  2059	  2187	  2208	  3169	  3205	  3206
PC.UIO	  1604
PCBPTR	    48%	  2894	  2985
PE.NER	    74%	  2751
PG	  2891	  2982	  2988	  3033	  3052
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88
MAPIO.MAC	28-OCT-87 17:02		Symbol cross reference

PGE.A	   474	   722	  3206
PGE.W	  1587	  1594
PGYATB	  1354%	  1546
PGYDIO	    38%
PGYDRT	    38%
PGYSIO	    38%
PGYSPT	  1354%	  1548
PGYUSE	    38%
PJBSTS	    67%	  3276	  3335	  3409
PJOBN	    67%	   557	  2800	  3274	  3333
PS.DER	    74%	  2758
PS.DTE	    74%	  2758
PTRCHG	    52%	  1004	  1515	  2044	  2254	  2353	  2611	  2867
PTRINN	    52%	   914	  2033	  2344
PTRLEN	    52%	   853	   913	  2332	  2471
PTROU0	    52%	  1009	  1854	  1984	  2292	  2575	  2627
PTROU2	    52%	  2868
PUUOAC	    66%
PVYCOR	    69%	  1116
PX.MEM	   899	   969	  1205	  1383	  1590
RBLVSP	    30%	  1954	  1956
RBMASK	    30%	   680	  1254	  2668	  3136	  3157
RBREAL	    30%	   305	   681	   920	   921	   959	  1242	  1254	  1354%	  1472	  1477	  1499	  1529	  1791
	  2666	  2668	  3043	  3136	  3143	  3228
RBYPNO	    30%
RBYUN1	    31%	  3045
RBYUNI	    30%	   472
REDLMA	    72%	   734%	   739	   947	  1355%	  1371	  1452	  1474	  1497
REDLMX	   734%	   742
REDSRC	   678	   737#
RELLOK	  1741%	  1760
RELM2	    49%	  2081	  2089
RELRB2	    46%	  1822	  2071	  2938
RELRIB	    46%	   332	   341	   358	   887	   891	   900	  1028	  1272	  1447	  1520	  1578	  1641	  1650
	  1656	  1661	  1804	  1821	  2001	  2070	  2184	  2630	  2909	  2914	  2946	  3003	  3050	  3071
RELSAT	    46%	   340	   346	   349	   357	   367	   717	   729	   962	   968	  1270	  1553	  1577	  1651
	  1662	  1814	  1823	  2083	  2185	  2743	  2750	  3223
REMCHT	    68%
REMMWS	    69%
REMSPT	    68%	  1355%
REMUWS	    68%
REMWAT	    68%
REPFAL	   656	   665	   673	   695	   728#
REPLC1	   652#	   715
REPLC2	   672	   677#
REPNXT	   705	   708#	   726
REPOUT	   709	   716#
REPSUP	   687	   720#
RIBALP	    32%	  1027
RIBCKD	    54%
RIBCON	    52%	  2907
RIBLCW	    31%	  3002
RIBLST	    30%	   862	   867	   879	   882	  2245
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88
MAPIO.MAC	28-OCT-87 17:02		Symbol cross reference

RIBPFS	    31%	  1249	  3042
RIBRIB	    31%	  1250
RIBSFS	    31%	  1251
RIBSIZ	    31%	  1025
RIBSLF	    30%	  2020	  2031	  2055
RIBSTS	    30%	  3000	  3036
RIPBDR	    31%	  2999	  3035
RIPUFE	    31%	  3001
RNQ	    67%	  3275	  3334
RONDUP	  1269	  1293#	  1802	  2052
S	   232	   246	   248	   249	   300	   301	   355	   432	   584	   585	   794	   810	   812	   813
	   995	   996	  1194	  1196	  1197	  1261	  1262	  1700	  1702	  1703	  1878	  1898	  1899	  2273
	  2274	  2309	  2310	  2672	  2673	  2911	  2912	  2939	  2948	  2950	  2951	  3070
S$DEBU	  3174	  3175
S$DISK	  1446	  1485
S$ENTR	    11	    17	   254	   305	   449	   621	   818	   846	   873	   915	   942	  1018	  1222	  1446
	  1485	  1531	  1539	  1617	  1851	  1906	  2034	  2043	  2147	  2153	  2199	  2345	  2484	  2511
	  2540	  2570	  2602	  2685	  2728	  2731	  2733	  2753	  2757	  2767	  2785	  2937	  2942	  3129
	  3166	  3175	  3180	  3307	  3311	  3372
S$EVEN	   304	  3174
S$HALT	    11	   254	   304	   449	   621	   818	   846	   873	   915	   942	  1018	  1222	  1446	  1485
	  1531	  1539	  1617	  1851	  1906	  2034	  2043	  2147	  2153	  2199	  2345	  2484	  2511	  2540
	  2570	  2602	  2685	  2728	  2731	  2733	  2753	  2757	  2767	  2785	  2937	  2942	  3129	  3166
	  3174	  3180	  3307	  3311	  3372
S$INFO	   304	  3174
S$JOB	   304	   305
S$NAME	    15#	   254	   449	   621	   818	   846	   873	   915	   942	  1018	  1222	  1446	  1485	  1531
	  1539	  1617	  1851	  1906	  2034	  2043	  2147	  2153	  2199	  2345	  2484	  2511	  2540	  2570
	  2602	  2685	  2728	  2731	  2733	  2753	  2757	  2767	  2785	  2937	  2942	  3129	  3166	  3180
	  3307	  3311	  3372
S$NONA	    14	    17	   254	   305	   449	   621	   818	   846	   873	   915	   942	  1018	  1222	  1446
	  1485	  1531	  1539	  1617	  1851	  1906	  2034	  2043	  2147	  2153	  2199	  2345	  2484	  2511
	  2540	  2570	  2602	  2685	  2728	  2731	  2733	  2753	  2757	  2767	  2785	  2937	  2942	  3129
	  3166	  3175	  3180	  3307	  3311	  3372
S$PATC	   304	  3174
S$TEMP	    11#	    11	   254#	   254	   304#	   304	   449#	   449	   621#	   621	   818#	   818	   846#	   846
	   873#	   873	   915#	   915	   942#	   942	  1018#	  1018	  1222#	  1222	  1446#	  1446	  1485#	  1485
	  1531#	  1531	  1539#	  1539	  1617#	  1617	  1851#	  1851	  1906#	  1906	  2034#	  2034	  2043#	  2043
	  2147#	  2147	  2153#	  2153	  2199#	  2199	  2345#	  2345	  2484#	  2484	  2511#	  2511	  2540#	  2540
	  2570#	  2570	  2602#	  2602	  2685#	  2685	  2728#	  2728	  2731#	  2731	  2733#	  2733	  2753#	  2753
	  2757#	  2757	  2767#	  2767	  2785#	  2785	  2937#	  2937	  2942#	  2942	  3129#	  3129	  3166#	  3166
	  3174#	  3174	  3180#	  3180	  3307#	  3307	  3311#	  3311	  3372#	  3372
S$XCT	    17	   254	   305	   449	   621	   818	   846	   873	   915	   942	  1018	  1222	  1446	  1485
	  1531	  1539	  1617	  1851	  1906	  2034	  2043	  2147	  2153	  2199	  2345	  2484	  2511	  2540
	  2570	  2602	  2685	  2728	  2731	  2733	  2753	  2757	  2767	  2785	  2937	  2942	  3129	  3166
	  3175	  3180	  3307	  3311	  3372
SAT2ND	  3174#
SATBAD	  3118	  3119#	  3141
SATBCT	  3121#	  3173
SATBRD	  3118	  3120#
SAVE4	  2723%	  2723
SETACH	    76%	  1183	  1354%	  1405	  1788	  1967
SETAFL	  1062	  1072	  1083	  1085	  1094#
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88
MAPIO.MAC	28-OCT-87 17:02		Symbol cross reference

SETARG	   219	   421	   614	  1076#
SETARR	  1058#	  1076	  1358
SETDST	   698	   725	   770#
SETLMA	    72%	   734%	   771	  2748
SETLMX	   212%	   320	   477	   734%	   772
SETRUN	    67%	  3277	  3336
SETSHR	    62%	   706
SIMCRE	  1137	  1139#
SMMPXC	    47%	  2009	  2019	  2026
SPMUSC	    42%	  1355%	  3165
SPPVIR	    42%	  3216
SPRBN2	   525#	   535
SPRBNS	   521	   531#
SPRBNU	   524#
SPTUSC	    42%	  1355%	  1507	  3164
SPTVIR	    42%	  3218
SRCCHT	    56%
SRCSPT	    56%	  1502	  3145	  3158
SRUNI	    68%	   579
STACML	    49%	  2992
STAWLN	    50%	  2993
STAWTL	    49%	  2990
STAWTU	    49%	  2989
STODST	   766#
STOLMA	    62%	   734%	   756	   767	  1355%	  1552	  1588	  1595
STOLMX	   734%	   759	   768
STOP1	    66%
STOSRC	   707	   755#
STRDDB	    26%	   441	   531	   576
STRNAM	    26%	   576
STRPPU	    26%	   443	   533
STRSOM	  3283	  3319	  3329#	  3338
STRUNI	    26%	   445
STRUNM	    26%	   532
SUPBEG	   435	   554#
SUPBND	   437	   521#
SUPOUT	   578	   584#
SWEEP	  2140#
SWEEP0	  2144	  2146	  2148#
SWEEP2	  2159	  2172#
SWEEP3	  2230#
SWEEP4	  2234	  2253#
SWEEP5	  2248	  2290#
SWEEP6	  2249	  2350#
SWEP2A	  2174	  2181	  2221#
SWEP3E	  2192	  2202#
SWEP42	  2264#	  2270
SWEP44	  2258	  2265	  2268#
SWEP46	  2267	  2273#
SWEP47	  2275	  2278#
SWEP54	  2304#	  2308
SWEP55	  2299	  2317#
SWEP56	  2305	  2311	  2314	  2326#
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88
MAPIO.MAC	28-OCT-87 17:02		Symbol cross reference

SWEP57	  2328#	  2335
SWEP58	  2329	  2337#
SWEP63	  2352#
SWEP64	  2355	  2360#	  2370
SWEP65	  2365	  2368#
SWEPD4	  2170	  2209	  2224	  2386	  2388#
SWEPDN	  2241	  2286	  2346	  2363	  2367	  2371	  2374#
SWEPHO	  2137#	  2167
SWEPPG	  1218	  2138#
SWEPRH	  1442	  2136#
T1	   223	   226	   233	   235	   238	   239	   242	   250	   259	   266	   270	   279	   294	   306
	   308	   309	   310	   312	   314	   316	   337	   347	   356	   359	   366	   368	   369	   423
	   426	   440	   443	   446	   452	   453	   457	   463	   464	   465	   467	   471	   472	   484
	   485	   488	   502	   504	   506	   524	   525	   527	   532	   533	   566	   573	   576	   580
	   628	   629	   631	   632	   633	   642	   643	   644	   653	   654	   655	   656	   658	   665
	   669	   670	   673	   695	   728	   730	   792	   795	   801	   803	   807	   814	   822	   823
	   826	   835	   864	   865	   866	   869	   870	   872	   892	   905	   908	   920	   921	   941
	   943	   944	   946	   949	   956	   960	   963	   966	   990	   992	   997	  1003	  1004	  1006
	  1016	  1017	  1022	  1023	  1024	  1025	  1026	  1027	  1058	  1061	  1072	  1080	  1082	  1085
	  1094	  1107	  1108	  1109	  1111	  1114	  1115	  1116	  1117	  1118	  1119	  1121	  1175	  1176
	  1177	  1180	  1182	  1192	  1209	  1217	  1219	  1220	  1225	  1226	  1227	  1239	  1243	  1258
	  1263	  1294	  1295	  1296	  1297	  1299	  1300	  1301	  1377	  1383	  1388	  1389	  1395	  1396
	  1414	  1415	  1423	  1433	  1434	  1441	  1443	  1444	  1454	  1458	  1459	  1479	  1484	  1487
	  1489	  1507	  1512	  1513	  1515	  1516	  1522	  1523	  1527	  1532	  1534	  1537	  1541	  1546
	  1547	  1548	  1551	  1575	  1590	  1602	  1603	  1605	  1607	  1615	  1616	  1625	  1630	  1632
	  1635	  1638	  1642	  1645	  1646	  1652	  1657	  1660	  1663	  1667	  1698	  1713	  1720	  1743
	  1744	  1746	  1751	  1754	  1757	  1758	  1787	  1792	  1796	  1797	  1798	  1799	  1815	  1819
	  1824	  1847	  1852	  1876	  1879	  1883	  1892	  1901	  1914	  1916	  1918	  1939	  1942	  1944
	  1945	  1950	  1952	  1956	  1957	  1979	  1982	  1996	  1997	  1998	  1999	  2006	  2010	  2011
	  2012	  2013	  2014	  2017	  2020	  2021	  2022	  2031	  2032	  2055	  2057	  2064	  2078	  2079
	  2086	  2087	  2144	  2146	  2164	  2166	  2190	  2191	  2193	  2196	  2197	  2198	  2202	  2204
	  2231	  2232	  2233	  2235	  2236	  2240	  2242	  2246	  2247	  2254	  2255	  2290	  2294	  2295
	  2297	  2327	  2330	  2333	  2334	  2350	  2362	  2374	  2375	  2376	  2377	  2378	  2380	  2381
	  2382	  2383	  2384	  2408	  2416	  2440	  2472	  2476	  2480	  2491	  2508	  2509	  2510	  2512
	  2513	  2514	  2515	  2517	  2519	  2520	  2537	  2538	  2539	  2541	  2542	  2543	  2545	  2548
	  2550	  2551	  2568	  2569	  2571	  2574	  2576	  2577	  2607	  2608	  2610	  2611	  2622	  2628
	  2653	  2654	  2655	  2669	  2676	  2681	  2682	  2683	  2686	  2694	  2724	  2726	  2727	  2732
	  2735	  2738	  2745	  2746	  2751	  2752	  2754	  2755	  2756	  2758	  2761	  2762	  2763	  2764
	  2765	  2766	  2768	  2772	  2773	  2774	  2776	  2777	  2778	  2779	  2780	  2781	  2782	  2783
	  2784	  2801	  2802	  2803	  2806	  2827	  2828	  2829	  2831	  2832	  2833	  2852	  2853	  2858
	  2863	  2866	  2867	  2894	  2896	  2898	  2899	  2901	  2904	  2905	  2906	  2943	  2944	  2955
	  2956	  2958	  2959	  2962	  2964	  2966	  2968	  2971	  2974	  2976	  2980	  2981	  2985	  2987
	  2988	  2989	  2990	  2992	  2993	  2996	  2997	  2999	  3000	  3001	  3002	  3006	  3007	  3009
	  3011	  3012	  3013	  3016	  3023	  3031	  3032	  3035	  3036	  3040	  3042	  3043	  3049	  3051
	  3055	  3058	  3066	  3067	  3073	  3127	  3131	  3134	  3135	  3144	  3146	  3154	  3156	  3164
	  3175	  3179	  3181	  3182	  3185	  3190	  3191	  3195	  3199	  3203	  3212	  3218	  3245	  3247
	  3250	  3254	  3256	  3260	  3261	  3263	  3264	  3265	  3266	  3268	  3269	  3275	  3276	  3278
	  3279	  3288	  3316	  3322	  3329	  3330	  3334	  3335	  3391	  3393	  3396	  3405	  3414
T2	   252	   253	   303	   305	   327	   388	   389	   390	   391	   392	   393	   394	   395	   397
	   444	   470	   473	   475	   476	   554	   555	   560	   563	   565	   567	   569	   680	   681
	   721	   723	   724	   805	   816	   817	   834	   835	   839	   840	   842	   843	   861	   862
	   868	   871	   872	   876	   879	   881	   883	   896	   897	   899	   906	   907	   916	   959
	  1021	  1022	  1026	  1078	  1081	  1082	  1084	  1086	  1087	  1106	  1111	  1112	  1113	  1115
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88
MAPIO.MAC	28-OCT-87 17:02		Symbol cross reference

	  1119	  1177	  1178	  1191	  1224	  1225	  1227	  1242	  1248	  1253	  1254	  1265	  1266	  1293	  1301
	  1360	  1429	  1471	  1472	  1477	  1478	  1498	  1499	  1514	  1517	  1521	  1528	  1529	  1576
	  1584	  1585	  1618	  1619	  1649	  1655	  1664	  1697	  1743	  1745	  1753	  1754	  1755	  1761
	  1762	  1763	  1764	  1791	  1795	  1799	  1800	  1805	  1850	  1855	  1903	  1904	  1905	  1910
	  1939	  1941	  1944	  1951	  1953	  1954	  1955	  2044	  2045	  2047	  2053	  2068	  2136	  2138
	  2143	  2151	  2152	  2194	  2215	  2216	  2256	  2259	  2262	  2269	  2300	  2303	  2306	  2317
	  2318	  2331	  2332	  2333	  2334	  2352	  2356	  2359	  2368	  2379	  2414	  2439	  2442	  2447
	  2472	  2473	  2474	  2479	  2480	  2488	  2507	  2515	  2536	  2546	  2661	  2664	  2666	  2667
	  2668	  2675	  2688	  2696	  2702	  2805	  2806	  2807	  2808	  2855	  2862	  2872	  2892	  2894
	  2961	  2962	  2963	  2964	  2965	  2966	  2967	  2968	  2969	  2970	  2971	  2973	  2974	  2975
	  2976	  2983	  2985	  3005	  3007	  3014	  3017	  3020	  3027	  3028	  3029	  3037	  3038	  3039
	  3041	  3045	  3046	  3047	  3054	  3061	  3136	  3143	  3157	  3200	  3204	  3205	  3207	  3208
	  3219	  3222	  3224	  3228	  3374	  3379	  3380	  3384	  3397	  3398	  3399	  3408	  3409	  3415
T3	   261	   262	   384	   385	   386	   388	   395	   396	   397	   398	   399	   558	   559	   561
	   562	   799	   800	   867	   868	   869	   870	   877	   882	   883	   884	   906	   908	   909
	   913	   966	  1067	  1068	  1070	  1071	  1167	  1172	  1199	  1202	  1203	  1204	  1205	  1206
	  1209	  1210	  1211	  1212	  1231	  1232	  1244	  1245	  1246	  1247	  1252	  1253	  1257	  1260
	  1265	  1402	  1430	  1431	  1432	  1435	  1438	  1484	  1487	  1490	  1507	  1508	  1511	  1513
	  1523	  1574	  1705	  1707	  1708	  1709	  1710	  1713	  1715	  1716	  1717	  1747	  1783	  1887
	  1889	  1890	  1894	  1911	  1912	  1936	  1955	  1957	  2065	  2069	  2243	  2244	  2245	  2246
	  2260	  2261	  2262	  2301	  2302	  2303	  2357	  2358	  2359	  2417	  2420	  2421	  2422	  2448
	  2467	  2468	  2469	  2476	  2477	  2479	  2485	  2486	  2489	  2490	  2491	  2514	  2545	  2546
	  2548	  2670	  2677	  2687	  2725	  2729	  2730	  2732	  2736	  2744	  2760	  2771	  2778	  2856
	  2861	  2871	  2972	  2973	  2975	  3019	  3020	  3056	  3063	  3064	  3149	  3155	  3164	  3165
	  3189	  3191	  3195	  3216	  3218	  3246	  3248	  3254	  3255	  3256	  3261	  3262	  3264	  3268
	  3273	  3278	  3281	  3282	  3287	  3308	  3309	  3310	  3312	  3313	  3314	  3323	  3329	  3332
	  3337	  3338	  3373	  3375	  3376	  3378	  3380	  3381	  3385	  3386	  3394	  3397	  3399	  3402
	  3403	  3416
T4	   255	   256	   257	   269	   278	   281	   662	   663	   664	   667	   668	   671	   697	   910
	   911	   912	   913	  1187	  1216	  1237	  1249	  1251	  1252	  1407	  1411	  1426	  1439	  1440
	  1537	  1538	  1540	  1541	  1751	  1881	  1885	  1907	  1908	  1909	  1916	  1941	  2027	  2028
	  2029	  2030	  2148	  2154	  2155	  2156	  2157	  2158	  2162	  2163	  2319	  2320	  2323	  2340
	  2341	  2342	  2343	  2388	  2416	  2417	  2418	  2419	  2420	  2422	  2471	  2483	  2485	  2568
	  2577	  2723	  3010	  3011	  3017	  3018	  3019	  3022	  3023	  3024	  3025	  3057	  3058	  3060
	  3063	  3064	  3067	  3068	  3127	  3128	  3130	  3131	  3141	  3163	  3178	  3179	  3182	  3184
	  3185	  3215	  3392	  3394	  3395	  3413
TIMADJ	    71%
TITO	  2134#	  2135	  2137
TSTVIR	  1355%	  1379
U	   433	   439	   441	   443	   445	   447	   448	   482	   487	   488	   521	   524	   531	   532
	   533	   534	   574	   583	  2857	  2860	  2865
UFDALP	    64%	  3068
UFDERR	    64%	  3067
UFDEXT	    64%	  3063	  3064
UFDNAM	    64%	  3058
UFDSIZ	    64%	  3054	  3060
UFPERR	    64%	  3066
UNIPPU	    24%	   482	   524
UNISTR	    24%	   447	   487
UNLFIL	   342	   360	   814	   823	   892	   901	   997	  1029	  1180	  1193	  1271	  1562	  1579	  1620
	  1699	  1765	  1803	  1812	  1820	  1900	  1915	  1919	  1940	  1943	  1946	  2072	  2186	  2947
	  3072	  3241	  3243#
UNLFL4	  3251	  3260#
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88
MAPIO.MAC	28-OCT-87 17:02		Symbol cross reference

UNLFL6	  3267	  3271#
UNLOT6	  3255	  3257	  3262	  3270	  3287#
UNLOUT	  3280	  3282	  3285#
UNTLEN	    24%	  3046
UNTTBL	    24%	  3047
UNYLUN	    24%	   471
UPDAC0	  1356%	  1524
UPDAC2	    70%	  2689
UPDADS	    46%
UPDDDB	  2283	  2407#
UPDDLP	  2409#	  2413	  2414	  2423
UPTJOB	    72%	   616	   650	   651	  1356%
UPTLDC	    70%	   704
UPTOFD	   611%	   619
USETST	    52%	   297	   329	   830	  1469	  1845	  1972	  2003	  2222
UUYCPR	    44%	  1081
UUYCTG	    44%	  1060
UUYSVM	    44%	  1059
VALID	  1356%	  1390	  1460
VL.VPP	  1356%	  1389	  1459
VL.WAT	    70%	  1356%	  1459
VLIOE%	    70%	  1356%	  1616
VLNVP%	    70%
VPADR	  1381	  1589	  1602#
VPMAX	   632	  1071
VPUMAX	    66%
VUOFL0	   366#
VUOOUT	   224	   226	   233	   239	   242	   352	   361	   369#	   424	   426	   436	   438	   457	   465
	   486	   489	   633	   644	   731
W	   308	   321	   369	   392	   463	   483	   491	   505	   642	   653	   654	   703	   715	   737
	   738	   740	   743	   748	   749	   755	   757	   760	   946	  1059	  1067	  1094	  1107	  1364
	  1369	  1388	  1392	  1401	  1450	  1456	  1458	  1463	  1559	  1567	  1602	  1625	  1626	  1646
	  2189	  2206	  2739	  2740	  2742	  2749
W2PLSH	  1744
WATPCB	    49%	  1032
WRTCHG	  2695	  2797	  2799#
WRTCHP	  2825	  2827#
WSCHED	    66%	  3411
ZZ	   899#	   899	   969#	   969	  1205#	  1205	  1383#	  1383	  1590#	  1590
ZZ1	   899#	   899	   969#	   969	  1205#	  1205	  1383#	  1383	  1590#	  1590
%COW	    70%	  2754	  2773	  2776	  2778
%COW.N	    70%	  2190	  2193	  2197	  2740	  2751	  2755	  2765	  2783
%CTSTS	    47%	  2988
%CTUPT	    48%	   331	   856	  2892	  2983
%RB2	  2011	  2055
%RB2.C	    49%
%RIB	   872	  1025	  1027	  1250	  1253	  1265	  1799	  1989	  1997	  2020	  2028	  2031	  2306	  2318
	  2319	  2323	  2332	  2901	  3000	  3002	  3036	  3042	  3058	  3063	  3064	  3067	  3068
%RIB.C	    48%	   331	   856	  2891	  2892	  2982	  2983	  3033	  3052
%SAT	   966	  1484	  1487	  1513	  3191	  3195
%SAT.C	    46%
%UPLMA	    69%	   653	   662
%UPLMX	   212%	   308	   463	   611%	   654	   663
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88
MAPIO.MAC	28-OCT-87 17:02		Symbol cross reference

%UPT	    69%	   616	   619	   650	   704	  1356%
%UPT.N	    69%
%UPX	   611%	   651
MAPIO	MAPPED IO ROUTINES	MACRO 12.5-46.0 14:29 13-JAN-88
MAPIO.MAC	28-OCT-87 17:02		Macro/Opdef cross reference

FALERR	   184#	   226	   233	   239	   242	   250	   266	   270	   279	   306	   310	   316	   337	   347
	   426	   457	   465	   527	   580	   633	   644	   656	   665	   673	   695	   792	   801	   807
	   814	   823	   892	   949	   990	   992	   997	  1072	  1085	  1180	  1239	  1243
NOCHAR	   218
PAGSTS	  2756
PERSET	  2752
PFALL	  2371
PJRST	   717	   750	   751	   767	   768	   771	   772	  1008	  1020	  1849	  2084	  2090	  2908	  2909
	  2914
PRINTF	   442	   530	   575	  1695
PXCT	   899	   969	  1205	  1383	  1590
PXGEN	   899	   969	  1205	  1383	  1590
STOPCD	    10	   254	   304	   449	   621	   818	   846	   873	   915	   942	  1018	  1222	  1446	  1485
	  1531	  1539	  1617	  1851	  1906	  2034	  2043	  2147	  2153	  2199	  2345	  2484	  2511	  2540
	  2570	  2602	  2685	  2728	  2731	  2733	  2753	  2757	  2767	  2785	  2937	  2942	  3129	  3166
	  3174	  3180	  3307	  3311	  3372
SWAPIN	  2754	  2901
UMOVE	  1383
UMOVEM	   899	   969	  1205
VCLEAR	  2198
VCREAT	  2191
VREMOV	  2766	  2784
XCTBU	  1590
XCTFU	  1383
XCTTU	   899	   969	  1205
$END	  3420    +3X
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 1
S.MAC	13-JAN-88 11:55		S.MAC - with system parameter file for P035/D, January 1988

     1				SUBTTL	S.MAC - with system parameter file for P035/D, January 1988
     2
     3				IF2,<IFNDEF LISTSN,<TAPE>>	;Skip to PASS2 in all but COMMON.LST
     4				;THIS MODULE ASSEMBLED WITH KL-10 PARAMETER FILE - KLSYM.MAC
     5
     6					IF2,<IFNDEF LISTSN,<		;LIST KLSYM.MAC IN COMMON ONLY
     7								TAPE>>
     8				TITLE REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE
     9
    10				ENTRY	REFRSH,PAKREF,SCNBAT	;Main entry points
    11				ENTRY	TSTSUP,PREAD,PWRITE	;Debugging/maintenance routines
    12				INTERN	REFSTT,REFLNR,REFLNP	;Start of phased code, lengths
    13				INTERN	RANNO			;Set at GETRAN in ONCDSK
    14
    15				EXTERN RIBALP,RIBCOD,RIBUNM,RIBRPS,RBYPNO,RBYUNI,RIBUN1
    16				EXTERN RIBEXT,RIBNAM,RIBPPN,RIBQTF,RIBQTO,RIBSIZ,RIBPVW
    17				EXTERN RIBSLF,RIBSTS,RIBUSD,RIBVER,RIPDIR,RIPNDL,RIPNFS
    18				EXTERN RIBLST,RIBSNM,RIBSFS,RIBRIB,CODRIB
    19				EXTERN RBREAL,RIBSZS,RIBPFS,RBLVPR,RBLVSP,RIBMXA,RBSPAR,RIBPRV
    20
    21				EXTERN UNISTT,UNISTR,UNIPPU
    22				EXTERN UNYPPY,UNYSPU,UNYLUN
    23
    24				EXTERN HOMREF,HOMHSH,HOMRAN
    25
    26				EXTERN STRREF,STRP4C,STRUNI,STRUNM,STRHSH,STRDDB,STRBTS
    27
    28				EXTERN STTAOB,STTLEN,STTPTR,STTFPC,STTSTS
    29
    30				EXTERN %HOM.P,%HMR.P,%STR.P,%STA.P,%BAT.P,%TMP.P,%T2P.P
    31
    32				EXTERN CPOPJ1,REFLAG,SAVT,MFDRIB,CORZER,CORONZ
    33				EXTERN RIBEX1,RIBEX2,RIBEX3,RIBEX4
    34				EXTERN BATFIR,BAYNBB,BATNBB,BATELB,FSFPPN
    35				EXTERN OPAGIN,OPAGOT,WTBOTH,GETBAT,GETHOM
    36				EXTERN SAVE1,SAVE4,OCONM,OPOUT,CONMES
    37				EXTERN UNTTBL,UFDHSI
    38
    39
    40				IFNDEF FTSPAG,<XP FTSPAG,-1>	;; -1 == FT Spare Pages on CYL 1 and 2
    41
    42	000000'			REFSTT:
    43	770000			PHASE %REF
    44		777777	010000'		%R==REFSTT-REFSTR	;To look at LABEL, use LABEL+%R
    45
    46					STOPCD(,ENTRY,REFSTR)^
    47					ENTRY	REFSTR		;For library searches
    48	000000'	260040	000000*	REFSTR::PUSHJ	P,DIE		;**** Default stopcode for "REFSTR" ****
    49	000001'	624546	636462		SIXBIT	/REFSTR/  	;Title of module
    50	000002'	000000	000000		S$NONAME,,0		;?NONAME stopcode "REFSTR+nnn(nnnnnn)"
    51			770000	S$NAME==REFSTR			;For STOPCDs with no arguments
    52					SALL>
    53				^
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 2
REFSTR.MAC	20-NOV-87 22:23		REFSTR definitions

    54				SUBTTL	REFSTR definitions
    55
    56				;QUOTAS FOR UFD'S WE CREATE
    57
    58		377777	777777	ND QF,377777777777	;FIRST COME, FIRST SERVED QUOTA.
    59		377777	777777	ND QO,377777777777	;LOGGED OUT QUOTA.
    60	000003'	377777	777777	QUOTAF: EXP QF		;To patch this in SAV file, use QUOTAF+%R/
    61	000004'	377777	777777	QUOTAO: EXP QO
    62
    63				;SOME DEFINITIONS FOR HOME AND BAT PAGES AND BOOTS AND SAT.SYS RIB:
    64				;(ALL MUST BE IN THE 1ST SAT ON THE UNIT.).
    65
    66			000000	XP LPN000,0		;Page 0 is reserved (has TOPS-10 HOM block on KS2020)
    67			000001	XP LPNHOM,1		;Logical page # of first HOME page
    68			000002	XP LPNBAT,2		;  "       "    of first BAT page
    69			000003	XP FBOOTB,3		;First BOOTS page (see BOTLOD and MONBTS)
    70			000003	XP NBOOTP,3		; # of pages reserved for BOOTS (pages 3,4,5)
    71			000006	XP LP2HOM,6		;Logical page # of second HOME page
    72			000007	XP LP2BAT,7		;  "       "    of second BAT page
    73			000010	XP LPNSAT,10		;  "       "    of RIB to SAT.SYS
    74							;1st SAT page is 11 on DSKB0, page 10 on all others
    75
    76				IFN FTSPAG,<		;The size of a cylinder depends on the type of disk
    77				; XP LPNSPG,<CYL*1>	;START OF SPARE PAGES AREA (CYL 1 & 2)
    78				; XP SPGLEN,<CYL*2>	;LENGTH IN PAGES OF SPARE PAGES AREA
    79				> ; End IFN FTSPAG
    80
    81				IFCPU(KS),< XP FEFLEN,100 >	;LENGTH IN PAGES OF FE FILE AREA
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 3
REFSTR.MAC	20-NOV-87 22:23		REFSTR definitions

    82				DEFINE MSGDIE (A)
    83				<PUSHJ P,[MOVEI T1,A
    84					PUSHJ P,OCONM
    85					PUSHJ P,OPOUT
    86					STOPCD ()]>
    87
    88				DEFINE MSGSFE (A)
    89				<PUSHJ P,[MOVEI T1,A
    90					PUSHJ P,OCONM
    91					PUSHJ P,OPOUT
    92					MOVEI T1,SOFERR;;CALL PDP-10 OPERATING SYSTEMS GROUP
    93					PUSHJ P,OCONM
    94					PUSHJ P,OPOUT
    95					STOPCD ()]>
    96
    97				DEFINE MSGLIV (A)
    98				<PUSHJ P,[MOVEI T1,A
    99					PUSHJ P,OCONM
   100					PUSHJ P,OPOUT
   101					POP  P,(P);;Dump most recent PUSHJ return address
   102					POPJ P,]>
   103
   104	770005			IOFAL:	ASCIZ /
   105	000005'	064250	551244	ERROR ON DISK TRANSFER.
	000006'	476444	047634
	000007'	202111	151626
	000010'	202512	240634
	000011'	516150	551134
   106	000012'	064240	000000	/
   107
   108	770013			OGTPG: ASCIZ /
   109	000013'	064251	752650	OUT OF ROOM ON DISK.
	000014'	202370	620244
	000015'	476371	520236
	000016'	471010	444646
   110	000017'	455341	505000	/
   111
   112	770020			BATBAD:	ASCIZ /
   113	000020'	064250	240650	BAT PAGE CONSISTENCY ERROR.
	000021'	202410	143612
	000022'	202071	747246
	000023'	446472	442634
	000024'	416624	042644
	000025'	512372	227032
   114	000026'	050000	000000	/
   115
   116	770027			RBNOUT:	ASCIZ /
   117	000027'	064251	752650	OUT OF RETRIEVAL POINTER SPACE IN NON-EXTENDED FILE.
	000030'	202370	620244
	000031'	426512	244612
	000032'	532031	420240
	000033'	476231	652212
	000034'	511012	350202
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 3-2
REFSTR.MAC	20-NOV-87 22:23		REFSTR definitions

	000035'	416124	044634
	000036'	202351	747132
	000037'	426612	442634
	000040'	422130	420214
	000041'	446310	527032
   118	000042'	050000	000000	/
   119
   120	770043			RBEOUT:	ASCIZ /
   121	000043'	064251	752650	OUT OF RETRIEVAL POINTER SPACE IN EXTENDED FILE.
	000044'	202370	620244
	000045'	426512	244612
	000046'	532031	420240
	000047'	476231	652212
	000050'	511012	350202
	000051'	416124	044634
	000052'	202133	052212
	000053'	472110	542100
	000054'	432231	442534
   122	000055'	064240	000000	/
   123
   124	770056			UFDERR:	ASCIZ /
   125	000056'	064251	752650	OUT OF ROOM IN A ONE PAGE UFD.
	000057'	202370	620244
	000060'	476371	520222
	000061'	471010	120236
	000062'	472124	050202
	000063'	436124	052614
   126	000064'	421341	505000	/
   127
   128	770065			NOTAVL:	ASCIZ /
   129	000065'	064252	242646	RESERVED PAGE HAS ALREADY BEEN ALLOCATED.
	000066'	426452	642610
	000067'	202410	143612
	000070'	202210	151500
	000071'	406312	242602
	000072'	422624	041212
	000073'	426344	040630
	000074'	462370	340650
   130	000075'	426105	606424	/
	000076'	000000	000000
   131
   132	770077			RIBFAL:	ASCIZ/
   133	000077'	064250	640652	FAULTY RIB STRUCTURE.
	000100'	462513	120244
	000101'	446044	051650
	000102'	512530	352252
   134	000103'	512125	606424	/
	000104'	000000	000000
   135
   136	770105			SOFERR:	ASCIZ /
   137	000105'	064252	347614	SOFTWARE ERROR.
	000106'	522570	151212
	000107'	202132	251236
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 3-3
REFSTR.MAC	20-NOV-87 22:23		REFSTR definitions

   138	000110'	511341	505206	CALL PDP-10 OPERATING SYSTEMS GROUP.
	000111'	406311	420240
	000112'	422405	530540
	000113'	202372	042644
	000114'	406511	147216
	000115'	202473	151650
	000116'	426332	320216
	000117'	512372	550134
   139	000120'	064240	000000	/
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 4
REFSTR.MAC	20-NOV-87 22:23		REFRSH - Refresh a complete file structure

   140				SUBTTL	REFRSH - Refresh a complete file structure
   141				;ARGS	P2=ADDR OF STR DATA BLOCK
   142				;	F=ADDR OF DDB
   143
   144	000121'	265440	000000*	REFRSH::JSP	T4,SAVE4	;SAVE PERMANENT ACS
   145	000122'	554255	000000*		HLRZ	U,STRUNI(P2)	;U=ADDR OF FIRST UNIT IN STR
   146	000123'	202240	772161		MOVEM	U,FSTUNI	;REMEMBER FIRST UNIT.
   147	000124'	402000	772162		SETZM	REFUNI		;Not doing PAKREF
   148	000125'	402000	772120		SETZM	R.ZERB		;ZERO OUT LOCS RECORDING FIRST PAGE NOS.
   149	000126'	200300	772171		MOVE	T1,[XWD R.ZERB,R.ZERB+1] ;NEVER ON PAGE 0 SO WE KNOW
   150	000127'	251300	772135		BLT	T1,R.ZERE	;IF REALLY SET UP.
   151	000130'	402000	772164		SETZM	SATDSK		;MARK NO SAT IN CORE IN %STA.
   152
   153				;SET UP RIB IN CORE FOR HOME.SYS.
   154
   155	000131'	200300	772102		MOVE	T1,HOMFIL	;NAME OF HOME.SYS FILE
   156	000132'	200340	772111		MOVE	T2,HOMEXP	;Extension and protection
   157	000133'	200400	000000*		MOVE	T3,SYSPPN	;IN SYS UFD
   158	000134'	201440	752000		MOVEI	T4,%HMR		;PNTR TO HOME.SYS RIB IN CORE.
   159	000135'	201740	000000*		MOVEI	P4,RIPNDL!RIPNFS ;NO DELETE, NO FAILSAFE BITS
   160	000136'	260040	772022		PUSHJ	P,RIBSET	;SET UP RIB FOR HOME.SYS.
   161	000137'	505300	000000*		HRLI	T1,-RBLVPR-1	;SET UP AOBJN WORD TO
   162	000140'	541300	751777*		HRRI	T1,%HMR+RIBPFS-1
   163	000141'	202300	772145		MOVEM	T1,HOMRBP	;RETREVIAL AREA.
   164
   165				;SET UP RIB IN CORE FOR SAT.SYS.
   166
   167	000142'	200300	772103		MOVE	T1,SATFIL	;NAME OF SAT.SYS FILE
   168	000143'	200340	772112		MOVE	T2,SATEXP	;Extension and protection
   169	000144'	200400	000133*		MOVE	T3,SYSPPN	;IN SYS UFD
   170	000145'	201440	750000		MOVEI	T4,%STR		;PNTR TO SAT.SYS RIB IN CORE.
   171	000146'	201740	000000*		MOVEI	P4,RIPNDL!RIPNFS ;NO DELETE, NO FAILSAVE BITS
   172	000147'	260040	772022		PUSHJ	P,RIBSET	;SET UP RIB FOR SAT.SYS.
   173	000150'	505300	000000*		HRLI	T1,-RBLVPR-1	;SET UP AOBJN WORD TO
   174	000151'	541300	747777*		HRRI	T1,%STR+RIBPFS-1
   175	000152'	202300	772146		MOVEM	T1,SATRBP	;RETREVIAL POINTER AREA+1.
   176
   177				;SPAGES.SYS is set up later
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 5
REFSTR.MAC	20-NOV-87 22:23		REFRSH - Refresh a complete file structure

   178				;HERE IS THE LOOP FOR EACH UNIT IN THE STR.
   179
   180	000153'	260040	000000*	NXUNIT:	PUSHJ	P,GETBAT	;READ BAT PAGE(S).
   181	000154'	254000	770427		  JRST	REFFAL
   182	000155'	260040	771041		PUSHJ	P,SATCLC	;SET BEGSAT, SVSBTL, LPGSAT, AND SATIND.
   183
   184				;HERE IS THE LOOP FOR EACH SAT ON THE UNIT.
   185
   186	000156'	260040	770672	NXTSAT:	PUSHJ	P,INISAT	;Reserve special pages, build RIB to SAT.SYS
   187	000157'	254000	770427		  JRST	REFFAL		; and RIB to HOME.SYS
   188
   189	000160'	260040	771021		PUSHJ	P,NXCLC		;ANOTHER SAT FOR THIS UNIT?
   190	000161'	254000	770156		  JRST	NXTSAT		;YES, GO DO IT.
   191
   192	000162'	554245	000000*		HLRZ	U,UNISTR(U)	;NEXT UNIT IN STR.
   193	000163'	326240	770153		JUMPN	U,NXUNIT	;LOOP FOR ALL UNITS IN STR.
   194
   195				;HERE AFTER ALL SATS ON ALL UNITS ARE WRITTEN.
   196
   197	000164'	200240	772161		MOVE	U,FSTUNI	;RESET TO FIRST UNIT IN STR
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 6
REFSTR.MAC	20-NOV-87 22:23		REFRSH - Refresh a complete file structure

   198				;WRITE RIBS FOR SAT.SYS AND HOME.SYS ON FIRST UNIT.
   199
   200				    ;WRITE RIB FOR SAT.SYS (IT IS PRE-ALLOCATED)
   201	000165'	201300	750000		MOVEI	T1,%STR		;Set RIBSIZ
   202	000166'	260040	772076		PUSHJ	P,CNVSIZ	;
   203	000167'	400340	000000		SETZ	T2,		;STORE THE EOF AND
   204	000170'	260040	771526		PUSHJ	P,SATRBS	;COUNT THE PRIME RIB IN ALP.
   205	000171'	201440	000010		MOVEI	T4,LPNSAT	;BUILD THE RETRIEVAL POINTER TO
   206	000172'	661440	000000*		TLO	T4,RBREAL	;THE SAT.SYS RIB AND
   207	000173'	202440	750000*		MOVEM	T4,%STR+RIBSLF	;STORE IT.
   208	000174'	202440	772130		MOVEM	T4,SATRBD	;REMEMBER LOGICAL PAGE NUMBER OF SAT.SYS RIB
   209	000175'	621440	000172*		TLZ	T4,RBREAL	;(U is set to first unit)
   210	000176'	201140	000000*		MOVEI	PG,%STR.P	;WRITE OUT THE RIB OF
   211	000177'	260040	000000*		PUSHJ	P,OPAGOT	;SAT.SYS (page 10 = RIB, page 11 = data)
   212	000200'	254000	770427		  JRST	REFFAL
   213	000201'	200300	750000*		MOVE	T1,%STR+RIBALP
   214	000202'	202300	772121		MOVEM	T1,SATALP	;# of pages allocated to SAT.SYS
   215
   216				    ;ALLOCATE AND WRITE RIB FOR HOME.SYS.
   217
   218	000203'	201300	752000		MOVEI	T1,%HMR		;Set RIBSIZ
   219	000204'	260040	772076		PUSHJ	P,CNVSIZ	;
   220	000205'	400340	000000		SETZ	T2,		;STORE THE EOF AND
   221	000206'	260040	771535		PUSHJ	P,HOMRBS	;COUNT THE PRIME RIB IN ALP.
   222	000207'	260040	771435		PUSHJ	P,OGETPG	;ALLOCATE A PAGE FOR HOME.SYS RIB.
   223	000210'	254000	770427		  JRST	REFFAL
   224	000211'	202340	752000*		MOVEM	T2,%HMR+RIBSLF
   225	000212'	202340	772127		MOVEM	T2,HOMRBD	;REMEMBER LOG. PAGE NUMBER OF RIB FOR HOME.SYS.
   226	000213'	135440	000000*		LDB	T4,RBYPNO	;PAGE NO. OF RIB.
   227	000214'	201140	000000*		MOVEI	PG,%HMR.P	;WRITE OUT THE RIB OF
   228	000215'	260040	000177*		PUSHJ	P,OPAGOT	;HOME.SYS (page 12)
   229	000216'	254000	770427		  JRST	REFFAL
   230	000217'	200300	752000*		MOVE	T1,%HMR+RIBALP	;
   231	000220'	202300	772120		MOVEM	T1,HOMALP	;# of pages allocated to HOME.SYS
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 7
REFSTR.MAC	20-NOV-87 22:23		REFRSH - Refresh a complete file structure

   232				;ALLOCATE SPACE FOR SPAGES.SYS - SPECIAL/SPARE PAGES CYL 1 & 2
   233
   234				IFN FTSPAG,<
   235	000221'	200240	772161		MOVE	U,FSTUNI	;USE FIRST UNIT FOR RIB
   236	000222'	200300	772105		MOVE	T1,SPGFIL	;NAME OF SPAGES.SYS FILE
   237	000223'	200340	772114		MOVE	T2,SPGEXP	;Extension and protection
   238	000224'	200400	000144*		MOVE	T3,SYSPPN	;IN SYS UFD
   239	000225'	201440	746000		MOVEI	T4,%TMP		;ADDRESS OF RIB IN MEMORY.
   240	000226'	201740	000000*		MOVEI	P4,RIPNDL!RIPNFS ;NO DELETE, NO FAILSAFE BITS
   241	000227'	260040	772022		PUSHJ	P,RIBSET	;SET UP RIB IN MEMORY.
   242
   243	000230'	505300	000000*		HRLI	T1,-RBLVPR-1	;SET UP AOBJN WORD
   244	000231'	541300	745777*		HRRI	T1,%TMP+RIBPFS-1 ; TO RETREVIAL
   245	000232'	202300	772150		MOVEM	T1,TMPRBP	; AREA FOR PTREXT.
   246
   247	000233'	260040	771435		PUSHJ	P,OGETPG	;Allocate page 13 for RIB to SPAGES.SYS
   248	000234'	254000	770427		  JRST	REFFAL
   249	000235'	202340	746000*		MOVEM	T2,%TMP+RIBSLF	;REMEMBER LOG. PAGE # OF RIB
   250	000236'	202340	772132		MOVEM	T2,SPGRBD	; FOR SPAGES.SYS IN HOM PAGE.
   251	000237'	135300	000000*		LDB	T1,UNYPPY	;GET # PAGES PER CYLINDER
   252	000240'	242300	000001		LSH	T1,1		; 2 cylinders each unit
   253	000241'	550705	000162*		HRRZ	P3,UNISTR(U)	; Up pointer to STR
   254	000242'	550716	000000*		HRRZ	P3,STRUNM(P3)	; Number of units on structure
   255	000243'	220300	000016		IMUL	T1,P3		;Calculate number of pages
   256	000244'	202300	746000*		MOVEM	T1,%TMP+RIBALP	;Set current pages
   257	000245'	350000	746000*		AOS	%TMP+RIBALP	; plus 1 for prime rib
   258	000246'	242300	000011		LSH	T1,P2WLSH	;Convert to words
   259	000247'	202300	746000*		MOVEM	T1,%TMP+RIBSIZ	;Store
   260
   261	000250'	402000	772166		SETZM	PGSRIB		;CLEAR # OF SPARE RIBS
   262	000251'	135300	000237*	SPGCRE:	LDB	T1,UNYPPY	;GET # PAGES PER CYLINDER	(REMEMBER
   263	000252'	210700	000006		MOVN	P3,T1		; NEGATE AND POSITION		 THESE WERE
   264	000253'	242700	000023		LSH	P3,^D<18+1>	; FOR AOBJN LENGTH (-n*2,,0)	 RESERVED
   265	000254'	540700	000006		HRR	P3,T1		;GET FIRST PAGE AS POINTER	 BY INISAT).
   266
   267	000255'	550300	000016	SPGCR1:	HRRZ	T1,P3		;GET THIS PAGE NEXT
   268	000256'	260040	771100		PUSHJ	P,MAKPAG	; CONVERT T1 TO RETRIEVAL POINTER
   269	000257'	260040	771642		PUSHJ	P,PTREXT	;PUT THE PAGE IN THE RIB
   270	000260'	254000	770427		  JRST	REFFAL
   271	000261'	253700	770255		AOBJN	P3,SPGCR1	;LOOP FOR ALL PAGES THIS UNIT
   272	000262'	554245	000241*		HLRZ	U,UNISTR(U)	;ANOTHER UNIT?
   273	000263'	326240	770251		JUMPN	U,SPGCRE	;YES, GO TO IT
   274
   275	000264'	200240	772161		MOVE	U,FSTUNI	;RETRIEVE THE UNIT POINTER
   276	000265'	201300	746000		MOVEI	T1,%TMP		;POINT TO RIB PAGE
   277	000266'	260040	771316		PUSHJ	P,RBNFL9	;STORE EOF, ADJUST RIBALP, WRITE RIB
   278	000267'	254000	770427		  JRST	REFFAL
   279	000270'	200300	746000*		MOVE	T1,%TMP+RIBALP	;REMEMBER ALLOCATED PAGES
   280	000271'	202300	772123		MOVEM	T1,SPGALP	;FOR LATER
   281				> ; End IFN FTSPAG
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 8
REFSTR.MAC	20-NOV-87 22:23		REFRSH - Refresh a complete file structure

   282				;ALLOCATE SPACE FOR FEFILE.SYS ON KS-10s ONLY (for now)
   283
   284				IFCPU(KS),<			;; KS-10 HAS FE-FILE AREA FOR 8080
   285					MOVE	U,FSTUNI	;USE FIRST UNIT FOR RIB
   286					MOVE	T1,FEFFIL	;NAME OF FEFILE.SYS FILE
   287					MOVE	T2,FEFEXP	;Extension and protection
   288					MOVE	T3,SYSPPN	;IN SYS UFD
   289					MOVEI	T4,%TMP		;ADDRESS OF RIB IN MEMORY.
   290					MOVEI	P4,RIPNDL!RIPNFS ;NO DELETE, NO FAILSAFE BITS
   291					PUSHJ	P,RIBSET	;SET UP RIB IN MEMORY.
   292				
   293					HRLI	T1,-RBLVPR-1	;SET UP AOBJN WORD
   294					HRRI	T1,%TMP+RIBPFS-1 ; TO RETREVIAL
   295					MOVEM	T1,TMPRBP	; AREA FOR PTREXT.
   296				
   297					PUSHJ	P,OGETPG	;Allocate page 14 for RIB to FEFILE.SYS
   298					  JRST	REFFAL
   299					MOVEM	T2,%TMP+RIBSLF	;REMEMBER LOG. PAGE # OF RIB
   300					MOVEM	T2,FEFRBD	; FOR FEFILE.SYS (IN HOM PAGE?).
   301					MOVEI	T1,FEFLEN	;# of pages in FEFILE
   302					MOVEM	T1,%TMP+RIBALP	;Set current pages
   303					AOS	%TMP+RIBALP	; plus 1 for prime rib
   304					LSH	T1,P2WLSH	;Convert to words
   305					MOVEM	T1,%TMP+RIBSIZ	;Store
   306				
   307					SETZM	PGSRIB		;CLEAR # OF SPARE RIBS
   308				FEFCRE:	LDB	P3,UNYPPY	;GET # PAGES PER CYLINDER	(REMEMBER
   309				IFN FTSPAG,<	;IF SPAGES EXISTS START ON CYL 3 ELSE CYL 1	 THESE WERE
   310					IMULI	P3,3 >		; MAKE FIRST PAGE ON CYLINDER 3	 RESERVED
   311					HRLI	P3,-FEFLEN	;GET LENGTH OF FE AREA		 BY INISAT).
   312				
   313				FEFCR1:	HRRZ	T1,P3		;GET THIS PAGE NEXT
   314					PUSHJ	P,MAKPAG	; CONVERT T1 TO RETRIEVAL POINTER
   315					PUSHJ	P,PTREXT	;PUT THE PAGE E RIB
   316					  JRST	REFFAL
   317					AOBJN	P3,FEFCR1	;LOOP FOR ALL PAGES UNIT 0 (ONLY)
   318					MOVEI	T1,%TMP		;POINT TO RIB PAGE
   319					PUSHJ	P,RBNFL9	;STORE EOF, ADJUST RIBALP, WRITE RIB
   320					  JRST	REFFAL
   321					MOVE	T1,%TMP+RIBALP	;REMEMBER ALLOCATED PAGES
   322					MOVEM	T1,FEFALP	;FOR LATER
   323				> ; End IFCPU(KS)
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 9
REFSTR.MAC	20-NOV-87 22:23		REFRSH - Refresh a complete file structure

   324				;ALLOCATE SPACE FOR CRASH.SAV - SPACE TO WRITE OUT A CRASH FILE.
   325
   326	000272'	200645	000262*	CRSCRE:	MOVE	P2,UNISTR(U)	;SEE IF A
   327	000273'	550455	000000*		HRRZ	T4,STRP4C(P2)	;  CRASH FILE
   328	000274'	336000	000011		SKIPN	T4		;  ON THIS STR.
   329	000275'	254000	770311		 JRST	NORCV		;NO
   330	000276'	200240	772161		MOVE	U,FSTUNI	;PUT IT ON FIRST UNIT.
   331	000277'	200300	772104		MOVE	T1,CRSFIL	;File name
   332	000300'	200340	772113		MOVE	T2,CRSEXP	;Extension and protection
   333	000301'	200400	000224*		MOVE	T3,SYSPPN	;In (SYS)
   334	000302'	201740	000000*		MOVEI	P4,RIPNDL!RIPNFS ;SET UP THE RIB IN %TMP AND
   335	000303'	260040	771234		PUSHJ	P,RBNFIL	;THE FILE.
   336	000304'	254000	770427		  JRST	REFFAL		;
   337	000305'	200340	746000*		MOVE	T2,%TMP+RIBALP	;SAVE THE NO. OF PAGES IN THIS
   338	000306'	202340	772122		MOVEM	T2,CRSALP	;FILE + RIB PAGES FOR RIBUSD.
   339	000307'	200340	746000*		MOVE	T2,%TMP+RIBSLF	;
   340	000310'	202340	772131		MOVEM	T2,CRSRBD	;
   341
   342				;CREATE PRINT UFD.
   343
   344	000311'	200240	772161	NORCV:	MOVE	U,FSTUNI	;
   345	000312'	403600	000015		SETZB	P1,P2		;NO FILES= SUM OF ALPS=0.
   346	000313'	200300	000000*		MOVE	T1,SPLPPN	;PPN for print UFD
   347	000314'	202300	772107		MOVEM	T1,SPLUFD	; is filename for MFD
   348	000315'	200340	772116		MOVE	T2,SPLEXP	;'UFD' and protection
   349	000316'	260040	771107		PUSHJ	P,UFDSET	;Build RIB for UFD and write it out
   350	000317'	254000	770427		  JRST	REFFAL		;
   351	000320'	202340	772134		MOVEM	T2,SPLRBD	;SAVE LOGICAL PAGE NUM OF RIB.
   352	000321'	200440	746000*		MOVE	T4,%TMP+RIBALP
   353	000322'	202440	772125		MOVEM	T4,SPLALP	;PAGES ALLOCATED TO (SPOOLING).UFD
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 10
REFSTR.MAC	20-NOV-87 22:23		REFRSH - Refresh a complete file structure

   354				;CREATE SYS UFD AND ITS RIB.
   355
   356	000323'	200240	772161		MOVE	U,FSTUNI	;FIRST UNIT ON STR
   357	000324'	400640	000000		SETZ	P2,
   358	000325'	205300	777774		MOVSI	T1,-NFILE	;FIND SUM OF
   359	000326'	270646	772120		ADD	P2,R.SIZE(T1)	;ALPS FOR
   360	000327'	253300	770326		AOBJN	T1,.-1		;ITS FILES.
   361	000330'	205600	777774		MOVSI	P1,-NFILE	;
   362	000331'	200300	000301*		MOVE	T1,SYSPPN	;PPN for SYS UFD
   363	000332'	202300	772106		MOVEM	T1,SYSUFD	; is filename for MFD
   364	000333'	200340	772115		MOVE	T2,SYSEXP	;'UFD' and protection
   365	000334'	260040	771107		PUSHJ	P,UFDSET	;SET UP & WRITE OUT INFO IN THE RIB FOR SYS.UFD.
   366	000335'	254000	770427		  JRST	REFFAL
   367	000336'	202340	772133		MOVEM	T2,SYSRBD	;Ret Ptr to RIB
   368	000337'	200440	746000*		MOVE	T4,%TMP+RIBALP
   369	000340'	202440	772124		MOVEM	T4,SYSALP	;UFD has 7 data pages
   370	000341'	205600	777774		MOVSI	P1,-NFILE	;MAKE ENTRIES IN THE UFD FOR THE FILES
   371	000342'	260040	771145		PUSHJ	P,SETUFD	;SET UP AND WRITE OUT THE UFD ITSELF.
   372	000343'	254000	770427		  JRST	REFFAL
   373
   374
   375				;CREATE (1,1).UFD (MFD) AND ITS RIB.
   376
   377	000344'	400640	000000		SETZ	P2,		;Sum up the ALPs
   378	000345'	200300	772172		MOVE	T1,[-NUFDS,,NFILE]; of all the UFDs
   379	000346'	270646	772120		ADD	P2,R.SIZE(T1)
   380	000347'	253300	770346		AOBJN	T1,.-1
   381	000350'	271640	000002		ADDI	P2,2		;COUNT MFDALP ALSO.
   382	000351'	200600	772172		MOVE	P1,[-NUFDS,,NFILE]
   383	000352'	200300	000000*		MOVE	T1,MFDPPN	;PPN for MFD UFD
   384	000353'	202300	772110		MOVEM	T1,MFDUFD	; is filename for MFD
   385	000354'	200340	772117		MOVE	T2,MFDEXP	;'UFD' and protection
   386	000355'	260040	771107		PUSHJ	P,UFDSET	;SET UP AND WRITE OUT INFO IN THE RIB FOR MFD.
   387	000356'	254000	770427		  JRST	REFFAL
   388	000357'	202340	772135		MOVEM	T2,MFDRBD	;Ret Ptr to RIB
   389	000360'	202340	000000*		MOVEM	T2,MFDRIB	;Store for FILRIB
   390	000361'	200440	746000*		MOVE	T4,%TMP+RIBALP
   391	000362'	202440	772126		MOVEM	T4,MFDALP	;7 data pages in UFD
   392	000363'	200600	772172		MOVE	P1,[-NUFDS,,NFILE]	;MAKE ENTRIES IN THE MFD FOR THE UFDS
   393	000364'	260040	771145		PUSHJ	P,SETUFD	;SET UP AND WRITE OUT THE MFD ITSELF.
   394	000365'	254000	770427		  JRST	REFFAL
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 11
REFSTR.MAC	20-NOV-87 22:23		REFRSH - Refresh a complete file structure

   395	000366'	260040	771464		PUSHJ	P,CNDSWT	;IF THERE IS A SAT IN CORE, WRITE IT.
   396	000367'	254000	770427		  JRST	REFFAL
   397
   398				;HERE TO UPDATE THE HOME PAGES ON EACH UNIT OF THE STR.
   399
   400
   401	000370'	200240	772161		MOVE	U,FSTUNI	;START WITH THE FIRST UNIT.
   402	000371'	260040	000000*	HOMUPD:	PUSHJ	P,GETHOM	;READ HOME PAGES.
   403	000372'	254000	770427		  JRST	REFFAL
   404	000373'	402000	753000*		SETZM	%HOM+HOMREF	;CLEAR NEEDS REFRESHING FLAG
   405				IFCPU(KS),<
   406					LDB	T1,UNYPPY	;GET # PAGES PER CYL
   407				IFN FTSPAG,<	;; Use CYL 1 if no special/spare pages ELSE use CYL 3
   408					IMULI	T1,3		;STARTS AT CYL 3
   409				> ; End IFN FTSPAG
   410					HRLI	T1,FEFLEN	;FOR FEFLEN PAGES
   411					CAME	U,FSTUNI	;But only on unit 0
   412				> ; End IFCPU(KS)
   413	000374'	201300	000000		 MOVEI	T1,0		;Nothing for KI,KL,F3 and other units on KS
   414	000375'	202300	753014		MOVEM	T1,%HOM+HOMFEP	;SET POINTER TO FE FILE
   415	000376'	201300	000000*		MOVEI	T1,UFDHSI	;RESET HASH
   416	000377'	516300	753000*		HRLZM	T1,%HOM+HOMHSH	;AND
   417	000400'	550300	772154		HRRZ	T1,RANNO
   418	000401'	542300	753000*		HRRM	T1,%HOM+HOMRAN	;RANDOM PACK-SET MOUNT COUNT TO SAME
   419	000402'	205300	777771		MOVSI	T1,-NFILE-NUFDS	;*.SYS and *.UFD
   420	000403'	200346	772127	HOMUP1:	MOVE	T2,R.RIBS(T1)	;Ret Ptr to RIB of this file or UFD
   421	000404'	135400	772173		LDB	T3,[POINT 9,R.EXPR(T1),35];Get index (zero if none)
   422	000405'	332000	000010		SKIPE	T3		;If it belongs in the HOM page
   423	000406'	202350	753000		 MOVEM	T2,%HOM(T3)	; put it there
   424	000407'	253300	770403		AOBJN	T1,HOMUP1	;Update HOMTAB (HOMSAT thru HOMMFD)
   425	000410'	260040	000000*		PUSHJ	P,WTBOTH	;P4 & PG STILL SET UP FROM GETHOM.
   426	000411'	256000	770000		 STOPCD			;WTBOTH HAS TYPED AN ERR MSG.
   427	000412'	554245	000272*		HLRZ	U,UNISTR(U)
   428	000413'	326240	770371		JUMPN	U,HOMUPD	;LOOP FOR ALL UNITS IN STR
   429	000414'	260040	771555		PUSHJ	P,CLSAOB	;Clear STTAOB on all SATs
   430
   431				;HERE WHEN ALL DONE
   432
   433	000415'	200300	000000*		MOVE	T1,FSFPPN	;FAILSAFE PPN
   434	000416'	202300	000000*		MOVEM	T1,REFLAG	;SET REFLAG NON-ZERO
   435	000417'	200240	772161		MOVE	U,FSTUNI	;RESET U TO FIRST UNIT
   436	000420'	550645	000412*		HRRZ	P2,UNISTR(U)	;TO RESET P2 WHICH WAS CLOBBERED
   437	000421'	201300	000376*		MOVEI	T1,UFDHSI	;  FIXING HOME PAGES.
   438	000422'	542315	000000*		HRRM	T1,STRHSH(P2)	;Update STR datablock
   439	000423'	201300	000000*		MOVEI	T1,SRPREF##	;Mark the STR
   440	000424'	436315	000000*		IORM	T1,STRBTS(P2)	; has having been refreshed
   441	000425'	553015	000000*		HRRZS	STRREF(P2)	;CLEAR NEEDS REFRESHING FLAG IN CORE
   442	000426'	254000	000000*		JRST	CPOPJ1		;SKIP RETURN
   443
   444
   445	000427'	263040	000000	REFFAL:	POPJ	P,		;ERROR EXIT.
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 12
REFSTR.MAC	20-NOV-87 22:23		PAKREF - Refresh a single pack which is being added to a STR

   446				SUBTTL	PAKREF - Refresh a single pack which is being added to a STR
   447				;ENTER WITH U/ UNIT DB AND P2/ STR DB.
   448
   449				;The RIB to HOME.SYS needs to be updated to include the additional HOM pages.
   450				;The RIB to SAT.SYS needs to be updated to include the additional SATs.
   451				;The RIB to SPAGES.SYS needs to be updated to include the new cylinders.
   452				;Then the new HOM page is rewritten.
   453
   454	000430'	202240	772162	PAKREF::MOVEM	U,REFUNI	;SAVE UNIT BEING REFRESHED.
   455	000431'	402000	772161		SETZM	FSTUNI		;FLAG FOR INISAT.
   456	000432'	542645	000420*		HRRM	P2,UNISTR(U)	;PUT STR HERE, SOME LOOK FOR IT.
   457	000433'	554255	000122*		HLRZ	U,STRUNI(P2)	;GET THE 1ST UNIT IN THE STR.
   458	000434'	402000	772164		SETZM	SATDSK		;MARK NO SAT IN CORE IN %STA.
   459	000435'	402000	772120		SETZM	R.ZERB		;Zero out R.RIBS and R.SIZE
   460	000436'	200300	772171		MOVE	T1,[XWD R.ZERB,R.ZERB+1]
   461	000437'	251300	772135		BLT	T1,R.ZERE
   462
   463	000440'	260040	000371*		PUSHJ	P,GETHOM	;GET HOME PAGES FROM FIRST UNIT.
   464	000441'	254000	770632		  JRST	PAKLEV		;ERROR.
   465	000442'	205300	777771		MOVSI	T1,-NFILE-NUFDS	;Loop thru entire table
   466	000443'	135400	772173	PREF1:	LDB	T3,[POINT 9,R.EXPR(T1),35]
   467	000444'	332000	000010		SKIPE	T3		;If it comes from the HOM page
   468	000445'	200410	753000		 MOVE	T3,%HOM(T3)	; get it, else use zero
   469	000446'	202406	772127		MOVEM	T3,R.RIBS(T1)	;Ret Ptr to RIB of this file or ufd
   470	000447'	253300	770443		AOBJN	T1,PREF1	;Read HOMTAB (HOMSAT thru HOMMFD)
   471
   472				  ;Read the current RIBs for HOME,SAT,SPAGES into %HMR,%STR,%TMP
   473	000450'	205740	777774		MOVSI	P4,-NFILE	;P4/ LOOP INDEX.
   474	000451'	332017	772136	PREF2:	SKIPE	R.PCBS(P4)	;Only SAT,HOME,SPAGES belong on added packs
   475	000452'	336457	772127		SKIPN	T4,R.RIBS(P4)	;T4/ PAGE NO. OF PRIME RIB FIRST UNIT.
   476	000453'	254000	770522		 JRST	PRFNST		;No big deal if no RIB to SPAGES.SYS (SWAP.SYS)
   477	000454'	621440	000175*		TLZ	T4,RBREAL	;Page within unit, unit 0 always
   478
   479	000455'	550157	772136		HRRZ	PG,R.PCBS(P4)	;PG/ %XXX.P = PCB
   480	000456'	554617	772136		HLRZ	P1,R.PCBS(P4)	;P1/ %XXX   = virtual address
   481	000457'	200240	772162		MOVE	U,REFUNI	;Requested unit
   482	000460'	550645	000432*		HRRZ	P2,UNISTR(U)	;STR it belongs to
   483	000461'	554255	000433*		HLRZ	U,STRUNI(P2)	;First unit of that STR
   484	000462'	260040	000000*		PUSHJ	P,OPAGIN	;Read RIB of this file
   485	000463'	254000	770632		  JRST	PAKLEV
   486	000464'	200654	000000*		MOVE	P2,RIBSIZ(P1)	;CALC NO. OF THE LAST PAGE IN
   487	000465'	231640	001000		IDIVI	P2,1000		;FILE. (NB NOT TRUE IN GENERAL.)
   488	000466'	200414	000000*	PREF3:	MOVE	T3,RIBSZS(P1)	;FOUND RIGHT RIB IF
   489	000467'	302400	000001		CAIE	T3,1		;AT LOWEST LEVEL.
   490	000470'	254000	770475		 JRST	PREF4		;
   491	000471'	271654	000000*		ADDI	P2,RIBPFS(P1)	;P2/ ADDR OF EOF PNTR.
   492	000472'	332014	000000*		SKIPE	RIBRIB(P1)	;
   493	000473'	271640	000000*		 ADDI	P2,RIBSFS-RIBPFS;Spare RIBs start at a different location
   494	000474'	254000	770514		JRST	PREF11		;
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 13
REFSTR.MAC	20-NOV-87 22:23		PAKREF - Refresh a single pack which is being added to a STR

   495				;GO DOWN A LEVEL INTO A SPARE RIB
   496
   497	000475'	230654	000466*	PREF4:	IDIV	P2,RIBSZS(P1)	;ELSE P2/ #PRECED SPARE PNTRS, P3/ INDEX
   498	000476'	271654	000471*		ADDI	P2,RIBPFS(P1)	;P2/ ADDR OF NEXT PNTR.
   499	000477'	332014	000472*		SKIPE	RIBRIB(P1)	;
   500	000500'	271640	000000*		 ADDI	P2,RIBSFS-RIBPFS;Third level of RIBs
   501	000501'	200355	000000		MOVE	T2,(P2)		;IS THE PNTR
   502	000502'	607340	000000*		TLNN	T2,RBSPAR	;A SPARE RIB PNTR?
   503	000503'	254000	770513		 JRST	PREF5		;NO, WE ARE IN THIS RIB.
   504	000504'	200640	000016		MOVE	P2,P3		;YES, WE MUST READ
   505	000505'	135240	000000*		LDB	U,RBYUNI	;IN
   506	000506'	200245	000000*		MOVE	U,UNTTBL(U)	;THE
   507	000507'	135440	000213*		LDB	T4,RBYPNO	;LOWER
   508	000510'	260040	000462*		PUSHJ	P,OPAGIN	;RIB.
   509	000511'	254000	770632		  JRST	PAKLEV		;
   510	000512'	254000	770466		JRST	PREF3		;P2 has index into the current RIB
   511
   512	000513'	271656	000000	PREF5:	ADDI	P2,(P3)		;Index to a real pointer following a spare
   513
   514				    ;HERE WITH ADDR OF EOF PNTR IN P2.
   515
   516	000514'	200300	000015	PREF11:	MOVE	T1,P2		;BUILD
   517	000515'	274640	000014		SUB	P2,P1		; AN
   518	000516'	275640	000002*		SUBI	P2,RIBLST+2	; AOBJN
   519	000517'	506640	000006		HRLM	P2,T1		; POINTER
   520	000520'	541306	777777		HRRI	T1,-1(T1)	; IN T1.
   521	000521'	202317	772145		MOVEM	T1,R.RBPS(P4)	;Store for adding more RIB pointers
   522	000522'	253740	770451	PRFNST:	AOBJN	P4,PREF2	;Locate all 3 files
   523
   524				    ;READ THE BAT PAGE INTO %BAT.
   525	000523'	200240	772162		MOVE	U,REFUNI	;READ THE
   526	000524'	260040	000153*		PUSHJ	P,GETBAT	;BAT PAGE.
   527	000525'	254000	770632		  JRST	PAKLEV		;
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 14
REFSTR.MAC	20-NOV-87 22:23		PAKREF - Refresh a single pack which is being added to a STR

   528				;HERE FOR THE SATS FOR THIS UNIT.
   529
   530	000526'	260040	771041		PUSHJ	P,SATCLC	;CALC BEGSAT, SVSBTL, LPGSAT, AND SATIND.
   531
   532				    ;THIS IS THE LOOP FOR EACH SAT.
   533
   534	000527'	260040	770672	RFNXST:	PUSHJ	P,INISAT	;SET UP A SAT AND PART OF HOME.SYS.
   535	000530'	256000	770000		 STOPCD
   536
   537	000531'	260040	771021		PUSHJ	P,NXCLC		;CALC INFO FOR NEXT SAT.
   538	000532'	254000	770527		  JRST	RFNXST		;Loop for all SATs on new unit
   539
   540
   541				    ;SET NEW RIBSIZ'S IN THE RIBS FOR HOME.SYS AND SAT.SYS
   542
   543	000533'	201300	752000		MOVEI	T1,%HMR		;		HOME
   544	000534'	260040	772075		PUSHJ	P,CNVSZM	;
   545	000535'	400340	000000		SETZ	T2,		;STORE THE
   546	000536'	260040	771535		PUSHJ	P,HOMRBS	;EOF POINTER.
   547
   548	000537'	201300	750000		MOVEI	T1,%STR		;		SAT
   549	000540'	260040	772075		PUSHJ	P,CNVSZM	;
   550	000541'	400340	000000		SETZ	T2,		;
   551	000542'	260040	771526		PUSHJ	P,SATRBS	;STORE EOF POINTER
   552
   553				IFN FTSPAG,<    ;SET NEW RIBSIZ'S IN THE RIB FOR SPAGES.SYS
   554	000543'	336000	772150		SKIPN	TMPRBP		;Is there a file to be added to?
   555	000544'	254000	770565		 JRST	PAKSP0		;No
   556				;INISAT has reserved cylinders 1 and 2 for SPAGES.SYS
   557	000545'	135300	000251*		LDB	T1,UNYPPY	;GET # PAGES PER CYLINDER
   558	000546'	242300	000001		LSH	T1,1		; 2 cylinders
   559	000547'	272300	746000*		ADDM	T1,%TMP+RIBALP	;Add to allocated pages
   560	000550'	242300	000011		LSH	T1,P2WLSH	; # of words
   561	000551'	272300	746000*		ADDM	T1,%TMP+RIBSIZ	;Add to written words
   562	000552'	135300	000545*		LDB	T1,UNYPPY	;GET # PAGES PER CYLINDER
   563	000553'	210700	000006		MOVN	P3,T1		; NEGATE AND POSITION
   564	000554'	242700	000023		LSH	P3,^D<18+1>	; FOR AOBJN LENGTH (-N*2,,0)
   565	000555'	540700	000006		HRR	P3,T1		;First page is start of cyl 1
   566
   567	000556'	550300	000016	PAKSPG:	HRRZ	T1,P3		;GET THIS PAGE NEXT
   568	000557'	260040	771100		PUSHJ	P,MAKPAG	; CONVERT T1 TO RETRIEVAL POINTER
   569	000560'	260040	771642		PUSHJ	P,PTREXT	;PUT THE PAGE IN THE RIB
   570	000561'	254000	770632		  JRST	PAKLEV
   571	000562'	253700	770556		AOBJN	P3,PAKSPG	;LOOP FOR ALL PAGES THIS UNIT
   572
   573	000563'	400340	000000		SETZ	T2,		;STORE THE
   574	000564'	260040	771642		PUSHJ	P,PTREXT	;NEW EOF POINTER
   575	770565			PAKSP0:
   576				>  ;end IFN FTSPAG
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 15
REFSTR.MAC	20-NOV-87 22:23		PAKREF - Refresh a single pack which is being added to a STR

   577				;NOW FIX UP THE HOME PAGES ON THIS UNIT.
   578
   579	000565'	200240	772162	FIXHOM:	MOVE	U,REFUNI	;Read HOM page on unit in question
   580	000566'	260040	000440*		PUSHJ	P,GETHOM
   581	000567'	256000	770000		 STOPCD
   582	000570'	402000	753000*		SETZM	%HOM+HOMREF	;Clear "needs refreshing" flag
   583	000571'	402000	753014		SETZM	%HOM+HOMFEP	;Front-end file system on DSKB0 only
   584	000572'	550300	000000*		HRRZ	T1,STRDDB+STRHSH
   585	000573'	516300	753000*		HRLZM	T1,%HOM+HOMHSH	;
   586	000574'	550300	772154		HRRZ	T1,RANNO	;
   587	000575'	542300	753000*		HRRM	T1,%HOM+HOMRAN	;
   588	000576'	205300	777771		MOVSI	T1,-NFILE-NUFDS
   589	000577'	200346	772127	FIXHM1:	MOVE	T2,R.RIBS(T1)	;Ret Ptr to RIB of this file or ufd
   590	000600'	135400	772173		LDB	T3,[POINT 9,R.EXPR(T1),35]
   591	000601'	332000	000010		SKIPE	T3		;If it belongs in the HOM page
   592	000602'	202350	753000		 MOVEM	T2,%HOM(T3)	; put it there
   593	000603'	253300	770577		AOBJN	T1,FIXHM1	;Update HOMTAB (HOMSAT thru HOMMFD)
   594	000604'	260040	000410*		PUSHJ	P,WTBOTH	;NOW WRITE THEM OUT.
   595	000605'	256000	770000		 STOPCD
   596	000606'	550645	000460*		HRRZ	P2,UNISTR(U)	;
   597	000607'	201300	000421*		MOVEI	T1,UFDHSI	;
   598	000610'	542315	000422*		HRRM	T1,STRHSH(P2)	;
   599
   600				    ;NOW WRITE OUT THE RIBS FOR HOME AND SAT and maybe SPAGES.
   601
   602	000611'	205740	777774		MOVSI	P4,-NFILE	;
   603	000612'	332017	772136	PAKRB1:	SKIPE	R.PCBS(P4)	;Do only the 3 special files
   604	000613'	336017	772127		SKIPN	R.RIBS(P4)	;Was this RIB read in?
   605	000614'	254000	770625		 JRST	PKRB1A		;No, OK for RIB to SPAGES.SYS to be missing
   606	000615'	554417	772136		HLRZ	T3,R.PCBS(P4)	;Virtual address
   607	000616'	200350	000000*		MOVE	T2,RIBSLF(T3)	;Self pointer says where to write the data
   608	000617'	135440	000507*		LDB	T4,RBYPNO	;Page within unit
   609	000620'	135240	000505*		LDB	U,RBYUNI	;Unit number
   610	000621'	200245	000506*		MOVE	U,UNTTBL(U)	;Unit data block
   611	000622'	550157	772136		HRRZ	PG,R.PCBS(P4)	;Physical address
   612	000623'	260040	000215*		PUSHJ	P,OPAGOT	;Write it out
   613	000624'	256000	770000		 STOPCD
   614	000625'	253740	770612	PKRB1A:	AOBJN	P4,PAKRB1	;Do all 3 files
   615	000626'	260040	771464		PUSHJ	P,CNDSWT	;Write out SAT if any
   616	000627'	256000	770000		 STOPCD
   617	000630'	260040	771546		PUSHJ	P,CLUAOB	;Clear SATAOB
   618	000631'	350001	000000		AOS	(P)		;SUCCESS RETURN
   619
   620	000632'	200240	772162	PAKLEV:	MOVE	U,REFUNI	;Restore U and P2
   621	000633'	550645	000606*		HRRZ	P2,UNISTR(U)	;
   622	000634'	263040	000000		POPJ	P,		;End of PAKREF
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 16
REFSTR.MAC	20-NOV-87 22:23		SCNBAT - Scan BAT pages

   623				SUBTTL	SCNBAT - Scan BAT pages
   624
   625				COMMENT #
   626				@@SUBROUTINE SCNBAT
   627				@@PURPOSE
   628				SUBR TO SCAN BAT AREA AND EXECUTE AN INSTRUCTION FOR EACH BAD PAGE.
   629				@@ENTRY
   630				EXPECTS T2/ INSTRUCTION TO EXECUTE (AND IF CALLING SETBTS,
   631				T3/ ADDR OF STT ENTRY.).
   632				@@ACCUM
   633				DESTROYS T1, T2, AND T4.
   634				@@EXIT
   635				SKIP RETURNS UNLESS ERROR, IN WHICH CASE NON-SKIP RETURNS.
   636				@@ #
   637
   638				;Called from INISAT to mark bad pages as unuseable.
   639				;The old version of PAKCOP interpreted the numbers in the BAT pages as being
   640				;block numbers, it has been corrected to use page numbers.
   641				;See also UPERBT (update error BAT) routine in CORE1.
   642
   643	000635'	265440	000121*	SCNBAT::JSP	T4,SAVE4	;SAVE P1-P4
   644	000636'	200640	000007		MOVE	P2,T2		;P2=INSTRUCTION TO EXECUTE.
   645	000637'	201740	747000		MOVEI	P4,%BAT		;P4/ -NO. OF WORDS IN AREA,,
   646	000640'	270740	747000*		ADD	P4,%BAT+BATFIR	;ADDR OF 1ST ENTRY.
   647
   648				    ;HERE FOR EACH ENTRY.
   649	000641'	336017	000000*	SCNBT2:	SKIPN	BATNBB(P4)	;AT END?
   650	000642'	254000	000426*		 JRST	CPOPJ1		;YES.
   651	000643'	550340	000017		HRRZ	T2,P4		;Put addr in T2 for BAYNBB
   652	000644'	135700	000000*		LDB	P3,BAYNBB	;NUMBER BAD PAGES-1.
   653	000645'	334617	000000*		SKIPA	P1,BATELB(P4)	;P1=1ST BAD PAGE.
   654				    ;HERE FOR EACH BAD PAGE.
   655	000646'	271600	000001	SCNBT3:	 ADDI	P1,1		;P1=NEXT BAD PAGE.
   656	000647'	200300	000014		MOVE	T1,P1		;ARG FOR INSTRUCTION.
   657	000650'	256000	000015		XCT	P2		;MARK THIS PAGE IN SAT.
   658	000651'	365700	770646		SOJGE	P3,SCNBT3	;LOOP FOR ALL BAD PAGES THIS REGION.
   659	000652'	252740	770654		AOBJP	P4,.+2		;COMPENSATE FOR 2 WORD ENTRIES.
   660	000653'	253740	770641		AOBJN	P4,SCNBT2	;LOOP FOR ALL ENTRIES
   661	000654'	260040	772174		 MSGLIV	BATBAD		;Output message if BAT is completely full
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 17
REFSTR.MAC	20-NOV-87 22:23		SCNBAT - Scan BAT pages

   662				COMMENT #
   663				@@SUBROUTINE SETBTS
   664				@@PURPOSE
   665				SUBR TO CLEAR AN F BIT IN %STA AND DECREMENT STTFPC.
   666				This marks the page as being "in use".
   667				@@ENTRY
   668				EXPECTS T1/ PAGE NO. OF BIT AND T3/ ADDR OF STT ENTRY.
   669				@@ACCUM
   670				DESTROYS T1, T2, AND T4.
   671				@@ #
   672
   673	000655'	311300	772156	SETBTS:	CAML	T1,BEGSAT	;SKIP IF BEFORE BEGINNING OF CURRENT SAT.
   674	000656'	313300	772160		CAMLE	T1,LPGSAT	;SKIP IF WITHIN CURRENT SAT (NOT PAST END)
   675	000657'	263040	000000		 POPJ	P,		;PAGE NOT IN CURRENT SAT.
   676	000660'	274300	772156		SUB	T1,BEGSAT	;
   677	000661'	231300	000044		IDIVI	T1,^D36		;T1=INDEX IN PAGE OF BIT.
   678	000662'	213000	000007		MOVNS	T2		;T2=BITS TO SHIFT RIGHT
   679	000663'	205440	400000		MOVSI	T4,400000	;SET LEFTMOST BIT
   680	000664'	242447	000000		LSH	T4,(T2)		;POSITION BIT
   681	000665'	616446	751000		TDNN	T4,%STA(T1)	;SKIP IF BIT SET.
   682	000666'	263040	000000		 POPJ	P,		;ALREADY CLEAR, JUST RETURN.
   683	000667'	412446	751000		ANDCAM	T4,%STA(T1)	;SO CLEAR IT.
   684	000670'	370010	000000*		SOS	STTFPC(T3)	;NOTE ONE LESS FREE PAGE.
   685	000671'	263040	000000		POPJ	P,
   686
   687
   688				SUBTTL VARIOUS SUBROUTINES.
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 18
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

   689				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   690				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   691				;;									;;
   692				;;	INISAT	Set all the bits in %STA to represent available pages,	;;
   693				;;		except for BAD pages, the HOME, BAT and BOOT pages, on	;;
   694				;;		KS-10 the FEFILE pages, the special spare pages on all	;;
   695				;;		disk units, non-existent pages and page 0.		;;
   696				;;		Also, make the STT entry and write out the SAT.		;;
   697				;;									;;
   698				;;		Destroys T1 thru T4, P1 thru P4 and PG.			;;
   699				;;		calls: CORONZ, SCNBAT, SETBTS, GETHMP, SATSRH, SATRBS,	;;
   700				;;		       OPAGOT, TAKPAG and CPOPJ1.			;;
   701				;;									;;
   702				;;	expects	BEGSAT, SVSBTL, LPGSAT and SATIND setup.		;;
   703				;;		U/ UNIT DB						;;
   704				;;		F/ DDB							;;
   705				;;									;;
   706				;;	returns	SKIP if no errors.					;;
   707				;;		NON-SKIP if anything goes wrong.			;;
   708				;;									;;
   709				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   710				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   711
   712				    ;HERE TO MAKE THE STT ENTRY.
   713	000672'	260040	771464	INISAT:	PUSHJ	P,CNDSWT	;WRITE OUT ANY SAT IN CORE BEFORE
   714	000673'	263040	000000		  POPJ	P,		; WE WIPE IT OUT.
   715	000674'	350300	772163		AOS	T1,SATIND	;GET INTO T1 THE
   716	000675'	221300	000000*		IMULI	T1,STTLEN	;ADDR OF THE
   717	000676'	550345	000000*		HRRZ	T2,UNISTT(U)	;STT
   718	000677'	271307	000000		ADDI	T1,(T2)		;ENTRY.
   719	000700'	402006	000000*		SETZM	STTAOB(T1)	;CLEAR AOBJN POINTER.
   720	000701'	200340	772157		MOVE	T2,SVSBTL	;SET THE COUNT OF
   721	000702'	202346	000670*		MOVEM	T2,STTFPC(T1)	;FREE PAGES.
   722	000703'	402006	000000*		SETZM	STTSTS(T1)	;CLEAR THE STATUS.
   723	000704'	261040	000006		PUSH	P,T1		;SAVE ENTRY ADDR FOR BELOW.
   724
   725				    ;HERE TO SET ALL SAT BITS AND THEN CLEAR BITS OF NON-EXISTENT PAGES.
   726	000705'	551300	751000		HRRZI	T1,%STA		;SET THE ENTIRE
   727	000706'	476000	751000		SETOM	%STA		;AREA REPRESENTED IN THIS
   728	000707'	260040	000000*		PUSHJ	P,CORONZ	;SAT TO AVAILABLE.
   729	000710'	200340	772157		MOVE	T2,SVSBTL	;ANY NON-EXISTENT PAGES
   730	000711'	301340	022000		CAIL	T2,400*^D36	;AT THE END OF THE SAT?
   731	000712'	254000	770732		 JRST	INISA3		;NO.
   732	000713'	400300	000000		SETZ	T1,		;YES, DOES A PARTIAL
   733	000714'	231340	000044		IDIVI	T2,^D36		;WORD IN THE SAT HAVE
   734	000715'	322400	770721		JUMPE	T3,INISA2	;TO BE SET?
   735	000716'	205300	400000		MOVSI	T1,400000	;YES.  SET
   736	000717'	211410	777777		MOVNI	T3,-1(T3)	;THE PARTIAL
   737	000720'	240310	000000		ASH	T1,(T3)		;WORD.
   738	000721'	202307	751000	INISA2:	MOVEM	T1,%STA(T2)	;SET PARTIAL WORD OR NEXT WORD.
   739	000722'	301340	000377		CAIL	T2,377		;ANY MORE WORDS TO SET?
   740	000723'	254000	770732		 JRST	INISA3		;NO.
   741				page
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 19
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

   742	000724'	402007	751001		SETZM	%STA+1(T2)	;YES, PREPARE TO BLT.
   743	000725'	301340	000376		CAIL	T2,376		;BUT NOT IF ONLY ONE
   744	000726'	254000	770732		 JRST	INISA3		;WORD TO DO.
   745	000727'	551347	751002		HRRZI	T2,%STA+2(T2)	;SET THE REST OF
   746	000730'	505347	777777		HRLI	T2,-1(T2)	;THE SAT TO
   747	000731'	251340	751377		BLT	T2,%STA+377	;UNAVAILABLE.
   748
   749				    ;HERE TO SCAN BAT AREA AND MARK BAD PAGES IN SAT.
   750
   751	000732'	262040	000010	INISA3:	POP	P,T3		;RESTORE STT ENTRY ADDRESS.
   752	000733'	200340	772201		MOVE T2,[PUSHJ P,SETBTS];INSTRUCTION TO EXECUTE
   753	000734'	260040	770635		PUSHJ	P,SCNBAT	;FOR EACH BAD PAGE.
   754	000735'	263040	000000		  POPJ	P,
   755
   756	000736'	332000	772156	INISA5:	SKIPE	BEGSAT		;SKIP IF THIS IS 1ST SAT ON THIS UNIT
   757	000737'	254000	770767		 JRST	INISA6
   758
   759				    ;HERE TO ALLOCATE PAGES (HOME, BAT, AND BOOTS) IN HOME.SYS FILE
   760				    ;AND PAGE FOR SAT.SYS RIB.
   761				    ;(DONE ONLY IF THIS IS THE FIRST SAT ON THIS UNIT.).
   762	000740'	205700	777773		MOVSI	P3,-LBNLEN
   763	000741'	200316	771014	INISAA:	MOVE	T1,LBNLST(P3)
   764	000742'	260040	771050		PUSHJ	P,GETHMP	;GET NEXT PAGE IN THE GROUP.
   765	000743'	263040	000000		  POPJ	P,		;CAN'T GET IT.
   766	000744'	253700	770741		AOBJN	P3,INISAA	;LOOP FOR ALL OF THE GROUP
   767	000745'	200700	772202		MOVE	P3,[XWD -NBOOTP,FBOOTB]	;P3=-# PAGES FOR BOOTS, 1ST PAGE.
   768	000746'	550300	000016	INISAB:	HRRZ	T1,P3		;NEXT PAGE TO ALLOCATE.
   769	000747'	260040	771050		PUSHJ	P,GETHMP	;ALLOCATE THE PAGE, STORE IN %HMR
   770	000750'	263040	000000		  POPJ	P,
   771	000751'	253700	770746		AOBJN	P3,INISAB	;LOOP FOR ALL PAGES TO ALLOCATE FOR BOOTS.
   772				IFN FTSPAG,<	;;Allocate 2 cylinders in SAT even if no RIB for SPAGES.SYS
   773	000752'	135300	000552*		LDB	T1,UNYPPY	;GET # PAGES PER CYLINDER
   774	000753'	210700	000006		MOVN	P3,T1		; NEGATE AND POSITION
   775	000754'	242700	000023		LSH	P3,^D<18+1>	; FOR AOBJN LENGTH (-N*2,,0)
   776	000755'	540700	000006		HRR	P3,T1		;GET FIRST PAGE AS POINTER
   777	000756'	550300	000016	INISAC:	HRRZ	T1,P3		; NEED TO GET THIS PAGE #
   778	000757'	260040	771054		PUSHJ	P,TAKPAG	;RESERVE THE PAGE SO NOBODY ELSE GETS IT.
   779	000760'	263040	000000		  POPJ	P,
   780	000761'	253700	770756		AOBJN	P3,INISAC	;LOOP FOR ALL PAGES ON CYL 1 AND 2
   781				> ; End IFN FTSPAG
   782
   783	000762'	312240	772161		CAME	U,FSTUNI	;If not first unit,
   784	000763'	254000	770767		 JRST	INISA6		; skip the rest
   785				IFCPU(KS),<			;KS-10 HAS FE-FILE AREA FOR 8080
   786					LDB	P3,UNYPPY	;GET # PAGES PER CYLINDER
   787				IFN FTSPAG,<IMULI P3,3>		;Skip over cylinders 0,1,2,3 if SPAGES
   788					HRLI	P3,-FEFLEN	;GET LENGTH OF FE AREA
   789				INISAD:	HRRZ	T1,P3		; NEED TO GET THIS PAGE #
   790					PUSHJ	P,TAKPAG	;RESERVE THE PAGE SO NOBODY ELSE GETS IT.
   791					  POPJ	P,
   792					AOBJN	P3,INISAD	;LOOP FOR ALL PAGES TO ALLOCATE FE AREA
   793				> ; End IFCPU(KS)
   794				page
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 20
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

   795	000764'	201300	000010		MOVEI	T1,LPNSAT	;ALLOCATE PAGE 10 FOR THE RIB TO
   796	000765'	260040	771054		PUSHJ	P,TAKPAG	; SAT.SYS SO NOBODY ELSE GETS IT.
   797	000766'	263040	000000		  POPJ	P,		;End of first-unit-only stuff
   798				    ;HERE TO WRITE THIS SAT PAGE OUT TO THE DISK.
   799
   800	000767'	200600	000010	INISA6:	MOVE	P1,T3		;P1 HAS INDEX FOR SATSRH AND SAFETY.
   801	000770'	333014	000702*		SKIPLE	STTFPC(P1)	;ROOM IN THIS SAT FOR ITSELF?
   802	000771'	254000	771004		 JRST	INISA8		;YES. (always is)
   803	000772'	550305	000676*		HRRZ	T1,UNISTT(U)	;NO.  TRY TO
   804	000773'	306606	000000		CAIN	P1,(T1)		;FIND ROOM
   805	000774'	260040	772203		 MSGLIV	OGTPG		;IN AN EARLIER SAT, IF THERE IS ONE.
   806	000775'	200300	772210		MOVE	T1,[XWD %STA,%T2P] ;MEANWHILE, SAVE US
   807	000776'	251300	745777		BLT	T1,%T2P+777	;IN %T2P.
   808	000777'	402014	000000*		SETZM	STTPTR(P1)	;DON'T LET OGETPG GET PAST US.
   809	001000'	260040	771435		PUSHJ	P,OGETPG	;TRY TO GET A PAGE IN AN EARLIER SAT.
   810	001001'	263040	000000		  POPJ	P,		;
   811	001002'	201140	000000*		MOVEI	PG,%T2P.P	;REMEMBER WE WANT TO WRITE OUT %T2P.
   812	001003'	254000	771010		JRST	INISA9		;
   813	001004'	201640	000001	INISA8:	MOVEI	P2,1		;HERE TO GET A PAGE
   814	001005'	260040	771336		PUSHJ	P,SATSRH	;IN OURSELVES.
   815	001006'	263040	000000		  POPJ	P,
   816	001007'	201140	000000*		MOVEI	PG,%STA.P	;REMEMBER WE WANT TO WRITE OUT %STA.
   817	001010'	202354	000777*	INISA9:	MOVEM	T2,STTPTR(P1)	;STORE THE DISK PNTR TO THE SAT.
   818	001011'	260040	771526		PUSHJ	P,SATRBS	; " IN SAT.SYS RIB.
   819	001012'	135440	000617*		LDB	T4,RBYPNO	;WRITE OUT THE
   820	001013'	324740	000623*		PJRST	OPAGOT		;SAT PAGE, SKIP RETURN
   821
   822	001014'	000000	000000	LBNLST:	0		;Page 0 is reserved (TOPS-10 HOM block on KS)
   823	001015'	000000	000001		LPNHOM		;Primary HOM
   824	001016'	000000	000006		LP2HOM		;Secondary HOM
   825	001017'	000000	000002		LPNBAT		;Primary BAT
   826	001020'	000000	000007		LP2BAT		;Secondary BAT
   827			000005	LBNLEN==.-LBNLST
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 21
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

   828				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   829				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   830				;;									;;
   831				;;	NXCLC	See if this unit needs more SATs than we have already	;;
   832				;;		created.  Destroys T2.					;;
   833				;;									;;
   834				;;	expects	U/ UNIT DB						;;
   835				;;		BEGSAT and SVSBTL setup.				;;
   836				;;									;;
   837				;;	returns	SKIP if no more SATs for this unit.			;;
   838				;;		NON-SKIP with BEGSAT, LPGSAT and SVSBTL set up.		;;
   839				;;									;;
   840				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   841				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   842
   843	001021'	200340	772157	NXCLC:	MOVE	T2,SVSBTL	;PAGES IN THIS SAT.
   844	001022'	270340	772156		ADD	T2,BEGSAT	;LAST PAGE IN THIS SAT+1. NEXT
   845	001023'	311345	000000*		CAML	T2,UNIPPU(U)	;SAT WOULD BE PAST E O UNIT?
   846	001024'	254000	000642*		 JRST	CPOPJ1		;YES, NO MORE SATS THIS UNIT.
   847	001025'	202340	772156		MOVEM	T2,BEGSAT	;NO, ANOTHER SAT FOR THIS UNIT.
   848	001026'	270340	772157		ADD	T2,SVSBTL	;COMPUTE END OF NEXT
   849	001027'	275340	000001		SUBI	T2,1		;SAT.
   850	001030'	202340	772160		MOVEM	T2,LPGSAT	;REMEMBER LAST PAGE NEW SAT.
   851	001031'	271340	000001		ADDI	T2,1		;SKIP IF NEW SAT WOULD GO
   852	001032'	317345	001023*		CAMG	T2,UNIPPU(U)	;PAST END OF UNIT.
   853	001033'	263040	000000		 POPJ	P,		;NO, KEEP GOING.
   854	001034'	274345	001032*		SUB	T2,UNIPPU(U)	;YES. FIND OUT HOW
   855	001035'	213000	000007		MOVNS	T2		;MUCH OVER.
   856	001036'	272340	772157		ADDM	T2,SVSBTL	;CORRECT SIZE OF SAT
   857	001037'	272340	772160		ADDM	T2,LPGSAT	;AND LAST PAGE.
   858	001040'	263040	000000		POPJ	P,		;MORE SATS THIS UNIT.
   859
   860
   861				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   862				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   863				;;									;;
   864				;;	SATCLC	Set BEGSTA, SVSBTL, LPGSAT and SATIND for the first	;;
   865				;;		SAT on a unit.  Destroys T1.				;;
   866				;;									;;
   867				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   868				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   869
   870	001041'	402000	772156	SATCLC:	SETZM	BEGSAT		;BEGSAT/ 1ST SAT ON A UNIT.
   871	001042'	201300	022000		MOVEI	T1,400*^D36	;SVSBTL/ NO. OF REAL
   872	001043'	202300	772157		MOVEM	T1,SVSBTL	;ENTRIES IN THIS SAT.
   873	001044'	275300	000001		SUBI	T1,1		;LPGSAT/ LAST PAGE IN
   874	001045'	202300	772160		MOVEM	T1,LPGSAT	;THE FIRST SAT.
   875	001046'	476000	772163		SETOM	SATIND		;SAT INDEX,
   876	001047'	263040	000000		POPJ	P,		;SET TO -1 (BECAUSE WE AOS.).
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 22
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

   877				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   878				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   879				;;									;;
   880				;;	GETHMP	Allocate 1 page in current SAT for HOME.SYS while	;;
   881				;;		creating SATs.  (Only works for first SAT on a unit).	;;
   882				;;		Destroys T1 and T2.					;;
   883				;;		calls: TAKPAG and HOMRBS.				;;
   884				;;									;;
   885				;;	expects	T1/ LOGICAL PAGE NO. TO ALLOCATE			;;
   886				;;		T3/ STT ENTRY ADDRESS					;;
   887				;;		U/  UNIT DB						;;
   888				;;									;;
   889				;;	returns	NON-SKIP IF CAN'T HAVE PAGE.				;;
   890				;;		SKIP IF GET PAGE, RETRIEVAL POINTER STORED IN RIB	;;
   891				;;		OF HOME.SYS IN MEMORY.					;;
   892				;;									;;
   893				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   894				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   895
   896	001050'	260040	771054	GETHMP:	PUSHJ	P,TAKPAG	;
   897	001051'	263040	000000		  POPJ	P,		;NOT AVAILABLE.
   898	001052'	260040	771535		PUSHJ	P,HOMRBS	;
   899	001053'	254000	001024*		JRST	CPOPJ1
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 23
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

   900				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   901				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   902				;;									;;
   903				;;	TAKPAG	Marks a page taken and adjust SSTFPC.			;;
   904				;;		Destroys T1 and T2.					;;
   905				;;									;;
   906				;;	expects	T1/ LOGICAL PAGE NO. TO ALLOCATE			;;
   907				;;		T3/ STT ENTRY ADDRESS					;;
   908				;;		U/  UNIT DB						;;
   909				;;									;;
   910				;;	returns	NON-SKIP RETURN IF CAN'T HAVE PAGE.			;;
   911				;;		SKIP RETURN IF GET PAGE, WITH THE RETRIEVAL POINTER	;;
   912				;;		TO THE PAGE IN T2.					;;
   913				;;									;;
   914				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   915				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   916
   917	001054'	265440	000000*	TAKPAG:	JSP	T4,SAVE1	;SAVE P1
   918	001055'	261040	000006		PUSH	P,T1		;SAVE PAGE NEEDED (FOR PNTR.).
   919	001056'	311300	772156		CAML	T1,BEGSAT	;Make sure it is in the SAT that
   920	001057'	313300	772160		CAMLE	T1,LPGSAT	; T3 points to
   921	001060'	260040	772211		 MSGLIV	NOTAVL		;The caller goofed
   922	001061'	274300	772156		SUB	T1,BEGSAT	;Page with the SAT
   923	001062'	231300	000044		IDIVI	T1,^D36
   924	001063'	271300	751000		ADDI	T1,%STA		;
   925	001064'	213000	000007		MOVNS	T2		;
   926	001065'	205600	400000		MOVSI	P1,400000
   927	001066'	242607	000000		LSH	P1,(T2)		;SHIFT BIT INTO POSITION
   928	001067'	262040	000007		POP	P,T2		;
   929	001070'	616606	000000		TDNN	P1,(T1)		;SKIP IF AVAILABLE.
   930	001071'	260040	772211		 MSGLIV	NOTAVL		;NOT AVAILABLE.
   931	001072'	432606	000000		XORM	P1,(T1)		;MARK THE PAGE UNAVAILABLE.
   932	001073'	661340	000454*		TLO	T2,RBREAL	;MAKE T2
   933	001074'	135300	000000*		LDB	T1,UNYLUN	;A
   934	001075'	137300	000620*		DPB	T1,RBYUNI	;RETRIEVAL POINTER.
   935	001076'	370010	000770*		SOS	STTFPC(T3)	;
   936	001077'	254000	001053*		JRST	CPOPJ1
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 24
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

   937				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   938				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   939				;;									;;
   940				;;	MAKPAG	Makes a retrieval pointer out of the page number in	;;
   941				;;		T1 and returns it in T2.				;;
   942				;;									;;
   943				;;	expects	T1/ logical page number on unit				;;
   944				;;		U/  unit data block					;;
   945				;;									;;
   946				;;	returns	T2/ retrieval pointer					;;
   947				;;									;;
   948				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   949				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   950
   951	001100'	261040	000006	MAKPAG:	PUSH	P,T1		; Save page.
   952	001101'	200340	000006		MOVE	T2,T1		; Copy for pointer.
   953	001102'	661340	001073*		TLO	T2,RBREAL	; Make T2
   954	001103'	135300	001074*		LDB	T1,UNYLUN	; a
   955	001104'	137300	001075*		DPB	T1,RBYUNI	; Retrieval pointer.
   956	001105'	262040	000006		POP	P,T1		; Restore page
   957	001106'	263040	000000		POPJ	P,		;  and return
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 25
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

   958				COMMENT #
   959				@@SUBROUTINE UFDSET
   960				@@PURPOSE
   961				SUBR TO SET UP INFORMATION IN A UFD RIB IN %TMP AND THEN WRITE IT OUT.
   962				@@ENTRY
   963				EXPECTS T1/ FILENAME OF UFD, T2/EXT+PROT     U/ UNIT DB, P1/ AOBJN PNTR TO
   964				FILENAMES, AND P2/ ARG. FOR RIBUSD.
   965				@@CALLS
   966				HASH, RIBSET, OGETPG, AND TMPOUT.
   967				@@EXIT
   968				NON-SKIP RETURNS IF ERROR, ELSE SKIP RETURNS WITH
   969				T2/ DISK PNTR TO RIB ITSELF.
   970				@@ #
   971
   972	001107'	261040	000015	UFDSET:	PUSH	P,P2		;RIBUSD
   973	001110'	200400	000352*		MOVE	T3,MFDPPN	;T1&T2 HAVE NAME & EXT & PROT
   974	001111'	201440	746000		MOVEI	T4,%TMP		;
   975	001112'	201740	000000*		MOVEI	P4,RIPDIR	;SET DIRECTORY BIT IN STATUS
   976	001113'	260040	772022		PUSHJ	P,RIBSET	;SET UP INFO IN RIB IN CORE.
   977	001114'	262040	000007		POP	P,T2		;STORE NO. OF PAGES IN ALL THE
   978	001115'	202340	746000*		MOVEM	T2,%TMP+RIBUSD	;FILES THIS UFD POINTS TO.
   979	001116'	202340	746000*		MOVEM	T2,%TMP+RIBMXA	;
   980				    ;SET UP UFDHSI NON-EXISTENT PNTRS.
   981	001117'	201300	000607*		MOVEI	T1,UFDHSI	;SET UP UFDHSI
   982	001120'	201340	434164		MOVEI	T2,(SIXBIT/CAT/) ;NON-EXISTENT PNTRS
   983	001121'	202346	745777*		MOVEM	T2,%TMP+RIBPFS-1(T1) ;IN THE PRIME
   984	001122'	367300	771121		SOJG	T1,.-1		;RIB.
   985				    ;SET UP THE REAL PNTRS.
   986	001123'	201700	000001		MOVEI	P3,1		;COUNT FOR RIBALP.
   987	001124'	322600	771133		JUMPE	P1,UFDST3	;All done if UFD has no files
   988				REPEAT 0,<;Removed 15-May-87, changed to allocate 7 data pages)
   989				PRINTF (<[Should allocate all 14. data pages in UFDSET for UFD project]>)
   990				UFDST1:	MOVE	T1,R.FILE(P1)	;GET T1/ FIRST FILENME.
   991					PUSHJ	P,HASH		;HASH IT TO T1.
   992					MOVE	T2,%TMP+RIBPFS-1(T1) ;PNTR FOR THIS FILE'S PAGE.
   993					TLNE	T2,RBREAL	;HAS IT ALREADY BEEN MADE REAL?
   994					  JRST	UFDST2		;YES.
   995					MOVE	P2,T1		;SAVE PLACE.
   996					PUSHJ	P,OGETPG	;NO, GET A PAGE FOR IT.
   997					  POPJ	P,		;LOST.
   998					ADDI	P3,1		;COUNT FOR RIBALP.
   999					MOVEM	T2,%TMP+RIBPFS-1(P2) ;STORE THE REAL PNTR.
  1000				UFDST2:	AOBJN	P1,UFDST1	;CONTINUE FOR ALL FILES.
  1001				>  ;End of REPEAT 0
  1002				page
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 26
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1003				;If the UFD has any files in it at all, allocate UFDHSI data pages.
  1004				;P3 starts at 1, gets set to total pages (including RIB page).
  1005
  1006	001125'	201640	001117*		MOVEI	P2,UFDHSI	;Number of hash buckets
  1007	001126'	260040	771435	UFDST1:	PUSHJ	P,OGETPG	;Get a UFD data pages
  1008	001127'	263040	000000		  POPJ	P,		;Error
  1009	001130'	202356	745777*		MOVEM	T2,%TMP+RIBPFS-1(P3)
  1010	001131'	271700	000001		ADDI	P3,1		;Count for RIBALP
  1011	001132'	367640	771126		SOJG	P2,UFDST1	;Do all 7
  1012				;End of new code added 15-May-87
  1013
  1014	001133'	202700	746000*	UFDST3:	MOVEM	P3,%TMP+RIBALP	;STORE RIBALP.
  1015	001134'	201700	000000*		MOVEI	P3,UFDHSI*1000	;CALC AND
  1016	001135'	202700	746000*		MOVEM	P3,%TMP+RIBSIZ	;STORE RIBSIZ.
  1017	001136'	260040	771435		PUSHJ	P,OGETPG	;GET A PAGE FOR THE
  1018	001137'	263040	000000		  POPJ	P,
  1019	001140'	202340	746000*		MOVEM	T2,%TMP+RIBSLF	;RIB.
  1020	001141'	260040	771563		PUSHJ	P,TMPOUT	;WRITE OUT THE RIB.
  1021	001142'	263040	000000		  POPJ	P,
  1022	001143'	200340	746000*		MOVE	T2,%TMP+RIBSLF	;
  1023	001144'	254000	001077*		JRST	CPOPJ1
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 27
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1024				COMMENT #
  1025				@@SUBROUTINE SETUFD
  1026				@@PURPOSE
  1027				SUBR TO SET UP INFO IN THE PAGES OF A UFD AND THEN WRITE THEM OUT.
  1028				@@ENTRY
  1029				EXPECTS P1/ -LOOP COUNTER,,INDEX TO FIRST FILENAME.
  1030				EXPECTS PRIME RIB TO BE SET UP IN %TMP.
  1031				@@ACCUM
  1032				DESTROYS contents of page %T2P
  1033				@@EXIT
  1034				SKIP RETURNS UNLESS ERROR, IN WHICH CASE NON-SKIP RETURNS.
  1035				@@ #
  1036
  1037	001145'	261040	000015	SETUFD:	PUSH	P,P2		;SAVE P2.
  1038	001146'	201640	000001		MOVEI	P2,1		;P2/ CURRENT HASH NUMBER.
  1039
  1040	001147'	200355	745777*	SETUF1:	MOVE	T2,%TMP+RIBPFS-1(P2) ;T2/ ASSOCIATED RIB PNTR.
  1041	001150'	603340	001102*		TLNE	T2,RBREAL	;ANY FILE WITH THIS HASH?
  1042	001151'	254000	771156		 JRST	SETUF2		;YES, GO MAKE ENTRIES.
  1043
  1044				    ;HERE TO TRY NEXT HASH NUMBER, OR TO FINISH UP.
  1045	001152'	305640	001125*	SETUFN:	CAIGE	P2,UFDHSI	;ALL DONE?
  1046	001153'	344640	771147		 AOJA	P2,SETUF1	;NO, CONTINUE.
  1047	001154'	262040	000015		POP	P,P2		;YES, RESTORE P2.
  1048	001155'	254000	001144*		JRST	CPOPJ1		;End of SETUFD
  1049
  1050				    ;HERE TO MAKE ENTRIES IN ONE PAGE OF THE UFD.
  1051	001156'	201300	745000	SETUF2:	MOVEI	T1,%T2P		;CLEAR AN AREA FOR
  1052	001157'	260040	000000*		PUSHJ	P,CORZER	;THE UFD IN CORE, IN %T2P.
  1053	001160'	200300	772216		MOVE	T1,[XWD -776,%T2P] ;776 DIVIDES EVENLY BY 5.
  1054	001161'	202300	772155		MOVEM	T1,UFDSTP	;SET UP AOBJN PNTR FOR ENTUFD.
  1055	001162'	261040	000014		PUSH	P,P1		;P1.
  1056	001163'	200314	772102	SETUF4:	MOVE	T1,R.FILE(P1)	;Get filename or PPN
  1057	001164'	260040	771201		PUSHJ	P,HASH		;GET HASH TO T1.
  1058	001165'	306315	000000		CAIN	T1,(P2)		;MATCH FOR THIS BLOCK?
  1059	001166'	260040	771205		 PUSHJ	P,ENTUFD	;YES, MAKE THE UFD
  1060	001167'	253600	771163		AOBJN	P1,SETUF4	;
  1061	001170'	262040	000014	SETUF5:	POP	P,P1		;RESTORE P1
  1062	001171'	201140	001002*		MOVEI	PG,%T2P.P	;WRITE
  1063	001172'	200355	745777*		MOVE	T2,%TMP+RIBPFS-1(P2)	;OUT
  1064	001173'	135440	001012*		LDB	T4,RBYPNO	;THE
  1065	001174'	135240	001104*		LDB	U,RBYUNI	;PAGE
  1066	001175'	200245	000621*		MOVE	U,UNTTBL(U)	;OF THE
  1067	001176'	260040	001013*		PUSHJ	P,OPAGOT	;UFD.
  1068	001177'	263040	000000		  POPJ	P,
  1069	001200'	254000	771152		JRST	SETUFN		;Next hash bucket
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 28
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1070				;LITTLE SUBR TO HASH A FILENAME FOR A UFD.
  1071				;EXPECTS FILENAME IN T1, RETURNS HASH IN T2, DESTROYS T1.
  1072
  1073	001201'	621300	400000	HASH:	TLZ	T1,(1B0)	;Clear sign bit (so remainder is positive)
  1074	001202'	231300	001152*		IDIVI	T1,UFDHSI
  1075	001203'	201307	000001		MOVEI	T1,1(T2)	;By convention, the first bucket is 1 not 0
  1076	001204'	263040	000000		POPJ	P,
  1077
  1078
  1079
  1080				COMMENT #
  1081				@@SUBROUTINE ENTUFD
  1082				@@PURPOSE
  1083				SUBR TO MAKE AN ENTRY IN A UFD.
  1084				@@ENTRY
  1085				EXPECTS P1/ TABLE INDEX OF FILE TO ENTER
  1086				AND UFDSTP/ AOBJN POINTER TO UFD IN CORE.
  1087				@@ACCUM
  1088				DESTROYS T1 THRU T4 AND U.
  1089				@@ #
  1090
  1091			000000	XP UFDNAM,0	;File name
  1092			000001	XP UFDEXT,1	;Extension, file flags, protection
  1093			000002	XP UFDCDT,2	;Creation date and time
  1094			000003	XP UFDLIC,3	;File size and license
  1095			000004	XP UFDRIB,4	;Retrieval pointer to the RIB
  1096			000005	XP UFDSIZ,5	;Number of words in a UFD entry
  1097
  1098	001205'	336314	772127	ENTUFD:	SKIPN	T1,R.RIBS(P1)	;Do we have a RIB for this file?
  1099	001206'	263040	000000		 POPJ	P,
  1100	001207'	331440	772155		SKIPL	T4,UFDSTP	;SKIP IF STILL ROOM IN THIS PAGE.
  1101	001210'	260040	772217		 MSGSFE	UFDERR
  1102	001211'	202311	000004		MOVEM	T1,UFDRIB(T4)	;STORE RETRIEVAL POINTER
  1103	001212'	200314	772102		MOVE	T1,R.FILE(P1)	;FILE NAME
  1104	001213'	510354	772111		HLLZ	T2,R.EXPR(P1)	;EXTENSION
  1105	001214'	202311	000000		MOVEM	T1,UFDNAM(T4)	;STORE FILE NAME
  1106	001215'	502351	000001		HLLM	T2,UFDEXT(T4)	;AND EXTENSION.
  1107	001216'	135340	772226		LDB	T2,[POINT 9,R.EXPR(P1),^D26]
  1108	001217'	542351	000001		HRRM	T2,UFDEXT(T4)	;NO FLAG BITS, PROTECTION IN BITS 27-35
  1109	001220'	550340	000000*		HRRZ	T2,THSDAT##	;Today's date
  1110	001221'	135400	772227		LDB	T3,[POINT 2,T2,23]
  1111	001222'	137400	772230		DPB	T3,[POINT 2,T2,6];High two bits
  1112	001223'	202351	000002		MOVEM	T2,UFDCDT(T4)	;Creation date
  1113	001224'	200340	000000*		MOVE	T2,TIME##	;Ticks since midnight
  1114	001225'	230340	000000*		IDIV	T2,JFYSEC##	;Convert to seconds
  1115	001226'	137340	772231		DPB	T2,[POINT 17,UFDCDT(T4),23]
  1116	001227'	200354	772120		MOVE	T2,R.SIZE(P1)
  1117	001230'	516351	000003		HRLZM	T2,UFDLIC(T4)	;ALLOCATED SIZE, NO LICENSE
  1118	001231'	270440	772232		ADD	T4,[XWD UFDSIZ,UFDSIZ]	;BUMP POINTER
  1119	001232'	202440	772155		MOVEM	T4,UFDSTP	;RESTORE POINTER
  1120	001233'	263040	000000		POPJ	P,
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 29
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1121				COMMENT #
  1122				@@SUBROUTINE RBNFIL
  1123				@@PURPOSE
  1124				SUBR TO SET UP A RIB IN CORE IN %TMP.P, GET A SPECIFIED
  1125				NO. OF PAGES ON A UNIT, STORE THEIR RETRIEVAL PNTRS
  1126				IN THE RIB(S), AND WRITE OUT THE RIB(S).
  1127				@@ENTRY
  1128				EXPECTS:
  1129					T1/ FILE NAME
  1130					T2/ EXT,,PROT
  1131					T3/ PPN
  1132					T4/ NUMBER OF PAGES TO ALLOCATE (NOT INCLUDING RIBS).
  1133					P4/ BITS TO SET IN STATUS WORD
  1134					U/ UNIT DB
  1135				@@ACCUM
  1136				DESTROYS
  1137				@@CALLS
  1138				RIBSET, OGETPG, OPAGOT, SATSRH, GETSAT, GETPRM, AND PTREXT.
  1139				@@EXIT
  1140				IF ERROR, NON-SKIP RETURNS, ELSE SKIP
  1141				RETURNS WITH PRIME RIB IN %TMP (ALREADY WRITTEN OUT)
  1142				AND PGSRIB INCREMENTED FOR EACH RIB (OTHER THAN THE PRIME RIB)
  1143				GENERATED.
  1144				@@ #
  1145
  1146				    ;SET UP THE PRIME RIB IN CORE.
  1147	001234'	202440	771335	RBNFIL:	MOVEM	T4,PAGNED	;SAVE NO. OF PAGES REQUESTED.
  1148	001235'	402000	772166		SETZM	PGSRIB		;PGSRIB HOLDS NO. OF SPARE RIBS GENERATED.
  1149	001236'	201440	746000		MOVEI	T4,%TMP		;SET UP THE
  1150	001237'	260040	772022		PUSHJ	P,RIBSET	;RIB AREA.
  1151	001240'	201440	000001		MOVEI	T4,1		;SET NO. OF PAGES
  1152	001241'	270440	771335		ADD	T4,PAGNED	;PLUS ONE
  1153	001242'	202440	746000*		MOVEM	T4,%TMP+RIBALP	;RIB.
  1154	001243'	260040	771435		PUSHJ	P,OGETPG	;GET A DISK PAGE FOR THE RIB.
  1155	001244'	263040	000000		  POPJ	P,
  1156	001245'	202340	746000*		MOVEM	T2,%TMP+RIBSLF	;STORE SELF RIB PNTR.
  1157	001246'	505300	000000*		HRLI	T1,-RBLVPR-1	;SET UP
  1158	001247'	541300	745777*		HRRI	T1,%TMP+RIBPFS-1
  1159	001250'	202300	772150		MOVEM	T1,TMPRBP	;PNTR TO RIB AREA.
  1160
  1161				    ;LOOK FOR DISK SPACE. SEARCH FOR THE SAT ON THIS UNIT WITH THE MOST SPACE.
  1162
  1163	001251'	403600	000015	RBNFL1:	SETZB	P1,P2		;CLR MAX FOUND AND INDEX.
  1164	001252'	550305	000772*		HRRZ	T1,UNISTT(U)	;T1/ INDEX INTO STT.
  1165	001253'	336346	001010*	RBNFL2:	SKIPN	T2,STTPTR(T1)	;AT E O TABLE?
  1166	001254'	254000	771267		 JRST	RBNFL4		;YES.
  1167	001255'	336406	001076*		SKIPN	T3,STTFPC(T1)	;NO. ANY FREE PAGES IN THIS SAT?
  1168	001256'	254000	771265		 JRST	RBNFL3		;NO.
  1169	001257'	311400	771335		CAML	T3,PAGNED	;YES. ENOUGH TO SATISFY REQUEST?
  1170	001260'	254000	771273		 JRST	RBNFL6		;YES.
  1171	001261'	317400	000015		CAMG	T3,P2		;NO. FOUND MORE THAN MAX SEEN ALREADY?
  1172	001262'	254000	771265		 JRST	RBNFL3		;NO.
  1173	001263'	200640	000010		MOVE	P2,T3		;YES, SAVE IT AS
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 29-2
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1174	001264'	200600	000006		MOVE	P1,T1		;MAX.
  1175	001265'	271300	000675*	RBNFL3:	ADDI	T1,STTLEN	;NO.  LOOK AT NEXT
  1176	001266'	254000	771253		JRST	RBNFL2		;SAT ENTRY IN STT.
  1177
  1178				      ;HERE AT END OF TABLE.
  1179	001267'	326640	771271	RBNFL4:	JUMPN	P2,.+2		;BETTER HAVE FOUND SOMETHING.
  1180	001270'	260040	772203		 MSGLIV	OGTPG
  1181	001271'	261040	000014		PUSH	P,P1		;SAVE SAT'S INDEX IN STT.
  1182	001272'	334354	001253*		SKIPA	T2,STTPTR(P1)	;T2/ SAT'S DISK POINTER.
  1183
  1184				    ;HERE TO READ IN THE SAT.
  1185	001273'	261040	000006	RBNFL6:	PUSH	P,T1		;SAVE SAT'S INDEX IN STT.
  1186	001274'	260040	771476		PUSHJ	P,GETSAT	;
  1187					  JRST	[POP  P,T1
  1188	001275'	254000	772233			 POPJ P,]
  1189	001276'	200640	771335		MOVE	P2,PAGNED	;SET UP ARGS
  1190	001277'	262040	000014		POP	P,P1		;FOR SATSRH. (CLRS BITS & RETURNS
  1191
  1192				    ;HERE TO GET SOME SPACE IN THE SAT.
  1193	001300'	260040	771336	RBNFL7:	PUSHJ	P,SATSRH	;T2/ DISK PNTR AND T1/ COUNT.).
  1194	001301'	263040	000000		  POPJ	P,
  1195	001302'	200700	000006		MOVE	P3,T1		;P3/ # PAGES GOTTEN.
  1196	001303'	200640	771335		MOVE	P2,PAGNED	;CALC NO.
  1197	001304'	274640	000016		SUB	P2,P3		;LEFT TO
  1198	001305'	202640	771335		MOVEM	P2,PAGNED	;GET.
  1199	001306'	260040	771642	RBNFL8:	PUSHJ	P,PTREXT 	;STORE THE
  1200	001307'	263040	000000		  POPJ	P,
  1201	001310'	363700	771312		SOJLE	P3,.+2		;DISK POINTERS
  1202	001311'	344340	771306		AOJA	T2,RBNFL8	;TO GOTTEN SPACE.
  1203
  1204	001312'	323640	771316		JUMPLE	P2,RBNFL9	;MORE PAGES TO GET?
  1205	001313'	333014	001255*		SKIPLE	STTFPC(P1)	;YES.  MORE ROOM IN THIS SAT?
  1206	001314'	254000	771300		 JRST	RBNFL7		;YES.
  1207	001315'	254000	771251		JRST	RBNFL1		;NO.
  1208
  1209				    ;HERE WHEN DONE STORING PNTRS (EXCEPT FOR EOF PNTR).
  1210	001316'	400340	000000	RBNFL9:	SETZ	T2,		;STORE
  1211	001317'	260040	771642		PUSHJ	P,PTREXT	;EOF PNTR.
  1212	001320'	263040	000000		  POPJ	P,
  1213	001321'	336000	772166		SKIPN	PGSRIB		;MORE THAN JUST A PRIME RIB?
  1214	001322'	254000	771327		 JRST	RBNF10		;NO.
  1215	001323'	260040	772000		PUSHJ	P,GETPRM	;YES, GET IT AND
  1216	001324'	263040	000000		  POPJ	P,
  1217	001325'	200600	772166		MOVE	P1,PGSRIB	;ADJUST
  1218	001326'	272600	746000*		ADDM	P1,%TMP+RIBALP	;RIBALP.
  1219	001327'	200340	746000*	RBNF10:	MOVE	T2,%TMP+RIBSLF	;
  1220	001330'	135440	001173*		LDB	T4,RBYPNO	;WRITE
  1221	001331'	201140	000000*		MOVEI	PG,%TMP.P	;IT
  1222	001332'	260040	001176*		PUSHJ	P,OPAGOT	;OUT.
  1223	001333'	263040	000000		  POPJ	P,
  1224	001334'	254000	001155*		JRST	CPOPJ1
  1225
  1226	001335'	000000	000000	PAGNED: Z		;TEMP STORAGE FOR RBNFIL.
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 30
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1227				COMMENT #
  1228				@@SUBROUTINE SATSRH
  1229				@@PURPOSE
  1230				SUBR TO GET SOME CONTIGUOUS FREE PAGES ON A SAT IN %STA, AND SET THEM IN USE.
  1231				SAT IS GUARANTEED TO HAVE SOME PAGES FREE ON ENTRY.
  1232				@@ENTRY
  1233				EXPECTS P1/ STT ENTRY ADDR OF SAT, P2/ MAX NO. OF PAGES
  1234				TO GET, U/ UNIT NO., AND F/ DDB.
  1235				@@ACCUM
  1236				DESTROYS T1 THRU T4 AND P2.
  1237				@@EXIT
  1238				IF ERROR, NON-SKIP RETURNS
  1239				 ELSE SKIP RETURNS WITH
  1240					T2/ DISK POINTER TO FIRST PAGE GOTTEN
  1241					T1/ NO. OF PAGES ACTUALLY GOTTEN
  1242					THE SAT HAS THE PAGES TAKEN MARKED IN USE.
  1243					STTFPC AND STTAOB ARE ALSO ADJUSTED.
  1244				@@ #
  1245
  1246	001336'	336314	000700*	SATSRH:	SKIPN	T1,STTAOB(P1)	;T1/ CURRENT AOBJN POINTER.
  1247	001337'	254000	771343		 JRST	SATSR2		;START AT START OF SAT IF NONE.
  1248	001340'	332346	000000		SKIPE	T2,(T1)		;ANY FREE BITS IN THIS WORD?
  1249	001341'	254000	771350		 JRST	SATSR3		;YES.
  1250	001342'	253300	771340		AOBJN	T1,.-2		;NO, TRY NEXT WORD.
  1251
  1252	001343'	200300	772235	SATSR2:	MOVE	T1,[XWD -400,%STA] ;T1/ AOBJN PNTR TO START OF SAT.
  1253	001344'	332346	000000		SKIPE	T2,(T1)		;ANY FREE BITS IN THIS WORD?
  1254	001345'	254000	771350		  JRST	SATSR3		;YES.
  1255	001346'	253300	771344		AOBJN	T1,.-2		;NO, TRY NEXT WORD.
  1256	001347'	260040	772203		MSGLIV	OGTPG
  1257
  1258				    ;HERE ON FOUND FIRST FREE PAGE.  BUILD THE DISK POINTER TO IT.
  1259
  1260	001350'	243340	771352	SATSR3:	JFFO	T2,.+2		;GET T3/ NO. OF BITS INTO WORD.
  1261	001351'	256000	770000		 STOPCD
  1262	001352'	551446	027000		HRRZI	T4,-%STA(T1)	;Page # =
  1263	001353'	221440	000044		IMULI	T4,^D36		;         (word in SAT * 36)
  1264	001354'	271450	000000		ADDI	T4,(T3)		;          + (bit in word)
  1265	001355'	550345	001252*		HRRZ	T2,UNISTT(U)	;          + (starting page in SAT)
  1266	001356'	274340	000014		SUB	T2,P1		;
  1267	001357'	213000	000007		MOVNS	T2		;Offset into STT for this unit
  1268	001360'	261040	000010		PUSH	P,T3		;
  1269	001361'	231340	001265*		IDIVI	T2,STTLEN	;
  1270	001362'	221340	022000		IMULI	T2,400*^D36	;Starting page in this SAT
  1271	001363'	262040	000010		POP	P,T3		;
  1272	001364'	271447	000000		ADDI	T4,(T2)		;
  1273	001365'	205340	001150*		MOVSI	T2,RBREAL	;Build a Ret Ptr in T2
  1274	001366'	137440	001330*		DPB	T4,RBYPNO	; (page)
  1275	001367'	135440	001103*		LDB	T4,UNYLUN	;
  1276	001370'	137440	001174*		DPB	T4,RBYUNI	; (unit)
  1277	001371'	261040	000007		PUSH	P,T2		;SAVE IT.
  1278
  1279				    ;NOW FIND ALL THE CONTIGUOUS PAGES WE CAN/WANT, AND MARK THEM TAKEN.
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 30-2
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1280
  1281	001372'	200346	000000		MOVE	T2,(T1)		;T2/ SAT WORD AGAIN.
  1282	001373'	515440	400000		HRLZI	T4,400000	;BUILD THE
  1283	001374'	213000	000010		MOVNS	T3		;MASK IN
  1284	001375'	242450	000000		LSH	T4,(T3)		;T4.
  1285	001376'	202314	001336*		MOVEM	T1,STTAOB(P1)	;SAVE THE AOBJN POINTER.
  1286	001377'	400300	000000		SETZ	T1,		;T1/ # OF FREE PAGES.
  1287	001400'	271400	000044		ADDI	T3,^D36		;T3/ MAX NO.
  1288	001401'	313400	000015		CAMLE	T3,P2		;OF BITS TO LOOK
  1289	001402'	200400	000015		 MOVE	T3,P2		;AT IN THIS WORD.
  1290	001403'	636340	000011	SATSR5:	TDZN	T2,T4		;NEXT PAGE IS FREE?
  1291	001404'	254000	771426		 JRST	SATSR8		;NO, DONE.
  1292	001405'	271300	000001		ADDI	T1,1		;YES, COUNT IT.
  1293	001406'	242440	777777		LSH	T4,-1		;ADJUST THE MASK.
  1294	001407'	367400	771403		SOJG	T3,SATSR5	;CONTINUE IN THIS WORD.
  1295	001410'	311300	000015		CAML	T1,P2		;NEED MORE?
  1296	001411'	254000	771426		 JRST	SATSR8		;NO.
  1297	001412'	200414	001376*		MOVE	T3,STTAOB(P1)	;YES, TRY TO GET
  1298	001413'	252400	771426		AOBJP	T3,SATSR8	;NEXT WORD.  IS THERE ONE?
  1299	001414'	202350	777777		MOVEM	T2,-1(T3)	;YES.
  1300	001415'	336350	000000		SKIPN	T2,(T3)		; ANY FREE PAGES IN IT?
  1301	001416'	254000	771430		 JRST	SATSR9		;NO.  DONE.
  1302	001417'	202414	001412*		MOVEM	T3,STTAOB(P1)	;YES.  SAVE AOBJN PNTR.
  1303	001420'	515440	400000		HRLZI	T4,400000	;SET UP MASK FOR NEW WORD.
  1304	001421'	200400	000015		MOVE	T3,P2		;SET UP T3 TO
  1305	001422'	274400	000006		SUB	T3,T1		;MAX. NO. OF
  1306	001423'	303400	000044		CAILE	T3,^D36		;BITS TO LOOK AT
  1307	001424'	201400	000044		 MOVEI	T3,^D36		;IN THIS WORD.
  1308	001425'	254000	771403		JRST	SATSR5		;GO LOOK AT THIS WORD.
  1309
  1310				    ;HERE ON DONE.
  1311
  1312	001426'	200414	001417*	SATSR8:	MOVE	T3,STTAOB(P1)	;
  1313	001427'	202350	000000		MOVEM	T2,(T3)		;
  1314	001430'	200414	001313*	SATSR9:	MOVE	T3,STTFPC(P1)	;ADJUST THE
  1315	001431'	274400	000006		SUB	T3,T1		;FREE PAGE
  1316	001432'	202414	001430*		MOVEM	T3,STTFPC(P1)	;COUNT.
  1317	001433'	262040	000007		POP	P,T2		;RESTORE T2/ DISK POINTER.
  1318	001434'	254000	001334*		JRST	CPOPJ1
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 31
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1319				COMMENT #
  1320				@@SUBROUTINE OGETPG
  1321				@@PURPOSE
  1322				SUBR TO GET ONE PAGE ON THE DISK.
  1323				@@ENTRY
  1324				EXPECTS F/ DDB AND U/ UNIT DB.
  1325				@@ACCUM
  1326				DESTROYS T1 THRU T4 AND PG.
  1327				@@CALLS
  1328				SATSRH AND GETSAT.
  1329				@@EXIT
  1330				NON-SKIP RETURNS IF NO PAGE AVAILABLE,
  1331				ELSE SKIP RETURNS WITH T2/ DISK PNTR TO THE PAGE.
  1332				@@ #
  1333
  1334	001435'	261040	000014	OGETPG:	PUSH	P,P1		;SAVE P1 AND
  1335	001436'	261040	000015		PUSH	P,P2		;P2.
  1336	001437'	201640	000001		MOVEI	P2,1		;TELL SATSRH WE WANT ONE PAGE.
  1337	001440'	550605	001355*		HRRZ	P1,UNISTT(U)	;P1/ STT ENTRY ADDR.
  1338	001441'	332354	001272*	OGETP2:	SKIPE	T2,STTPTR(P1)	;AT END OF STT?
  1339	001442'	254000	771446		 JRST	OGETP3
  1340	001443'	262040	000015		POP	P,P2
  1341	001444'	262040	000014		POP	P,P1
  1342	001445'	260040	772203		MSGLIV	OGTPG
  1343	001446'	332014	001432*	OGETP3:	SKIPE	STTFPC(P1)	;NO.  ANY FREE PAGES IN THIS SAT?
  1344	001447'	254000	771452		 JRST	OGETP4		;YES.
  1345	001450'	271600	001361*		ADDI	P1,STTLEN	;NO, CONTINUE.
  1346	001451'	254000	771441		JRST	OGETP2		;
  1347
  1348	001452'	260040	771476	OGETP4:	PUSHJ	P,GETSAT	;Read in SAT
  1349	001453'	254000	771461		  JRST	OGETP5
  1350	001454'	260040	771336		PUSHJ	P,SATSRH	;GET T2/ DISK PNTR TO 1ST FREE PAGE.
  1351	001455'	254000	771461		  JRST	OGETP5
  1352	001456'	262040	000015		POP	P,P2		;RESTORE P2 AND
  1353	001457'	262040	000014		POP	P,P1		;P1.
  1354	001460'	254000	001434*		JRST	CPOPJ1
  1355
  1356	001461'	262040	000015	OGETP5:	POP	P,P2
  1357	001462'	262040	000014		POP	P,P1
  1358	001463'	263040	000000		POPJ	P,
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 32
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1359				COMMENT #
  1360				@@SUBROUTINE CNDSWT
  1361				@@PURPOSE
  1362				SUBR TO CONDITIONALLY WRITE OUT A SAT IN CORE.
  1363				@@ACCUM
  1364				DESTROYS U, PG,
  1365				@@EXIT
  1366				SKIP RETURNS UNLESS ERROR, IN WHICH CASE, NON-SKIP RETURNS.
  1367				@@ #
  1368
  1369	001464'	336340	772164	CNDSWT:	SKIPN	T2,SATDSK	;IS THERE A SAT IN %STA?
  1370	001465'	254000	001460*		 JRST	CPOPJ1		;NO, NO NEED TO DO ANYTHING.
  1371	001466'	135440	001366*		LDB	T4,RBYPNO	;YES,
  1372	001467'	135240	001370*		LDB	U,RBYUNI	; WRITE
  1373	001470'	200245	001175*		MOVE	U,UNTTBL(U)	; IT
  1374	001471'	201140	001007*		MOVEI	PG,%STA.P	; OUT.
  1375	001472'	260040	001332*		PUSHJ	P,OPAGOT	;
  1376	001473'	260040	772236		 MSGLIV	IOFAL
  1377	001474'	402000	772164		SETZM	SATDSK		;MARK NO SAT IN CORE.
  1378	001475'	254000	001465*		JRST	CPOPJ1		;SUCCESS RETURN.
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 33
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1379				COMMENT #
  1380				@@SUBROUTINE GETSAT
  1381				@@PURPOSE
  1382				SUBR TO GET A SAT INTO CORE, POSSIBLY WRITING OUT A SAT FIRST.
  1383				@@ENTRY
  1384				EXPECTS T2/ DISK ADDRESS OF DESIRED SAT, U/ UNIT DB, AND F/ DDB.
  1385				@@ACCUM
  1386				DESTROYS
  1387				@@EXIT
  1388				SKIP RETURNS UNLESS ERROR, IN WHICH CASE, NON-SKIP RETURNS.
  1389				@@ #
  1390
  1391	001476'	316340	772164	GETSAT:	CAMN	T2,SATDSK	;ALREADY HAVE THIS SAT IN CORE?
  1392	001477'	254000	001475*		 JRST	CPOPJ1		;YES.  JUST TAKE SUCCESS RETURN.
  1393	001500'	201140	001471*		MOVEI	PG,%STA.P	;NO, IS THERE
  1394	001501'	250340	772164		EXCH	T2,SATDSK	;A SAT
  1395	001502'	322340	771512		JUMPE	T2,GTSAT6	;IN CORE?
  1396	001503'	135440	001466*		LDB	T4,RBYPNO	;YES.  WRITE IT
  1397	001504'	261040	000005		PUSH	P,U		;
  1398	001505'	135240	001467*		LDB	U,RBYUNI	;
  1399	001506'	200245	001470*		MOVE	U,UNTTBL(U)	;
  1400	001507'	260040	001472*		PUSHJ	P,OPAGOT	;OUT.
  1401					  PUSHJ	P,[POP P,T2	;
  1402						EXCH T2,(P)	;
  1403	001510'	260040	772243			MSGLIV 	IOFAL]
  1404	001511'	262040	000005		POP	P,U		;
  1405	001512'	200340	772164	GTSAT6:	MOVE	T2,SATDSK	;HERE TO READ OUR SAT
  1406	001513'	135440	001503*		LDB	T4,RBYPNO	;INTO CORE.
  1407	001514'	260040	000510*		PUSHJ	P,OPAGIN	;
  1408	001515'	260040	772236		 MSGLIV	IOFAL
  1409	001516'	254000	001477*		JRST	CPOPJ1		;
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 34
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1410				COMMENT #
  1411				@@SUBROUTINE SATRBS/HOMRBS
  1412				@@PURPOSE
  1413				VARIOUS SUBRS TO STORE A RETRIEVAL POINTER AND INC RIBALP.
  1414				@@ENTRY
  1415				EXPECTS T2/ RETRIEVAL POINTER TO STORE AND XXXRBP TO BE AN AOBJN POINTER.
  1416				@@ACCUM
  1417				DESTROYS T1.
  1418				@@EXIT
  1419				STOPCDS IF AOBJN POINTER RUNS OUT.
  1420				ELSE RETURNS WITH NEW AOBJN POINTER STORED AND RIBALC ADJUSTED.
  1421				@@ #
  1422
  1423	001517'	200300	772150	TMPRBS:	MOVE	T1,TMPRBP
  1424	001520'	253300	771522		AOBJN	T1,TMPRS1
  1425	001521'	260040	772252		 MSGSFE	RBNOUT
  1426	001522'	202300	772150	TMPRS1:	MOVEM	T1,TMPRBP
  1427	001523'	260040	000000*		PUSHJ	P,SAVT		;SAVE T2,T3,T4
  1428	001524'	201400	746000		MOVEI	T3,%TMP
  1429	001525'	254000	771543		JRST	HOMRS2
  1430
  1431	001526'	200300	772146	SATRBS:	MOVE	T1,SATRBP
  1432	001527'	253300	771531		AOBJN	T1,SATRS1
  1433	001530'	260040	772252		 MSGSFE	RBNOUT
  1434	001531'	202300	772146	SATRS1:	MOVEM	T1,SATRBP
  1435	001532'	260040	001523*		PUSHJ	P,SAVT		;SAVE T2,T3,T4
  1436	001533'	201400	750000		MOVEI	T3,%STR
  1437	001534'	254000	771543		JRST	HOMRS2
  1438
  1439	001535'	200300	772145	HOMRBS:	MOVE	T1,HOMRBP
  1440	001536'	253300	771540		AOBJN	T1,HOMRS1
  1441	001537'	260040	772252		 MSGSFE	RBNOUT
  1442	001540'	202300	772145	HOMRS1:	MOVEM	T1,HOMRBP
  1443	001541'	260040	001532*		PUSHJ	P,SAVT
  1444	001542'	201400	752000		MOVEI	T3,%HMR
  1445	001543'	202346	000000	HOMRS2:	MOVEM	T2,(T1)
  1446	001544'	350010	000000*		AOS	RIBALP(T3)	;COUNT NO. OF PAGES IN THIS FILE.
  1447	001545'	263040	000000		POPJ	P,
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 35
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1448				COMMENT #
  1449				@@SUBROUTINE CLUAOB/CLSAOB
  1450				@@PURPOSE
  1451				SUBRS TO CLEAR OUT THE STTAOB ENTRIES FOR A UNIT (CLUAOB)
  1452				OR FOR ALL UNITS IN A STR (CLSAOB).
  1453				@@ENTRY
  1454				CLUAOB EXPECTS UNIT DB ADDR IN REFUNI.  CLSAOB EXPECTS
  1455				DB ADDB OF FIRST UNIT ON THE STR IN FTSUNI.
  1456				@@ACCUM
  1457				DESTROYS U AND T1.
  1458				@@ #
  1459
  1460	001546'	200240	772162	CLUAOB:	MOVE	U,REFUNI
  1461	001547'	550305	001440*	CLUAB1:	HRRZ	T1,UNISTT(U)	;
  1462	001550'	336006	001441*	CLUAB2:	SKIPN	STTPTR(T1)	;
  1463	001551'	263040	000000		  POPJ	P,
  1464	001552'	402006	001426*		SETZM	STTAOB(T1)	;Zero the AOBJN pointer
  1465	001553'	271300	001450*		ADDI	T1,STTLEN
  1466	001554'	254000	771550		JRST	CLUAB2		;
  1467
  1468	001555'	200240	772161	CLSAOB:	MOVE	U,FSTUNI	;First unit
  1469	001556'	260040	771547		PUSHJ	P,CLUAB1	;
  1470	001557'	554245	000633*		HLRZ	U,UNISTR(U)	;Next unit
  1471	001560'	326240	771556		JUMPN	U,.-2		;
  1472	001561'	263040	000000		POPJ	P,
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 36
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1473				COMMENT #
  1474				@@SUBROUTINE TMPIN/TMPOUT
  1475				@@PURPOSE
  1476				LITTLE SUBRS TO SET UP ARGS AND CALL OPAGIN/OT FOR IO TO/FROM %TMP.
  1477				@@ENTRY
  1478				EXPECT T2/ DISK POINTER OF PAGE TO BE TRANSFERRED.
  1479				@@CALLS
  1480				OPAGIN AND OPAGOT.
  1481				@@ACCUM
  1482				DESTROYS
  1483				@@EXIT
  1484				SKIP RETURN ON SUCCESS.
  1485				@@ #
  1486
  1487	001562'	334400	772261	TMPIN:	SKIPA	T3,[OPAGIN]	;Input
  1488	001563'	201400	001507*	TMPOUT:	 MOVEI	T3,OPAGOT	;Output
  1489	001564'	135440	001513*		LDB	T4,RBYPNO	;GET PAGE NO. FROM T2.
  1490	001565'	135240	001505*		LDB	U,RBYUNI	;GET UNIT DB
  1491	001566'	200245	001506*		MOVE	U,UNTTBL(U)	;ADDR FROM T2 AND UNTTBL.
  1492	001567'	201140	001331*		MOVEI	PG,%TMP.P	;IO TO/FROM %TMP.
  1493	001570'	260050	000000		PUSHJ	P,(T3)		;READ OR WRITE THE PAGE.
  1494	001571'	260040	772236		 MSGLIV	IOFAL
  1495	001572'	254000	001516*		JRST	CPOPJ1		;WON.
  1496
  1497				;Routines to do what TSTSUP.SAV does - read/patch/write disk pages.
  1498
  1499	001573'	202040	772167	TSTSUP::MOVEM	P,SAVEP
  1500					MOVEI	T1,[ASCIZ /TSTSUP routines.
  1501	001574'	201300	772262	Set page number in PAGE, then use PREAD$G to read, and PWRITE$G to write./]
  1502	001575'	260040	771637		PUSHJ	P,CONOUT
  1503					MOVEI	T1,[ASCIZ /
  1504				Data is in %TMP<%TMP+777>0$N.   Use FILES$G to get back to "FILES*".
  1505	001576'	201300	772305	/]
  1506	001577'	260040	771637		PUSHJ	P,CONOUT
  1507	001600'	201340	000001		MOVEI	T2,LPNHOM	;Reset to first HOM page on unit 0
  1508	001601'	202340	772170		MOVEM	T2,PAGE
  1509	001602'	260040	771562		PUSHJ	P,TMPIN		;Read it
  1510	001603'	254000	771635		  JRST	PREAD4
  1511				;*;	JRST	PREAD1		;Show what's been read it
  1512	001604'	201000	772324		MOVEI	0,[ASCIZ \C REFSTR: %TMP6T/ PAGE[\]
  1513	001605'	254000	000001*		JRST	DDT+1		;Tell DDT to unlock the symbol table
  1514
  1515
  1516	001606'	336040	772167	FILES::	SKIPN	P,SAVEP		;Reset PDL
  1517	001607'	254000	000000*		 JRST	SYSDSP##	;If no stack, do 140$G
  1518	001610'	263040	000000		POPJ	P,		;Return to "FILES*" in ONCDSK
  1519
  1520					PURGE	D		;Get rid of D=17 (for dump mode)
  1521			746000		D=%TMP			;Local symbol (only if REFSTR$:)
  1522					EXTERN	DDT
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 37
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1523				;Write data from %TMP to disk address in PAGE
  1524
  1525	001611'	260040	771621	PWRITE::PUSHJ	P,PREAD0	;TSTSUP routine to write a page
  1526	001612'	260040	771563		PUSHJ	P,TMPOUT
  1527	001613'	254000	771635		  JRST	PREAD4		;Error
  1528					PFALL	PREAD		;Verify by reading it back in again
  1529
  1530				;Read data from disk address in PAGE to %TMP
  1531
  1532	001614'	260040	771621	PREAD::	PUSHJ	P,PREAD0	;TSTSUP routine to read a page
  1533	001615'	260040	771562		PUSHJ	P,TMPIN
  1534	001616'	254000	771635		  JRST	PREAD4		;Error
  1535	771617			PREAD1:				;Type out the contents of PAGE
  1536				;*;	MOVEI	T1,[ASCIZ \PAGE/  \]
  1537				;*;	PUSHJ	P,CONMES
  1538				;*;	MOVE	T1,PAGE
  1539				;*;	PUSHJ	P,PRT22A##	;Print 22-bit address
  1540				;*;	PUSHJ	P,CRLFOP
  1541				;*;	JRST	DDT
  1542	001617'	201000	772332		MOVEI	0,[ASCIZ .PAGE/.]
  1543	001620'	254000	000001*		JRST	DDT+1		;Let EDDT type out the data
  1544
  1545	001621'	200340	772170	PREAD0:	MOVE	T2,PAGE		;Set up T2 for TMPIN/TMPOUT
  1546	001622'	135240	001565*		LDB	U,RBYUNI	;Get unit # from bits 9-16 of T2
  1547	001623'	307240	000000*		CAIG	U,UNTLEN##	;Don't exceed size of UNTTBL
  1548	001624'	336245	001566*		SKIPN	U,UNTTBL(U)	;Check if UNTTBL has been set up
  1549	001625'	254000	771631		 JRST	PREAD2		;Out of range or did not go thru FILES
  1550	001626'	135440	001564*		LDB	T4,RBYPNO	;Get page # from T2
  1551	001627'	315445	001034*		CAMGE	T4,UNIPPU(U)	;Within range of page addresses?
  1552	001630'	263040	000000		 POPJ	P,		;OK
  1553	001631'	201300	772334	PREAD2:	MOVEI	T1,[ASCIZ \? PAGE out of range or UNTTBL not set up.  \]
  1554	001632'	260040	000000*		PUSHJ	P,CONMES
  1555	001633'	262041	000000		POP	P,(P)		;Dump return address
  1556	001634'	254000	771617		JRST	PREAD1
  1557
  1558	001635'	201300	772345	PREAD4:	MOVEI	T1,[ASCIZ \?I/O error on \]
  1559	001636'	254000	771617		JRST	PREAD1
  1560
  1561	001637'	260040	001632*	CONOUT:	PUSHJ	P,CONMES	;String in T1 + CRLF + output buffer
  1562	001640'	260040	000000*	CRLFOP:	PUSHJ	P,CRLF##
  1563	001641'	324740	000000*		PJRST	OPOUT
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 38
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1564				COMMENT #
  1565				@@SUBROUTINE PTREXT
  1566				@@PURPOSE
  1567				SUBR TO STORE A RETRIEVAL POINTER IN %TMP ACCORDING TO TMPRBP,
  1568				TAKING INTO ACCOUNT AN EXTENDED RIB STRUCTURE.
  1569				(THIS REALLY DOESN'T NEED THREE LEVELS; ALSO PERHAPS THE
  1570				OGETPG CALLS SHOULD LOOK AT MORE THAN ONE UNIT.)
  1571				@@ENTRY
  1572				EXPECTS TMPRBP AND THE RIB IN %TMP TO BE SET UP,
  1573				T2/ THE RETRIEVAL POINTER TO BE STORED, AND F/ DDB.
  1574				@@CALLS
  1575				RIBEX1, RIBEX2, RIBEX3, RIBEX4, OGETPG, TMPOUT, TMPIN, CORZER AND MOROOM.
  1576				@@ACCUM
  1577				DESTROYS T1, T3, T4, AND PG.
  1578				PRESERVES U.
  1579				@@EXIT
  1580				IF ERROR, NON-SKIP RETURNS, ELSE SKIP RETURNS.
  1581				ON EXIT, THE RIB IN %TMP MAY NOT BE THE RIB THAT WAS THERE
  1582				ON ENTRY.  ON SUCCESSFUL EXIT, TMPRBP WILL BE SET UP PROPERLY
  1583				AND PGSRIB IS INCREMENTED FOR EACH ADDITIONAL RIB GENERATED.
  1584				@@ #
  1585
  1586	001642'	200300	772150	PTREXT:	MOVE	T1,TMPRBP	;GET THE AOBJN PNTR TO THE
  1587	001643'	253300	771652		AOBJN	T1,PTROT2	;RETRIEVAL PNTR STORAGE AREA.
  1588	001644'	261040	000005		PUSH	P,U		;PRESERVE U.
  1589	001645'	254000	771655		JRST	PTREX1		;OUT OF ROOM.
  1590
  1591	001646'	262040	000015	PTROU0:	POP	P,P2		;
  1592	001647'	262040	000014		POP	P,P1
  1593	001650'	262040	000007	PTROUT:	POP	P,T2		;RESTORE THE RETRIEVAL POINTER.
  1594	001651'	262040	000005		POP	P,U		;RESTORE U.
  1595	001652'	202300	772150	PTROT2:	MOVEM	T1,TMPRBP	;STORE THE AOBJN
  1596	001653'	202346	000000		MOVEM	T2,(T1)		;PNTR & RETRIEVAL PNTR.
  1597	001654'	254000	001572*		JRST	CPOPJ1
  1598
  1599				    ;HERE WHEN WE MUST GET ANOTHER RIB.
  1600	001655'	261040	000007	PTREX1:	PUSH	P,T2		;SAVE RET PNTR WE WANT TO STORE.
  1601	001656'	332340	746000*		SKIPE	T2,%TMP+RIBSLF	;GET A DISK PAGE TO WRITE US
  1602	001657'	254000	771663		  JRST	PTREX2		;OUT TO, UNLESS
  1603	001660'	260040	771435		PUSHJ	P,OGETPG	;WE HAVE
  1604	001661'	254000	771766		  JRST	PTRFAL		;ONE
  1605	001662'	202340	746000*		MOVEM	T2,%TMP+RIBSLF	;ALREADY.
  1606	001663'	200300	746000*	PTREX2:	MOVE	T1,%TMP+RIBSZS	;IF NOT AT LOWEST LEVEL
  1607	001664'	367300	771711		SOJG	T1,PTREX3	;AND EO RIB WITH REAL PNTR,
  1608	001665'	336000	746000*		SKIPN	%TMP+RIBRIB	;OR IF ONLY ONE RIB, WE
  1609	001666'	254000	771711		  JRST	PTREX3		;HAVE TO EXPAND.
  1610
  1611				    ;HERE WHEN WE ARE AT LOWEST LEVEL AND THERE IS A HIGHER RIB.
  1612				    ;WE MAY OR MAY NOT HAVE TO EXPAND.
  1613
  1614	001667'	261040	746000*		PUSH	P,%TMP+RIBRPS	;SAVE OUR POSITION FOR MOROOM.
  1615	001670'	260040	771563		PUSHJ	P,TMPOUT	;(WE HAVE ALREADY SET UP T2), SO
  1616	001671'	254000	771765		  JRST	PTRFL1		;WRITE US OUT.
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 38-2
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1617	001672'	200340	746000*		MOVE	T2,%TMP+RIBRIB	;READ IN THE
  1618	001673'	260040	771562		PUSHJ	P,TMPIN		;HIGHER RIB.
  1619	001674'	254000	771765		  JRST	PTRFL1
  1620	001675'	262040	000006		POP	P,T1		;RESTORE OUR POINTER.
  1621	001676'	260040	771771		PUSHJ	P,MOROOM	;ROOM FOR ANY MORE PNTRS IN IT?
  1622	001677'	254000	771650		  JRST	PTROUT		;YES.
  1623	001700'	336340	746000*		SKIPN	T2,%TMP+RIBRIB	;NO. IF THIS IS THE HIGHEST,
  1624	001701'	254000	771711		  JRST	PTREX3		;GO EXPAND.
  1625	001702'	261040	746000*		PUSH	P,%TMP+RIBRPS	;SAVE OUR POSITION FOR MOROOM.
  1626	001703'	260040	771562		PUSHJ	P,TMPIN		;READ IN THE HIGHER
  1627	001704'	254000	771765		  JRST	PTRFL1		;RIB.
  1628	001705'	262040	000006		POP	P,T1		;RESTORE OUR POSITION.
  1629	001706'	260040	771771		PUSHJ	P,MOROOM	;ROOM FOR ANY MORE PNTRS?
  1630	001707'	254000	771650		  JRST	PTROUT		;YES.
  1631	001710'	260040	772351		MSGSFE	RBEOUT		;EXCEEDED 3 LEVELS (IMPOSSIBLE!)
  1632
  1633				    ;HERE TO EXPAND THE RIB STRUCTURE.
  1634
  1635	001711'	201300	745000	PTREX3:	MOVEI	T1,%T2P		;CLEAR OUT A SPARE RIB
  1636	001712'	260040	001157*		PUSHJ	P,CORZER	;IN %T2P.
  1637	001713'	350000	772166		AOS	PGSRIB		;COUNT IT.
  1638	001714'	260040	771435		PUSHJ	P,OGETPG	;GET A PAGE
  1639	001715'	254000	771766		  JRST	PTRFAL		;FOR
  1640	001716'	202340	745000*		MOVEM	T2,%T2P+RIBSLF	;IT.
  1641	001717'	201300	000000*		MOVEI	T1,CODRIB	;SET ITS
  1642	001720'	202300	745000*		MOVEM	T1,%T2P+RIBCOD	;RIBCOD.
  1643	001721'	261040	000014		PUSH	P,P1		;SET UP THE
  1644	001722'	261040	000015		PUSH	P,P2		;ARGS
  1645	001723'	201600	746000		MOVEI	P1,%TMP		;FOR
  1646	001724'	201640	745000		MOVEI	P2,%T2P		;THE RIBEX? SUBRS.
  1647	001725'	200300	746000*		MOVE	T1,%TMP+RIBLST	;JUMP UNLESS LAST PNTR IN OUR
  1648	001726'	325300	771732		JUMPGE	T1,PTREX4	;SOURCE RIB IS A SPARE RIB PNTR.
  1649
  1650				    ;HERE TO EXPAND FROM TWO LEVELS TO THREE.
  1651
  1652	001727'	260040	000000*		PUSHJ	P,RIBEX1	;SET UP INFO IN BOTH RIBS.
  1653	001730'	201440	000000*		MOVEI	T4,RIBSFS+RBLVPR-1 ;
  1654	001731'	254000	771750		JRST	PTRE45		;
  1655
  1656
  1657				    ;HERE ON ALL RIB EXPANSION EXCEPT FROM TWO LEVELS TO THREE.
  1658
  1659	001732'	260040	000000*	PTREX4:	PUSHJ	P,RIBEX2	;SET UP INFO IN BOTH RIBS.
  1660	001733'	254000	771750		  JRST	PTRE45		;NEED NO INTERMED RIB.
  1661	001734'	261040	000011		PUSH	P,T4		;NEED INTERMED RIB.  SAVE RPS.
  1662	001735'	260040	771435		PUSHJ	P,OGETPG	;
  1663	001736'	254000	771761		  JRST	PTRFL2
  1664	001737'	350000	772166		AOS	PGSRIB		;COUNT THE INTERMEDIATE RIB.
  1665	001740'	260040	000000*		PUSHJ	P,RIBEX3	;LINK IT IN.
  1666	001741'	200340	746000*		MOVE	T2,%TMP+RIBSLF	;
  1667	001742'	260040	771563		PUSHJ	P,TMPOUT	;WRITE OUT THE
  1668	001743'	254000	771761		  JRST	PTRFL2		;HIGHEST RIB.
  1669	001744'	201300	746000		MOVEI	T1,%TMP		;CLEAR SPACE FOR THE
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 38-3
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1670	001745'	260040	001712*		PUSHJ	P,CORZER	;INTERMEDIATE RIB.
  1671	001746'	265440	000000*		JSP	T4,RIBEX4	;SET UP MORE STUFF.
  1672	001747'	262040	000011		POP	P,T4		;RESTORE RPS.
  1673
  1674
  1675	001750'	515611	000000*	PTRE45:	HRLZI	P1,-RIBLST(T4)	;SET UP THE AOBJN PNTR
  1676	001751'	541611	746001		HRRI	P1,%TMP+1(T4)	;FOR PTROU0.
  1677	001752'	200340	746000*		MOVE	T2,%TMP+RIBSLF	;WRITE OUT
  1678	001753'	260040	771563		PUSHJ	P,TMPOUT	;A RIB.
  1679	001754'	254000	771762		  JRST	PTRFL0
  1680	001755'	200300	772360		MOVE	T1,[XWD %T2P,%TMP] ;COPY THE NEW RIB TO
  1681	001756'	251300	746777		BLT	T1,%TMP+777	;THE CURRENT RIB AREA.
  1682	001757'	200300	000014		MOVE	T1,P1		;GET AOBJN PNTR FOR PTROUT.
  1683	001760'	254000	771646		JRST	PTROU0		;
  1684
  1685
  1686	001761'	262040	000006	PTRFL2:	POP	P,T1		;VARIOUS
  1687	001762'	262040	000015	PTRFL0:	POP	P,P2
  1688	001763'	262040	000014		POP	P,P1		;ERROR
  1689	001764'	254000	771766		JRST	PTRFAL
  1690
  1691	001765'	262040	000006	PTRFL1:	POP	P,T1		;EXITS.
  1692	001766'	262040	000007	PTRFAL:	POP	P,T2
  1693	001767'	262040	000005		POP	P,U
  1694	001770'	263040	000000		POPJ	P,
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 39
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1695				COMMENT #
  1696				@@SUBROUTINE MOROOM
  1697				@@PURPOSE
  1698				LITTLE SUBR TO SEE IF THERE IS ANY MORE ROOM IN A RIB IN
  1699				%TMP TO STORE POINTERS.
  1700				@@ENTRY
  1701				EXPECTS T1/RIBRPS FROM LOWER RIB.
  1702				@@ACCUM
  1703				DESTROYS T1 AND T2.
  1704				@@EXIT
  1705				SKIP RETURNS IF NO MORE ROOM.  NON-SKIP RETURNS IF THERE IS
  1706				MORE ROOM, WITH T1/ AOBJN POINTER TO ROOM.
  1707				@@ #
  1708
  1709	001771'	271300	746001	MOROOM:	ADDI	T1,%TMP+1	;GET ADDR OF NEXT POINTER.
  1710	001772'	303300	746000*		CAILE	T1,%TMP+RIBLST	;PAST E O RIB?
  1711	001773'	254000	001654*		 JRST	CPOPJ1		;YES, RETURN.
  1712	001774'	201346	000000		MOVEI	T2,(T1)		;NO.  MAKE THE USED AOBJN
  1713	001775'	275340	746000*		SUBI	T2,%TMP+RIBLST	;PNTR IN T1,
  1714	001776'	505307	777777		HRLI	T1,-1(T2)	;AND TAKE THE
  1715	001777'	263040	000000		POPJ	P,		;SUCCESSFUL RETURN.
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 40
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1716				COMMENT #
  1717				@@SUBROUTINE GETPRM
  1718				@@PURPOSE
  1719				SUBR TO WRITE OUT THE RIB IN CORE IN %TMP AND THEN GET
  1720				ITS PRIME RIB INTO %TMP.
  1721				@@CALLS
  1722				TMPIN AND TMPOUT.
  1723				@@ACCUM
  1724				DESTROYS
  1725				@@EXIT
  1726				SKIP RETURNS UNLESS ERROR, IN WHICH CASE NON-SKIP RETURNS.
  1727				@@ #
  1728
  1729	002000'	336000	746000*	GETPRM:	SKIPN	%TMP+RIBRIB	;Check if there is a pointer to upper level
  1730	002001'	254000	001773*		 JRST	CPOPJ1		;Already at prime RIB
  1731	002002'	201600	000002		MOVEI	P1,2		;CHECK FOR 2 more levels
  1732	002003'	261040	746000*	GETPR4:	PUSH	P,%TMP+RIBRIB	;SAVE ADDR OF HIGHER RIB.
  1733	002004'	332340	746000*		SKIPE	T2,%TMP+RIBSLF	;IF NECESSARY, GET
  1734	002005'	254000	772010		  JRST	GETPR5		;
  1735	002006'	260040	771435		PUSHJ	P,OGETPG	;A PAGE FOR THE
  1736					  JRST	[POP  P,T1
  1737	002007'	254000	772233			 POPJ P,]
  1738	002010'	202340	746000*	GETPR5:	MOVEM	T2,%TMP+RIBSLF	;CURRENT RIB.
  1739	002011'	260040	771563		PUSHJ	P,TMPOUT	;
  1740					  JRST	[POP  P,T1
  1741	002012'	254000	772233			 POPJ P,]
  1742	002013'	262040	000007		POP	P,T2		;READ IN THE
  1743	002014'	260040	771562		PUSHJ	P,TMPIN		;HIGHER RIB.
  1744	002015'	263040	000000		  POPJ	P,
  1745	002016'	336000	746000*		SKIPN	%TMP+RIBRIB	;DONE?
  1746	002017'	254000	002001*		 JRST	CPOPJ1		;YES
  1747	002020'	367600	772003		SOJG	P1,GETPR4	;NO, DON'T DO MORE THAN 3 LEVELS.
  1748	002021'	260040	772361		MSGSFE	RIBFAL
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 41
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1749				COMMENT #
  1750				@@SUBROUTINE RIBSET
  1751				@@PURPOSE
  1752				SUBR TO SET UP PRIME RIB INFORMATION IN A SPECIFIED AREA IN CORE.
  1753				@@ENTRY
  1754				EXPECTS:
  1755					T1=NAME OF FILE
  1756					T2=EXT,,PROTECTION
  1757					T3=PPN
  1758					T4=ADDR OF CORE AREA TO BE SET UP.
  1759					P4=BITS TO SET IN STATUS WORD
  1760				@@ACCUM
  1761				DESTROYS T1 AND T2.
  1762				@@CALLS
  1763				CORZER.
  1764				@@ #
  1765
  1766	002022'	261040	000006	RIBSET:	PUSH	P,T1		;SAVE T1 AND
  1767	002023'	261040	000007		PUSH	P,T2		;T2 FROM CORZER.
  1768	002024'	200300	000011		MOVE	T1,T4		;ARG FOR CORZER.
  1769	002025'	260040	001745*		PUSHJ	P,CORZER	;CLEAR OUT THE RIB AREA.
  1770	002026'	262040	000007		POP	P,T2		;RESTORE T2 AND
  1771	002027'	262040	000006		POP	P,T1		;T1.
  1772	002030'	202311	000000*		MOVEM	T1,RIBNAM(T4)	;File name
  1773	002031'	512351	000000*		HLLZM	T2,RIBEXT(T4)	;Extension
  1774	002032'	620340	000777		TRZ	T2,777		;Clear possible HOM index from protection
  1775	002033'	516351	000000*		HRLZM	T2,RIBPRV(T4)	;Set protection code
  1776	002034'	202411	000000*		MOVEM	T3,RIBPPN(T4)	;PPN
  1777	002035'	550400	001220*		HRRZ	T3,THSDAT##	;Today's date
  1778	002036'	542411	002033*		HRRM	T3,RIBPRV(T4)	;Set 12-bits creation date (and 2 bits time)
  1779	002037'	542411	002031*		HRRM	T3,RIBEXT(T4)	;Set 14-bits access date
  1780	002040'	242400	777764		LSH	T3,-^D12	;High-order 2 bits of creation date
  1781	002041'	137400	772370		DPB	T3,[POINT 2,RIBEXT(T4),21]
  1782	002042'	200340	001224*		MOVE	T2,TIME##	;Ticks since midnight
  1783	002043'	230340	000000*		IDIV	T2,JFYMIN##	;Convert to minutes
  1784	002044'	137340	772371		DPB	T2,[POINT 11,RIBPVW(T4),23] ;Creation time
  1785	002045'	201400	000001		MOVEI	T3,1		;Single-level RIB structure
  1786	002046'	202411	000475*		MOVEM	T3,RIBSZS(T4)	;
  1787	002047'	201400	001717*		MOVEI	T3,CODRIB	;UNLIKELY CODE
  1788	002050'	202411	000000*		MOVEM	T3,RIBCOD(T4)	;FOR RIB.
  1789	002051'	202751	000000*		MOVEM	P4,RIBSTS(T4)	;
  1790	002052'	606740	001112*		TRNN	P4,RIPDIR	;UFD OR MFD?
  1791	002053'	263040	000000		 POPJ	P,		;NO, RETURN.
  1792				        PFALL	RIBSTU
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 42
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1793				    ;HERE ONLY FOR MFD OR UFDS.
  1794	002054'	200400	770003	RIBSTU:	MOVE	T3,QUOTAF	;YES, SET FCFS
  1795	002055'	202411	000000*		MOVEM	T3,RIBQTF(T4)	; AND
  1796	002056'	200400	770004		MOVE	T3,QUOTAO	; LOGGED OUT
  1797	002057'	202411	000000*		MOVEM	T3,RIBQTO(T4)	; QUOTAS.
  1798	002060'	200340	772372		MOVE	T2,[SIXBIT /UFD/];SET UP
  1799	002061'	316300	772110		CAMN	T1,MFDUFD	; RIBUNM
  1800	002062'	254000	772073		 JRST	RIBST8		; WITH
  1801	002063'	200340	772373		MOVE	T2,[SIXBIT /SYS/];THE
  1802	002064'	316300	772106		CAMN	T1,SYSUFD	; APPROPRIATE
  1803	002065'	254000	772073		 JRST	RIBST8		; NAME
  1804	002066'	312300	772107		CAME	T1,SPLUFD
  1805	002067'	263040	000000		 POPJ	P,		;Unknown PPN, don't set name
  1806	002070'	200340	772374		MOVE	T2,[SIXBIT /NG/]
  1807	002071'	202351	000000*		MOVEM	T2,RIBUN1(T4)
  1808	002072'	200340	772375		MOVE	T2,[SIXBIT /SPOOLI/]
  1809	002073'	202351	000000*	RIBST8:	MOVEM	T2,RIBUNM(T4)
  1810	002074'	263040	000000		POPJ	P,
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 43
REFSTR.MAC	20-NOV-87 22:23		VARIOUS SUBROUTINES.

  1811				COMMENT #
  1812				@@SUBROUTINE CNVSIZ/CNVSZM
  1813				@@PURPOSE
  1814				LITTLE SUBRS TO SET RIBSIZ.
  1815				@@ENTRY
  1816				EXPECTS T1/ ADDR OF RIB IN CORE.
  1817				@@ACCUM
  1818				DESTROYS T2.
  1819				@@ #
  1820
  1821	002075'	374346	001544*	CNVSZM:	SOSA	T2,RIBALP(T1)	;Decrement for later increment (PAKREF)
  1822	002076'	200346	002075*	CNVSIZ:	MOVE	T2,RIBALP(T1)	;Allocated pages so far (excluding RIB)
  1823	002077'	242340	000011		LSH	T2,P2WLSH	;CALCULATE WORDS
  1824	002100'	202346	000464*		MOVEM	T2,RIBSIZ(T1)	;
  1825	002101'	263040	000000		POPJ	P,
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 44
REFSTR.MAC	20-NOV-87 22:23		Tables and storage

  1826				SUBTTL	Tables and storage
  1827
  1828				;The following definitions and table need to be updated if COMMOD is changed.
  1829				;The offsets into the HOM page are defined here for easy reference, LOADER
  1830				;will complain if they differ from the definitions in COMMOD.
  1831
  1832			000014	XP HOMFEP,014	;# of FEFILE data pages ,, First FEFILE data page (unit 0 only)
  1833			000017	XP HOMSAT,017	;RIB for SAT.SYS
  1834			000020	XP HOMHMS,020	;RIB for HOME.SYS
  1835			000021	XP HOMSPG,021	;Prime RIB for SPAGES.SYS (formerly SWAP.SYS)
  1836			000022	XP HOMCRS,022	;Prime RIB for CRASH.SAV (8192+ pages on KL)
  1837			000023	XP HOMSUF,023	;RIB for (SYS) [1,4].UFD
  1838			000024	XP HOMPUF,024	;RIB for (SPOOLING) [11653,115244].UFD
  1839			000025	XP HOMMFD,025	;RIB for (UFD) [1,1].UFD
  1840			000026	XP HOMP4C,026	;Number of pages allocated to CRASH.SAV
  1841				EXTERN SYRDPR,SYNRPR	;Read and no-read protection for *.SYS files
  1842				EXTERN SYSPPN,SYSPRV	;PPN for SYS and protection for that directory
  1843				EXTERN MFDPPN,MFDPRV	;PPN for MFD and protection for that directory
  1844				EXTERN SPLPPN		;PPN for (SPOOLING)
  1845
  1846				DEFINE ITEMS<;;SYS files must come before UFDs, otherwise can be in any order
  1847				;;NAM,FILENAME,EXT,PROT,INDEX,PCB
  1848				X HOM,HOME  ,SYS,SYRDPR,HOMHMS,HMR;;020  HOME.SYS   HOME, BAT and BOOTS
  1849				X SAT,SAT   ,SYS,SYRDPR,HOMSAT,STR;;017  SAT.SYS    SAT file
  1850				X CRS,CRASH ,SAV,SYNRPR,HOMCRS    ;;022  CRASH.SAV  (later .EXE) crash file
  1851				X SPG,SPAGES,SYS,SYNRPR,HOMSPG,TMP;;021  SPAGES.SYS Spare PAGES file, cyl 1 & 2
  1852				IFCPU (KS),<;;Note: pointer to RIB is NOT stored in HOM page.
  1853				X FEF,FEFILE,SYS,SYNRPR,0 >       ;;014  FEFILE.SYS for 2020 front-end
  1854				  ;;The UFDs must be last
  1855				X SYS,SYSPPN,UFD,SYSPRV,HOMSUF    ;;023  (SYS).UFD
  1856				X SPL,SPLPPN,UFD,754000,HOMPUF    ;;024  (SPOOLING).UFD
  1857				X MFD,MFDPPN,UFD,MFDPRV,HOMMFD    ;;025  (UFD).UFD
  1858				> ; End Define ITEMS
  1859
  1860			000000		NFILE==<NUFDS==0>	;Initialize counters
  1861				DEFINE X(NAM,FILE,EXT,PROT,INDEX,PCB),<
  1862				    IFDIF <EXT>,<UFD>,<NFILE==NFILE+1;;Count number of nonUFD files
  1863				            IFG NUFDS,<PRINTX ? UFDs must be last in ITEMS macro>
  1864				  NAM'FIL: SIXBIT /FILE/>
  1865				    IFIDN <EXT>,<UFD>,<NUFDS==NUFDS+1;;Count number of UFDs
  1866				  NAM'UFD: EXP 0 >;;PPN will be filled in later
  1867				>
  1868	002102'	505755	450000	R.FILE:	ITEMS	
  1869	002103'	634164	000000
  1870	002104'	436241	635000
  1871	002105'	636041	474563
  1872	002106'	000000	000000
  1873	002107'	000000	000000
  1874	002110'	000000	000000
  1875						;File names or addr of PPN
  1876
  1877				DEFINE X(NAM,FILE,EXT,PROT,INDEX,PCB),<
  1878				  NAM'EXP: XWD ''EXT'',PROT+INDEX>
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 44-2
REFSTR.MAC	20-NOV-87 22:23		Tables and storage

  1879	002111'	637163	000020*	R.EXPR:	ITEMS	
  1880	002112'	637163	000017*
  1881	002113'	634166	000022*
  1882	002114'	637163	000021*
  1883	002115'	654644	000023*
  1884	002116'	654644	754024
  1885	002117'	654644	000025*
  1886						;Extension, protection, index into %HOM
  1887
  1888				DEFINE X(NAM,FILE,EXT,PROT,INDEX,PCB),<
  1889				  NAM'ALP: 0>
  1890	772120			R.ZERB:!			;Start of area to zero
  1891	002120'	000000	000000	R.SIZE:	ITEMS	
  1892	002121'	000000	000000
  1893	002122'	000000	000000
  1894	002123'	000000	000000
  1895	002124'	000000	000000
  1896	002125'	000000	000000
  1897	002126'	000000	000000
  1898						;Allocated size
  1899								;R.SIZE+R.RIBS zeroed before REFRESH
  1900				DEFINE X(NAM,FILE,EXT,PROT,INDEX,PCB),<
  1901				  NAM'RBD: 0>
  1902	002127'	000000	000000	R.RIBS:	ITEMS	
  1903	002130'	000000	000000
  1904	002131'	000000	000000
  1905	002132'	000000	000000
  1906	002133'	000000	000000
  1907	002134'	000000	000000
  1908	002135'	000000	000000
  1909						;RIB data (retrieval pointer)
  1910			772135	R.ZERE==.-1			;End of area to zero
  1911
  1912				DEFINE X(NAM,FILE,EXT,PROT,INDEX,PCB),<;;Generates 0 if PCB is blank
  1913				  NAM'CTL: IFNB <PCB>,<XWD %'PCB,%'PCB'.P;> 0>
  1914	002136'	752000	000214*	R.PCBS:	ITEMS	
  1915	002137'	750000	000176*
  1916	002140'	000000	000000
  1917	002141'	746000	001567*
  1918	002142'	000000	000000
  1919	002143'	000000	000000
  1920	002144'	000000	000000
  1921						;PCB data for files that are on all units
  1922
  1923				DEFINE X(NAM,FILE,EXT,PROT,INDEX,PCB),<IFNB <PCB>,<PCB'RBP:>
  1924				  NAM'RBP: 0 >
  1925	002145'	000000	000000	R.RBPS:	ITEMS	
  1926	002146'	000000	000000
  1927	002147'	000000	000000
  1928	002150'	000000	000000
  1929	002151'	000000	000000
  1930	002152'	000000	000000
  1931	002153'	000000	000000
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 44-3
REFSTR.MAC	20-NOV-87 22:23		Tables and storage

  1932						;Pointers into RIB for adding new pages
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 45
REFSTR.MAC	20-NOV-87 22:23		MISC. DATA LOCATIONS.

  1933				SUBTTL	MISC. DATA LOCATIONS.
  1934
  1935	772154			RANNO::	BLOCK	1	;Holder for RANDOM # for REFRESH
  1936	772155			UFDSTP:	BLOCK	1	;PNTR TO SPACE IN UFD RIB FOR PNTRS.
  1937
  1938	772156			BEGSAT:	BLOCK	1	;First page in SAT
  1939	772157			SVSBTL:	BLOCK	1	;# of pages in SAT
  1940	772160			LPGSAT:	BLOCK	1	;Last page in current SAT
  1941
  1942	772161			FSTUNI:	BLOCK	1	;ADDR OF FIRST UNIT IN STR (FOR REFRSH)
  1943	772162			REFUNI:	BLOCK	1	;STORAGE FOR PAKREF.  (UNIT CURRENTLY BEING REFRESHED)
  1944
  1945	772163			SATIND:	BLOCK	1	;USED AS A TEMPORARY.
  1946
  1947	772164			SATDSK:	BLOCK	1	;FLAG TO PREVENT UNNECESSARY IO ON SAT PAGE.
  1948
  1949	772165			PGSSPG:	BLOCK	1	;USED BY SPAGES AND FEFILE
  1950	772166			PGSRIB:	BLOCK	1	;USED BY RBNFIL, ETC. TO KEEP TRACK OF COUNT OF
  1951							;RIBS AND MAYBE OF PAGES.
  1952
  1953	772167			SAVEP:	BLOCK	1	;Saved PDL
  1954	772170			PAGE::	BLOCK	1	;Current disk page number for TSTSUP
  1955
  1956	772171			REFLIT:	LIT
  1957	002171'	772120	772121
  1958	002172'	777775	000004
  1959	002173'	001106	772111
  1960	002174'	201300	770020
  1961	002175'	260040	000000*
  1962	002176'	260040	001641*
  1963	002177'	262041	000000
  1964	002200'	263040	000000
  1965	002201'	260040	770655
  1966	002202'	777775	000003
  1967	002203'	201300	770013
  1968	002204'	260040	002175*
  1969	002205'	260040	002176*
  1970	002206'	262041	000000
  1971	002207'	263040	000000
  1972	002210'	751000	745000
  1973	002211'	201300	770065
  1974	002212'	260040	002204*
  1975	002213'	260040	002205*
  1976	002214'	262041	000000
  1977	002215'	263040	000000
  1978	002216'	777002	745000
  1979	002217'	201300	770056
  1980	002220'	260040	002212*
  1981	002221'	260040	002213*
  1982	002222'	201300	770105
  1983	002223'	260040	002220*
  1984	002224'	260040	002221*
  1985	002225'	256000	770000
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 45-2
REFSTR.MAC	20-NOV-87 22:23		MISC. DATA LOCATIONS.

  1986	002226'	111114	772111
  1987	002227'	140200	000007
  1988	002230'	350200	000007
  1989	002231'	142111	000002
  1990	002232'	000005	000005
  1991	002233'	262040	000006
  1992	002234'	263040	000000
  1993	002235'	777400	751000
  1994	002236'	201300	770005
  1995	002237'	260040	002223*
  1996	002240'	260040	002224*
  1997	002241'	262041	000000
  1998	002242'	263040	000000
  1999	002243'	262040	000007
  2000	002244'	250341	000000
  2001	002245'	260040	772236
  2002	002246'	260040	002237*
  2003	002247'	260040	002240*
  2004	002250'	262041	000000
  2005	002251'	263040	000000
  2006	002252'	201300	770027
  2007	002253'	260040	002246*
  2008	002254'	260040	002247*
  2009	002255'	201300	770105
  2010	002256'	260040	002253*
  2011	002257'	260040	002254*
  2012	002260'	256000	770000
  2013	002261'	000000	001514*
  2014	002262'	522472	451652
  2015	002263'	501016	267752
  2016	002264'	723235	662746
  2017	002265'	270321	251712
  2018	002266'	721016	060716
  2019	002267'	625015	672732
  2020	002270'	613136	220322
  2021	002271'	671012	040616
  2022	002272'	425304	072320
  2023	002273'	627344	072746
  2024	002274'	625012	051212
  2025	002275'	406104	443500
  2026	002276'	723364	071312
  2027	002277'	607105	420302
  2028	002300'	673104	050256
  2029	002301'	512232	442510
  2030	002302'	435016	467500
  2031	002303'	737455	172312
  2032	002304'	270000	000000
  2033	002305'	064250	460750
  2034	002306'	605015	171500
  2035	002307'	647344	022650
  2036	002310'	466407	422650
  2037	002311'	466405	333556
  2038	002312'	335746	022234
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 45-3
REFSTR.MAC	20-NOV-87 22:23		MISC. DATA LOCATIONS.

  2039	002313'	271004	020252
  2040	002314'	717124	043222
  2041	002315'	462132	322216
  2042	002316'	203515	720316
  2043	002317'	627504	061302
  2044	002320'	617264	072336
  2045	002321'	201050	644630
  2046	002322'	426465	221134
  2047	002323'	064240	000000
  2048	002324'	154670	320244
  2049	002325'	426152	352244
  2050	002326'	155644	022650
  2051	002327'	466403	333250
  2052	002330'	275012	040616
  2053	002331'	426660	000000
  2054	002332'	502030	742536
  2055	002333'	000000	000000
  2056	002334'	375012	040616
  2057	002335'	425015	772750
  2058	002336'	203374	620344
  2059	002337'	607354	762500
  2060	002340'	677444	052634
  2061	002341'	522510	246100
  2062	002342'	673376	420346
  2063	002343'	627504	072740
  2064	002344'	271004	000000
  2065	002345'	035771	127636
  2066	002346'	203136	271336
  2067	002347'	711015	767100
  2068	002350'	000000	000000
  2069	002351'	201300	770043
  2070	002352'	260040	002256*
  2071	002353'	260040	002257*
  2072	002354'	201300	770105
  2073	002355'	260040	002352*
  2074	002356'	260040	002353*
  2075	002357'	256000	770000
  2076	002360'	745000	746000
  2077	002361'	201300	770077
  2078	002362'	260040	002355*
  2079	002363'	260040	002356*
  2080	002364'	201300	770105
  2081	002365'	260040	002362*
  2082	002366'	260040	002363*
  2083	002367'	256000	770000
  2084	002370'	160211	002037*
  2085	002371'	141311	000000*
  2086	002372'	654644	000000
  2087	002373'	637163	000000
  2088	002374'	564700	000000
  2089	002375'	636057	575451
  2090	772403				VAR
  2091
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 45-4
REFSTR.MAC	20-NOV-87 22:23		MISC. DATA LOCATIONS.

  2092
  2093			002404	REFLNR==.-%REF+1	;# of words in REFSTR
  2094			003000	REFLNP==<REFLNR!777>+1	;Rounded up to page boundry
  2095
  2096				ONSZCK(REFSTR,REF)	;CHECK TO SEE IF ENOUGH PAGES ALLOCATED
  2097
  2098	002403'			DEPHASE
  2099
  2100	002403'			REFEND:	END		;Cannot use $END in PHASEd code
  2101
NO ERRORS DETECTED
PROGRAM BREAK IS 002403
8K CORE USED
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 46
REFSTR.MAC	20-NOV-87 22:23		SYMBOL TABLE

BATBAD		770020		HOMCRS		000022	SIN	MFDUFD		772110		PTREX2		771663	
BATELB		000645'	EXT	HOMCTL		772136		MOROOM		771771		PTREX3		771711	
BATFIR		000000	EXT	HOMEXP		772111		NBOOTP		000003	SIN	PTREX4		771732	
BATNBB		000641'	EXT	HOMFEP		000014	SIN	NFILE		000004	SPD	PTREXT		771642	
BAYNBB		000644'	EXT	HOMFIL		772102		NODIE		000000	EXT	PTRFAL		771766	
BEGSAT		772156		HOMHMS		000020	SIN	NORCV		770311		PTRFL0		771762	
CLSAOB		771555		HOMHSH		000000	EXT	NOTAVL		770065		PTRFL1		771765	
CLUAB1		771547		HOMMFD		000025	SIN	NUFDS		000003	SPD	PTRFL2		771761	
CLUAB2		771550		HOMP4C		000026	SIN	NXCLC		771021		PTROT2		771652	
CLUAOB		771546		HOMPUF		000024	SIN	NXTSAT		770156		PTROU0		771646	
CNDSWT		771464		HOMRAN		000000	EXT	NXUNIT		770153		PTROUT		771650	
CNVSIZ		772076		HOMRBD		772127		OCONM		002365'	EXT	PWRITE		771611	ENT
CNVSZM		772075		HOMRBP		772145		OGETP2		771441		QF	377777	777777	SIN
CODRIB		002047'	EXT	HOMRBS		771535		OGETP3		771446		QO	377777	777777	SIN
CONMES		001637'	EXT	HOMREF		000000	EXT	OGETP4		771452		QUOTAF		770003	
CONOUT		771637		HOMRS1		771540		OGETP5		771461		QUOTAO		770004	
CORONZ		000707'	EXT	HOMRS2		771543		OGETPG		771435		R.EXPR		772111	
CORZER		002025'	EXT	HOMSAT		000017	SIN	OGTPG		770013		R.FILE		772102	
CPOPJ1		002017'	EXT	HOMSPG		000021	SIN	OPAGIN		002261'	EXT	R.PCBS		772136	
CPUKS		000003	SPD	HOMSUF		000023	SIN	OPAGOT		001563'	EXT	R.RBPS		772145	
CPUTYP		000002	SPD	HOMUP1		770403		OPOUT		002366'	EXT	R.RIBS		772127	
CPZZ		000000	SPD	HOMUPD		770371		P		000001	INT	R.SIZE		772120	
CRLF		001640'	EXT	INISA2		770721		P1		000014	INT	R.ZERB		772120	SPD
CRLFOP		771640		INISA3		770732		P2		000015	INT	R.ZERE		772135	SPD
CRSALP		772122		INISA5		770736		P2WLSH		000011	SPD	RANNO		772154	INT
CRSCRE		770272		INISA6		770767		P3		000016	INT	RBEOUT		770043	
CRSCTL		772140		INISA8		771004		P4		000017	INT	RBLVPR		000000	EXT
CRSEXP		772113		INISA9		771010		PAGE		772170	INT	RBLVSP		000000	EXT
CRSFIL		772104		INISAA		770741		PAGNED		771335		RBNF10		771327	
CRSRBD		772131		INISAB		770746		PAKLEV		770632		RBNFIL		771234	
CRSRBP		772147		INISAC		770756		PAKRB1		770612		RBNFL1		771251	
D		746000		INISAT		770672		PAKREF		770430	ENT	RBNFL2		771253	
DDT		000000	EXT	IOFAL		770005		PAKSP0		770565		RBNFL3		771265	
DIE		000000'	EXT	JFYMIN		002043'	EXT	PAKSPG		770556		RBNFL4		771267	
ENTUFD		771205		JFYSEC		001225'	EXT	PG		000003	INT	RBNFL6		771273	
FBOOTB		000003	SIN	LBNLEN		000005	SPD	PGSRIB		772166		RBNFL7		771300	
FILES		771606	INT	LBNLST		771014		PGSSPG		772165		RBNFL8		771306	
FIXHM1		770577		LP2BAT		000007	SIN	PJRST	324740	000000		RBNFL9		771316	
FIXHOM		770565		LP2HOM		000006	SIN	PKRB1A		770625		RBNOUT		770027	
FSFPPN		000415'	EXT	LPGSAT		772160		PREAD		771614	ENT	RBREAL		001365'	EXT
FSTUNI		772161		LPN000		000000	SIN	PREAD0		771621		RBSPAR		000502'	EXT
FTSPAG	777777	777777	SIN	LPNBAT		000002	SIN	PREAD1		771617		RBYPNO		001626'	EXT
GETBAT		000524'	EXT	LPNHOM		000001	SIN	PREAD2		771631		RBYUNI		001622'	EXT
GETHMP		771050		LPNSAT		000010	SIN	PREAD4		771635		REFEND		002403'	
GETHOM		000566'	EXT	MAKPAG		771100		PREF1		770443		REFFAL		770427	
GETPR4		772003		MFDALP		772126		PREF11		770514		REFLAG		000416'	EXT
GETPR5		772010		MFDCTL		772144		PREF2		770451		REFLIT		772171	
GETPRM		772000		MFDEXP		772117		PREF3		770466		REFLNP		003000	SIN
GETSAT		771476		MFDPPN		001110'	EXT	PREF4		770475		REFLNR		002404	SIN
GTSAT6		771512		MFDPRV		000000	EXT	PREF5		770513		REFRSH		770121	ENT
HASH		771201		MFDRBD		772135		PRFNST		770522		REFSTR		770000	ENT
HMRRBP		772145		MFDRBP		772153		PTRE45		771750		REFSTT		000000'	INT
HOMALP		772120		MFDRIB		000360'	EXT	PTREX1		771655		REFUNI		772162	
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88 PAGE 46-2
REFSTR.MAC	20-NOV-87 22:23		SYMBOL TABLE

RFNXST		770527		SATSR2		771343		SYNRPR		000000	EXT	%REF		770000	SIN
RIBALP		002076'	EXT	SATSR3		771350		SYRDPR		000000	EXT	%STA		751000	SIN
RIBCOD		002050'	EXT	SATSR5		771403		SYSALP		772124		%STA.P		001500'	EXT
RIBEX1		001727'	EXT	SATSR8		771426		SYSCTL		772142		%STR		750000	SIN
RIBEX2		001732'	EXT	SATSR9		771430		SYSDSP		001607'	EXT	%STR.P		002137'	EXT
RIBEX3		001740'	EXT	SATSRH		771336		SYSEXP		772115		%T2P		745000	SIN
RIBEX4		001746'	EXT	SAVE1		001054'	EXT	SYSPPN		000331'	EXT	%T2P.P		001171'	EXT
RIBEXT		002370'	EXT	SAVE4		000635'	EXT	SYSPRV		000000	EXT	%TMP		746000	SIN
RIBFAL		770077		SAVEP		772167		SYSRBD		772133		%TMP.P		002141'	EXT
RIBLST		000000	EXT	SAVT		001541'	EXT	SYSRBP		772151		
RIBMXA		000000	EXT	SCNBAT		770635	ENT	SYSUFD		772106		
RIBNAM		002030'	EXT	SCNBT2		770641		T1		000006	INT	
RIBPFS		000476'	EXT	SCNBT3		770646		T2		000007	INT	
RIBPPN		002034'	EXT	SETBTS		770655		T3		000010	INT	
RIBPRV		002036'	EXT	SETUF1		771147		T4		000011	INT	
RIBPVW		002371'	EXT	SETUF2		771156		TAKPAG		771054		
RIBQTF		002055'	EXT	SETUF4		771163		THSDAT		002035'	EXT	
RIBQTO		002057'	EXT	SETUF5		771170		TIME		002042'	EXT	
RIBRIB		000477'	EXT	SETUFD		771145		TMPIN		771562		
RIBRPS		000000	EXT	SETUFN		771152		TMPOUT		771563		
RIBSET		772022		SIZREF		000003	SIN	TMPRBP		772150		
RIBSFS		000000	EXT	SOFERR		770105		TMPRBS		771517		
RIBSIZ		002100'	EXT	SPGALP		772123		TMPRS1		771522		
RIBSLF		000616'	EXT	SPGCR1		770255		TSTSUP		771573	ENT	
RIBSNM		000000	EXT	SPGCRE		770251		U		000005	INT	
RIBST8		772073		SPGCTL		772141		UFDCDT		000002	SIN	
RIBSTS		002051'	EXT	SPGEXP		772114		UFDERR		770056		
RIBSTU		772054		SPGFIL		772105		UFDEXT		000001	SIN	
RIBSZS		002046'	EXT	SPGRBD		772132		UFDHSI		001202'	EXT	
RIBUN1		002071'	EXT	SPGRBP		772150		UFDLIC		000003	SIN	
RIBUNM		002073'	EXT	SPLALP		772125		UFDNAM		000000	SIN	
RIBUSD		000000	EXT	SPLCTL		772143		UFDRIB		000004	SIN	
RIBVER		000000	EXT	SPLEXP		772116		UFDSET		771107		
RIPDIR		002052'	EXT	SPLPPN		000313'	EXT	UFDSIZ		000005	SIN	
RIPNDL		000000	EXT	SPLRBD		772134		UFDST1		771126		
RIPNFS		000000	EXT	SPLRBP		772152		UFDST3		771133		
S$ENTR	777777	777775	SIN	SPLUFD		772107		UFDSTP		772155		
S$HALT	777777	777777	SIN	SRPREF		000423'	EXT	UNIPPU		001627'	EXT	
S$NAME		770000	SPD	STRBTS		000424'	EXT	UNISTR		001557'	EXT	
S$NONA		000000	SIN	STRDDB		000000	EXT	UNISTT		001547'	EXT	
S$TEMP		000000	SPD	STRHSH		000610'	EXT	UNTLEN		001623'	EXT	
S$XCT	777777	777776	SIN	STRP4C		000273'	EXT	UNTTBL		001624'	EXT	
SATALP		772121		STRRBP		772146		UNYLUN		001367'	EXT	
SATCLC		771041		STRREF		000425'	EXT	UNYPPY		000752'	EXT	
SATCTL		772137		STRUNI		000461'	EXT	UNYSPU		000000	EXT	
SATDSK		772164		STRUNM		000242'	EXT	WTBOTH		000604'	EXT	
SATEXP		772112		STTAOB		001552'	EXT	%BAT		747000	SIN	
SATFIL		772103		STTFPC		001446'	EXT	%BAT.P		000000	EXT	
SATIND		772163		STTLEN		001553'	EXT	%HMR		752000	SIN	
SATRBD		772130		STTPTR		001550'	EXT	%HMR.P		002136'	EXT	
SATRBP		772146		STTSTS		000703'	EXT	%HOM		753000	SIN	
SATRBS		771526		SVSBTL		772157		%HOM.P		000000	EXT	
SATRS1		771531		SYNRPR		000000	EXT	

REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88
REFSTR.MAC	20-NOV-87 22:23		Symbol cross reference

BATBAD	   112#	   661
BATELB	    34%	   653
BATFIR	    34%	   646
BATNBB	    34%	   649
BAYNBB	    34%	   652
BEGSAT	   673	   676	   756	   844	   847	   870	   919	   922	  1938#
CLSAOB	   429	  1468#
CLUAB1	  1461#	  1469
CLUAB2	  1462#	  1466
CLUAOB	   617	  1460#
CNDSWT	   395	   615	   713	  1369#
CNVSIZ	   202	   219	  1822#
CNVSZM	   544	   549	  1821#
CODRIB	    18%	  1641	  1787
CONMES	    36%	  1554	  1561
CONOUT	  1502	  1506	  1561#
CORONZ	    32%	   728
CORZER	    32%	  1052	  1636	  1670	  1769
CPOPJ1	    32%	   442	   650	   846	   899	   936	  1023	  1048	  1224	  1318	  1354	  1370	  1378	  1392
	  1409	  1495	  1597	  1711	  1730	  1746
CPUKS	    81	   284	   405	   785	  1872	  1883	  1895	  1906	  1918	  1929
CPUTYP	    81	   284	   405	   785	  1872	  1883	  1895	  1906	  1918	  1929
CPZZ	    81#	    81	   284#	   284	   405#	   405	   785#	   785	  1872#	  1872	  1883#	  1883	  1895#	  1895
	  1906#	  1906	  1918#	  1918	  1929#	  1929
CRLF	  1562%	  1562
CRLFOP	  1562#
CRSALP	   338	  1893#
CRSCRE	   326#
CRSCTL	  1916#
CRSEXP	   332	  1881#
CRSFIL	   331	  1870#
CRSRBD	   340	  1904#
CRSRBP	  1927#
D	  1520	  1521#
DDT	  1513	  1522%	  1543
DIE	    47	    47%	    48
ENTUFD	  1059	  1098#
FBOOTB	    69#	   767
FILES	  1516#
FIXHM1	   589#	   593
FIXHOM	   579#
FSFPPN	    34%	   433
FSTUNI	   146	   197	   235	   275	   330	   344	   356	   401	   435	   455	   783	  1468	  1942#
FTSPAG	    40	    76	   234	   553	   772
GETBAT	    35%	   180	   526
GETHMP	   764	   769	   896#
GETHOM	    35%	   402	   463	   580
GETPR4	  1732#	  1747
GETPR5	  1734	  1738#
GETPRM	  1215	  1729#
GETSAT	  1186	  1348	  1391#
GTSAT6	  1395	  1405#
HASH	  1057	  1073#
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88
REFSTR.MAC	20-NOV-87 22:23		Symbol cross reference

HMRRBP	  1925#
HOMALP	   231	  1891#
HOMCRS	  1836#	  1881
HOMCTL	  1914#
HOMEXP	   156	  1879#
HOMFEP	   414	   583	  1832#
HOMFIL	   155	  1868#
HOMHMS	  1834#	  1879
HOMHSH	    24%	   416	   585
HOMMFD	  1839#	  1885
HOMP4C	  1840#
HOMPUF	  1838#	  1884
HOMRAN	    24%	   418	   587
HOMRBD	   225	  1902#
HOMRBP	   163	  1439	  1442	  1925#
HOMRBS	   221	   546	   898	  1439#
HOMREF	    24%	   404	   582
HOMRS1	  1440	  1442#
HOMRS2	  1429	  1437	  1445#
HOMSAT	  1833#	  1880
HOMSPG	  1835#	  1882
HOMSUF	  1837#	  1883
HOMUP1	   420#	   424
HOMUPD	   402#	   428
INISA2	   734	   738#
INISA3	   731	   740	   744	   751#
INISA5	   756#
INISA6	   757	   784	   800#
INISA8	   802	   813#
INISA9	   812	   817#
INISAA	   763#	   766
INISAB	   768#	   771
INISAC	   777#	   780
INISAT	   186	   534	   713#
IOFAL	   104#	  1376	  1403	  1408	  1494
JFYMIN	  1783%	  1783
JFYSEC	  1114%	  1114
LBNLEN	   762	   827#
LBNLST	   763	   822#	   827
LISTSN	     3	     6
LP2BAT	    72#	   826
LP2HOM	    71#	   824
LPGSAT	   674	   850	   857	   874	   920	  1940#
LPN000	    66#
LPNBAT	    68#	   825
LPNHOM	    67#	   823	  1507
LPNSAT	    73#	   205	   795
MAKPAG	   268	   568	   951#
MFDALP	   391	  1897#
MFDCTL	  1920#
MFDEXP	   385	  1885#
MFDPPN	   383	   973	  1843%
MFDPRV	  1843%	  1885
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88
REFSTR.MAC	20-NOV-87 22:23		Symbol cross reference

MFDRBD	   388	  1908#
MFDRBP	  1931#
MFDRIB	    32%	   389
MFDUFD	   384	  1799	  1874#
MOROOM	  1621	  1629	  1709#
NBOOTP	    70#	   767
NFILE	   358	   361	   370	   378	   382	   392	   419	   465	   473	   588	   602	  1860#	  1868	  1868#
	  1869	  1869#	  1870	  1870#	  1871	  1871#
NODIE	    47%
NORCV	   329	   344#
NOTAVL	   128#	   921	   930
NUFDS	   378	   382	   392	   419	   465	   588	  1860#	  1868	  1869	  1870	  1871	  1872	  1872#	  1873
	  1873#	  1874	  1874#
NXCLC	   189	   537	   843#
NXTSAT	   186#	   190
NXUNIT	   180#	   193
OCONM	    36%	   661	   805	   921	   930	  1101	  1180	  1256	  1342	  1376	  1403	  1408	  1425	  1433
	  1441	  1494	  1631	  1748
OGETP2	  1338#	  1346
OGETP3	  1339	  1343#
OGETP4	  1344	  1348#
OGETP5	  1349	  1351	  1356#
OGETPG	   222	   247	   809	  1007	  1017	  1154	  1334#	  1603	  1638	  1662	  1735
OGTPG	   108#	   805	  1180	  1256	  1342
OPAGIN	    35%	   484	   508	  1407	  1487
OPAGOT	    35%	   211	   228	   612	   820	  1067	  1222	  1375	  1400	  1488
OPOUT	    36%	   661	   805	   921	   930	  1101	  1180	  1256	  1342	  1376	  1403	  1408	  1425	  1433
	  1441	  1494	  1563	  1631	  1748
P	    48	   160	   172	   180	   182	   186	   189	   202	   204	   211	   219	   221	   222	   228
	   241	   247	   268	   269	   277	   335	   349	   365	   371	   386	   393	   395	   402	   425
	   429	   445	   463	   484	   508	   526	   530	   534	   537	   544	   546	   549	   551	   568
	   569	   574	   580	   594	   612	   615	   617	   618	   622	   661	   675	   682	   685	   713
	   714	   723	   728	   751	   752	   753	   754	   764	   765	   769	   770	   778	   779	   796
	   797	   805	   809	   810	   814	   815	   818	   853	   858	   876	   896	   897	   898	   918
	   921	   928	   930	   951	   956	   957	   972	   976	   977	  1007	  1008	  1017	  1018	  1020
	  1021	  1037	  1047	  1052	  1055	  1057	  1059	  1061	  1067	  1068	  1076	  1099	  1101	  1120
	  1150	  1154	  1155	  1180	  1181	  1185	  1186	  1187	  1188	  1190	  1193	  1194	  1199	  1200
	  1211	  1212	  1215	  1216	  1222	  1223	  1256	  1268	  1271	  1277	  1317	  1334	  1335	  1340
	  1341	  1342	  1348	  1350	  1352	  1353	  1356	  1357	  1358	  1375	  1376	  1397	  1400	  1401
	  1402	  1403	  1404	  1407	  1408	  1425	  1427	  1433	  1435	  1441	  1443	  1447	  1463	  1469
	  1472	  1493	  1494	  1499	  1502	  1506	  1509	  1516	  1518	  1525	  1526	  1532	  1533	  1552
	  1554	  1555	  1561	  1562	  1588	  1591	  1592	  1593	  1594	  1600	  1603	  1614	  1615	  1618
	  1620	  1621	  1625	  1626	  1628	  1629	  1631	  1636	  1638	  1643	  1644	  1652	  1659	  1661
	  1662	  1665	  1667	  1670	  1672	  1678	  1686	  1687	  1688	  1691	  1692	  1693	  1694	  1715
	  1732	  1735	  1736	  1737	  1739	  1740	  1741	  1742	  1743	  1744	  1748	  1766	  1767	  1769
	  1770	  1771	  1791	  1805	  1810	  1825
P1	   345	   361	   370	   382	   392	   480	   486	   488	   491	   492	   497	   498	   499	   517
	   653	   655	   656	   800	   801	   804	   808	   817	   926	   927	   929	   931	   987	  1055
	  1056	  1060	  1061	  1098	  1103	  1104	  1107	  1116	  1163	  1174	  1181	  1182	  1190	  1205
	  1217	  1218	  1246	  1266	  1285	  1297	  1302	  1312	  1314	  1316	  1334	  1337	  1338	  1341
	  1343	  1345	  1353	  1357	  1592	  1643	  1645	  1675	  1676	  1682	  1688	  1731	  1747
P2	   145	   326	   327	   345	   357	   359	   377	   379	   381	   436	   438	   440	   441	   456
	   457	   482	   483	   486	   487	   491	   493	   497	   498	   500	   501	   504	   512	   516
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88
REFSTR.MAC	20-NOV-87 22:23		Symbol cross reference

	   517	   518	   519	   596	   598	   621	   644	   657	   813	   972	  1006	  1011	  1037	  1038	  1040
	  1045	  1046	  1047	  1058	  1063	  1163	  1171	  1173	  1179	  1189	  1196	  1197	  1198	  1204
	  1288	  1289	  1295	  1304	  1335	  1336	  1340	  1352	  1356	  1591	  1644	  1646	  1687
P2WLSH	   258	   560	  1823
P3	   253	   254	   255	   263	   264	   265	   267	   271	   504	   512	   563	   564	   565	   567
	   571	   652	   658	   762	   763	   766	   767	   768	   771	   774	   775	   776	   777	   780
	   986	  1009	  1010	  1014	  1015	  1016	  1195	  1197	  1201
P4	   159	   171	   240	   334	   473	   474	   475	   479	   480	   521	   522	   602	   603	   604
	   606	   611	   614	   645	   646	   649	   651	   653	   659	   660	   975	  1789	  1790
PAGE	  1508	  1545	  1954#
PAGNED	  1147	  1152	  1169	  1189	  1196	  1198	  1226#
PAKLEV	   464	   485	   509	   527	   570	   620#
PAKRB1	   603#	   614
PAKREF	    10	   454#
PAKSP0	   555	   575#
PAKSPG	   567#	   571
PG	   210	   227	   479	   611	   811	   816	  1062	  1221	  1374	  1393	  1492
PGSRIB	   261	  1148	  1213	  1217	  1637	  1664	  1950#
PGSSPG	  1949#
PKRB1A	   605	   614#
PREAD	    11	  1528	  1532#
PREAD0	  1525	  1532	  1545#
PREAD1	  1535#	  1556	  1559
PREAD2	  1549	  1553#
PREAD4	  1510	  1527	  1534	  1558#
PREF1	   466#	   470
PREF11	   494	   516#
PREF2	   474#	   522
PREF3	   488#	   510
PREF4	   490	   497#
PREF5	   503	   512#
PRFNST	   476	   522#
PTRE45	  1654	  1660	  1675#
PTREX1	  1589	  1600#
PTREX2	  1602	  1606#
PTREX3	  1607	  1609	  1624	  1635#
PTREX4	  1648	  1659#
PTREXT	   269	   569	   574	  1199	  1211	  1586#
PTRFAL	  1604	  1639	  1689	  1692#
PTRFL0	  1679	  1687#
PTRFL1	  1616	  1619	  1627	  1691#
PTRFL2	  1663	  1668	  1686#
PTROT2	  1587	  1595#
PTROU0	  1591#	  1683
PTROUT	  1593#	  1622	  1630
PWRITE	    11	  1525#
QF	    58	    58#	    60
QO	    59	    59#	    61
QUOTAF	    60#	  1794
QUOTAO	    61#	  1796
R.EXPR	   421	   466	   590	  1104	  1107	  1879#
R.FILE	  1056	  1103	  1868#
R.PCBS	   474	   479	   480	   603	   606	   611	  1914#
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88
REFSTR.MAC	20-NOV-87 22:23		Symbol cross reference

R.RBPS	   521	  1925#
R.RIBS	   420	   469	   475	   589	   604	  1098	  1902#
R.SIZE	   359	   379	  1116	  1891#
R.ZERB	   148	   149	   459	   460	  1890#
R.ZERE	   150	   461	  1910#
RANNO	    13	   417	   586	  1935#
RBEOUT	   120#	  1631
RBLVPR	    19%	   161	   173	   243	  1157	  1653
RBLVSP	    19%
RBNF10	  1214	  1219#
RBNFIL	   335	  1147#
RBNFL1	  1163#	  1207
RBNFL2	  1165#	  1176
RBNFL3	  1168	  1172	  1175#
RBNFL4	  1166	  1179#
RBNFL6	  1170	  1185#
RBNFL7	  1193#	  1206
RBNFL8	  1199#	  1202
RBNFL9	   277	  1204	  1210#
RBNOUT	   116#	  1425	  1433	  1441
RBREAL	    19%	   206	   209	   477	   932	   953	  1041	  1273
RBSPAR	    19%	   502
RBYPNO	    15%	   226	   507	   608	   819	  1064	  1220	  1274	  1371	  1396	  1406	  1489	  1550
RBYUNI	    15%	   505	   609	   934	   955	  1065	  1276	  1372	  1398	  1490	  1546
REFEND	  2100#
REFFAL	   181	   187	   212	   223	   229	   248	   270	   278	   336	   350	   366	   372	   387	   394
	   396	   403	   445#
REFLAG	    32%	   434
REFLIT	  1956#
REFLNP	    12	  2094#	  2096
REFLNR	    12	  2093#	  2094
REFRSH	    10	   144#
REFSTR	    44	    47	    48#	    51
REFSTT	    12	    42#	    44
REFUNI	   147	   454	   481	   525	   579	   620	  1460	  1943#
RFNXST	   534#	   538
RIBALP	    15%	   213	   230	   256	   257	   279	   337	   352	   368	   390	   559	  1014	  1153	  1218
	  1446	  1821	  1822
RIBCOD	    15%	  1642	  1788
RIBEX1	    33%	  1652
RIBEX2	    33%	  1659
RIBEX3	    33%	  1665
RIBEX4	    33%	  1671
RIBEXT	    16%	  1773	  1779	  1781
RIBFAL	   132#	  1748
RIBLST	    18%	   518	  1647	  1675	  1710	  1713
RIBMXA	    19%	   979
RIBNAM	    16%	  1772
RIBPFS	    19%	   162	   174	   244	   491	   493	   498	   500	   983	  1009	  1040	  1063	  1158
RIBPPN	    16%	  1776
RIBPRV	    19%	  1775	  1778
RIBPVW	    16%	  1784
RIBQTF	    16%	  1795
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88
REFSTR.MAC	20-NOV-87 22:23		Symbol cross reference

RIBQTO	    16%	  1797
RIBRIB	    18%	   492	   499	  1608	  1617	  1623	  1729	  1732	  1745
RIBRPS	    15%	  1614	  1625
RIBSET	   160	   172	   241	   976	  1150	  1766#
RIBSFS	    18%	   493	   500	  1653
RIBSIZ	    16%	   259	   486	   561	  1016	  1824
RIBSLF	    17%	   207	   224	   249	   339	   607	  1019	  1022	  1156	  1219	  1601	  1605	  1640	  1666
	  1677	  1733	  1738
RIBSNM	    18%
RIBST8	  1800	  1803	  1809#
RIBSTS	    17%	  1789
RIBSTU	  1792	  1794#
RIBSZS	    19%	   488	   497	  1606	  1786
RIBUN1	    15%	  1807
RIBUNM	    15%	  1809
RIBUSD	    17%	   978
RIBVER	    17%
RIPDIR	    17%	   975	  1790
RIPNDL	    17%	   159	   171	   240	   334
RIPNFS	    17%	   159	   171	   240	   334
S$ENTR	    47	    53	   426	   535	   581	   595	   613	   616	  1101	  1261	  1425	  1433	  1441	  1631
	  1748
S$HALT	    47	   426	   535	   581	   595	   613	   616	  1101	  1261	  1425	  1433	  1441	  1631	  1748
S$NAME	    51#	   426	   535	   581	   595	   613	   616	  1101	  1261	  1425	  1433	  1441	  1631	  1748
S$NONA	    50	    53	   426	   535	   581	   595	   613	   616	  1101	  1261	  1425	  1433	  1441	  1631
	  1748
S$TEMP	    47#	    47	   426#	   426	   535#	   535	   581#	   581	   595#	   595	   613#	   613	   616#	   616
	  1101#	  1101	  1261#	  1261	  1425#	  1425	  1433#	  1433	  1441#	  1441	  1631#	  1631	  1748#	  1748
S$XCT	    53	   426	   535	   581	   595	   613	   616	  1101	  1261	  1425	  1433	  1441	  1631	  1748
SATALP	   214	  1892#
SATCLC	   182	   530	   870#
SATCTL	  1915#
SATDSK	   151	   458	  1369	  1377	  1391	  1394	  1405	  1947#
SATEXP	   168	  1880#
SATFIL	   167	  1869#
SATIND	   715	   875	  1945#
SATRBD	   208	  1903#
SATRBP	   175	  1431	  1434	  1926#
SATRBS	   204	   551	   818	  1431#
SATRS1	  1432	  1434#
SATSR2	  1247	  1252#
SATSR3	  1249	  1254	  1260#
SATSR5	  1290#	  1294	  1308
SATSR8	  1291	  1296	  1298	  1312#
SATSR9	  1301	  1314#
SATSRH	   814	  1193	  1246#	  1350
SAVE1	    36%	   917
SAVE4	    36%	   144	   643
SAVEP	  1499	  1516	  1953#
SAVT	    32%	  1427	  1435	  1443
SCNBAT	    10	   643#	   753
SCNBT2	   649#	   660
SCNBT3	   655#	   658
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88
REFSTR.MAC	20-NOV-87 22:23		Symbol cross reference

SETBTS	   673#	   752
SETUF1	  1040#	  1046
SETUF2	  1042	  1051#
SETUF4	  1056#	  1060
SETUF5	  1061#
SETUFD	   371	   393	  1037#
SETUFN	  1045#	  1069
SIZREF	  2096
SOFERR	   136#	  1101	  1425	  1433	  1441	  1631	  1748
SPGALP	   280	  1894#
SPGCR1	   267#	   271
SPGCRE	   262#	   273
SPGCTL	  1917#
SPGEXP	   237	  1882#
SPGFIL	   236	  1871#
SPGRBD	   250	  1905#
SPGRBP	  1928#
SPLALP	   353	  1896#
SPLCTL	  1919#
SPLEXP	   348	  1884#
SPLPPN	   346	  1844%
SPLRBD	   351	  1907#
SPLRBP	  1930#
SPLUFD	   347	  1804	  1873#
SRPREF	   439%	   439
STRBTS	    26%	   440
STRDDB	    26%	   584
STRHSH	    26%	   438	   584	   598
STRP4C	    26%	   327
STRRBP	  1926#
STRREF	    26%	   441
STRUNI	    26%	   145	   457	   483
STRUNM	    26%	   254
STTAOB	    28%	   719	  1246	  1285	  1297	  1302	  1312	  1464
STTFPC	    28%	   684	   721	   801	   935	  1167	  1205	  1314	  1316	  1343
STTLEN	    28%	   716	  1175	  1269	  1345	  1465
STTPTR	    28%	   808	   817	  1165	  1182	  1338	  1462
STTSTS	    28%	   722
SVSBTL	   720	   729	   843	   848	   856	   872	  1939#
SYNRPR	  1841%	  1881	  1882
SYRDPR	  1841%	  1879	  1880
SYSALP	   369	  1895#
SYSCTL	  1918#
SYSDSP	  1517%	  1517
SYSEXP	   364	  1883#
SYSPPN	   157	   169	   238	   333	   362	  1842%
SYSPRV	  1842%	  1883
SYSRBD	   367	  1906#
SYSRBP	  1929#
SYSUFD	   363	  1802	  1872#
T1	   149	   150	   155	   161	   162	   163	   167	   173	   174	   175	   201	   213	   214	   218
	   230	   231	   236	   243	   244	   245	   251	   252	   255	   256	   258	   259	   262	   263
	   265	   267	   276	   279	   280	   331	   346	   347	   358	   359	   360	   362	   363	   378
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88
REFSTR.MAC	20-NOV-87 22:23		Symbol cross reference

	   379	   380	   383	   384	   413	   414	   415	   416	   417	   418	   419	   420	   421	   424	   433
	   434	   437	   438	   439	   440	   460	   461	   465	   466	   469	   470	   516	   519	   520
	   521	   543	   548	   557	   558	   559	   560	   561	   562	   563	   565	   567	   584	   585
	   586	   587	   588	   589	   590	   593	   597	   598	   656	   661	   673	   674	   676	   677
	   681	   683	   715	   716	   718	   719	   721	   722	   723	   726	   732	   735	   737	   738
	   763	   768	   773	   774	   776	   777	   795	   803	   804	   805	   806	   807	   871	   872
	   873	   874	   918	   919	   920	   921	   922	   923	   924	   929	   930	   931	   933	   934
	   951	   952	   954	   955	   956	   981	   983	   984	  1051	  1053	  1054	  1056	  1058	  1073
	  1074	  1075	  1098	  1101	  1102	  1103	  1105	  1157	  1158	  1159	  1164	  1165	  1167	  1174
	  1175	  1180	  1185	  1187	  1195	  1246	  1248	  1250	  1252	  1253	  1255	  1256	  1262	  1281
	  1285	  1286	  1292	  1295	  1305	  1315	  1342	  1376	  1403	  1408	  1423	  1424	  1425	  1426
	  1431	  1432	  1433	  1434	  1439	  1440	  1441	  1442	  1445	  1461	  1462	  1464	  1465	  1494
	  1500	  1503	  1553	  1558	  1586	  1587	  1595	  1596	  1606	  1607	  1620	  1628	  1631	  1635
	  1641	  1642	  1647	  1648	  1669	  1680	  1681	  1682	  1686	  1691	  1709	  1710	  1712	  1714
	  1736	  1740	  1748	  1766	  1768	  1771	  1772	  1799	  1802	  1804	  1821	  1822	  1824
T2	   156	   168	   203	   220	   224	   225	   237	   249	   250	   332	   337	   338	   339	   340
	   348	   351	   364	   367	   385	   388	   389	   420	   423	   501	   502	   545	   550	   573
	   589	   592	   607	   644	   651	   678	   680	   717	   718	   720	   721	   729	   730	   733
	   738	   739	   742	   743	   745	   746	   747	   752	   817	   843	   844	   845	   847	   848
	   849	   850	   851	   852	   854	   855	   856	   857	   925	   927	   928	   932	   952	   953
	   977	   978	   979	   982	   983	  1009	  1019	  1022	  1040	  1041	  1063	  1075	  1104	  1106
	  1107	  1108	  1109	  1110	  1111	  1112	  1113	  1114	  1115	  1116	  1117	  1156	  1165	  1182
	  1202	  1210	  1219	  1248	  1253	  1260	  1265	  1266	  1267	  1269	  1270	  1272	  1273	  1277
	  1281	  1290	  1299	  1300	  1313	  1317	  1338	  1369	  1391	  1394	  1395	  1401	  1402	  1405
	  1445	  1507	  1508	  1545	  1593	  1596	  1600	  1601	  1605	  1617	  1623	  1640	  1666	  1677
	  1692	  1712	  1713	  1714	  1733	  1738	  1742	  1767	  1770	  1773	  1774	  1775	  1782	  1783
	  1784	  1798	  1801	  1806	  1807	  1808	  1809	  1821	  1822	  1823	  1824
T3	   157	   169	   238	   333	   421	   422	   423	   466	   467	   468	   469	   488	   489	   590
	   591	   592	   606	   607	   684	   734	   736	   737	   751	   800	   935	   973	  1110	  1111
	  1167	  1169	  1171	  1173	  1264	  1268	  1271	  1283	  1284	  1287	  1288	  1289	  1294	  1297
	  1298	  1299	  1300	  1302	  1304	  1305	  1306	  1307	  1312	  1313	  1314	  1315	  1316	  1428
	  1436	  1444	  1446	  1487	  1488	  1493	  1776	  1777	  1778	  1779	  1780	  1781	  1785	  1786
	  1787	  1788	  1794	  1795	  1796	  1797
T4	   144	   158	   170	   205	   206	   207	   208	   209	   226	   239	   327	   328	   352	   353
	   368	   369	   390	   391	   475	   477	   507	   608	   643	   679	   680	   681	   683	   819
	   917	   974	  1064	  1100	  1102	  1105	  1106	  1108	  1112	  1115	  1117	  1118	  1119	  1147
	  1149	  1151	  1152	  1153	  1220	  1262	  1263	  1264	  1272	  1274	  1275	  1276	  1282	  1284
	  1290	  1293	  1303	  1371	  1396	  1406	  1489	  1550	  1551	  1653	  1661	  1671	  1672	  1675
	  1676	  1768	  1772	  1773	  1775	  1776	  1778	  1779	  1781	  1784	  1786	  1788	  1789	  1795
	  1797	  1807	  1809
TAKPAG	   778	   796	   896	   917#
THSDAT	  1109%	  1109	  1777%	  1777
TIME	  1113%	  1113	  1782%	  1782
TMPIN	  1487#	  1509	  1533	  1618	  1626	  1743
TMPOUT	  1020	  1488#	  1526	  1615	  1667	  1678	  1739
TMPRBP	   245	   554	  1159	  1423	  1426	  1586	  1595	  1928#
TMPRBS	  1423#
TMPRS1	  1424	  1426#
TSTSUP	    11	  1499#
U	   145	   146	   192	   193	   197	   235	   253	   272	   273	   275	   326	   330	   344	   356
	   401	   427	   428	   435	   436	   454	   456	   457	   481	   482	   483	   505	   506	   525
	   579	   596	   609	   610	   620	   621	   717	   783	   803	   845	   852	   854	  1065	  1066
	  1164	  1265	  1337	  1372	  1373	  1397	  1398	  1399	  1404	  1460	  1461	  1468	  1470	  1471
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88
REFSTR.MAC	20-NOV-87 22:23		Symbol cross reference

	  1490	  1491	  1546	  1547	  1548	  1551	  1588	  1594	  1693
UFDCDT	  1093#	  1112	  1115
UFDERR	   124#	  1101
UFDEXT	  1092#	  1106	  1108
UFDHSI	    37%	   415	   437	   597	   981	  1006	  1015	  1045	  1074
UFDLIC	  1094#	  1117
UFDNAM	  1091#	  1105
UFDRIB	  1095#	  1102
UFDSET	   349	   365	   386	   972#
UFDSIZ	  1096#	  1118
UFDST1	  1007#	  1011
UFDST3	   987	  1014#
UFDSTP	  1054	  1100	  1119	  1936#
UNIPPU	    21%	   845	   852	   854	  1551
UNISTR	    21%	   192	   253	   272	   326	   427	   436	   456	   482	   596	   621	  1470
UNISTT	    21%	   717	   803	  1164	  1265	  1337	  1461
UNTLEN	  1547%	  1547
UNTTBL	    37%	   506	   610	  1066	  1373	  1399	  1491	  1548
UNYLUN	    22%	   933	   954	  1275
UNYPPY	    22%	   251	   262	   557	   562	   773
UNYSPU	    22%
WTBOTH	    35%	   425	   594
%BAT	   645	   646
%BAT.P	    30%
%HMR	   158	   162	   218	   224	   230	   543	  1444	  1914
%HMR.P	    30%	   227	  1914
%HOM	   404	   414	   416	   418	   423	   468	   582	   583	   585	   587	   592
%HOM.P	    30%
%R	    44#
%REF	    43	  2093
%STA	   681	   683	   726	   727	   738	   742	   745	   747	   806	   924	  1252	  1262
%STA.P	    30%	   816	  1374	  1393
%STR	   170	   174	   201	   207	   213	   548	  1436	  1915
%STR.P	    30%	   210	  1915
%T2P	   806	   807	  1051	  1053	  1635	  1640	  1642	  1646	  1680
%T2P.P	    30%	   811	  1062
%TMP	   239	   244	   249	   256	   257	   259	   276	   279	   337	   339	   352	   368	   390	   559
	   561	   974	   978	   979	   983	  1009	  1014	  1016	  1019	  1022	  1040	  1063	  1149	  1153
	  1156	  1158	  1218	  1219	  1428	  1521	  1601	  1605	  1606	  1608	  1614	  1617	  1623	  1625
	  1645	  1647	  1666	  1669	  1676	  1677	  1680	  1681	  1709	  1710	  1713	  1729	  1732	  1733
	  1738	  1745	  1917
%TMP.P	    30%	  1221	  1492	  1917
REFSTR - ROUTINE TO REFRESH A FILE STRUCTURE	MACRO 12.5-46.0 14:41 13-JAN-88
REFSTR.MAC	20-NOV-87 22:23		Macro/Opdef cross reference

IFCPU	    81	   284	   405	   785	  1872	  1883	  1895	  1906	  1918	  1929
ITEMS	  1846#	  1868	  1879	  1891	  1902	  1914	  1925
MSGDIE	    83#
MSGLIV	    98#	   661	   805	   921	   930	  1180	  1256	  1342	  1376	  1403	  1408	  1494
MSGSFE	    89#	  1101	  1425	  1433	  1441	  1631	  1748
ND	    58	    59
ONSZCK	  2096
PFALL	  1528	  1792
PJRST	   820	  1563
STOPCD	    46	   426	   535	   581	   595	   613	   616	  1101	  1261	  1425	  1433	  1441	  1631	  1748
X	  1861#	  1868	  1869	  1870	  1871	  1872	  1873	  1874	  1877#	  1879	  1880	  1881	  1882	  1883
	  1884	  1885	  1888#	  1891	  1892	  1893	  1894	  1895	  1896	  1897	  1900#	  1902	  1903	  1904
	  1905	  1906	  1907	  1908	  1912#	  1914	  1915	  1916	  1917	  1918	  1919	  1920	  1923#	  1925
	  1926	  1927	  1928	  1929	  1930	  1931	  2096#
XP	    66	    67	    68	    69	    70	    71	    72	    73	  1091	  1092	  1093	  1094	  1095	  1096
	  1832	  1833	  1834	  1835	  1836	  1837	  1838	  1839	  1840    A@{5
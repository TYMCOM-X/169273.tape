                                                               February 9, 1987







                        ATC S-MODE DESIGN SPECIFICATION


                                    TYMNET
                        NETWORK TECHNOLOGY DEVELOPMENT
                               February 9, 1987





























     ====================================================================
     |   TYMNET's proprietary rights  are included in  the information  |
     |   disclosed herein.  The recipient, by receiving this document,  |
     |   agrees  that  neither  this  document  nor   the  information  |
     |   disclosed herein nor  any part thereof shall be reproduced or  |
     |   transferred to other documents or used or disclosed to others  |
     |   for  manufacturing  or  for  any  other   purpose  except  as  |
     |   specifically authorized in writing by TYMNET.                  |
     ====================================================================





                                                                      SMODE.DOC
                                                               February 9, 1987







                                   TABLE OF CONTENTS

        Section                                                            Page



        1.   BACKGROUND                                                       1


        2.   What is R-Mode?                                                  2
          2.1   Network Echo in Space parity                                  2
          2.2   O-TID support Transparency Mode                               2


        3.   S-Mode                                                           3
          3.1   Configuration to Utilize S-Mode                               3
             3.1.1    the Working Configuration                               4


        4.   S-Mode Call Description                                          6


        5.   Establish an IIX circuit                                         8
          5.1   Login without Gateway                                         8
          5.2   Login Through Gateway                                         9


        6.   IIX Message Format                                              11
          6.1   Global IIX Messages                                          12
          6.2   S-Mode Data Messages                                         13


        7.   Protocol Exchange                                               14


        8.   S-Mode Internal Design                                          15
          8.1   ATC Data/Control Flow                                        15
          8.2   ATC Packet Format                                            16
             8.2.1    PKTYPE - Packet Types                                  17

          8.3   New Switches                                                 18
          8.4   IIX Circuit Building States                                  19
             8.4.1    IDLE State                                             20
             8.4.2    Logon to Supervisor State                              20
             8.4.3    IIX Dialect Select State                               20

          8.5   Implementation Stages                                        21
             8.5.1    Stage 1 - Login String to SUP                          22

                                                                      SMODE.DOC
                                                               February 9, 1987


             8.5.2    Stage 2 - Needle Comes Back                            22
             8.5.3    STAGE 3 - Wait for IIX dialect                         23
             8.5.4    Stage 4 - LKIPK2 receives SIIX or TIIX                 23
                8.5.4.1     stage 4.1 - Select Dialect                       24
                8.5.4.2     Stage 4.2 - IIX data stage                       25

             8.5.5    Stage 5 - Data Xfer                                    26
             8.5.6    Stage 6 - DISCONNECT  SITUATIONS                       27
             8.5.7    Stage 7 - Gateway Login                                27


        9.   Testing                                                         29
          9.1   Prepare a Tymcom Slot                                        29
          9.2   Perform Testing                                              29
          9.3   Reminder                                                     30







































                                                                      SMODE.DOC
        BACKGROUND                                             February 9, 1987






                                    1 -  BACKGROUND


             The S-Mode  project is  the next  step of   the R-Mode  project to
        support the Microdata Prism terminals.   A new feature is added  to the
        R-Mode support to  resolve the terminal  problems  when the  circuit is
        zapped  by the  network.  The  terminals could  be left  in undesirable
        states if they are set into that state by the host computer  before the
        disconnection.   Thus  a   reset  scheme  handled  by  the  network  is
        requested.  The original requirement for the S-MODE  project is to have
        the ATC send a stored message to the Microdata PRISM terminal  when the
        circuit is  zapped.  This  message will  reset the  terminal parameters
        from  R-mode to S-mode.


             Consat version 6.01 implemented this S-MODE requirement in  a more
        general way using IIX.  The IIX capability allows any kind  of messages
        sent from the  Tymcom (version 3.0) to  be stored in the  Consat.  This
        message (called Load  Message) will then be  sent by the Consat  to the
        terminal when  the circuit  is zapped.   The Consat  will also  set the
        parity bit according to the parity bit field in this load  message.  To
        be compatible with the Consat, ATC will implement the same approach.




























        1                                                             SMODE.DOC
        What is R-Mode?                                        February 9, 1987






                                 2 -  What is R-Mode?


             There are two major implementation in the ATC for R-mode support:






                           2.1  Network Echo in Space parity


             The Prism terminals make use of all the 8 bits in a character.  If
        a character generated in the network has its parity bit set, it will be
        interpreted  as a  graphic  symbol by  the Prism  terminal.   A network
        message will then be displayed incorrectly as the result.  So  when the
        terminal is  connected to  the network and  when the  circuit is  to be
        zapped, the parity  bit will be set  to space parity for  the terminals
        declared to be CRTO type in the configuration file.






                         2.2  O-TID support Transparency Mode


             After the terminal is  connected, the terminal user  specifies the
        parameters  characteristics of  his  terminal by  entering  a "Terminal
        IDentification character"  (TID).  When  a TID-A  is detected,  all the
        data processed by the ATC will be treated as 7 bit ASCII data  of "save
        parity".  The parity bit will be passed by the ATC without any change.


             The R-Mode support allows the  O-TID option for data to  be passed
        in 8 bits.


             To  make this  to  work, Tymcom  needs to  have  macro SOPT(E8ETM)
        defined in the  tymfile.  After detecting the TID characteristic in the
        CCT field of the NEEDLE, Tymcom sends ETM (Enter Transparency  Mode) to
        the ATC.  The ATC sets  parity  to "save parity" on receiving  the ETM.
        Data transferred  from then on  will be 8  bits until Tymcom  sends LTM
        (Leave  Transparency  Mode) before  zapping  a circuit.   The  ATC will
        transfer data using  Space parity after receiving the LTM.



        2                                                             SMODE.DOC
        S-Mode                                                 February 9, 1987






                                      3 -  S-Mode


             The S-Mode  differs from  the R-Mode is  that each  key depression
        generates one byte in the  R-Mode, but two bytes in S-Mode.   The first
        byte is  information (value  >= E0 hex),  and the  second byte  is data
        (value from 20  to DF hex).   The terminal is  always powered up  in R-
        Mode.  The host computer can send one byte control  code "E1"  (hex) to
        switch the terminal from R-Mode into S-Mode.  It can also use  one byte
        control code  "EB" (hex) to  switch the terminal  from the  S-Mode back
        into  R-Mode at any time.  And  these control codes do not  take effect
        if the terminal is already in the desired mode.






                         3.1  Configuration to Utilize S-Mode


             There are restrictions in the configuration to make use of  the S-
        Mode support.  An inappropriate configuration could produce undesirable
        result even if the  ATC does support the S-Mode.   Sixteen combinations
        can be generated  with the necessary  components listed below,  many of
        them cannot make use of the S-Mode feature.

           Host Computer - support S-Mode or Not.
           Tymcom        - support R-Mode and S-Mode or Not.
                           has the macros declared or not.
           User          - type in A-TID or O-TID.
           Terminal      - support S-Mode or Not.


             The reason is that the ATC does not know what type of  terminal it
        connects to.  Once its configuration file declares the terminals  to be
        Prism type terminals, the code  will treat them to support  S-Mode.  As
        the  ATC is  a prom  base product  and cannot  be downline  loaded, its
        configuration is  fixed for  each version.  A  terminal  that  does not
        support S-Mode might be  confused by the control characters  sending to
        it.


             The user has to enter O-TID at connection time to make use  of the
        R-Mode and S-Mode.  An A-TID will not cause the R-Mode and S-Mode to be
        utilized.   In addition,  using A-TID  on a  Prism terminal  will cause
        display problems.



        3                                                             SMODE.DOC
        S-Mode                                                 February 9, 1987


             Another  factor is  on  the host  interface side.   If  the Tymcom
        version  does not  support R-Mode  and S-Mode,  or if  it does  but the
        necessary macros are not declared in its tymfile, the outcome  will all
        be affected.





                    3.1.1  the Working Configuration

        |-----------|
        | Sovereign |     |--------|            |-----|   
        | host      | --  | Tymcom |  --------- | ATC |  --- PRISM 
        | computer  |     |--------|            |-----|      TERMINALS
        |-----------|                                        
                                                             
           (1)              (2)                   (3)         (4)


        (1) Sovereign Host Computer - 

            A host computer that supports S-Mode:
            It can send an "E1" or "EB" byte to the terminal
            to set it  into S-mode or reset it into R-mode.

        (2) Tymcom -

            Tymcom version 3.0  has S-mode implemented using
            IIX protocol.  To utilize this feature, the macro
            TBYEMS needs to be declared in the tymfile at sys
            gen time.  This macro can contain any text string
            including the hex byte "80EB". For example:
             
                TBYEMS("80"EB"0D"0ALEAVING HOST XXX)

            The text string is sent to the circuit originating
            interface (ATC or Consat) after the IIX protocol
            exchange is established. Its format follows the one
            of the Load Message. The first byte is the parity
            information, the second byte is the control byte.
            Macro SOPT(E8ETM) should also be declared.


        3) ATC -

            ATC version 3.0 will have the S-mode support using IIX 
            protocol to talk to Tymcom.  Once the IIX protocol is 
            established between the ATC and Tymcom, any S-Mode IIX
            data message sent from Tymcom will be stored in the ATC
            buffer.  This message is disptached when the zapper is 
            received. The first byte updates the parity bit, the
            remaining message will be sent to the terminal.

        4                                                             SMODE.DOC
        S-Mode                                                 February 9, 1987



            Receiving another  S-Mode IIX message CLEAR (C080) at
            any time will cause the ATC to throw away the message.

            The ATC configuration file should declare all the 
            eight terminals to be of type  CRTO (Prism terminal).

        (4) PRISM TERMINALS -
          
            The following PRISM terminals which have S-Mode support
            shall be used.
           
            PRISM-4
            PRISM-5
            M100 -  PRISM 4/5 EMULATOR
            PRISM-14






































        5                                                             SMODE.DOC
        S-Mode Call Description                                February 9, 1987






                             4 -  S-Mode Call Description


             The  following graph  shows four  states which  explains  the high
        correlations between the TID, parity bit and S-Mode.

          terminal    ---->  TID-O  ---->    Tymcom         ----> circuit
          connected          entered         sends ETM      zapped

          (state 1)          (state 2)       (state 3)     (state 4)


        State 1: terminal is turned on.

                 a. defaulted to R-Mode.
                 b. defaulted to space parity for Prism 
                    type terminals

        State 2: TID-O entered.

                 a. still in R-Mode.
                 b. username, password, network messages are processed
                 d. circuit built 
                    (in R-Mode or S-Mode depends on the
                     IIX dialect select result)

        State 3: Tymcom sends ETM (Enter Transparency Mode)

                 a. change into save parity
                 b. terminal talks to host in 8 bit data

        State 4: circuit zapped

                 a. Tymcom sends LTM (Leave Transparency Mode)
                 b. change the parity bit:
                    
                    If in R-Mode
                    ------------
                    change into the space parity

                    If in S-Mode
                    ------------
                    use the Parity type sent in the Load message

                     00 - current-state parity (same as in state 2)
                     01 - null parity (save parity,reserve parity)
                     02 - space parity (parity bit = 0)
                     03 - even parity 


        6                                                             SMODE.DOC
        S-Mode Call Description                                February 9, 1987


                    send the load message to terminal





















































        7                                                             SMODE.DOC
        Establish an IIX circuit                               February 9, 1987






                             5 -  Establish an IIX circuit


             Each end of a circuit must  know that the other end is  capable of
        supporting IIX.  When ATC and  Tymcom report their  host status  to the
        Supervisor, the Supervisor knows if  they are smart or dumb  by looking
        at the IIX  capability information.  When the  "TID FOR NEW  LOGIN PLUS
        STRING"  reaches the  Supervisor, Sup looks  at the first  character to
        decide if this is an IIX  request.  If both ends are smart then  IIX is
        invoked.


             Following sections give the examples of successful login sequences
        for:

        1. Login without Gateway 
        2. Login through Gateway 


             Note that the sequences in  [] can appear when the password  is to
        be entered seperately from the username (and system number).


             For both of the cases, after a successful login, the  IIX protocol
        exchange will be followed.






                              5.1  Login without Gateway

         
          Tymcom     Node        Sup                     ATC
          ======     Code        ===                     ===
                     ====
                                 <---------------- TID FOR NEW LOGIN
                                                   PLUS STRING (0F)
                                                   IIX turned on
         
                             [ TALK TO TERMINAL
                               IN LOGIN MODE (0D) ----------->

                                 <---------------- LOGON STRING 
                                                   CONTINUATION (0E)  ]

                                NEEDLE (09)  -------------> 
                                IIX circuit flag set

        8                                                        SMODE.DOC
        Establish an IIX circuit                               February 9, 1987



                      <--------------------------- NEEDLE (09)
                                                   IIX circuit flag set








                              5.2  Login Through Gateway


        Tymcom     SUP     Gateway        SUP              ATC
        ======     ===     =======        ===              ===

                                             <-- TID FOR NEW LOGIN
                                                 PLUS STRING (0F)
                                                 IIX turned on

                                         [ TALK TO TERMINAL
                                           IN LOGIN MODE (0D) ----->

                                         <--------- LOGON STRING 
                                                    CONTINUATION (0E) ]


                                        Needle (09) --->
                                        IIX circuit flag set

                             <--------------------- Needle (09)
                                                    (IIX circuit flag set)

                             Tymnet/Tymnet gateway --->
                             (8080 8082)


                           Normal Logon
                           status (8084 01)
                           "please log in" -------------->

                   <-------------------------------- (0F) TID FOR NEW
                                                     LOGIN PLUS STRING (0F)
                                                     IIX turned on
                                           [ option ]

                 Normal Logon
                 Status (B4) -->
                           Normal logon -------------->
                           status (8084)



        9                                                             SMODE.DOC
        Establish an IIX circuit                               February 9, 1987


                   Needle (09)---->
                   IIX circuit flag set

          <----Needle (09)  8082/8083 ------------------>
               IIX circuit  smart/dump
               flag set     host reached          
















































        10                                                            SMODE.DOC
        IIX Message Format                                     February 9, 1987






                                6 -  IIX Message Format


             An IIX command or response consists of the following field:

        |------|------|--------|--------|--------|
        | SIIX | TYPE | <size> | <data> | <TIIX> |
        |------|------|--------|--------|--------|

        SIIX:  Start of IIX flag
        TYPE:  Command or Response Type
        <size>: number of bytes to follow, optional
        <data>: information field, optional
        <TIIX>: Termination of IIX flag, optional


             The SIIX   should be sent  before each IIX  message to  notify the
        other side  this is  an IIX message.   TIIX  message  can also  be sent
        after an IIX message, but is not required after every IIX message.

        Format of SIIX and TIIX
        =======================

        |------|----------------------|----------|
        |      |     Tymcomm          |   ATC    |
        |------|----------------------|----------|
        | SIIX |   RPORT#   BF        | 01F6     |
        |------|----------------------|----------|
        | TIIX |   RPORT#   C0        | 01F7     |
        |------|----------------------|----------|


             RPORT# is the two byte port number assigned by Dispatcher  to this
        circuit.  BF and C0 (both in HEX) are 1-byte ISIS control messages.


             When there  is a SIIX  to be  sent out, the  ATC sends  a function
        packet  with value  01F6.  This  packet reaches  the node  code  of the
        Tymcom and is transformed to BF preceeded by the ISIS RPORT  number and
        then sent to Tymcom.


             Same rules apply to TIIX (C0 and 01F7)







        11                                                            SMODE.DOC
        IIX Message Format                                     February 9, 1987


                               6.1  Global IIX Messages


             Following is  a list of  the global IIX  messages used  in S-Mode.
        All the values are in hex.

        1. 8080 - Select Dialect

            format: |------|---------|------|
                    | 8080 | dialect | TIIX |
                    |------|---------|------|

            dialect list:
                 8081: ASCII dialect (null dialect)
                 8082: Tymnet/Tymnet gateway
                 8083: X.25/X.75 interface
                 8084: 3270 DSP
                 8093: S-Mode dialect


        2. 8081 - Dialect Selected
            format: |------|---------|
                    | 8081 | dialect |
                    |------|---------|

            dialect= 8080: no dialect selected
                     8081: ASCII data dialect selected
                     8093: S-Mode dialect selected

        3. 8082 - Smart Host Reached
        4. 8083 - Dumb Host Reached
        5. 8084 - Normal Logon Status

           format: |------|--------|
                   | 8084 | status |
                   |------|--------| 

           status: 1 byte of logon status, format is as in
                   ISIS B4 and B5  message

        6. 8086 - product ID and version #, not supported by ATC
        7. 8087 - Request Product ID, not supported by ATC












        12                                                            SMODE.DOC
        IIX Message Format                                     February 9, 1987


                               6.2  S-Mode Data Messages


             Following are two messages meaningful only to S-Mode feature.

        C080 - Clear Message

        C081 - Load Message
           format:  |------|------|-----|---------|
                    | C081 | len1 | par | message |
                    |------|------|-----|---------|

           len1: how many butes of the message to be loaded
                 value <= 9D-4

           par:  parity type of data message loaded to terminal 
                 when network circuit is zapped.

                 00 - current-state parity
                 01 - null parity
                 02 - space parity
                 03 - even parity
































        13                                                            SMODE.DOC
        Protocol Exchange                                      February 9, 1987






                                7 -  Protocol Exchange


             After an IIX  circuit is built between  the Tymcom and  ATC, there
        will be protocol  exchanges between these  two hosts.  Following  is an
        example of selecting S-mode:

        Tymcom                                  ATC
        ======                                  ===

              IIX circuit built from ATC to Tymcom

        RPORT# BF  ------------------------------>
        (SIIX)
        RPORT# 06 8080 8081 8093  --------------->
        (Select Dialect)
               <------------------------------01F6 8080 8093
                                              (Dialect Selected)

               [data messages]

        RPORT# BF   ----------------------------->
        (SIIX)
        RPORT# len1+2 C081 len1 par  message  --->

               [data messages]


             As the data messages sending from either the host computer  or the
        terminal are not  IIX messages, they  are not lead  by the SIIX  as the
        Clear Message or Load Message.



















        14                                                            SMODE.DOC
        S-Mode Internal Design                                 February 9, 1987






                              8 -  S-Mode Internal Design


             The following sections focus on the internal design of  the S-Mode
        project.  Any modification to the code  will be built onto the existing
        structure for consistency and clarity.






                              8.1  ATC Data/Control Flow


             The ATC code has five major components:

        1. the LING modules -- the terminal interface driver
        2. the TRM modules -- handles terminal side packets
        3. the PKT modules -- packets routines
        4. the LKIPK modules -- handles network side packets
        5. the LINKI modules --  direct interface into network


             The Data/Control Flow between these components looks as follows:

        OUTPUT DATA FLOW
        ================

        |//////|
        |Tymnet|
        |//////|
              <----- LINKI 
                     <---- LKIPK1
                           <--- PKT
                                <--- TRMP <---TRM 
                                               <--LING
                                                         |/////////////|
                                                  <------|terminal user|
                                                         |/////////////|
        INPUT DATA FLOW
        ===============

        |//////|
        |Tymnet| ---->
        |//////|
               LINKI ---->
                      LKIPK2 ---->
                               PKT ----->

        15                                                            SMODE.DOC
        S-Mode Internal Design                                 February 9, 1987


                                     TRMF ----> TRM --->
                                                     LING --->
                                                 |/////////////|        
                                                 |terminal user|
                                                 |/////////////|



             Main focus  of the  S-Mode implementation will  be on  the LKIPK1,
        LKIPK2,  TRMP, TRMF  and TRM  modules.  Information  is  passed through
        packets  between these modules.   Among the different types  of packet,
        modification will be done to the  function type packet (PKTYPE=4).






                                8.2  ATC Packet Format


             An ATC  packet has  minimum length  of six  bytes.  The  first six
        bytes have fixed meanings:

         byte 0-1   PKLINK - link pointer to next packet.
         byte 2     PKCNT  - number of bytes in packet.
         byte 3     PKTYPE - packet type (see next section).
         byte 4     PKSOC  - socket number when a packet is
                             sent over a link.
                 or PKPNT  - pointer which points to the current
                             data byte in the packet on the
                             destination list.
         byte 5    PKSEQ   - packet sequence number.


             The packet data area starts from byte 6, its offset in  the packet
        is called PKDATA.

















        16                                                            SMODE.DOC
        S-Mode Internal Design                                 February 9, 1987


         
        |-------------------|   
        |   PKLINK          |   
        |---------|---------|   
        | PKTYPE  | PKCNT   |   
        |---------|---------|   
        | PKSEQ   | PKSOC   |   
        |         | / PKPNT |      
        |---------|---------|      
        |   PKDATA          |      
           ....                  
        |-------------------|    





                    8.2.1  PKTYPE - Packet Types


             There are twelve  packet types, each  is assigned an  octal value.
        Their value, symbol in the code and meaning  are listed below:

        Value   Symbol    Meaning                 
        =====   ======    ===================

          0     .PTDAT    DATA PACKET
          1     .PTCCN    CONNECTION REQUEST 
          2     .PTACK    CONNECTION ACK     
          3     .PTNAK    CONNECTION NAK     
          4     .PTFUN    FUNCTION
          5     .PTINT    INTERRUPT          
          6     .PTEAT    EAT FUNCTION       
          7     .PTDIS    DISCONNECT REQUEST
         10     .PTKIL    KILL CONNECTION    
         11     .PTDAK    DISCONNECT ACK     
         12     ??????    RECONNECT REQUEST  
         21     ??????    X.25 RR EQUIVALENT
















        17                                                            SMODE.DOC
        S-Mode Internal Design                                 February 9, 1987


                                   8.3  New Switches

        1. S-Mode IIX switch  (..IIX=!1)


             This switch is used in all the module that the code is affected by
        the S-Mode implementation.  The  purpose is to keep  the implementation
        as  independent as  possible.   The new  code will  have  the following
        format:

           .IF NE ..IIX
             new code
           .ENDC


             This switch will be declared in file IIXPR.MAC.  Any  module which
        uses this switch should be  assembled with this macro file.  On  top of
        each module there should also have the following statements  to default
        the ..IIX to 0:

           .IF NDF ..IIX
               ..IIX=!0
           .ENDC

            
        2. IIX request bit ($I3IIX, T1IIX)


             It is  used to distinguish between an non-IIX and IIX circuit.  It
        is on both the TERMINAL and NETWORK modules.

        NETWORK   ---     $I3IIX, SDLIS3
        TERMINAL  ----    $T1IIX, SDTRS1


        3. In S-Mode bit ($I3SMO)


             It is used to indicate it is in the state that the LOAD & CLEAR S-
        Mode  IIX messages  are legal  from  the network.   It is  used  in the
        NETWORK modules only.  The SIIX and TIIX function packets will  only be
        sent to the Terminal side when the smodeB=1.

           set:   dialect selected to be S-Mode
           reset: DISCONNECT send to terminal side
                  DISCONNECT received from the terminal side

        4. Terminate of SIIX message ($I3WAT)


             It is an indication of  the termination of an IIX message.   It is
        used only at the NETWORK side.
            

        18                                                            SMODE.DOC
        S-Mode Internal Design                                 February 9, 1987


           set:   when SIIX is received
           reset: when TIIX is received
                  when number of data received on SYNC line
                       = length or end of frame indication reached

        5. Wait for Dialect exchange bit ($I3DIA)


             Used in the Network side  only.  This bit is set when  NEEDLE came
        back with IIX bit  set.  Which means the code  should be in a  state to
        wait for the IIX Dialect Exchange. It should  be cleared when a dialect
        is selected,  or when the circuit is zapped for any reason.

        6. Gateway Login State ($I3GWY)


             Used in the Network side only.  This bit is set when  LKIPK2 sends
        8081 8082 (selected gateway) as the dialect.

        7. Load Message Flag ($I3MSG)


             Used  in the  network  side only.   This  bit is  set  when LKIPK2
        receives C081  in the S-mode.   It is reset  when the whole  message is
        read into the temporary buffer.






                           8.4  IIX Circuit Building States


        1. IDLE state
        2. Logon to Supervisor State
        3. IIX Dialect Select State
        4. Non-IIX State
        5. S-Mode IIX State
        6. Gateway Login State














        19                                                            SMODE.DOC
        S-Mode Internal Design                                 February 9, 1987


                    8.4.1  IDLE State

             This state is entered:

        1. intially before logon is triggered
        2. from other states when the circuit is zapped






                    8.4.2  Logon to Supervisor State

             At this state, the TID and user login string shall be sent  to the
        supervisor.  The IIX bit in  the Node to Supervisor Message  "0F" shall
        be  set to  0 to  indicate a  login request  for IIX  circuit.  Several
        situation could happen at this state:
         
        1. Text string coming back from the  Supervisor
           ---> output it to the terminal
                stay in this sate

        2. "0D" message with flag is returned from the Sup
           ---> perform appropriate action on the flag
                a. error, stay in this state
                b. continue, send information requested 

        3. Time out while waiting for sup to respond
           ---> disconnect, back to IDLE state

        4. NEEDLE returned from the supervisor
           ---> check bit 9 of flag byte in the NEEDLE
                a. not 0, the host interface is dump
                          enter NON-IIX state
                b. = 0, remember this information
                        enter IIX Dialect Select State






                    8.4.3  IIX Dialect Select State

             Once an IIX circuit is built, before any other information  can be
        exchanged the  caller and  the callee  must know  what dialect  will be
        used.  As soon as the IIX circuit is established ATC waits for the 8080
        from host interface.  Several conditions could happen:

        1. Disconnect request received from network 
           ---> zap circuit


        20                                                            SMODE.DOC
        S-Mode Internal Design                                 February 9, 1987


        2. Time out on waiting for the "Select Dialect" command
           ---> zap circuit

        3. Receives anything other than "Select Dialect" command 
           ---> zap circuit

        4. The host interface send the "Select Dialect" command
           with a list of dialect, terminated by a TIIX.


             For the case  4, after sending  the "Select Dialect"  command, the
        Host Interface waits for ATC to respond.  Again there are four possible
        situations:

        1. None of the dialects provided can be supported by 
           the ATC ---> zap circuit.

        2. The only dialect to be selected is the ASCII data
           (8081)  ---> The ATC sends 8081 8081,
                        protocol exchange completed, 
                        byte SDLIIX = 0,
                        enter NON-IIX state.

        3. Received 8080 8082 (Tyment/Tymnet gateway)
           --->  the ATc sends 8081 8082,
                 enter Gateway Login state

        4. The Consat S-Mode dialect (8093) is selected
           ---> the ATC sends 8081 8093,
                IIX protocol exchange completed, 
                enter IIX circuit state.







                              8.5  Implementation Stages


             The S-mode project  is broken down into  7 stages to  simplify the
        implementation  and minimize  the possibility  of logic  errors.  These
        seven stages are scheduled to be completed in five weeks:

        Week 1 - January 26-30     Stage 1, 2, 3
        Week 2 - February 2-6      Stage 4, 4.1, 4.2
        Week 3 - February 9-13     Stage 5,6
        Week 4 - February 16-20    Stage 7
        Week 5 - February 23-27    testing




        21                                                            SMODE.DOC
        S-Mode Internal Design                                 February 9, 1987


                    8.5.1  Stage 1 - Login String to SUP

        AUTO11    -- if is space parity output
                     (bit $T2SPP is set in SDTRS2 )
                     1. set $T1IIX in SDTRS1

        CMDSAT    -- if $T1IIX set IN SDTRS1 then when setting
                     up the CONNECT PACKET set PKDATA+27 to 40

        LKIPK1   --  if PKDATA+27 has value 40

                     1. set $I3IIX in SDLIS3
                     2. do not set 80 bit for IIX in the
                        SUP 0F message  send to SUP





                    8.5.2  Stage 2 - Needle Comes Back

             Four conditions can happen  on both the network and  terminal side
        with the IIX  request bit set/not set  and the IIX circuit  bit set/not
        set:

                     Network side:           Terminal side:
                     =============           ==============
                   | IIX ckt  NON-IIX  | IIX ckt    NON-IIX ckt
        -----------|-------------------|----------------------------
        IIX req    | NA        reset   |      NA         reset
        NON-IIX req| FSTOP     NA      |      FSTOP      NA
        -----------|-------------------|---------------------------

        NA: not do anything to the IIX request bit
        reset: clear that bit
        FSTOP: fatal stop for impossible reason


        LKIPK2  --  1. if $I3IIX is set in SDLIS3
                           if flag =non-IIX
                              reset $I3IIX bit in SDLIS3
                           endif
                       else
                           if flag = IIX then FSTOP IIN
                       endif

                    2. clear  PKDATA+1
                       if $I3IIX is set in SDLIS3
                       (here it already represents if is
                        an IIX circuit)
                          PKDATA+1=200 octal
                          SET $I3DIA in SDLIS3 (wait for dialect exchange)
                          set timer to 90 seconds (TIMREQ)

        22                                                            SMODE.DOC
        S-Mode Internal Design                                 February 9, 1987


                       endif
                                         
                    3. send CLEAR LOGIN MODE FUNCTION PACKET 
                       TO terminal, with 2 bytes in PKDATA field.

        TRMF   --  check on CLEAR LOGIN MODE FUNCTION PACKET

                   if $T1IIX set in SDTRS1 then
                      if (PKDATA+1)=0   reset $T1IIX bit
                   else
                      if (PKDATA+1<>0)  FSTOP IIN
                   endif





                    8.5.3  STAGE 3 - Wait for IIX dialect

             Here the $I3DIA bit in SDLIS3 word is set.

        LKIPK2
        ======
             o received SIIX - stage 4
             o received TIIX - stage 4
             o zapper
                  clear SDLIS3 word
                  use existing code
             o timeout 
                  ZAP LOGICAL CIRCUIT
             o text received
                  ZAP LOGICAL CIRCUIT





                    8.5.4  Stage 4 - LKIPK2 receives SIIX or TIIX


             New  routines  adds into  the  Dispatch  table will  be  put  in a
        seperate module LNKIIX.MAC to keep the code clean.

        SIIX
        ====

            if $I3MSG=1 then  ZAP LOGICAL CIRCUIT
            if $I3WAT=1 then  ZAP LOGICAL CIRCUIT

            GET NEXT BYTE (the byte after SIIX)
            if  byte = "80" then
                GET NEXT BYTE
                if byte = 80 then  

        23                                                            SMODE.DOC
        S-Mode Internal Design                                 February 9, 1987



                    kill timer (TIMKIL)
                    $I3WAT = 1
                    get a packet
                    link to SDIXSP, put function type/ SIIX 
                    keep reading byte from frame record
                        and put into packet until done
                else
                  if $I3DIA=0 then
                        ZAP LOGICAL CIRCUIT
                  else
                    81 -- ZAP LOGICAL CIRCUIT
                    82 --  reached smart host
                            $I3DIA=1
                    83 -- reached dumb host
                            $I3IIX=0
                            send CLEAR LOGIN PKT to terminal
                            (pkdata+1=0)
                    84 -- STAGE 7
                    85 -- IGNORE IT
                    86 -- ZAP LOGICAL CIRCUIT
                    87 -- IGNORE IT
                 endif
              else
                 stage 4.2
              endif
             endif

        TIIX
        ====

            if $I3MSG=1 then   ZAP LOGICAL CIRCUIT

            if $I3WAT=1 then (a dialect list ready to be dispatched)
               get packet off SKIXSP
               dispatch dialect in this packet (stage 4.1)
               $I3WAT=0
            endif

            send a TIIX function packet to terminal side



        8.5.4.1  stage 4.1 - Select Dialect

              for i=0,(pkcnt/2)-1 do
                 begin
                    if (pkdata+ I*2) = 81 then
                       BR DIAL81
                    else if (pkdata+i*2)=82 then
                       BR DIAL82
                    else if (pkdata+i*2)=93 then
                       BR DIAL93

        24                                                            SMODE.DOC
        S-Mode Internal Design                                 February 9, 1987


                    endif
                end

              BR DIAL80  (if everything fails)
              for all conditions do
                 1. clear SDIXSP pointer
                 2. free packet

        conditions:
        -----------
              DIAL80 -- no dialect can be chosen
                 return 8081 8080 to reject any dialect
                 ZAP LOGICAL CIRCUIT

              DIAL81 -- ASCII selected
                 $I3IIX=0
                 return 8081 8081 to network
                 LOGIN COMPLETE(IIX=0)

              DIAL82 -- gateway selected
                 $I3GWY=1
                 return 8081 8082 to network

              DIAL93 -- S-MODE selected
                 $I3SMO=1
                 return 8081 8093 to network
                 LOGIN COMPLETE (IIX=1)
           



        8.5.4.2  Stage 4.2 - IIX data stage

           if $I3SMO=0 then
              ZAP LOGICAL CIRCUIT
           else
              if this byte <> C0 then
                 ZAP LOGICAL CIRCUIT
              else
                 read next byte
                 if byte = 80 then
                     send function packet with C080 to terminal
                 else if byte = 81 then
                     get a packet
                     link to SDIXSP
                     put function /SIIX C081 into it
                     PKSEQ=1, PKCNT =1
                     $I3MSG =1
                     keep reading bytes and put into buffer
                     until byte count is reached.
                     send the pkt to terminal side
                     send TIIX to terminal side
                     clear SKIXSP pointer

        25                                                            SMODE.DOC
        S-Mode Internal Design                                 February 9, 1987


                     free packets (s) for temporary buffer
                     I3MSG = 0
                 endif
              endif
           endif





                    8.5.5  Stage 5 - Data Xfer

        TRMF
        ====
            if receives TIIX then
               if reqB=0 then
                  DISCONNECT
               else
                  used to determine that the
                  load message is completed
               endif
            endif

            if receives SIIX  then
               if reqB=0 then
                  DISCONNECT
               else
                   (*** logic has to handle if more than
                        one data packet is needed for the
                        load message, 
                      1. is it still a siix function packet?
                      2. is it going to be terminated by TIIX?
                      3. will it be checked by the length? somehow? ***)

                  dispatch the packet DATA area
                  if = C080 then
                        return the LOAD msg pkt pointer
                  else if = C081 then
                         allocate a pkt to store the msg
                  else
                         reqB=0
                         DISCONNECT
                  endif
              endif










        26                                                            SMODE.DOC
        S-Mode Internal Design                                 February 9, 1987


                    8.5.6  Stage 6 - DISCONNECT  SITUATIONS

        TRMF receives DISCONNECT PKT from network side
        ====
           if reqB=1 then
             1. dispatch load msg
             2. display msg
             3. change parity
             4. reqB=0
             5. clean up LOAD msg pointers
           endif

        LKIPK1 receives DISCONNECT PKT from terminal side
        ======
             1. reqB=0 
             2. smodeB=0
             3. if (waitB=1)
                  give up TEMP buffer
                  waitB=0
                endif

        LKIPK2 - ZAP LOGICAL CIRCUIT
        ======
           if anything on SDIXSP then free the pkt
           flush the record
           continue with frame (should flush the record  
                of the same socket in the same frame).






                    8.5.7  Stage 7 - Gateway Login

        Here the $I3GWY=1.

        LKIPK2
        ======
          o receives text string
            -- send a data packet to terminal

          o receives SIIX 8084
            READ NEXT BYTE (status byte)
               dispatch  using ISIS B4 and B5 format
                  0  continue
                  1  please log in
                  2  error, type username
                  3  error, type password
                  4  username
                  5  password
                  8   "please see your rep"    DISCONNECT
                  9   bad mud                  DISCONNECT

        27                                                            SMODE.DOC
        S-Mode Internal Design                                 February 9, 1987


                  0A  circuits busy            DISCONNECT
                  0B  host not avail           DISCONNECT
                  0C    host out of ports      DISCONNECT
                  0D  host down                DISCONNECT
                  0F  try again in 2 minutes   DISCONNECT
                  10  access not permitted     DISCONNECT
                  11  no host specified        DISCONNECT
                  12  bad host number          DISCONNECT
                  13  mud error                DISCONNECT

                 80 - ISIS unable to complete request
                 81 - format error
                 82 - bad user name
                 83 - bad mud
                 84 - system unavilable
                 85 - down-line load or dial-out failure
                 86 - timeout
                 87 - access not permitted
                 88 - out of origination ports
                 89 - try again later
                 8A - bad requesting-host number
                 8B - requesting-host not up on requesting node
































        28                                                            SMODE.DOC
        Testing                                                February 9, 1987






                                     9 -  Testing


             To test if the S-Mode implementation work or not, we will  need to
        prepare a Tymcom slot which  will send the Load Message when  the login
        is successful and  IIX protocol exchange  is completed.  Then  we shall
        zap the circuit  and expect to  see the Load  Message to appear  on the
        screen.


             This test should be performed on a 430 or 444 terminal and also on
        a Prism terminal to make sure that it works completely.






                              9.1  Prepare a Tymcom Slot

           
           Version: 3.00
           Tymfile: (Bubbnet:39)BB2071.#02
           Macro added: TBYEMS("80"EB"0D"0AZAPPED FROM HOST 764)
           Node: Bubbnet, node 2071
           Slot: 2
           Host #: 764
           Kernel Host #: ????






                                 9.2  Perform Testing


             Once  the Tymcon  slot  is loaded  and  the ATC  prom  with S-Mode
        implementation is ready to run, perform the following steps:

        1. login to host 764 with following input:

           O<CR>
           ISISTECH:764;BUG-SPRAY<CR>

        2. Two ways to zap the circuit:
           a. login to kernel host  ???? and issue command
              H to halt the Tymcom slot to zap all the circuits.


        29                                                            SMODE.DOC
        Testing                                                February 9, 1987


           b. type in a control Z on the keyboard to zap 
              the circuit been tested.

        3. Examine the terminal display and see if the message 
           
                ZAPPED FROM HOST 764


           is displayed on the screen.






                                     9.3  Reminder


             The S-Mode version of ATC  has ..IIX switch turned on for  all the
        terminals  connected.   That  is,  all  the  terminals  are  treated as
        supporting  S-Mode.  So  if the  Tymcom supports  S-mode,  the terminal
        supports S-Mode,  then there should  be no problems.   Several problems
        might happen when


        1. The terminal does not support S-Mode.

        Question: If the terminal does not support S-Mode,
           how does it treat the control characters sending
           from ATC when the circuit is zapped?

           Will these control characters set the terminal
           into a incorrect state? Or, if not, will they
           be displayed as garbage?

           Or these characters will be simply thrown away
           by the terminal? 

        Guessing: These characters will simply be thrown 
           away by the terminal.

        Testing: Use a non-Prism terminal to login to 
           a Tymcom 3.00  which has macro TBYEMS declared
           with control character "EB" in the argument.
           Zap the circuit by halting the Tymcom to see
           if the display looks normal.
           
          






        30                                                            SMODE.DOC
  8\]k
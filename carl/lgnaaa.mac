UNIVERSAL LGNUNV - Parameter file for LOGIN version 63(1115) - 12-Jan-84
SUBTTL	Larry Campbell /TW/DJB/DAL/RCC/JSL/DAL/LC/HRB/BAH/WCL/KPY/MSL/WSM/DPM

;	LOGIN - The program for gaining access to the
;		DECsystem-10 Timesharing System


;COPYRIGHT (C) 1969, 1974, 1979, 1980, 1981, 1982, 1983, 1984 BY
;DIGITAL EQUIPMENT CORPORATION, MAYNARD, MASS.
;
;  This version hacked to get scan stuff out of it.
;
;DIGITAL ASSUMES NO RESPONSIBILITY FOR THE USE OR RELIABILITY  OF  ITS
;SOFTWARE ON EQUIPMENT WHICH IS NOT SUPPLIED BY DIGITAL.

IF1, <PRINTX [Searches UUOSYM, MACTEN, SCNMAC, ACTSYM, UFDPRM]> 
	SEARCH	UUOSYM,MACTEN,SCNMAC,ACTSYM,UFDPRM

IF2, <	PRINTX
	PRINTX [Loads with REL:SCAN, REL:WILD, REL:HELPER, REL:FACTOR, REL:UFDSET]>
	.REQUEST REL:SCAN,REL:WILD,REL:HELPER
	.REQUEST REL:FACTOR,REL:UFDSET

	SALL

	TWOSEG

	LGNVER==63
	LGNMIN==0
	LGNEDT==1115
	LGNWHO==0

	LOC	137
	VRSN.	(LGN)

;               TABLE OF CONTENTS FOR LOGIN
;
;
;                        SECTION                                   PAGE
;    1. Edit history..............................................   3
;    2. Parameters................................................  15
;    3. Message macros............................................  17
;    4. Inter-module globals......................................  18
;    5. Storage definitions.......................................  19
;    6. Type first message, check states bits.....................  29
;    7. SESSION command scanning..................................  34
;    8. TERMSW
;         8.1   Handle /TERMINAL:(args) switch        [744].......  40
;    9. Switch tables
;         9.1   LOGIN switches (definition).......................  43
;         9.2   LOGIN switches (expansion)........................  44
;         9.3   ATTACH switches (definition)......................  45
;         9.4   ATTACH switches (expansion).......................  45
;         9.5   TERMINAL arguments (definition)...................  46
;         9.6   TERMINAL arguments (expansion)....................  47
;   10. LGNSCN storage............................................  48
;   11. Search ACCT.SYS...........................................  53
;   12. Check ACCT.SYS entry......................................  57
;   13. Write USAGE/FACT file entry...............................  59
;   14. SWITCH.INI handling.......................................  60
;   15. PROMPT user for ACCOUNT and REMARK........................  62
;   16. Get the account string....................................  63
;   17. Get the REMARK string.....................................  65
;   18. Fact file header setup....................................  66
;   19. Expiration date conversion      [754].....................  67
;   20. Password encryption routines..............................  68
;   21. VALIDATION accounting message.............................  70
;   22. LOGIN account message.....................................  71
;   23. SESSION account message...................................  72
;   24. ATTACH accounting message.................................  73
;   25. Support routines..........................................  74
;   26. IPCF message routines.....................................  77
;   27. CHKJSP - check If ATTACH Preferred Over LOGIN.............  78
;   28. Turn on echo, diddle some bits............................  81
;   29. Build scheduler table.....................................  82
;   30. Search AUXACC.SYS.........................................  86
;   31. Subroutine to set up a UFD................................  91
;   32. Subroutine to create a path............................... 106
;   33. Set user profile
;        33.1   privileged GALAXY SETUUOs......................... 108
;        33.2   privileged SETUUO's............................... 109
;        33.3   non-privileged SETUUOs............................ 116
;   34. Set user parameters
;        34.1   subroutines....................................... 123
;   35. LOGIN messages............................................ 130
;   36. I/O subroutines........................................... 134
;   37. Error conditions.......................................... 138
;   38. Error message routine..................................... 139
;   39. Error message printer..................................... 141
;   40. ERRWTO - ROUTINE TO WTO IMPORTANT ERROR MESSAGES.......... 142
;   41. Random messages........................................... 144
;   42. Data and storage.......................................... 146
	SUBTTL	Conditional assembly switches

ND SUPNOT,1		;SUPPRESS NOTICE.TXT IF / IN PPN
ND FASTLG,1		;INCLUDE DIRECTORY OF ACCT.SYS IN HI SEG
ND SETTTY,1		;INCLUDE CODE TO SET TTY CHARACTERISTICS
ND BATMAX,0		;[505] INCLUDE CODE TO CHECK BATMAX (REQUIRES
			;[505] EDIT 1055 OF BATCON)
ND NCRYPT,0		;[557] PASSWORD ENCRYPTION
ND PSWCHG,0		;[557] ALLOW USER TO CHANGE OWN PASSWORD
ND FTCMPR,1		;[667] ZERO COMPRESS UFDS WHEN RECOMPUTING QUOTA
ND FTMAIL,0		;[760] CALL EXTERNAL RNMAIL ROUTINE
ND FTUSAG,1		;DO USAGE ACCOUNTING
ND FACTSW,1		;DO FACT FILE ACCOUNTING (7.01 ONLY)
ND FAILOG,1		;LOG LOGIN/ATTACH FAILURES IN FACT FILE
IFE FACTSW,<FAILOG==0>	;NO POINT IF NO FACT FILE

;OTHER PARAMETER VALUES

ND TTYSLP,2		;NO. OF MINS TO SLEEP AWAITING TTY INPUT BEFORE DYING
ND PDLSIZ,60		;DEPTH OF STACK
ND DVICES,20		;[470] NUMBER OF DEVICES ASSIGNABLE BY /ASSIGN
ND EXPWRN,^D31		;DAYS TO WARN IF PPN WILL EXPIRE SOON
ND STRMAX,^D36		;MAXIMUM NUMBER OF STRS IN SYSTEM
ND TTYBSZ,^D24		;NUMBER OF WORDS IN TTY OUTPUT BUFFER
	SUBTTL	Declaration macro

IF1,<
DEFINE	LGNDCL,<
	.XCREF
	LALL
;



;THIS SOFTWARE IS FURNISHED UNDER A LICENSE AND MAY ONLY BE USED
;  OR COPIED IN ACCORDANCE WITH THE TERMS OF SUCH LICENSE.
;
;COPYRIGHT (C) 1969, 1974, 1979, 1980, 1981, 1984 BY DIGITAL EQUIPMENT CORPORATION, MAYNARD, MASS.
	TWOSEG
	RELOC	400000
	IFNDEF	BIGLST,<SALL>
	LOWVAR
	GLOBS
	.CREF
>>
	SUBTTL	Edit history

;316)	FIX TEST FOR WEEKEND TO PREVENT NON-PRIME-TIME USERS FROM
;	LOGGING IN DURING PRIME TIME (SPRS 10-14,021 AND 10-14,046)

;317)	ENLARGE PARAMETER BLOCK FOR STRUUO SO POINTER TO AUXACC
;	ENTRY (RDHED) DOESN'T GET OVERWRITTEN.
;		SPRS 10-14,219 AND 10-14,083

;320)	MAKE LOGIN PREFIX EACH STR.TXT TYPEOUT WITH THE NAME OF THE
;	FILE STRUCTURE FROM WHICH IT CAME.  SPR 10-14,031

;321)	REALLY IMPLEMENT /HELP	(SPR 10-14,031)

;322)	CHANGE PREFIX FOR WARNING ERROR MESSAGES FROM ? TO %
;	TO PREVENT BATCH JOBS FROM FLUSHING.
;		SPRS 10-14,145 AND 10-14,172.

;323)	FIX SECURITY BREACH WHERE BOTH NAME AND PSWD ARE REQUIRED AND
;	NEITHER IS ASKED FOR.	SPR 10-14,306.

;324)	PUT IN TEST SO SETUUO IS SKIPPED IF NO BITS WANT TO BE SET.
;		SPR 10-14190.

;325)	FIX ?LGNIPS IF NO SPACE BETWEEN PPN AND SWITCHES.
;		SPR 10-14,031


;326)	MOVE MISPLACED CLOSE CONDITIONAL	(SPR 10-14,244)

;327)	MAKE LOGIN LOOK AT PHYSICAL CORE LIMIT EVEN IN KA MONITORS.
;		SPR 10-14,264.

;330)	ALLOW PPN TO BE ENCLOSED IN SQUARE BRACKETS ON LOGIN.

;331)	REMOVE ALL REFERENCES TO FL.BRK -- OBSOLETE BATCH HACK.
;		SPR 10-14,021.

;332)	IMPLEMENT /NOWATCH	SPR 10-14,145

;333)	FIX EDITS 221 AND 226 SO LOGIN REALLY WON'T PRINT NOTICE.TXT
;	TO AN OPSER SUBJOB.

;334)	MAKE LOGIN SLEEP BETWEEN RETRIES AFTER BAD PASSWORDS ONLY
;	ONLY ON PTY'S.  SPR 10-14,021.

;335)	CLEAR TMPCOR AT BEGINNING OF FLOW RATHER THAN END
;		SO /TMPCOR SWITCH WORKS.

;336)	FIX EDIT 332, WHICH ONLY DID HALF THE JOB.

;337)	FIX EDIT 333, WHICH COMPLETELY MADE NOTICE.TXT GO AWAY, OPSER
;		SUBJOB OR NOT!
;340)	MAKE ISOPSR ONLY LOOK AT IMMEDIATELY CONTROLLING JOB SO
;		NOTICE.TXT WILL GET PRINTED FOR BATCH JOBS.

;341)	ANOTHER FIX TO THE INFAMOUS EDIT 333, WHICH SOMETIMES
;		TURNED THE TTY INTO A LOCAL COPY TERMINAL
;		(SUPER NO-ECHO).

;342)	WHEN SETTING UP TEMP SEARCH LIST TO READ SWITCH.INI, ONLY LOOK
;		AT STRS WHOSE NAMES BEGIN WITH DSK (DSKA, DSKB, ETC.).

;343)	EXIT ON ^Z.

;344)	IMPLEMENT SWITCHES TO SET TERMINAL CHARACTERISTICS.

;345)	FIX TO EDIT 344 WHERE JOBS WHICH DIDN'T NEED PASSWORDS
;		DIDN'T GET TTY CHARACTERISTICS SET.

;346)	WHEN SETTING UP TO READ SWITCH.INI, ENABLE SYS (IN CASE
;		OF SYSTEMS WITH FUNNY-NAMED FILE STRUCTURES).

;347)	PRINT NOTICE.TXT AND /NOTE:FILE EVEN IF CAN'T LOG IN
;		(SYS NOT AVAILABLE, BATCH ONLY, ETC.)


;350)	MAKE LOGIN GET NAME IF REQUIRED ON ATTACH
;		(SPR 10-14,593)

;351)	MISCELLANEOUS CODE CLEANUP AND SPEEDUP.

;352)	ADD CODE TO SET ENQ/DEQ QUOTAS.

;353)	MAKE SURE RP.LOG GETS SET WHEN RECOMPUTING DISK USAGE.

;354)	ADD "SYSTEM IS UNATTENDED" MESSAGE

;355)	MAKE /NAME LOGIC WORK RIGHT.

;356)	ADD CHECK FOR ACCT.SYS FORMAT VERSION 4 AND DON'T
;		SET ENQ/DEQ QUOTAS IF NOT VERSION 4.

;357)	MISCELLANEOUS CODE CLEANUP ON SUGGESTIONS BY DAL.

;360)	MORE CODE CLEANUP.

;361)	IF DEVPPN ON SYS FAILS, WE USE GARBAGE.  LET'S USE [1,4].

;362)	MAKE /NOTE PRINT OUT BEFORE NOTICE.TXT.

;363)	DO ALL NON-PRIV. SETUUO'S AFTER PRINTING NOTICES.  THIS IS SO
;		THE TRMOP.'S (LIKE SPEED) WON'T SCREW UP PRINTING NOTES.

;364)	DON'T SETUUO THE SPOOL BITS IF SYSTEM DOESN'T HAVE SPOOLING.

;365)	ADD /DEFER AND /NODEFER SWITCHES, AND PREVENT /SPOOL:ALL FROM
;		SETTING BIT FOR DEFERRED SPOOLING.
;366)	FIX BUG INTRODUCED BY EDIT 324 WHERE /DSKFUL:PAUSE NO LONGER
;		WORKS.

;367)	ADD CODE TO SLEEP UNTIL OUTPUT BUFFER EMPTY BEFORE DOING
;		TRMOP.S WHICH MIGHT GARBLE TTY OUTPUT.

;370)	REMOVE ALL REFERENCES TO DATE75 CONDITIONAL

;371)	CODE CLEANUP.

;372)	MAKE LGNUNV INTO A SEPARATE (UNIVERSAL) FILE TO SPEED ASSEMBLY.

;373)	ADD ERROR MESSAGE IN CASE SETUUO FOR DEFER BIT FAILS.

;374)	CHECK ST%GAL (GALAXY) BIT IN 2ND STATES WORD AND DON'T TRY
;	TO SET DEFER BIT IF ZERO.

;375)	IMPROVE ERROR MESSAGE IF TRMOP. FAILS TO TELL FUNCTION CODE.

;376)	IF USER TYPES BAD PATH OR PSWD AND RETRIES, HIS PATH
;	IS SCREWED UP.  FIX: CLEAR PATH BLOCK EACH TIME AROUND.

;377)	DON'T DOUBLE-SPACE /NOTE OR /STR TYPEOUT

;400)	ADD FTINHOUSE CONDITIONAL AND ENCLOSE IN IT THE CODE
;	WHICH WILL ONLY ALLOW FILE STRUCTURES WHOSE NAMES BEGIN WITH
;	'DSK' TO GO INTO YOUR SEARCH LIST WHEN READING SWITCH.INI.
;	THIS CODE FIXES THE BUG IN WHICH SWITCH.INI WAS NOT READ
;	IF 7 OR 8 PRIVATE PACKS PRECEDE THE PUBLIC PACKS IN THE
;	RETURNS FROM SYSSTR.  SINCE THIS IS ONLY A PROBLEM IN
;	SYSTEMS WITH 9 OR MORE FILE STRUCTURES, THE CODE WILL BE
;	CONDITIONED OUT IN FIELD-IMAGE.

;401)	PREVENT /MESSAGE:ALL FROM TURNING ON RANDOM WATCH BITS

;402)	RANDOM CODE CLEANUP -- ALSO REMOVE CODE FOR ENQ/DEQ SO IT
;	CAN BE PUT INTO V57 ALONG WITH SCHED. STUFF IN
;	ONE FELL SWOOP

;403)	IMPROVE LOGIC FOR READING AUXACC.SYS

;404)	(SIGH) FIX EDIT 333 AGAIN.  

;405)	REMOVE EDIT 372.

;406)	SLEEP ON DATASETS AS WELL AS PTY'S FOR RETRIES.

;****	RELEASE VERSION 56 -- -- START VERSION 57  ****
;	  NEXT EDIT NUMBER WILL BE 420 TO LEAVE ROOM FOR
;	  MAINTENANCE EDITS.

;420)	CHECK LINE NUMBER JUST BEFORE ATTACH UUO SO JOB WHICH
;	BECOMES DETACHED DURING ATTACH COMMAND CAN'T STEAL TTY0
;					[SPR 15329]
;421)	FIX TEST FOR DETACHED LINE.  [SPR 15330]

;422)	FIX BUG IN RECOMPUTING LOGIC.  [SPR 15396]

;423)	ADD /RTCOMPATABILITY SWITCH.

;424)	MAKE LOGIN USE ALL OF HIGH SEG FOR ACCT.SYS (LOGIN
;	USED TO ALWAYS EXPAND CORE EVEN IF NOT NECESSARY)

;425)	ADD CODE TO READ SCDMAP.SYS AND SET SCHEDULER CLASSES.

;426)	FIX ENQ/DEQ QUOTA ROUTINE.

;427)	CHECK FOR END OF STR LIST IN SYSTEMS WITHOUT FENCE AT USRST1.

;430)	MAKE A -1 ENQ QUOTA ENTRY MEAN DON'T SET THE QUOTA SO ON THE
;	FIRST ENQ UUO MONITOR WILL SUPPLY SYSTEM-WIDE DEFAULT QUOTA

;431)	JUMP AROUND ABOUT 30 INSTRUCTIONS IF NON-6.02 MONITOR
;	WHICH ONLY APPLY TO 6.02.  AREA AFFECTED: PRVSET, PRSET3.

;432)	DO A CRLF AFTER TYPING "NO OPERATOR COVERAGE."

;433)	FIX POSSIBLE BUG IN SCHED. TABLE BUILDING LOGIC, AND CLEAN
;	UP SOME CODE AND ERROR MESSAGES.

;434)	ALLOW /HELP TO BE TYPED WITHOUT A PPN

;435)	ALLOW CR IN RESPONSE TO # PROMPT WITHOUT NASTY ERROR MESSAGE

;436)	ADD CODE TO CALL TSKCHK MODULE.  THIS IS USED ON OUR IN-HOUSE
;	TIMESHARING SYSTEM TO ASK FOR AND RECORD IN THE FACT FILE
;	A COST CENTER AND TASK FOR ACCOUNTING PURPOSES.  THIS CODE
;	IS UNDER THE FTTASK SWITCH WHICH WILL REMAIN 0 IN FIELD IMAGE.
;	THIS CODE IS FOR INFORMATIONAL PURPOSES ONLY AND IS NOT
;	SUPPORTED.  [NOTE SWITCH REMOVED AS PART OF EDIT 716]

;437)	WHEN LOGIN BELIEVES IN ENQ/DEQ AND SCHED. CLASSES, IT
;	FORGETS ALL ABOUT VM.  FIX - SET NEWACT=-1 IF ACCT.SYS
;	VERSION NUMBER IS 3 OR GREATER (NOT JUST 3).

;440)	WHEN SAYING "OTHER JOBS SAME PPN", TELL HIM WHAT JOBS.

;441)	MAKE START ADDRESS AND PROGRAM NAME WORK RIGHT.

;442)	MOVE CALL TO .OSCAN SO A) USER HAS SEARCH LIST WHEN IT IS
;	CALLED AND B) /NAME SWITCH WORKS CORRECTLY WITHOUT THE
;	NECESSITY OF HACKS LIKE EDIT 355.

;443)	FINISH THE JOB OF EDIT 442 BY REMOVING (AT LAST!) SETTMP
;	AND CLRTMP.
;444)	ADD TWO ROUTINES: LOCK TO WRITE-ENABLE HI SEG AND LOCK
;	OUT CTRL-C AND OTHER JOBS WHO WANT TO MODIFY HI SEG, AND
;	UNLOCK TO DO THE REVERSE.

;445)	DON'T TELL [1,2] JOBS WHICH JOBS ARE ALSO LOGGED IN UNDER
;	[1,2] - THERE'RE USUALLY VERY MANY AND YOU DON'T WANT TO KNOW

;446)	FIX SPURIOUS ERROR MESSAGE IN TINY MONITOR, AND DO SOME
;	RANDOM CODE CLEANUP

;447)	MAKE .LOGIN [PROJ,PROG,SFD,SFD,..]/SWITCH WORK

;450)	ADD /NOTICE:ARG SWITCH TO CONTROL PRINTING OF NOTICE.TXT
;	ARG=ALWAYS TO ALWAYS SEE NOTICE
;	ARG=SOMETIMES TO WORK LIKE PROJ/PPN
;	ARG=NEVER TO NEVER SEE IT

;451)	ALLOW USER TO SPECIFY DIFFERENT DEFAULT PATH THEN LOGGED-IN
;	PPN

;452)	USE SECOND 512 ENTRIES OF SCDMAP.SYS FOR BATCH JOBS.

;453)	MAKE DEFAULT FOR /NOTICE BE SOMETIMES.

;454)	FIX BUG IN SFD LOGIC AND TYPO IN /NOTICE LOGIC.

;455)	MAKE /VERBOSITY WORK RIGHT.

;456)	USE BUFFERED TTY OUTPUT.  THIS WILL SPEED UP LOGIN IN
;	REAL TIME ON HEAVILY-LOADED DUAL-CPU SYSTEMS.

;457)	ADD /PATH SWITCH TO DO THE OBVIOUS THING.  THIS WILL OVERRIDE
;	A PATH TYPED ON THE LOGIN COMMAND LINE - I.E.,
;	.LOG [34,35,FOO]/PATH:[24,25,BAR] WILL LOG THE USER IN
;	TO [34,35] WITH A PATH OF [24,25,BAR].

;460)	WHEN RECOMPUTING DISK USAGE, DO AN OUTPUT TTY AFTER EACH
;	STR SO USER THINKS SYSTEM IS STILL ALIVE

;461)	SPRINKLE A FEW OUTPUT TTY,S THROUGHOUT LOGIN SO STUFF
;	GETS TYPED A LITTLE AT A TIME, RATHER THAN A LONG
;	WAIT AND THEN A GUSH OF TTY OUTPUT.  ALSO, RELEASE TTY
;	BEFORE ATTACH SO 2,5 JOBS DON'T GET LEFT LYING AROUNG
;	IN TO WAIT.

;462)	WHEN ATTACHING TO A JOB WHOSE PPN REQUIRES NAME, ONLY ASK
;	NAME IF THERE IS ONE IN ACCT.SYS TO CHECK IT AGAINST

;463)	FIX POSSIBLE BUG IN SCHED. TABLE LOGIC

;464)	REMEMBER TO RESERVE BATMIN JOBS FOR BATCH - I.E., FOR A T/S JOB,
;	ALLOW LOGIN ONLY IF LOGMAX-BATMIN-LOGNUM+BATNUM>0 [SPR 10-15847]

;465)	ADD OUTPUT TTY, TO TYPE RTN TO KEEP USERS PATIENT.
;466)	SAVE ERROR CODE OVER CALL TO UFDSMB AT LGNCAS. [SPR 10-15873]

;467)	MAKE /PATH IN SWITCH.INI WORK.

;470)	ADD /ASSIGN:PHYS:LOG SWITCH TO DO THE OBVIOUS.

;471)	IN EDIT 467, AT NOZAP-1, THE BLT DIDN'T HAVE A -1 AFTER IT
;	SO IT BLT'ED THE SPOOL BITS.  FIX: ADD A -1.

;472)	SPLIT TRMOP.S INTO TWO CLASSES - THOSE WHICH SHOULD BE DONE
;	BEFORE PRINTING NOTICE.TXT, AND THOSE WHICH SHOULD BE DONE
;	AFTER.  CURRENTLY ONLY SPEED IS SET AFTER PRINTING NOTICES.

;473)	/ASSIGN:DEV (NO LOG. NAME) MAKES SCAN HALT.  FIX: IF EOL IS
;	SEEN WHILE PROCESSING /ASSIGN, SET FLAG (R.EOL) SO NO MORE
;	INPUT WILL BE DONE AND REEAT ONE CHAR SO SCAN WILL SEE EOL.

;474)	FIX POSSIBLE STACK PHASE PROBLEM IN PARSE.

;475)	ADD TIMEOUT TO WAITO ROUTINE IN LGNSET & CLEAN UP SOME CODE

;476)	FIX BAD RETURN FROM ERROR RECOVERY ROUTINE IN LGNDSK (UFDSE3)

;477)	CHECK LOGMAX FOR BATCH JOBS AND ADD A NEW CLASS OF ERROR MESSAGE
;	FOR BATCON: REQUE, ERROR CODE 5, MEANING REQUE THIS JOB AND
;	DON'T SCHEDULE ANYBODY ELSE FOR A LITTLE WHILE

;500)	REMOVED BY EDIT 505.

;501)	WHEN SCANNING THRU ALL JOB NUMBERS, SCAN UP TO HIGHJOB, NOT
;	LOGNUM.

;502)	IN A SEQUENCE OF /ASSIGNS, THE LAST ONE IS NOT DONE.
;	CURE: CHANGE AOJL TO AOJLE.

;503)	WHEN LOGMAX IS EXCEEDED LOGIN TELLS YOU AND THEN CLEVERLY
;	PROCEEDS TO LOG YOU IN.  FIX: TREAT REQUE AS A FATAL ERROR.

;504)	EQACT WAS MISTAKENLY PUT IN THE LOW SEG. PUT IT IN THE HI SEG.

;505)	REMOVE EDIT 500, AND CHECK BATMAX RATHER THAN LOGMAX FOR BATCH
;	JOBS.  LOGMAX IS NOW DEFINED TO MEAN THE GREATEST NUMBER OF
;	INTERACTIVE, USER JOBS LOGGED IN.  ALSO ADD CONDITIONAL ASSEMBLY
;	SWITCH BATMAX WHICH WILL TURN ON THE NEW BATMAX/LOGMAX
;	CODE.  THIS REQUIRES EDIT 1055 IN BATCON.

;506)	MAKE .LOG 3,4[5,6] WORK.

;507)	ADD AN ERROR MESSAGE IF THE ENQC. UUO FAILS.

;510)	CLEAN UP SOME ERROR MESSAGES AND ADD SOME HUMAN ENGINEERING.

;511)	FIX BUG IN /CORE LOGIC; ADD SOME ERROR MESSAGES FOR 'THIS
;	CAN NEVER HAPPEN' TYPE STUFF; DO SOME CODE CLEANUP.
;512)	ADD A CHECK IN TYPE ROUTINE TO POPJ RIGHT OUT IF NAME
;	OF FILE IS 0 (NO NAME, NO WILDCARDS) TO AVOID AN
;	INCREDIBLY BIZARRE BUG IN WILD.

;513)	DON'T TURN ECHO OFF UNTIL ENTIRE COMMAND LINE(S) TYPED,
;	SO CONTINUATION LINES WILL ECHO.

;514)	IF UFD INTERLOCK IS BUSY TOO LONG GET NASTY AND BREAK
;	THE DOOR DOWN.

;515)	MAKE SURE RP.LOG ALWAYS GETS SET [QAR 3638]

;516)	CODE CLEANUP.

;517)	DON'T TYPE 'NO OPERATOR COVERAGE' ON EVERY RETRY.

;520)	DON'T BOTHER CLEARING TMPCOR, CLEAN UP SOME COSMETICS.
;	ALSO LOCK OUT CTRL-C WHILE WE HAVE UFD INTERLOCK.

;521)	FIX HANDLING OF /CORE.
;	THIS WILL BE LAST EDIT IN VERSION 57.  NEXT EDIT NUMBER
;	WILL BE 540 TO LEAVE ROOM FOR MAINTENANCE EDITS.

;540)	CHECK CREATION DATE-TIME OF ACCOUNTING FILES AND REBUILD
;	HIGH SEGMENT DATA BASE IF THEY HAVE CHANGED.

;541)	IF NOT JACCTED, GIVE WARNING MESSAGE.

;542)	FIX /VERB AND /MESSAG.

;543)	MOVE CALL TO RNMAIL TO BEFORE THE LOGIN UUO SO IT HAS
;	JACCT AND CAN RENAME MAIL TO USER'S AREA.

;544)	.REQUEST SCAN, WILD, AND HELPER TO SIMPLIFY ASSEMBLY & LOADING

;545)	FIX ONE MORE BUG IN /CORE.

;546)	DETERMINE WHETHER TTY IS A 2741 EARLIER SO IF WE DO THE
;	NUMBER-SIGN PROMPT WE GO INTO TI WAIT RATHER THAHIBERNATING SO THE KEYBOARD UNLOCKS.

;547)	ALLOW /QUOTA TO FORCE RECOMPUTING EVEN IF OTHER JOBS SAME PPN.

;550)	ADD /SFDPROT:055 SWITCH TO DO THE OBVIOUS.

;551)	REWROTE CODE AT NSPOOL+1 SO /CORE WILL FINALLY WORK CORRECTLY

;552)	REORDERED CODE AROUND ACCT1 THRU ACCT3 AND MOVED
;	CODE FOR TYPING DATE AND TIME TO DAYMES,
;	WHERE IT BELONGS

;553)	FIX BUG IN WAITO ROUTINE.

;554)	ADD /UFDPROT:N SWITCH TO DO THE OBVIOUS.
;555)	DON'T ALLOW ATTACHES AFTER KSYS UNLESS OPR OR SON-OF-OPR

;556)	CLEAN UP THE LISTING

;557)	ADD 2 SECURITY FEATURES.  ASSEMBLY SWITCH NCRYPT CAUSES CODE TO
;	BE GENERATED TO ENCRYPT PASSWORDS BEFORE COMPARING THEM TO THE
;	PASSWORD IN ACCT.SYS (WHICH WAS ENCRYPTED BY REACT ALREADY).
;	THE ENCRYPTION FUNCTION IS A NON-INVERTIBLE FUNCTION SO HACKERS
;	CAN READ ACCT.SYS ALL THEY WANT AND NOT GET INTO SOMEONE'S PPN.
;	ASSEMBLY SWITCH PSWCHG ALLOWS USERS TO CHANGE THEIR OWN PSWDS
;	AT LOGIN TIME BY SPECIFYING THE /PASSWORD SWITCH IN THE LOGIN
;	COMMAND LINE.  THIS CAUSES LOGIN TO PROMPT FOR A NEW PASSWORD
;	AND WRITE IT INTO ACCT.SYS.  NOTE: THE ENCRYPTION FEATURE
;	REQUIRES VERSION 32 OF REACT.

;560)	REMOVE THE SIGNIFICANCE OF SLASH IN PPN (REPLACED BY /NOTICE)

;561)	DO AN EXTENDED LOOKUP OF THE FACT FILES SO WE ALWAYS GET
;	THE FILE'S LENGTH IN WORDS AND DON'T MAKE FACT.SYS SEEM
;	TO BE MESSED UP (HIATUS RECORDS).

;562)	IF WE GET THE SKIP RETURN FROM THE IN UUO THAT READS
;	ACCT.SYS, CHECK THE ERROR CODE RATHER THAN ASSUMING THAT IT
;	IS END-OF-FILE.  IF IT ISN'T, GIVE A MORE ILLUMINATING ERROR
;	MESSAGE THAN "INVALID ENTRY - TRY AGAIN".

;563)	DON'T ENABLE CONTROL-C IF THE USER IS LOCKED INTO RUNNING
;	A PROGRAM BY ACCT.SYS.

;564)	CLEAN UP THE EXIT SEQUENCE.

;565)	RE-INIT STACK EVERY TIME THROUGH LOGIN3.

;566)	TURN RP.LOG OFF IF USER CONTROL-C'S DURING RECOMPUTING
;	SO HE WON'T RECOMPUTE NEEDLESSLY NEXT TIME.

;567)	IF EITHER HALF OF LIB PPN IS ZERO, USE USER'S HALF AS DEFAULT.

;570)	CLEAN UP THE CODE.

;571)	REMOVE FACT FILE CODE FROM LOGIN.  MOVE IT TO A SEPARATE MODULE
;	CALLED FACTOR AND CALL THIS MODULE FROM LOGIN.

;572)	ADD CHECK TO BYPASS BLANK AUXACC.SYS ENTRIES.

;573)	FIX ?LGNSND ERROR IN MONITORS WITH LIMLVL=5.

;574)	SAVE M, N, AND CH OVER STUFBS IF THE MESSAGE IS TYPED
;	SO GARBAGE QUOTAS ARE NOT TYPED.

;575)	MAKE BATCH JOBS WAIT TWICE AS LONG ON UFD INTERLOCKS
;	AS INTERACTIVE JOBS, AND DON'T LET THEM BREAK IT DOWN.

;576)	FIX ?ILL MEM REF WHEN CUSP-TO-RUN DOESN'T EXIST
;577)	ALLOW LOGIN WITH NO AUXACC.SYS IF OPR OR HIS OFFSPRING

;600)	DON'T TYPE ERROR SEVERITY TO ANYTHING BUT A BATCH JOB.

;601)	ADD TWOSEG TO LGNDCL MACRO SO LOGIN COMPILES WITH
;	MACRO V.51

;602)	CHECK JBTLIM TO SEE IF BATCH JOB SO WE DON'T DEPEND
;	ON BATCON BEING CALLED BATCON

;603)	CHECK TIMES-TO-LOG IN FOR BATCH JOBS AND AC.BAT

;604)	FIX PROBLEM WITH 2ND TRY AT LOGGING IN WITH /ASSIGN
;	GIVES ? NULL DEVICE ILLEGAL FROM SCAN

;605)	REWRITE CODE AT NOJBMS THRU TTYDET TO FIX BUG
;	INTRODUCED BY EDITS 602 AND 603

;606)	ALLOW ATTACH AND LOGIN AFTER KSYS FROM LOCAL TTY'S

;607)	FIX PROBLEM IN EDIT 605.

;610)	PASSWORDS IN ACCT.SYS ENTRIES WHICH SPAN DISK BLOCKS CANNOT
;	BE CHANGED.  CURE: REMEMBER ONLY POINTER TO PASSWORD,
;	DON'T WORRY IF WHOLE ENTRY CAN'T BE READ IN ONE DSK READ

;611)	PREVENT STRANGE RACES IN ATTACHES

;612)	MAKE ?MAY NOT LOGIN REMOTE/DATASET/BATCH/BATCH SUBJOB
;	ERRORS FATAL SO BATCON WON'T WASTE TIME
;	TRYING TO LOG THE JOB IN

;613)	CLEAN UP THE LISTING; REMOVE UNREACHABLE CODE AND
;	UNREFERENCED DATA

;614)	EDIT 573 IS MISSING A POPJ. CURE: YES.

;615)	SETNAM TO LOGIN RATHER THAN FLUSH TO EVADE KLUDGE IN STOP1C.

;616)	DON'T CHANGE UFD PROTECTION UNLESS /UFDPROTECT SPECIFIED.

;617)	MORE CHANGES TO CONFORM TO MACRO 52.

;620)	IMPLEMENT /DEFPROT:NNN TO SET DEFAULT FILE PROTECTION.

;621)	DON'T PRINT STRANGE GARBAGE IF USER TYPES .R LOGIN

;622)	DON'T LOG IN A USER WHOSE SCHEDULER CLASS HAS A ZERO
;	CPU QUOTA IF THE CLASS SCHEDULER IS RUNNING.

;623)	ENTRY POINT TO FACTOR IS NOW CALLED .FACTR

;624)	PICK UP WHERE EDIT 610 LEFT OFF AND REALLY FIX /PASSWORD.
;625)	SLEEP BEFORE TYPING ?LGNIET TO MAKE IT HARDER TO BREAK
;	SECURITY (EASIER THAN SLEEPING BEFORE ASKING FOR PASSWORD
;	AND TRAPPING FOR CONTROL-C'S WHILE SLEEPING)

;626)	IF WE DON'T HAVE JACCT, WE'RE BEING DEBUGGED - SO DON'T
;	RECOMPUTE DISK USAGE

;627)	/ASSIGN:PHYS-NAME WITH NO LOGICAL NAME LOSES.  FIX IT.

;630)	MAKE "NO OPR COVERAGE" INFORMATIONAL RATHER THAN WARNING.

;631)	LAST-MINUTE CODE CLEANUP.  THIS WILL BE THE LAST EDIT
;	IN VERSION 60.

;632)	DON'T TRY TO SET SCHEDULER CLASS QUOTAS IF 6.03 SCHEDULER
;	RUNNING IN WMU MODE

;633)	LOCATE USER AT CENTRAL SITE IF LOGGING IN ON A NODE WITHOUT
;	AN LPT
;634)	SEE EDIT HISTORY FOR 672 EDIT

;%60A(634)	SHIPPED WITH 6.03A

;635-637) RESERVED FOR DEC 6.03 SUPPORT

;640)	DO PHYSICAL-ONLY RUN UUO FOR CUSP-TO-RUN (SECURITY)

;641)	DISABLE CONTROL-C JUST BEFORE LOGIN UUO AND ENABLE ONLY IF
;	NO CUSP-TO-RUN SPECIFIED

;642)	IF A LINE OF SWITCH.INI ENDS WITH A /ASSIGN, AND THE NEXT LINE
;	CONTAINS A /ASSIGN, YOU GET ?SCNILC ILLEGAL CHAR IN CMD
;	FIX: CLEAR R.EOL EACH TIME THROUGH ASSIGN

;643)	ENQ QUOTA DOESN'T GET SET UP; SENSE OF TEST INSTRUCTION IS BACKWARDS
;	AT PRSET3+5

;644)	FIX YET ANOTHER CASE OF OFF-BY-ONE ARITHMETIC AT UFDEX1-2

;645)	DELETE SEARCH LIST IF USER TYPES ^C WHILE LOGGED OUT

;646)	?LGNCWR UNDESERVEDLY - WRONG GETTAB VALUE BEING USED

;647)	FIX SWITCH.INI NOT BEING READ IF FACTSW TURNED OFF

;650)	RESERVE BATMIN JOB SLOTS FOR BATCON'S USE

;651)	FIX BUG IN /PASSWORD (BUG ONLY IF NCRYPT TURNED ON)

;652)	DON'T ATTEMPT TO CREATE SFD'S ON STRS THAT ARE WRITE-LOCKED

;653)	REMOVE EDIT 547 WHICH ALLOWS USERS TO AVOID QUOTAS

;654)	FIX EDIT 650 SO ATTACH WORKS DESPITE BATMIN.  SPR#10-23336

;655)	SUPPORT "<" AS PPN DELIMITER ON ATTACH.  THIS IS FOR 2741.
;	SPR #10-23335

;656)	TEACH LOGIN ABOUT FIXED VS. UNFIXED CLASS QUOTAS.  SPR#10-23094.

;657)	DON'T PERMIT DATA-SET LOGINS AFTER KSYS.

;660)	PERMIT DETACHED [1,2] JOB TO LOGIN PTY SUBJOBS. SPR #10-23725.
;	NOTE: ONLY PERMITS SON OF [1,2] NOT SON OF DETACHED OPR OR CTY.

;661)	MOVE LOGIN UUO AFTER MESSAGE TYPE-OUT TO PERMIT PROPER /STR
;	OPERATION.  SPR #10-23847

;662)	EDIT 661 WAS NOT VERY GOOD.  REMOVE IT AND TRY AGAIN.

;663)	FIX UP ALL DATES AND COPYRIGHT STATEMENTS

;664)	DON'T PERMIT MORE THAN LOGMAX JOBS IF BATMAX TESTING
;	IS DISABLED.  SPR #10-24354.

;665)	LOGMAX+1 JOBS CAN LOGIN; SHOULD BE LOGMAX.  SPR #10-24354

;666)	IMPLEMENT ACCOUNT AND REMARK PROMPTS TO ENTER AN ACCOUNT STRING
;	AND A REMARK

;667)	DO UFD ZERO COMPRESSION WHEN RECOMPUTING QUOTA.
;	THIS USES THE DISK. UUO FUNCTION CODE 7 WHICH IS NEW FOR
;	7.01.  THE EFFECT OF UFD COMPRESSION IS TO SPEED UP
;	LOOKUPS AND ENTERS.

;670)	FIX BAD POPJ ON ERROR RETURN FROM CTLJOB UUO. SPR #10-24481

;671)	FIX SOME PROBLEMS INTRODUCED BY EDIT 666.

;672)	ADD BACKROUND BATCH SUPPORT.

;673)	IMPLEMENT ACCOUNT VALIDATION

;674)	PUT IN TEMPORARY FIX SO BATCH JOBS CAN RUN WITH ACCOUNT VALIDATION

;675)	IMPLEMENT /TYPE SWITCH TO SET TERMINAL TYPE.

;676)	SPR # 10-25342  WCL  JUNE-27-78
;	Fix code that checks for necessary job slots for Batch so it checks
;	how many Batch jobs are already logged in
;	Areas affected: PPNGO
;677)	FIX BUG IN 675.  AT NOTTYP INSERT  POP	T,T1.
;700)	FIX BUG WHERE CODE AT BACHEK NEVER GETS EXECUTED.
;701)	IMPLEMENT USAGE ACCOUNTING, SPECIFICALLY ACCOUNT VALIDATION (LGNUSG MODULE)
;702)	FIX A VALIDATION ERROR. ALSO MAKE THE LOGIN MESSAGE REPORT THE TIME
;	AS HH:MM INSTEAD OF HHMM.
;703)	FIX BUGS INTRODUCED WITH 702
;704)	DON'T LOSE OWNER PPN FOR NESTED PTY SUBJOBS. SPR #10-27223
;705)	MAKE  /PATH[,,SFD] USE LOGGED-IN PPN AS DEFAULT. SPR #10-27073
;706)	/BAH
;	1)  ADD ATTACH, LOGIN, AND SESSION IPCF MESSAGES SO THE ACCOUNT
;	DAEMON CAN DO USAGE ACCOUNTING WITH SESSION ENTRIES. 
;	2)  ADD /BATSEQ, /BATNAM, AND /REQID SWITCHES SO BATCON CAN PASS
;	BATCH JOB INFORMATION TO THE ACCOUNT DAEMON VIA LOGIN IPCF MESSAGES
;707)	/BAH ADD SETUUO FUNCTION TO SET OPERATOR PRIVILEGES FOR GALAXY 4 SUPPORT
;	3)  FIX UP EDIT 701'S ERROR MESSAGES
;710	REPEAT LOGMAX CHECK JUST PRIOR TO LOGIN UUO
;	SPR 10-27195
;711	CHECK THAT STR NAME IN AUXACC IS "FULL FILE STRUCTURE NAME"
;	SPR 10-27402
;712	/MSL/BAH 22-MAY-79 Display SEARCH, .REQUEST info during compilation
;713)	/MSL/BAH 22-MAY-79 Limit /DSKPRI value by ACCT.SYS
;714)	/MSL/BAH 22-MAY-79 Warn user if account expires within one month
;715)	/MSL/BAH 22-MAY-79 Let user logging in attach if PPN already has detached job
;716)	/MSL/BAH 22-MAY-79 Set up search list before calling OSCAN (for SWITCH.INI), thus
;	allowing account switches, UFD defaults, etc. in SWITCH.INI
;	This rewrite completely changes the order of things (such as 
;	where account validation and accounting is done).  As a result,
;	the FTTASK switch (an unsupported switch used by our in-house
;	systems) no longer applied as written and has been removed.
;717)	/MSL/BAH 22-MAY-79 No NOTICE.TXT if Job Capacity Exceeded
;720)	/MSL/BAH 22-MAY-79 Clear search list before LOGOUT when flushing (c.f. ed.645)
;721)	/MSL/BAH 22-MAY-79 Fix so last error try also gets a FACT entry
;722)	/MSL/BAH 22-MAY-79 Make ENCODE global (SPR 10-23055)
;723)	/MSL/BAH 22-MAY-79 Clear FL.ACC when done with ACCT instead of waiting for AUXACC
;724)	/MSL/BAH 22-MAY-79 Fill AUXACC pointer table, even if early EOF
;725)	/BAH 31-MAY-79 IF A JOB REQUIRES AN ACCOUNT AND/OR REMARK AND THE
;	TERMINAL IS A PTY AND AN ACCOUNT/REMARK WAS NOT SUPPLIED, USE THE
;	CONTROLLING JOB'S ACCOUNT (IF IT EXISTS) AND ALLOW A NULL REMARK.
;726	IF A USER HAS ZERO LOGGED-IN QUOTA ON A STR IN HIS SEARCH LIST
;	DON'T TRY TO CREATE AN SFD ON IT.
;727	COMMAND LIST IS ONE TOO LONG.  ALSO FIX A PJRST P,.USAGE
;730	SEARCH OF AUXACC.SYS FOR PPN IS OFF BY 1.
;	SPR 10-28333.
;731	REMOVE EDIT 730
;732	20-SEP-79/BAH CORE UUO TO EXPAND HIGH SEGMENT CAN FAIL IF 1) SOMEONE
;	IS SAVING LOGIN OR IF 2) IN AN SMP ENVIRONMENT, ANOTHER CPU IS
;	EXECUTING THE SAME CODE WITH THE HIGH SEGMENT WRITE-ENABLED.
;	TO GIVE THE MONITOR TIME TO CATCH UP, SLEEP A SECOND AND TRY AGAIN
;	(3 TIMES) IF THE CORE UUO FAILS.
;733	4-OCT-79/BAH  ADD ATTACH:ARG SWITCH.  IF ATTACH:IGNORE IS IN SWITCH.INI OR TYPED,
;	THEN DON'T PROMPT USER FOR ATTACH MESSAGE IF ANY DETACHED
;	JOBS UNDER HIS PPN.  IF ATTACH:ASK IS IN SWITCH.INI OR TYPED, THEN
;	ASK USER IF HE WANTS TO ATTACH OR LOGIN.  THE DEFAULT IS
;	ALWAYS ASK IF ANY DETACHED JOBS.  SEE EDIT 715.
;734	22-OCT-79/BAH SET U.ACTS AND U.RMRK TO -1 FOR SCAN.  ALSO ZERO  THEM
;	BEFORE FILLING IN THE CHARACTERS SO THE USAGE FILES GET THEM RIGHT.
;735	7-NOV-79/BAH  MAKE LOGIN SEARCH ACTSYM.UNV INSTEAD OF ACCSYM.UNV.
;736	25-JAN-80/BAH  EDIT 723 CLEARED FL.ACC TOO SOON CAUSING PASSWORDS
;	NOT TO BE CHANGED.  ALSO EDIT 716 DELETED THE CALL TO .USAGE THAT
;	SENT A LOGIN MESSAGE TO THE ACCOUNT DAEMON.  ALSO CHANGE THE CALL TO
;	.SIXSW FOR THE /BATNAM SWITCH TO .SIXQW.
;737	14-FEB-80/BAH IF A USER TRIES TO LOGIN WITH AN ILLEGAL PROGRAMMER
;	NUMBER, THEN LOGIN GOES INTO A LOOP READING ACCT.SYS AND REBUILDING
;	ITS TABLE.
;740	SPR 10-28750 Edit 627 caused SCAN to read the slash after a name
;	twice in an /ASSIGN switch if there were more switches.
;741	11-Apr-80/BAH QAR 10-03985 Don't type out error message setting
;	operator privileges if the monitor version number is earlier than
;	7.00.
;742	24-Apr-80/BAH LOGIN doesn't send the terminal designator in its
;	LOGIN and ATTACH IPCF messages to the account daemon.  Include
;	a common routine to find the terminal designator, line number and
;	node name of the job -- SETTNL.  Also include a switch to defer
;	TTY output /TTDEFER.
;743	29-april-80/FRS SPR 10-28831
;	Change put in FACTOR to check to see if job being attached to
;	is DAEMON and [1,2].  If so, skip trying to write FACT entry.
;744	5-May-80/WSM Allow new form for specifing settty switches for LOGIN.
;	ie /TERMINAL:(NOPAGE,SPEED:300,WIDTH:80,TYPE:VT52) instead of a
;	random set of several switches. Also, cleanup some SCAN switch
;	handling. Use standard version macro from MACTEN.
;	Fix recovery from %LGNTTI Terminal type invalid errors
;745	6-May-80/WSM Improve command scanning especially for SESSION
;746	6-MAY-80/WSM Fix the bug that didnt set path to area that
;	already existed if user had no login quota or software write-locked
;	Also, type warning if any PATH. uuo fails.
;747	1-Jun-80/WSM Complete implementation of /TERMINAL by adding 
;	keywords [no]UC, NOFILL and [no]TIDY. Also, dont prompt with 
;	password if the user types it on the same line.
;750	2-Jun-80/WSM Include debugged DDT patch for testing LOGIN under 7.01 
;	(QAR 10-04145) Add /DEFBUFFER:n switch to set default number
;	of disk buffers, like .SET DEFAULT BUFFER n command
;751	3-Jun-80/WSM (QARs 10-42046, 10-04172) LOGIN loops if invalid PPN given.
;	Edit 737 didnt fix the problem as reported.
;
;;61(751) released with 7.01
;Start V62 for Galaxy 4.1
;
;752	17-Jun-80/WSM Fix the usage accounting entries for ATTACH and
;	SESSION commands.  Remove unreachable code.
;753	27-Jun-80/DPM
;	Add /BATINT:[NO/YES] and /BATSTR:ooo so BATCON can set the Batch
;	operator intervention values and Batch stream numbers. This is
;	required for Galaxy 4.1 and later versions of QUASAR and ORION.
;	These switches apply only to Batch jobs and are ignored for
;	timesharing jobs. Also before we open the TTY, determine if the job
;	is a Batch job and don't turn off echoing. Note: SCNSER must also
;	check this at TTYRS1 plus a few and not turn off echoing when an
;	unlogged in job starts running LOGIN.
;754	8-Jul-80/WSM Add some fixes for accounting support
;	  1) Include expiration date in UFD (.RBDED)
;	  2) Dont type NOTICE.TXT on errors with SESSION command
;	  3) Expand ATTACH message to include target job number
;	  4) Dont allow retries on SESSION command
;	  5) Dont do checks to see if user can LOGIN if SESSION command
;	  6) Flush receive queue correctly when waiting for ACK
;	  Improve date/time printing (use SCANs routines)
;	  Add lost instruction @RICC to fix ^C problems
;755	SPR #10-29629	RKB	14-Jul-80
;	(published 15-Jul as edit 752) Fix a bug in edit 651 so /PASSWORD
;	will work properly with NCRYPT set.
;756	Be consistant in handling account string and remark. If its
;	-1 (for SCAN and ACTDAE's benifit) it hasnt been specified.
;	Anything else should be treated as ASCIZ text
;757	SPR #10-29879		12 AUG 80
;	Creating SFDs on all structures is annoying, so lets let the
;	user say whether he wants it to happen or not. Install the
;	/[NO]SFDCREATE switch, which allows him to say 'DONT CREATE'
;760	If you logged in and recomputed disk usage at or before 4 minutes
;	22.192 seconds after midnight, LOGIN would die with ?Illegal
;	address in UUO trying to compress the UFD.
;	Also, change REPEAT 0 to IFN FTMAIL for RNMAIL routine.
;761	23-Sep-80/WSM Convert to more UUOSYM and ACTSYM symbols
;	Allow /LOCATE to take sixbit node name
;	Improve usage accounting routines--Dont let user in if account
; 	 validation is required, and ACTDAE isnt around or talking to us
;762	28-Sep-80/WSM Cleanup error messages and interface with BATCON.
;	In the process, fix ?Job capacity errors from dumping the job.
;	Dont output ^D when you fail to login. Thats old stuff.
;	Define new bit in error macros to WTO to operator. This removes
;	all the "Please call the operator" messages. If ORION isnt running
;	that text is appended to the users output.
;763	30-Sep-80/WSM (QAR 10-04663) Improve ATTACH query logic. Give 
;	a small SYSTAT output (job, program, state), and if/when we
;	attach to a job, preserve the user/monitor state.
;764	Use ND to set number of days for warning on %PPN will expire message
;765	6-Oct-80/WSM (QAR 10-04728) Improve things a little
;	bit if the unsupported PSWCHG feature test is turned on
;	by asking for new password twice with echo off
;766	20-Oct-80/WSM Remove part of edit 761 which allowed LOCATE to take SIXBIT name.
;	It requires more monitor/GALAXY support than was thought.
;	Dont create a UFD of AUXACC says its write-locked.
;	(QAR 10-04816) Change BLANK to BLANKS to be consistent with
;	INITIA and monitor SET TTY commands
;767	24-Nov-80/WSM (QAR 10-04969) LOGIN is too hard to be debugged.
;	Add more tests for R.DBUG
;770	24-Nov-80/WSM LOGIN loses /OPTION when asking for detached jobs.
;	Save /OPTION around second .PSCAN call. Requires kludge that assumes
;	SCANs OPTION storage is .NMUL##-3 (until OPTION made global)

;771	16-Dec-80/WSM Add support for ACTDAE returning an account string
;	from a validation request. (It may be a default, or case changed)
;772	15-Jan-81/WSM (QAR 10-05259) Allow switches on ATTACH to attach to
;	the job in either user or monitor mode.
;773	15-Jan-81/WSM Allow OPR[1,2] to login in w/o an account string if
;	the PID of ACTDAE doesnt exist in 5 seconds.
;	Dont complain if the LOCATE UUO fails and he is trying to locate
;	to the central site (node 0)
;774	30-JAN-81/WSM (QAR 10-05356) Allow SESSION command to be invoked
;	from CCL entry point and look for TMP:LGN. Always send account
;	string to ACTDAE for possible defaulting.
;	(QAR 10-05356) Path not also set correctly if we cant create an
;	SFD in the path. Get around SCAN bug with .LOGIN/ACCOUNT:"" using
;	SWITCH.INI when it shouldnt
;775	17-Feb-81/WSM (QAR 10-05478) Fix up more scanning problems with
;	the /ACCOUNT switch.  Change some UUOSYM symbols that changed.
;	Allow indirect command files for SESSION command.
;776	19-Mar-81/WSM (QAR 10-05786) Fix blanks in TERMINAL scanning
;	(QAR 10-05797) Dont type expiration date on ATTACH
;777	7-Apr-81/WSM (QAR 10-05931) Fix a one instruction race
;	(QAR 10-05925) Remove checks for level C disk service!
;	(QAR 10-05942) Check response from ATTACH question for YES/NO
;	(no QAR) Remove checks for old scanner service
;1000	9-Apr-81/WSM Move setting batch stream number before STRUUOs
;	to change search list so we dont confuse QUASAR.
;
;1001	9-Jul-81/WSM Increase MAXFS to 7.01 defined value of 10; handle
;	more AUXACC entries than can fix in a S/L more gracefully.
;1002	16-Nov-81/WSM Bypass accounting if we are attaching to the
;	ACTDAE job so we dont get hung if ACTDAE is ^Ced.
;	Improve ATTACH job query logic to show default and preserve
;	/OPTION around .PSCAN better.
;1003	23-Nov-81/WSM Insert fix for ^C, and removed window where user
;	can ^C out of cusp-to-run. This was incorrectly published as
;	edit 754 to LOGIN as CMCO 571.1.
;1004	9-Mar-82/WSM (QAR 10-06880) Explicitly BLT scan block words to
;	zero in routine PARSE.
;	(QAR 10-06495) /SCAN not set /NOSFDCREATE and the SFD doesnt exist.
;1005	27-Aug-82/DPM (QAR #10-02018) Correct logic to GETTAB ACTDAE pid.
;Start of version 63 for 7.02
;
;1100	14-JUL-81/WSM Add support for new terminal switches, and /DEFAULT:(BIGBUF)
;	Allow new batch switch syntax of /BATCH:(args) too.
;1101	30-Jul-81/BCM (SPR 10-30609) Add a new UUO to do LOGMAX/BATMAX
;	quota checking.  This is necessary to eliminate race between two
;	simultaneous LOGINs where LOGNUM could be 1 greater than LOGMAX.
;1102	21-Aug-81/BCM (SPR 10-30832) Correct test for no
;	class scheduler at PRSET4 and NOTHER.
;1103	8-Sep-81/WSM Add (under FTMAIL) /[no]MAILCHECK switch to control
;	scanning for new mail. Check for mail on ATTACH too.
;1104	3-Feb-82/WSM Add new TRMOP. to see if we are on a full-SCNSER-PTY
;	so we know we can turn the echo off.
;1105	26-Apr-82/WSM Rip out lots of code, and call DPM's new UFDSET routine
;	to handle UFD setup. This is the same routines that PULSAR/MDA
;	use, so it should all do it the same way.
;1106	29-Jun-82/WSM Fix up all error messages and macros (This also
;	fixing the ^C ?Ill mem ref bug introduced with edit 1105)
;
;1107	22-Apr-83/DPM
;	1. Turn on echo if called by SCAN for continuation lines.
;	2. Don't make junk FACT file entries on LOGIN failures.
;	3. Allow /QUOTA:(str,...).
;	4. If a name is required, make sure it's non-zero.
;
;1110	26-Apr-83/DPM
;	Eliminate problems with I/O to unassigned channel by doing buffered
;	OUTSTRs to the TTY.  This is a lot more efficient than doing buffered
;	I/O and saves lots of OUTPUT TTY, instructions.
;
;1111	 8-Jul-83/DPM
;	1. Add a few missing calls to TTYOUT.
;	2. Disconnect line if too many command format errors.
;	3. Call .ISLGI to determine logged-in/out status in FLUSH routine.
;	4. Finally after all these years, add verbosity checking in ERRMSG
;	   routine.  Attn. future LOGIN hackers: calls to .PSCAN wipe .FLVRB!
;	5. Fix up listing stuff in .ERR. macro.
;
;1112	31-Aug-83/DPM
;	Don't set UFD protection to <000> when recomputing disk usage on
;	structures not in AUXACC.
;
;1113	12-Sep-83/DPM
;	1. FATAL, WARN, INFO, etc. still don't list.
;	2. Make references to .POPJ1 external in LGNMS.
;
;1114	21-Sep-83 /DPM
;	1. Remove ZEROSL.  No longer needed now that the LOGOUT UUO does this.
;	2. Remove unreferenced and non-existant symbols from GLOB macros.
;	3. Remove unreferenced low seg locations.
;	4. Repeated ^Cs typed while recomputing disk usage gives ill mem ref.
;	   ERRMSG isn't recursive. Fix Control-C trap.
;
;1115	12-Jan-84 /DPM
;	Add missing AC in test instruction (UFDSET + a bunch).
;
;63(1115) released with 7.02
;This patch will allow you to debug LOGIN under normal timesharing
; The patch is executed via FILDDT and causes your terminal to 
; run LOGIN from HAKSTR/HAKPPN while all other terminals use SYSPPN. 

;This patch has been tested under the 7.01 monitor


	REPEAT 0,<

PATCH/	HAKPPN:	10,,3146
PATCH+1/	0	HAKSTR:	$"/DSKQ/
PATCH+2/	0	LOGHAK:	PUSHJ P,.+2
LOGHAK+1/	0	JRST MSTART
LOGHAK+2/	0	LGHAK1:	PUSHJ P,SAVE1
LGHAK1+1/	0	MOVEI P1,(U)
LGHAK1+2/	0	LOGLDB:	CAIE P1,-1
LOGLDB+1/	0	POPJ P,
LOGLDB+2/	0	MOVE P1,SGANAM+.JDAT
LOGLDB+3/	0	CAME P1,LOGTXT
LOGLDB+4/	0	POPJ P,
LOGLDB+5/	0	MOVE P1,JBTSTS(J)
LOGLDB+6/	0	TLNE P1,JLOG
LOGLDB+7/	0	POPJ P,
LOGLDB+10/	0	MOVE P1,HAKSTR
LOGLDB+11/	0	MOVEM P1,SGADEV+.JDAT
LOGLDB+12/	0	MOVE P1,HAKPPN
LOGLDB+13/	0	MOVEM P1,SGAPPN+.JDAT
LOGLDB+14/	0	POPJ P,

COMCON$:
SGST1B-FTMP/	JRST MSTART	JRST LOGHAK
GJOB2 5/	SETZM 0(P)	JFCL
CLOGIN 1/	JRST LOGDET	JRST RUNAME

.CPJOB[	70	$Q<JOBNOX:
TTYTAB JOBNOX[	150022
$Q DDBLDB[	711622	$Q<LDB:
LOGLDB/	CAIE P1,-1	CAIE P1,LDB

>>>;END REPEAT 0
	SUBTTL	Parameters -- AC assignments

F=0	;FLAGS

T1=1	;TEMP AC'S
T2=2
T3=3
T4=4

P1=5	;PRESERVED
P2=6	; ..
P3=7	; ..
N=7	;NUMBERS INPUT
C=10	;CHARACTERS (THIS AC IS READ-ONLY, EDIT 102)
PP=12	;PROJECT PROGRAMMER PAIR
M=13	;MESSAGE ADDRESSES
CH=14	;CHARACTER FOR TYPE-OUT OR ANALYSIS
WD=16	;WORDS
P=17	;PUSHDOWN POINTER

	SUBTTL	Parameters -- IO channels

;0	;USED BY SCAN & WILD
;TTY==1	;TELETYPE
UFD==2	;FOR DISK IO
USR==3	;FOR CHECKING USER FILES
US1==4	;THESE TWO USED BY UFDSET
FCT==6	;FOR THE FACT FILE
	SUBTTL	Parameters -- Flags in F

SHFWAT==^D12	;BITS TO SHIFT WATCH BITS TO POSITION FOR SET UUO

;LEFT HALF

L.PEND==1	;STUFF IN TTY OUTPUT BUFFER
L.MANY==2	;ON IF MORE THAN ONE CONTROLLING JOB IN CHAIN
FL.WKD==4	;ON IF THIS IS A WEEKDAY
FL.FDX==10	;ON IF THIS IS A FULL-DUPLEX LINE
FL.RAS==20	;READ ACCOUNT FILE SYNC (I.E., TO RD 1ST WD)
FL.DET==40	;DETACHED (DISCONNECTED)
FL.ACC==200	;SET IF READING ACCT.SYS, NOT IF AUXACC.SYS
FL.BSJ==1000	;SET IF BATCH JOB SUBJOB
FL.ERR==2000	;SET TO WATCH FOR ERRORS IN UFD SCAN
FL.BAT==4000	;SET IF THIS JOB IS A BATCH JOB
FL.GPN==10000	;GENERATE A PROGRAMMER NUMBER
L.OPR==20000	;SET IF MY TTY IS OPR OR CTY
L.SOPR==40000	;SET IF I AM ON PTY UNDER OPR, CTY OR A 1,2 JOB
FL.ATT==100000	;SET IF ATTACH COMMAND
FL.WLD==200000	;WILD CARD PROGRAMER

;RH OF F

R.ACRE==1	;SET IF ANY CREATES ALLOWED ON ANY STR'S
R.ASTR==2	;SET IF ANY STR'S IN THIS JOB'S SEARCH LIST
R.PTYJ==10	;PTY JOB
R.COMA==20	;[440] COMMA HAS BEEN TYPED WHEN TELLING OTHER JOBS
R.2MNY==40	;[470] TOO MANY DEVICES MESSAGE HAS BEEN TYPED
R.EOL==100	;[473] END OF LINE SEEN WHILE DOING /ASSIGN
R.UIB==200	;[514] UFD INTERLOCK WAS BUSY TOO LONG & WE'RE
		;[514] GETTING IMPATIENT
R.UIBM==400	;[514] WE HAVE ALREADY TYPED A WAIT PLS MSG FOR THIS STR
R.DBUG==1000	;[626] WE'RE BEING DEBUGGED
R.NXSW==2000	;[627] NEXT SWITCH SEEN (DURING /ASSIGN PROCESSING)
R.SESS==4000	;SESSION COMMAND
R.RCOM==10000	;SET IF WE HAVE RECOMPUTED ALREADY
R.RDU==20000	;SET IF [RECOMPUTING DISK USAGE] ALREADY CAME OUT

;SPECIAL PPN CHARACTERS

UNISYM=="#"	;CHARACTER FOR CREATE UNIQUE PPN
UNIPRG==777776	;INTERNAL VALUE FOR UNIQUE PPN
	SUBTTL	Parameters -- Block lengths and versions

TRANSZ==10	;MAX SIZE OF FACT.SYS ENTRY
MAXENT==20	;MAX SIZE OF ENTRY IN ACCT.SYS

ACC506==2	;VERSION NUMBER OF OLD ACCT.SYS
ACC601==3	;VERSION NUMBER OF NEW ACCT.SYS
ACC602==4	;[356] VERSION NUMBER OF ACCT.SYS FOR 6.02
AC1FOR==0	;FORMAT VERSION NUMBER FOR AUXACC.SYS

FBMTRY==^D10	;TIMES TO RETRY TO ENTER OR RENAME UFD
IFNDEF	RP.NQC,<	
RP.NQC=2000	;DO NOT INCLUDE FILES WITH THIS BIT SET IN
		; .RBSTS IN LOGGED OUT QUOTA CHECK
>
SCDSIZ==^D1024/4 ;[425] SIZE OF SCHEDULER CLASS TABLE

MAXFS==^D10		;MAXIMUM NUMBER OF FILE STRUCTURES PER USER

AC1BLK==5		;NUMBER OF WORDS PER BLOCK IN AUXACC.SYS ENTRIES

EXLLEN==.RBDED+1	;[754]LENGTH OF ARGUMENT LIST FOR EXTENDED LOOKUP/ENTER/RENAME
	SUBTTL	Message macros

;ERROR CODES FOR TYPES OF LOGIN ERRORS (FOR PTY JOBS)
;**** NOTE ERROR COMMENTS SHOULD ALL BEGIN WITH A QUESTION MARK
;**** AND FOR PTY JOBS INCLUDE AN ERROR TYPE OF THE FORM
;**** (#) WHERE # IS ONE OF THE FOLLOWING:

;ERR.NF==1	;NON FATAL (Not used by BATCON or LOGIN)
;ERR.SF==2	;SEMI FATAL (Not used by BATCON or LOGIN)
 ERR.FT==3	;FATAL - CANCEL JOB
 ERR.SS==4	;STOP SCHEDULING (Shutdown batch stream but requeue job)
 ERR.RQ==5	;REQUE JOB (Requeue job)

IF1,<

;FLAGS IN LEFT HALF OF EF
EF.SYS==1B1	;SYSTEM ERROR
EF.ERR==1B2	;FATAL ERROR
EF.WRN==1B3	;WARNING
EF.INF==1B4	;INFORMATION LINE (IN [])
EF.REQ==1B5	;REQUE JOB
EF.WTO==1B6	;WTO ERROR TO OPERATOR (ANY ERROR MESSAGE TYPE)
EF.SIL==1B7	;SUPPRESS NOTICE.TXT TYPEOUT ON FATAL ERRORS
EF.FMT==1B8	;FORMAT ERROR (USER GETS TO RETRY)

;SUPER FATAL ERROR -- NEVER RETURNS
;THE BATCH STREAM IS SHUTDOWN, AND THE JOB IS REQUEUED
	DEFINE	STOP(PFX,TXT,FLG,MOR),<
	.ERR.	EF.SYS,PFX,<TXT>,FLG,MOR
>

;FATAL ERROR (HOWEVER, SYSTEM IS STILL OK)
	DEFINE	FATAL(PFX,TXT,FLG,MOR),<
	.ERR.	EF.ERR,PFX,<TXT>,FLG,MOR
>

;WARNING MESSGAE
;CALL WITH:
;	WARN	PREFIX,<TEXT>
	DEFINE	WARN(PFX,TXT,FLG,MOR),<
	.ERR.	EF.WRN,PFX,<TXT>,FLG,MOR
>

;SEMI-FATAL ERROR--BATCON SHOULD REQUE JOB AND STOP SCHEDULING
;FOR A LITTLE WHILE
;CALL WITH:
;		REQUE	PREFIX,<TEXT>
;		  NEVER RETURN
	DEFINE	REQUE(PFX,TXT,FLG,MOR),<
	.ERR.	EF.REQ,PFX,<TXT>,FLG,MOR
>

;INFORMATION MESSAGE (PRINTED IN [])
;CALL WITH:
;	INFO	PREFIX,<TEXT>
	DEFINE	INFO(PFX,TXT,FLG,MOR),<
	.ERR.	EF.INF,PFX,<TXT>,FLG,MOR
>

	DEFINE	.ERR.	(TYP,PFX,TXT,FLG,MOR),<
LGN'PFX:PUSHJ	P,[XLIST
		   PUSHJ P,ERRMSG	;CALL ERROR MESSAGE
		   IFB  <MOR>,<XWD 0,''PFX''>
		   IFNB <MOR>,<XWD MOR,''PFX''>
		   IFB  <FLG>,<TYP![ASCIZ\TXT\]>
		   IFNB <FLG>,<TYP!FLG![ASCIZ\TXT\]>
		   LIST]
	>

> ;END IF1
	SUBTTL	Inter-module globals

IF1,<
	DEFINE	GLOBS,<
GLOB <ACCT,AD.YN,ALAST,CLRRIB,DATEPR,ATTIGN>
GLOB <W.ACCT,W.AUX,W.SCED>		;[540]
GLOB <LGNWFV,BADNAM>
GLOB <DAYMES,DSKFER,DSKFPA,ENTPTH>
GLOB <ERRMSG,ETOLO,FLUSH,FRUN,GET2WD,GETCOD>
GLOB <GETACT,.USAGE,ACTVLD>
GLOB <GETNAM,ISBATC,LAST>
GLOB <LOKBLK,LOKBLN,LOGBLN,LOGBLK,NOATT>
GLOB <NOSYS,NEWLIN,DIEMSG>
GLOB <PPERR1,PRVSET,PSWOK,RDACCT,RDUFD,GLXSET>
	IFN	PSWCHG,<
GLOB <WTUFD>
	>;END	PSWCHG
GLOB <SNOOZE,SPLBTS,STYO,TOLO>
GLOB <TOLO1,TRANSZ,TRYAGN,TTYGET,TTYGO,TYI,TYO>
GLOB <USRSET,POSTMS,WATBTS,WTCHDA>	;[472]
GLOB <ACCTA,CODGET,FLUSHX,LOGIN3,CRLFPD>	;[517]
GLOB <SCDTBL,SCDBLT,BLDSCD,LOK,UNLOCK>		;[425] SCHED STUFF
IFN FASTLG,<GLOB <ENTSIZ,DACCFL,DLOCK,DAUXFL,DACCL,PDACC,NEWACT,EQACT>>

;STUFF IN LGNLOW
GLOB <PDPLST,LGIARG,FCTAHD,FCTHED,FCTFMD,FCTWD,FCTFWD>
	>>

GLOB <RDUFLG,UFDNDL>
	SUBTTL	Global storage definitions

;MACRO TO DEFINE COMMON LOWSEG FOR ALL MODULES
IF1,<
	DEFINE	LOWVAR,<
LBLOCK	ZZBEG,0		;;START OF BLT TO ZERO
LWORD	TTYPTR,		;;BYTE POINTER TO TTY BUFFER
LWORD	TTYCNT,		;;BYTE COUNT
LBLOCK	TTYBUF,TTYBSZ	;;TTY OUTPUT BUFFER
LBLOCK	INTBLK,4	;;CONTROL-C INTERCEPT BLOCK
LWORD	CCWAIT,		;;IF 0 DO CONTROL-C WHEN TYPED.
			;;IF -1 WAIT FOR CRTITICAL CODE TO COMPLETE
LWORD	CCTYPE,		;;-1 IF CONTROL-C TYPED.
LBLOCK	LASTX,0		;;LAST PIECE OF CODE
LWORD	SAVERG,		;;USED TO SAVE A REGSTER BY LGNDSK
LWORD	HELP,		;;POINTER TO HELP STRING
LWORD	HPOS,		;;POSITION ON LINE
LBLOCK	WILDBK,.FXLEN	;;BLOCK USED BY WILD
LBLOCK	JUNK,4		;;[422] PLACE TO THROW AWAY SHORT LOOKUP BLOCK
LWORD	RDUFLG,		;;RECOMPUTING DISK USAGE TYPEOUT FLAG
LBLOCK	UFDBUF,200	;;[571] BUFFER FOR READING UFD'S
LBLOCK	PTHBUF,11	;;
LBLOCK	CHRBUF,.DCSAJ+1	;;BUFFER FOR DSKCHR
LBLOCK	SRCBUF,EXLLEN	;;
LBLOCK	SECBUF,.RBTIM+1	;;[540]
LWORD	UFDFSN,		;;FILE STRUCTURE NAME
LWORD	UFDMTP,		;;
LWORD	UFDDMJ,		;;
LWORD	UFDDMP,		;;
LBLOCK	UFDDMF,MAXFS*3+1;;[371]
LBLOCK	UFDARG,.UFSIZ	;;ARGS TO .UFD IN UFDSET.MAC
LBLOCK	SAVAUX,MAXFS*5+1;;Save AUXACC entries while setting S.L.
LWORD	FCTFNC		;;FACTOR writes in FCTDAT-1 the .FACT function
LBLOCK	FCTDAT,TRANSZ	;;
LBLOCK	RDHED,2		;;
IFN PSWCHG,<		;;[557]
LBLOCK	WTHED,2		;;[557] I/O CMD LIST FOR WRITING ACCT.SYS
LWORD	SAVBLK,		;;[610] BLOCK CONTAINING OUR PSWD
LWORD	SAVPOS,		;;[610] PTR TO WORD WITHIN BLK CONTAINING PSWD
>			;;[557] END IFN PSWCHG
LWORD	FL2741,		;;-1 IF THIS IS A 2741
LBLOCK	PDL,PDLSIZ+1	;;PUSH DOWN LIST
LWORD	MFDPPN,		;;PPN FOR MFD
LWORD	ALPPPN,		;;ALL PRIVS
LWORD	UFDPRT,		;;[557] STANDARD UFD PROTECTION
LBLOCK	ENTRY,MAXENT	;;DATA FROM ACCT.SYS
LWORD	LOGTRY,		;;TRIES AT LOGGING IN
LWORD	TTBITS,		;;TELETYPE DESCRIPTOR
LWORD	STATES,		;;SYSTEM STATES
LWORD	STATS2,		;;[374] SECOND STATES WORD
LWORD	XPDDTM,		;;[754] Universal date/time expiration date
IFE FASTLG,<
LWORD	NEWACT,		;;-1 IF NEW ACCT.SYS, 0 IF OLD
LWORD	ENTSIZ,		;;SIZE OF AN ACCT.SYS ENTRY
> ;END FASTLG

LWORD	NOWBIT,		;;TIME OF DAY AS A BIT
LWORD	ACCTLN,		;;LENGTH OF ACCT.SYS IN BLOCKS
LWORD	ACCKNT,		;;NUMBER OF BLOCKS READ ON ACCT.SYS
LWORD	SAVEDA,		;;SAVED DATE
LWORD	SYSPPN,		;;[1,4]
LWORD	MYTTY,		;;NAME OF MY TTY
LWORD	TTYUDX,		;;UDX OF MY TTY
LWORD	RECFLG,		;;
LWORD	UFDDAT,		;;DATE OF MOST RECENT UFD
LWORD	UFDTIM,		;;AND ITS TIME
LWORD	UFDNDL,		;;0 IF UFD CAN BE RENAMED, -1 IF IT CAN NOT
LWORD	THSJOB,		;;THIS JOB NUMBER
LWORD	DEVPTR,		;;[470] POINTER TO DEVTAB
LWORD	WLDPNT,		;;TEMP FOR WILD LOOKUPS
LBLOCK	IPS.BL,4	;;IPCF SEND BLOCK
LBLOCK	IPR.BL,6	;;IPCF RECEIVE BLOCK
LBLOCK	PAGBLK,2	;;ARGUMENT BLOCK OF A PAGE. UUO
LWORD	ACTPID,		;;ACCOUNT DAEMON PID
LWORD	ACTMES,		;;TYPE OF ACCOUNTING MESSAGE TO BE SENT
LWORD	MONLNO,		;;LINE NUMBER FOR USAGE ACCOUNTING
LWORD	MONNOD,		;;NODE NAME FOR USAGE ACCOUNTING
LWORD	MONTDE,		;;TERMINAL DESIGNATOR FOR USAGE ACCOUNTING
LWORD	ACTACK		;;UNIQUE MESSAGE IDENTIFIER
LBLOCK	QTATAB,STRMAX	;;TABLE OF STRS TO RECOMPUTE
LWORD	LSTSTR,		;;LAST STR FOR /QUOTA
LWORD	STRMSK,		;;STR MASK FOR /QUOTA
;;***START OF BLOCK SET TO 0 ON CALLS TO SCAN

LBLOCK	Z.STRT,0	;;START OF BLT

LBLOCK	NOTSPC,.FXLEN	;;/NOTE SPEC
LBLOCK	LIBSPC,.FXLEN	;;/LIB SPEC
LBLOCK	TYPSPC,.FXLEN	;;TEMP FOR TYPE
LBLOCK	U.PATH,.FXLEN	;;AREA FOR USER'S PATH SPEC
LBLOCK	PTHSPC,.FXLEN	;;[457] /PATH SWITCH AREA
LBLOCK	DEVTAB,DVICES*2	;;[470] TABLE OF DEV PHYS AND LOG NAMES
LWORD	U.SPL,		;;SPOOL REQUEST
LWORD	U.WAT,		;;WATCH REQUEST
LWORD	U.DPRI,		;;DISK PRIORITY

LBLOCK	Z.END,0		;;END OF BLT
;;***START OF BLOCK SET TO -1 ON CALLS TO SCAN

LBLOCK	OOBEG,0		;;START OF BLT FOR SCAN

LWORD	U.ATT		;;ASK OR IGNORE ATTACH MESSAGE IF DETACHED JOB WHEN LOGGING IN
LWORD	U.BINT		;;Batch operator intervention
LWORD	U.BNAM		;;BATCH JOB NAME
LWORD	U.BSEQ		;;BATCH SEQUENCE NUMBER
LWORD	U.BSTR		;;Batch stream number
LWORD	U.BREQ		;;BATCH REQUEST ID
LBLOCK	U.ACTS,10	;;ACCOUNT STRING
LBLOCK	U.RMRK,10	;;REMARK
LWORD	U.TIME,		;;TIME LIMIT REQUEST
LWORD	U.CORE,		;;CORE LIMIT
LBLOCK	U.NAME,2,	;;/NAME
LWORD	U.NEW,		;;NEW BIT
LWORD	U.NOTC,		;;[450] /NOTICE
LWORD	U.NWAT,		;;[336] /NOWATCH
LWORD	U.DFER,		;;[365] DEFERRED SPOOLING BIT
LWORD	U.SYS,		;;SYS BIT
LWORD	U.DFUL,		;;DISK FULL CONDTION
LWORD	U.LIMI,		;;1 IF /NOGUIDELINE, 0 IF /GUIDELINE
LWORD	U.GUID,		;;1 IF /GUIDELINE, 0 IF /NOGUIDELINE
LWORD	U.CPPL,		;;CURRENT PHYSICAL PAGE LIMIT
LWORD	U.CVPL,		;;CURRENT VIRTUAL PAGE LIMIT
LWORD	U.SFDCRE,	;;[757] IF SFD CREATION IS DESIRED
LWORD	U.SFDP,		;;[550] PROTECTION FOR CREATED SFD'S
LWORD	U.UFDP,		;;[554] PROTECTION FOR CREATED UFD'S
LWORD	U.DFPR,		;;[620] DEFAULT FILE PROTECTION
LWORD	U.DFBU,		;;[750] DEFAULT BUFFERS COUNT
LWORD	U.DFBB,		;;DEFAULT BIGBUF
IFN FTMAIL,<
LWORD	U.MAIL,		;;MAILCHECK SWITCH
>;END IFN FTMAIL
LWORD	U.MODE,		;;ATTACH MODE (MONITOR=0, USER=1)
IFN PSWCHG,<		;;[557] IF ALLOWING PASSWORD CHANGING
LWORD	U.NPSW,		;;[557] NEW PASSWORD
> ;;[557] END IFN PSWCHG
LWORD	U.SCAN,		;;SCAN SWITCH FOR PATH UUO
LWORD	U.STR,		;;STRUCTURE SWITCH
LWORD	U.QTA,		;;FOR RECOMPUTING DISK USAGE ON STRS IN JSL
LWORD	U.STA,		;;STATION NUMBER

IFN	SETTTY,<
LWORD	U.ALTM,		;;[344] ALTMODE CONVERSION
LWORD	U.BLNK,		;;[344] DO NOT TYPE BLANK LINES
LWORD	U.CRLF,		;;[344] FREE CRLF AT RIGHT MARGIN
LWORD	U.DBRK,		;;[344] DEBREAK (2741 TERM.)
LWORD	U.DISP,		;;[743] DISPLAY MODE
LWORD	U.ECHO,		;;[344] GUESS
LWORD	U.FILL,		;;[344] FILLER CLASS
LWORD	U.FFHO,		;;HOME ON FF
LWORD	U.FFSI,		;;SIMULATE FF WITH LF'S
LWORD	U.FFST,		;;STOP ON FF'S
LWORD	U.FORM,		;;[344] TTY HAS FORM FEEDS
LWORD	U.GAG,		;;[344] ALLOW SENDS ONLY AT MON. MODE OR RIGHT MARGIN
LWORD	U.LC,		;;[344] TTY HAS LOWER CASE
LWORD	U.LENG,		;;TTY PAGE LENGTH
LWORD	U.PAGE,		;;[344] ^S-^Q MODE
LWORD	U.PGSZ,		;;[344] PAGE SIZE
LWORD	U.RSPD,		;;[344] RECEIVE SPEED
LWORD	U.RTC,		;;[423] /RTCOMPATABILITY
LWORD	U.SBEL,		;;TTY SBELL
LWORD	U.SETT,		;;[344] /SETTTY /NOSETTY
LWORD	U.SPED,		;;[344] XMIT/RCV SPEED
LWORD	U.STOP,		;;TTY STOP n
LWORD	U.SSTO,		;;TTY SSTOP n
LWORD	T.STOP,		;;TTY STOP BIT (NOT SET BY SCAN)
LWORD	T.SSTOP,	;;TTY SSTOP BIT (NOT SET BY SCAN)
LWORD	U.TABS,		;;[344] TTY HAS HARDWARE TABS
LWORD	U.TAPE,		;;[344] XON STARTS PTR
LWORD	U.TIDY,		;;[747] TTY IS TIDY
LWORD	U.TTDE,		;;DEFER TTY OUTPUT
LWORD	U.TYPE,		;;[675] /TYPE
LWORD	U.UC,		;;[747] TTY HAS UPPER CASE
LWORD	U.WDTH,		;;[344] CARRIAGE WIDTH
LWORD	U.XONXO		;;TTY XONXOFF
LWORD	U.XSPD,		;;[344] XMIT SPEED
> ;;[344] END IFN SETTTY

LBLOCK	OOMAX,0		;;END OF BLT FOR SCAN
;;***END OF BLOCK SET TO -1 ON CALLS TO SCAN
LWORD	RPERCT,		;;FLAG FOR FILES FOUND WITH ERRORS
LWORD	SAVKNT,		;;TEMP FOR BUILDING AUX DIR
LWORD	CODE,		;;PASSWORD
LWORD	TDATE,		;;[477] TODAY'S DATE
LWORD	SAVOPR,		;;PLACE TO SAVE NAME OF OPR'S TTY
LWORD	SAOFST,		;;STARTING ADDRESS OFFSET FOR SCAN
LWORD	SVPROT,		;;USED TO SAVE UWP
LWORD	CNTLJT,		;;CONTROLLING JOB'S LINE CHARACTERISTICS
LWORD	CNTLJP,		;;CONTROLLING JOB'S PPN
LWORD	ATTJOB,			;;JOB NUMBER TO ATTACH
LWORD	INISCN,			;;[744] -1 IF IN .OSCAN
LBLOCK	WTOBLK,.QUARV+3		;;WTO MESSAGE BLOCK
LBLOCK	ERRACS,20		;;SAVED AC'S DURING ERROR PROCESSOR
;;***ARGUMENT BLOCK FOR LOGIN UUO****
LWORD	PPN,		;;USERS PPN
LWORD	PRIVWD,		;;PRIV WORD
LWORD	NAME,		;;FIRST HALF OF USER NAME
LWORD	NAME2,		;;SECOND HALF OF USER NAME
LWORD	CHGNO,		;;CHARGE NUMBER
;;***END OF LOGIN WORD
IFN FTCMPR, <		;;[667] ARGS FOR ZERO COMPRESSION
LBLOCK	CMPBLK,4	;;[667] UFD COMPRESSION FILE SPEC
LWORD	CMPDSK,		;;[667] DISK. UUO ARGUMENT BLOCK
>			;;[667] END UFD COMPRESSION ARGUMENTS
LBLOCK	ZZMAX,0		;;END OF BLT TO ZERO
>

DEFINE	LWORD(A),<	EXTERNAL A>
DEFINE	LBLOCK(A,B),<	EXTERNAL A>

> ;END IF1


	PRGEND
v	TITLE	LOGIN - Initialization for LOGIN
	SUBTTL	LOGIN - Initialization for LOGIN

	SEARCH	UUOSYM,MACTEN,SCNMAC,LGNUNV,ACTSYM,UFDPRM

	LGNDCL

COPYRIGHT (C) DIGITAL EQUIPMENT CORPORATION 1969,1984.


;START HERE

LOGIN::	TDZA	17,17		;CLEAR AC17 ON A NORMAL START
	MOVEI	17,1		;SETUP A 1 ON A CCL START
	SETZB	0,ZZBEG		;PREPARE TO CLEAR CORE
	MOVEI	16,1		;CLEAR THE AC'S
	BLT	16,16		; ..
	MOVE	T1,[ZZBEG,,ZZBEG+1] ;CLEAR OUT THE LOWSEG
	BLT	T1,ZZMAX-1	; ..
	MOVEM	17,SAOFST	;SAVE STARTING OFFSET
	MOVE	T1,[4,,RICC##]	;LOAD UP JOBINT BLOCK
	MOVEM	T1,INTBLK	; ..
	MOVX	T1,ER.ICC	;ASK FOR CONTROL-C
	MOVEM	T1,INTBLK+1	; INTERCEPT
	MOVEI	T1,INTBLK	;CONTROL-C INTERCEPT BLOCK
	MOVEM	T1,.JBINT##	;STORE FOR THE MONITOR
	RESET

	MOVE	P,PDPLST	;Set up the stack
	PJOB	T1,		;Get our job number
	MOVEM	T1,THSJOB	;Store for later
	PUSHJ	P,ISBATC	;Is this a Batch job ?
	SKIPA			;No
	TLO	F,FL.BAT!L.SOPR	;This guy is a real son of a batch
	MOVX	T1,.IOASC	;Assume a Batch job
	TLNN	F,FL.BAT	;Is it ?
	PUSHJ	P,TTYINI##	;INITIAL TTY
	PUSHJ	P,TTYNEC##	;SET TTY NO ECHO
	INIT	UFD,.IODMP	;GET A DISK IN DUMP MODE
	SIXBIT	/SYS/		;LOOKUP ACCOUNTING FILES IN SYS
	XWD	0,0		;NO HEADERS
	  LOGOUT		;THIS IS ALSO UNFIXABLE
	SETOM	RECFLG		;SET FLAG FOR RECOMP MESSAGE
	MOVNI	T3,1		;GET THE TTY CHARACTERISTICS
	GETLCH	T3
	CAMN	T3,[-1]		;IF A NOOP, ASSUME HDX
	MOVX	T3,GL.HDP
	MOVEM	T3,TTBITS
	MOVEM	T3,CNTLJT
	TXNN	T3,GL.ITY!GL.HDP!GL.LCP!GL.PTM	;SKIP IF HALF DUPLEX
	TLO	F,FL.FDX	;SET FULL DUPLEX FLAG
	MOVX	T1,.TOFSP	;Full SCNSER PTY function
	SETO	T2,		;My UDX
	MOVE	T3,[2,,T1]	;Point to args
	TRMOP.	T3,		;Read it
	 MOVEI	T3,0		;Cant
	CAIE	T3,0		;Is it set?
	 TLO	F,FL.FDX	;Yes--Set full duplex for full SCNSER PTYs
	MOVX	T1,%CNSTS	;MAGIC CODES FOR LOC STATES IN SYS
	GETTAB	T1,		;GET TABLE ENTRY
	  SETZ	T1,		;ZERO IF ERROR RETURN
	MOVEM	T1,STATES	;SAVE FOR LATER
	MOVX	T1,%CNST2	;[374] GET SECOND STATES WORD
	GETTAB	T1,		;[374] ..
	  SETZ	T1,		;[374] ..
	MOVEM	T1,STATS2	;[374] SAVE FOR A RAINY DAY
	MOVX	T1,%CNOPR	;GET OPR DEVICE NAME
	GETTAB	T1,		; FROM MONITOR
	  MOVSI T1,(SIXBIT /CTY/)	;ASSUME CTY IF IT WONT TELL US
	MOVEM	T1,SAVOPR	;STORE FOR LATER USE
	GETLIN	T1,		;GET MY TTY NAME
	MOVEM	T1,MYTTY	;SAVE IT
	TXNN	T3,GL.CTY	;IS MY TTY THE CTY?
	CAMN	T1,SAVOPR	;OR THE OPR?
	TLO	F,L.OPR		;YES. REMEMBER THAT IN FLAG AC
	MOVE	T3,THSJOB	;[351] GET OUR JOB NUMBER
	TRMNO.	T3,		;[345] GET TTY UDX
	  SETZ	T3,		;[345] SO WHAT?
	MOVEM	T3,TTYUDX	;[345] SALT AWAY FOR TRMOP. STUFF
	JUMPE	T3,NT2741	;[546] NOT A 2741
	MOVE	T1,[2,,T2]	;[546] ARG POINTER FOR TRMOP.
	MOVX	T2,.TO2741	;[546] READ THE 2741 BIT
	TRMOP.	T1,		;[546] ..
	  SETZ	T1,		;[546] ASSUME NOT 2741
	SKIPE	T1		;[546] IS THIS A 2741?
	SETOM	FL2741		;[546] YES - SET THE FLAG
NT2741:	SETOM	OOBEG		;SET SCAN SWITCH BLOCK TO -1
	MOVE	T1,[XWD OOBEG,OOBEG+1]
	BLT	T1,OOMAX-1
	MOVEI	T1,^D5		;LET THE GUY TRY 5 TIMES
	MOVEM	T1,LOGTRY
	MOVX	T1,%LDFFA	;PPN THAT HAS THE PRIVS
	GETTAB	T1,		;GET IT FROM MONITOR
	  MOVE	T1,[1,,2]	;DEFAULT
	MOVEM	T1,ALPPPN	;SAVE IT FOR LATER
	MOVX	T1,%LDMFD	;GET THE MFD PPN
	GETTAB	T1,		; FROM THE MONITOR
	  MOVE	T1,[1,,1]	;DEFAULT
	MOVEM	T1,MFDPPN	;STORE FOR LATER USE
	MOVSI	T1,(SIXBIT .SYS.)
	DEVPPN	T1,		;GET PPN FOR SYS
	  MOVE	T1,[1,,4]	;[361] DEFAULT
	MOVEM	T1,SYSPPN
	MOVX	T1,%LDUFP	;[557] GET STANDARD UFD PROTECTION
	GETTAB	T1,		;[557] ..
	  MOVSI	T1,775000	;[557] EH?
	ROT	T1,^D9		;[557] RIGHT-JUSTIFY IT
	MOVEM	T1,UFDPRT
	DATE	T1,
	MOVEM	T1,TDATE	;[557] SAVE FOR LATER

	PJRST	LGNSCN##	;GO OFF TO COMMAND SCANNER

	PRGEND	LOGIN
	TITLE	LGNSCN - Command scanner for LOGIN

	SEARCH	UUOSYM,MACTEN,SCNMAC,LGNUNV,ACTSYM,UFDPRM
	LGNDCL

LGNSCN::MOVEI	T1,[ASCIZ /LOGIN/]
	MOVEM	T1,HELP
	MOVE	T1,[XWD 6,SCIBLK]
	PUSHJ	P,.ISCAN##	;CALL SCAN TO GET COMMAND
	MOVE	P1,T1		;SAVE COMMAND VALUE
	SKIPN	SAOFST		;CCL RUN?
	CAIN	P1,2		;IS IT A SESSION COMMAND?
	TRO	F,R.SESS	;YES--FLAG SESSION
	SKIPE	.JBDDT##	;IS DDT LOADED?
	JRST	LGIN2B		;YES--LET IT GO
	MOVN	T1,THSJOB	;MAKE NEGATIVE
	JOBSTS	T1,		;READ JOB STATUS
	  JRST	LOGIN2		;ASSUME OK IF NO JOB STATUS
	TXNE	T1,JB.UJC	;IF JACCT IS CLEAR THERE IS NO HARM TRYING
	TXNN	T1,JB.ULI	;IF JACCT IS SET JLOG MUST BE CLEAR
	JRST	LOGIN2		;OK--EITHER NO PRIVS OR LOGGED OUT
	TRNE	F,R.SESS	;IS IT A SESSION COMMAND?
	JRST	LOGIN2		;YES LET IT GO
	FATAL	KOD,<Please KJOB or DETACH>,EF.SIL
LOGIN2:	TXNE	T1,JB.UJC	;[541] JACCT?
	  JRST	LGIN2A		;[541] YES
	WARN	IDJ,<I do not have JACCT>
LGIN2B:	TRO	F,R.DBUG	;[626] SET DEBUG FLAG; WE'RE BEING DEBUGGED
LGIN2A:	TRNE	F,R.SESS	;SESSION COMMAND?
	JRST	NOJBMS		;YES
	JUMPLE	P1,LOGDIS	;IF R, RUN, OR  LOGIN COMMAND
;HERE IF ATTACH

	MOVE	T1,[XWD ATTBLN,ATTBLK]	;POINT TO ATTACH SWITCHES
	PUSHJ	P,.PSCAN##	;GO SET UP FOR PARTIAL SCAN
	  PJRST	FLUSH		;SHOULD NEVER HAPPEN
	PUSHJ	P,CHKSWT	;CHECK FOR SWITCHES NOW
				;(CURRENTLY MONITOR WILL NOT ALLOW ANY, BUT..)
	MOVEI	T1,[ASCIZ /a job number/]
	MOVEM	T1,HELP
	PUSHJ	P,.DECNW##	;READ JOB NUMBER TO BE ATTACHED TO
	MOVEM	N,ATTJOB	;SAVE JOB NUMBER
	TLO	F,FL.ATT	;NOTE ATTACH
	SETOM	NOWBIT		;CAN ALWAYS ATTACH
ATTD1:	JUMPLE	C,FLUSH		;MUST BE POSITIVE NUMBER
	CAIE	C,"<"		;[655] CHECK FOR PPN FROM 2741
	CAIN	C,"["		;SKIP IF NOT YET TO PPN
	JRST	ATTD2		;READ PPN
	PUSHJ	P,TYI		;READ NEXT CHAR
	JRST	ATTD1		;AND LOOP TILL [
ATTD2:	PUSHJ	P,.OCTNW##	;READ PROJECT NUMBER
	TLNN	N,-1		;ONLY 6 DIGITS
	CAIE	C,","		;MUST END WITH COMMA
	 FATAL	BPN,<Invalid format for project-programmer number>,EF.FMT
	JUMPE	N,LGNBPN		;MUST BE SOMETHING THERE
	HRLZ	PP,N		;SAVE PROJECT NUMBER
	PUSHJ	P,.OCTNW##	;READ PROGRAMMER NUMBER
	JUMPE	N,LGNBPN		;MUST BE SOMETHING THERE
	TLNE	N,-1		;BUT NOT TOO MUCH
	JRST	LGNBPN
	CAIE	C,">"		;USER TERMINATE?
	 CAIN	C,"]"		;..
	  PUSHJ	P,TYI		;YES--GET NEXT CHAR
	HRR	PP,N		;SAVE PROGRAMMER NUMBER
	MOVEM	PP,PPN		;STORE PPN
	MOVEI	N,.GTPPN	;CHECK TO SEE THAT THIS
	HRL	N,ATTJOB	; JOB HAS THE PPN HE
	GETTAB	N,		; CLAIMED IT DOES. THE MONITOR
	  SETZ	N,		; MAKES THIS CHECK BUT LOGIN
	CAME	N,PPN		; COULD HAVE A BUG WHICH WOULD
	JRST	NOATT		; ZAP A USER.
	PUSHJ	P,CHKSWT	;CHECK FOR SWITCHES HERE
	JRST	NOJBMS		;OK, PROCEED WITH ATTACH

;PROCESS SWITCHES (IF ANY) FOR ATTACH

CHKSWT:	CAIN	C," "		;A SPACE?
	 PUSHJ	P,TYI		;YES--GET A REAL CHAR
	CAIE	C,"/"		;SWITCH COMING?
	 POPJ	P,		;NO--RETURN
	PUSHJ	P,.KEYWD##	;YES--ASK SCAN TO PROCESS
	 JRST	LGNNSS		;ERROR IF NO SWITCH
	JRST	CHKSWT		;AND LOOP

	FATAL	NSS,<No switch specified>
	SUBTTL	Type first message, check states bits

;HERE TO TYPE JOB NUMBER, MONITOR NAME, AND TTY NUMBER

LOGDIS:	MOVEI	T1,[ASCIZ/JOB /]
	PUSHJ	P,.TSTRG##
	MOVE	T1,THSJOB	;GET JOB NUMBER
	PUSHJ	P,.TDECW##
	PUSHJ	P,.TSPAC##
	MOVNI	T3,5
CONFLP:	MOVEI	T1,.GTCNF
	HRLI	T1,5(T3)
	GETTAB	T1,		;GET NEXT WORD OF MONITOR NAME
	  JRST	ONTTY
	MOVEM	T1,UFDBUF
	SETZM	UFDBUF+1
	MOVEI	T1,UFDBUF
	PUSHJ	P,.TSTRG##	;**TEMP** UFDBUF
	AOJL	T3,CONFLP
	PUSHJ	P,.TSPAC##
ONTTY:	MOVE	T1,MYTTY	;GET TTY NAME
	PUSHJ	P,.TSIXN##	;PRINT IT
	PUSHJ	P,.TCRLF##

NOJBMS:	MOVE	T3,TTBITS
	MOVE	T2,STATES	;GET STATES WORD
	TXNN	T3,GL.ITY	;[605] PTY?
	  JRST	TTYGO		;[605] NO: NO SPECIAL CHECKS THEN

	TRO	F,R.PTYJ	;MARK AS A PTY JOB
	TLNE	F,FL.BAT	;Is this a Batch job ?
	JRST	TTYGO		;[605] TRUST BATCON AND SKIP CHECKS

;ENTER HERE WITH	T3=TTBITS FOR TTY OR CONTROL JOB TTY

TTYGO:	MOVE	T2,STATES	;GET STATES BITS
	TLNE	F,L.OPR!L.SOPR	;OPER OR HIS SUB?
	TLNE	F,FL.BAT	;[700]  AND NON-BATCH JOB?
	SKIPA			;[700]  NO--CONTINUE
	JRST	PPNGO4		;[1101] YES. OK TO GO
	TXNN	T2,ST%NLG	;NO LOGIN?
	JRST	SYSAVL		;NO--SYSTEM IS AVAIL
	STOP	SNA,<System not available>
SYSAVL:	TXNE	T3,GL.DSL!GL.REM	;NON-LOCAL?
	TXNN	T2,ST%NRL	;AND STATES SAYS LOCAL ONLY?
	JRST	NOTRMT		;NO. OK
	REQUE	NRU,<No remote users; Try again later>
NOTRMT:	TLNE	F,FL.ATT	;[555] SKIP IF LOGIN, NOT IF ATTACH
	  JRST	PPNGO4		;[654] DON'T NEED TO CHECK LOGMAX FOR ATTACH
NT2MNY:	TLNE	F,FL.BAT	;BATCH JOB?
	JRST	PPNGO		;YES, GO CHECK JOBMAX
	TXNN	T2,ST%BON	;NO. BATCH ONLY ONES ALLOWED?
	JRST	PPNGO		;NO
	FATAL	OBU,<Only batch users may LOGIN>

PPNGO:	MOVSI	T1,(AC.MAX)	;[1101] SETUP TO CHECK LOGMAX
IFN BATMAX,<
	TLNE	F,FL.BAT	;[1101] IS THIS GUY BATCH?
	TLO	T1,(AC.BMX)	;[1101] YES, CHECK BATMAX
>
	ACCLG.	T1,		;[1101] SEE IF WE CAN GET ACCESS
	  JRST	ACCERR		;[1101] NO, FIND OUT WHY AND GIVE AN ERROR

PPNGO4:	MOVX	T1,%NSKTM	;FIND OUT IF SYSTEM IS DOWN
	GETTAB	T1,
	  SETZ	T1,
	JUMPE	T1,PPNGO1	;OK TO GO
	JUMPG	T1,PPNGO3	;JUMP IF SYSTEM GOING DOWN SOON
	TLNN	F,L.OPR!L.SOPR	;[606] IF OPR OR SUB OF OPR OR 1,2
 	 TXNN	T3,GL.REM!GL.DSL	;[657] OR LOCAL TTY
	  JRST	PPNGO1		;[606] THEN LET HIM IN ANYWAY
	STOP	TIO,<Timesharing is over>
PPNGO3:	CAIL	T1,^D24*^D60	;OVER A DAY TO GO?
	JRST	PPNGO1		;YES--SKIP WARNING
	INFO	TCI,<Timesharing will cease in >,,E.TCI
	JRST	PPNGO1

E.TCI:	PUSH	P,T1		;SAVE MINUTES TILL KSYS
	IDIVI	T1,^D60
	MOVE	T4,T2		;SAVE REMAINDER (MINUTES)
	JUMPE	T1,E.TCI1	;SEE IF HOURS NONZERO
	PUSHJ	P,.TDECW##	;YES. PRINT HOURS
	MOVEI	T1,[ASCIZ/ hours /]
	PUSHJ	P,.TSTRG##
E.TCI1:	MOVE	T1,T4		;GET MINUTES
	PUSHJ	P,.TDECW##
	MOVEI	T1,[ASCIZ/ minutes at /]
	PUSHJ	P,.TSTRG##	;TYPE
	MSTIME	T1,		;GET NOW
	IDIVI	T1,^D60*^D1000	;MAKE MINUTES
	POP	P,T2		;RESTORE KSYS TIMER
	ADD	T1,T2		;COMBINE
	CAILE	T1,^D24*^D60	;WRAP AROUND?
	 SUBI	T1,^D24*^D60	;YES--FIX UP
	IMULI	T1,^D60*^D1000	;BACK INTO MILLISECONDS FOR SCAN
	PJRST	.TTIME##	;TYPE AND RETURN

;HERE TO BEGIN CHECKING PPN

PPNGO1:	TLNE	F,FL.ATT	;[555] LOGIN OR ATTACH?
	  JRST	ATTCHK		;[555] ATTACH


;HERE TO COMPUTE BIT IN TIMES WORD TO CHECK

	MOVE	T1,STATES	;[354] GET STATES WORD
	TXNN	T1,ST%NOP	;[354] IS THERE AN OPERATOR?
	JRST	LOGIN3		;[354,360] YES -- PROCEED
	INFO	NOC,<No operator coverage>

LOGIN3:	MOVE	P,PDPLST	;[565] RE-INIT STACK
	TLZ	F,FL.WKD+FL.RAS	;TRY AGAIN ENTRY
	PUSHJ	P,.GTNOW##	;GO GET TODAYS DATE
	HLRZ	T1,T1		;SAVE THE DAY
	IDIVI	T1,7		;FIGURE OUT THE DAY
	CAIL	T2,3		;[316] SATURDAY??
	CAILE	T2,4		;[316]  OR SUNDAY??
	TLO	F,FL.WKD	;NO--FLAG AS WEEKDAY
	MOVEM	T2,SAVEDA	;SALT AWAY
	MSTIME	T1,
	IDIV	T1,[EXP ^D1000*^D60*^D60]
	MOVSI	T2,400000	;MAKE A BIT FOR THE CURRENT HOUR
	TLNN	F,FL.WKD	;WEEKDAY?
	MOVEI	T2,4000		;NO. USE LOW 12 BITS
	TLNN	F,FL.WKD	;WEEKDAY?
	ASH	T1,-1		;NO. USE TWO-HOUR SHIFTS
	MOVNS	T1
	LSH	T2,0(T1)	;PUT BIT IN TUNE WITH TIME
	MOVEM	T2,NOWBIT	;SAVE.

	PUSHJ	P,PARSE##	;GO PARSE LOGIN LINE
ATTCHK:	CAME	PP,SYSPPN	;SYSPPN CAN ALWAYS LOGIN
	CAME	PP,MFDPPN	;BUT IF MFDPPN IS NOT SYSPPN,
	JRST	STACCT
	FATAL	MLB,<May not LOGIN as MFD PPN>,EF.FMT

;	HERE IF ACCLG. UUO FAILED

ACCERR:	MOVEI	T2,3		;[1101] 1=ALWAYS, 2=SOMETIMES, 3=NEVER
	MOVEM	T2,U.NOTC	;[1101] Simulate /NOTICE:NEVER
	CAIE	T1,ACLMX%	;[1101] DID LOGMAX FAIL?
	  JRST	ACCBMX		;[1101] NO, SO CHECK BATMAX
	REQUE	JCE,<Job capacity exceeded>;[1101]
ACCBMX:	CAIE	T1,ACLBM%	;[1101] did BATMAX fail?
	  JRST	ACCJLG		;[1101] NO, CHECK FOR JLOG ERROR
	REQUE	BJC,<Batch job capacity exceeded>
ACCJLG:	CAIE	T1,ACLJL%	;[1101] WAS JLOG ON?
	  JRST	ACCILL		;[1101] NO, SEE IF BAD ARGUMENT
	STOP	JLG,<Decrement tried with JLOG on>,EF.WTO
ACCILL:	CAIE	T1,ACLIL%	;[1101] WAS IT A BAD ARGUMENT?
	  JRST	ACCDCR		;[1101] NO, CHECK FOR DECR ERROR
	STOP	ARG,<Illegal argument detected>,EF.WTO
ACCDCR:	CAIE	T1,ACLDC%	;[1101] WAS IT A BAD DECR
	  JRST	ACCDIE		;[1101] NO, WE HAVE AN UNKNOWN ERROR
	STOP	DCR,<Decrement tried with PD.LGN on>,EF.WTO
ACCDIE:	STOP	UKN,<Unknown error detected from ACCLG. UUO>,EF.WTO

;[605] HERE IF NON-BATCH PTY JOB TO CHECK SUPERIOR JOBS

NOTBAT:	PUSHJ	P,FNDCTL	;FIND CONTROLLING JOB NUMBER
	 JRST	TTYDET		;CAN'T
	  JRST	BJSJ		;BATCH JOB SUBJOB
	MOVEM	T2,CNTLJP	;SAVE CONTROLLER'S PPN
	HRLZ	T1,T3		;T1=SIXBIT LINE NUMBER
	CAME	T3,[SIXBIT/CTY/]	;[660] SKIP IF ATTACHED CTY
	CAMN	T3,SAVOPR	;IS IT THE OPR?
	TLO	F,L.SOPR	;FLAG SUBJOB OF OPR.
	SETZ	T3,
	MOVE	T4,[POINT 6,T1]
	JUMPN	T1,ISPTY1	;JUMP IF NOT CTY
	MOVX	T3,%CNPTY
	GETTAB	T3,
	  SETO	T3,
	HLRES	T3		;T3=OFFSET FOR FIRST PTY
	SUBI	T3,1		;-1=LINE NUMBER OF CTY
	JUMPGE	T3,ISPTY2	;JUMP IF HAVE CTY LINE NUMBER
	MOVX	T3,GL.CTY	;NO, FAKE TTBITS
	JRST	ISPTY3		;WE KNOW ITS THE CTY

ISPTY1:	ILDB	WD,T4
	JUMPE	WD,ISPTY2	;JUMP IF NO MORE CHARS
	LSH	T3,3
	ADDI	T3,-20(WD)
	JRST	ISPTY1

TTYDET:	SKIPA	T3,[GL.REM+GL.DSL]	;MAKE HIM NON-LOCAL

ISPTY2:	GETLCH	T3		;GET LINE BITS FOR CONTROL JOB TTY
ISPTY3:	MOVEM	T3,CNTLJT	;SAVE LINE BITS FOR CONTROL JOB TTY
	JRST	TTYGO		;GO DO THE ACCOUNTING

BJSJ:	TLO	F,FL.BSJ	;REMEMBER WE'RE A BATCH JOB SUBJOB
	MOVEM	T2,CNTLJP	;CONTROLLING PPN=PPN OF BATCH JOB
	MOVX	T3,GL.REM	;PRETEND REMOTE
	MOVEM	T3,CNTLJT	;SAVE FAKE TTY BITS
	JRST	TTYGO		;GO DO CHECKING
;ROUTINE TO FIND JOB'S ULTIMATE CONTROLLER FOR PURPOSES OF ACCESS CHECKING
;STOP SCANNING IF REACH: [1,2] JOB, TOP LEVEL JOB, DETACHED JOB, OR BATCH JOB
;CALL:	PUSHJ	P,FNDCTL
;	 CPOPJ IF CAN'T FIND JOB (ASSUME WE'RE DETACHED)
;	  CPOPJ1 IF BATCH JOB SUBJOB (ASSUME REMOTE)
;	    CPOPJ2 WITH AC'S SET UP AS FOLLOWS:
;		T1=CONTROLLING JOB NUMBER
;		T2=CONTROLLING JOB'S PPN
;		T3=CONTROLLING JOB'S PHYSICAL TTY NAME
FNDCTL:	SETO	T1,		;FIRST, GET IMMEDIATE CONTROLLING JOB
	CTLJOB	T1,		;..
	  JRST	CPOPJ		;ASSUME WE'VE BECOME DETACHED
	JUMPL	T1,CPOPJ	;DITTO

FNDCT1:	HRLZ	T3,T1		;GET THIS JOB'S TTY DDB ADDRESS
	HRRI	T3,.GTTTY	;..
	GETTAB	T3,		;..
	  JRST	CPOPJ
	PEEK	T3,		;GET PHYSICAL TTY NAME
				;[660] REMOVED 3 INSTRUCTIONS
	PUSH	P,T1		;SAVE T1
	MOVE	T1,T2		;SAVE LAST PPN IN CASE SON-OF-OPR
	HRLZ	T2,(P)		;GET THIS JOB'S PPN (JOB # ON STACK)
	HRRI	T2,.GTPPN	;..
	GETTAB	T2,
	  SETZ	T2,
	CAMN	T2,ALPPPN	;HAVE WE HIT A [1,2] JOB YET?
	  JRST	SONOPR		;YES: WE'RE SON-OF-OPR
	HRRZ	T1,(P)		;GET JOB NO. BACK AGAIN
	PUSHJ	P,ISBATC	;IS THIS JOB A BATCH JOB?
	  JRST	NOTBSJ
	POP	P,T1		;FIX UP STACK
	JRST	CPOPJ1		;WE'RE A BATCH JOB SUBJOB

NOTBSJ:	MOVE	T1,(P)		;RESTORE T1 FOR A BIT
	CTLJOB	T1,		;ANOTHER LEVEL?
	  JRST	TPOPJ		;[670] RESTORE T1 AND RETURN
	AOJE	T1,TOPLVL	;IF T1=-1 WE'VE HIT TOP LEVEL
	TLO	F,L.MANY	;FLAG MORE THAN ONE SUPERIOR
	POP	P,T3		;[704] ADJUST STACK
	SOJA	T1,FNDCT1	;[704] GO THRU NEXT LEVEL


SONOPR:	TLO	F,L.SOPR	;REMEMBER WE'RE SPAWN OF OPR
	MOVE	T2,T1		;USE LAST NON-[1,2] PPN AS CONTROLLER
	TLNN	F,L.MANY	;UNLESS [1,2] IS IMMEDIATE CONTROLLER
	  MOVE	T2,ALPPPN	;IN WHICH CASE USE [1,2]
TOPLVL:	POP	P,T1		;JOB # WE WANT IS ON STACK
CPOPJ2:	AOS	(P)
CPOPJ1:	AOSA	(P)		;[670]
TPOPJ:	POP	P,T1		;[670] RESTORE T1
CPOPJ:	POPJ	P,
;SUBROUTINE TO PARSE THE LOGIN COMMAND LINE
;CALL WITH:
;	PUSHJ	P,PARSE
;	RETURN HERE IF OK
;
PARSE::	TLZ	F,FL.WLD	;[355]
	TRZ	F,R.EOL		;[604] CLEAR FLAGS WHICH NEED IT
	SETZM	Z.STRT		;INIT SOME SWITCHES TO 0
	MOVE	T1,[XWD Z.STRT,Z.STRT+1];SETUP BLT
	BLT	T1,Z.END-1	;CLEAR THEM OUT
	SETOM	OOBEG		;[355] CLEAR OUT SWITCH BLOCK
	MOVE	T1,[XWD OOBEG,OOBEG+1]	;[355]
	BLT	T1,OOMAX-1	;[355]
	MOVE	T1,[IOWD DVICES*2+1,DEVTAB] ;[470] INIT PTR TO DEV TABLE
	MOVEM	T1,DEVPTR	;[470] ..
	TRNE	F,R.SESSION	;[745] SESSION COMMAND?
	 JRST	PARSES		;[745] YES--GO PARSE IT
	MOVE	T1,[LOGBLN,,LOGBLK]	;SETUP UP TO DO A PARTIAL
	PUSHJ	P,.PSCAN##	; SCAN.
	 PUSHJ	P,GIVNBR##	;GIVE NUMBER SIGN PROMPT IF NEEDED
	SETZB	PP,RDHED	;[451] THIS IS A GOOD IDEA
LOOP:	PUSHJ	P,.TIAUC##	;[330] GET NEXT CHAR
	JUMPLE	C,PARSE		;[506] ALLOW BLANK LINES
	CAIN	C," "		;[330] EAT SPACES
	JRST	LOOP		;[330]
	CAIL	C,"0"		;[330] NOT SPACE OR BRACKET - IS IT
	CAILE	C,"7"		;[330] AN OCTAL DIGIT?
	  JRST	PTHSWT		;[446] NO - GO GET PPN, PATH, & SWITCHES
	PUSHJ	P,.OCTNC##	;[745][447] GET PROJ NO (HAVE 1ST DIGIT)
	JUMPL	C,[JUMPE N,PARSE ;IGNORE BLANK LINES
		   JRST  LGNBPN]	;INVALID ENTRY
	CAIE	C,"/"		;SLASH BREAK?
	CAIN	C,","		;ORDINARY COMMA BREAK?
	SKIPN	N		;NON-ZERO NUMBER
	JRST	LGNBPN		;NO GOOD
	TLNE	N,-1		;ALSO ONLY 6 DIGITS
	JRST	LGNBPN
	HRLZ	PP,N		;PUT IN AC PP
	PUSHJ	P,.TIAUC##	;LOOK AT NEXT CHAR
	CAIE	C,UNISYM	;WANT UNIQUE PPN?
	JRST	GPRGMN		;NO, COLLECT PROGRAMMER NO
	PUSHJ	P,.TIAUC##	;GET SEPARATOR INTO CH
	MOVEI	N,UNIPRG	;PUT UNIQUE CODE INTO N
	TLOA	F,FL.WLD	;NOTE UNIQUE PROGRAMMER NO
GPRGMN:	PUSHJ	P,.OCTNC##	;COLLECT PROGRAMMER, 1ST CHAR IN CH
	JUMPE	N,LGNBPN		;THIS SHOULD CATCH FORMAT ERRORS
	TLNE	N,-1		;..
	JRST	LGNBPN		;NO GOOD.
	HRR	PP,N		;MAKE AN XWD
	JUMPLE	C,NOSWIT	;[442] NO PATH OR SWITCES IF EOL FOUND
;HERE HANDLE PATH DEFINITION AND LOGIN SWITCHES

PTHSWT:	PUSHJ	P,.REEAT##	;[325] BACK UP ONE CHARACTER
	PUSHJ	P,.FILIN##	;[434] GO SCAN OFF THE PATH
	MOVEI	T1,U.PATH	;NOW GO COPY THE SPEC
	MOVEI	T2,.FXLEN	;  INTO LOGIN'S CORE
	PUSHJ	P,.GTSPC##	;  AREA
NOSWIT:	SKIPN	PP		;[447] NON-PATH PPN TYPED?
	  MOVE	PP,U.PATH+.FXDIR;[447] NO - GET PATH PPN
	TLNE	PP,-1		;[447] MAKE SURE BOTH HALVES
	 TRNN	PP,-1		;[447] ARE NON-ZERO
	  JRST	LGNBPN		;[447] NOPE - COMPLAIN
	MOVEM	PP,PPN		;[447] YES - SALT PPN AWAY FOR LOGIN UUO
	PUSHJ	P,TTYNEC##	;SET TTY NO ECHO

	MOVEI	T1,U.PATH	;[457] GET ADDR OF PATH SPEC TO CHECK
	PUSHJ	P,CHKPTH	;[457] MAKE SURE IT'S A NICE PATH SPEC
	  FATAL IPS,<Invalid path specification>,EF.FMT
	MOVEI	T1,PTHSPC	;[457] GET ADDR OF PATH SWITCH SPEC
	MOVE	T4,PTHSPC+.FXDIR;[474] DON'T WANT CHKPTH TO DEFAULT THIS
	PUSHJ	P,CHKPTH	;[457] MAKE SURE IT'S OK
	  JRST	LGNIPS		;BAD BOY
	SKIPN	PTHSPC+.FXDIR+2	;[705] WAS SFD TYPED IN PATH?
	JRST	NOSWT1		;[705] NO, SO LEAVE PTHSPC ALONE
	TLNN	T4,-1		;[705] ELSE: - IS PROJECT ZERO?
	HLL	T4,PP		;[705] YES - DEFAULT TO USER'S
	TRNN	T4,-1		;[705] IS PROG NO. ZERO?
	HRR	T4,PP		;[705] YES - DEFAULT TO USER'S
NOSWT1:	MOVEM	T4,PTHSPC+.FXDIR;[474][705] GET DESIRED PPN BACK
	SKIPN	U.PATH+.FXDIR+2	;[457] WERE SFD'S TYPED WITHOUT /PATH?
	POPJ	P,		;[457] NO - ALL IS OK
	SKIPN	PTHSPC+.FXDIR+2	;[457] YES - WAS AN SFD TYPED IN /PATH?
	POPJ	P,		;[457] NO - STILL OK
	JRST	LGNIPS		;YES - THAT IS A CONFLICT - COMPLAIN
	SUBTTL	SESSION command scanning

PARSES:	GETPPN	PP,			;SETUP PPN
	 JFCL
	MOVEM	PP,PPN			;STASH AWAY
PARSS2:	MOVE	T1,[LOGBLN,,LOGBLK]	;SETUP UP TO DO A PARTIAL
	PUSHJ	P,.PSCAN##		;SCAN
	 POPJ	P,			;IF PROMPT NEEDED, RETURN
	PUSHJ	P,.TIAUC##		;PRIME THE PUMP
PARSS1:	CAIN	C," "			;A SPACE?
	 PUSHJ	P,.TIAUC##		;YES--GET A REAL CHAR
	CAIN	C,"@"			;SEE IF INDIRECT CMD FILE
	 JRST	[PUSHJ	P,.GTIND##	;YES--SETUP FOR IT
		 JUMPLE	C,PARSS2	;LOOP IF EOL
		 JRST	E.ILSC##]	;ELSE ERROR
	CAIE	C,"/"			;SWITCH COMING?
	 JRST	LGNISF			;NO--ERROR
	PUSHJ	P,.KEYWD##		;YES--GO PROCESS IT
	 JRST	LGNISF			;NO SWITCH--ERROR
	JUMPG	C,PARSS1		;LOOP IF MORE
	POPJ	P,			;ELSE RETURN

	FATAL	ISF,<Illegal SESSION command format>

;[457] ROUTINE TO CHECK LEGALITY OF PATH SPEC (NO WILDCARDS ALLOWED)
;[457] CALL:	MOVE	T1,ADDRESS-OF-PATH-SPEC
;[457]		PUSHJ	P,CHKPTH
;[457]		  BAD PATH
;[457]		OKAY
;[457] THIS ROUTINE ALSO PLUGS IN LOGGED-IN PPN IF NO PPN GIVEN

CHKPTH:	MOVSI	T2,'DSK'	;FORCE DEFAULT OF DSK
	SKIPN	.FXDEV(T1)	;DEFAULT SUPPLIED BY SCAN
	  MOVEM	T2,.FXDEV(T1)	;STORE CORRECTED DEVICE
	MOVE	T3,.FXDEV(T1)	;GET THE DEVICE NAME
	DEVCHR	T3,		;GET ITS DEVICE TYPE
	TXNE	T3,DV.DSK	;MUST BE A DISK
	 SKIPE	.FXNAM(T1)	;NOR FILE NAME
	  JRST	.POPJ##		;BOMB HIM ON THAT
	SKIPE	.FXEXT(T1)	;CAN'T EVEN GIVE EXT
	  JRST	.POPJ##
	MOVSI	T3,-.FXLND	;ENTRIES IN A FULL PATH SPEC
	ADD	T3,T1		;[457] BASE ADDR OF PATH SPEC
PTHCHK:	SKIPN	.FXDIR(T3)	;WAS A DIRECTORY GIVEN?
	  JRST	.PLUS5		;NO, WE'VE REACHED END OF LIST
	AOSE	.FXDIM(T3)	;YES, WERE WILD CARDS GIVEN?
	  JRST	.POPJ##		;YES, MUSTN'T DO THAT
	AOJ	T3,
	AOBJN	T3,PTHCHK	;LOOP TO CHECK ENTIRE PATH
.PLUS5:	HLLZ	T2,.FXDIR(T1);DID HE GIVE A PROJ?
	SKIPN	T2
	  HLLM	PP,.FXDIR(T1);NO--JAM IT IN
	HRRZ	T2,.FXDIR(T1);DID HE GIVE A PROG. NO.
	SKIPN	T2
	  HRRM	PP,.FXDIR(T1);NO--GO DO THE DEFAULT
	JRST	.POPJ1##	;[457] GIVE GOOD RETURN
;HERE TO GET NAME

GETNAM:	MOVEI	T1,[ASCIZ /your name/]
	MOVEM	T1,HELP
	MOVE	T1,U.NAME	;GET THE USER NAME
	MOVE	T2,U.NAME+1	;GET THE SECOND HALF
	CAME	T1,[-1]		;NAME GIVEN?
	JRST	GETNM1		;YES--DO NOT NEED TO ASK
	MOVE	T1,ENTRY+.ACNM1	;[462] PICK UP NAME FROM ACCT.SYS
	MOVE	T2,ENTRY+.ACNM2	;[462] ..
	JUMPN	T1,.+3		;[462] IS THERE ONE?
	 TLNE	F,FL.ATT	;[462] NO - ARE WE ATTACHING?
	  JRST	GETNM1		;[462] YES - DON'T ASK, THEN
	PUSHJ	P,TTYECH##	;SET TTY ECHO
	MOVEI	T1,[ASCIZ/Name: /]
	PUSHJ	P,TTYPMT##	;[443] PROMPT
	PUSHJ	P,GET2WD	;GET NAME
	PUSH	P,T1		;SAVE FROM DESTRUCTION
	PUSHJ	P,TTYNEC##	;SET TTY NO ECHO
	POP	P,T1		;RESTORE FIRST WORD OF NAME
GETNM1:	MOVEM	T1,NAME
	MOVEM	T2,NAME2
	MOVE	T3,ENTRY+.ACPRO	;GET PROFILE WORD
	TXNN	T3,AC.NRT	;IS NAME REQUIRED?
	SKIPE	ENTRY+.ACNM1	;SKIP IF ACCT.SYS = 0
	JRST	GETCOD		;GO COLLECT PASSWORD
	MOVEM	T1,ENTRY+.ACNM1	;NO--FORCE A VALID NAME BY
	MOVEM	T2,ENTRY+.ACNM2	; OVERWRITING NAME IN ACCT.SYS ENTRY
	TXNN	T3,AC.PRT 	;NEED PASSWORD
	JRST	PSWOK		;NO--CHARGE AHEAD
;HERE TO GET PASSWORD

GETCOD:	MOVEI	T1,[ASCIZ /a valid password/]	;HELP
	MOVEM	T1,HELP		; TEXT FOR TIMEOUT
	PUSHJ	P,CODGET
IFN	NCRYPT,<	;[755] NEED TO HASH THE PASSWORD?
	MOVE	P1,T1		;[755] GET SET FOR THE HASHING ROUTINE
	PUSH	P,T2		;[755] SAVE T2 SO ENCODE WON'T SMASH IT
	PUSHJ	P,ENCODE##	;[755] DO THE HASHING ONCE AND ONLY ONCE
	MOVE	T1,P1		;[755] PUT THE CODE INTO THE RIGHT AC
	POP	P,T2		;[755] GET T2 BACK
>	;[755] END OF IFN NCRYPT
	MOVEM	T1,CODE		;SAVE THE PASSWORD TO INCLUDE IN FACT FILE
	JUMPN	T2,TRYAGN	;CAN'T BE MORE THE 6 LETTERS
	MOVE	T1,ENTRY+.ACPRO	;[355] GET PROFILE WORD
	TXNN	T1,AC.NRT	;[355] NAME REQUIRED?
	JRST	NAMEOK		;[355] NO -- PROCEED
	SKIPN	T1,ENTRY+.ACNM1	;IF NAME NON-ZERO, THEN MUST MATCH FILE
	JRST	NAME1		;SEE IF NON-ZERO NAME SPECIFIED
	MOVE	T2,ENTRY+.ACNM2	;CHECK THE NAME.
	CAMN	T1,NAME		;..
	CAME	T2,NAME2	;SECOND HALF
	JRST	BADNAM
	JRST	NAMEOK		;ONWARD

NAME1:	MOVE	T1,NAME		;GET NAME
	IOR	T1,NAME2	; THE USER GAVE US
	JUMPE	T1,BADNAM	;IF NAME IS REQUIRED, IT MUST BE NON-ZERO

NAMEOK:	MOVE	P1,CODE		;[557] GET PASSWORD TYPED
	CAME	P1,ENTRY+.ACPSW	;[557] DOES PASSWORD MATCH?
	  JRST	TRYAGN		;NO. HE LOSES.
IFN	PSWCHG,<		;[557] IF ALLOWING PSWD CHANGES
	SKIPG	U.NPSW		;[557] USER WANT TO CHANGE HER PSWD?
	  JRST	PSWOK		;[557] NO - SKIP THIS STUFF
NOWAY:	MOVEI	T1,[ASCIZ /a new password/]
	MOVEM	T1,HELP		;[557] HELP TEXT FOR TIMEOUT
	MOVEI	T1,[ASCIZ/New password: /]
	PUSHJ	P,TTYPMT##	;PROMPT
	PUSHJ	P,GET2WD	;[557] GET THE ANSWER
	PUSHJ	P,.TCRLF##	;ECHO THE CRLF
	SKIPN	P1,T1		;[557] MAKE SURE NON-NULL
	  JRST	NOWAY		;[557] NULL PSWD IS A NO-NO
	JUMPN	T2,NOWAY	;[557] PASSWORD TOO LONG
	MOVEI	T1,[ASCIZ/Reenter to verify: /]
	PUSHJ	P,TTYPMT##	;PROMPT
	PUSHJ	P,GET2WD	;READ PASSWORD AGAIN
	PUSHJ	P,.TCRLF##	;ECHO THE CRLF
	CAMN	P1,T1		;SAME AS BEFORE?
	 CAIE	T2,0		;OR TOO LONG?
	  CAIA			;LOOKS BAD
	   JRST OKWAY		;LOOKS GOOD
	WARN	PDV,<Passwords didnt verify; Try again>
	JRST	NOWAY		;AND ASK AGAIN

OKWAY:
IFN	NCRYPT,<		;[557] ENCRYPTING PSWDS?
	PUSHJ	P,ENCODE##	;[557] YES - MUNGE IT
>				;[557] END IFN NCRYPT
	MOVEM	P1,ENTRY+.ACPSW	;[557] REPLACE OLD PSWD WITH NEW
	PUSHJ	P,WTUFD		;[557] WRITE THE BLOCK TO ACCT.SYS
	>			;[557] END IFN PSWCHG
	JRST	PSWOK		;CHARGE AHEAD
;SUBROUTINE TO SCAN OFF DISK PRIORITY
;
SWDSKP:	PUSHJ	P,.OCTNW##	;READ THE NUMBER
	CAML	N,[-3]		;TOO SMALL
	CAILE	N,3		;TOO BIG
	JRST	SDSKPE		;YES--ERROR
	MOVEM	N,U.DPRI	;STORE THE ANSWER
	PJRST	.SWDON##	;RETURN

SDSKPE:	M.FAIO	<Invalid argument to /DSKPRI:>


;[470] SUBROUTINE TO STORE ARGS TO /ASSIGN:PHYS:LOG
;
ASSIGN:	TRZ	F,R.NXSW!R.EOL	;[627] CLEAR NEXT-SWITCH-SEEN FLAG AND END-OF-LINE FLAG
	AOS	(P)		;[470] SKIP RETURN TO BYPASS .SWDPB
	PUSHJ	P,.+1		;[470] DO THIS TWICE - ONCE FOR PHYS
				;[470] NAME, ONCE FOR LOG NAME
	TRNE	F,R.EOL		;[473] EOL SEEN YET?
	  POPJ	P,		;[473] YES-SCAN BARFS IF WE CALL .SIXSW
	MOVE	T1,DEVPTR	;[470] GET POINTER TO TABLE
	AOBJP	T1,LGNA2M	;[470] TOO MANY /ASSIGN SWITCHES
	SETZ	T2,		;[627] ZAP T2 IN CASE NO LOGICAL NAME
	TRNE	F,R.NXSW	;[627] ARE WE ABOUT TO READ THE NEXT SWITCH?
	  JRST	ASIGN1		;[627] YES - DON'T!
	PUSH	P,T1		;[470] SAVE T1 OVER .SIXQW
	PUSHJ	P,.SIXSW##	;[470] GET SIXBIT STRING
	CAIN	C,"/"		;[627] NEXT SWITCH?
	TRO	  F,R.NXSW	;[627] REMEMBER TO STOP NOW
	SKIPG	C		;[473] EOL YET?
	TRO	  F,R.EOL	;[627] EOL - REMEMBER IT
	POP	P,T1		;[470] GET T1 BACK AGAIN
	MOVE	T2,.NMUL##	;[470] PICK UP ARG FROM SCAN
ASIGN1:	MOVEM	T2,(T1)		;[627] STORE AWAY IN TABLE
	MOVEM	T1,DEVPTR	;[470] SAVE POINTER TO TABLE
	POPJ	P,		;[470] RETURN

	WARN	A2M,<Attempt to assign too many devices with /ASSIGN>
	POPJ	P,		;AND RETURN
;SUBROUTINE TO READ /ACCOUNT SWITCH
;CALL:	PUSHJ	P,ACCTSW
;	RETURN HERE
;
ACCTSW:	PUSHJ	P,.SWASQ##	;READ THE QUOTED STRING
	MOVEI	N,1		;FAKE SCAN
	MOVE	T2,[POINT 7,.NMUL##];POINT TO STORAGE
	MOVEI	T3,^D39		;MAXIMUM NUMBER OF CHARACTERS IN ACCOUNT STRING
ACCTS1:	ILDB	T1,T2		;GET A CHAR
	JUMPE	T1,.SWDPB##	;NOTE THAT VALIDATION IS DONE LATER
	CAIGE	T1,176		;NO. CHECK FOR ILLEGAL CHARACTERS
	 CAIGE	T1," "
	  FATAL	ICA,<Illegal character in account string>,EF.FMT,.TFCHR##
	SOJGE	T3,ACCTS1	;LOOP FOR ALL
	FATAL	ATL,<Account string too long>,EF.FMT

;SUBROUTINE TO READ /REMARK SWITCH
;CALL:	PUSHJ	P,RMRKSW
;	RETURN HERE
;
RMRKSW:	PUSHJ	P,.SWASQ##	;READ THE QUOTED STRING
	MOVE	N,.NMUL##	;MAKE SCAN HAPPY
	MOVE	T2,[POINT 7,.NMUL##];POINT TO IT
	MOVEI	T3,^D39		;SET MAXIMUM LENGTH
RMRKS1:	ILDB	T1,T2		;GET A CHAR
	JUMPE	T1,.SWDPB##	;GO STORE IF THE END
	CAIGE	T1,176		;NO. CHECK FOR ILLEGAL CHARACTERS
	 CAIGE	T1," "
	  MOVEI	T1,"\"		;IF ILLEGAL, SUBSTITUTE A BACKSLASH
	DPB	T1,T2		;STORE THE CHAR
	SOJGE	T3,RMRKS1	;LOOP FOR ALL
	WARN	RST,<REMARK string truncated to 39 characters>
	MOVEI	T1,0		;INSURE NULL AT END
	DPB	T1,T2		;STICK IT IN
	JRST	.SWDPB##	;AND RETURN TO STORE

;SUBROUTINE TO READ /BATNAM:"NAME" SWITCH
BATNAM:	PUSHJ	P,.SIXQW##	;[744] READ QUOTED SIXBIT STRING
	MOVE	N,.NMUL##	;[744] RETURN FIRST WORD
	JRST	.SWDPB##	;[744] AND LET SCAN STORE
	SUBTTL	TERMSW - Handle /TERMINAL:(args) switch	[744]

IFN SETTTY,<
TERMSW:	MOVEI	T1,TERSWT		;POINT TO SUB-TABLE
	PJRST	KEYWRD			;HANDLE THE KEYWORDS
>

	SUBTTL	DEFASW -- Handle /DEFAULT:(args) switch

DEFASW:	MOVEI	T1,DEFSWT		;POINT TO SUB-TABLE
	PJRST	KEYWRD			;HANDLE THE KEYWORDS


	SUBTTL	BATCSW -- Handle /BATCH:(args) switch

BATCSW:	MOVEI	T1,BATSWT		;POINT TO SUB-TABLE
	PJRST	KEYWRD			;HANDLE THE KEYWORDS
;THIS ROUTINE IS SIMILIAR TO .KEYWD IN SCAN, EXCEPT IT DOESNT HANDLE
;ALSO THE CASES THAT SCAN'S DOES. BUT, IT HANDLES THE SIMPLE SN,SP,SL
;SUB-SWITCHES THAT LOGIN USERS FOR /TERMINAL:. MAYBE SOMEDAY IF SCAN
;CHANGES, WE CAN REMOVE THIS CODE
					;  AND P2 (LOCAL/REMOTE INDEX)
KEYWRD:	PUSHJ	P,.SAVE2##		;SAVE P1 (SWITCH INDEX)
	MOVEI	P2,(T1)			;SAVE POINTER TO SWITCH TABLE
	PUSHJ	P,SIXSW			;GET NAME
	MOVE	T1,SWA(P2)		;GET POINTER TO TABLES
	PUSHJ	P,SWTNAM		;LOOKUP IN TABLE
	 SKIPA				;CAN'T FIND, TRY HARDER
	  JRST	KEYWDG			;GOT IT
	JUMPG	T1,E.UKK##		;AMBIGUOUS IF MORE THAN ONE
	TLC	N,'NO '			;SEE IF /NOXYZ
	TLCE	N,'NO '			;..
	 JRST	E.UKK##			;NO--ISSUE ERROR
	PUSH	P,N			;SAVE WORD
	LSH	N,^D12			;STRIP "NO"
	MOVE	T1,SWA(P2)		;POINT TO TABLES AGAIN
	PUSHJ	P,SWTNAM		;LOOKUP
	 JRST	[POP   P,N		;ERROR--RESTORE WORD
		 JRST	E.UKK]		;AND ISSUE ERROR
	POP	P,N			;RESTORE NAME
	TLO	P1,-1			;FLAG /NOXYZ
	MOVX	T1,FS.NOS 		;GET YES/NO BIT
	TDNN	T1,@SWD(P2)		;SEE IF YES/NO SWITCH
	 JRST	[MOVNI	T1,1		;ELSE PRETEND UNKNOWN
		 JRST	E.UKK##]	;FOR SCAN
KEYWDG:	MOVE	T2,@SWD(P2)		;GET DEFAULT
	MOVEI	N,(T2)			;COPY INTO N
	MOVE	T1,@SWM(P2)		;GET PROCESSOR OR TABLE POINTER
	TXNE	T2,FS.NOS		;SEE IF "NO" SWITCH
	JRST	[HLRZ N,P1		;IF SN STYLE, GET NO INDICATOR
		 MOVEI N,1(N)		;SET N=0 IF NO, 1 IF NOT NO
		 JRST KEYWDA]		;GO STUFF RESULT
	CAIN	C,":"			;SEE IF VALUE SPECIFIED
	JRST	KEYWD2			;YES--GO CHECK INTO IT
;HERE WHEN DEFAULT NEEDED
KEYWD1:	TXNE	T2,FS.VRQ		;SEE IF VALUE REQUIRED
	 JRST	E.SVR##			;YES--GIVE ERROR
	TLNN	T1,-1			;SEE IF MAX SET
	JUMPN	T1,KEYWDJ		;NO--DIRECT ACTION
	JRST	KEYWD8			;YES--GO STORE DEFAULT
;HERE WHEN VALUE SPECIFIED BY USER (MAY BE NULL)
KEYWD2:	;JUMPE	T1,E$$NMA		;IF NO VALUE LEGAL, GIVE ERROR
	JUMPG	T1,KEYWDJ		;IF SPECIAL PROCESSOR, GO DO IT

	PUSHJ	P,SIXSW			;VALUE IS ANOTHER KEYWORD--GET IT
	MOVE	T1,@SWM(P2)		;REFETCH SUB-KEY POINTER
	PUSHJ	P,.NAME			;LOOK IT UP
	  JRST	E.UKK##			;ERROR
	SUB	T1,@SWM(P2)		;DETERMINE INDEX AS VALUE
	MOVEI	N,(T1)			;PLACE IN VALUE (1,2,...)
	JRST	KEYWD8			;AND GO STORE IT AWAY

;HERE IF SN SWITCH TO LOOK FOR VALUES

KEYWDA:	JUMPE	N,KEYWD8		;IF NO, PROCEED (NO VALUES)
	CAIE	C,":"			;SEE IF VALUE COMING
	JRST	KEYWD8			;NO--THAT'S IT
KEYWDB:	PUSHJ	P,SIXSW		;GET VALUE AS NAME
	MOVE	T1,[IOWD YNTABL,YNTAB] 	;TRY YES-NO TABLE
	PUSHJ	P,.NAME			;LOOK UP NAME
	 JRST	E.UKK##			;UNKNOWN
	MOVEI	N,(T1)			;GET LOCATION OF MATCH
	SUBI	N,YNTAB			;GET OFFSET IN TABLE
	ANDI	N,1			;GET YES/NO SETTING
	JRST	KEYWD8			;RETURN THAT VALUE

;HERE TO GO TO SWITCH PROCESSOR
KEYWDJ:	PUSHJ	P,(T1)			;GO DO IT
	 JFCL				;GO STORE
;HERE TO STORE SWITCH
KEYWD8:	LDB	T1,@SWP(P2)		;GET STORED VALUE
	CAME	T1,[-1]			;SEE IF SET
	 JRST	[CAME	T1,N		;SAME AS BEFORE?
		  SKIPE	INISCN		;IN SWITCH.INI?
		   JRST	.SWDON##	;YES--JUST FORGET
		 JRST	E.DSI##]	;NO--ERROR
	DPB	N,@SWP(P2)		;NO--STORE VALUE
	JRST	.SWDON##		;AND RETURN W/O STORE

;TABLE OF YES/NO VALUES--MUST BE NO/YES PAIRS
YNTAB:	SIXBIT	/0/
	SIXBIT	/1/
	SIXBIT	/NO/
	SIXBIT	/YES/
	SIXBIT	/OFF/
	SIXBIT	/ON/
YNTABL==.-YNTAB

;ROUTINE TO READ SIXBIT WORD IGNORING LEADING SPACES
SIXSW:	PUSHJ	P,.TIAUC##		;Prime the pump
	CAIN	C," "			;Space?
	 PUSHJ	P,.TIAUC##		;Yes--Get a real char
	PJRST	.SIXSC##		;Read SIXBIT (char in C)

;ROUTINE TO LOOKUP SWITCH IN TABLE
SWTNAM:	PUSHJ	P,.NAME##		;LOOKUP IN TABLE
	 POPJ	P,			;NOT FOUND
	HRRZ	T2,SWN(P2)		;GET START
	MOVEI	P1,(T1)			;GET MATCH
	SUBI	P1,(T2)			;COMPUTE OFFSET
	JRST	.POPJ1##		;AND SKIP RETURN
;SUBROUTINE TO ASK FOR AND READ PASSWORD
;VALUES	T1=SIXBIT PASSWORD

CODGET:	PJUMPG	C,GET2WD	;[747] IF USER ALREADY TYPED, NO PROMPTS
	SKIPE	FL2741		;[546] IS THIS A 2741?
	  JRST	PW2741		;[546] YES - DO 2741 THINGS
	TLNE	F,FL.FDX	;SKIP IF NOT FDX LINE
	JRST	FDXCOD		;YES.
	MOVEI	T3,3		;THREE OVERLAYS
MASKLP:	PUSHJ	P,PRMASK	;PRINT THE MASK
	MOVX	T1,.CHCRT	;JUST A CR
	PUSHJ	P,.TCHAR##	;TYPE IT
	SOJG	T3,MASKLP	;GO BACK 3 TIMES
	PUSHJ	P,TTYOUT##	;FORCE OUTPUT
	PUSHJ	P,GET2WD	;COLLECT THE PASSWORD
	MOVEI	CH,"*"		;MASK FOR DISPLAY TERMINALS
	MOVEI	N,6		;COUNT
	PUSHJ	P,TYO		;PRINT ENOUGH TO ERASE PASSWORD
	SOJG	N,.-1		;LOOP
	PJRST	.TCRLF##	;[747] EASY

PW2741:	MOVEI	T1,[ASCIZ "Password: #$%&*@"]
	PUSHJ	P,PBACK6	;SEND 6 BACKSPACES
	PUSHJ	P,PRMASK	;PRINT A MASK
	PUSHJ	P,BACK6		;SEND 6 BACKSPACES
	PUSHJ	P,PRMASK	;PRINT A MASK
	PUSHJ	P,BACK6		;BACKSPACE OVER IT
	MOVEI	T1,[ASCIZ "######"] ;MAKE IT BLACK
	PUSHJ	P,PBACK6	; ..
	MOVEI	T1,[ASCIZ "@@@@@@"] ; ..
	PUSHJ	P,PBACK6
	PUSHJ	P,TTYOUT##	;FORCE OUTPUT
	JRST	CODCRL		;[747] READ PASSWORD

PBACK6:	PUSHJ	P,.TSTRG##	;TYPE STRING IN T1
BACK6:	MOVEI	T1,[BYTE (7)10,10,10,10,10,10,0]
	PJRST	.TSTRG##	;TYPE 6 BACKSPACES


;ROUTINE TO PRINT A MASK
PRMASK:	TIMER	T1,		;MUST MAKE MASK
	ADDB	T1,MSKMEM	;PROTECT AGAINST FAST SYSTEM
	TRO	T1,1		;FOR RANDOM NUMBERS
	MOVNI	T2,6		;6 CHARS LONG
MASK1:	IMULI	T1,-3		;RANDOM CHAR
	HRRZ	N,T1
	IDIVI	N,76		;NO SPACE OR QUEST MK
	MOVEI	CH,41(N+1)	;THE CHAR
	PUSHJ	P,TYO		;OUTPUT IT
	AOJL	T2,MASK1	;MAKE A LINE
	POPJ	P,0		;RETURN

FDXCOD:	MOVEI	T1,[ASCIZ/Password: /]	;REQUEST CODE
	PUSHJ	P,TTYPMT##	;PROMPT
CODCRL:	PUSHJ	P,GET2WD	;[747] READ PASSWORD
	PJRST	.TCRLF##	;[747] CRLF AND RETURN
LOGBLK:	IOWD	LOGSWL,LOGSWN
	XWD	LOGSWD,LOGSWM
	XWD	0,LOGSWP
	SIXBIT	/LOGIN/		;[320] TYPE HLP:LOGIN.HLP ON /HELP
LOGBLN==.-LOGBLK

ATTBLK:	IOWD	ATTSWL,ATTSWN
	XWD	ATTSWD,ATTSWM
	XWD	0,ATTSWP
	SIXBIT	/LOGIN/
ATTBLN==.-ATTBLK

SCIBLK:	IOWD	COMLEN,COMLST
	XWD	SAOFST,'LGN'
	XWD	TTYGET,STYO
	XWD	0,0
	XWD	SCNPMT##,FLUSH	
	EXP	FS.ICL

COMLST:	<SIXBIT	/LOGIN/>
	<SIXBIT	/ATTACH/>
	<SIXBIT	/SESSION/>
COMLEN==.-COMLST

LOKBLK:	XWD	[WILDBK],0
	XWD	JUNK,SECBUF	;[422] THROW AWAY 4-WORD LOOKUP BLK SO
	XWD	.FXLEN,.RBSTS+1	;[422] IT WON'T OVERWRITE AUXACC.SYS DATA
	XWD	0,WLDPNT
LOKBLN==.-LOKBLK

;OFFSETS INTO SWT TABLES FOR KEYWRD ROUTINE

	SWA==-1
	SWN==0
	SWP==1
	SWM==2
	SWD==3

IFN SETTTY,<			;[744]
	IOWD	TERM.L,TERM.N	;[744] POINTER TO SWITCH KEYWORDS
TERSWT:	TERM.N(P1)		;[744] SWITCH POINTERS FOR /SETTTY 
	TERM.P(P1)		;[744]
	TERM.M(P1)		;[744]
	TERM.D(P1)		;[744]
>;END IFN SETTTY		;[744]

	IOWD	DEFA.L,DEFA.N	;POINTER TO SWITCH KEYWORDS
DEFSWT:	DEFA.N(P1)		;SWITCH POINTERS FOR /DEFAULT:(args)
	DEFA.P(P1)
	DEFA.M(P1)
	DEFA.D(P1)

	IOWD	BATC.L,BATC.N	;POINTER TO SWITCH KEYWORDS
BATSWT:	BATC.N(P1)		;SWITCH POINTERS FOR /BATCULT:(args)
	BATC.P(P1)
	BATC.M(P1)
	BATC.D(P1)
	SUBTTL	Switch tables -- LOGIN switches (definition)

DM	COR,^D0,^D262143,^D262143	;[551]
DM	DPR,3,0,1
DM	FIL,.FXLEN,0,0
DM	LOC,77,0,0
DM	QTA,1,0,0
DM	TIM,0,0,^D60
DM	YN,1,0,1

KEYS	ATT,<ASK,IGNORE>
KEYS	DSKF,<ERROR,PAUSE>
KEYS	SPOL,<LPT,PLT,PTP,CDP,CDR>
KEYS	WTCH,<FILES,MTA,VERSION,WRITE,READ,WAIT,RUN,DAY>
KEYS	NOTC,<ALWAYS,SOMETIMES,NEVER>

	DEFINE SWTCHS,<
SP	ACCOUNT,<*P,<POINT ^D65-^D8,U.ACTS>>,ACCTSW,,FS.VRQ
SP	ASSIGN,<*F,DEVTAB>,ASSIGN,,FS.VRQ	;[470]
SL	ATTACH,<*F,U.ATT>,ATT,ATTASK
SP	BATCH,,BATCSW,,FS.VRQ
SN	BATINT,<*F,U.BINT>,			;Batch only - OPR intervention
SP	BATNAM,<*F,U.BNAM>,BATNAM,,FS.VRQ	;BATCH ONLY - BATCH JOB NAME
SP	BATSEQ,<*F,U.BSEQ>,.SWDEC##,,FS.VRQ	;BATCH ONLY - BATCH SEQUENCE NUMBER
SP	BATSTR,<*F,U.BSTR>,.SWOCT##,,FS.VRQ	;Batch only - Stream number
SP	CORE,<*F,U.CORE>,.SWCOR##,COR,FS.VRQ
SN	DEFER,<*F,U.DFER>,
SP	DEFAULT,,DEFASW,,FS.VRQ
SP	DEFBUFFER,<*F,U.DFBU>,.SWDEC##,BUF,	;[750]
SP	DEFPROT,<*F,U.DFPR>,.SWOCT##,PRO,FS.VRQ	;[620]
SL	DSKFUL,<*F,U.DFUL>,DSKF,DSKFPA
SP	DSKPRI,<*F,U.DPRI>,SWDSKP,DPR,FS.VRQ
SN	GUIDELINE,<*F,U.GUID>
SP	LIB,<*F,LIBSPC>,.SWFIL##,FIL,FS.VRQ
SN	LIMIT,<*F,U.LIMIT>
SP	LOCATE,<*F,U.STA>,.SWOCT##,LOC,FS.VRQ
IFN FTMAIL,<
SN	MAILCHECK,<*F,U.MAIL>,
>;END IFN FTMAIL
SP	NAME,<*P,<POINT ^D65-2,U.NAME>>,.SIXQW##,,FS.VRQ
SN	NEW,<*F,U.NEW>,
SS	NOLIB,<*F,LIBSPC+.FXDIR>,0
SP	NOTE,<*F,NOTSPC>,.SWFIL##,FIL,FS.VRQ
SL	NOTICE,<*F,U.NOTC>,NOTC,0,FS.VRQ	;[450] /NOTICE:
SS	NOWATCH,<*F,U.NWAT>,0
IFN	PSWCHG,<				;[557]
SN	PASSWORD,<*F,U.NPSW>, 			;[557]
	>					;[557] END IFN PSWCHG
SP	PATH,<*F,PTHSPC>,.SWFIL##,FIL,FS.VRQ	;[456] /PATH SWITCH
SP	*PHYSICAL,<*F,U.CPPL>,.SWCOR##,COR,FS.VRQ
SP	QUOTA,<*F,U.QTA>,QUOTAS##,QTA
SP	REMARK,<*P,<POINT ^D65-^D8,U.RMRK>>,RMRKSW,,FS.VRQ
SP	REQID,<*F,U.BREQ>,.SWDEC##,,FS.VRQ		;BATCH ONLY - BATCH REQUEST ID
SN	SCAN,<*F,U.SCAN>, 
SN	SFDCREATE,<*F,U.SFDC>,			;[757]
SP	SFDPROT,<*F,U.SFDP>,.SWOCT##,,FS.VRQ
SL	SPOOL,<*F,U.SPL>,SPOL,0,FS.OBV
SN	STR,<*F,U.STR>, 
SN	SYS,<*F,U.SYS>, 
SP	TIME,<*F,U.TIME>,.SWDEC##,TIM,FS.VRQ
SP	UFDPROT,<*F,U.UFDP>,.SWOCT##,,FS.VRQ	;[553]
SP	VIRTUAL,<*F,U.CVPL>,.SWCOR##,COR,FS.VRQ
SL	WATCH,<*F,U.WAT>,WTCH,0,FS.OBV


;**NOTE** DO NOT ADD NEW SETTTY SWITCHES HERE. ADD THEM IN THE OTHER
;KEYWORD TABLE ON THE NEXT PAGE. SOMEDAY THE STAND-ALONE SETTTY SWITCHES
;LISTED BELOW MAY BE REMOVED

IFN	SETTTY,<		;[344] TTY CHARACT. SWITCHES
SN	ALTMODE,<*F,U.ALTM>,
SN	BLANK,<*F,U.BLNK>,
SN	CRLF,<*F,U.CRLF>,
SN	DEBREAK,<*F,U.DBRK>,
SN	ECHO,<*F,U.ECHO>,
SP	FILL,<*F,U.FILL>,.SWOCT##,FLL
SN	FORM,<*F,U.FORM>,
SN	GAG,<*F,U.GAG>,
SN	LC,<*F,U.LC>,
SN	PAGE,<*F,U.PAGE>,
SP	PAGESIZE,<*F,U.PGSZ>,.SWDEC##,PSZ,FS.VRQ
SL	RCVSPEED,<*F,U.RSPD>,SPED,0,FS.VRQ
SN	RTCOMP,<*F,U.RTC>,
SL	SPEED,<*F,U.SPED>,SPED,0,FS.VRQ
SN	SETTTY,<*F,U.SETT>,			;[744]
SN	TABS,<*F,U.TABS>,
SN	TAPE,<*F,U.TAPE>,
SP	TERMINAL,,TERMSW,,FS.VRQ		;[744]
SN	TTDEFER,<*F,U.TTDE>,
SP	TYPE,<*F,U.TYPE>,.SWSIX##,,FS.VRQ	;[675]
SP	WIDTH,<*F,U.WDTH>,.SWDEC##,WTH,
SL	XMTSPEED,<*F,U.XSPD>,SPED,0,FS.VRQ
	>			;[344] END IFN SETTTY

>
	SUBTTL	Switch tables -- LOGIN switches (expansion)

	DOSCAN(LOGSW)			;LOGIN SWITCHES
	SUBTTL	Switch tables -- ATTACH switches (definition)

DEFINE SWTCHS,<
IFN FTMAIL,<
	SN	MAILCHECK,<*F,U.MAIL>,
>;END IFN FTMAIL
	SS	MONITOR,<*F,U.MODE>,0
	SS	USER,<*F,U.MODE>,1
>


	SUBTTL	Switch tables -- ATTACH switches (expansion)

	DOSCAN(ATTSW)			;ATTACH SWITCHES
	SUBTTL	Switch tables -- TERMINAL arguments (definition)

;[744] ADD ALL NEW TERMINAL SWITCHS HERE
IFN SETTTY,<

DM	FLL,3,0,2
DM	PSZ,^D255,^D255,^D24
DM	WTH,^D255,^D80,^D132

KEYS	SPED,<50,75,110,134,150,200,300,600,1200,1800,2400,4800,9600,EXTA,EXTB>
DEFINE SWTCHS,<
SN	ALTMODE,<*F,U.ALTM>,
SN	BLANKS,<*F,U.BLNK>,
SN	CRLF,<*F,U.CRLF>,
SN	DEBREAK,<*F,U.DBRK>,
SN	DEFER,<*F,U.TTDE>,
SN	DISPLAY,<*F,U.DISP>,
SN	ECHO,<*F,U.ECHO>,
SN	FFHOME,<*F,U.FFHO>,
SN	FFSIMULATE,<*F,U.FFSI>
SN	FFSTOP,<*F,U.FFST>
SP	FILL,<*F,U.FILL>,.SWOCT##,FLL
SN	FORM,<*F,U.FORM>,
SN	GAG,<*F,U.GAG>,
SN	LC,<*F,U.LC>,
SP	LENGTH,<*F,U.LENG>,.SWDEC##,PSZ,FS.VRQ
SS	NOFILL,<*F,U.FILL>,0			;[747]
SS	NOSTOP,<*F,U.STOP>,0
SS	NOSSTOP,<*F,U.SSTO>,0
SN	PAGE,<*F,U.PAGE>,
SP	PAGESIZE,<*F,U.PGSZ>,.SWDEC##,PSZ,FS.VRQ
SL	RCVSPEED,<*F,U.RSPD>,SPED,0,FS.VRQ
SN	RTCOMP,<*F,U.RTC>,
SN	SBELL,<*F,U.SBEL>,
SL	SPEED,<*F,U.SPED>,SPED,0,FS.VRQ
SP	STOP,<*F,U.STOP>,.SWDEC##,PSZ,FS.VRQ
SP	SSTOP,<*F,U.SSTO>,.SWDEC##,PSZ,FS.VRQ
SN	TABS,<*F,U.TABS>,
SN	TAPE,<*F,U.TAPE>,
SN	TIDY,<*F,U.TIDY>,			;[747]
SP	TYPE,<*F,U.TYPE>,.SIXSW##,,FS.VRQ	;[675]
SN	UC,<*F,U.UC>,				;[747]
SP	WIDTH,<*F,U.WDTH>,.SWDEC##,WTH,
SN	XONXOFF,<*F,U.XONXO>,
SL	XMTSPEED,<*F,U.XSPD>,SPED,0,FS.VRQ
>;END DEFINE SWTCHS
	SUBTTL	Switch tables -- TERMINAL arguments (expansion)

	DOSCAN	(TERM.)		;[744] EXPAND THE SUBTABLE POINTERS

>;END IFN SETTTY
	SUBTTL	Switch tables -- DEFAULT arguments (definition)

DM	PRO,777,0,0
DM	BUF,777,0,2
DM	BIG,^D31,0,^D4

DEFINE SWTCHS,<
SP	BIGBUFFER,<*F,U.DFBB>,.SWDEC##,BIG,
SP	BUFFER,<*F,U.DFBU>,.SWDEC##,BUF,
SP	PROTECTION,<*F,U.DFPR>,.SWOCT##,PRO,FS.VRQ
>
	SUBTTL	Switch tables -- DEFAULT arguments (expansion)

	DOSCAN	(DEFA.)		;EXPAND THE SUBTABLE POINTERS
	SUBTTL	Switch tables -- BATCH arguments (definition)

DEFINE SWTCHS,<
SN	INTERVENTION,<*F,U.BINT>,
SP	NAME,<*F,U.BNAM>,BATNAM,,FS.VRQ
SP	SEQUENCE,<*F,U.BSEQ>,.SWDEC##,,FS.VRQ
SP	STREAM,<*F,U.BSTR>,.SWOCT##,,FS.VRQ
SP	REQUESTID,<*F,U.BREQ>,.SWDEC##,,FS.VRQ
>
	SUBTTL	Switch tables -- BATCH arguments (expansion)

	DOSCAN	(BATC.)
	SUBTTL	LGNSCN storage

	WCHLSH==:^D17-WTCHDA	;AMOUNT TO SHIFT BITS RETURNED BY
				; SCAN FOR SETUUO

;LOWSEG STORAGE FOR LGNSCN
	RELOC
MSKMEM:	BLOCK	1	;MEMORY FOR MASK PRINTER
	RELOC
	PRGEND

;CHKOPR - SEE IF [1,2] AND NO ACCOUNT STRING. READ THE SYSTEM DEFAULT
;AND USE THAT IF WE CAN

CHKOPR:	MOVE	T1,PPN		;GET PPN
	CAME	T1,ALPPPN	;OPR?
	 JRST	.POPJ1##	;NO--BETTER WAIT
	MOVE	T1,U.ACTS	;GET ACCOUNT STRING
	CAME	T1,[-1]		;SEE IF SPECIFIED
	 JUMPN	T1,.POPJ1##	;YES--BETTER WAIT
	MOVE	T1,[.ACTRD,,T2]	;READ ACCOUNT STRING
	MOVEI	T2,2		;2 ARGS
	MOVEI	T3,0		;NULL JOB (SYSTEM DEFAULT)
	MOVEI	T4,U.ACTS	;INTO OUR ACCOUNT STRING
	ACCT.	T1,		;DO IT
	 JFCL			;CANT SAY WE DIDNT TRY
	POPJ	P,		;AND LET HIM IN

;DATTIM - ROUTINE TO GETTAB THE INTERNAL DATE AND TIME (%CNDTM) AND STORE IT
;	IN ACTACK SO IPCF MESSAGES AND THEIR RESPONSES CAN BE SYNCRONIZED AND
;	ALSO ENSURE SYSTEM SECURITY AND ACCOUNTING DATA INTEGRITY.
;	RETURNS THE DATE/TIME WORD IN T1

DATTIM:	MOVX	T1,%CNDTM
	GETTAB	T1,
	  MOVEI	T1,0		;CAN'T HAPPEN
	MOVEM	T1,ACTACK	;SAVE IT AS A UNIQUE NUMBER
	POPJ	P,
;[344] TABLES FOR ROUTINE TO DO TRMOP.S AND SET TERMINAL STUFF

IFN	SETTTY,<

	DEFINE X(TCODE,ARG,FLAGS),<
	XWD	ARG,FLAGS!TCODE+1000 >

;FLAGS
TF.CMP==1B18		;USE COMPLEMENT OF VALUE STORED BY SCAN

TTAB:	X .TOTRM,U.TYPE,0	;[675] DO TYPE SETTING FIRST THEN ALTER
				;[675] THE DEFAULTS.
	X .TOALT,U.ALTM,TF.CMP	;[472] TRMOP.S WHICH ARE DONE BEFORE
	X .TOBLK,U.BLNK,TF.CMP	;[472] PRINTING NOTICE.TXT
	X .TONFC,U.CRLF,TF.CMP
	X .TODBK,U.DBRK,0
	X .TOLCP,U.ECHO,TF.CMP
	X .TOFLC,U.FILL,0
	X .TOFRM,U.FORM,0
	X .TOSND,U.GAG,TF.CMP
	X .TOLCT,U.LC,TF.CMP
	X .TOPAG,U.PAGE,0
	X .TOPSZ,U.PGSZ,0
	X .TORTC,U.RTC,0
	X .TOTAB,U.TABS,0
	X .TOTAP,U.TAPE,0
	X .TOWID,U.WDTH,0
	X .TODEM,U.TTDE,0
	X .TODIS,U.DISP,0	;[743]
	X .TOLCT,U.UC,0		;[747]
	X .TOTDY,U.TIDY,0	;[747]
;;	X .TOFFH,U.FFHO,0
;;	X .TOFFF,U.FFSI,0
;;	X .TOFFS,U.FFST,0
	X .TOLNB,U.LENG,0
	X .TOSBL,U.SBEL,0
	X .TOSSZ,U.SSTO,0	;STOP SIZE
	X .TOSSZ,U.STOP,0	; "     "
	X .TOXNF,U.XONXO,0
	X .TOSTO,T.STOP,0	;STOP BIT
	X .TOSST,T.SSTOP,0	;SSTOP BIT
TTLNTH=.-TTAB

PTAB:	X .TORSP,U.RSPD,0	;[472] TRMOP.S WHICH SHOULD BE DONE
	X .TOTSP,U.XSPD,0	;[472] AFTER PRINTING NOTICE.TXT
PTLNTH=.-PTAB			;[472]

	>		;[344] END IFN SETTTY

	SUBTTL	Set user profile -- non-privileged SETUUOs
 
;HERE AFTER LOGIN UUO IS DONE TO SET OPTIONAL STUFF
USRSET:	HRROI	T1,.GTWCH	;[446] TRY GETTAB TO GET THIS JOB'S
	GETTAB	T1,		;[446] WATCH BITS. IF GETTAB FAILS,
	  JRST	TINY		;[446] THIS MUST BE A 1040 MONITOR
	LDB	T1,WATBTS	;GET WATCH BITS
	LSH	T1,SHFWAT
	HRRZ	T2,U.WAT	;GET WATCH BITS
	LSH	T2,WCHLSH##	;SHIFT TO CORRECT PLACE
	IOR	T1,T2		;OR IN THE USER SETTINGS
	MOVE	T2,ENTRY+.ACPRO	;GET THE PROFILE WORD
	TXNE	T2,AC.WVR	;WANT TO WATCH VERSIONS?
	TRO	T1,(JW.WVR)	;YES--TURN ON VERSION WATCHING
	SKIPE	NEWACT		;IF OLD ACCT.SYS FORMAT
	TXNE	T2,AC.WMT	; OR USER WANTS MTA WATCHING
	TRO	T1,(JW.WMT)	; TURN ON WATCH MTA
	TXNE	T2,AC.WFL	;USER WANTS FILE WATCHING
	TRO	T1,(JW.WFI)
	MOVE	T2,.FLVRB##	;[455] GET /VERBOSITY FROM SCAN
	LSH	T2,^D6		;[542] SHIFT OVER TO RIGHT PLACE
	ANDI	T2,700		;[542] THROW AWAY GARBAGE BITS
	IOR	T1,T2		;[455] OR INTO WATCH BITS
	HRLI	T1,.STWTC	;SET WATCH FUNCTION
	MOVE	T2,['SWB',,[ASCIZ/watch bits/]]
	SKIPE	U.NWAT		;[336] SKIP THE SETUUO IF /NOWATCH
	PUSHJ	P,SETIT		;DO THE SET UUO
TINY:	SETOM	UFDFSN		;[446] START WITH FIRST STR

;HERE TO SET CURRENT VM LIMITS
USRST1:	MOVE	T1,STATS2	;GET SECOND STATES WORD
	TXNN	T1,ST%VMS	;DO WE HAVE VM?
	JRST	USRST7		;NO--TRY NEXT THING
	MOVEI	T3,0		;PRESET ANSWER TO ZERO
	SKIPGE	T1,U.CVPL	;GET CURRENT VIRT LIMIT
	JRST	USRS6A		;NONE SUPPLIED
	PUSHJ	P,FIXPGS	;CONVERT TO PAGES
	HRL	T3,T1		;USER SUPPLIED ONE -- USE IT
USRS6A:	SKIPGE	T1,U.CPPL	;GET CURRENT PHYS LIMIT
	JRST	USRS6B		;NONE SUPPLIED--LEAVE ZERO
	PUSHJ	P,FIXPGS	;MAKE SURE WE HAVE PAGES
	HRR	T3,T1		;USER SPECIFIED ONE -- USE IT
USRS6B:	JUMPE	T3,USRST7	;JUMP IF NOTHING REQUESTED
	SKIPG	U.LIMIT		;SKIP IF /LIMIT
	SKIPN	U.GUID		;SKIP UNLESS /NOGUIDELINE GIVEN
	TRO	T3,400000	;SET THE BIT
	MOVE	T1,[.STCVM,,T3]	;ARGUMENT TO SET UUO
	MOVE	T2,['SCV',,[ASCIZ/current virtual and physical limits/]]
	PUSHJ	P,SETIT		;DO THE SETUUO

USRST7:	IFN	SETTTY,<	;[344]
	SKIPN	U.SETT		;[344] DID HE SAY /NOSETTY?
	JRST	USRST8		;[344] YES -- SKIP THE WHOLE BIT
	SKIPG	T1,U.SPED	;[344] DID HE SAY /SPEED:N?
	JRST	.+3		;[344] NOPE
	MOVEM	T1,U.RSPD	;[344] YES -- SET BOTH RCV AND XMIT
	MOVEM	T1,U.XSPD	;[344] SPEED TO N
;FIX UP STOP/SSTOP
	MOVEI	T1,1		;A BIT
	SKIPG	U.STOP		;STOP?
	 SKIPLE	U.SSTOP		;OR SSTOP?
	  MOVEM	T1,T.STOP	;YES--SET STOP
	SKIPLE	U.SSTOP		;SSTOP?
	 MOVEM	T1,T.SSTOP	;YES--SET SSTOP TOO
	MOVE	T1,[-TTLNTH,,TTAB] ;[472] TABLE OF PRE-NOTICE TRMOP.S
	PUSHJ	P,DOTRMP	;[472] DO THE TRMOP.S
	>			;[472] END IFN SETTTY



USRST8:	MOVEI	P1,DEVTAB	;[470] MAKE PTR TO LIST
	HLRE	T1,DEVPTR	;[470] GET -NUMBER OF WORD PAIRS LEFT
	ADDI	T1,DVICES*2	;[470] MAKE +NUMBER OF PAIRS USED
	JUMPL	T1,USRS8C	;[470] NO /ASSIGN SWITCH TYPED
	CAILE	T1,DVICES*2	;[470] TOO MANY?
	  MOVEI	T1,DVICES*2	;[631] YES - USE MAX
	LSH	T1,-1		;[470] HALVE BECAUSE WORD PAIRS
	MOVN	P2,T1		;[470] MAKE AOJL COUNTER
USRS8A:	SETZB	T1,T3		;[470] SET UP OPEN BLOCK
	MOVE	T2,(P1)		;[470] GET PHYSICAL NAME
	OPEN	UFD,T1		;[470] OPEN ON SOME RANDOM CHANNEL
	  JRST	NDEV		;[470] LOSE
	AOS	P1		;[470] BUMP POINTER
	MOVEI	T1,UFD		;[470] CHANNEL NUMBER
	SKIPN	T2,(P1)		;[470] PICK UP LOGICAL NAME
	  JRST	.+3		;[470] NONE - KEEP GOING
	DEVLNM	T1,		;[470] ASSIGN LOGICAL NAME
	  JRST	NODEV		;[470] LOST
	MOVE	T1,THSJOB	;[470] SET ASSCON BY REASSI
	MOVEI	T2,UFD		;[470] CHANNEL NUMBER
	REASSI	T1,		;[470] ZAP!
USRS8B:	CLOSE	UFD,		;[470] TIDY UP
	AOS	P1		;[470] BUMP POINTER
	AOJLE	P2,USRS8A	;[502] LOOP THRU DEVICE LIST

USRS8C:	POPJ	P,		;[470] ALL DONE


NODEV:	SOS	P1		;[470] DROP BACK TO POINT AT PHYS NAME
NDEV:	WARN	CAD,<Could not assign device >,,E.CAD
	JRST	USRS8B		;KEEP ON TRUCKIN

E.CAD:	MOVE	T1,(P1)		;GET PHYSICAL NAME
	PUSHJ	P,.TSIXN##	;TYPE IT
	AOS	P1		;BUMP POINTER
	SKIPN	(P1)		;LOGICAL NAME SPECIFIED?
	 POPJ	P,		;NO - DON'T TALK ABOUT IT
	MOVEI	T1,[ASCIZ/ logical name /]	;[470]
	PUSHJ	P,.TSTRG##
	MOVE	T1,(P1)		;GET LOGICAL NAME
	PUSHJ	P,.TSIXN##	;TYPE IT
	PJRST	.TSIXN##	;TYPE IT AND RETURN

;[472] ROUTINE TO DO POST-NOTICE TRMOP.S
POSTMS:	IFN	SETTTY,<	;[472]
	SKIPN	U.SETT		;[472] DID HE SAY /NOSETTTY?
	  POPJ	P,		;[556] YES- SKIP IT
	PUSHJ	P,WAITO		;[472] WAIT UNTIL OUTPUT BUFFER EMPTY
	MOVE	T1,[-PTLNTH,,PTAB] ;[472] TABLE OF POST-NOTICE TRMOP.S
	PUSHJ	P,DOTRMP	;[472] DO THEM UP
	>			;[472] END IFN SETTTY
	POPJ	P,		;[472]

	IFN SETTTY,<		;[556]
DOTRMP:	MOVE	P1,[XWD 3,T2]	;[472] SET UP ARG POINTER
TLOOP:	SETZ	P2,		;[344] CLEAR FLAGS
	HLRZ	T4,(T1)		;[344] GET ADDR OF ARG FOR TRMOP.
	MOVE	T4,(T4)		;[344] GET ACTUAL ARGUMENT
	CAMN	T4,[-1]		;[675] IF -1,
	JRST	LEAVE		;[675]  SCAN DIDN'T TOUCH IT
	HRRZ	T2,(T1)		;[344] GET TRMOP. FUNCTION CODE & FLAGS
	TRZE	T2,TF.CMP	;[344] CLEAR FLAGS OUT OF T2 SO IT
	TRO	P2,TF.CMP	;[344] WILL BE A REAL TRMOP. CODE
	MOVE	T3,TTYUDX	;[344] GET TTY UDX
	TRNE	P2,TF.CMP	;[344] COMPLEMENT ARGUMENT?
	TRC	T4,1		;[344] YUP
	TRMOP.	P1,
	  JRST	WHA		;[344] OOPS -- CHECK IT OUT
LEAVE:	AOBJN	T1,TLOOP	;[344] GO ROUND AGAIN
FORGET:	POPJ	P,		;[475] ALL DONE
	>			;[470] END IFN SETTTY


	IFN	SETTTY,<	;[556]
;[344] HERE IF TRMOP. UUO FAILS
WHA:	CAIN	P1,TOPRC%	;[344] NOT PRIVILEGED?
	JRST	IGNORE		;[344] ACT LIKE IT DIDN'T HAPPEN
	JUMPE	P1,IGNORE	;[344] IF FUN. NOT IMPLEMENTED, IGNORE
	CAMN	P1,[XWD 3,T2]	;[344] IF UUO NOT IMPLEMENTED, FORGET
	JRST	FORGET		;[475] THE WHOLE THING
	PUSH	P,T1		;[375] WATCH OUT FOR T1
	HRRZ	T1,(T1)		;[675] PICK UP FUNCTION CODE
	CAIN	T1,.TOTRM+1000	;[675] TRYING TO SET TERMINAL TYPE
	JRST	NOTTYP		;[675] YES, NO SUCH TTY TYPE
	WARN	TUF,<TRMOP. UUO failed. Function code = >,,.TOCTW##
	POP	P,T1		;[677] GET T1 BACK AGAIN

IGNORE:	MOVE	P1,[XWD 3,T2]	;[344] RESTORE POINTER
	JRST	LEAVE		;[344] AND RETURN

;[675] TERMINAL TYPE INVALID ERROR
NOTTYP:	POP	P,T1		;[677]  GET T1 BACK AGAIN
	WARN	TTI,<Terminal type invalid;  Using defaults>
	JRST	IGNORE		;[744] AND RETURN

;[367] ROUTINE TO SLEEP UNTIL FINISHED OUTPUTTING ON TTY
WAITO:	MOVEI	P1,^D120	;[475] WAIT FOR TTY OUTPUT FOR 2 MIN.
WAITO1:	MOVE	T1,[XWD 2,T2]	;[553] SET UP POINTER FOR TRMOP.
	MOVEI	T2,.TOSOP	;[367] SKIP IF OUTPUT BUFFER NON-EMPTY
	MOVE	T3,TTYUDX	;[367] OUR UNIVERSAL I/O INDEX
	TRMOP.	T1,		;[367] IF OUTPUT BUFFER EMPTY OR TRMOP.
	  POPJ	P,		;[367] FAILS, ASSUME OK AND RETURN
	MOVEI	T4,1		;[367] SLEEP FOR ONE SECOND
	SLEEP	T4,
	SOJG	P1,WAITO1	;[553] IF STILL PATIENT, KEEP SLEEPING
	POPJ	P,		;[475] WAITED TOO LONG - GIVE UP

	>			;[357] END IFN SETTTY

	SUBTTL	Set user parameters -- subroutines

;SUBROUTINE TO DO A SET UUO
;CALL WITH:
;	T1 = SET UUO ARGUMENT
;	LH(T2) =  3 LETTER CODE IN SIXBIT
;	RH(T2) = ADDRESS OF ASCIZ STRING
;	PUSHJ	P,SETIT
;	RETURN HERE IN ALL CASES
SETIT:	SETUUO	T1,		;SET THE PARAMETER
	  SKIPA			;LOST--PRINT MESSAGE
	POPJ	P,0		;WORKED--RETURN
	PUSH	P,T2		;SAVE T2
	PUSHJ	P,NEWLIN	;START WITH CLEAN LINE
	MOVEI	T1,[ASCIZ/%LGN/] ;PRINT PREFIX
	PUSHJ	P,.TSTRG##	; ..
	HLLZ	T1,(P)		;COPY 3 LETTER CODE
	PUSHJ	P,.TSIXN##	;PRINT THAT OUT
	MOVEI	T1,[ASCIZ/ SETUUO failed attempting to set /]
	PUSHJ	P,.TSTRG##	;TYPE THE FIRST STUFF
	HRRZ	T1,(P)		;COPY REST OF STRING
	PUSHJ	P,.TSTRG##	;PRINT IT
	POP	P,T2		;CLEAN UP STACK
	PJRST	.TCRLF##	;ADD A CRLF
;SUBROUTINE TO CONVERT CORE ARGUMENT TO PAGES
;CALL WITH:
;	MOVE	T1,ANSWER-FROM-.SWCOR
;	PUSHJ	P,FIXPGS
;	RETURN HERE # OF PAGES IN T1
;USES NO AC'S
FIXPGS:	CAIG	T1,^D512	;JUST A NUMBER?
	IMULI	T1,^D1024	;YES--CONVERT TO WORDS
	LSH	T1,-9		;CONVERT TO PAGES
	POPJ	P,0		;RETURN
;LOWSEG STUFF FOR LGNSET
	XLIST
	LIT
	LIST

	RELOC
IPCFLG:	BLOCK	1		;IPCF FLAGS
FMPID:	BLOCK	1		;MY PID
TOPID:	BLOCK	1		;SENDER'S PID
IPCPTR:	BLOCK	1		;POINTER TO MESSAGE
IPCMSG:	BLOCK	1		;FUNCTION FOR [SYSTEM]IPCF TO DO
IPCJOB:	BLOCK	1		;JOB TO DO IT TO
IPCQTA:	BLOCK	1		;IPCF QUOTA
NODBLK:
NODLEN:	BLOCK	1		;[633] LENGTH OF NODE UUO ARGUMENT BLOCK
NODLOC:	BLOCK	1		;[633] NODE NUMBER
	BLOCK	1		;[633] RESERVED ARGUMENT
NODDEV:	BLOCK	1		;[633] NUMBER OF DEVICES,,DEVICE TYPE
	PRGEND
	TITLE	LGNIO - Input output module for LOGIN

	SEARCH	UUOSYM,MACTEN,SCNMAC,LGNUNV,ACTSYM,UFDPRM
	LGNDCL

; Initialize terminal
TTYINI::PUSH	P,T1			;SAVE T1
	SETZM	TTYBUF##		;CLEAR FIRST WORD OF BUFFER
	MOVE	T1,[TTYBUF##,,TTYBUF##+1] ;SET UP BLT
	BLT	T1,TTYBUF##+TTYBSZ-1	;CLEAR OUR BUFFER
	MOVE	T1,[POINT 7,TTYBUF##]	;SET UP
	MOVEM	T1,TTYPTR##		; BYTE POINTER
	MOVEI	T1,<TTYBSZ*5>-1		;SET UP
	MOVEM	T1,TTYCNT##		; BYTE COUNT
	POP	P,T1			;RESTORE T1
	POPJ	P,			;AND RETURN


; Output entire buffer
TTYOUT::TLNE	F,FL.DET		;DETACHED?
	SETZM	TTYBUF			;YES--NEVER DO OUTPUT
	SKIPE	TTYBUF##		;ANYTHING IN BUFFER?
	OUTSTR	TTYBUF			;YES--DUMP IT
	PJRST	TTYINI			;RESET POINTER AND COUNT


; Output a character
TTYTYO::SOSGE	TTYCNT			;COUNT CHARACTERS
	PUSHJ	P,TTYOUT		;BUFFER FULL--OUTPUT
	IDPB	CH,TTYPTR		;STORE CHARACTER
	CAIN	CH,.CHCRT		;CARRAGE RETURN?
	SETZM	HPOS			;YES--BACK TO START OF LINE
	CAIL	CH," "			;CONTROL CHARACTER?
	AOS	HPOS			;NO--UPDATE POSITION
	CAIN	CH,.CHLFD		;LINE FEED?
	PJRST	TTYOUT			;YES--FORCE BUFFER OUT
	POPJ	P,			;RETURN


; Output a prompt and force output
TTYPMT::PUSH	P,T1			;SAVE PROMPT TEXT
	PUSHJ	P,NEWLIN		;TYPE A CRLF IF NEEDED
	POP	P,T1			;RESTORE T1
	PUSHJ	P,.TSTRG##		;TYPE PROMPT STRING
	PJRST	TTYOUT			;FORCE OUTPUT


; Set terminal echo status
TTYECH::SKIPA	T1,[TXZ	T1,GL.NEC]	;ECHO
TTYNEC::MOVE	T1,[TXO	T1,GL.NEC]	;NO ECHO
	PUSH	P,T1			;SAVE INSTRUCTION
	MOVNI	T1,1			;-1 FOR OUR LINE
	GETLCH	T1			;GET LINE CHARACTERISTICS
	XCT	(P)			;SET OR CLEAR ECHO
	SETLCH	T1			;SET LINE CHARACTERISTICS
	POP	P,(P)			;TRIM STACK
	POPJ	P,			;RETURN
;SUBROUTINE TO INPUT CHARS TO 1ST NON-SIXBIT CHAR - SAVE 2 WORDS OF CHARS
;VALUES	T1,T2=SIXBIT CHARS
;	CH=TERMINATING CHAR
;	FL.BRK BIT IN LH F=1 IF TERMINATING CHAR IS A BREAK CHAR

GET2WD:	PUSHJ	P,.SAVE1##	;SAVE P1
	SETZB	T1,T2
	MOVE	P1,[POINT 6,T1]
GETNL:	PUSHJ	P,.TICHE##	;GET A CHAR. WITH THE RIGHT
				; AMOUNT OF CONVERSION.
	JUMPLE	C,.POPJ##	;[456] JUMP IF END OF LINE
	CAIL	C,"A"+40	;CONVER LOWER CASE
	CAILE	C,"Z"+40	; TO UPPER CASE
	SKIPA
	SUBI	C,40	
	MOVEI	CH,-40(C)	;CONVERT TO SIXBIT
	CAME	P1,[600,,T2]	;POINTER EXPIRED
	IDPB	CH,P1		;NO--STASH AWAY
	JRST	GETNL		;GET THE NEXT CHAR
;SUBROUTINE TO DETERMINE IF JOB NUMBER IN T1 IS A BATCH JOB
;ARGS	T1=JOB NUMBER
;RETURN	.POPJ IF JOB IS NOT BATCH
;	.POPJ1 IF JOB IS BATCH

ISBATC:	HRLZ	T4,T1
	HRRI	T4,.GTLIM	;[602] GETTAB INDEX FOR JBTLIM
	GETTAB	T4,		;[602] GET BITS
	  SETZ	T4,
	TXNN	T4,JB.LBT	;[602] BATCH JOB?
	  POPJ	P,		;[602] NO
	JRST	.POPJ1##	;[602] YES - SKIP RETURN

;[333] SUBROUTINE TO DETERMINE WHETHER THIS JOB IS A SUBJOB OF OPSER.
;[333] RETURN	POPJ IF NOT
;[333]		POPJ1 IF IT IS

ISOPSR:	SETO	T1,		;[333,340] THIS JOB
	CTLJOB	T1,		;[333] WHO CONTROLS ME?
	  POPJ	P,		;[333] I DUNNO
	MOVE	T2,T1		;[404] REMEMBER CNTRL JOB NO.
	TRMNO.	T1,		;[333] WHERE'S HIS TTY AT?
	  POPJ	P,		;[333,340] DUNNO
	GETLCH	T1		;[333,341] WHAT KIND OF TERMINAL
	TXNE	T1,GL.ITY	;[333] PTY?
	POPJ	P,		;[333,340] YES--PROBABLY BATCON
	HRLZ	T1,T2		;[337,340,404] GET JOB NO.
	HRRI	T1,.GTPRG	;[333] SET UP FOR GETTAB
	GETTAB	T1,		;[333] GET PROGRAM NAME
	  POPJ	P,		;[333] A REAL LOSER
	CAME	T1,[SIXBIT /OPSER/]
	POPJ	P,
	JRST	.POPJ1##
STYO:	MOVE	CH,T1		;CHARACTER OUTPUT FOR SCAN & WILD
TYO:	JRST	TTYTYO

TYI:	PUSHJ	P,.TIAUC##	;GET CHAR BY SCAN'S SUBROUTINE
	MOVE	CH,C		;[331] COPY CHAR
	POPJ	P,
;SUBROUTINE TO GET ONE CHAR AND BOMB USER FOR BEING
; SLOW.
;
;CALLED ONLY FROM SCAN -- MAY CHANGE NO AC'S

TTYGET:	PUSHJ	P,.SAVE2##	;SAVE P1 AND P2
	SKIPN	FL2741		;IS THIS A 2741?
	TRNE	F,R.PTYJ	;PTY JOB?
	JRST	TTGET2		;YES -- GO INTO TI WAIT
	MOVEI	P2,TTYSLP	;NUMBER OF MINS. TO SLEEP
TTGET1:	SKPINL			;ANYTHING THERE??
	  SKIPA			;NO--LOOP
	JRST	TTGET2		;YES--GO GET IT
	MOVE	P1,[HB.RTL!HB.RWJ!^D60000]
	HIBER	P1,		;HIBER FOR 1 MIN.
	  JRST	TTGET2		;TINY MONITOR
	SKPINL
	  SKIPA
	JRST	TTGET2
	SOJG	P2,TTGET1	;LOOP FOR A WHILE
	FATAL	(WFS,<Waiting for >,EF.SIL,HELPR)

TTGET2:	INCHWL	C		;GET A CHAR. INTO C
	CAIE	C,.CHCNC	;CONTROL-C?
	CAIN	C,.CHCNZ	;[343] OR CONTROL-Z?
	PJRST	RICC##		;YES--GO EXIT
	CAIN	C,.CHCRT	;IS IT A CARRAGE RETURN?
	SETZM	HPOS		;YES--UPDATE HORIZ. POSITION
	CAIL	C," "		;PRINTING CHARACTER?
	AOS	HPOS		;YES--UPDATE HORIZ POSITION
	POPJ	P,		;RETURN


;HERE IF USER DOES NOT TYPE ANYTHING WITHIN 2 MIN.
HELPR:	MOVE	T1,HELP		;POINT TO HELP TEXT
	PUSHJ	P,.TSTRG##	;TYPE IT
	MOVEI	T1,[ASCIZ /; please start over/]
	PJRST	.TSTRG##	;TYPE END OF ERROR AND RETURN


; SUBROUTINE TO PROMPT FOR A PPN
GIVNBR::PUSHJ	P,NEWLIN	;GIVE A CRLF IF NEEDED
	MOVEI	CH,[ASCIZ /project-programmer number/]
	MOVEM	CH,HELP		;STORE REASON FOR WAITING
				;FALL INTO SCNPMT


; SUBROUTINE TO PROMPT.  CALLED FROM SCAN
SCNPMT::PUSHJ	P,TTYECH	;SET TTY ECHO
	TLNE	F,FL.BAT	;ARE WE A BATCH JOB?
	FATAL	(EIB,<Error in BATCON - LOGIN aborted>)
	MOVEI	T1,"#"		;ALWAYS PROMPT WITH "#" WHETHER
	PUSHJ	P,.TCHAR##	;FIRST OR CONTINUATION LINE
	PJRST	TTYOUT		;FORCE OUTPUT AND RETURN


;SUBROUTINE TO TYPE A CRLF IF ONE IS NEEDED
NEWLIN:	SKIPN	HPOS		;IS A CRLF NEEDED?
	POPJ	P,0		;NO--JUST RETURN
	PJRST	.TCRLF##	;YES--GO TYPE ONE
	SUBTTL	LOGIN messages

	MSGOK==1		;FLAG TO TYPE MEESSAGE EVEN IF USER
				; HAS SEEN IT.
	FNAME==2		;FLAG TO REQUEST FILE NAME PRINTING
	STONLY==4		;[357] FLAG TO PRINT STR NAME ONLY

;HERE TO PRINT RANDOM FILES USER GETS ON LOGIN

DAYMES:	PUSHJ	P,.SAVE1##	;SAVE P1
	MOVE	T1,PPN		;GET PPN
	TLNE	F,FL.WLD	;WILD PPN?
	 INFO	LIA,<You are logged in as >,,.TXWDW##
	MSTIME	T1,		;GET TIME OF DAY
	IDIVI	T1,^D60000	;TO MINUTES
	IDIVI	T1,^D60		;NOW BREAK IN MINS AND HRS
	PUSH	P,T2		;SAVE MINUTES
	MOVEI	T2,"0"		;[754] ZERO FILL
	PUSHJ	P,.TDEC2##	;[754]TYPE HOURS
	PUSHJ	P,.TCOLN##	;TYPE A COLON
	POP	P,T1		;[754]MINUTES
	MOVEI	T2,"0"		;[754] ZERO FILL
	PUSHJ	P,.TDEC2##	;[754]TYPE
	PUSHJ	P,.TTABC##	;TAB
	PUSHJ	P,.TDATN##	;[754] And current date
	PUSHJ	P,.TTABC##
	MOVE	T1,SAVEDA	;DAY OF WEEK
	MOVEI	T1,WEEKDA(T1)
	PUSHJ	P,.TSTRG##	;TYPE DAY OF WEEK
	PUSHJ	P,.TCRLF##

	MOVEI	T1,2		;[454] GET DEFAULT FOR /NOTICE
	MOVE	P1,U.NOTC	;[453] GET SWITCH TYPED
	AOSN	P1		;[453] WAS A SWITCH TYPED?
	  MOVEM	T1,U.NOTC	;[453] NO - USE DEFAULT
	MOVEI	T1,NOTSPC	;[362] /NOTE FILESPEC
	MOVEI	P1,FNAME	;[362] PRINT FILE NAME
	PUSHJ	P,TYPE		;[362] TYPE IT
	PUSHJ	P,ISOPSR	;[333] IS THIS AN OPSER SUBJOB?

DIEMSG:	SKIPA	T1,[DAYSPC]	;[333,337] NO--PRINT NOTICE.TXT
	POPJ	P,0		;[662] [333] YES--DON'T PRINT IT
	TRNE	F,R.SESSION	;[754] SESSION Command?
	 POPJ	P,		;[754] Yes--No message for him either
	MOVEI	P1,0		;FLAGS
	PJRST	TYPE		;GO PRINT IT AND RETURN

;[662]	CREATE SEPERATE /STR PRINTER
STRMES::SKIPG	U.STR		;/STR GIVEN
	POPJ	P,0		;NO--RETURN
	MOVEI	T1,STRSPC	;STR.TXT SPEC
	MOVEI	P1,MSGOK!FNAME!STONLY	;[357] OK TO TYPE MESSAGE
	PJRST	TYPE		;PRINT IT

;FILE SPEC FOR SYS:NOTICE.TXT/PHYSICAL/NOSTR
DAYSPC:	SIXBIT	/SYS/
	SIXBIT	/NOTICE/
	EXP	-1
	XWD	'TXT',-1
	EXP	FX.PHY!FX.NOM
	EXP	FX.STR!FX.PHY!FX.NOM
	BLOCK	.FXLEN-<.-DAYSPC>

;FILE SPEC FOR SYS:STR.TXT/PHYSICAL/STRS
STRSPC:	SIXBIT	/ALL/
	SIXBIT	/STR/
	EXP	-1
	XWD	'TXT',-1
	EXP	FX.PHY!FX.STR
	EXP	FX.PHY!FX.STR
	XWD	1,4
	XWD	-1,-1
	BLOCK	.FXLEN-<.-STRSPC>
;SUBROUTINE TO TYPE A FILE
;CALL WITH:
;	MOVEI	T1,ADDRESS-OF-SCAN-STYLE-FILESPEC
;	MOVEI	P1,FLAGS
;	PUSHJ	P,TYPE
;	RETURN HERE
TYPE:	SKIPN	.FXNAM(T1)	;[512] ANY NAME OR MASK SPECIFIED?
	  POPJ	P,		;[512] NO - SKIP IT
	HRLZ	T1,T1		;FLIP AROUND
	HRRI	T1,TYPSPC	;ADDRESS OF OUT SPEC
	BLT	T1,TYPSPC+.FXLEN-1 ;[436] COPY THE FILESPEC
	SETZM	WLDPNT		;CLEAR MEMORY FOR FIRST CALL
	MOVX	T1,FX.NOM!FX.PRT ;/OKNONE AND /OKPROT
	IORM	T1,TYPSPC+.FXMOD;FORCE SWITCH TO BE
	IORM	T1,TYPSPC+.FXMOM; SET ON ALL CALLS TO WILD
TYPE1:	MOVE	T1,[4,,[[TYPSPC],,0
			UFDBUF,,SECBUF
			.FXLEN,,.RBPRV+1
			UFD,,WLDPNT]]
	MOVX	T2,.IOASC	;SET UP ASCII MODE
	MOVEM	T2,UFDBUF	; ..
	PUSHJ	P,.LKWLD##	;LOOK FOR FILE
	  POPJ	P,0		;ALL DONE
	MOVEI	T1,B.DC##	;SET UP ADDRESS OF BUFFER HEADER
	MOVEM	T1,UFDBUF+2	; ..
	OPEN	UFD,UFDBUF	;OPEN THE FILE
	  PJRST	E.DFO##		;CAN'T
	LOOKUP	UFD,SECBUF	;LOOKUP FILE
	JRST	[PUSHJ P,E.DFL## ;REPORT ERROR
		 JRST  TYPE1]	;LOOK FOR NEXT FILE
IFN SUPNOT,<
	TRNE	P1,MSGOK	;WANT MESSAGE ALWAYS?
	JRST	TYPE3		;YES--GO TYPE IT
	SKIPE	UFDNDL		;SKIP IF UFD CAN BE DELETED
	JRST	TYPE2		; SAW THE MESSAGE
	LDB	T1,[POINTR(SECBUF+.RBPRV,RB.CRD)]
	LDB	T2,[POINTR(SECBUF+.RBEXT,RB.CRX)] ;GET TOP 3 BITS OF DATE
	LSH	T2,^D12		;MOVE OVER TO CORRECT PLACE
	IORI	T1,(T2)		;COMBINE
	CAMLE	T1,UFDDAT	;IS FILE NEWER THAN UFD?
	JRST	TYPE3		;YES--PRINT ANYWAY
	CAME	T1,UFDDAT	;SAME DAY?
	JRST	TYPE2		;NO--DISTINCTLY OLDER
	LDB	T2,[POINTR(SECBUF+.RBPRV,RB.CRT)]
	CAML	T2,UFDTIM	;IS MESSAGE NEWER THAN UFD
	JRST	TYPE3		;YES--GO PRINT
TYPE2:	MOVE	T1,U.NOTC	;[450] GET /NOTICE VALUE
	CAIL	T1,2		;[450,453] SOMETIMES OR NEVER?
	JRST	TYPE1		;[453] YES -LOOK FOR NEXT FILE
>
TYPE3:	MOVE	T1,U.NOTC	;[450] GET /NOTICE VALUE
	CAIN	T1,3		;[450] NEVER PRINT?
	  JRST	TYPE1		;[450] YES - SKIP IT
	TXNE	P1,FNAME	;WANT TO SEE FILE NAME?
	PUSHJ	P,TYPFIL	;TYPE THE FILE SPEC
TYPE4:	PUSHJ	P,.NXDTW##	;GET A BYTE
	  JRST	TYPE1		;END OF FILE
	PUSHJ	P,.TCHAR##	;TYPE IT
	JRST	TYPE4
;SUBROUTINE TO TYPE A FILESPEC
;CALL WITH:
;	UFDBUF = OPEN BLOCK
;	SECBUF = LOOKUP BLOCK
;	PUSHJ	P,TYPFIL
;	RETURN HERE
TYPFIL:	PUSHJ	P,NEWLIN	;[377] DON'T DOUBLE-SPACE
	MOVE	T1,UFDBUF+1	;GET DEVICE NAME
	PUSHJ	P,.TSIXN##	;TYPE IT
	PUSHJ	P,.TCOLN##	;TYPE IT
	TXNE	P1,STONLY	;[357] ONLY WANT STR NAME?
	PJRST	.TSPAC##	;[357] YES -- FINISH UP
	MOVE	T1,SECBUF+.RBNAM ;GET FILE NAME
	PUSHJ	P,.TSIXN##	;TYPE IT
	MOVEI	T1,"."		;TYPE A DOT
	PUSHJ	P,.TCHAR##	;TYPE THE DOT
	HLLZ	T1,SECBUF+.RBEXT;TYPE THE EXTENSION
	PUSHJ	P,.TSIXN##	;TYPE EXTENSION
	MOVEI	T1,SECBUF+.RBPPN;POINT TO PPN
	PUSHJ	P,.TDIRB##	;PRINT IT
	PJRST	NEWLIN		;START A NEW LINE AND RETURN


WEEKDA:	ASCIZ	.Wed.
	ASCIZ	.Thur.
	ASCIZ	.Fri.
	ASCIZ	.Sat.
	ASCIZ	.Sun.
	ASCIZ	.Mon.
	ASCIZ	.Tue.

	PRGEND
	TITLE	LGNERR - Error messages and typeout for LOGIN

	SEARCH	UUOSYM,MACTEN,SCNMAC,LGNUNV,ACTSYM,UFDPRM

	LGNDCL

	SUBTTL	Error message printer

;CALLED ONLY BY MACROS
ERRMSG:	MOVEM	T1,ERRACS+1	;SAVE T1
	MOVE	T1,[2,,ERRACS+2];SETUP BLT
	BLT	T1,ERRACS+16	;EXCLUDE F(0) AND P(17)
	HRRZ	P1,(P)		;GET ADDRESS OF ARGS FROM CALL
	POP	P,(P)		;GET EXTRA PUSHJ OFF THE STACK
	PUSHJ	P,.VERBO##	;GET VERBOSITY BITS
	PUSH	P,T1		;SAVE THEM FOR LATER
	PUSHJ	P,NEWLIN	;GET START OF A NEW LINE
	MOVE	P2,1(P1)	;GET FLAGS
	TXNE	P2,EF.REQ	;[477] REQUE BATCH JOB?
	MOVE	T1,["?",,[ASCIZ/?(5)/]]  ;[477] YES
	TXNE	P2,EF.SYS	;SYSTEM FAILURE
	MOVE	T1,["?",,[ASCIZ/?(4)/]] ;YES--DATA FOR THAT
	TXNE	P2,EF.ERR	;FATAL ERROR
	MOVE	T1,["?",,[ASCIZ/?(3)/]]
	TXNE	P2,EF.WRN	;WARNING?
	MOVE	T1,["%",,[ASCIZ/%/]]
	TXNE	P2,EF.INF	;INFORMATIONAL
	MOVE	T1,["[",,[ASCIZ/[/]]
	TLNN	F,FL.BAT	;[600] BATCH JOB?
	  JRST	[HLRZ  T1,T1	;NO--PUT CHAR IN RH
		 PUSHJ P,.TCHAR## ;TYPE IT
		 JRST  ERMSG1]	;CONTINUE
	HRRZ	T1,T1		;CLEAR LH
	PUSHJ	P,.TSTRG##	;TYPE THE MESSAGE

ERMSG1:	MOVE	T1,(P)		;GET VERBOSITY BITS
	TXNN	T1,JWW.PR	;/MESSAGE:PREFIX?
	JRST	ERMSG2		;NO
	HRRZ	T1,(P1)		;GET PREFIX
	HRLI	T1,'LGN'	;INCLUDE OUR NAME
	PUSHJ	P,.TSIXN##	;TYPE IN SIXBIT

ERMSG2:	PUSHJ	P,.TSPAC##	;PRINT A SPACE
	POP	P,T1		;GET VERBOSITY BITS
	TXNN	T1,JWW.FL	;/MESSAGE:FIRST?
	JRST	ERMSG3		;NO
	HRRZ	T1,1(P1)	;GET TEXT ADDRESS
	PUSHJ	P,.TSTRG##	;YES--PRINT THE STRING
	HLRZ	T1,(P1)		;GET MORE ADDRESS
	JUMPE	T1,ERMSG3	;NONE
	PUSH	P,P2		;SAVE FLAGS
	PUSH	P,T1		;SAVE IT
	MOVE	16,[ERRACS+1,,1];RESTORE ACS
	BLT	16,16		;..
	PUSHJ	P,@(P)		;CALL CONTINUATION ROUTINE
	POP	P,(P)		;FIX STACK
	POP	P,P2		;RESTORE FLAGS
ERMSG3:	TXNE	P2,EF.WTO	;WTO THIS ERROR?
	 PUSHJ	P,ERRWTO	;YES--DO IT NOW
	TXNE	P2,EF.INF	;INFORMATION?
	 PUSHJ	P,.TRBRK##	;YES
	PUSHJ	P,.TCRLF##	;CRLF
	TXNE	P2,EF.FMT	;FORMAT ERROR? (LET HIM RETRY)
	 JRST	ERMSG6		;YES
	TXNE	P2,EF.ERR!EF.SYS!EF.REQ	;FATAL?
	 JRST	ERMSG4		;YES--GO FLUSH USER
	MOVE	16,[ERRACS+1,,1];RESTORE ACS
	BLT	16,16		;..
	POPJ	P,		;AND RETURN

ERMSG4:	PUSHJ	P,.TCRLF##	;[347] DO A CRLF
	TXNE	P2,EF.SIL!EF.FMT ;SUPRESS NOTICE.TXT OR FORMAT ERROR?
	 JRST	ERMSG5		;YES
	MOVE	T1,[SIXBIT /LOGIN/]	;[615]
	SETNAM	T1,		;[357] CLEAR JACCT
	PUSHJ	P,DIEMSG	;[621] TYPE MESSAGES OF THE DAY
	PUSHJ	P,STRMES##	;[662] AND DO /STR IF DESIRED
ERMSG5:	PJRST	FLUSH		;[347] AND DIE

ERMSG6:	PUSHJ	P,.CLRBF##	;CLEAR TYPE-AHEAD
	TDNN	F,[FL.BAT,,R.SESSION];Batch or SESSION?
	 SOSG	LOGTRY		;Another chance??
	  JRST	FLUSH		;No, bye-bye
	JRST	LOGIN3		;[517]
	SUBTTL	ERRWTO - ROUTINE TO WTO IMPORTANT ERROR MESSAGES

ERRWTO:	TRNE	F,R.DBUG		;DEBUG?
	 JRST	ERRWO			;YES--DONT BOTHER REAL OPR
	MOVX	T1,.QUWTO		;FUNCTION CODE
	DPB	T1,[POINTR WTOBLK+.QUFNC,QF.FNC];STORE
	SETOM	WTOBLK+.QUNOD		;CENTRAL SITE OPR
	SETZM	WTOBLK+.QURSP		;NO RESPONCE BLOCK
	MOVX	T1,<INSVL.(WTOLEN,QA.LEN)!INSVL.(.QBTYP,QA.TYP)>;SETUP ARGS
	MOVEM	T1,WTOBLK+.QUARG	;STORE 1ST ARG
	MOVEI	T1,WTOTXT		;GET ADDR OF TEXT
	MOVEM	T1,WTOBLK+.QUARV	;STORE 1ST VALUE
	MOVX	T1,<INSVL.(^D16,QA.LEN)!INSVL.(.QBMSG,QA.TYP)>;SETUP ARGS
	MOVEM	T1,WTOBLK+.QUARG+2	;STORE 2ND ARG
	HRRZ	T1,1(P1)		;GET TEXT ADDRESS
	MOVEM	T1,WTOBLK+.QUARV+2	;STORE 2ND VALUE
	MOVE	T1,[.QUARV+3,,WTOBLK]	;POINT TO BLOCK
	QUEUE.	T1,			;WTO
	 CAIA				;FAILED
	  POPJ	P,			;OK
ERRWO:	MOVEI	T1,[ASCIZ/; Please call the operator/];JUST GIVE HIM
	PJRST	.TSTRG##		;THE TEXT W/O THE WTO

WTOTXT:	ASCIZ/LOGIN error/		;WTO HEADER
WTOLEN==.-WTOTXT
	SUBTTL	Random messages

KLGMSG:	ASCIZ	/
.KJOB
./
CRLFPD:	ASCIZ	/
./
	SUBTTL	Data and storage

;STORAGE

WATBTS:	POINTR	ENTRY+.ACPRO,AC.WDT!AC.WRT!AC.WWA!AC.RED!AC.WRI
SPLBTS:	POINTR	ENTRY+.ACPRO,AC.CDR!AC.CDP!AC.PTP!AC.PLT!AC.LPT

	PRGEND
	TITLE	LGNEND - Exit sequence for LOGIN

	SEARCH	UUOSYM,MACTEN,SCNMAC,LGNUNV,ACTSYM,UFDPRM
	LGNDCL



;SUBROUTINE TO ALLOW CONTROL-C'S TO WORK AGAIN
;CALL WITH:
;	PUSHJ	P,CTLCOK
;	RETURN HERE IF NO CONTROL-C TYPED
;
CTLCOK::SETZM	CCWAIT		;CLEAR THE CONTROL-C DELAY FLAG
	AOSE	CCTYPED		;WAS A CONTROL-C TYPED?
	POPJ	P,0		;NO--RETURN TO CALLER
				;YES--FALL INTO RICC
;HERE WHEN A CONTROL-C TYPED
RICC::	PUSH	P,INTBLK+2	;SAVE OLD PC
	SKIPL	CCWAIT		;DO WE WANT CONTROL-C HELD UP?
	JRST	CCEXIT		;NO--CHARGE AHEAD
	INFO	WFC,<Please wait for Control-C>
	SETZM	INTBLK+2	;REENABLE INTERRUPTS
	SETOM	CCTYPED		;SET THE FLAG
	POPJ	P,0		;RETURN

CCEXIT:	PUSHJ	P,.ISLGI##	;ARE WE LOGGED IN?
	AOJE	T1,.MNRET##	;NO--EXIT
	WARN	LAC,<LOGIN aborted by Control-C - job is LOGGED-IN>
	JRST	CCLAST		;EXIT QUICKLY
LAST:	TLNE	F,FL.ATT	;SKIP IF LOGIN, NOT IF ATTACH
	JRST	ALAST		;FINISH UP ATTACH
	PUSHJ	P,PRVSET	;DO PRIV. SET UUOS
	TXNE	F,R.SESS	;IF SESSION JUST EXIT
	JRST	NORUN
IFN FTMAIL,<			;[760] CALL EXTERNAL MODULE TO SEE IF
	PUSHJ	P,RNMAIL##	;[543] USER HAS ANY MAIL
>;[760] END IFN FTMAIL

	PUSHJ	P,STRMES##	;[662] DO /STR IF DESIRED
	SETOM	CCWAIT		;[641] DISABLE CONTROL-C
	MOVE	T1,LGIARG	;NOW LOG THE GUY IN
	LOGIN	T1,
	  JFCL
	SKIPN	ENTRY+.ACPGM	;[563] UNLESS WE'RE GOING TO RUN A CUSP,
	  PUSHJ	P,CTLCOK	;[563] ALLOW CONTROL-C TO WORK AGAIN
	PUSHJ	P,USRSET	;[363] DO ORDINARY SETUUO'S (AND TRMOP.S)
	PUSHJ	P,DAYMES	;[472] PRINT OUT DAILY MESSAGES
	PUSHJ	P,POSTMS	;[472] DO POST-MESSAGE TRMOP.S (SPEED)
	SKIPN	ENTRY+.ACPGM	;SKIP IF USER IS LOCKED INTO A PROGRAM
	PUSHJ	P,.RUNCM##	;PROCESS /RUN IF ANY
CCLAST:	SKIPN	T4,ENTRY+.ACPGM	;SKIP IF RUN UUO TO BE EXECUTED
	JRST	NORUN		;NO, DONT SET IT UP
	SKIPN	T3,ENTRY+.ACDEV	;YES, SKIP IF DEVICE SPECIFIED
	MOVSI	T3,(SIXBIT .SYS.)	;NO, ASSUME SYS
	SETZB	P1,P2
	MOVE	N,ENTRY+.ACDIR	;PPN
NORUN:	SETZB	M,LASTX		;CLEAR CORE
	MOVE	WD,TOLO1
NORUN1:	PUSHJ	P,TTYOUT##	;FORCE OUT ANY REMAIN TEXT IN OUTPUT BUFFER
	MOVE	T1,[XWD LASTX,LASTX+1]
	SKIPN	.JBDDT##	;SKIP THIS IF DDT IS LOADED
	BLT	T1,@.JBREL
	SETZM	.JBSA		;CLEAR START ADDRESS SINCE PROG NO LONGER THERE
	MOVE	T1,[XWD TOLO,LASTX]
	BLT	T1,LASTX+ETOLO-TOLO	;TRANSFER TO LOW SEG
	MOVEM	WD,LASTX+TOLO1-TOLO
	JUMPE	T4,LASTX+FRUN-TOLO	;JUMP IF NO RUN UUO
	SETZB	T3+3,T3+5	;CLEAR UNUSED ARGS
	JRST	LASTX		;DO RUN UUO
;THE CODE ON THIS PAGE IS COPIED TO THE LOWSEG AND EXECUTED
; FROM THERE. THIS IS DONE WITHOUT BENIFIT OF RELOCATION
; SO BE CAREFUL

TOLO:	MOVEI	WD,T3
	RUN	WD,UU.PHY	;[640] RUN CUSP, PHYSICAL-ONLY
FRUN:	SETZ	T1,		;NO RUN UUO OR RUN UUO FAILED
	SETNAM	T1,		;CLEAR NAME
	HRLI	T1,1		;[576] GET RID OF HI SEG
	HRRI	T1,1		;[576] AND SHRINK LOW SEG TO 1K
	SKIPN	.JBDDT##
	CORE	T1,
	  JFCL
TOLO1:	MONRT.
ETOLO:	EXIT			;AND EXIT IN CASE OF CONTINUE
ALAST:	MOVEI	T1,.GTPPN	;GET PPN OF JOB THAT I AM ABOUT
	HRL	T1,ATTJOB	;  TO ATTACH TO
	GETTAB	T1,		;[157]
	  JRST	NOATT		;     CAN'T GET PPN, CAN'T ATTACH
	CAME	T1,PPN		;PPN'S DIFFER?
	  JRST	NOATT		;  YES, CAN'T ATTACH
	HRRZ	T1,ATTJOB	;[611] JOB NO. TO ATTACH TO
	TRMNO.	T1,		;[611] SEE OF SOMEONE ALREADY THERE
	  JRST	ALAST1		;[611] LOOKS OK SO FAR
	JRST	NOATT		;[611] DON'T DETACH - SQUATTER'S RIGHTS
ALAST1:	MOVN	N,ATTJOB	;[611] DO MORE CHECKING ON JOB
	JOBSTS	N,		;[611] ..
	  JRST	NOATT		;[611] FUNNY JOB NUMBER?
IFN FTMAIL,<
	PUSH	P,N		;SAVE N
	PUSHJ	P,RNMAIL##	;CHECK OUT MAIL
	POP	P,N		;RESTORE N
>;END IFN FTMAIL
	JUMPGE	N,NOATT		;[611] IF JNA NOT SET, DIE
	SKIPE	U.MODE##	;USER REQUESTED MONITOR MODE?
	 TXNN	N,JB.URN	;RUNNING?
	  JRST	ALAST3		;NO--GIVE HIM DOT
	INFO	ATJ,<Attaching to job >,,E.ATJ
	MOVX	N,AT.UUM	;INDICATE USER MODE
	JRST	ALAST2		;AND SKIP THIS
ALAST3:	MOVEI	T1,CRLFPD
	PUSHJ	P,.TSTRG##	;MAKE IT LOOK GOOD
	PUSHJ	P,TTYOUT##	;FORCE OUTPUT
	MOVX	N,AT.UMM	;INDICATE MONITOR MODE
ALAST2:	SETO	T1,		;[420] MAKE T1=-1
	GETLCH	T1		;[420] GET LINE NUMBER AND BITS
	CAME	T1,[-1]		;[420] IF GETLCH A NO-OP OR
	TRNN	T1,-1		;[420] LINE IS DETACHED, THEN
	  JRST	NOATT		;[420] ATTACH HAD BETTER LOSE
	TRZ	T1,600000	;[420] CLEAR UDX BITS
	MOVSI	T1,(T1)		;SET UP LINE NUMBER
	TDO	T1,N		;INCLUDE MODE BITS FROM ABOVE
	HRR	T1,ATTJOB	;[420] GET JOB NUMBER
	ATTACH	T1,		;ATTACH JOB TO TTY
	  JRST	NOATT		;WOOPS, COULDNT!

FLUSHX:	RESET			;TURN ON ECHOING
	MOVSI	T1,(AC.DCR)	;[1101] GET THE DECREMENT BIT
	ACCLG.	T1,		;[1101] TRY TO COUNT DOWN
	  JFCL			;[1101] IF ERROR IGNORE AND CONTINUE
	SKIPE	T1,.JBDDT##	;SKIP IF NO DDT
	 JRST	(T1)		;GO TO DDT
	SETZB	T4,LASTX	;CLEAR CORE IF UNSUCCESSFUL LOGIN
	MOVE	WD,[LOGOUT]	;KILL KJOB
	TRNE	F,R.SESSION	;[754] SESSION command?
	 MOVE	WD,[MONRT.]	;[754] Yes--Pretty up exit
	JRST	NORUN1

E.ATJ:	MOVE	T1,ATTJOB	;GET TARGET JOB
	PUSHJ	P,.TDECW##	;TYEP
	MOVEI	 T1,[ASCIZ/ running /];GET TEXT
	PUSHJ	P,.TSTRG##	;TYPE
	HRLZ	T1,ATTJOB	;GET TARGET JOB
	HRRI	T1,.GTPRG	;FIND ITS NAME
	GETTAB	T1,		;ASK MONITOR
	 MOVEI	T1,0		;NOT TODAY
	PUSHJ	P,.TSIXN##	;TYPE PROGRAM NAME
	MOVEI	T1,[ASCIZ/ in user mode/]
	PJRST	.TSTRG##

	PRGEND
	TITLE	LGNLOW - Low segment for LOGIN

	SEARCH	UUOSYM,MACTEN,SCNMAC,LGNUNV
	GLOBS		;DECLARE GLOBALS

DEFINE	LWORD(A),<
A::	BLOCK	1
>

DEFINE	LBLOCK(A,B),<
A::	BLOCK	B
>

	TWOSEG
	RELOC	400000

LGIARG:	XWD	PPN-CHGNO-1,PPN	;ARGUMENT TO LOGIN UUO
PDPLST:	IOWD	PDLSIZ,PDL

	RELOC
	LOWVAR
	END
 " 	^